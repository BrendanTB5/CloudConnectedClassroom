\hypertarget{nbns__client_8c}{}\section{cyclone\+\_\+tcp/netbios/nbns\+\_\+client.c File Reference}
\label{nbns__client_8c}\index{cyclone\+\_\+tcp/netbios/nbns\+\_\+client.\+c@{cyclone\+\_\+tcp/netbios/nbns\+\_\+client.\+c}}


N\+B\+NS client (Net\+B\+I\+OS Name Service)  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv4/ipv4\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}netbios/nbns\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}netbios/nbns\+\_\+common.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dns/dns\+\_\+debug.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{nbns__client_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_aaa0682b805a8d862dce0a66bfec167f0}{N\+B\+N\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{nbns__client_8c_a00bd7dea91c743a4decfd8b1bc7bd2a5}{nbns\+Resolve} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}, \hyperlink{structIpAddr}{Ip\+Addr} $\ast$\hyperlink{ipcp_8h_a11542dd5a4de5976a89188df3d53b42d}{ip\+Addr})
\begin{DoxyCompactList}\small\item\em Resolve a host name using N\+B\+NS. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{nbns__client_8c_a42df9ad6f78e5e2e05d9cfef77482e98}{nbns\+Send\+Query} (\hyperlink{structDnsCacheEntry}{Dns\+Cache\+Entry} $\ast$entry)
\begin{DoxyCompactList}\small\item\em Send a N\+B\+NS query message. \end{DoxyCompactList}\item 
void \hyperlink{nbns__client_8c_a183d1e4024a0f85d858a193cf5b02ddf}{nbns\+Process\+Response} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{ipv4_8h_a0e92b64e038199f1bb6383f2a76f30b6}{Ipv4\+Pseudo\+Header} $\ast$pseudo\+Header, const \hyperlink{udp_8h_a6877bae1da8326482f5e311875e52bce}{Udp\+Header} $\ast$udp\+Header, const \hyperlink{nbns__common_8h_a31dec1106c9cf3a1e242d985ac447238}{Nbns\+Header} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process N\+B\+NS response message. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
N\+B\+NS client (Net\+B\+I\+OS Name Service) 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{nbns__client_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{nbns__client_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{nbns\+\_\+client.\+c@{nbns\+\_\+client.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!nbns\+\_\+client.\+c@{nbns\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_aaa0682b805a8d862dce0a66bfec167f0}{N\+B\+N\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file nbns\+\_\+client.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{nbns__client_8c_a183d1e4024a0f85d858a193cf5b02ddf}\label{nbns__client_8c_a183d1e4024a0f85d858a193cf5b02ddf}} 
\index{nbns\+\_\+client.\+c@{nbns\+\_\+client.\+c}!nbns\+Process\+Response@{nbns\+Process\+Response}}
\index{nbns\+Process\+Response@{nbns\+Process\+Response}!nbns\+\_\+client.\+c@{nbns\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{nbns\+Process\+Response()}{nbnsProcessResponse()}}
{\footnotesize\ttfamily void nbns\+Process\+Response (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{ipv4_8h_a0e92b64e038199f1bb6383f2a76f30b6}{Ipv4\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{const \hyperlink{udp_8h_a6877bae1da8326482f5e311875e52bce}{Udp\+Header} $\ast$}]{udp\+Header,  }\item[{const \hyperlink{nbns__common_8h_a31dec1106c9cf3a1e242d985ac447238}{Nbns\+Header} $\ast$}]{message,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process N\+B\+NS response message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & U\+DP pseudo header \\
\hline
\mbox{\tt in}  & {\em udp\+Header} & U\+DP header \\
\hline
\mbox{\tt in}  & {\em message} & Pointer to the N\+B\+NS response message \\
\hline
\mbox{\tt in}  & {\em length} & Length of the message \\
\hline
\end{DoxyParams}


Definition at line 277 of file nbns\+\_\+client.\+c.


\begin{DoxyCode}
279 \{
280    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
281    \textcolor{keywordtype}{size\_t} pos;
282    \hyperlink{structDnsCacheEntry}{DnsCacheEntry} *entry;
283    \hyperlink{dns__common_8h_a801d4a933cd802d56c5450013b4c0969}{DnsResourceRecord} *record;
284    \hyperlink{nbns__common_8h_abdcf413c012c8910ced7035094a5c957}{NbnsAddrEntry} *addrEntry;
285 
286    \textcolor{comment}{//The NBNS response shall contain one answer}
287    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->qdcount) != 0 && \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->ancount) != 1)
288       \textcolor{keywordflow}{return};
289 
290    \textcolor{comment}{//Parse NetBIOS name}
291    pos = \hyperlink{nbns__common_8c_a883186d42b150c72047c02e9ee490770}{nbnsParseName}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, \textcolor{keyword}{sizeof}(
      \hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader}), \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
292    \textcolor{comment}{//Invalid name?}
293    \textcolor{keywordflow}{if}(!pos)
294       \textcolor{keywordflow}{return};
295 
296    \textcolor{comment}{//Point to the associated resource record}
297    record = \hyperlink{dns__common_8h_a4f1a2722ba292be26060ec5693e1f280}{DNS\_GET\_RESOURCE\_RECORD}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, pos);
298    \textcolor{comment}{//Point to the resource data}
299    pos += \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_a801d4a933cd802d56c5450013b4c0969}{DnsResourceRecord});
300 
301    \textcolor{comment}{//Make sure the resource record is valid}
302    \textcolor{keywordflow}{if}(pos > \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length})
303       \textcolor{keywordflow}{return};
304    \textcolor{keywordflow}{if}((pos + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->rdlength)) > \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length})
305       \textcolor{keywordflow}{return};
306 
307    \textcolor{comment}{//Check the class and the type of the resource record}
308    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->rclass) != \hyperlink{dns__common_8h_aa541e7289dae8934f7f37e74c15cc5a5ae4d96c0329f035328ba190627f2782e9}{DNS\_RR\_CLASS\_IN})
309       \textcolor{keywordflow}{return};
310    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->rtype) != \hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a2c6f8e31b0a836590f0173f34e3d082c}{DNS\_RR\_TYPE\_NB})
311       \textcolor{keywordflow}{return};
312 
313    \textcolor{comment}{//Verify the length of the data field}
314    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->rdlength) < \textcolor{keyword}{sizeof}(\hyperlink{nbns__common_8h_abdcf413c012c8910ced7035094a5c957}{NbnsAddrEntry}))
315       \textcolor{keywordflow}{return};
316 
317    \textcolor{comment}{//Loop through DNS cache entries}
318    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dns__cache_8h_a0559240be0228278dd24ac2103aa0c66}{DNS\_CACHE\_SIZE}; i++)
319    \{
320       \textcolor{comment}{//Point to the current entry}
321       entry = &\hyperlink{dns__cache_8c_a459576a3a6c3ed0c90f544dabacc8377}{dnsCache}[i];
322 
323       \textcolor{comment}{//NBNS name resolution in progress?}
324       \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3affcd994aeea92ea47ae5be4f6a2f7511}{DNS\_STATE\_IN\_PROGRESS} &&
325          entry->\hyperlink{structDnsCacheEntry_aeb800b57a9593f4749e3ae8ac03f4a71}{protocol} == \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94a71aefbb76f027115b860aebd98ce74e9}{HOST\_NAME\_RESOLVER\_NBNS} &&
326          entry->\hyperlink{structDnsCacheEntry_a5520082c9b81d8244f858641785ac01e}{type} == \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdaebe58bd51c617e7f9024189e369dc8e9}{HOST\_TYPE\_IPV4})
327       \{
328          \textcolor{comment}{//Compare identifiers}
329          \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ab32547b4942b2db0f0c0bcb41458856d}{id} == \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->id))
330          \{
331             \textcolor{comment}{//Compare NetBIOS names}
332             \textcolor{keywordflow}{if}(\hyperlink{nbns__common_8c_af63e6277864b3b60286e2d72e977bf7a}{nbnsCompareName}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, \textcolor{keyword}{sizeof}(
      \hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader}), entry->\hyperlink{structDnsCacheEntry_a81b2ed3b8465dd82a249f7141865dae6}{name}))
333             \{
334                \textcolor{comment}{//Point to the address entry array}
335                addrEntry = (\hyperlink{nbns__common_8h_abdcf413c012c8910ced7035094a5c957}{NbnsAddrEntry} *) record->rdata;
336                \textcolor{comment}{//Copy the IPv4 address}
337                entry->\hyperlink{structDnsCacheEntry_aad3958e8dcdeb2eea1a99089b2a8f5b1}{ipAddr}.\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} = \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr});
338                entry->\hyperlink{structDnsCacheEntry_aad3958e8dcdeb2eea1a99089b2a8f5b1}{ipAddr}.\hyperlink{structIpAddr_a8de6f49cb0461f57c1eda49bb1088916}{ipv4Addr} = addrEntry->addr;
339 
340                \textcolor{comment}{//Save current time}
341                entry->\hyperlink{structDnsCacheEntry_ae149514d2ade99ae033ecedd03a5daf0}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
342                \textcolor{comment}{//Save TTL value}
343                entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout} = \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(record->ttl) * 1000;
344                \textcolor{comment}{//Limit the lifetime of the NBNS cache entries}
345                entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout} = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout}, 
      \hyperlink{nbns__client_8h_a4206d29a299846a38774fa2617f4f78f}{NBNS\_MAX\_LIFETIME});
346 
347                \textcolor{comment}{//Host name successfully resolved}
348                entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} = \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3a29c9441f0fda002de6ba63d19b20f334}{DNS\_STATE\_RESOLVED};
349             \}
350          \}
351       \}
352    \}
353 \}
\end{DoxyCode}
\mbox{\Hypertarget{nbns__client_8c_a00bd7dea91c743a4decfd8b1bc7bd2a5}\label{nbns__client_8c_a00bd7dea91c743a4decfd8b1bc7bd2a5}} 
\index{nbns\+\_\+client.\+c@{nbns\+\_\+client.\+c}!nbns\+Resolve@{nbns\+Resolve}}
\index{nbns\+Resolve@{nbns\+Resolve}!nbns\+\_\+client.\+c@{nbns\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{nbns\+Resolve()}{nbnsResolve()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} nbns\+Resolve (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{name,  }\item[{\hyperlink{structIpAddr}{Ip\+Addr} $\ast$}]{ip\+Addr }\end{DoxyParamCaption})}



Resolve a host name using N\+B\+NS. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em name} & Name of the host to be resolved \\
\hline
\mbox{\tt out}  & {\em ip\+Addr} & IP address corresponding to the specified host name \\
\hline
\end{DoxyParams}


Definition at line 53 of file nbns\+\_\+client.\+c.


\begin{DoxyCode}
54 \{
55    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
56    \hyperlink{structDnsCacheEntry}{DnsCacheEntry} *entry;
57 
58 \textcolor{preprocessor}{#if (NET\_RTOS\_SUPPORT == ENABLED)}
59    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} delay;
60 
61    \textcolor{comment}{//Debug message}
62    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Resolving host name %s (NBNS resolver)...\(\backslash\)r\(\backslash\)n"}, \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name});
63 \textcolor{preprocessor}{#endif}
64 
65    \textcolor{comment}{//Get exclusive access}
66    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
67 
68    \textcolor{comment}{//Search the DNS cache for the specified host name}
69    entry = \hyperlink{dns__cache_8c_a079712e25d65a0e902068e6fea3141ae}{dnsFindEntry}(interface, \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}, \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdaebe58bd51c617e7f9024189e369dc8e9}{HOST\_TYPE\_IPV4}, 
      \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94a71aefbb76f027115b860aebd98ce74e9}{HOST\_NAME\_RESOLVER\_NBNS});
70 
71    \textcolor{comment}{//Check whether a matching entry has been found}
72    \textcolor{keywordflow}{if}(entry)
73    \{
74       \textcolor{comment}{//Host name already resolved?}
75       \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3a29c9441f0fda002de6ba63d19b20f334}{DNS\_STATE\_RESOLVED} ||
76          entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3ada34e46aacf8dc68d5c86add93157ea2}{DNS\_STATE\_PERMANENT})
77       \{
78          \textcolor{comment}{//Return the corresponding IP address}
79          *ipAddr = entry->\hyperlink{structDnsCacheEntry_aad3958e8dcdeb2eea1a99089b2a8f5b1}{ipAddr};
80          \textcolor{comment}{//Successful host name resolution}
81          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
82       \}
83       \textcolor{keywordflow}{else}
84       \{
85          \textcolor{comment}{//Host name resolution is in progress...}
86          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca14596397b69ee6fd1d74ca77fb55e186}{ERROR\_IN\_PROGRESS};
87       \}
88    \}
89    \textcolor{keywordflow}{else}
90    \{
91       \textcolor{comment}{//If no entry exists, then create a new one}
92       entry = \hyperlink{dns__cache_8c_ac154126efa899c325ee537727c9f5174}{dnsCreateEntry}();
93 
94       \textcolor{comment}{//Record the host name whose IP address is unknown}
95       strcpy(entry->\hyperlink{structDnsCacheEntry_a81b2ed3b8465dd82a249f7141865dae6}{name}, \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name});
96 
97       \textcolor{comment}{//Initialize DNS cache entry}
98       entry->\hyperlink{structDnsCacheEntry_a5520082c9b81d8244f858641785ac01e}{type} = \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdaebe58bd51c617e7f9024189e369dc8e9}{HOST\_TYPE\_IPV4};
99       entry->\hyperlink{structDnsCacheEntry_aeb800b57a9593f4749e3ae8ac03f4a71}{protocol} = \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94a71aefbb76f027115b860aebd98ce74e9}{HOST\_NAME\_RESOLVER\_NBNS};
100       entry->\hyperlink{structDnsCacheEntry_ad0d0a0228fc29308f59f4b2d402758e6}{interface} = interface;
101 
102       \textcolor{comment}{//Initialize retransmission counter}
103       entry->\hyperlink{structDnsCacheEntry_aa1813da7ebe162f069a6079aa2365db1}{retransmitCount} = \hyperlink{nbns__client_8h_a85ea7b96a9e109ed32f5f888d51be477}{NBNS\_CLIENT\_MAX\_RETRIES};
104       \textcolor{comment}{//Send NBNS query}
105       error = \hyperlink{nbns__client_8c_a42df9ad6f78e5e2e05d9cfef77482e98}{nbnsSendQuery}(entry);
106 
107       \textcolor{comment}{//NBNS message successfully sent?}
108       \textcolor{keywordflow}{if}(!error)
109       \{
110          \textcolor{comment}{//Save the time at which the query message was sent}
111          entry->\hyperlink{structDnsCacheEntry_ae149514d2ade99ae033ecedd03a5daf0}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
112          \textcolor{comment}{//Set timeout value}
113          entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout} = \hyperlink{nbns__client_8h_a496e2d4e4f7d16dc9d24f798ff1de2e7}{NBNS\_CLIENT\_INIT\_TIMEOUT};
114          entry->\hyperlink{structDnsCacheEntry_a4167197fb96cd19e4efdcd25184749c1}{maxTimeout} = \hyperlink{nbns__client_8h_a1c8ec9276abb019d88795be4f0a404fd}{NBNS\_CLIENT\_MAX\_TIMEOUT};
115          \textcolor{comment}{//Decrement retransmission counter}
116          entry->\hyperlink{structDnsCacheEntry_aa1813da7ebe162f069a6079aa2365db1}{retransmitCount}--;
117 
118          \textcolor{comment}{//Switch state}
119          entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} = \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3affcd994aeea92ea47ae5be4f6a2f7511}{DNS\_STATE\_IN\_PROGRESS};
120          \textcolor{comment}{//Host name resolution is in progress}
121          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca14596397b69ee6fd1d74ca77fb55e186}{ERROR\_IN\_PROGRESS};
122       \}
123    \}
124 
125    \textcolor{comment}{//Release exclusive access}
126    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
127 
128 \textcolor{preprocessor}{#if (NET\_RTOS\_SUPPORT == ENABLED)}
129    \textcolor{comment}{//Set default polling interval}
130    delay = \hyperlink{dns__cache_8h_a437dbba366682cad097edc5d6e463d06}{DNS\_CACHE\_INIT\_POLLING\_INTERVAL};
131 
132    \textcolor{comment}{//Wait the host name resolution to complete}
133    \textcolor{keywordflow}{while}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca14596397b69ee6fd1d74ca77fb55e186}{ERROR\_IN\_PROGRESS})
134    \{
135       \textcolor{comment}{//Wait until the next polling period}
136       \hyperlink{os__port__chibios_8c_a69608590db97c707277aebf15be010e5}{osDelayTask}(delay);
137 
138       \textcolor{comment}{//Get exclusive access}
139       \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
140 
141       \textcolor{comment}{//Search the DNS cache for the specified host name}
142       entry = \hyperlink{dns__cache_8c_a079712e25d65a0e902068e6fea3141ae}{dnsFindEntry}(interface, \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}, \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdaebe58bd51c617e7f9024189e369dc8e9}{HOST\_TYPE\_IPV4}, 
      \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94a71aefbb76f027115b860aebd98ce74e9}{HOST\_NAME\_RESOLVER\_NBNS});
143 
144       \textcolor{comment}{//Check whether a matching entry has been found}
145       \textcolor{keywordflow}{if}(entry)
146       \{
147          \textcolor{comment}{//Host name successfully resolved?}
148          \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3a29c9441f0fda002de6ba63d19b20f334}{DNS\_STATE\_RESOLVED})
149          \{
150             \textcolor{comment}{//Return the corresponding IP address}
151             *ipAddr = entry->\hyperlink{structDnsCacheEntry_aad3958e8dcdeb2eea1a99089b2a8f5b1}{ipAddr};
152             \textcolor{comment}{//Successful host name resolution}
153             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
154          \}
155       \}
156       \textcolor{keywordflow}{else}
157       \{
158          \textcolor{comment}{//Host name resolution failed}
159          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
160       \}
161 
162       \textcolor{comment}{//Release exclusive access}
163       \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
164 
165       \textcolor{comment}{//Backoff support for less aggressive polling}
166       delay = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(delay * 2, \hyperlink{dns__cache_8h_aec92c7ec467dd08af86f9b5c77473b0e}{DNS\_CACHE\_MAX\_POLLING\_INTERVAL});
167    \}
168 
169    \textcolor{comment}{//Check status code}
170    \textcolor{keywordflow}{if}(error)
171    \{
172       \textcolor{comment}{//Failed to resolve host name}
173       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Host name resolution failed!\(\backslash\)r\(\backslash\)n"});
174    \}
175    \textcolor{keywordflow}{else}
176    \{
177       \textcolor{comment}{//Successful host name resolution}
178       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Host name resolved to %s...\(\backslash\)r\(\backslash\)n"}, \hyperlink{ip_8c_aecdb577de79f65f8c814d5f101c7c6ae}{ipAddrToString}(ipAddr, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
179    \}
180 \textcolor{preprocessor}{#endif}
181 
182    \textcolor{comment}{//Return status code}
183    \textcolor{keywordflow}{return} error;
184 \}
\end{DoxyCode}
\mbox{\Hypertarget{nbns__client_8c_a42df9ad6f78e5e2e05d9cfef77482e98}\label{nbns__client_8c_a42df9ad6f78e5e2e05d9cfef77482e98}} 
\index{nbns\+\_\+client.\+c@{nbns\+\_\+client.\+c}!nbns\+Send\+Query@{nbns\+Send\+Query}}
\index{nbns\+Send\+Query@{nbns\+Send\+Query}!nbns\+\_\+client.\+c@{nbns\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{nbns\+Send\+Query()}{nbnsSendQuery()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} nbns\+Send\+Query (\begin{DoxyParamCaption}\item[{\hyperlink{structDnsCacheEntry}{Dns\+Cache\+Entry} $\ast$}]{entry }\end{DoxyParamCaption})}



Send a N\+B\+NS query message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em entry} & Pointer to a valid D\+NS cache entry \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 193 of file nbns\+\_\+client.\+c.


\begin{DoxyCode}
194 \{
195    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
196    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
197    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
198    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
199    \hyperlink{nbns__common_8h_a31dec1106c9cf3a1e242d985ac447238}{NbnsHeader} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
200    \hyperlink{dns__common_8h_ac1ef063cc8bc932118463092c282f188}{DnsQuestion} *dnsQuestion;
201    \hyperlink{structIpAddr}{IpAddr} \hyperlink{ipcp_8h_a752e1719cf65f78dfec6274352cb56df}{destIpAddr};
202 
203    \textcolor{comment}{//Allocate a memory buffer to hold the NBNS query message}
204    buffer = \hyperlink{udp_8c_a2c65cad7c5665fe03f94364e7e52b2be}{udpAllocBuffer}(\hyperlink{dns__common_8h_a8578d0d73531c18ef02299543f9b232e}{DNS\_MESSAGE\_MAX\_SIZE}, &offset);
205    \textcolor{comment}{//Failed to allocate buffer?}
206    \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
207       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
208 
209    \textcolor{comment}{//Point to the NBNS header}
210    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, offset);
211 
212    \textcolor{comment}{//Format NBNS query message}
213    message->id = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(entry->\hyperlink{structDnsCacheEntry_ab32547b4942b2db0f0c0bcb41458856d}{id});
214    message->qr = 0;
215    message->opcode = \hyperlink{dns__common_8h_a9f7c2277e233fdeda3757e48282d3314af37862c9f8865288e6df0392930ec0a3}{DNS\_OPCODE\_QUERY};
216    message->aa = 0;
217    message->tc = 0;
218    message->rd = 0;
219    message->ra = 0;
220    message->z = 0;
221    message->b = 1;
222    message->rcode = \hyperlink{dns__common_8h_a4e14ab5567efbae42f570bc5bbd1d209a3673e53909ca3bf211abc3f0600158e0}{DNS\_RCODE\_NO\_ERROR};
223 
224    \textcolor{comment}{//The NBNS query contains one question}
225    message->qdcount = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(1);
226    message->ancount = 0;
227    message->nscount = 0;
228    message->arcount = 0;
229 
230    \textcolor{comment}{//Length of the NBNS query message}
231    length = \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader});
232 
233    \textcolor{comment}{//Encode the NetBIOS name}
234    length += \hyperlink{nbns__common_8c_a2ffccdee63ab330c3b5720619c241fa8}{nbnsEncodeName}(entry->\hyperlink{structDnsCacheEntry_a81b2ed3b8465dd82a249f7141865dae6}{name}, message->questions);
235 
236    \textcolor{comment}{//Point to the corresponding question structure}
237    dnsQuestion = \hyperlink{dns__common_8h_a66ca704f3f850dcbb2f3ceefe90afcc5}{DNS\_GET\_QUESTION}(message, length);
238    \textcolor{comment}{//Fill in question structure}
239    dnsQuestion->qtype = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a2c6f8e31b0a836590f0173f34e3d082c}{DNS\_RR\_TYPE\_NB});
240    dnsQuestion->qclass = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{dns__common_8h_aa541e7289dae8934f7f37e74c15cc5a5ae4d96c0329f035328ba190627f2782e9}{DNS\_RR\_CLASS\_IN});
241 
242    \textcolor{comment}{//Update the length of the NBNS query message}
243    length += \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_ac1ef063cc8bc932118463092c282f188}{DnsQuestion});
244 
245    \textcolor{comment}{//Adjust the length of the multi-part buffer}
246    \hyperlink{net__mem_8c_ac0a46f396754e069dd1ee65cdc559b28}{netBufferSetLength}(buffer, offset + length);
247 
248    \textcolor{comment}{//Debug message}
249    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending NBNS message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
250    \textcolor{comment}{//Dump message}
251    \hyperlink{dns__debug_8c_aa6a38c4e74d8b059c64c30456d5c26ad}{dnsDumpMessage}((\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader} *) message, length);
252 
253    \textcolor{comment}{//The destination address is the broadcast address}
254    destIpAddr.\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} = \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr});
255    \hyperlink{ipv4__misc_8c_a454228b972ac4244316ad7fbbf73db7a}{ipv4GetBroadcastAddr}(entry->\hyperlink{structDnsCacheEntry_ad0d0a0228fc29308f59f4b2d402758e6}{interface}, &destIpAddr.
      \hyperlink{structIpAddr_a8de6f49cb0461f57c1eda49bb1088916}{ipv4Addr});
256 
257    \textcolor{comment}{//A request packet is always sent to the well known port 137}
258    error = \hyperlink{udp_8c_a72a529f723ed1b75bfe98d0708f28eb1}{udpSendDatagramEx}(entry->\hyperlink{structDnsCacheEntry_ad0d0a0228fc29308f59f4b2d402758e6}{interface}, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 
      \hyperlink{nbns__common_8h_ab90f2670e8b34ee01fe3052166b7a279}{NBNS\_PORT},
259       &destIpAddr, \hyperlink{nbns__common_8h_ab90f2670e8b34ee01fe3052166b7a279}{NBNS\_PORT}, buffer, offset, \hyperlink{ipv4_8h_a23220cfb7e593785a73a64a092829228}{IPV4\_DEFAULT\_TTL});
260 
261    \textcolor{comment}{//Free previously allocated memory}
262    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
263    \textcolor{comment}{//Return status code}
264    \textcolor{keywordflow}{return} error;
265 \}
\end{DoxyCode}
