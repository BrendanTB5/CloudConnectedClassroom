\hypertarget{tls__handshake_8h}{}\section{cyclone\+\_\+ssl/tls\+\_\+handshake.h File Reference}
\label{tls__handshake_8h}\index{cyclone\+\_\+ssl/tls\+\_\+handshake.\+h@{cyclone\+\_\+ssl/tls\+\_\+handshake.\+h}}


T\+LS handshake.  


{\ttfamily \#include \char`\"{}tls.\+h\char`\"{}}\newline
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__handshake_8h_a89760024b4640ed45d9961d0cd91d4d3}{tls\+Init\+Handshake} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em T\+LS handshake initialization. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__handshake_8h_a8cb9f40f473b24c28c2168772da3b26d}{tls\+Perform\+Handshake} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Perform T\+LS handshake. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__handshake_8h_ad729f5d4a23f051eebf844a6fe4964cd}{tls\+Send\+Handshake\+Message} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const void $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9b}{Tls\+Message\+Type} \hyperlink{ppp_8h_a1d127017fb298b889f4ba24752d08b8e}{type})
\begin{DoxyCompactList}\small\item\em Send handshake message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__handshake_8h_a56fc0a8992b1b7e5a2420f9557b39561}{tls\+Receive\+Handshake\+Message} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Receive peer\textquotesingle{}s message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__handshake_8h_ad8c84ebcfdd55f293c7b605273e750c2}{tls\+Parse\+Handshake\+Message} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Parse handshake message. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
T\+LS handshake. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+S\+SL Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Function Documentation}
\mbox{\Hypertarget{tls__handshake_8h_a89760024b4640ed45d9961d0cd91d4d3}\label{tls__handshake_8h_a89760024b4640ed45d9961d0cd91d4d3}} 
\index{tls\+\_\+handshake.\+h@{tls\+\_\+handshake.\+h}!tls\+Init\+Handshake@{tls\+Init\+Handshake}}
\index{tls\+Init\+Handshake@{tls\+Init\+Handshake}!tls\+\_\+handshake.\+h@{tls\+\_\+handshake.\+h}}
\subsubsection{\texorpdfstring{tls\+Init\+Handshake()}{tlsInitHandshake()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Init\+Handshake (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



T\+LS handshake initialization. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 56 of file tls\+\_\+handshake.\+c.


\begin{DoxyCode}
57 \{
58    \textcolor{comment}{//Allocate send buffer if necessary}
59    \textcolor{keywordflow}{if}(context->txBuffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
60    \{
61       \textcolor{comment}{//Allocate TX buffer}
62       context->txBuffer = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(context->txBufferSize);
63 
64       \textcolor{comment}{//Failed to allocate memory?}
65       \textcolor{keywordflow}{if}(context->txBuffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
66          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
67 
68       \textcolor{comment}{//Clear TX buffer}
69       memset(context->txBuffer, 0, context->txBufferSize);
70    \}
71 
72    \textcolor{comment}{//Allocate receive buffer if necessary}
73    \textcolor{keywordflow}{if}(context->rxBuffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
74    \{
75       \textcolor{comment}{//Allocate RX buffer}
76       context->rxBuffer = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(context->rxBufferSize);
77 
78       \textcolor{comment}{//Failed to allocate memory?}
79       \textcolor{keywordflow}{if}(context->rxBuffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
80          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
81 
82       \textcolor{comment}{//Clear RX buffer}
83       memset(context->rxBuffer, 0, context->rxBufferSize);
84    \}
85 
86 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
87    \textcolor{comment}{//Server mode?}
88    \textcolor{keywordflow}{if}(context->entity == \hyperlink{tls_8h_acb21bc158664d823d899d760edd8135ba3ddde9cb0be1b78b5b7e1e2ba1704a44}{TLS\_CONNECTION\_END\_SERVER})
89    \{
90       \textcolor{comment}{//A server implementation may choose to reject the early data}
91       context->earlyDataRejected = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
92    \}
93 \textcolor{preprocessor}{#endif}
94 
95    \textcolor{comment}{//The client initiates the TLS handshake by sending a ClientHello message}
96    \textcolor{comment}{//to the server}
97    context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dade201db86ae38480c06696f3a48e0170}{TLS\_STATE\_CLIENT\_HELLO};
98 
99    \textcolor{comment}{//Successful processing}
100    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
101 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__handshake_8h_ad8c84ebcfdd55f293c7b605273e750c2}\label{tls__handshake_8h_ad8c84ebcfdd55f293c7b605273e750c2}} 
\index{tls\+\_\+handshake.\+h@{tls\+\_\+handshake.\+h}!tls\+Parse\+Handshake\+Message@{tls\+Parse\+Handshake\+Message}}
\index{tls\+Parse\+Handshake\+Message@{tls\+Parse\+Handshake\+Message}!tls\+\_\+handshake.\+h@{tls\+\_\+handshake.\+h}}
\subsubsection{\texorpdfstring{tls\+Parse\+Handshake\+Message()}{tlsParseHandshakeMessage()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Parse\+Handshake\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{message,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Parse handshake message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em message} & Pointer to the handshake message to parse \\
\hline
\mbox{\tt in}  & {\em length} & Length of the handshake messaged \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 338 of file tls\+\_\+handshake.\+c.


\begin{DoxyCode}
340 \{
341    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
342    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{dtls__misc_8h_a9d7facd71a8c8355a77006f5a6dcd420}{msgType};
343    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
344    \textcolor{keyword}{const} \textcolor{keywordtype}{void} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
345 
346 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
347    \textcolor{comment}{//DTLS protocol?}
348    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
349    \{
350       \textcolor{comment}{//Retrieve handshake message type}
351       msgType = ((\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *) \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})->msgType;
352       \textcolor{comment}{//Point to the handshake message}
353       p = \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message} + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
354       \textcolor{comment}{//Calculate the length of the handshake message}
355       n = \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
356    \}
357    \textcolor{keywordflow}{else}
358 \textcolor{preprocessor}{#endif}
359    \textcolor{comment}{//TLS protocol?}
360    \{
361       \textcolor{comment}{//Retrieve handshake message type}
362       msgType = ((\hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake} *) \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})->msgType;
363       \textcolor{comment}{//Point to the handshake message}
364       p = \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message} + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake});
365       \textcolor{comment}{//Calculate the length of the handshake message}
366       n = \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake});
367    \}
368 
369 \textcolor{preprocessor}{#if (TLS\_MAX\_KEY\_UPDATE\_MESSAGES > 0)}
370    \textcolor{comment}{//Reset the count of consecutive KeyUpdate messages}
371    \textcolor{keywordflow}{if}(msgType != \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9bab97fd5abc6c82fbde3813a4f585323f2}{TLS\_TYPE\_KEY\_UPDATE})
372       context->keyUpdateCount = 0;
373 \textcolor{preprocessor}{#endif}
374 
375 \textcolor{preprocessor}{#if (TLS\_CLIENT\_SUPPORT == ENABLED)}
376    \textcolor{comment}{//Client mode?}
377    \textcolor{keywordflow}{if}(context->entity == \hyperlink{tls_8h_acb21bc158664d823d899d760edd8135ba7f216418b2d898ed01cf9376fd9b3d6d}{TLS\_CONNECTION\_END\_CLIENT})
378    \{
379       \textcolor{comment}{//Parse server's handshake message}
380       error = \hyperlink{tls__client__fsm_8c_aea420e8e37aba190c9ccb4f9249d87bb}{tlsParseServerHandshakeMessage}(context, msgType, p, n);
381 
382       \textcolor{comment}{//Update the hash value with the incoming handshake message}
383       \hyperlink{tls__transcript__hash_8c_a8d1850c2779ca34d9ec197014384be77}{tlsUpdateTranscriptHash}(context, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
384    \}
385    \textcolor{keywordflow}{else}
386 \textcolor{preprocessor}{#endif}
387 \textcolor{preprocessor}{#if (TLS\_SERVER\_SUPPORT == ENABLED)}
388    \textcolor{comment}{//Server mode?}
389    \textcolor{keywordflow}{if}(context->entity == \hyperlink{tls_8h_acb21bc158664d823d899d760edd8135ba3ddde9cb0be1b78b5b7e1e2ba1704a44}{TLS\_CONNECTION\_END\_SERVER})
390    \{
391       \textcolor{comment}{//Update the hash value with the incoming handshake message}
392       \textcolor{keywordflow}{if}(msgType == \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9bac60c488eb103ba58049875235476f1cc}{TLS\_TYPE\_CLIENT\_KEY\_EXCHANGE})
393       \{
394          \hyperlink{tls__transcript__hash_8c_a8d1850c2779ca34d9ec197014384be77}{tlsUpdateTranscriptHash}(context, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
395       \}
396 
397       \textcolor{comment}{//Parse client's handshake message}
398       error = \hyperlink{tls__server__fsm_8c_aac0e365e07c9b42faf4f23dfcf9a9f27}{tlsParseClientHandshakeMessage}(context, msgType, p, n);
399 
400       \textcolor{comment}{//Update the hash value with the incoming handshake message}
401       \textcolor{keywordflow}{if}(msgType != \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9bac60c488eb103ba58049875235476f1cc}{TLS\_TYPE\_CLIENT\_KEY\_EXCHANGE})
402       \{
403          \hyperlink{tls__transcript__hash_8c_a8d1850c2779ca34d9ec197014384be77}{tlsUpdateTranscriptHash}(context, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
404       \}
405    \}
406    \textcolor{keywordflow}{else}
407 \textcolor{preprocessor}{#endif}
408    \textcolor{comment}{//Unsupported mode of operation?}
409    \{
410       \textcolor{comment}{//Report an error}
411       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
412    \}
413 
414    \textcolor{comment}{//Return status code}
415    \textcolor{keywordflow}{return} error;
416 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__handshake_8h_a8cb9f40f473b24c28c2168772da3b26d}\label{tls__handshake_8h_a8cb9f40f473b24c28c2168772da3b26d}} 
\index{tls\+\_\+handshake.\+h@{tls\+\_\+handshake.\+h}!tls\+Perform\+Handshake@{tls\+Perform\+Handshake}}
\index{tls\+Perform\+Handshake@{tls\+Perform\+Handshake}!tls\+\_\+handshake.\+h@{tls\+\_\+handshake.\+h}}
\subsubsection{\texorpdfstring{tls\+Perform\+Handshake()}{tlsPerformHandshake()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Perform\+Handshake (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Perform T\+LS handshake. 

T\+LS handshake protocol is responsible for the authentication and key exchange necessary to establish a secure session


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 114 of file tls\+\_\+handshake.\+c.


\begin{DoxyCode}
115 \{
116    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
117 
118 \textcolor{preprocessor}{#if (TLS\_CLIENT\_SUPPORT == ENABLED)}
119    \textcolor{comment}{//Client mode?}
120    \textcolor{keywordflow}{if}(context->entity == \hyperlink{tls_8h_acb21bc158664d823d899d760edd8135ba7f216418b2d898ed01cf9376fd9b3d6d}{TLS\_CONNECTION\_END\_CLIENT})
121    \{
122       \textcolor{comment}{//Perform TLS handshake with the remote server}
123       error = \hyperlink{tls__client__fsm_8c_ae64b68918d36ccfba6230c918fe3bf6e}{tlsPerformClientHandshake}(context);
124    \}
125    \textcolor{keywordflow}{else}
126 \textcolor{preprocessor}{#endif}
127 \textcolor{preprocessor}{#if (TLS\_SERVER\_SUPPORT == ENABLED)}
128    \textcolor{comment}{//Server mode?}
129    \textcolor{keywordflow}{if}(context->entity == \hyperlink{tls_8h_acb21bc158664d823d899d760edd8135ba3ddde9cb0be1b78b5b7e1e2ba1704a44}{TLS\_CONNECTION\_END\_SERVER})
130    \{
131       \textcolor{comment}{//Perform TLS handshake with the remote client}
132       error = \hyperlink{tls__server__fsm_8c_a28347628b27e36732d617324e8694ecd}{tlsPerformServerHandshake}(context);
133    \}
134    \textcolor{keywordflow}{else}
135 \textcolor{preprocessor}{#endif}
136    \textcolor{comment}{//Unsupported mode of operation?}
137    \{
138       \textcolor{comment}{//Report an error}
139       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
140    \}
141 
142    \textcolor{comment}{//Return status code}
143    \textcolor{keywordflow}{return} error;
144 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__handshake_8h_a56fc0a8992b1b7e5a2420f9557b39561}\label{tls__handshake_8h_a56fc0a8992b1b7e5a2420f9557b39561}} 
\index{tls\+\_\+handshake.\+h@{tls\+\_\+handshake.\+h}!tls\+Receive\+Handshake\+Message@{tls\+Receive\+Handshake\+Message}}
\index{tls\+Receive\+Handshake\+Message@{tls\+Receive\+Handshake\+Message}!tls\+\_\+handshake.\+h@{tls\+\_\+handshake.\+h}}
\subsubsection{\texorpdfstring{tls\+Receive\+Handshake\+Message()}{tlsReceiveHandshakeMessage()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Receive\+Handshake\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Receive peer\textquotesingle{}s message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 246 of file tls\+\_\+handshake.\+c.


\begin{DoxyCode}
247 \{
248    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
249    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
250    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
251    \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{TlsContentType} contentType;
252 
253 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
254    \textcolor{comment}{//DTLS protocol?}
255    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
256    \{
257       \textcolor{comment}{//A message can be fragmented across several DTLS records}
258       error = \hyperlink{dtls__record_8c_acdb1074243776f124182a136435bab6c}{dtlsReadProtocolData}(context, &data, &length, &contentType);
259    \}
260    \textcolor{keywordflow}{else}
261 \textcolor{preprocessor}{#endif}
262    \textcolor{comment}{//TLS protocol?}
263    \{
264       \textcolor{comment}{//A message can be fragmented across several TLS records}
265       error = \hyperlink{tls__record_8c_a801443c458f35a2640ec508b1ec1ecf6}{tlsReadProtocolData}(context, &data, &length, &contentType);
266    \}
267 
268    \textcolor{comment}{//Check status code}
269    \textcolor{keywordflow}{if}(!error)
270    \{
271       \textcolor{comment}{//Advance data pointer}
272       context->rxBufferPos += \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
273       \textcolor{comment}{//Number of bytes still pending in the receive buffer}
274       context->rxBufferLen -= \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
275 
276       \textcolor{comment}{//Handshake message received?}
277       \textcolor{keywordflow}{if}(contentType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca72077515f40a300c29899b5a3ba48682}{TLS\_TYPE\_HANDSHAKE})
278       \{
279          \textcolor{comment}{//Parse handshake message}
280          error = \hyperlink{tls__handshake_8c_ad8c84ebcfdd55f293c7b605273e750c2}{tlsParseHandshakeMessage}(context, data, length);
281       \}
282       \textcolor{comment}{//ChangeCipherSpec message received?}
283       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(contentType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca4a02e9d014afd5e75b90deefd3e5428c}{TLS\_TYPE\_CHANGE\_CIPHER\_SPEC})
284       \{
285          \textcolor{comment}{//The ChangeCipherSpec message is sent by an endpoint to notify the}
286          \textcolor{comment}{//peer that subsequent records will be protected under the newly}
287          \textcolor{comment}{//negotiated CipherSpec and keys}
288          error = \hyperlink{tls__common_8c_a5e337b2359ac1c81214620f4d4744f29}{tlsParseChangeCipherSpec}(context, (
      \hyperlink{tls_8h_a589c515096324e0d72dbaf58631c0501}{TlsChangeCipherSpec} *) data,
289             length);
290       \}
291       \textcolor{comment}{//Alert message received?}
292       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(contentType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896cac576c866dc3772236d51f16226adfbd9}{TLS\_TYPE\_ALERT})
293       \{
294          \textcolor{comment}{//Parse Alert message}
295          error = \hyperlink{tls__common_8c_abd3d66a2f80b812ee5db99a78191b795}{tlsParseAlert}(context, (\hyperlink{tls_8h_aae4f7171708af263a31b184f9747b17a}{TlsAlert} *) data, length);
296       \}
297 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
298       \textcolor{comment}{//Application data received?}
299       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(contentType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896caa8233b89b5c8f35ce7fcd1f644cbc0fc}{TLS\_TYPE\_APPLICATION\_DATA})
300       \{
301 \textcolor{preprocessor}{#if (TLS\_SERVER\_SUPPORT == ENABLED)}
302          \textcolor{comment}{//Server mode?}
303          \textcolor{keywordflow}{if}(context->entity == \hyperlink{tls_8h_acb21bc158664d823d899d760edd8135ba3ddde9cb0be1b78b5b7e1e2ba1704a44}{TLS\_CONNECTION\_END\_SERVER})
304          \{
305             \textcolor{comment}{//Process early data}
306             error = \hyperlink{tls13__server__misc_8h_a0ec77662e70f881c8676da0bc16fe195}{tls13ProcessEarlyData}(context, data, length);
307          \}
308          \textcolor{keywordflow}{else}
309 \textcolor{preprocessor}{#endif}
310          \{
311             \textcolor{comment}{//The server cannot transmit application data before the handshake}
312             \textcolor{comment}{//is completed}
313             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
314          \}
315       \}
316 \textcolor{preprocessor}{#endif}
317       \textcolor{comment}{//Unexpected message received?}
318       \textcolor{keywordflow}{else}
319       \{
320          \textcolor{comment}{//Abort the handshake with an unexpected\_message alert}
321          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
322       \}
323    \}
324 
325    \textcolor{comment}{//Return status code}
326    \textcolor{keywordflow}{return} error;
327 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__handshake_8h_ad729f5d4a23f051eebf844a6fe4964cd}\label{tls__handshake_8h_ad729f5d4a23f051eebf844a6fe4964cd}} 
\index{tls\+\_\+handshake.\+h@{tls\+\_\+handshake.\+h}!tls\+Send\+Handshake\+Message@{tls\+Send\+Handshake\+Message}}
\index{tls\+Send\+Handshake\+Message@{tls\+Send\+Handshake\+Message}!tls\+\_\+handshake.\+h@{tls\+\_\+handshake.\+h}}
\subsubsection{\texorpdfstring{tls\+Send\+Handshake\+Message()}{tlsSendHandshakeMessage()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Send\+Handshake\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const void $\ast$}]{data,  }\item[{size\+\_\+t}]{length,  }\item[{\hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9b}{Tls\+Message\+Type}}]{type }\end{DoxyParamCaption})}



Send handshake message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to the handshake message \\
\hline
\mbox{\tt in}  & {\em length} & Length of the handshake message \\
\hline
\mbox{\tt in}  & {\em type} & Handshake message type \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 156 of file tls\+\_\+handshake.\+c.


\begin{DoxyCode}
158 \{
159    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
160 
161 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
162    \textcolor{comment}{//DTLS protocol?}
163    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
164    \{
165       \hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
166 
167       \textcolor{comment}{//Point to the handshake message header}
168       message = (\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *) \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
169 
170       \textcolor{comment}{//Make room for the handshake message header}
171       memmove(message->data, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
172 
173       \textcolor{comment}{//Handshake message type}
174       message->msgType = \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type};
175       \textcolor{comment}{//Number of bytes in the message}
176       \hyperlink{cpu__endian_8h_acba352ed22d98efff17d0374c0790885}{STORE24BE}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, message->length);
177       \textcolor{comment}{//Message sequence number}
178       message->msgSeq = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(context->txMsgSeq);
179       \textcolor{comment}{//Fragment offset}
180       \hyperlink{cpu__endian_8h_acba352ed22d98efff17d0374c0790885}{STORE24BE}(0, message->fragOffset);
181       \textcolor{comment}{//Fragment length}
182       \hyperlink{cpu__endian_8h_acba352ed22d98efff17d0374c0790885}{STORE24BE}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, message->fragLength);
183 
184       \textcolor{comment}{//Whenever a new message is generated, the message sequence}
185       \textcolor{comment}{//number is incremented by one}
186       context->txMsgSeq++;
187 
188       \textcolor{comment}{//Total length of the handshake message}
189       \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
190    \}
191    \textcolor{keywordflow}{else}
192 \textcolor{preprocessor}{#endif}
193    \textcolor{comment}{//TLS protocol?}
194    \{
195       \hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
196 
197       \textcolor{comment}{//Point to the handshake message header}
198       message = (\hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake} *) \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
199 
200       \textcolor{comment}{//Make room for the handshake message header}
201       memmove(message->data, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
202 
203       \textcolor{comment}{//Handshake message type}
204       message->msgType = \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type};
205       \textcolor{comment}{//Number of bytes in the message}
206       \hyperlink{cpu__endian_8h_acba352ed22d98efff17d0374c0790885}{STORE24BE}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, message->length);
207 
208       \textcolor{comment}{//Total length of the handshake message}
209       \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake});
210    \}
211 
212    \textcolor{comment}{//The HelloRequest message must not be included in the message hashes}
213    \textcolor{comment}{//that are maintained throughout the handshake and used in the Finished}
214    \textcolor{comment}{//messages and the CertificateVerify message}
215    \textcolor{keywordflow}{if}(\hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type} != \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9baa9428dd744b7ffb47682aa40f988dd70}{TLS\_TYPE\_HELLO\_REQUEST})
216    \{
217       \hyperlink{tls__transcript__hash_8c_a8d1850c2779ca34d9ec197014384be77}{tlsUpdateTranscriptHash}(context, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
218    \}
219 
220 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
221    \textcolor{comment}{//DTLS protocol?}
222    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
223    \{
224       \textcolor{comment}{//Send handshake message}
225       error = \hyperlink{dtls__record_8c_ab15a3a01b2765ebf23f0fc72f1405f92}{dtlsWriteProtocolData}(context, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca72077515f40a300c29899b5a3ba48682}{TLS\_TYPE\_HANDSHAKE});
226    \}
227    \textcolor{keywordflow}{else}
228 \textcolor{preprocessor}{#endif}
229    \textcolor{comment}{//TLS protocol?}
230    \{
231       \textcolor{comment}{//Send handshake message}
232       error = \hyperlink{tls__record_8c_ae8f8c035d23eb99d1d5642d4ce644715}{tlsWriteProtocolData}(context, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, 
      \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca72077515f40a300c29899b5a3ba48682}{TLS\_TYPE\_HANDSHAKE});
233    \}
234 
235    \textcolor{comment}{//Return status code}
236    \textcolor{keywordflow}{return} error;
237 \}
\end{DoxyCode}
