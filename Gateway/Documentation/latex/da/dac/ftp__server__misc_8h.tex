\hypertarget{ftp__server__misc_8h}{}\section{cyclone\+\_\+tcp/ftp/ftp\+\_\+server\+\_\+misc.h File Reference}
\label{ftp__server__misc_8h}\index{cyclone\+\_\+tcp/ftp/ftp\+\_\+server\+\_\+misc.\+h@{cyclone\+\_\+tcp/ftp/ftp\+\_\+server\+\_\+misc.\+h}}


Helper functions for F\+TP server.  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ftp/ftp\+\_\+server.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{ftp__server__misc_8h_a7e6589130ad309cdc58d3275d127904b}{F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS}~(180 $\ast$ 86400)
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{ftp__server__misc_8h_a50a3cc62ee63d47c923b30ad23b20aef}{ftp\+Server\+Tick} (\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Handle periodic operations. \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{ftp__server__misc_8h_aa10a2ae6c1b6a6f25fdab668be0415c3}{ftp\+Server\+Get\+Passive\+Port} (\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Get a passive port number. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ftp__server__misc_8h_af55d165aa46a6edf5f8f603cc4671075}{ftp\+Server\+Get\+Path} (\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$connection, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$input\+Path, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$output\+Path, size\+\_\+t max\+Len)
\begin{DoxyCompactList}\small\item\em Retrieve the full pathname. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} \hyperlink{ftp__server__misc_8h_a5c8fef27bdd37ac48d983912577b8ac3}{ftp\+Server\+Get\+File\+Permissions} (\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$connection, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$path)
\begin{DoxyCompactList}\small\item\em Get permissions for the specified file or directory. \end{DoxyCompactList}\item 
size\+\_\+t \hyperlink{ftp__server__misc_8h_a01d9bcf3bf568909180f709c27234f28}{ftp\+Server\+Format\+Dir\+Entry} (const \hyperlink{structFsDirEntry}{Fs\+Dir\+Entry} $\ast$dir\+Entry, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} perm, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$buffer)
\begin{DoxyCompactList}\small\item\em Format a directory entry in U\+N\+I\+X-\/style format. \end{DoxyCompactList}\item 
const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$ \hyperlink{ftp__server__misc_8h_a30e8f42cce71fd1d85a4015bf3a1f97d}{ftp\+Server\+Strip\+Root\+Dir} (\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$context, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$path)
\begin{DoxyCompactList}\small\item\em Strip root dir from specified pathname. \end{DoxyCompactList}\item 
const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$ \hyperlink{ftp__server__misc_8h_a60770197d5fe8d7b61246dcec3b70af7}{ftp\+Server\+Strip\+Home\+Dir} (\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$connection, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$path)
\begin{DoxyCompactList}\small\item\em Strip home directory from specified pathname. \end{DoxyCompactList}\item 
void \hyperlink{ftp__server__misc_8h_a131bc4ee0544ae32eee4cf829f006a11}{ftp\+Server\+Close\+Connection} (\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Close client connection properly. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Helper functions for F\+TP server. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{ftp__server__misc_8h_a7e6589130ad309cdc58d3275d127904b}\label{ftp__server__misc_8h_a7e6589130ad309cdc58d3275d127904b}} 
\index{ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}!F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS@{F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS}}
\index{F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS@{F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS}!ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS}{FTP\_SERVER\_180\_DAYS}}
{\footnotesize\ttfamily \#define F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS~(180 $\ast$ 86400)}



Definition at line 39 of file ftp\+\_\+server\+\_\+misc.\+h.



\subsection{Function Documentation}
\mbox{\Hypertarget{ftp__server__misc_8h_a131bc4ee0544ae32eee4cf829f006a11}\label{ftp__server__misc_8h_a131bc4ee0544ae32eee4cf829f006a11}} 
\index{ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}!ftp\+Server\+Close\+Connection@{ftp\+Server\+Close\+Connection}}
\index{ftp\+Server\+Close\+Connection@{ftp\+Server\+Close\+Connection}!ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{ftp\+Server\+Close\+Connection()}{ftpServerCloseConnection()}}
{\footnotesize\ttfamily void ftp\+Server\+Close\+Connection (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Close client connection properly. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection to be closed \\
\hline
\end{DoxyParams}


Definition at line 386 of file ftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
387 \{
388    \textcolor{comment}{//Close data connection}
389    \hyperlink{ftp__server__data_8c_a62d97804710ebb11e8a1814fba4158a1}{ftpServerCloseDataChannel}(connection);
390    \textcolor{comment}{//Close control connection}
391    \hyperlink{ftp__server__control_8c_a555fc92281a4153d74f9617edea59df6}{ftpServerCloseControlChannel}(connection);
392 
393    \textcolor{comment}{//Valid file pointer?}
394    \textcolor{keywordflow}{if}(connection->file != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
395    \{
396       \textcolor{comment}{//Close file}
397       \hyperlink{fs__port__fatfs_8c_a563173066eb2924f61e00e87fbf9d0bc}{fsCloseFile}(connection->file);
398       connection->file = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
399    \}
400 
401    \textcolor{comment}{//Valid directory pointer?}
402    \textcolor{keywordflow}{if}(connection->dir != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
403    \{
404       \textcolor{comment}{//Close directory}
405       \hyperlink{fs__port__fatfs_8c_a94bfd6c1ae79880d0a5cbe3b491368f2}{fsCloseDir}(connection->dir);
406       connection->dir = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
407    \}
408 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__misc_8h_a01d9bcf3bf568909180f709c27234f28}\label{ftp__server__misc_8h_a01d9bcf3bf568909180f709c27234f28}} 
\index{ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}!ftp\+Server\+Format\+Dir\+Entry@{ftp\+Server\+Format\+Dir\+Entry}}
\index{ftp\+Server\+Format\+Dir\+Entry@{ftp\+Server\+Format\+Dir\+Entry}!ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{ftp\+Server\+Format\+Dir\+Entry()}{ftpServerFormatDirEntry()}}
{\footnotesize\ttfamily size\+\_\+t ftp\+Server\+Format\+Dir\+Entry (\begin{DoxyParamCaption}\item[{const \hyperlink{structFsDirEntry}{Fs\+Dir\+Entry} $\ast$}]{dir\+Entry,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{perm,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{buffer }\end{DoxyParamCaption})}



Format a directory entry in U\+N\+I\+X-\/style format. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em dir\+Entry} & Pointer to the directory entry \\
\hline
\mbox{\tt in}  & {\em perm} & Access rights for the specified file \\
\hline
\mbox{\tt out}  & {\em buffer} & Buffer where to format the directory entry \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Length of resulting string, in bytes 
\end{DoxyReturn}


Definition at line 233 of file ftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
235 \{
236    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
237    time\_t \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
238    time\_t modified;
239 
240    \textcolor{comment}{//Abbreviated months}
241    \textcolor{keyword}{static} \textcolor{keyword}{const} \textcolor{keywordtype}{char} \hyperlink{date__time_8c_a28e16ae8240a8338b89ff5929f9b274f}{months}[13][4] =
242    \{
243       \textcolor{stringliteral}{"   "},
244       \textcolor{stringliteral}{"Jan"},
245       \textcolor{stringliteral}{"Feb"},
246       \textcolor{stringliteral}{"Mar"},
247       \textcolor{stringliteral}{"Apr"},
248       \textcolor{stringliteral}{"May"},
249       \textcolor{stringliteral}{"Jun"},
250       \textcolor{stringliteral}{"Jul"},
251       \textcolor{stringliteral}{"Aug"},
252       \textcolor{stringliteral}{"Sep"},
253       \textcolor{stringliteral}{"Oct"},
254       \textcolor{stringliteral}{"Nov"},
255       \textcolor{stringliteral}{"Dec"}
256    \};
257 
258    \textcolor{comment}{//Format links, owner, group and size fields}
259    n = sprintf(buffer, \textcolor{stringliteral}{"----------   1 owner    group    %10"} PRIu32,
260       dirEntry->\hyperlink{structFsDirEntry_acface51e05962d480c731d0b0c7b1d0e}{size});
261 
262    \textcolor{comment}{//Check whether the current entry is a directory}
263    \textcolor{keywordflow}{if}(dirEntry->\hyperlink{structFsDirEntry_ae6bc73c8708ef8541ed7dc2c5f802e96}{attributes} & \hyperlink{fs__port_8h_a2edaa29f659eebea8cf331b1066405a3a24f8258160b4e054c565570b6260db96}{FS\_FILE\_ATTR\_DIRECTORY})
264    \{
265       buffer[0] = \textcolor{charliteral}{'d'};
266    \}
267 
268    \textcolor{comment}{//Read access permitted?}
269    \textcolor{keywordflow}{if}(perm & \hyperlink{ftp__server_8h_aa941a819cc54df0f491b11d56ebe4a5ea2f3957b04a30fc147df1c3818e26fe1b}{FTP\_FILE\_PERM\_READ})
270    \{
271       buffer[1] = \textcolor{charliteral}{'r'};
272       buffer[4] = \textcolor{charliteral}{'r'};
273       buffer[7] = \textcolor{charliteral}{'r'};
274    \}
275 
276    \textcolor{comment}{//Write access permitted?}
277    \textcolor{keywordflow}{if}(perm & \hyperlink{ftp__server_8h_aa941a819cc54df0f491b11d56ebe4a5eab2002a5415790b9b7318f8067f623ff0}{FTP\_FILE\_PERM\_WRITE})
278    \{
279       \textcolor{comment}{//Make sure the file is not marked as read-only}
280       \textcolor{keywordflow}{if}(!(dirEntry->\hyperlink{structFsDirEntry_ae6bc73c8708ef8541ed7dc2c5f802e96}{attributes} & \hyperlink{fs__port_8h_a2edaa29f659eebea8cf331b1066405a3a218468508475fb0ef7155299f48fc9e5}{FS\_FILE\_ATTR\_READ\_ONLY}))
281       \{
282          buffer[2] = \textcolor{charliteral}{'w'};
283          buffer[5] = \textcolor{charliteral}{'w'};
284          buffer[8] = \textcolor{charliteral}{'w'};
285       \}
286    \}
287 
288    \textcolor{comment}{//Get current time}
289    time = \hyperlink{date__time_8c_a5ea5d60e1fafcd89917ee76d57981aae}{getCurrentUnixTime}();
290    \textcolor{comment}{//Get modification time}
291    modified = \hyperlink{date__time_8c_a399c87076e1ac03c9542ba1544c06f21}{convertDateToUnixTime}(&dirEntry->\hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified});
292 
293    \textcolor{comment}{//Check whether the modification time is within the previous 180 days}
294    \textcolor{keywordflow}{if}(time > modified && time < (modified + \hyperlink{ftp__server__events_8h_a7e6589130ad309cdc58d3275d127904b}{FTP\_SERVER\_180\_DAYS}))
295    \{
296       \textcolor{comment}{//The format of the date/time field is Mmm dd hh:mm}
297       n += sprintf(buffer + n, \textcolor{stringliteral}{" %s %02"} PRIu8 \textcolor{stringliteral}{" %02"} PRIu8 \textcolor{stringliteral}{":%02"} PRIu8,
298          months[\hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(dirEntry->\hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.\hyperlink{structDateTime_ac895afb51c74941c50205f746b709148}{month}, 12)], dirEntry->
      \hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.\hyperlink{structDateTime_a727866b5ecdfda1edf946efe86aa74af}{day},
299          dirEntry->\hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.\hyperlink{structDateTime_a46fa4e0c13c7fc19c8ae97a5642c4a15}{hours}, dirEntry->\hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.
      \hyperlink{structDateTime_a9e705a28fc51e333616553313107d579}{minutes});
300    \}
301    \textcolor{keywordflow}{else}
302    \{
303       \textcolor{comment}{//The format of the date/time field is Mmm dd  yyyy}
304       n += sprintf(buffer + n, \textcolor{stringliteral}{" %s %02"} PRIu8 \textcolor{stringliteral}{"  %04"} PRIu16,
305          months[\hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(dirEntry->\hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.\hyperlink{structDateTime_ac895afb51c74941c50205f746b709148}{month}, 12)], dirEntry->
      \hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.\hyperlink{structDateTime_a727866b5ecdfda1edf946efe86aa74af}{day},
306          dirEntry->\hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.\hyperlink{structDateTime_a0a61d60280541502e47f9a7fd6e1c8d2}{year});
307    \}
308 
309    \textcolor{comment}{//Append filename}
310    n += sprintf(buffer + n, \textcolor{stringliteral}{" %s\(\backslash\)r\(\backslash\)n"}, dirEntry->\hyperlink{structFsDirEntry_ab2a81b6bc89dc202e25448d2afdbae5b}{name});
311 
312    \textcolor{comment}{//Return the length of the resulting string, in bytes}
313    \textcolor{keywordflow}{return} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
314 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__misc_8h_a5c8fef27bdd37ac48d983912577b8ac3}\label{ftp__server__misc_8h_a5c8fef27bdd37ac48d983912577b8ac3}} 
\index{ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}!ftp\+Server\+Get\+File\+Permissions@{ftp\+Server\+Get\+File\+Permissions}}
\index{ftp\+Server\+Get\+File\+Permissions@{ftp\+Server\+Get\+File\+Permissions}!ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{ftp\+Server\+Get\+File\+Permissions()}{ftpServerGetFilePermissions()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} ftp\+Server\+Get\+File\+Permissions (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{path }\end{DoxyParamCaption})}



Get permissions for the specified file or directory. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em path} & Canonical path of the file \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Access rights for the specified file 
\end{DoxyReturn}


Definition at line 182 of file ftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
184 \{
185    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
186    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} perm;
187    \hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{FtpServerContext} *context;
188 
189    \textcolor{comment}{//Point to the FTP server context}
190    context = connection->context;
191 
192    \textcolor{comment}{//Calculate the length of the home directory}
193    n = strlen(connection->homeDir);
194 
195    \textcolor{comment}{//Make sure the pathname is valid}
196    \textcolor{keywordflow}{if}(!strncmp(path, connection->homeDir, n))
197    \{
198       \textcolor{comment}{//Strip root directory from the pathname}
199       path = \hyperlink{ftp__server__misc_8c_a30e8f42cce71fd1d85a4015bf3a1f97d}{ftpServerStripRootDir}(context, path);
200 
201       \textcolor{comment}{//Invoke user-defined callback, if any}
202       \textcolor{keywordflow}{if}(context->settings.getFilePermCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
203       \{
204          \textcolor{comment}{//Retrieve access rights for the specified file}
205          perm = context->settings.getFilePermCallback(connection,
206             connection->user, path);
207       \}
208       \textcolor{keywordflow}{else}
209       \{
210          \textcolor{comment}{//Use default access rights}
211          perm = \hyperlink{ftp__server_8h_aa941a819cc54df0f491b11d56ebe4a5eaeede2660186e1e3800757ec2c6744df6}{FTP\_FILE\_PERM\_LIST} | \hyperlink{ftp__server_8h_aa941a819cc54df0f491b11d56ebe4a5ea2f3957b04a30fc147df1c3818e26fe1b}{FTP\_FILE\_PERM\_READ} | 
      \hyperlink{ftp__server_8h_aa941a819cc54df0f491b11d56ebe4a5eab2002a5415790b9b7318f8067f623ff0}{FTP\_FILE\_PERM\_WRITE};
212       \}
213    \}
214    \textcolor{keywordflow}{else}
215    \{
216       \textcolor{comment}{//The specified pathname is not valid}
217       perm = 0;
218    \}
219 
220    \textcolor{comment}{//Return access rights}
221    \textcolor{keywordflow}{return} perm;
222 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__misc_8h_aa10a2ae6c1b6a6f25fdab668be0415c3}\label{ftp__server__misc_8h_aa10a2ae6c1b6a6f25fdab668be0415c3}} 
\index{ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}!ftp\+Server\+Get\+Passive\+Port@{ftp\+Server\+Get\+Passive\+Port}}
\index{ftp\+Server\+Get\+Passive\+Port@{ftp\+Server\+Get\+Passive\+Port}!ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{ftp\+Server\+Get\+Passive\+Port()}{ftpServerGetPassivePort()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} ftp\+Server\+Get\+Passive\+Port (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Get a passive port number. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP server context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Passive port number 
\end{DoxyReturn}


Definition at line 88 of file ftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
89 \{
90    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port};
91 
92    \textcolor{comment}{//Retrieve current passive port number}
93    port = context->passivePort;
94 
95    \textcolor{comment}{//Invalid port number?}
96    \textcolor{keywordflow}{if}(port < context->settings.passivePortMin ||
97       port > context->settings.passivePortMax)
98    \{
99       \textcolor{comment}{//Generate a random port number}
100       port = context->settings.passivePortMin + \hyperlink{net_8c_a7bb00b31d641749ac8ce742261eb1f6d}{netGetRand}() %
101          (context->settings.passivePortMax - context->settings.passivePortMin + 1);
102    \}
103 
104    \textcolor{comment}{//Next passive port to use}
105    \textcolor{keywordflow}{if}(port < context->settings.passivePortMax)
106    \{
107       \textcolor{comment}{//Increment port number}
108       context->passivePort = port + 1;
109    \}
110    \textcolor{keywordflow}{else}
111    \{
112       \textcolor{comment}{//Wrap around if necessary}
113       context->passivePort = context->settings.passivePortMin;
114    \}
115 
116    \textcolor{comment}{//Return the passive port number}
117    \textcolor{keywordflow}{return} \hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port};
118 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__misc_8h_af55d165aa46a6edf5f8f603cc4671075}\label{ftp__server__misc_8h_af55d165aa46a6edf5f8f603cc4671075}} 
\index{ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}!ftp\+Server\+Get\+Path@{ftp\+Server\+Get\+Path}}
\index{ftp\+Server\+Get\+Path@{ftp\+Server\+Get\+Path}!ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{ftp\+Server\+Get\+Path()}{ftpServerGetPath()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ftp\+Server\+Get\+Path (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{input\+Path,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{output\+Path,  }\item[{size\+\_\+t}]{max\+Len }\end{DoxyParamCaption})}



Retrieve the full pathname. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em input\+Path} & Relative or absolute path \\
\hline
\mbox{\tt out}  & {\em output\+Path} & Resulting full path \\
\hline
\mbox{\tt in}  & {\em max\+Len} & Maximum acceptable path length \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 130 of file ftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
132 \{
133    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
134 
135    \textcolor{comment}{//Relative or absolute path?}
136    \textcolor{keywordflow}{if}(\hyperlink{path_8c_ad91b37d05d6572c1525086e8f2646774}{pathIsRelative}(inputPath))
137    \{
138       \textcolor{comment}{//Sanity check}
139       \textcolor{keywordflow}{if}(strlen(connection->currentDir) > maxLen)
140          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
141 
142       \textcolor{comment}{//Copy current directory}
143       strcpy(outputPath, connection->currentDir);
144       \textcolor{comment}{//Append the specified path}
145       \hyperlink{path_8c_a38625df4e9abd106fb932b8ff308adc3}{pathCombine}(outputPath, inputPath, maxLen);
146    \}
147    \textcolor{keywordflow}{else}
148    \{
149       \textcolor{comment}{//Sanity check}
150       \textcolor{keywordflow}{if}(strlen(connection->homeDir) > maxLen)
151          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
152 
153       \textcolor{comment}{//Copy home directory}
154       strcpy(outputPath, connection->homeDir);
155       \textcolor{comment}{//Append the specified path}
156       \hyperlink{path_8c_a38625df4e9abd106fb932b8ff308adc3}{pathCombine}(outputPath, inputPath, maxLen);
157    \}
158 
159    \textcolor{comment}{//Clean the resulting path}
160    \hyperlink{path_8c_a64519f81386b6ece797fb51f06e3052d}{pathCanonicalize}(outputPath);
161    \hyperlink{path_8c_af03ec9a7da6f93032b4ea949a4d0d768}{pathRemoveSlash}(outputPath);
162 
163    \textcolor{comment}{//Calculate the length of the home directory}
164    n = strlen(connection->homeDir);
165 
166    \textcolor{comment}{//Make sure the pathname is valid}
167    \textcolor{keywordflow}{if}(strncmp(outputPath, connection->homeDir, n))
168       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca62bb3e19c7e34b7eaf8e1fdadd52149c}{ERROR\_INVALID\_PATH};
169 
170    \textcolor{comment}{//Successful processing}
171    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
172 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__misc_8h_a60770197d5fe8d7b61246dcec3b70af7}\label{ftp__server__misc_8h_a60770197d5fe8d7b61246dcec3b70af7}} 
\index{ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}!ftp\+Server\+Strip\+Home\+Dir@{ftp\+Server\+Strip\+Home\+Dir}}
\index{ftp\+Server\+Strip\+Home\+Dir@{ftp\+Server\+Strip\+Home\+Dir}!ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{ftp\+Server\+Strip\+Home\+Dir()}{ftpServerStripHomeDir()}}
{\footnotesize\ttfamily const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t}$\ast$ ftp\+Server\+Strip\+Home\+Dir (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{path }\end{DoxyParamCaption})}



Strip home directory from specified pathname. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em path} & input pathname \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Resulting pathname with home directory stripped 
\end{DoxyReturn}


Definition at line 356 of file ftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
358 \{
359    \textcolor{comment}{//Default directory}
360    \textcolor{keyword}{static} \textcolor{keyword}{const} \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} defaultDir[] = \textcolor{stringliteral}{"/"};
361 
362    \textcolor{comment}{//Local variables}
363    \textcolor{keywordtype}{size\_t} \hyperlink{ndp_8h_a6b3284d8492267a77ca46948daf5545e}{m};
364    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
365 
366    \textcolor{comment}{//Retrieve the length of the home directory}
367    n = strlen(connection->homeDir);
368    \textcolor{comment}{//Retrieve the length of the specified pathname}
369    m = strlen(path);
370 
371    \textcolor{comment}{//Strip the home directory from the specified pathname}
372    \textcolor{keywordflow}{if}(n <= 1)
373       \textcolor{keywordflow}{return} path;
374    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(n < m)
375       \textcolor{keywordflow}{return} path + \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
376    \textcolor{keywordflow}{else}
377       \textcolor{keywordflow}{return} defaultDir;
378 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__misc_8h_a30e8f42cce71fd1d85a4015bf3a1f97d}\label{ftp__server__misc_8h_a30e8f42cce71fd1d85a4015bf3a1f97d}} 
\index{ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}!ftp\+Server\+Strip\+Root\+Dir@{ftp\+Server\+Strip\+Root\+Dir}}
\index{ftp\+Server\+Strip\+Root\+Dir@{ftp\+Server\+Strip\+Root\+Dir}!ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{ftp\+Server\+Strip\+Root\+Dir()}{ftpServerStripRootDir()}}
{\footnotesize\ttfamily const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t}$\ast$ ftp\+Server\+Strip\+Root\+Dir (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$}]{context,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{path }\end{DoxyParamCaption})}



Strip root dir from specified pathname. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP server context \\
\hline
\mbox{\tt in}  & {\em path} & input pathname \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Resulting pathname with root dir stripped 
\end{DoxyReturn}


Definition at line 324 of file ftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
326 \{
327    \textcolor{comment}{//Default directory}
328    \textcolor{keyword}{static} \textcolor{keyword}{const} \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} defaultDir[] = \textcolor{stringliteral}{"/"};
329 
330    \textcolor{comment}{//Local variables}
331    \textcolor{keywordtype}{size\_t} \hyperlink{ndp_8h_a6b3284d8492267a77ca46948daf5545e}{m};
332    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
333 
334    \textcolor{comment}{//Retrieve the length of the root directory}
335    n = strlen(context->settings.rootDir);
336    \textcolor{comment}{//Retrieve the length of the specified pathname}
337    m = strlen(path);
338 
339    \textcolor{comment}{//Strip the root dir from the specified pathname}
340    \textcolor{keywordflow}{if}(n <= 1)
341       \textcolor{keywordflow}{return} path;
342    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(n < m)
343       \textcolor{keywordflow}{return} path + \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
344    \textcolor{keywordflow}{else}
345       \textcolor{keywordflow}{return} defaultDir;
346 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__misc_8h_a50a3cc62ee63d47c923b30ad23b20aef}\label{ftp__server__misc_8h_a50a3cc62ee63d47c923b30ad23b20aef}} 
\index{ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}!ftp\+Server\+Tick@{ftp\+Server\+Tick}}
\index{ftp\+Server\+Tick@{ftp\+Server\+Tick}!ftp\+\_\+server\+\_\+misc.\+h@{ftp\+\_\+server\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{ftp\+Server\+Tick()}{ftpServerTick()}}
{\footnotesize\ttfamily void ftp\+Server\+Tick (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Handle periodic operations. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP server context \\
\hline
\end{DoxyParams}


Definition at line 51 of file ftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
52 \{
53    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
54    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
55    \hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{FtpClientConnection} *connection;
56 
57    \textcolor{comment}{//Get current time}
58    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
59 
60    \textcolor{comment}{//Loop through the connection table}
61    \textcolor{keywordflow}{for}(i = 0; i < context->settings.maxConnections; i++)
62    \{
63       \textcolor{comment}{//Point to the current entry}
64       connection = &context->connections[i];
65 
66       \textcolor{comment}{//Check the state of the current connection}
67       \textcolor{keywordflow}{if}(connection->controlChannel.state != \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156bab3165039e718584ac932b07402ac08f2}{FTP\_CHANNEL\_STATE\_CLOSED})
68       \{
69          \textcolor{comment}{//Disconnect inactive client after idle timeout}
70          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, connection->timestamp + 
      \hyperlink{ftp__server_8h_a3b76e666e83f88781c7407a0a0e748e4}{FTP\_SERVER\_TIMEOUT}) >= 0)
71          \{
72             \textcolor{comment}{//Debug message}
73             \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"FTP server: Closing inactive connection...\(\backslash\)r\(\backslash\)n"});
74             \textcolor{comment}{//Close connection with the client}
75             \hyperlink{ftp__server__misc_8c_a131bc4ee0544ae32eee4cf829f006a11}{ftpServerCloseConnection}(connection);
76          \}
77       \}
78    \}
79 \}
\end{DoxyCode}
