\hypertarget{coap__client__block_8h}{}\section{cyclone\+\_\+tcp/coap/coap\+\_\+client\+\_\+block.h File Reference}
\label{coap__client__block_8h}\index{cyclone\+\_\+tcp/coap/coap\+\_\+client\+\_\+block.\+h@{cyclone\+\_\+tcp/coap/coap\+\_\+client\+\_\+block.\+h}}


Co\+AP block-\/wise transfer.  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}coap/coap\+\_\+client.\+h\char`\"{}}\newline
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{coap__client__block_8h_ac2ab62e6cddc494a3a66aa7d7bf005d5}{coap\+Client\+Set\+Tx\+Block\+Size} (\hyperlink{coap__client_8h_a3dac6728ded461f458ffd870eca7afe7}{Coap\+Client\+Request} $\ast$request, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} block\+Size)
\begin{DoxyCompactList}\small\item\em Set preferred block for transmission path. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{coap__client__block_8h_aa401f127c540df6fd24461fdfced4b77}{coap\+Client\+Set\+Rx\+Block\+Size} (\hyperlink{coap__client_8h_a3dac6728ded461f458ffd870eca7afe7}{Coap\+Client\+Request} $\ast$request, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} block\+Size)
\begin{DoxyCompactList}\small\item\em Set preferred block for reception path. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{coap__client__block_8h_a621577ba04c7e3766e39b88b729e0da6}{coap\+Client\+Write\+Body} (\hyperlink{coap__client_8h_a3dac6728ded461f458ffd870eca7afe7}{Coap\+Client\+Request} $\ast$request, const void $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, size\+\_\+t $\ast$written, \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} \hyperlink{ipv6__frag_8h_a7179af054cf318941e1a12e964965935}{last})
\begin{DoxyCompactList}\small\item\em Write resource body using block-\/wise mode. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{coap__client__block_8h_aec9e70ad776619af1bbce04c98eab427}{coap\+Client\+Read\+Body} (\hyperlink{coap__client_8h_a3dac6728ded461f458ffd870eca7afe7}{Coap\+Client\+Request} $\ast$request, void $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t size, size\+\_\+t $\ast$received)
\begin{DoxyCompactList}\small\item\em Read resource body using block-\/wise mode. \end{DoxyCompactList}\item 
\hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8}{Coap\+Block\+Size} \hyperlink{coap__client__block_8h_a0f3723fd9e1a0944ec21ec50ae85206f}{coap\+Client\+Get\+Max\+Block\+Size} (void)
\begin{DoxyCompactList}\small\item\em Get maximum block size. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Co\+AP block-\/wise transfer. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Function Documentation}
\mbox{\Hypertarget{coap__client__block_8h_a0f3723fd9e1a0944ec21ec50ae85206f}\label{coap__client__block_8h_a0f3723fd9e1a0944ec21ec50ae85206f}} 
\index{coap\+\_\+client\+\_\+block.\+h@{coap\+\_\+client\+\_\+block.\+h}!coap\+Client\+Get\+Max\+Block\+Size@{coap\+Client\+Get\+Max\+Block\+Size}}
\index{coap\+Client\+Get\+Max\+Block\+Size@{coap\+Client\+Get\+Max\+Block\+Size}!coap\+\_\+client\+\_\+block.\+h@{coap\+\_\+client\+\_\+block.\+h}}
\subsubsection{\texorpdfstring{coap\+Client\+Get\+Max\+Block\+Size()}{coapClientGetMaxBlockSize()}}
{\footnotesize\ttfamily \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8}{Coap\+Block\+Size} coap\+Client\+Get\+Max\+Block\+Size (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Get maximum block size. 

\begin{DoxyReturn}{Returns}
Block size 
\end{DoxyReturn}


Definition at line 553 of file coap\+\_\+client\+\_\+block.\+c.


\begin{DoxyCode}
554 \{
555    \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8}{CoapBlockSize} blockSize;
556 
557    \textcolor{comment}{//Retrieve maximum block size}
558 \textcolor{preprocessor}{#if (COAP\_MAX\_MSG\_SIZE > 1024)}
559    blockSize = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ab8b9efb919c4d721145b4e7df685c4c0}{COAP\_BLOCK\_SIZE\_1024};
560 \textcolor{preprocessor}{#elif (COAP\_MAX\_MSG\_SIZE > 512)}
561    blockSize = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8a284cde1d86aa887ff1acdfbfba1b0ed3}{COAP\_BLOCK\_SIZE\_512};
562 \textcolor{preprocessor}{#elif (COAP\_MAX\_MSG\_SIZE > 256)}
563    blockSize = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ab4b3d2739379f93c3b720cf28b4a8430}{COAP\_BLOCK\_SIZE\_256};
564 \textcolor{preprocessor}{#elif (COAP\_MAX\_MSG\_SIZE > 128)}
565    blockSize = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ab024418bf9766ce7373b999ba1a4f30a}{COAP\_BLOCK\_SIZE\_128};
566 \textcolor{preprocessor}{#elif (COAP\_MAX\_MSG\_SIZE > 64)}
567    blockSize = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ace36ecacac80357174a4bc5e7758c79b}{COAP\_BLOCK\_SIZE\_64};
568 \textcolor{preprocessor}{#elif (COAP\_MAX\_MSG\_SIZE > 32)}
569    blockSize = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8a5d5d3ef1e829133c441b714bab3cb204}{COAP\_BLOCK\_SIZE\_32};
570 \textcolor{preprocessor}{#else}
571    blockSize = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8a830c70b5e7a7d3816f1d8f64acc9722a}{COAP\_BLOCK\_SIZE\_16};
572 \textcolor{preprocessor}{#endif}
573 
574    \textcolor{comment}{//Return maximum block size}
575    \textcolor{keywordflow}{return} blockSize;
576 \}
\end{DoxyCode}
\mbox{\Hypertarget{coap__client__block_8h_aec9e70ad776619af1bbce04c98eab427}\label{coap__client__block_8h_aec9e70ad776619af1bbce04c98eab427}} 
\index{coap\+\_\+client\+\_\+block.\+h@{coap\+\_\+client\+\_\+block.\+h}!coap\+Client\+Read\+Body@{coap\+Client\+Read\+Body}}
\index{coap\+Client\+Read\+Body@{coap\+Client\+Read\+Body}!coap\+\_\+client\+\_\+block.\+h@{coap\+\_\+client\+\_\+block.\+h}}
\subsubsection{\texorpdfstring{coap\+Client\+Read\+Body()}{coapClientReadBody()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} coap\+Client\+Read\+Body (\begin{DoxyParamCaption}\item[{\hyperlink{coap__client_8h_a3dac6728ded461f458ffd870eca7afe7}{Coap\+Client\+Request} $\ast$}]{request,  }\item[{void $\ast$}]{data,  }\item[{size\+\_\+t}]{size,  }\item[{size\+\_\+t $\ast$}]{received }\end{DoxyParamCaption})}



Read resource body using block-\/wise mode. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em request} & Co\+AP request handle \\
\hline
\mbox{\tt out}  & {\em data} & Buffer into which received data will be placed \\
\hline
\mbox{\tt in}  & {\em size} & Maximum number of bytes that can be received \\
\hline
\mbox{\tt out}  & {\em received} & Number of bytes that have been received \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 359 of file coap\+\_\+client\+\_\+block.\+c.


\begin{DoxyCode}
361 \{
362    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
363    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
364    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
365    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} blockPos;
366    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} blockSzx;
367    \textcolor{keywordtype}{size\_t} \hyperlink{ipv6_8h_ae4d38aba40b6dddf544612da0726cd7e}{payloadLen};
368    \textcolor{keyword}{const} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *payload;
369    \hyperlink{structCoapMessage}{CoapMessage} *requestMsg;
370    \hyperlink{structCoapMessage}{CoapMessage} *responseMsg;
371    \hyperlink{coap__common_8h_af91e1fbf0a9ca1f9175e6049c9f2680e}{CoapCode} responseCode;
372 
373    \textcolor{comment}{//Initialize status code}
374    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
375 
376    \textcolor{comment}{//Total number of bytes that have been received}
377    *received = 0;
378 
379    \textcolor{comment}{//Block-wise transfers are realized as combinations of exchanges, each}
380    \textcolor{comment}{//of which is performed according to the CoAP base protocol}
381    \textcolor{keywordflow}{while}(*received < size)
382    \{
383       \textcolor{comment}{//Point to the response message}
384       responseMsg = \hyperlink{coap__client__request_8c_ab8831a171211717a75e7304cebec7821}{coapClientGetResponseMessage}(request);
385 
386       \textcolor{comment}{//Read payload data}
387       error = \hyperlink{coap__client__request_8c_a2da0d276ec4cac1a4e67a5b061241390}{coapClientReadPayload}(responseMsg, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size - *received, &n);
388 
389       \textcolor{comment}{//Check status code}
390       \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
391       \{
392          \textcolor{comment}{//Advance data pointer}
393          \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} + n;
394 
395          \textcolor{comment}{//Total number of bytes that have been received}
396          *received += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
397       \}
398       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca8b7223773301a4f3dd811f1d35e13ce4}{ERROR\_END\_OF\_STREAM})
399       \{
400          \textcolor{comment}{//Point to the request message}
401          requestMsg = \hyperlink{coap__client__request_8c_a3a3a39a5c6725120f715ac031f412277}{coapClientGetRequestMessage}(request);
402 
403          \textcolor{comment}{//A Block2 Option is used in control usage in a request}
404          error = \hyperlink{coap__client__request_8c_a9aec664a9fa5adc7d61beb0c3970ac8b}{coapClientGetUintOption}(requestMsg, 
      \hyperlink{coap__option_8h_ab833642841b9ddc4cab90acf5cffb0e7a5c471307a51b53ed7bf1c06a21a6dc64}{COAP\_OPT\_BLOCK2}, 0,
405             &value);
406 
407          \textcolor{comment}{//Block2 option found?}
408          \textcolor{keywordflow}{if}(!error)
409          \{
410             \textcolor{comment}{//Retrieve current block parameters}
411             blockPos = \hyperlink{coap__option_8h_af476c3ecbec55a048b64100ae4e634ad}{COAP\_GET\_BLOCK\_POS}(value);
412             blockSzx = \hyperlink{coap__option_8h_a66414e735018b7e4c61a954124707b0b}{COAP\_GET\_BLOCK\_SZX}(value);
413          \}
414          \textcolor{keywordflow}{else}
415          \{
416             \textcolor{comment}{//Initialize block parameters}
417             blockPos = 0;
418             blockSzx = request->rxBlockSzx;
419          \}
420 
421          \textcolor{comment}{//Block2 option is used in descriptive usage in a response}
422          error = \hyperlink{coap__client__request_8c_a9aec664a9fa5adc7d61beb0c3970ac8b}{coapClientGetUintOption}(responseMsg, 
      \hyperlink{coap__option_8h_ab833642841b9ddc4cab90acf5cffb0e7a5c471307a51b53ed7bf1c06a21a6dc64}{COAP\_OPT\_BLOCK2}, 0,
423             &value);
424 
425          \textcolor{comment}{//Block-wise transfer?}
426          \textcolor{keywordflow}{if}(!error)
427          \{
428             \textcolor{comment}{//The value 7 for SZX is reserved}
429             \textcolor{keywordflow}{if}(\hyperlink{coap__option_8h_a66414e735018b7e4c61a954124707b0b}{COAP\_GET\_BLOCK\_SZX}(value) >= 
      \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ad9b1ead02f5dd9599b4080b74c6adb43}{COAP\_BLOCK\_SIZE\_RESERVED})
430             \{
431                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
432                \textcolor{keywordflow}{break};
433             \}
434 
435             \textcolor{comment}{//The NUM field in the option value describes what block number}
436             \textcolor{comment}{//is contained in the payload of this message}
437             \textcolor{keywordflow}{if}(\hyperlink{coap__option_8h_af476c3ecbec55a048b64100ae4e634ad}{COAP\_GET\_BLOCK\_POS}(value) != blockPos)
438             \{
439                \textcolor{comment}{//Report an error}
440                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
441                \textcolor{keywordflow}{break};
442             \}
443 
444             \textcolor{comment}{//The M bit indicates whether further blocks need to be}
445             \textcolor{comment}{//transferred to complete the transfer of that body}
446             \textcolor{keywordflow}{if}(!\hyperlink{coap__option_8h_ace229e0410332b47e02ff58dea5c447f}{COAP\_GET\_BLOCK\_M}(value))
447             \{
448                \textcolor{comment}{//Exit immediately}
449                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca8b7223773301a4f3dd811f1d35e13ce4}{ERROR\_END\_OF\_STREAM};
450                \textcolor{keywordflow}{break};
451             \}
452 
453             \textcolor{comment}{//Retrieve the length of the payload}
454             error = \hyperlink{coap__client__request_8c_a8ff6bac5add283786dc14e6dd84a89ae}{coapClientGetPayload}(responseMsg, &payload, &payloadLen);
455             \textcolor{comment}{//Any error to report?}
456             \textcolor{keywordflow}{if}(error)
457                \textcolor{keywordflow}{break};
458 
459             \textcolor{comment}{//Make sure the length of the payload matches the block size}
460             \textcolor{keywordflow}{if}(payloadLen != \hyperlink{coap__option_8h_add186aa746976d5f8c99ef54044b2263}{COAP\_GET\_BLOCK\_SIZE}(value))
461             \{
462                \textcolor{comment}{//Report an error}
463                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
464                \textcolor{keywordflow}{break};
465             \}
466 
467             \textcolor{comment}{//If the first request uses a bigger block size than the receiver}
468             \textcolor{comment}{//prefers, subsequent requests will use the preferred block size}
469             \textcolor{keywordflow}{if}(blockSzx > \hyperlink{coap__option_8h_a66414e735018b7e4c61a954124707b0b}{COAP\_GET\_BLOCK\_SZX}(value))
470                blockSzx = \hyperlink{coap__option_8h_a66414e735018b7e4c61a954124707b0b}{COAP\_GET\_BLOCK\_SZX}(value);
471 
472             \textcolor{comment}{//Next block}
473             blockPos += \hyperlink{coap__option_8h_add186aa746976d5f8c99ef54044b2263}{COAP\_GET\_BLOCK\_SIZE}(value);
474 
475             \textcolor{comment}{//The NUM field in the Block2 option gives the block number of the}
476             \textcolor{comment}{//payload that is being requested to be returned in the response}
477             \hyperlink{coap__option_8h_aed9ed8570bb73135e19a61861b2f562f}{COAP\_SET\_BLOCK\_NUM}(value, blockPos >> (blockSzx + 4));
478 
479             \textcolor{comment}{//the M bit has no function and must be set to zero}
480             \hyperlink{coap__option_8h_a9aa6c7a639f193b8824954b1c0a9074c}{COAP\_SET\_BLOCK\_M}(value, 0);
481 
482             \textcolor{comment}{//The block size given suggests a block size (in the case of block}
483             \textcolor{comment}{//number 0) or repeats the block size of previous blocks received}
484             \textcolor{comment}{//(in the case of a non-zero block number)}
485             \hyperlink{coap__option_8h_adc27c995b190e918d48a1c92dae148e9}{COAP\_SET\_BLOCK\_SZX}(value, blockSzx);
486 
487             \textcolor{comment}{//A Block2 Option is used in control usage in a request}
488             error = \hyperlink{coap__client__request_8c_ad47ce9f4d2077ce52ab1ade0490792a6}{coapClientSetUintOption}(requestMsg, 
      \hyperlink{coap__option_8h_ab833642841b9ddc4cab90acf5cffb0e7a5c471307a51b53ed7bf1c06a21a6dc64}{COAP\_OPT\_BLOCK2}, 0,
489                value);
490             \textcolor{comment}{//Any error to report?}
491             \textcolor{keywordflow}{if}(error)
492                \textcolor{keywordflow}{break};
493 
494             \textcolor{comment}{//Perform message exchange}
495             error = \hyperlink{coap__client__request_8c_aa2ae90ad0854f80b7e75e4d996a6bce9}{coapClientSendRequest}(request, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
496             \textcolor{comment}{//Any error to report?}
497             \textcolor{keywordflow}{if}(error)
498                \textcolor{keywordflow}{break};
499 
500             \textcolor{comment}{//Point to the response message}
501             responseMsg = \hyperlink{coap__client__request_8c_ab8831a171211717a75e7304cebec7821}{coapClientGetResponseMessage}(request);
502 
503             \textcolor{comment}{//Retrieve response code}
504             error = \hyperlink{coap__client__request_8c_af69d71981433a0044c044274b04e8d9d}{coapClientGetResponseCode}(responseMsg, &responseCode);
505             \textcolor{comment}{//Any error to report?}
506             \textcolor{keywordflow}{if}(error)
507                \textcolor{keywordflow}{break};
508 
509             \textcolor{comment}{//Check response code}
510             \textcolor{keywordflow}{if}(\hyperlink{coap__common_8h_affb375199c7e7b6b8bce03764eb0e1bf}{COAP\_GET\_CODE\_CLASS}(responseCode) != 
      \hyperlink{coap__common_8h_adfae531892e0bd3d2ed4254388416842ad401c059150c6148ec79d98403cc1f2a}{COAP\_CODE\_CLASS\_SUCCESS})
511             \{
512                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cad08a24e05f290a18fed0f90d007380e1}{ERROR\_INVALID\_STATUS};
513                \textcolor{keywordflow}{break};
514             \}
515          \}
516          \textcolor{keywordflow}{else}
517          \{
518             \textcolor{comment}{//The Block2 option is not present in the response}
519             \textcolor{keywordflow}{if}(blockPos == 0)
520                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca8b7223773301a4f3dd811f1d35e13ce4}{ERROR\_END\_OF\_STREAM};
521             \textcolor{keywordflow}{else}
522                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
523 
524             \textcolor{comment}{//Exit immediately}
525             \textcolor{keywordflow}{break};
526          \}
527       \}
528       \textcolor{keywordflow}{else}
529       \{
530          \textcolor{comment}{//Failed to read payload data}
531          \textcolor{keywordflow}{break};
532       \}
533    \}
534 
535    \textcolor{comment}{//Any data received?}
536    \textcolor{keywordflow}{if}(*received > 0)
537    \{
538       \textcolor{comment}{//Catch exception}
539       \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca8b7223773301a4f3dd811f1d35e13ce4}{ERROR\_END\_OF\_STREAM})
540          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
541    \}
542 
543    \textcolor{comment}{//Return status code}
544    \textcolor{keywordflow}{return} error;
545 \}
\end{DoxyCode}
\mbox{\Hypertarget{coap__client__block_8h_aa401f127c540df6fd24461fdfced4b77}\label{coap__client__block_8h_aa401f127c540df6fd24461fdfced4b77}} 
\index{coap\+\_\+client\+\_\+block.\+h@{coap\+\_\+client\+\_\+block.\+h}!coap\+Client\+Set\+Rx\+Block\+Size@{coap\+Client\+Set\+Rx\+Block\+Size}}
\index{coap\+Client\+Set\+Rx\+Block\+Size@{coap\+Client\+Set\+Rx\+Block\+Size}!coap\+\_\+client\+\_\+block.\+h@{coap\+\_\+client\+\_\+block.\+h}}
\subsubsection{\texorpdfstring{coap\+Client\+Set\+Rx\+Block\+Size()}{coapClientSetRxBlockSize()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} coap\+Client\+Set\+Rx\+Block\+Size (\begin{DoxyParamCaption}\item[{\hyperlink{coap__client_8h_a3dac6728ded461f458ffd870eca7afe7}{Coap\+Client\+Request} $\ast$}]{request,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{block\+Size }\end{DoxyParamCaption})}



Set preferred block for reception path. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em request} & Co\+AP request handle \\
\hline
\mbox{\tt in}  & {\em block\+Size} & Preferred block size, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 97 of file coap\+\_\+client\+\_\+block.\+c.


\begin{DoxyCode}
98 \{
99    \textcolor{comment}{//Make sure the CoAP request handle is valid}
100    \textcolor{keywordflow}{if}(request == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
101       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
102 
103    \textcolor{comment}{//Acquire exclusive access to the CoAP client context}
104    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&request->context->mutex);
105 
106    \textcolor{comment}{//Set RX block size}
107    \textcolor{keywordflow}{if}(blockSize == 16)
108       request->rxBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8a830c70b5e7a7d3816f1d8f64acc9722a}{COAP\_BLOCK\_SIZE\_16};
109    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(blockSize == 32)
110       request->rxBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8a5d5d3ef1e829133c441b714bab3cb204}{COAP\_BLOCK\_SIZE\_32};
111    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(blockSize == 64)
112       request->rxBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ace36ecacac80357174a4bc5e7758c79b}{COAP\_BLOCK\_SIZE\_64};
113    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(blockSize == 128)
114       request->rxBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ab024418bf9766ce7373b999ba1a4f30a}{COAP\_BLOCK\_SIZE\_128};
115    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(blockSize == 256)
116       request->rxBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ab4b3d2739379f93c3b720cf28b4a8430}{COAP\_BLOCK\_SIZE\_256};
117    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(blockSize == 512)
118       request->rxBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8a284cde1d86aa887ff1acdfbfba1b0ed3}{COAP\_BLOCK\_SIZE\_512};
119    \textcolor{keywordflow}{else}
120       request->rxBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ab8b9efb919c4d721145b4e7df685c4c0}{COAP\_BLOCK\_SIZE\_1024};
121 
122    \textcolor{comment}{//Ensure the block size is acceptable}
123    \textcolor{keywordflow}{if}(request->rxBlockSzx > \hyperlink{coap__client__block_8c_a0f3723fd9e1a0944ec21ec50ae85206f}{coapClientGetMaxBlockSize}())
124       request->rxBlockSzx = \hyperlink{coap__client__block_8c_a0f3723fd9e1a0944ec21ec50ae85206f}{coapClientGetMaxBlockSize}();
125 
126    \textcolor{comment}{//Release exclusive access to the CoAP client context}
127    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&request->context->mutex);
128 
129    \textcolor{comment}{//Successful processing}
130    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
131 \}
\end{DoxyCode}
\mbox{\Hypertarget{coap__client__block_8h_ac2ab62e6cddc494a3a66aa7d7bf005d5}\label{coap__client__block_8h_ac2ab62e6cddc494a3a66aa7d7bf005d5}} 
\index{coap\+\_\+client\+\_\+block.\+h@{coap\+\_\+client\+\_\+block.\+h}!coap\+Client\+Set\+Tx\+Block\+Size@{coap\+Client\+Set\+Tx\+Block\+Size}}
\index{coap\+Client\+Set\+Tx\+Block\+Size@{coap\+Client\+Set\+Tx\+Block\+Size}!coap\+\_\+client\+\_\+block.\+h@{coap\+\_\+client\+\_\+block.\+h}}
\subsubsection{\texorpdfstring{coap\+Client\+Set\+Tx\+Block\+Size()}{coapClientSetTxBlockSize()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} coap\+Client\+Set\+Tx\+Block\+Size (\begin{DoxyParamCaption}\item[{\hyperlink{coap__client_8h_a3dac6728ded461f458ffd870eca7afe7}{Coap\+Client\+Request} $\ast$}]{request,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{block\+Size }\end{DoxyParamCaption})}



Set preferred block for transmission path. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em request} & Co\+AP request handle \\
\hline
\mbox{\tt in}  & {\em block\+Size} & Preferred block size, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 53 of file coap\+\_\+client\+\_\+block.\+c.


\begin{DoxyCode}
54 \{
55    \textcolor{comment}{//Make sure the CoAP request handle is valid}
56    \textcolor{keywordflow}{if}(request == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
57       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
58 
59    \textcolor{comment}{//Acquire exclusive access to the CoAP client context}
60    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&request->context->mutex);
61 
62    \textcolor{comment}{//Set TX block size}
63    \textcolor{keywordflow}{if}(blockSize == 16)
64       request->txBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8a830c70b5e7a7d3816f1d8f64acc9722a}{COAP\_BLOCK\_SIZE\_16};
65    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(blockSize == 32)
66       request->txBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8a5d5d3ef1e829133c441b714bab3cb204}{COAP\_BLOCK\_SIZE\_32};
67    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(blockSize == 64)
68       request->txBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ace36ecacac80357174a4bc5e7758c79b}{COAP\_BLOCK\_SIZE\_64};
69    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(blockSize == 128)
70       request->txBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ab024418bf9766ce7373b999ba1a4f30a}{COAP\_BLOCK\_SIZE\_128};
71    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(blockSize == 256)
72       request->txBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ab4b3d2739379f93c3b720cf28b4a8430}{COAP\_BLOCK\_SIZE\_256};
73    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(blockSize == 512)
74       request->txBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8a284cde1d86aa887ff1acdfbfba1b0ed3}{COAP\_BLOCK\_SIZE\_512};
75    \textcolor{keywordflow}{else}
76       request->txBlockSzx = \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ab8b9efb919c4d721145b4e7df685c4c0}{COAP\_BLOCK\_SIZE\_1024};
77 
78    \textcolor{comment}{//Ensure the block size is acceptable}
79    \textcolor{keywordflow}{if}(request->txBlockSzx > \hyperlink{coap__client__block_8c_a0f3723fd9e1a0944ec21ec50ae85206f}{coapClientGetMaxBlockSize}())
80       request->txBlockSzx = \hyperlink{coap__client__block_8c_a0f3723fd9e1a0944ec21ec50ae85206f}{coapClientGetMaxBlockSize}();
81 
82    \textcolor{comment}{//Release exclusive access to the CoAP client context}
83    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&request->context->mutex);
84 
85    \textcolor{comment}{//Successful processing}
86    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
87 \}
\end{DoxyCode}
\mbox{\Hypertarget{coap__client__block_8h_a621577ba04c7e3766e39b88b729e0da6}\label{coap__client__block_8h_a621577ba04c7e3766e39b88b729e0da6}} 
\index{coap\+\_\+client\+\_\+block.\+h@{coap\+\_\+client\+\_\+block.\+h}!coap\+Client\+Write\+Body@{coap\+Client\+Write\+Body}}
\index{coap\+Client\+Write\+Body@{coap\+Client\+Write\+Body}!coap\+\_\+client\+\_\+block.\+h@{coap\+\_\+client\+\_\+block.\+h}}
\subsubsection{\texorpdfstring{coap\+Client\+Write\+Body()}{coapClientWriteBody()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} coap\+Client\+Write\+Body (\begin{DoxyParamCaption}\item[{\hyperlink{coap__client_8h_a3dac6728ded461f458ffd870eca7afe7}{Coap\+Client\+Request} $\ast$}]{request,  }\item[{const void $\ast$}]{data,  }\item[{size\+\_\+t}]{length,  }\item[{size\+\_\+t $\ast$}]{written,  }\item[{\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t}}]{last }\end{DoxyParamCaption})}



Write resource body using block-\/wise mode. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em request} & Co\+AP request handle \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to a buffer containing the data to be transmitted \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes to be transmitted \\
\hline
\mbox{\tt out}  & {\em written} & Actual number of bytes written (optional parameter) \\
\hline
\mbox{\tt in}  & {\em last} & Flag indicating whether this message fragment is the last \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 144 of file coap\+\_\+client\+\_\+block.\+c.


\begin{DoxyCode}
146 \{
147    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
148    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
149    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
150    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} blockPos;
151    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} blockSzx;
152    \textcolor{keywordtype}{size\_t} \hyperlink{ipv6_8h_ae4d38aba40b6dddf544612da0726cd7e}{payloadLen};
153    \textcolor{keyword}{const} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *payload;
154    \hyperlink{structCoapMessage}{CoapMessage} *requestMsg;
155    \hyperlink{structCoapMessage}{CoapMessage} *responseMsg;
156    \hyperlink{coap__common_8h_af91e1fbf0a9ca1f9175e6049c9f2680e}{CoapCode} responseCode;
157 
158    \textcolor{comment}{//Initialize status code}
159    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
160 
161    \textcolor{comment}{//Total number of bytes that have been written}
162    \textcolor{keywordflow}{if}(written != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
163       *written = 0;
164 
165    \textcolor{comment}{//Block-wise transfers are realized as combinations of exchanges, each}
166    \textcolor{comment}{//of which is performed according to the CoAP base protocol}
167    \textcolor{keywordflow}{while}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} > 0 || \hyperlink{ipv4__frag_8h_a7179af054cf318941e1a12e964965935}{last})
168    \{
169       \textcolor{comment}{//Point to the request message}
170       requestMsg = \hyperlink{coap__client__request_8c_a3a3a39a5c6725120f715ac031f412277}{coapClientGetRequestMessage}(request);
171 
172       \textcolor{comment}{//Block1 option is used in descriptive usage in a request}
173       error = \hyperlink{coap__option_8c_a4098de0a9fbec04954546ce1978572d9}{coapGetUintOption}(requestMsg, \hyperlink{coap__option_8h_ab833642841b9ddc4cab90acf5cffb0e7a5492ac3bfefc86f9801606306e6edb18}{COAP\_OPT\_BLOCK1}, 0, &value);
174 
175       \textcolor{comment}{//Block1 option found?}
176       \textcolor{keywordflow}{if}(!error)
177       \{
178          \textcolor{comment}{//Retrieve current block parameters}
179          blockPos = \hyperlink{coap__option_8h_af476c3ecbec55a048b64100ae4e634ad}{COAP\_GET\_BLOCK\_POS}(value);
180          blockSzx = \hyperlink{coap__option_8h_a66414e735018b7e4c61a954124707b0b}{COAP\_GET\_BLOCK\_SZX}(value);
181       \}
182       \textcolor{keywordflow}{else}
183       \{
184          \textcolor{comment}{//Initialize block parameters}
185          blockPos = 0;
186          blockSzx = request->txBlockSzx;
187       \}
188 
189       \textcolor{comment}{//Retrieve message payload length}
190       error = \hyperlink{coap__client__request_8c_a8ff6bac5add283786dc14e6dd84a89ae}{coapClientGetPayload}(requestMsg, &payload, &payloadLen);
191       \textcolor{comment}{//Any error to report?}
192       \textcolor{keywordflow}{if}(error)
193          \textcolor{keywordflow}{break};
194 
195       \textcolor{comment}{//Write as much data as possible}
196       \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} > 0 && payloadLen < \hyperlink{coap__option_8h_add186aa746976d5f8c99ef54044b2263}{COAP\_GET\_BLOCK\_SIZE}(blockSzx))
197       \{
198          \textcolor{comment}{//Limit the number of data to copy at a time}
199          n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, \hyperlink{coap__option_8h_add186aa746976d5f8c99ef54044b2263}{COAP\_GET\_BLOCK\_SIZE}(blockSzx) - payloadLen);
200 
201          \textcolor{comment}{//Write payload data}
202          error = \hyperlink{coap__client__request_8c_a18dd1e572768e3f0a22ea04501a721e9}{coapClientWritePayload}(requestMsg, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, n);
203          \textcolor{comment}{//Any error to report?}
204          \textcolor{keywordflow}{if}(error)
205             \textcolor{keywordflow}{break};
206 
207          \textcolor{comment}{//Advance data pointer}
208          \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} + n;
209          \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
210 
211          \textcolor{comment}{//Total number of bytes that have been written}
212          \textcolor{keywordflow}{if}(written != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
213             *written += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
214       \}
215       \textcolor{keywordflow}{else}
216       \{
217          \textcolor{comment}{//Block-wise transfer?}
218          \textcolor{keywordflow}{if}(blockPos > 0 || \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} > 0 || !\hyperlink{ipv4__frag_8h_a7179af054cf318941e1a12e964965935}{last})
219          \{
220             \textcolor{comment}{//The NUM field in the option value describes what block number}
221             \textcolor{comment}{//is contained in the payload of this message}
222             \hyperlink{coap__option_8h_aed9ed8570bb73135e19a61861b2f562f}{COAP\_SET\_BLOCK\_NUM}(value, blockPos >> (blockSzx + 4));
223 
224             \textcolor{comment}{//The M bit indicates whether further blocks need to be transferred}
225             \textcolor{comment}{//to complete the transfer of the body}
226             \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} == 0 && \hyperlink{ipv4__frag_8h_a7179af054cf318941e1a12e964965935}{last})
227                \hyperlink{coap__option_8h_a9aa6c7a639f193b8824954b1c0a9074c}{COAP\_SET\_BLOCK\_M}(value, 0);
228             \textcolor{keywordflow}{else}
229                \hyperlink{coap__option_8h_a9aa6c7a639f193b8824954b1c0a9074c}{COAP\_SET\_BLOCK\_M}(value, 1);
230 
231             \textcolor{comment}{//Set block size}
232             \hyperlink{coap__option_8h_adc27c995b190e918d48a1c92dae148e9}{COAP\_SET\_BLOCK\_SZX}(value, blockSzx);
233 
234             \textcolor{comment}{//Block1 option is used in descriptive usage in a request}
235             error = \hyperlink{coap__client__request_8c_ad47ce9f4d2077ce52ab1ade0490792a6}{coapClientSetUintOption}(requestMsg, 
      \hyperlink{coap__option_8h_ab833642841b9ddc4cab90acf5cffb0e7a5492ac3bfefc86f9801606306e6edb18}{COAP\_OPT\_BLOCK1}, 0, value);
236             \textcolor{comment}{//Any error to report?}
237             \textcolor{keywordflow}{if}(error)
238                \textcolor{keywordflow}{break};
239          \}
240 
241          \textcolor{comment}{//Last block?}
242          \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} == 0 && \hyperlink{ipv4__frag_8h_a7179af054cf318941e1a12e964965935}{last})
243          \{
244             \textcolor{comment}{//Any preferred block size defined?}
245             \textcolor{keywordflow}{if}(request->rxBlockSzx < \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ad9b1ead02f5dd9599b4080b74c6adb43}{COAP\_BLOCK\_SIZE\_RESERVED})
246             \{
247                \textcolor{comment}{//Set preferred block size}
248                \hyperlink{coap__option_8h_aed9ed8570bb73135e19a61861b2f562f}{COAP\_SET\_BLOCK\_NUM}(value, 0);
249                \hyperlink{coap__option_8h_a9aa6c7a639f193b8824954b1c0a9074c}{COAP\_SET\_BLOCK\_M}(value, 0);
250                \hyperlink{coap__option_8h_adc27c995b190e918d48a1c92dae148e9}{COAP\_SET\_BLOCK\_SZX}(value, request->rxBlockSzx);
251 
252                \textcolor{comment}{//Perform early negotiation}
253                error = \hyperlink{coap__client__request_8c_ad47ce9f4d2077ce52ab1ade0490792a6}{coapClientSetUintOption}(requestMsg, 
      \hyperlink{coap__option_8h_ab833642841b9ddc4cab90acf5cffb0e7a5c471307a51b53ed7bf1c06a21a6dc64}{COAP\_OPT\_BLOCK2}, 0, value);
254                \textcolor{comment}{//Any error to report?}
255                \textcolor{keywordflow}{if}(error)
256                   \textcolor{keywordflow}{break};
257             \}
258          \}
259 
260          \textcolor{comment}{//Send request}
261          error = \hyperlink{coap__client__request_8c_aa2ae90ad0854f80b7e75e4d996a6bce9}{coapClientSendRequest}(request, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
262          \textcolor{comment}{//Any error to report?}
263          \textcolor{keywordflow}{if}(error)
264             \textcolor{keywordflow}{break};
265 
266          \textcolor{comment}{//Point to the response message}
267          responseMsg = \hyperlink{coap__client__request_8c_ab8831a171211717a75e7304cebec7821}{coapClientGetResponseMessage}(request);
268 
269          \textcolor{comment}{//Retrieve response code}
270          error = \hyperlink{coap__client__request_8c_af69d71981433a0044c044274b04e8d9d}{coapClientGetResponseCode}(responseMsg, &responseCode);
271          \textcolor{comment}{//Any error to report?}
272          \textcolor{keywordflow}{if}(error)
273             \textcolor{keywordflow}{break};
274 
275          \textcolor{comment}{//Check response code}
276          \textcolor{keywordflow}{if}(\hyperlink{coap__common_8h_affb375199c7e7b6b8bce03764eb0e1bf}{COAP\_GET\_CODE\_CLASS}(responseCode) != 
      \hyperlink{coap__common_8h_adfae531892e0bd3d2ed4254388416842ad401c059150c6148ec79d98403cc1f2a}{COAP\_CODE\_CLASS\_SUCCESS})
277          \{
278             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cad08a24e05f290a18fed0f90d007380e1}{ERROR\_INVALID\_STATUS};
279             \textcolor{keywordflow}{break};
280          \}
281 
282          \textcolor{comment}{//Block-wise transfer?}
283          \textcolor{keywordflow}{if}(blockPos > 0 || \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} > 0 || !\hyperlink{ipv4__frag_8h_a7179af054cf318941e1a12e964965935}{last})
284          \{
285             \textcolor{comment}{//A Block1 option is used in control usage in a response}
286             error = \hyperlink{coap__client__request_8c_a9aec664a9fa5adc7d61beb0c3970ac8b}{coapClientGetUintOption}(responseMsg, 
      \hyperlink{coap__option_8h_ab833642841b9ddc4cab90acf5cffb0e7a5492ac3bfefc86f9801606306e6edb18}{COAP\_OPT\_BLOCK1}, 0, &value);
287             \textcolor{comment}{//Any error to report?}
288             \textcolor{keywordflow}{if}(error)
289                \textcolor{keywordflow}{break};
290 
291             \textcolor{comment}{//The value 7 for SZX is reserved}
292             \textcolor{keywordflow}{if}(\hyperlink{coap__option_8h_a66414e735018b7e4c61a954124707b0b}{COAP\_GET\_BLOCK\_SZX}(value) >= 
      \hyperlink{coap__option_8h_ad1e9eed649f4a72e0e2219dae49cbae8ad9b1ead02f5dd9599b4080b74c6adb43}{COAP\_BLOCK\_SIZE\_RESERVED})
293             \{
294                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
295                \textcolor{keywordflow}{break};
296             \}
297 
298             \textcolor{comment}{//The NUM field of the Block1 option indicates what block number is}
299             \textcolor{comment}{//being acknowledged}
300             \textcolor{keywordflow}{if}(\hyperlink{coap__option_8h_af476c3ecbec55a048b64100ae4e634ad}{COAP\_GET\_BLOCK\_POS}(value) != blockPos)
301             \{
302                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
303                \textcolor{keywordflow}{break};
304             \}
305 
306             \textcolor{comment}{//A server receiving a block-wise PUT or POST may want to indicate a}
307             \textcolor{comment}{//smaller block size preference (late negotiation)}
308             \textcolor{keywordflow}{if}(blockSzx > \hyperlink{coap__option_8h_a66414e735018b7e4c61a954124707b0b}{COAP\_GET\_BLOCK\_SZX}(value))
309                blockSzx = \hyperlink{coap__option_8h_a66414e735018b7e4c61a954124707b0b}{COAP\_GET\_BLOCK\_SZX}(value);
310 
311             \textcolor{comment}{//Next block}
312             blockPos += \hyperlink{coap__option_8h_add186aa746976d5f8c99ef54044b2263}{COAP\_GET\_BLOCK\_SIZE}(blockSzx);
313 
314             \textcolor{comment}{//The NUM field in the option value describes what block number}
315             \textcolor{comment}{//is contained in the payload of this message}
316             \hyperlink{coap__option_8h_aed9ed8570bb73135e19a61861b2f562f}{COAP\_SET\_BLOCK\_NUM}(value, blockPos >> (blockSzx + 4));
317 
318             \textcolor{comment}{//Set block size}
319             \hyperlink{coap__option_8h_adc27c995b190e918d48a1c92dae148e9}{COAP\_SET\_BLOCK\_SZX}(value, blockSzx);
320 
321             \textcolor{comment}{//Block1 option is used in descriptive usage in a request}
322             error = \hyperlink{coap__client__request_8c_ad47ce9f4d2077ce52ab1ade0490792a6}{coapClientSetUintOption}(requestMsg, 
      \hyperlink{coap__option_8h_ab833642841b9ddc4cab90acf5cffb0e7a5492ac3bfefc86f9801606306e6edb18}{COAP\_OPT\_BLOCK1}, 0, value);
323             \textcolor{comment}{//Any error to report?}
324             \textcolor{keywordflow}{if}(error)
325                \textcolor{keywordflow}{break};
326          \}
327 
328          \textcolor{comment}{//Trim the existing payload}
329          error = \hyperlink{coap__client__request_8c_ad46031e1eca67323fb6e4f1de29ed6a7}{coapClientSetPayload}(requestMsg, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 0);
330          \textcolor{comment}{//Any error to report?}
331          \textcolor{keywordflow}{if}(error)
332             \textcolor{keywordflow}{break};
333 
334          \textcolor{comment}{//Last block?}
335          \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} == 0 && \hyperlink{ipv4__frag_8h_a7179af054cf318941e1a12e964965935}{last})
336          \{
337             \textcolor{comment}{//Delete Block1 option}
338             error = \hyperlink{coap__client__request_8c_aa9aa610dcd9c6c70bd1ae2b361e6dce5}{coapClientDeleteOption}(requestMsg, 
      \hyperlink{coap__option_8h_ab833642841b9ddc4cab90acf5cffb0e7a5492ac3bfefc86f9801606306e6edb18}{COAP\_OPT\_BLOCK1}, 0);
339             \textcolor{comment}{//We are done}
340             \textcolor{keywordflow}{break};
341          \}
342       \}
343    \}
344 
345    \textcolor{comment}{//Return status code}
346    \textcolor{keywordflow}{return} error;
347 \}
\end{DoxyCode}
