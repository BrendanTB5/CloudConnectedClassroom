\hypertarget{tls__record__encryption_8c}{}\section{cyclone\+\_\+ssl/tls\+\_\+record\+\_\+encryption.c File Reference}
\label{tls__record__encryption_8c}\index{cyclone\+\_\+ssl/tls\+\_\+record\+\_\+encryption.\+c@{cyclone\+\_\+ssl/tls\+\_\+record\+\_\+encryption.\+c}}


T\+LS record encryption.  


{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include \char`\"{}tls.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+record.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+record\+\_\+encryption.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ssl\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}cipher\+\_\+mode/cbc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}aead/ccm.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}aead/gcm.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}aead/chacha20\+\_\+poly1305.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{tls__record__encryption_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{tls__config_8h_afee42a623033dac888291d1993985206}{T\+L\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record__encryption_8c_a570ea69586ebaeac3279b864b4630a02}{tls\+Encrypt\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$encryption\+Engine, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Encrypt an outgoing T\+LS record. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record__encryption_8c_a1384d8730aec553ed80975b72c5fb8c6}{tls\+Encrypt\+Aead\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$encryption\+Engine, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Record encryption (A\+E\+AD cipher) \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record__encryption_8c_ada4c8d478ae44afd175ccfc7426e0930}{tls\+Encrypt\+Cbc\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$encryption\+Engine, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Record encryption (C\+BC block cipher) \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record__encryption_8c_a90ddf9ce156fdf3a42f30a5682027cfb}{tls\+Encrypt\+Stream\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$encryption\+Engine, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Record encryption (stream cipher) \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record__encryption_8c_ae934755b58738b2cb4bc7bbf5d62ddd9}{tls\+Append\+Message\+Auth\+Code} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$encryption\+Engine, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Append message authentication code. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record__encryption_8c_aa9b63a57f10ba6ac0d1abce783ff1457}{tls\+Compute\+Mac} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$encryption\+Engine, void $\ast$record, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t data\+Len, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$mac)
\begin{DoxyCompactList}\small\item\em Compute message authentication code. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
T\+LS record encryption. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+S\+SL Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{tls__record__encryption_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{tls__record__encryption_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{tls__config_8h_afee42a623033dac888291d1993985206}{T\+L\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file tls\+\_\+record\+\_\+encryption.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{tls__record__encryption_8c_ae934755b58738b2cb4bc7bbf5d62ddd9}\label{tls__record__encryption_8c_ae934755b58738b2cb4bc7bbf5d62ddd9}} 
\index{tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}!tls\+Append\+Message\+Auth\+Code@{tls\+Append\+Message\+Auth\+Code}}
\index{tls\+Append\+Message\+Auth\+Code@{tls\+Append\+Message\+Auth\+Code}!tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}}
\subsubsection{\texorpdfstring{tls\+Append\+Message\+Auth\+Code()}{tlsAppendMessageAuthCode()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Append\+Message\+Auth\+Code (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{encryption\+Engine,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Append message authentication code. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em encryption\+Engine} & Pointer to the encryption engine \\
\hline
\mbox{\tt in,out}  & {\em record} & T\+LS record to be authenticated \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 407 of file tls\+\_\+record\+\_\+encryption.\+c.


\begin{DoxyCode}
409 \{
410    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
411    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
412    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
413 
414    \textcolor{comment}{//Get the length of the TLS record}
415    length = \hyperlink{tls__record_8c_ab259ff6b1964745a6f4646139c69bfec}{tlsGetRecordLength}(context, record);
416    \textcolor{comment}{//Point to the payload}
417    data = \hyperlink{tls__record_8c_a937201285f16b034ffc504f6151b9f37}{tlsGetRecordData}(context, record);
418 
419 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= SSL\_VERSION\_3\_0)}
420    \textcolor{comment}{//SSL 3.0 currently selected?}
421    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} == \hyperlink{tls_8h_a8d19a9661e2ca28062ba4a00799e8bdb}{SSL\_VERSION\_3\_0})
422    \{
423       \textcolor{comment}{//SSL 3.0 uses an older obsolete version of the HMAC construction}
424       error = \hyperlink{ssl__misc_8h_aedba18076ae541c67eff5f69f21a14a8}{sslComputeMac}(encryptionEngine, record, data, length,
425          data + length);
426    \}
427    \textcolor{keywordflow}{else}
428 \textcolor{preprocessor}{#endif}
429 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
430    \textcolor{comment}{//TLS 1.0, TLS 1.1 or TLS 1.2 currently selected?}
431    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} >= \hyperlink{tls_8h_adcc8f4321c8f3b847fbea16ca0ff337e}{TLS\_VERSION\_1\_0})
432    \{
433       \textcolor{comment}{//TLS uses a HMAC construction}
434       error = \hyperlink{tls__record__encryption_8c_aa9b63a57f10ba6ac0d1abce783ff1457}{tlsComputeMac}(context, encryptionEngine, record, data,
435          length, data + length);
436    \}
437    \textcolor{keywordflow}{else}
438 \textcolor{preprocessor}{#endif}
439    \textcolor{comment}{//Invalid TLS version?}
440    \{
441       \textcolor{comment}{//Report an error}
442       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
443    \}
444 
445    \textcolor{comment}{//Any error to report?}
446    \textcolor{keywordflow}{if}(error)
447       \textcolor{keywordflow}{return} error;
448 
449    \textcolor{comment}{//Debug message}
450    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Write sequence number:\(\backslash\)r\(\backslash\)n"});
451    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, &encryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ab9706be268c77258f4c7238721793c}{seqNum}, \textcolor{keyword}{sizeof}(
      \hyperlink{tls_8h_aadbcbb634b990da0c6d0d07fe08e9f89}{TlsSequenceNumber}));
452    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Computed MAC:\(\backslash\)r\(\backslash\)n"});
453    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, data + length, encryptionEngine->
      \hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo}->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize});
454 
455    \textcolor{comment}{//Adjust the length of the message}
456    length += encryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo}->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize};
457    \textcolor{comment}{//Fix length field}
458    \hyperlink{tls__record_8c_a956295a326cb475d6e9ad935a91690af}{tlsSetRecordLength}(context, record, length);
459 
460    \textcolor{comment}{//Increment sequence number}
461    \hyperlink{tls__record_8c_a7033a23b01aeb6f99b9876392eeb4ca4}{tlsIncSequenceNumber}(&encryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ab9706be268c77258f4c7238721793c}{seqNum});
462 
463    \textcolor{comment}{//Successful processing}
464    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
465 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record__encryption_8c_aa9b63a57f10ba6ac0d1abce783ff1457}\label{tls__record__encryption_8c_aa9b63a57f10ba6ac0d1abce783ff1457}} 
\index{tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}!tls\+Compute\+Mac@{tls\+Compute\+Mac}}
\index{tls\+Compute\+Mac@{tls\+Compute\+Mac}!tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}}
\subsubsection{\texorpdfstring{tls\+Compute\+Mac()}{tlsComputeMac()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Compute\+Mac (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{encryption\+Engine,  }\item[{void $\ast$}]{record,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{data\+Len,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{mac }\end{DoxyParamCaption})}



Compute message authentication code. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em encryption\+Engine} & Pointer to the encryption/decryption engine \\
\hline
\mbox{\tt in}  & {\em record} & Pointer to the T\+LS record \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to the record data \\
\hline
\mbox{\tt in}  & {\em data\+Len} & Length of the data \\
\hline
\mbox{\tt out}  & {\em mac} & The computed M\+AC value \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 479 of file tls\+\_\+record\+\_\+encryption.\+c.


\begin{DoxyCode}
481 \{
482    \hyperlink{structHmacContext}{HmacContext} *hmacContext;
483 
484    \textcolor{comment}{//Point to the HMAC context}
485    hmacContext = encryptionEngine->\hyperlink{structTlsEncryptionEngine_a6e659b6a95474feec4ee46f40c7b92e4}{hmacContext};
486 
487    \textcolor{comment}{//Initialize HMAC calculation}
488    \hyperlink{hmac_8c_ac4ecc520cae02c1b9bbb3651758a703e}{hmacInit}(hmacContext, encryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo},
489       encryptionEngine->\hyperlink{structTlsEncryptionEngine_addc5682b60f0e934f1b838909b8aea7c}{macKey}, encryptionEngine->\hyperlink{structTlsEncryptionEngine_a26e44e1dbfb86e7a0f118dc4d859d7ab}{macKeyLen});
490 
491 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
492    \textcolor{comment}{//DTLS protocol?}
493    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
494    \{
495       \textcolor{keyword}{const} \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *dtlsRecord;
496 
497       \textcolor{comment}{//Point to the DTLS record}
498       dtlsRecord = (\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) record;
499 
500       \textcolor{comment}{//Compute the MAC over the 64-bit value formed by concatenating the}
501       \textcolor{comment}{//epoch and the sequence number in the order they appear on the wire}
502       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, (\textcolor{keywordtype}{void} *) &dtlsRecord->epoch, 2);
503       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, &dtlsRecord->seqNum, 6);
504 
505       \textcolor{comment}{//Compute MAC over the record contents}
506       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, &dtlsRecord->type, 3);
507       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, (\textcolor{keywordtype}{void} *) &dtlsRecord->length, 2);
508       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, dataLen);
509    \}
510    \textcolor{keywordflow}{else}
511 \textcolor{preprocessor}{#endif}
512    \textcolor{comment}{//TLS protocol?}
513    \{
514       \textcolor{keyword}{const} \hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *tlsRecord;
515 
516       \textcolor{comment}{//Point to the TLS record}
517       tlsRecord = (\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *) record;
518 
519       \textcolor{comment}{//Compute MAC over the implicit sequence number}
520       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, &encryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ab9706be268c77258f4c7238721793c}{seqNum},
521          \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_aadbcbb634b990da0c6d0d07fe08e9f89}{TlsSequenceNumber}));
522 
523       \textcolor{comment}{//Compute MAC over the record contents}
524       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, tlsRecord, \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
525       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, dataLen);
526    \}
527 
528    \textcolor{comment}{//Finalize HMAC computation}
529    \hyperlink{hmac_8c_a387906ffc55755df380361c43ce0bd6a}{hmacFinal}(hmacContext, mac);
530 
531    \textcolor{comment}{//Successful processing}
532    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
533 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record__encryption_8c_a1384d8730aec553ed80975b72c5fb8c6}\label{tls__record__encryption_8c_a1384d8730aec553ed80975b72c5fb8c6}} 
\index{tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}!tls\+Encrypt\+Aead\+Record@{tls\+Encrypt\+Aead\+Record}}
\index{tls\+Encrypt\+Aead\+Record@{tls\+Encrypt\+Aead\+Record}!tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}}
\subsubsection{\texorpdfstring{tls\+Encrypt\+Aead\+Record()}{tlsEncryptAeadRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Encrypt\+Aead\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{encryption\+Engine,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Record encryption (A\+E\+AD cipher) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em encryption\+Engine} & Pointer to the encryption engine \\
\hline
\mbox{\tt in,out}  & {\em record} & T\+LS record to be encrypted \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 136 of file tls\+\_\+record\+\_\+encryption.\+c.


\begin{DoxyCode}
138 \{
139 \textcolor{preprocessor}{#if (TLS\_CCM\_CIPHER\_SUPPORT == ENABLED || TLS\_CCM\_8\_CIPHER\_SUPPORT == ENABLED || \(\backslash\)}
140 \textcolor{preprocessor}{   TLS\_GCM\_CIPHER\_SUPPORT == ENABLED || TLS\_CHACHA20\_POLY1305\_SUPPORT == ENABLED)}
141    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
142    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
143    \textcolor{keywordtype}{size\_t} aadLen;
144    \textcolor{keywordtype}{size\_t} nonceLen;
145    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *tag;
146    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
147    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} aad[13];
148    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} nonce[12];
149 
150    \textcolor{comment}{//Get the length of the TLS record}
151    length = \hyperlink{tls__record_8c_ab259ff6b1964745a6f4646139c69bfec}{tlsGetRecordLength}(context, record);
152    \textcolor{comment}{//Point to the payload}
153    data = \hyperlink{tls__record_8c_a937201285f16b034ffc504f6151b9f37}{tlsGetRecordData}(context, record);
154 
155    \textcolor{comment}{//Debug message}
156    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Record to be encrypted (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
157    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
158 
159    \textcolor{comment}{//TLS 1.3 currently selected?}
160    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} == \hyperlink{tls_8h_ab44dc642afbfbd72926ab1f94634cd4d}{TLS\_VERSION\_1\_3})
161    \{
162       \textcolor{comment}{//The type field indicates the higher-level protocol used to process}
163       \textcolor{comment}{//the enclosed fragment}
164       data[length++] = \hyperlink{tls__record_8c_a6541692151f64ebb3797032c4390d371}{tlsGetRecordType}(context, record);
165 
166       \textcolor{comment}{//In TLS 1.3, the outer opaque\_type field of a TLS record is always}
167       \textcolor{comment}{//set to the value 23 (application data)}
168       \hyperlink{tls__record_8c_a2ca833f61cd4672cd6dc3cf323e33a06}{tlsSetRecordType}(context, record, 
      \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896caa8233b89b5c8f35ce7fcd1f644cbc0fc}{TLS\_TYPE\_APPLICATION\_DATA});
169 
170       \textcolor{comment}{//Fix the length field of the TLS record}
171       \hyperlink{tls__record_8c_a956295a326cb475d6e9ad935a91690af}{tlsSetRecordLength}(context, record, length +
172          encryptionEngine->\hyperlink{structTlsEncryptionEngine_aef28b3fa8d6ac0147cdc47db9a642fc7}{authTagLen});
173    \}
174 
175    \textcolor{comment}{//Additional data to be authenticated}
176    \hyperlink{tls__record_8c_ada6e5a7f5801af080907024ae7a9eeb4}{tlsFormatAad}(context, encryptionEngine, record, aad, &aadLen);
177 
178    \textcolor{comment}{//Check the length of the nonce explicit part}
179    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen} != 0)
180    \{
181       \textcolor{comment}{//Make room for the explicit nonce at the beginning of the record}
182       memmove(data + encryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen}, data, length);
183 
184       \textcolor{comment}{//The explicit part of the nonce is chosen by the sender and is}
185       \textcolor{comment}{//carried in each TLS record}
186       error = context->prngAlgo->read(context->prngContext, data,
187          encryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen});
188       \textcolor{comment}{//Any error to report?}
189       \textcolor{keywordflow}{if}(error)
190          \textcolor{keywordflow}{return} error;
191    \}
192 
193    \textcolor{comment}{//Generate the nonce}
194    \hyperlink{tls__record_8c_aa0aafa9e75cfd27fde215575a44899d8}{tlsFormatNonce}(context, encryptionEngine, record, data, nonce,
195       &nonceLen);
196 
197    \textcolor{comment}{//Point to the plaintext}
198    data += encryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen};
199    \textcolor{comment}{//Point to the buffer where to store the authentication tag}
200    tag = data + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
201 
202 \textcolor{preprocessor}{#if (TLS\_CCM\_CIPHER\_SUPPORT == ENABLED || TLS\_CCM\_8\_CIPHER\_SUPPORT == ENABLED)}
203    \textcolor{comment}{//CCM AEAD cipher?}
204    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5a42db5b52a68da8ba71735ac7248f7401}{CIPHER\_MODE\_CCM})
205    \{
206       \textcolor{comment}{//Authenticated encryption using CCM}
207       error = \hyperlink{ccm_8c_a46d26dc0770850a161c9f9c605f7f51a}{ccmEncrypt}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ba455619112e97e419c3c51de90b0ca}{cipherAlgo},
208          encryptionEngine->\hyperlink{structTlsEncryptionEngine_a6fb752231a2f6d7d6789c35481af0559}{cipherContext}, nonce, nonceLen, aad, aadLen,
209          data, data, length, tag, encryptionEngine->\hyperlink{structTlsEncryptionEngine_aef28b3fa8d6ac0147cdc47db9a642fc7}{authTagLen});
210    \}
211    \textcolor{keywordflow}{else}
212 \textcolor{preprocessor}{#endif}
213 \textcolor{preprocessor}{#if (TLS\_GCM\_CIPHER\_SUPPORT == ENABLED)}
214    \textcolor{comment}{//GCM AEAD cipher?}
215    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af09ab2345f2ff996cf47696f7540fe7a}{CIPHER\_MODE\_GCM})
216    \{
217       \textcolor{comment}{//Authenticated encryption using GCM}
218       error = \hyperlink{gcm_8c_a2f5111c280fe4411127041f1c43d4346}{gcmEncrypt}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_aef9d3f24e20174d9493d919ec8964b7c}{gcmContext}, nonce, nonceLen,
219          aad, aadLen, data, data, length, tag, encryptionEngine->\hyperlink{structTlsEncryptionEngine_aef28b3fa8d6ac0147cdc47db9a642fc7}{authTagLen});
220    \}
221    \textcolor{keywordflow}{else}
222 \textcolor{preprocessor}{#endif}
223 \textcolor{preprocessor}{#if (TLS\_CHACHA20\_POLY1305\_SUPPORT == ENABLED)}
224    \textcolor{comment}{//ChaCha20Poly1305 AEAD cipher?}
225    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5a0a78e04fbee5d777bfd542b085003855}{CIPHER\_MODE\_CHACHA20\_POLY1305})
226    \{
227       \textcolor{comment}{//Authenticated encryption using ChaCha20Poly1305}
228       error = \hyperlink{chacha20__poly1305_8c_a8e0dc01ce6f977cc74e07587da869829}{chacha20Poly1305Encrypt}(encryptionEngine->
      \hyperlink{structTlsEncryptionEngine_ac52797db6bbb0e89321c969292dfddd6}{encKey},
229          encryptionEngine->\hyperlink{structTlsEncryptionEngine_ad657d271cd7780efcb7d2005737256dd}{encKeyLen}, nonce, nonceLen, aad, aadLen,
230          data, data, length, tag, encryptionEngine->\hyperlink{structTlsEncryptionEngine_aef28b3fa8d6ac0147cdc47db9a642fc7}{authTagLen});
231    \}
232    \textcolor{keywordflow}{else}
233 \textcolor{preprocessor}{#endif}
234    \textcolor{comment}{//Invalid cipher mode?}
235    \{
236       \textcolor{comment}{//The specified cipher mode is not supported}
237       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb876ae52f4c1d437e8688214c55c331}{ERROR\_UNSUPPORTED\_CIPHER\_MODE};
238    \}
239 
240    \textcolor{comment}{//Failed to encrypt data?}
241    \textcolor{keywordflow}{if}(error)
242       \textcolor{keywordflow}{return} error;
243 
244    \textcolor{comment}{//Compute the length of the resulting message}
245    length += encryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen} + encryptionEngine->
      \hyperlink{structTlsEncryptionEngine_aef28b3fa8d6ac0147cdc47db9a642fc7}{authTagLen};
246    \textcolor{comment}{//Fix length field}
247    \hyperlink{tls__record_8c_a956295a326cb475d6e9ad935a91690af}{tlsSetRecordLength}(context, record, length);
248 
249    \textcolor{comment}{//Increment sequence number}
250    \hyperlink{tls__record_8c_a7033a23b01aeb6f99b9876392eeb4ca4}{tlsIncSequenceNumber}(&encryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ab9706be268c77258f4c7238721793c}{seqNum});
251 
252    \textcolor{comment}{//Debug message}
253    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Encrypted record (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
254    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
255 
256    \textcolor{comment}{//Successful processing}
257    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
258 \textcolor{preprocessor}{#else}
259    \textcolor{comment}{//AEAD ciphers are not supported}
260    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb876ae52f4c1d437e8688214c55c331}{ERROR\_UNSUPPORTED\_CIPHER\_MODE};
261 \textcolor{preprocessor}{#endif}
262 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record__encryption_8c_ada4c8d478ae44afd175ccfc7426e0930}\label{tls__record__encryption_8c_ada4c8d478ae44afd175ccfc7426e0930}} 
\index{tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}!tls\+Encrypt\+Cbc\+Record@{tls\+Encrypt\+Cbc\+Record}}
\index{tls\+Encrypt\+Cbc\+Record@{tls\+Encrypt\+Cbc\+Record}!tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}}
\subsubsection{\texorpdfstring{tls\+Encrypt\+Cbc\+Record()}{tlsEncryptCbcRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Encrypt\+Cbc\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{encryption\+Engine,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Record encryption (C\+BC block cipher) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em encryption\+Engine} & Pointer to the encryption engine \\
\hline
\mbox{\tt in,out}  & {\em record} & T\+LS record to be encrypted \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 273 of file tls\+\_\+record\+\_\+encryption.\+c.


\begin{DoxyCode}
275 \{
276 \textcolor{preprocessor}{#if (TLS\_CBC\_CIPHER\_SUPPORT == ENABLED)}
277    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
278    \textcolor{keywordtype}{size\_t} i;
279    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
280    \textcolor{keywordtype}{size\_t} paddingLen;
281    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
282    \textcolor{keyword}{const} \hyperlink{structCipherAlgo}{CipherAlgo} *cipherAlgo;
283 
284    \textcolor{comment}{//Point to the cipher algorithm}
285    cipherAlgo = encryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ba455619112e97e419c3c51de90b0ca}{cipherAlgo};
286 
287    \textcolor{comment}{//Get the length of the TLS record}
288    length = \hyperlink{tls__record_8c_ab259ff6b1964745a6f4646139c69bfec}{tlsGetRecordLength}(context, record);
289    \textcolor{comment}{//Point to the payload}
290    data = \hyperlink{tls__record_8c_a937201285f16b034ffc504f6151b9f37}{tlsGetRecordData}(context, record);
291 
292    \textcolor{comment}{//Debug message}
293    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Record to be encrypted (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
294    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
295 
296 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_1 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
297    \textcolor{comment}{//TLS 1.1 and 1.2 use an explicit IV}
298    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} >= \hyperlink{tls_8h_a9e359f668824d16983a41f8deb338979}{TLS\_VERSION\_1\_1})
299    \{
300       \textcolor{comment}{//Make room for the IV at the beginning of the data}
301       memmove(data + encryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen}, data, length);
302 
303       \textcolor{comment}{//The initialization vector should be chosen at random}
304       error = context->prngAlgo->read(context->prngContext, data,
305          encryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen});
306       \textcolor{comment}{//Any error to report?}
307       \textcolor{keywordflow}{if}(error)
308          \textcolor{keywordflow}{return} error;
309 
310       \textcolor{comment}{//Adjust the length of the message}
311       length += encryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen};
312    \}
313 \textcolor{preprocessor}{#endif}
314 
315    \textcolor{comment}{//Get the actual amount of bytes in the last block}
316    paddingLen = (length + 1) % cipherAlgo->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize};
317 
318    \textcolor{comment}{//Padding is added to force the length of the plaintext to be an}
319    \textcolor{comment}{//integral multiple of the cipher's block length}
320    \textcolor{keywordflow}{if}(paddingLen > 0)
321       paddingLen = cipherAlgo->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize} - paddingLen;
322 
323    \textcolor{comment}{//Write padding bytes}
324    \textcolor{keywordflow}{for}(i = 0; i <= paddingLen; i++)
325    \{
326       data[length + i] = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) paddingLen;
327    \}
328 
329    \textcolor{comment}{//Compute the length of the resulting message}
330    length += paddingLen + 1;
331    \textcolor{comment}{//Fix length field}
332    \hyperlink{tls__record_8c_a956295a326cb475d6e9ad935a91690af}{tlsSetRecordLength}(context, record, length);
333 
334    \textcolor{comment}{//Debug message}
335    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Record with padding (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
336    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
337 
338    \textcolor{comment}{//CBC encryption}
339    error = \hyperlink{cbc_8c_a51d0daca289df7143bfb16726b27e281}{cbcEncrypt}(cipherAlgo, encryptionEngine->\hyperlink{structTlsEncryptionEngine_a6fb752231a2f6d7d6789c35481af0559}{cipherContext},
340       encryptionEngine->\hyperlink{structTlsEncryptionEngine_af7dda7e3510e4e13458a16c5357143f7}{iv}, data, data, length);
341    \textcolor{comment}{//Any error to report?}
342    \textcolor{keywordflow}{if}(error)
343       \textcolor{keywordflow}{return} error;
344 
345    \textcolor{comment}{//Debug message}
346    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Encrypted record (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
347    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
348 
349    \textcolor{comment}{//Successful processing}
350    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
351 \textcolor{preprocessor}{#else}
352    \textcolor{comment}{//CBC cipher mode is not supported}
353    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb876ae52f4c1d437e8688214c55c331}{ERROR\_UNSUPPORTED\_CIPHER\_MODE};
354 \textcolor{preprocessor}{#endif}
355 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record__encryption_8c_a570ea69586ebaeac3279b864b4630a02}\label{tls__record__encryption_8c_a570ea69586ebaeac3279b864b4630a02}} 
\index{tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}!tls\+Encrypt\+Record@{tls\+Encrypt\+Record}}
\index{tls\+Encrypt\+Record@{tls\+Encrypt\+Record}!tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}}
\subsubsection{\texorpdfstring{tls\+Encrypt\+Record()}{tlsEncryptRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Encrypt\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{encryption\+Engine,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Encrypt an outgoing T\+LS record. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em encryption\+Engine} & Pointer to the encryption engine \\
\hline
\mbox{\tt in,out}  & {\em record} & T\+LS record to be encrypted \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 59 of file tls\+\_\+record\+\_\+encryption.\+c.


\begin{DoxyCode}
61 \{
62    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
63 
64 \textcolor{preprocessor}{#if (TLS\_CCM\_CIPHER\_SUPPORT == ENABLED || TLS\_CCM\_8\_CIPHER\_SUPPORT == ENABLED || \(\backslash\)}
65 \textcolor{preprocessor}{   TLS\_GCM\_CIPHER\_SUPPORT == ENABLED || TLS\_CHACHA20\_POLY1305\_SUPPORT == ENABLED)}
66    \textcolor{comment}{//AEAD cipher?}
67    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5a42db5b52a68da8ba71735ac7248f7401}{CIPHER\_MODE\_CCM} ||
68       encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af09ab2345f2ff996cf47696f7540fe7a}{CIPHER\_MODE\_GCM} ||
69       encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5a0a78e04fbee5d777bfd542b085003855}{CIPHER\_MODE\_CHACHA20\_POLY1305})
70    \{
71       \textcolor{comment}{//Perform authenticated encryption}
72       error = \hyperlink{tls__record__encryption_8c_a1384d8730aec553ed80975b72c5fb8c6}{tlsEncryptAeadRecord}(context, encryptionEngine, record);
73    \}
74    \textcolor{keywordflow}{else}
75 \textcolor{preprocessor}{#endif}
76 \textcolor{preprocessor}{#if (TLS\_CBC\_CIPHER\_SUPPORT == ENABLED)}
77    \textcolor{comment}{//CBC block cipher?}
78    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5a7c82e8aeb1e9badb0c083823b5b14eaa}{CIPHER\_MODE\_CBC})
79    \{
80       \textcolor{comment}{//Compute message authentication code}
81       error = \hyperlink{tls__record__encryption_8c_ae934755b58738b2cb4bc7bbf5d62ddd9}{tlsAppendMessageAuthCode}(context, encryptionEngine, record);
82 
83       \textcolor{comment}{//Check status code}
84       \textcolor{keywordflow}{if}(!error)
85       \{
86          \textcolor{comment}{//Encrypt the contents of the record}
87          error = \hyperlink{tls__record__encryption_8c_ada4c8d478ae44afd175ccfc7426e0930}{tlsEncryptCbcRecord}(context, encryptionEngine, record);
88       \}
89    \}
90    \textcolor{keywordflow}{else}
91 \textcolor{preprocessor}{#endif}
92 \textcolor{preprocessor}{#if (TLS\_STREAM\_CIPHER\_SUPPORT == ENABLED)}
93    \textcolor{comment}{//Stream cipher?}
94    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5a97fe9f5ed79394865625397eb96140ee}{CIPHER\_MODE\_STREAM})
95    \{
96       \textcolor{comment}{//Compute message authentication code}
97       error = \hyperlink{tls__record__encryption_8c_ae934755b58738b2cb4bc7bbf5d62ddd9}{tlsAppendMessageAuthCode}(context, encryptionEngine, record);
98 
99       \textcolor{comment}{//Check status code}
100       \textcolor{keywordflow}{if}(!error)
101       \{
102          \textcolor{comment}{//Encrypt the contents of the record}
103          error = \hyperlink{tls__record__encryption_8c_a90ddf9ce156fdf3a42f30a5682027cfb}{tlsEncryptStreamRecord}(context, encryptionEngine, record);
104       \}
105    \}
106    \textcolor{keywordflow}{else}
107 \textcolor{preprocessor}{#endif}
108 \textcolor{preprocessor}{#if (TLS\_NULL\_CIPHER\_SUPPORT == ENABLED)}
109    \textcolor{comment}{//NULL cipher?}
110    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af2b260457a3fa53d37ac1701c7b6502e}{CIPHER\_MODE\_NULL})
111    \{
112       \textcolor{comment}{//Compute message authentication code}
113       error = \hyperlink{tls__record__encryption_8c_ae934755b58738b2cb4bc7bbf5d62ddd9}{tlsAppendMessageAuthCode}(context, encryptionEngine, record);
114    \}
115    \textcolor{keywordflow}{else}
116 \textcolor{preprocessor}{#endif}
117    \textcolor{comment}{//Invalid cipher mode?}
118    \{
119       \textcolor{comment}{//The specified cipher mode is not supported}
120       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb876ae52f4c1d437e8688214c55c331}{ERROR\_UNSUPPORTED\_CIPHER\_MODE};
121    \}
122 
123    \textcolor{comment}{//Return status code}
124    \textcolor{keywordflow}{return} error;
125 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record__encryption_8c_a90ddf9ce156fdf3a42f30a5682027cfb}\label{tls__record__encryption_8c_a90ddf9ce156fdf3a42f30a5682027cfb}} 
\index{tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}!tls\+Encrypt\+Stream\+Record@{tls\+Encrypt\+Stream\+Record}}
\index{tls\+Encrypt\+Stream\+Record@{tls\+Encrypt\+Stream\+Record}!tls\+\_\+record\+\_\+encryption.\+c@{tls\+\_\+record\+\_\+encryption.\+c}}
\subsubsection{\texorpdfstring{tls\+Encrypt\+Stream\+Record()}{tlsEncryptStreamRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Encrypt\+Stream\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{encryption\+Engine,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Record encryption (stream cipher) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em encryption\+Engine} & Pointer to the encryption engine \\
\hline
\mbox{\tt in,out}  & {\em record} & T\+LS record to be encrypted \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 366 of file tls\+\_\+record\+\_\+encryption.\+c.


\begin{DoxyCode}
368 \{
369 \textcolor{preprocessor}{#if (TLS\_STREAM\_CIPHER\_SUPPORT == ENABLED)}
370    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
371    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
372 
373    \textcolor{comment}{//Get the length of the TLS record}
374    length = \hyperlink{tls__record_8c_ab259ff6b1964745a6f4646139c69bfec}{tlsGetRecordLength}(context, record);
375    \textcolor{comment}{//Point to the payload}
376    data = \hyperlink{tls__record_8c_a937201285f16b034ffc504f6151b9f37}{tlsGetRecordData}(context, record);
377 
378    \textcolor{comment}{//Debug message}
379    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Record to be encrypted (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
380    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
381 
382    \textcolor{comment}{//Encrypt record contents}
383    encryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ba455619112e97e419c3c51de90b0ca}{cipherAlgo}->\hyperlink{structCipherAlgo_a158602146ec9ac4f5eb3540e603b0a44}{encryptStream}(
384       encryptionEngine->\hyperlink{structTlsEncryptionEngine_a6fb752231a2f6d7d6789c35481af0559}{cipherContext}, data, data, length);
385 
386    \textcolor{comment}{//Debug message}
387    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Encrypted record (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
388    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
389 
390    \textcolor{comment}{//Successful processing}
391    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
392 \textcolor{preprocessor}{#else}
393    \textcolor{comment}{//Stream ciphers are not supported}
394    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb876ae52f4c1d437e8688214c55c331}{ERROR\_UNSUPPORTED\_CIPHER\_MODE};
395 \textcolor{preprocessor}{#endif}
396 \}
\end{DoxyCode}
