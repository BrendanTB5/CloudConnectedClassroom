\hypertarget{modbus__server__pdu_8c}{}\section{cyclone\+\_\+tcp/modbus/modbus\+\_\+server\+\_\+pdu.c File Reference}
\label{modbus__server__pdu_8c}\index{cyclone\+\_\+tcp/modbus/modbus\+\_\+server\+\_\+pdu.\+c@{cyclone\+\_\+tcp/modbus/modbus\+\_\+server\+\_\+pdu.\+c}}


Modbus P\+DU processing.  


{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+server.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+server\+\_\+pdu.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+server\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+debug.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{modbus__server__pdu_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_aa132de375069fd85fe54b72fe90f445f}{M\+O\+D\+B\+U\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__pdu_8c_abd690a574433bb829e14d0b441231e92}{modbus\+Server\+Process\+Request} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Process Modbus request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__pdu_8c_a06cfbb21593b3452e371a12eaeae32c7}{modbus\+Server\+Process\+Read\+Coils\+Req} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, const \hyperlink{modbus__common_8h_aa4702d51ba783b5878e2d85eb50f12eb}{Modbus\+Read\+Coils\+Req} $\ast$request, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process Read Coils request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__pdu_8c_a7cf7ba0ec9500e864a51a5ab5e92782c}{modbus\+Server\+Process\+Read\+Discrete\+Inputs\+Req} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, const \hyperlink{modbus__common_8h_a6b3c6bf2487d67b21ae247c81021f9d9}{Modbus\+Read\+Discrete\+Inputs\+Req} $\ast$request, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process Read Discrete Inputs request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__pdu_8c_a6392c779ce25f14a695dbc2e59687cfc}{modbus\+Server\+Process\+Read\+Holding\+Regs\+Req} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, const \hyperlink{modbus__common_8h_aa297b84e33b977936179091b40b94105}{Modbus\+Read\+Holding\+Regs\+Req} $\ast$request, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process Read Holding Registers request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__pdu_8c_a798ee2cc07051f07f128ac4a340c8758}{modbus\+Server\+Process\+Read\+Input\+Regs\+Req} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, const \hyperlink{modbus__common_8h_afa5ef848526c22d4c830ba2f983c5d9e}{Modbus\+Read\+Input\+Regs\+Req} $\ast$request, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process Read Input Registers request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__pdu_8c_a4bc96d0fd0eab0cd850bbb8140a66f12}{modbus\+Server\+Process\+Write\+Single\+Coil\+Req} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, const \hyperlink{modbus__common_8h_aad1ac61db943fe79841b4fbce3052319}{Modbus\+Write\+Single\+Coil\+Req} $\ast$request, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process Write Single Coil request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__pdu_8c_ac3e40b6726e1137fef819100b3c30878}{modbus\+Server\+Process\+Write\+Single\+Reg\+Req} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, const \hyperlink{modbus__common_8h_a74bda8038d20dce920761c0034bd14b4}{Modbus\+Write\+Single\+Reg\+Req} $\ast$request, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process Write Single Register request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__pdu_8c_a3e5b29aa82f9fae851b640209aa002a2}{modbus\+Server\+Process\+Write\+Multiple\+Coils\+Req} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, const \hyperlink{modbus__common_8h_a19f63f9dc17af71e9c7828d1ec2c642a}{Modbus\+Write\+Multiple\+Coils\+Req} $\ast$request, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process Write Multiple Coils request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__pdu_8c_a32868447f35f14706080437b394b1d39}{modbus\+Server\+Process\+Write\+Multiple\+Regs\+Req} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, const \hyperlink{modbus__common_8h_a0df4ddefd60ea51eeed19e72451abb6f}{Modbus\+Write\+Multiple\+Regs\+Req} $\ast$request, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process Write Multiple Registers request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__pdu_8c_a53f6d9e7bcfdf047cd62f54c2858a685}{modbus\+Server\+Process\+Mask\+Write\+Reg\+Req} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, const \hyperlink{modbus__common_8h_a7539dcefe33983a8d5c3f4cc09aa8a4e}{Modbus\+Mask\+Write\+Reg\+Req} $\ast$request, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process Mask Write Register request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__pdu_8c_aefac671a9f0081dfdb0a1b15e013c48a}{modbus\+Server\+Process\+Read\+Write\+Multiple\+Regs\+Req} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, const \hyperlink{modbus__common_8h_a61b1d57beb231e4493215507659b8fa3}{Modbus\+Read\+Write\+Multiple\+Regs\+Req} $\ast$request, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process Read/\+Write Multiple Registers request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__pdu_8c_a540a1f3f9f47e62a6d4adad3388b67d7}{modbus\+Server\+Format\+Exception\+Resp} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, \hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0b}{Modbus\+Function\+Code} \hyperlink{modbus__common_8h_ac97f602b24d9eeef735f2f8cfd5a54ba}{function\+Code}, \hyperlink{modbus__common_8h_a0b7f726dfaa2b4cf98aaaed1eb42fa72}{Modbus\+Exception\+Code} \hyperlink{modbus__common_8h_a87000e9fd18fc68c309200e9abe4bb68}{exception\+Code})
\begin{DoxyCompactList}\small\item\em Format exception response. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Modbus P\+DU processing. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{modbus__server__pdu_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{modbus__server__pdu_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_aa132de375069fd85fe54b72fe90f445f}{M\+O\+D\+B\+U\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file modbus\+\_\+server\+\_\+pdu.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{modbus__server__pdu_8c_a540a1f3f9f47e62a6d4adad3388b67d7}\label{modbus__server__pdu_8c_a540a1f3f9f47e62a6d4adad3388b67d7}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!modbus\+Server\+Format\+Exception\+Resp@{modbus\+Server\+Format\+Exception\+Resp}}
\index{modbus\+Server\+Format\+Exception\+Resp@{modbus\+Server\+Format\+Exception\+Resp}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Format\+Exception\+Resp()}{modbusServerFormatExceptionResp()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Format\+Exception\+Resp (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0b}{Modbus\+Function\+Code}}]{function\+Code,  }\item[{\hyperlink{modbus__common_8h_a0b7f726dfaa2b4cf98aaaed1eb42fa72}{Modbus\+Exception\+Code}}]{exception\+Code }\end{DoxyParamCaption})}



Format exception response. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em function\+Code} & Function code of the request \\
\hline
\mbox{\tt in}  & {\em exception\+Code} & Exception code \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Exception code 
\end{DoxyReturn}


Definition at line 1037 of file modbus\+\_\+server\+\_\+pdu.\+c.


\begin{DoxyCode}
1039 \{
1040    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1041    \hyperlink{modbus__common_8h_ac67e266bf48a77fcfa7c438e8b45e461}{ModbusExceptionResp} *response;
1042 
1043    \textcolor{comment}{//Point to the Modbus response PDU}
1044    response = \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbusServerGetResponsePdu}(connection);
1045 
1046    \textcolor{comment}{//Format Exception response}
1047    response->functionCode = \hyperlink{modbus__common_8h_ab61e7a8d3e7254830873c58f657c460c}{MODBUS\_EXCEPTION\_MASK} | 
      \hyperlink{modbus__common_8h_ac97f602b24d9eeef735f2f8cfd5a54ba}{functionCode};
1048    response->exceptionCode = \hyperlink{modbus__common_8h_a87000e9fd18fc68c309200e9abe4bb68}{exceptionCode};
1049 
1050    \textcolor{comment}{//Compute the length of the response PDU}
1051    length = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_ac67e266bf48a77fcfa7c438e8b45e461}{ModbusExceptionResp});
1052 
1053    \textcolor{comment}{//Debug message}
1054    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Sending Response PDU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length)
      ;
1055    \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
1056    \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(response, length);
1057 
1058    \textcolor{comment}{//Format MBAP header}
1059    \textcolor{keywordflow}{return} \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbusServerFormatMbapHeader}(connection, length);
1060 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__pdu_8c_a53f6d9e7bcfdf047cd62f54c2858a685}\label{modbus__server__pdu_8c_a53f6d9e7bcfdf047cd62f54c2858a685}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!modbus\+Server\+Process\+Mask\+Write\+Reg\+Req@{modbus\+Server\+Process\+Mask\+Write\+Reg\+Req}}
\index{modbus\+Server\+Process\+Mask\+Write\+Reg\+Req@{modbus\+Server\+Process\+Mask\+Write\+Reg\+Req}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Process\+Mask\+Write\+Reg\+Req()}{modbusServerProcessMaskWriteRegReq()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Process\+Mask\+Write\+Reg\+Req (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{modbus__common_8h_a7539dcefe33983a8d5c3f4cc09aa8a4e}{Modbus\+Mask\+Write\+Reg\+Req} $\ast$}]{request,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process Mask Write Register request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em request} & Pointer to the request P\+DU \\
\hline
\mbox{\tt in}  & {\em length} & Length of the request P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 853 of file modbus\+\_\+server\+\_\+pdu.\+c.


\begin{DoxyCode}
855 \{
856    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
857    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
858    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{modbus__common_8h_acb3a59cf566f9458f57ee33d025a6edb}{andMask};
859    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{modbus__common_8h_ab78e691ac48889ca164516c323c53791}{orMask};
860    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
861    \hyperlink{modbus__common_8h_ab12c078025995256fd47af2a77b48da9}{ModbusMaskWriteRegResp} *response;
862 
863    \textcolor{comment}{//Malformed PDU?}
864    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a7539dcefe33983a8d5c3f4cc09aa8a4e}{ModbusMaskWriteRegReq}))
865       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
866 
867    \textcolor{comment}{//Get the address of the register}
868    address = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->referenceAddr);
869    \textcolor{comment}{//Get the value of the AND mask}
870    andMask = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->andMask);
871    \textcolor{comment}{//Get the value of the OR mask}
872    orMask = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->orMask);
873 
874    \textcolor{comment}{//Lock access to Modbus table}
875    \hyperlink{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}{modbusServerLock}(connection);
876 
877    \textcolor{comment}{//Retrieve the value of the register}
878    error = \hyperlink{modbus__server__misc_8c_aa21275a0aedb09f8232538300dfe5c12}{modbusServerReadHoldingReg}(connection, address, &value);
879 
880    \textcolor{comment}{//Check status code}
881    \textcolor{keywordflow}{if}(!error)
882    \{
883       \textcolor{comment}{//Apply AND mask and OR mask}
884       value = (value & \hyperlink{modbus__common_8h_acb3a59cf566f9458f57ee33d025a6edb}{andMask}) | (orMask & ~andMask);
885       \textcolor{comment}{//Write register value}
886       error = \hyperlink{modbus__server__misc_8c_a1f56a7850a7fa591bab6c1b6764a9f09}{modbusServerWriteReg}(connection, address, value, 
      \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
887    \}
888 
889    \textcolor{comment}{//Unlock access to Modbus table}
890    \hyperlink{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}{modbusServerUnlock}(connection);
891 
892    \textcolor{comment}{//Check whether the write operation has failed}
893    \textcolor{keywordflow}{if}(error)
894       \textcolor{keywordflow}{return} error;
895 
896    \textcolor{comment}{//Point to the Modbus response PDU}
897    response = \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbusServerGetResponsePdu}(connection);
898 
899    \textcolor{comment}{//The normal response is an echo of the request}
900    response->functionCode = request->functionCode;
901    response->referenceAddr = request->referenceAddr;
902    response->andMask = request->andMask;
903    response->orMask = request->orMask;
904 
905    \textcolor{comment}{//Compute the length of the response PDU}
906    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_ab12c078025995256fd47af2a77b48da9}{ModbusMaskWriteRegResp});
907 
908    \textcolor{comment}{//Debug message}
909    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Sending Response PDU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
910    \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
911    \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(response, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
912 
913    \textcolor{comment}{//Format MBAP header}
914    \textcolor{keywordflow}{return} \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbusServerFormatMbapHeader}(connection, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
915 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__pdu_8c_a06cfbb21593b3452e371a12eaeae32c7}\label{modbus__server__pdu_8c_a06cfbb21593b3452e371a12eaeae32c7}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!modbus\+Server\+Process\+Read\+Coils\+Req@{modbus\+Server\+Process\+Read\+Coils\+Req}}
\index{modbus\+Server\+Process\+Read\+Coils\+Req@{modbus\+Server\+Process\+Read\+Coils\+Req}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Process\+Read\+Coils\+Req()}{modbusServerProcessReadCoilsReq()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Process\+Read\+Coils\+Req (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{modbus__common_8h_aa4702d51ba783b5878e2d85eb50f12eb}{Modbus\+Read\+Coils\+Req} $\ast$}]{request,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process Read Coils request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em request} & Pointer to the request P\+DU \\
\hline
\mbox{\tt in}  & {\em length} & Length of the request P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 220 of file modbus\+\_\+server\+\_\+pdu.\+c.


\begin{DoxyCode}
222 \{
223    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
224    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} i;
225    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} quantity;
226    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
227    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} state;
228    \hyperlink{modbus__common_8h_a58be1323c5adde030c9ddca852296a4a}{ModbusReadCoilsResp} *response;
229 
230    \textcolor{comment}{//Initialize status code}
231    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
232 
233    \textcolor{comment}{//Malformed PDU?}
234    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_aa4702d51ba783b5878e2d85eb50f12eb}{ModbusReadCoilsReq}))
235       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
236 
237    \textcolor{comment}{//Get the address of the first coil}
238    address = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->startingAddr);
239    \textcolor{comment}{//Get the number of coils}
240    quantity = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->quantityOfCoils);
241 
242    \textcolor{comment}{//The number of discrete inputs must be in range 1 to 2000}
243    \textcolor{keywordflow}{if}(quantity < 1 || quantity > 2000)
244       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE};
245 
246    \textcolor{comment}{//Point to the Modbus response PDU}
247    response = \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbusServerGetResponsePdu}(connection);
248 
249    \textcolor{comment}{//Format Read Coils response}
250    response->functionCode = request->functionCode;
251    response->byteCount = (quantity + 7) / 8;
252 
253    \textcolor{comment}{//If the quantity of coils is not a multiple of eight, the remaining}
254    \textcolor{comment}{//bits in the final data byte will be padded with zeros}
255    \textcolor{keywordflow}{if}((quantity % 8) != 0)
256       response->coilStatus[response->byteCount - 1] = 0;
257 
258    \textcolor{comment}{//Lock access to Modbus table}
259    \hyperlink{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}{modbusServerLock}(connection);
260 
261    \textcolor{comment}{//Read the specified number of coils}
262    \textcolor{keywordflow}{for}(i = 0; i < quantity && !error; i++)
263    \{
264       \textcolor{comment}{//Retrieve the state of the current coil}
265       error = \hyperlink{modbus__server__misc_8c_abd6a4ec07d872ffd8165b1b20f670d52}{modbusServerReadCoil}(connection, address + i, &state);
266 
267       \textcolor{comment}{//Successful read operation?}
268       \textcolor{keywordflow}{if}(!error)
269       \{
270          \textcolor{comment}{//The coils in the response message are packed as one coil per bit}
271          \textcolor{comment}{//of the data field}
272          \textcolor{keywordflow}{if}(state)
273             \hyperlink{modbus__common_8h_a5fbd9f0b7e0acba7cad9f1ff97312c3e}{MODBUS\_SET\_COIL}(response->coilStatus, i);
274          \textcolor{keywordflow}{else}
275             \hyperlink{modbus__common_8h_a4295032534529d710ae16c652dd9d9b2}{MODBUS\_RESET\_COIL}(response->coilStatus, i);
276       \}
277    \}
278 
279    \textcolor{comment}{//Unlock access to Modbus table}
280    \hyperlink{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}{modbusServerUnlock}(connection);
281 
282    \textcolor{comment}{//Check whether the read operation has failed}
283    \textcolor{keywordflow}{if}(error)
284       \textcolor{keywordflow}{return} error;
285 
286    \textcolor{comment}{//Compute the length of the response PDU}
287    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a58be1323c5adde030c9ddca852296a4a}{ModbusReadCoilsResp}) + response->byteCount;
288 
289    \textcolor{comment}{//Debug message}
290    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Sending Response PDU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
291    \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
292    \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(response, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
293 
294    \textcolor{comment}{//Format MBAP header}
295    \textcolor{keywordflow}{return} \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbusServerFormatMbapHeader}(connection, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
296 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__pdu_8c_a7cf7ba0ec9500e864a51a5ab5e92782c}\label{modbus__server__pdu_8c_a7cf7ba0ec9500e864a51a5ab5e92782c}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!modbus\+Server\+Process\+Read\+Discrete\+Inputs\+Req@{modbus\+Server\+Process\+Read\+Discrete\+Inputs\+Req}}
\index{modbus\+Server\+Process\+Read\+Discrete\+Inputs\+Req@{modbus\+Server\+Process\+Read\+Discrete\+Inputs\+Req}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Process\+Read\+Discrete\+Inputs\+Req()}{modbusServerProcessReadDiscreteInputsReq()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Process\+Read\+Discrete\+Inputs\+Req (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{modbus__common_8h_a6b3c6bf2487d67b21ae247c81021f9d9}{Modbus\+Read\+Discrete\+Inputs\+Req} $\ast$}]{request,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process Read Discrete Inputs request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em request} & Pointer to the request P\+DU \\
\hline
\mbox{\tt in}  & {\em length} & Length of the request P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 307 of file modbus\+\_\+server\+\_\+pdu.\+c.


\begin{DoxyCode}
309 \{
310    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
311    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} i;
312    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
313    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} quantity;
314    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} state;
315    \hyperlink{modbus__common_8h_a63a55a927abd455c91e8d6d460102507}{ModbusReadDiscreteInputsResp} *response;
316 
317    \textcolor{comment}{//Initialize status code}
318    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
319 
320    \textcolor{comment}{//Malformed PDU?}
321    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a6b3c6bf2487d67b21ae247c81021f9d9}{ModbusReadDiscreteInputsReq}))
322       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
323 
324    \textcolor{comment}{//Get the address of the first coil}
325    address = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->startingAddr);
326    \textcolor{comment}{//Get the number of coils}
327    quantity = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->quantityOfInputs);
328 
329    \textcolor{comment}{//The number of discrete inputs must be in range 1 to 2000}
330    \textcolor{keywordflow}{if}(quantity < 1 || quantity > 2000)
331       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE};
332 
333    \textcolor{comment}{//Point to the Modbus response PDU}
334    response = \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbusServerGetResponsePdu}(connection);
335 
336    \textcolor{comment}{//Format Read Discrete Inputs response}
337    response->functionCode = request->functionCode;
338    response->byteCount = (quantity + 7) / 8;
339 
340    \textcolor{comment}{//If the quantity of coils is not a multiple of eight, the remaining}
341    \textcolor{comment}{//bits in the final data byte will be padded with zeros}
342    \textcolor{keywordflow}{if}((quantity % 8) != 0)
343       response->inputStatus[response->byteCount - 1] = 0;
344 
345    \textcolor{comment}{//Lock access to Modbus table}
346    \hyperlink{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}{modbusServerLock}(connection);
347 
348    \textcolor{comment}{//Read the specified number of coils}
349    \textcolor{keywordflow}{for}(i = 0; i < quantity && !error; i++)
350    \{
351       \textcolor{comment}{//Retrieve the state of the current coil}
352       error = \hyperlink{modbus__server__misc_8c_a8377f33fbff980a2b4ae0e361ca427b0}{modbusServerReadDiscreteInput}(connection, address + i, &state);
353 
354       \textcolor{comment}{//Successful read operation?}
355       \textcolor{keywordflow}{if}(!error)
356       \{
357          \textcolor{comment}{//The coils in the response message are packed as one coil per bit}
358          \textcolor{comment}{//of the data field}
359          \textcolor{keywordflow}{if}(state)
360             \hyperlink{modbus__common_8h_a5fbd9f0b7e0acba7cad9f1ff97312c3e}{MODBUS\_SET\_COIL}(response->inputStatus, i);
361          \textcolor{keywordflow}{else}
362             \hyperlink{modbus__common_8h_a4295032534529d710ae16c652dd9d9b2}{MODBUS\_RESET\_COIL}(response->inputStatus, i);
363       \}
364    \}
365 
366    \textcolor{comment}{//Unlock access to Modbus table}
367    \hyperlink{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}{modbusServerUnlock}(connection);
368 
369    \textcolor{comment}{//Check whether the read operation has failed}
370    \textcolor{keywordflow}{if}(error)
371       \textcolor{keywordflow}{return} error;
372 
373    \textcolor{comment}{//Compute the length of the response PDU}
374    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a63a55a927abd455c91e8d6d460102507}{ModbusReadDiscreteInputsResp}) + response->byteCount;
375 
376    \textcolor{comment}{//Debug message}
377    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Sending Response PDU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
378    \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
379    \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(response, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
380 
381    \textcolor{comment}{//Format MBAP header}
382    \textcolor{keywordflow}{return} \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbusServerFormatMbapHeader}(connection, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
383 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__pdu_8c_a6392c779ce25f14a695dbc2e59687cfc}\label{modbus__server__pdu_8c_a6392c779ce25f14a695dbc2e59687cfc}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!modbus\+Server\+Process\+Read\+Holding\+Regs\+Req@{modbus\+Server\+Process\+Read\+Holding\+Regs\+Req}}
\index{modbus\+Server\+Process\+Read\+Holding\+Regs\+Req@{modbus\+Server\+Process\+Read\+Holding\+Regs\+Req}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Process\+Read\+Holding\+Regs\+Req()}{modbusServerProcessReadHoldingRegsReq()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Process\+Read\+Holding\+Regs\+Req (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{modbus__common_8h_aa297b84e33b977936179091b40b94105}{Modbus\+Read\+Holding\+Regs\+Req} $\ast$}]{request,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process Read Holding Registers request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em request} & Pointer to the request P\+DU \\
\hline
\mbox{\tt in}  & {\em length} & Length of the request P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 394 of file modbus\+\_\+server\+\_\+pdu.\+c.


\begin{DoxyCode}
396 \{
397    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
398    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} i;
399    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
400    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} quantity;
401    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
402    \hyperlink{modbus__common_8h_aeada894fa61622eaacc0c122f30b12f5}{ModbusReadHoldingRegsResp} *response;
403 
404    \textcolor{comment}{//Initialize status code}
405    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
406 
407    \textcolor{comment}{//Malformed PDU?}
408    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_aa297b84e33b977936179091b40b94105}{ModbusReadHoldingRegsReq}))
409       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
410 
411    \textcolor{comment}{//Get the address of the first register}
412    address = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->startingAddr);
413    \textcolor{comment}{//Get the number of registers}
414    quantity = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->quantityOfRegs);
415 
416    \textcolor{comment}{//The number of registers must be in range 1 to 125}
417    \textcolor{keywordflow}{if}(quantity < 1 || quantity > 125)
418       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE};
419 
420    \textcolor{comment}{//Point to the Modbus response PDU}
421    response = \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbusServerGetResponsePdu}(connection);
422 
423    \textcolor{comment}{//Format Read Holding Registers response}
424    response->functionCode = request->functionCode;
425    response->byteCount = quantity * \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t});
426 
427    \textcolor{comment}{//Lock access to Modbus table}
428    \hyperlink{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}{modbusServerLock}(connection);
429 
430    \textcolor{comment}{//Read the specified number of registers}
431    \textcolor{keywordflow}{for}(i = 0; i < quantity && !error; i++)
432    \{
433       \textcolor{comment}{//Retrieve the value of the current register}
434       error = \hyperlink{modbus__server__misc_8c_aa21275a0aedb09f8232538300dfe5c12}{modbusServerReadHoldingReg}(connection, address + i, &value);
435       \textcolor{comment}{//Convert the value to network byte order}
436       response->regValue[i] = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(value);
437    \}
438 
439    \textcolor{comment}{//Unlock access to Modbus table}
440    \hyperlink{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}{modbusServerUnlock}(connection);
441 
442    \textcolor{comment}{//Check whether the read operation has failed}
443    \textcolor{keywordflow}{if}(error)
444       \textcolor{keywordflow}{return} error;
445 
446    \textcolor{comment}{//Compute the length of the response PDU}
447    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_aeada894fa61622eaacc0c122f30b12f5}{ModbusReadHoldingRegsResp}) + response->byteCount;
448 
449    \textcolor{comment}{//Debug message}
450    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Sending Response PDU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
451    \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
452    \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(response, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
453 
454    \textcolor{comment}{//Format MBAP header}
455    \textcolor{keywordflow}{return} \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbusServerFormatMbapHeader}(connection, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
456 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__pdu_8c_a798ee2cc07051f07f128ac4a340c8758}\label{modbus__server__pdu_8c_a798ee2cc07051f07f128ac4a340c8758}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!modbus\+Server\+Process\+Read\+Input\+Regs\+Req@{modbus\+Server\+Process\+Read\+Input\+Regs\+Req}}
\index{modbus\+Server\+Process\+Read\+Input\+Regs\+Req@{modbus\+Server\+Process\+Read\+Input\+Regs\+Req}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Process\+Read\+Input\+Regs\+Req()}{modbusServerProcessReadInputRegsReq()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Process\+Read\+Input\+Regs\+Req (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{modbus__common_8h_afa5ef848526c22d4c830ba2f983c5d9e}{Modbus\+Read\+Input\+Regs\+Req} $\ast$}]{request,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process Read Input Registers request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em request} & Pointer to the request P\+DU \\
\hline
\mbox{\tt in}  & {\em length} & Length of the request P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 467 of file modbus\+\_\+server\+\_\+pdu.\+c.


\begin{DoxyCode}
469 \{
470    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
471    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} i;
472    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
473    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} quantity;
474    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
475    \hyperlink{modbus__common_8h_a677438bee40c2d73e2de284c5fb896ed}{ModbusReadInputRegsResp} *response;
476 
477    \textcolor{comment}{//Initialize status code}
478    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
479 
480    \textcolor{comment}{//Malformed PDU?}
481    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_afa5ef848526c22d4c830ba2f983c5d9e}{ModbusReadInputRegsReq}))
482       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
483 
484    \textcolor{comment}{//Get the address of the first register}
485    address = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->startingAddr);
486    \textcolor{comment}{//Get the number of registers}
487    quantity = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->quantityOfRegs);
488 
489    \textcolor{comment}{//The number of registers must be in range 1 to 125}
490    \textcolor{keywordflow}{if}(quantity < 1 || quantity > 125)
491       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE};
492 
493    \textcolor{comment}{//Point to the Modbus response PDU}
494    response = \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbusServerGetResponsePdu}(connection);
495 
496    \textcolor{comment}{//Format Read Input Registers response}
497    response->functionCode = request->functionCode;
498    response->byteCount = quantity * \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t});
499 
500    \textcolor{comment}{//Lock access to Modbus table}
501    \hyperlink{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}{modbusServerLock}(connection);
502 
503    \textcolor{comment}{//Read the specified number of registers}
504    \textcolor{keywordflow}{for}(i = 0; i < quantity && !error; i++)
505    \{
506       \textcolor{comment}{//Retrieve the value of the current register}
507       error = \hyperlink{modbus__server__misc_8c_a9a0997751459063835bc76ef41bf51b2}{modbusServerReadInputReg}(connection, address + i, &value);
508       \textcolor{comment}{//Convert the value to network byte order}
509       response->regValue[i] = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(value);
510    \}
511 
512    \textcolor{comment}{//Unlock access to Modbus table}
513    \hyperlink{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}{modbusServerUnlock}(connection);
514 
515    \textcolor{comment}{//Check whether the read operation has failed}
516    \textcolor{keywordflow}{if}(error)
517       \textcolor{keywordflow}{return} error;
518 
519    \textcolor{comment}{//Compute the length of the response PDU}
520    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a677438bee40c2d73e2de284c5fb896ed}{ModbusReadInputRegsResp}) + response->byteCount;
521 
522    \textcolor{comment}{//Debug message}
523    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Sending Response PDU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
524    \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
525    \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(response, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
526 
527    \textcolor{comment}{//Format MBAP header}
528    \textcolor{keywordflow}{return} \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbusServerFormatMbapHeader}(connection, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
529 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__pdu_8c_aefac671a9f0081dfdb0a1b15e013c48a}\label{modbus__server__pdu_8c_aefac671a9f0081dfdb0a1b15e013c48a}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!modbus\+Server\+Process\+Read\+Write\+Multiple\+Regs\+Req@{modbus\+Server\+Process\+Read\+Write\+Multiple\+Regs\+Req}}
\index{modbus\+Server\+Process\+Read\+Write\+Multiple\+Regs\+Req@{modbus\+Server\+Process\+Read\+Write\+Multiple\+Regs\+Req}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Process\+Read\+Write\+Multiple\+Regs\+Req()}{modbusServerProcessReadWriteMultipleRegsReq()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Process\+Read\+Write\+Multiple\+Regs\+Req (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{modbus__common_8h_a61b1d57beb231e4493215507659b8fa3}{Modbus\+Read\+Write\+Multiple\+Regs\+Req} $\ast$}]{request,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process Read/\+Write Multiple Registers request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em request} & Pointer to the request P\+DU \\
\hline
\mbox{\tt in}  & {\em length} & Length of the request P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 926 of file modbus\+\_\+server\+\_\+pdu.\+c.


\begin{DoxyCode}
928 \{
929    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
930    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} i;
931    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} readAddress;
932    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} readQuantity;
933    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} writeAddress;
934    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} writeQuantity;
935    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
936    \hyperlink{modbus__common_8h_a2c66e843f88ab1c99e9135345b818a4a}{ModbusReadWriteMultipleRegsResp} *response;
937 
938    \textcolor{comment}{//Initialize status code}
939    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
940 
941    \textcolor{comment}{//Malformed PDU?}
942    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a61b1d57beb231e4493215507659b8fa3}{ModbusReadWriteMultipleRegsReq}))
943       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
944 
945    \textcolor{comment}{//Compute the length of the data field}
946    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a0df4ddefd60ea51eeed19e72451abb6f}{ModbusWriteMultipleRegsReq});
947 
948    \textcolor{comment}{//Malformed PDU?}
949    \textcolor{keywordflow}{if}(length < request->\hyperlink{modbus__common_8h_a9ced9d8d3285539c1414169453b93f23}{writeByteCount})
950       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
951 
952    \textcolor{comment}{//Get the address of the first register to be read}
953    readAddress = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->readStartingAddr);
954    \textcolor{comment}{//Get the number of registers to be read}
955    readQuantity = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->quantityToRead);
956    \textcolor{comment}{//Get the address of the first register to be written}
957    writeAddress = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->writeStartingAddr);
958    \textcolor{comment}{//Get the number of registers to be written}
959    writeQuantity = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->quantityToWrite);
960 
961    \textcolor{comment}{//The number of registers to be read must be in range 1 to 125}
962    \textcolor{keywordflow}{if}(readQuantity < 1 || readQuantity > 125)
963       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE};
964 
965    \textcolor{comment}{//The number of registers to be written must be in range 1 to 121}
966    \textcolor{keywordflow}{if}(writeQuantity < 1 || writeQuantity > 121)
967       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE};
968 
969    \textcolor{comment}{//Check byte count field}
970    \textcolor{keywordflow}{if}(request->writeByteCount != (writeQuantity * \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t})))
971       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE};
972 
973    \textcolor{comment}{//Point to the Modbus response PDU}
974    response = \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbusServerGetResponsePdu}(connection);
975 
976    \textcolor{comment}{//Format Read/Write Multiple Registers response}
977    response->functionCode = request->functionCode;
978    response->readByteCount = readQuantity * \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t});
979 
980    \textcolor{comment}{//Lock access to Modbus table}
981    \hyperlink{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}{modbusServerLock}(connection);
982 
983    \textcolor{comment}{//Read the specified number of registers}
984    \textcolor{keywordflow}{for}(i = 0; i < readQuantity && !error; i++)
985    \{
986       \textcolor{comment}{//Retrieve the value of the current register}
987       error = \hyperlink{modbus__server__misc_8c_aa21275a0aedb09f8232538300dfe5c12}{modbusServerReadHoldingReg}(connection, readAddress + i, &value);
988 
989       \textcolor{comment}{//Convert the value to network byte order}
990       response->readRegValue[i] = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(value);
991    \}
992 
993    \textcolor{comment}{//Consistency check (first phase)}
994    \textcolor{keywordflow}{for}(i = 0; i < writeQuantity && !error; i++)
995    \{
996       \textcolor{comment}{//Validate register address}
997       error = \hyperlink{modbus__server__misc_8c_a1f56a7850a7fa591bab6c1b6764a9f09}{modbusServerWriteReg}(connection, writeAddress + i,
998          \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->writeRegValue[i]), \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
999    \}
1000 
1001    \textcolor{comment}{//Commit changes (second phase)}
1002    \textcolor{keywordflow}{for}(i = 0; i < writeQuantity && !error; i++)
1003    \{
1004       \textcolor{comment}{//Write the value of the current register}
1005       error = \hyperlink{modbus__server__misc_8c_a1f56a7850a7fa591bab6c1b6764a9f09}{modbusServerWriteReg}(connection, writeAddress + i,
1006          \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->writeRegValue[i]), \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
1007    \}
1008 
1009    \textcolor{comment}{//Unlock access to Modbus table}
1010    \hyperlink{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}{modbusServerUnlock}(connection);
1011 
1012    \textcolor{comment}{//Check whether the write operation has failed}
1013    \textcolor{keywordflow}{if}(error)
1014       \textcolor{keywordflow}{return} error;
1015 
1016    \textcolor{comment}{//Compute the length of the response PDU}
1017    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a2c66e843f88ab1c99e9135345b818a4a}{ModbusReadWriteMultipleRegsResp}) + response->
      readByteCount;
1018 
1019    \textcolor{comment}{//Debug message}
1020    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Sending Response PDU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
1021    \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
1022    \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(response, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
1023 
1024    \textcolor{comment}{//Format MBAP header}
1025    \textcolor{keywordflow}{return} \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbusServerFormatMbapHeader}(connection, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
1026 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__pdu_8c_abd690a574433bb829e14d0b441231e92}\label{modbus__server__pdu_8c_abd690a574433bb829e14d0b441231e92}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!modbus\+Server\+Process\+Request@{modbus\+Server\+Process\+Request}}
\index{modbus\+Server\+Process\+Request@{modbus\+Server\+Process\+Request}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Process\+Request()}{modbusServerProcessRequest()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Process\+Request (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Process Modbus request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 51 of file modbus\+\_\+server\+\_\+pdu.\+c.


\begin{DoxyCode}
52 \{
53    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
54    \textcolor{keywordtype}{size\_t} requestLen;
55    \textcolor{keywordtype}{size\_t} responseLen;
56    \textcolor{keywordtype}{void} *request;
57    \textcolor{keywordtype}{void} *response;
58    \hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0b}{ModbusFunctionCode} \hyperlink{modbus__common_8h_ac97f602b24d9eeef735f2f8cfd5a54ba}{functionCode};
59    \hyperlink{modbus__common_8h_a0b7f726dfaa2b4cf98aaaed1eb42fa72}{ModbusExceptionCode} \hyperlink{modbus__common_8h_a87000e9fd18fc68c309200e9abe4bb68}{exceptionCode};
60    \hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{ModbusServerContext} *context;
61 
62    \textcolor{comment}{//Point to the Modbus server context}
63    context = connection->context;
64    \textcolor{comment}{//Point to the Modbus request PDU}
65    request = \hyperlink{modbus__server__misc_8c_abe2e4dc73cd1260eb2bbbc7862c13a91}{modbusServerGetRequestPdu}(connection, &requestLen);
66 
67    \textcolor{comment}{//Malformed request?}
68    \textcolor{keywordflow}{if}(requestLen == 0)
69       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
70 
71    \textcolor{comment}{//Debug message}
72    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Request PDU received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
73       requestLen);
74 
75    \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
76    \hyperlink{modbus__debug_8c_ac0d13d0c10bfd7327330fd26bdbd1925}{modbusDumpRequestPdu}(request, requestLen);
77 
78    \textcolor{comment}{//Retrieve function code}
79    functionCode = (\hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0b}{ModbusFunctionCode}) ((\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) request)[0];
80 
81    \textcolor{comment}{//Any registered callback?}
82    \textcolor{keywordflow}{if}(context->settings.processPduCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
83    \{
84       \textcolor{comment}{//Point to the Modbus response PDU}
85       response = \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbusServerGetResponsePdu}(connection);
86       \textcolor{comment}{//Initialize response length}
87       responseLen = 0;
88 
89       \textcolor{comment}{//Process request PDU}
90       error = context->settings.processPduCallback(request, requestLen,
91          response, &responseLen);
92 
93       \textcolor{comment}{//Check status code}
94       \textcolor{keywordflow}{if}(!error)
95       \{
96          \textcolor{comment}{//Valid response PDU?}
97          \textcolor{keywordflow}{if}(responseLen > 0)
98          \{
99             \textcolor{comment}{//Debug message}
100             \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Sending Response PDU (%"} 
      \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
101                responseLen);
102 
103             \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
104             \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(response, responseLen);
105 
106             \textcolor{comment}{//Format MBAP header}
107             error = \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbusServerFormatMbapHeader}(connection, responseLen);
108          \}
109       \}
110    \}
111    \textcolor{keywordflow}{else}
112    \{
113       \textcolor{comment}{//Keep processing}
114       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca1b349e84bdbdf3372adce06ef426b735}{ERROR\_INVALID\_FUNCTION\_CODE};
115    \}
116 
117    \textcolor{comment}{//Unknown function code?}
118    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca1b349e84bdbdf3372adce06ef426b735}{ERROR\_INVALID\_FUNCTION\_CODE})
119    \{
120       \textcolor{comment}{//Check function code}
121       \textcolor{keywordflow}{switch}(functionCode)
122       \{
123       \textcolor{comment}{//Read Coils request?}
124       \textcolor{keywordflow}{case} \hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0ba07d947f92ea81f0d663f5dcb388ed09d}{MODBUS\_FUNCTION\_READ\_COILS}:
125          \textcolor{comment}{//Process Modbus PDU}
126          error = \hyperlink{modbus__server__pdu_8c_a06cfbb21593b3452e371a12eaeae32c7}{modbusServerProcessReadCoilsReq}(connection,
127             request, requestLen);
128          \textcolor{keywordflow}{break};
129       \textcolor{comment}{//Format Read Discrete Inputs request?}
130       \textcolor{keywordflow}{case} \hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0babcff2d7c5fdc39674ce6fa20542d2767}{MODBUS\_FUNCTION\_READ\_DISCRETE\_INPUTS}:
131          \textcolor{comment}{//Process Modbus PDU}
132          error = \hyperlink{modbus__server__pdu_8c_a7cf7ba0ec9500e864a51a5ab5e92782c}{modbusServerProcessReadDiscreteInputsReq}(
      connection,
133             request, requestLen);
134          \textcolor{keywordflow}{break};
135       \textcolor{comment}{//Read Holding Registers request?}
136       \textcolor{keywordflow}{case} \hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0ba52b26a210214dfc2d06eef1eeec41b04}{MODBUS\_FUNCTION\_READ\_HOLDING\_REGS}:
137          \textcolor{comment}{//Process Modbus PDU}
138          error = \hyperlink{modbus__server__pdu_8c_a6392c779ce25f14a695dbc2e59687cfc}{modbusServerProcessReadHoldingRegsReq}(connection,
139             request, requestLen);
140          \textcolor{keywordflow}{break};
141       \textcolor{comment}{//Read Input Registers request?}
142       \textcolor{keywordflow}{case} \hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0ba95a506d74dc629acae8bd404d92ab232}{MODBUS\_FUNCTION\_READ\_INPUT\_REGS}:
143          \textcolor{comment}{//Process Modbus PDU}
144          error = \hyperlink{modbus__server__pdu_8c_a798ee2cc07051f07f128ac4a340c8758}{modbusServerProcessReadInputRegsReq}(connection,
145             request, requestLen);
146          \textcolor{keywordflow}{break};
147       \textcolor{comment}{//Write Single Coil request?}
148       \textcolor{keywordflow}{case} \hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0ba0736abb54b479e55e76ae8941675999c}{MODBUS\_FUNCTION\_WRITE\_SINGLE\_COIL}:
149          \textcolor{comment}{//Process Modbus PDU}
150          error = \hyperlink{modbus__server__pdu_8c_a4bc96d0fd0eab0cd850bbb8140a66f12}{modbusServerProcessWriteSingleCoilReq}(connection,
151             request, requestLen);
152          \textcolor{keywordflow}{break};
153       \textcolor{comment}{//Write Single Register request?}
154       \textcolor{keywordflow}{case} \hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0ba0f3b918c28650fb91247afcc40b15c0f}{MODBUS\_FUNCTION\_WRITE\_SINGLE\_REG}:
155          \textcolor{comment}{//Process Modbus PDU}
156          error = \hyperlink{modbus__server__pdu_8c_ac3e40b6726e1137fef819100b3c30878}{modbusServerProcessWriteSingleRegReq}(connection,
157             request, requestLen);
158          \textcolor{keywordflow}{break};
159       \textcolor{comment}{//Write Multiple Coils request?}
160       \textcolor{keywordflow}{case} \hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0ba7237b6ded4add7362096cd9be58d3647}{MODBUS\_FUNCTION\_WRITE\_MULTIPLE\_COILS}:
161          \textcolor{comment}{//Process Modbus PDU}
162          error = \hyperlink{modbus__server__pdu_8c_a3e5b29aa82f9fae851b640209aa002a2}{modbusServerProcessWriteMultipleCoilsReq}(
      connection,
163             request, requestLen);
164          \textcolor{keywordflow}{break};
165       \textcolor{comment}{//Write Multiple Registers request?}
166       \textcolor{keywordflow}{case} \hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0ba3cd57886a5db63792fdb96a759435a16}{MODBUS\_FUNCTION\_WRITE\_MULTIPLE\_REGS}:
167          \textcolor{comment}{//Process Modbus PDU}
168          error = \hyperlink{modbus__server__pdu_8c_a32868447f35f14706080437b394b1d39}{modbusServerProcessWriteMultipleRegsReq}(connection,
169             request, requestLen);
170          \textcolor{keywordflow}{break};
171       \textcolor{comment}{//Mask Write Register request?}
172       \textcolor{keywordflow}{case} \hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0babbd7f08400866e875a12838c719edc7c}{MODBUS\_FUNCTION\_MASK\_WRITE\_REG}:
173          \textcolor{comment}{//Process Modbus PDU}
174          error = \hyperlink{modbus__server__pdu_8c_a53f6d9e7bcfdf047cd62f54c2858a685}{modbusServerProcessMaskWriteRegReq}(connection,
175             request, requestLen);
176          \textcolor{keywordflow}{break};
177       \textcolor{comment}{//Read/Write Multiple Registers request?}
178       \textcolor{keywordflow}{case} \hyperlink{modbus__common_8h_a5dc067f13fceb5a2ac4b5d83c997ae0ba3c4313c27737af1dad599ec82de77267}{MODBUS\_FUNCTION\_READ\_WRITE\_MULTIPLE\_REGS}:
179          \textcolor{comment}{//Process Modbus PDU}
180          error = \hyperlink{modbus__server__pdu_8c_aefac671a9f0081dfdb0a1b15e013c48a}{modbusServerProcessReadWriteMultipleRegsReq}(
      connection,
181             request, requestLen);
182          \textcolor{keywordflow}{break};
183       \textcolor{comment}{//Illegal function code?}
184       \textcolor{keywordflow}{default}:
185          \textcolor{comment}{//Report an error}
186          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca1b349e84bdbdf3372adce06ef426b735}{ERROR\_INVALID\_FUNCTION\_CODE};
187          \textcolor{keywordflow}{break};
188       \}
189    \}
190 
191    \textcolor{comment}{//Any exception?}
192    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca1b349e84bdbdf3372adce06ef426b735}{ERROR\_INVALID\_FUNCTION\_CODE} ||
193       error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS} ||
194       error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE} ||
195       error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca7446f962c635e715f75bc4aff05feb77}{ERROR\_WRITE\_FAILED} ||
196       error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cacf545b4d693b270f9d01d54d86efedc2}{ERROR\_READ\_FAILED} ||
197       error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cad277e4824b55c91dc5e9ff4f177ba208}{ERROR\_DEVICE\_BUSY})
198    \{
199       \textcolor{comment}{//Retrieve exception code}
200       exceptionCode = \hyperlink{modbus__server__misc_8c_a30545bfadafe40e691b671a1978c09c0}{modbusServerTranslateExceptionCode}(error);
201 
202       \textcolor{comment}{//Send an exception response to the Modbus/TCP client}
203       error = \hyperlink{modbus__server__pdu_8c_a540a1f3f9f47e62a6d4adad3388b67d7}{modbusServerFormatExceptionResp}(connection, functionCode,
204          exceptionCode);
205    \}
206 
207    \textcolor{comment}{//Return status code}
208    \textcolor{keywordflow}{return} error;
209 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__pdu_8c_a3e5b29aa82f9fae851b640209aa002a2}\label{modbus__server__pdu_8c_a3e5b29aa82f9fae851b640209aa002a2}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!modbus\+Server\+Process\+Write\+Multiple\+Coils\+Req@{modbus\+Server\+Process\+Write\+Multiple\+Coils\+Req}}
\index{modbus\+Server\+Process\+Write\+Multiple\+Coils\+Req@{modbus\+Server\+Process\+Write\+Multiple\+Coils\+Req}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Process\+Write\+Multiple\+Coils\+Req()}{modbusServerProcessWriteMultipleCoilsReq()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Process\+Write\+Multiple\+Coils\+Req (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{modbus__common_8h_a19f63f9dc17af71e9c7828d1ec2c642a}{Modbus\+Write\+Multiple\+Coils\+Req} $\ast$}]{request,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process Write Multiple Coils request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em request} & Pointer to the request P\+DU \\
\hline
\mbox{\tt in}  & {\em length} & Length of the request P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 669 of file modbus\+\_\+server\+\_\+pdu.\+c.


\begin{DoxyCode}
671 \{
672    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
673    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} i;
674    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
675    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} quantity;
676    \hyperlink{modbus__common_8h_ace13f6faa98c98242f810f16599a68e3}{ModbusWriteMultipleCoilsResp} *response;
677 
678    \textcolor{comment}{//Initialize status code}
679    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
680 
681    \textcolor{comment}{//Malformed PDU?}
682    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a19f63f9dc17af71e9c7828d1ec2c642a}{ModbusWriteMultipleCoilsReq}))
683       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
684 
685    \textcolor{comment}{//Compute the length of the data field}
686    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a19f63f9dc17af71e9c7828d1ec2c642a}{ModbusWriteMultipleCoilsReq});
687 
688    \textcolor{comment}{//Malformed PDU?}
689    \textcolor{keywordflow}{if}(length < request->\hyperlink{ksz8851__driver_8h_a45600d295fea880887d9d1a2061ec978}{byteCount})
690       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
691 
692    \textcolor{comment}{//Get the address of the first coil to be forced}
693    address = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->startingAddr);
694    \textcolor{comment}{//Get the number of coils}
695    quantity = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->quantityOfOutputs);
696 
697    \textcolor{comment}{//The number of discrete inputs must be in range 1 to 2000}
698    \textcolor{keywordflow}{if}(quantity < 1 || quantity > 2000)
699       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE};
700 
701    \textcolor{comment}{//Check byte count field}
702    \textcolor{keywordflow}{if}(request->byteCount != ((quantity + 7) / 8))
703       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE};
704 
705    \textcolor{comment}{//Lock access to Modbus table}
706    \hyperlink{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}{modbusServerLock}(connection);
707 
708    \textcolor{comment}{//Consistency check (first phase)}
709    \textcolor{keywordflow}{for}(i = 0; i < quantity && !error; i++)
710    \{
711       \textcolor{comment}{//Validate coil address}
712       error = \hyperlink{modbus__server__misc_8c_a64f402c2e18183ee2eece59ed7e552f2}{modbusServerWriteCoil}(connection, address + i,
713          \hyperlink{modbus__common_8h_a9fb36d8b503711824817b87a1229dfa3}{MODBUS\_TEST\_COIL}(request->outputValue, i), \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
714    \}
715 
716    \textcolor{comment}{//Commit changes (second phase)}
717    \textcolor{keywordflow}{for}(i = 0; i < quantity && !error; i++)
718    \{
719       \textcolor{comment}{//Force the current coil to the desired ON/OFF state}
720       error = \hyperlink{modbus__server__misc_8c_a64f402c2e18183ee2eece59ed7e552f2}{modbusServerWriteCoil}(connection, address + i,
721          \hyperlink{modbus__common_8h_a9fb36d8b503711824817b87a1229dfa3}{MODBUS\_TEST\_COIL}(request->outputValue, i), \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
722    \}
723 
724    \textcolor{comment}{//Unlock access to Modbus table}
725    \hyperlink{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}{modbusServerUnlock}(connection);
726 
727    \textcolor{comment}{//Check whether the write operation has failed}
728    \textcolor{keywordflow}{if}(error)
729       \textcolor{keywordflow}{return} error;
730 
731    \textcolor{comment}{//Point to the Modbus response PDU}
732    response = \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbusServerGetResponsePdu}(connection);
733 
734    \textcolor{comment}{//The normal response returns the starting address, and quantity of}
735    \textcolor{comment}{//coils forced}
736    response->functionCode = request->functionCode;
737    response->startingAddr = request->startingAddr;
738    response->quantityOfOutputs = request->quantityOfOutputs;
739 
740    \textcolor{comment}{//Compute the length of the response PDU}
741    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_ace13f6faa98c98242f810f16599a68e3}{ModbusWriteMultipleCoilsResp});
742 
743    \textcolor{comment}{//Debug message}
744    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Sending Response PDU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
745    \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
746    \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(response, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
747 
748    \textcolor{comment}{//Format MBAP header}
749    \textcolor{keywordflow}{return} \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbusServerFormatMbapHeader}(connection, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
750 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__pdu_8c_a32868447f35f14706080437b394b1d39}\label{modbus__server__pdu_8c_a32868447f35f14706080437b394b1d39}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!modbus\+Server\+Process\+Write\+Multiple\+Regs\+Req@{modbus\+Server\+Process\+Write\+Multiple\+Regs\+Req}}
\index{modbus\+Server\+Process\+Write\+Multiple\+Regs\+Req@{modbus\+Server\+Process\+Write\+Multiple\+Regs\+Req}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Process\+Write\+Multiple\+Regs\+Req()}{modbusServerProcessWriteMultipleRegsReq()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Process\+Write\+Multiple\+Regs\+Req (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{modbus__common_8h_a0df4ddefd60ea51eeed19e72451abb6f}{Modbus\+Write\+Multiple\+Regs\+Req} $\ast$}]{request,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process Write Multiple Registers request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em request} & Pointer to the request P\+DU \\
\hline
\mbox{\tt in}  & {\em length} & Length of the request P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 761 of file modbus\+\_\+server\+\_\+pdu.\+c.


\begin{DoxyCode}
763 \{
764    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
765    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} i;
766    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
767    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} quantity;
768    \hyperlink{modbus__common_8h_a9e705f8cd771473661fe9acbe0a82bf3}{ModbusWriteMultipleRegsResp} *response;
769 
770    \textcolor{comment}{//Initialize status code}
771    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
772 
773    \textcolor{comment}{//Malformed PDU?}
774    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a0df4ddefd60ea51eeed19e72451abb6f}{ModbusWriteMultipleRegsReq}))
775       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
776 
777    \textcolor{comment}{//Compute the length of the data field}
778    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a0df4ddefd60ea51eeed19e72451abb6f}{ModbusWriteMultipleRegsReq});
779 
780    \textcolor{comment}{//Malformed PDU?}
781    \textcolor{keywordflow}{if}(length < request->\hyperlink{ksz8851__driver_8h_a45600d295fea880887d9d1a2061ec978}{byteCount})
782       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
783 
784    \textcolor{comment}{//Get the address of the first register to be written}
785    address = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->startingAddr);
786    \textcolor{comment}{//Get the number of registers}
787    quantity = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->quantityOfRegs);
788 
789    \textcolor{comment}{//The number of registers must be in range 1 to 123}
790    \textcolor{keywordflow}{if}(quantity < 1 || quantity > 123)
791       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE};
792 
793    \textcolor{comment}{//Check byte count field}
794    \textcolor{keywordflow}{if}(request->byteCount != (quantity * \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t})))
795       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE};
796 
797    \textcolor{comment}{//Lock access to Modbus table}
798    \hyperlink{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}{modbusServerLock}(connection);
799 
800    \textcolor{comment}{//Consistency check (first phase)}
801    \textcolor{keywordflow}{for}(i = 0; i < quantity && !error; i++)
802    \{
803       \textcolor{comment}{//Validate register address}
804       error = \hyperlink{modbus__server__misc_8c_a1f56a7850a7fa591bab6c1b6764a9f09}{modbusServerWriteReg}(connection, address + i,
805          \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->regValue[i]), \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
806    \}
807 
808    \textcolor{comment}{//Commit changes (second phase)}
809    \textcolor{keywordflow}{for}(i = 0; i < quantity && !error; i++)
810    \{
811       \textcolor{comment}{//Write the value of the current register}
812       error = \hyperlink{modbus__server__misc_8c_a1f56a7850a7fa591bab6c1b6764a9f09}{modbusServerWriteReg}(connection, address + i,
813          \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->regValue[i]), \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
814    \}
815 
816    \textcolor{comment}{//Unlock access to Modbus table}
817    \hyperlink{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}{modbusServerUnlock}(connection);
818 
819    \textcolor{comment}{//Check whether the write operation has failed}
820    \textcolor{keywordflow}{if}(error)
821       \textcolor{keywordflow}{return} error;
822 
823    \textcolor{comment}{//Point to the Modbus response PDU}
824    response = \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbusServerGetResponsePdu}(connection);
825 
826    \textcolor{comment}{//The normal response returns the starting address, and quantity of}
827    \textcolor{comment}{//registers written}
828    response->functionCode = request->functionCode;
829    response->startingAddr = request->startingAddr;
830    response->quantityOfRegs = request->quantityOfRegs;
831 
832    \textcolor{comment}{//Compute the length of the response PDU}
833    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a9e705f8cd771473661fe9acbe0a82bf3}{ModbusWriteMultipleRegsResp});
834 
835    \textcolor{comment}{//Debug message}
836    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Sending Response PDU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
837    \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
838    \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(response, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
839 
840    \textcolor{comment}{//Format MBAP header}
841    \textcolor{keywordflow}{return} \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbusServerFormatMbapHeader}(connection, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
842 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__pdu_8c_a4bc96d0fd0eab0cd850bbb8140a66f12}\label{modbus__server__pdu_8c_a4bc96d0fd0eab0cd850bbb8140a66f12}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!modbus\+Server\+Process\+Write\+Single\+Coil\+Req@{modbus\+Server\+Process\+Write\+Single\+Coil\+Req}}
\index{modbus\+Server\+Process\+Write\+Single\+Coil\+Req@{modbus\+Server\+Process\+Write\+Single\+Coil\+Req}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Process\+Write\+Single\+Coil\+Req()}{modbusServerProcessWriteSingleCoilReq()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Process\+Write\+Single\+Coil\+Req (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{modbus__common_8h_aad1ac61db943fe79841b4fbce3052319}{Modbus\+Write\+Single\+Coil\+Req} $\ast$}]{request,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process Write Single Coil request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em request} & Pointer to the request P\+DU \\
\hline
\mbox{\tt in}  & {\em length} & Length of the request P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 540 of file modbus\+\_\+server\+\_\+pdu.\+c.


\begin{DoxyCode}
542 \{
543    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
544    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
545    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} state;
546    \hyperlink{modbus__common_8h_a32e40876f9d5132564d72b54ba79fc00}{ModbusWriteSingleCoilResp} *response;
547 
548    \textcolor{comment}{//Malformed PDU?}
549    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_aad1ac61db943fe79841b4fbce3052319}{ModbusWriteSingleCoilReq}))
550       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
551 
552    \textcolor{comment}{//Get the address of the coil to be forced}
553    address = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->outputAddr);
554 
555    \textcolor{comment}{//Check output value}
556    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->outputValue) == \hyperlink{modbus__common_8h_ac0f3225620ad337214b8983403fba6bba125beb486b3996f82c2cca173622f7b5}{MODBUS\_COIL\_STATE\_ON})
557    \{
558       \textcolor{comment}{//A value of 0xFF00 requests the output to be ON}
559       state = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
560    \}
561    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->outputValue) == \hyperlink{modbus__common_8h_ac0f3225620ad337214b8983403fba6bbaf3da41abc2fd602b161001e6fb3dfb9c}{MODBUS\_COIL\_STATE\_OFF})
562    \{
563       \textcolor{comment}{//A value of 0x0000 requests the output to be OFF}
564       state = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
565    \}
566    \textcolor{keywordflow}{else}
567    \{
568       \textcolor{comment}{//Report an error}
569       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE};
570    \}
571 
572    \textcolor{comment}{//Lock access to Modbus table}
573    \hyperlink{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}{modbusServerLock}(connection);
574    \textcolor{comment}{//Force the coil to the desired ON/OFF state}
575    error = \hyperlink{modbus__server__misc_8c_a64f402c2e18183ee2eece59ed7e552f2}{modbusServerWriteCoil}(connection, address, state, 
      \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
576    \textcolor{comment}{//Unlock access to Modbus table}
577    \hyperlink{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}{modbusServerUnlock}(connection);
578 
579    \textcolor{comment}{//Check whether the write operation has failed}
580    \textcolor{keywordflow}{if}(error)
581       \textcolor{keywordflow}{return} error;
582 
583    \textcolor{comment}{//Point to the Modbus response PDU}
584    response = \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbusServerGetResponsePdu}(connection);
585 
586    \textcolor{comment}{//The normal response is an echo of the request}
587    response->functionCode = request->functionCode;
588    response->outputAddr = request->outputAddr;
589    response->outputValue = request->outputValue;
590 
591    \textcolor{comment}{//Compute the length of the response PDU}
592    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a32e40876f9d5132564d72b54ba79fc00}{ModbusWriteSingleCoilResp});
593 
594    \textcolor{comment}{//Debug message}
595    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Sending Response PDU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
596    \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
597    \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(response, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
598 
599    \textcolor{comment}{//Format MBAP header}
600    \textcolor{keywordflow}{return} \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbusServerFormatMbapHeader}(connection, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
601 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__pdu_8c_ac3e40b6726e1137fef819100b3c30878}\label{modbus__server__pdu_8c_ac3e40b6726e1137fef819100b3c30878}} 
\index{modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}!modbus\+Server\+Process\+Write\+Single\+Reg\+Req@{modbus\+Server\+Process\+Write\+Single\+Reg\+Req}}
\index{modbus\+Server\+Process\+Write\+Single\+Reg\+Req@{modbus\+Server\+Process\+Write\+Single\+Reg\+Req}!modbus\+\_\+server\+\_\+pdu.\+c@{modbus\+\_\+server\+\_\+pdu.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Process\+Write\+Single\+Reg\+Req()}{modbusServerProcessWriteSingleRegReq()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Process\+Write\+Single\+Reg\+Req (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{modbus__common_8h_a74bda8038d20dce920761c0034bd14b4}{Modbus\+Write\+Single\+Reg\+Req} $\ast$}]{request,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process Write Single Register request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em request} & Pointer to the request P\+DU \\
\hline
\mbox{\tt in}  & {\em length} & Length of the request P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 612 of file modbus\+\_\+server\+\_\+pdu.\+c.


\begin{DoxyCode}
614 \{
615    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
616    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
617    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
618    \hyperlink{modbus__common_8h_a49602e089ca6e7199f5df159e96b129d}{ModbusWriteSingleRegResp} *response;
619 
620    \textcolor{comment}{//Malformed PDU?}
621    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a74bda8038d20dce920761c0034bd14b4}{ModbusWriteSingleRegReq}))
622       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
623 
624    \textcolor{comment}{//Get the address of the register}
625    address = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->regAddr);
626    \textcolor{comment}{//Get the value of the register}
627    value = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(request->regValue);
628 
629    \textcolor{comment}{//Lock access to Modbus table}
630    \hyperlink{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}{modbusServerLock}(connection);
631    \textcolor{comment}{//Write register value}
632    error = \hyperlink{modbus__server__misc_8c_a1f56a7850a7fa591bab6c1b6764a9f09}{modbusServerWriteReg}(connection, address, value, 
      \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
633    \textcolor{comment}{//Unlock access to Modbus table}
634    \hyperlink{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}{modbusServerUnlock}(connection);
635 
636    \textcolor{comment}{//Check whether the write operation has failed}
637    \textcolor{keywordflow}{if}(error)
638       \textcolor{keywordflow}{return} error;
639 
640    \textcolor{comment}{//Point to the Modbus response PDU}
641    response = \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbusServerGetResponsePdu}(connection);
642 
643    \textcolor{comment}{//The normal response is an echo of the request}
644    response->functionCode = request->functionCode;
645    response->regAddr = request->regAddr;
646    response->regValue = request->regValue;
647 
648    \textcolor{comment}{//Compute the length of the response PDU}
649    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a49602e089ca6e7199f5df159e96b129d}{ModbusWriteSingleRegResp});
650 
651    \textcolor{comment}{//Debug message}
652    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Sending Response PDU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
653    \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
654    \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(response, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
655 
656    \textcolor{comment}{//Format MBAP header}
657    \textcolor{keywordflow}{return} \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbusServerFormatMbapHeader}(connection, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
658 \}
\end{DoxyCode}
