\hypertarget{smtp__client__auth_8c}{}\section{cyclone\+\_\+tcp/smtp/smtp\+\_\+client\+\_\+auth.c File Reference}
\label{smtp__client__auth_8c}\index{cyclone\+\_\+tcp/smtp/smtp\+\_\+client\+\_\+auth.\+c@{cyclone\+\_\+tcp/smtp/smtp\+\_\+client\+\_\+auth.\+c}}


S\+M\+TP authentication mechanism.  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}smtp/smtp\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}smtp/smtp\+\_\+client\+\_\+auth.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}smtp/smtp\+\_\+client\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{smtp__client__auth_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_af97eea6d840b58cc238cef1f34a39aa0}{S\+M\+T\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{smtp__client__auth_8c_ab92b818e1d50243ded5ee7ddae5b0aa7}{smtp\+Client\+Login\+Auth} (\hyperlink{smtp__client_8h_a1d51e1986667e1138d72dec48c441c89}{Smtp\+Client\+Context} $\ast$context, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$username, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$password)
\begin{DoxyCompactList}\small\item\em Perform L\+O\+G\+IN authentication. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{smtp__client__auth_8c_adfc4feff558f08272cf14fbc7ce340af}{smtp\+Client\+Plain\+Auth} (\hyperlink{smtp__client_8h_a1d51e1986667e1138d72dec48c441c89}{Smtp\+Client\+Context} $\ast$context, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$username, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$password)
\begin{DoxyCompactList}\small\item\em Perform P\+L\+A\+IN authentication. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{smtp__client__auth_8c_a9e5434ce531926d1b59e4eb6212be477}{smtp\+Client\+Cram\+Md5\+Auth} (\hyperlink{smtp__client_8h_a1d51e1986667e1138d72dec48c441c89}{Smtp\+Client\+Context} $\ast$context, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$username, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$password)
\begin{DoxyCompactList}\small\item\em Perform C\+R\+A\+M-\/\+M\+D5 authentication. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
S\+M\+TP authentication mechanism. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{smtp__client__auth_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{smtp__client__auth_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{smtp\+\_\+client\+\_\+auth.\+c@{smtp\+\_\+client\+\_\+auth.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!smtp\+\_\+client\+\_\+auth.\+c@{smtp\+\_\+client\+\_\+auth.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_af97eea6d840b58cc238cef1f34a39aa0}{S\+M\+T\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file smtp\+\_\+client\+\_\+auth.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{smtp__client__auth_8c_a9e5434ce531926d1b59e4eb6212be477}\label{smtp__client__auth_8c_a9e5434ce531926d1b59e4eb6212be477}} 
\index{smtp\+\_\+client\+\_\+auth.\+c@{smtp\+\_\+client\+\_\+auth.\+c}!smtp\+Client\+Cram\+Md5\+Auth@{smtp\+Client\+Cram\+Md5\+Auth}}
\index{smtp\+Client\+Cram\+Md5\+Auth@{smtp\+Client\+Cram\+Md5\+Auth}!smtp\+\_\+client\+\_\+auth.\+c@{smtp\+\_\+client\+\_\+auth.\+c}}
\subsubsection{\texorpdfstring{smtp\+Client\+Cram\+Md5\+Auth()}{smtpClientCramMd5Auth()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} smtp\+Client\+Cram\+Md5\+Auth (\begin{DoxyParamCaption}\item[{\hyperlink{smtp__client_8h_a1d51e1986667e1138d72dec48c441c89}{Smtp\+Client\+Context} $\ast$}]{context,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{username,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{password }\end{DoxyParamCaption})}



Perform C\+R\+A\+M-\/\+M\+D5 authentication. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+M\+TP client context \\
\hline
\mbox{\tt in}  & {\em username} & N\+U\+L\+L-\/terminated string containing the user name \\
\hline
\mbox{\tt in}  & {\em password} & N\+U\+L\+L-\/terminated string containing the user\textquotesingle{}s password \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 321 of file smtp\+\_\+client\+\_\+auth.\+c.


\begin{DoxyCode}
323 \{
324 \textcolor{preprocessor}{#if (SMTP\_CLIENT\_CRAM\_MD5\_AUTH\_SUPPORT == ENABLED)}
325    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
326    \hyperlink{compiler__port_8h_a022c65af7f6c8d3947e8a37d64db6ad6}{int\_t} i;
327    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
328    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
329 
330    \textcolor{comment}{//Hex conversion table}
331    \textcolor{keyword}{static} \textcolor{keyword}{const} \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} hexDigit[] =
332    \{
333       \textcolor{charliteral}{'0'}, \textcolor{charliteral}{'1'}, \textcolor{charliteral}{'2'}, \textcolor{charliteral}{'3'}, \textcolor{charliteral}{'4'}, \textcolor{charliteral}{'5'}, \textcolor{charliteral}{'6'}, \textcolor{charliteral}{'7'},
334       \textcolor{charliteral}{'8'}, \textcolor{charliteral}{'9'}, \textcolor{charliteral}{'a'}, \textcolor{charliteral}{'b'}, \textcolor{charliteral}{'c'}, \textcolor{charliteral}{'d'}, \textcolor{charliteral}{'e'}, \textcolor{charliteral}{'f'}
335    \};
336 
337    \textcolor{comment}{//Initialize status code}
338    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
339 
340    \textcolor{comment}{//Execute SMTP command sequence}
341    \textcolor{keywordflow}{while}(!error)
342    \{
343       \textcolor{comment}{//Check current state}
344       \textcolor{keywordflow}{if}(context->state == \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a6d4f5c25e53afe04c724c28bf689b53b}{SMTP\_CLIENT\_STATE\_CONNECTED})
345       \{
346          \textcolor{comment}{//Format AUTH CRAM-MD5 command}
347          error = \hyperlink{smtp__client__misc_8c_ac924542c9a648900a3f6c08f89fca3ab}{smtpClientFormatCommand}(context, \textcolor{stringliteral}{"AUTH CRAM-MD5"}, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
348 
349          \textcolor{comment}{//Check status code}
350          \textcolor{keywordflow}{if}(!error)
351          \{
352             \textcolor{comment}{//Send AUTH CRAM-MD5 command and wait for the server's response}
353             \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a604aa223130b82feebda4402f92aace6}{SMTP\_CLIENT\_STATE\_SUB\_COMMAND\_1});
354          \}
355       \}
356       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a604aa223130b82feebda4402f92aace6}{SMTP\_CLIENT\_STATE\_SUB\_COMMAND\_1})
357       \{
358          \textcolor{comment}{//Send AUTH CRAM-MD5 command and wait for the server's response}
359          error = \hyperlink{smtp__client__misc_8c_a9a573cb6d178025fe0beb8f8dab70f11}{smtpClientSendCommand}(context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
360 
361          \textcolor{comment}{//Check status code}
362          \textcolor{keywordflow}{if}(!error)
363          \{
364             \textcolor{comment}{//Check SMTP response code}
365             \textcolor{keywordflow}{if}(\hyperlink{smtp__client_8h_a17ea972951d6b2d8cf44ada358fd8d59}{SMTP\_REPLY\_CODE\_3YZ}(context->replyCode))
366             \{
367                \textcolor{comment}{//Point to the buffer}
368                p = context->buffer;
369                \textcolor{comment}{//Retrieve the length of the response}
370                n = strlen(p);
371 
372                \textcolor{comment}{//Unexpected response from the SMTP server?}
373                \textcolor{keywordflow}{if}(n <= 4)
374                \{
375                   \textcolor{comment}{//Report an error}
376                   error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
377                \}
378 
379                \textcolor{comment}{//Check status code}
380                \textcolor{keywordflow}{if}(!error)
381                \{
382                   \textcolor{comment}{//Decrypt the Base64-encoded challenge}
383                   error = \hyperlink{base64_8c_ae360cde3e2ef08783ac2e01591b78530}{base64Decode}(p + 4, n - 4, p, &n);
384                \}
385 
386                \textcolor{comment}{//Check status code}
387                \textcolor{keywordflow}{if}(!error)
388                \{
389                   \textcolor{comment}{//Compute HMAC using MD5}
390                   error = \hyperlink{hmac_8c_a2c250d9716561ce1aadb4a514b76a799}{hmacCompute}(\hyperlink{md5_8h_adcb5ecbd7a360856b056f053b0d8343d}{MD5\_HASH\_ALGO}, password, strlen(password),
391                      p, n, p);
392                \}
393 
394                \textcolor{comment}{//Check status code}
395                \textcolor{keywordflow}{if}(!error)
396                \{
397                   \textcolor{comment}{//Convert the digest to hexadecimal string}
398                   \textcolor{keywordflow}{for}(i = \hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE} - 1; i >= 0; i--)
399                   \{
400                      \textcolor{comment}{//Convert the lower nibble}
401                      p[i * 2 + 1] = hexDigit[p[i] & 0x0F];
402                      \textcolor{comment}{//Then convert the upper nibble}
403                      p[i * 2] = hexDigit[(p[i] >> 4) & 0x0F];
404                   \}
405 
406                   \textcolor{comment}{//Properly terminate the string with a NULL character}
407                   p[\hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE} * 2] = \textcolor{charliteral}{'\(\backslash\)0'};
408 
409                   \textcolor{comment}{//Make room for the username}
410                   n = strlen(username);
411                   memmove(p + n + 1, p, \hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE} * 2 + 1);
412 
413                   \textcolor{comment}{//Concatenate the user name and the text representation of}
414                   \textcolor{comment}{//the digest}
415                   strcpy(p, username);
416                   p[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}] = \textcolor{charliteral}{' '};
417 
418                   \textcolor{comment}{//Encode the resulting string with Base64 algorithm}
419                   \hyperlink{base64_8c_a6eb49435a26b3297e611264f6d1cbf5f}{base64Encode}(p, strlen(p), p, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
420                   \textcolor{comment}{//Terminate the line with a CRLF sequence}
421                   strcat(p, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
422 
423                   \textcolor{comment}{//Calculate the length of the SMTP command}
424                   context->commandLen = strlen(p);
425 
426                   \textcolor{comment}{//Debug message}
427                   \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"SMTP client: %s"}, context->buffer);
428 
429                   \textcolor{comment}{//Flush receive buffer}
430                   context->bufferPos = 0;
431                   context->replyLen = 0;
432 
433                   \textcolor{comment}{//Send the second command of the AUTH CRAM-MD5 sequence}
434                   \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212af10d15d3806fc94483d0a85b77777252}{SMTP\_CLIENT\_STATE\_SUB\_COMMAND\_2});
435                \}
436             \}
437             \textcolor{keywordflow}{else}
438             \{
439                \textcolor{comment}{//Update SMTP client state}
440                \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a6d4f5c25e53afe04c724c28bf689b53b}{SMTP\_CLIENT\_STATE\_CONNECTED});
441                \textcolor{comment}{//Report an error}
442                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
443             \}
444          \}
445       \}
446       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212af10d15d3806fc94483d0a85b77777252}{SMTP\_CLIENT\_STATE\_SUB\_COMMAND\_2})
447       \{
448          \textcolor{comment}{//Wait for the server's response}
449          error = \hyperlink{smtp__client__misc_8c_a9a573cb6d178025fe0beb8f8dab70f11}{smtpClientSendCommand}(context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
450 
451          \textcolor{comment}{//Check status code}
452          \textcolor{keywordflow}{if}(!error)
453          \{
454             \textcolor{comment}{//Check SMTP response code}
455             \textcolor{keywordflow}{if}(\hyperlink{smtp__client_8h_a9cb6804b6ece6c7b253e111101d57545}{SMTP\_REPLY\_CODE\_2YZ}(context->replyCode))
456             \{
457                \textcolor{comment}{//Update SMTP client state}
458                \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a6d4f5c25e53afe04c724c28bf689b53b}{SMTP\_CLIENT\_STATE\_CONNECTED});
459                \textcolor{comment}{//Successful user authentication}
460                \textcolor{keywordflow}{break};
461             \}
462             \textcolor{keywordflow}{else}
463             \{
464                \textcolor{comment}{//Update SMTP client state}
465                \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a6d4f5c25e53afe04c724c28bf689b53b}{SMTP\_CLIENT\_STATE\_CONNECTED});
466                \textcolor{comment}{//Report an error}
467                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
468             \}
469          \}
470       \}
471       \textcolor{keywordflow}{else}
472       \{
473          \textcolor{comment}{//Invalid state}
474          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
475       \}
476    \}
477 
478    \textcolor{comment}{//Check status code}
479    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
480    \{
481       \textcolor{comment}{//Check whether the timeout has elapsed}
482       error = \hyperlink{smtp__client__misc_8c_ad78e5cfcbf408a9b9c01c176c016100d}{smtpClientCheckTimeout}(context);
483    \}
484 
485    \textcolor{comment}{//Return status code}
486    \textcolor{keywordflow}{return} error;
487 \textcolor{preprocessor}{#else}
488    \textcolor{comment}{//CRAM-MD5 authentication is not supported}
489    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca87e6ef81b46229cb03ed0a27e7f45c6e}{ERROR\_AUTHENTICATION\_FAILED};
490 \textcolor{preprocessor}{#endif}
491 \}
\end{DoxyCode}
\mbox{\Hypertarget{smtp__client__auth_8c_ab92b818e1d50243ded5ee7ddae5b0aa7}\label{smtp__client__auth_8c_ab92b818e1d50243ded5ee7ddae5b0aa7}} 
\index{smtp\+\_\+client\+\_\+auth.\+c@{smtp\+\_\+client\+\_\+auth.\+c}!smtp\+Client\+Login\+Auth@{smtp\+Client\+Login\+Auth}}
\index{smtp\+Client\+Login\+Auth@{smtp\+Client\+Login\+Auth}!smtp\+\_\+client\+\_\+auth.\+c@{smtp\+\_\+client\+\_\+auth.\+c}}
\subsubsection{\texorpdfstring{smtp\+Client\+Login\+Auth()}{smtpClientLoginAuth()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} smtp\+Client\+Login\+Auth (\begin{DoxyParamCaption}\item[{\hyperlink{smtp__client_8h_a1d51e1986667e1138d72dec48c441c89}{Smtp\+Client\+Context} $\ast$}]{context,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{username,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{password }\end{DoxyParamCaption})}



Perform L\+O\+G\+IN authentication. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+M\+TP client context \\
\hline
\mbox{\tt in}  & {\em username} & N\+U\+L\+L-\/terminated string containing the user name \\
\hline
\mbox{\tt in}  & {\em password} & N\+U\+L\+L-\/terminated string containing the user\textquotesingle{}s password \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 52 of file smtp\+\_\+client\+\_\+auth.\+c.


\begin{DoxyCode}
54 \{
55 \textcolor{preprocessor}{#if (SMTP\_CLIENT\_LOGIN\_AUTH\_SUPPORT == ENABLED)}
56    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
57    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
58 
59    \textcolor{comment}{//Initialize status code}
60    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
61 
62    \textcolor{comment}{//Execute SMTP command sequence}
63    \textcolor{keywordflow}{while}(!error)
64    \{
65       \textcolor{comment}{//Check current state}
66       \textcolor{keywordflow}{if}(context->state == \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a6d4f5c25e53afe04c724c28bf689b53b}{SMTP\_CLIENT\_STATE\_CONNECTED})
67       \{
68          \textcolor{comment}{//Format AUTH LOGIN command}
69          error = \hyperlink{smtp__client__misc_8c_ac924542c9a648900a3f6c08f89fca3ab}{smtpClientFormatCommand}(context, \textcolor{stringliteral}{"AUTH LOGIN"}, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
70 
71          \textcolor{comment}{//Check status code}
72          \textcolor{keywordflow}{if}(!error)
73          \{
74             \textcolor{comment}{//Send AUTH LOGIN command and wait for the server's response}
75             \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a604aa223130b82feebda4402f92aace6}{SMTP\_CLIENT\_STATE\_SUB\_COMMAND\_1});
76          \}
77       \}
78       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a604aa223130b82feebda4402f92aace6}{SMTP\_CLIENT\_STATE\_SUB\_COMMAND\_1})
79       \{
80          \textcolor{comment}{//Send AUTH LOGIN command and wait for the server's response}
81          error = \hyperlink{smtp__client__misc_8c_a9a573cb6d178025fe0beb8f8dab70f11}{smtpClientSendCommand}(context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
82 
83          \textcolor{comment}{//Check status code}
84          \textcolor{keywordflow}{if}(!error)
85          \{
86             \textcolor{comment}{//Check SMTP response code}
87             \textcolor{keywordflow}{if}(\hyperlink{smtp__client_8h_a17ea972951d6b2d8cf44ada358fd8d59}{SMTP\_REPLY\_CODE\_3YZ}(context->replyCode))
88             \{
89                \textcolor{comment}{//Retrieve the length of the user name}
90                n = strlen(username);
91 
92                \textcolor{comment}{//Encode the user name with Base64 algorithm}
93                \hyperlink{base64_8c_a6eb49435a26b3297e611264f6d1cbf5f}{base64Encode}(username, n, context->buffer, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
94                \textcolor{comment}{//Terminate the line with a CRLF sequence}
95                strcat(context->buffer, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
96 
97                \textcolor{comment}{//Calculate the length of the SMTP command}
98                context->commandLen = strlen(context->buffer);
99 
100                \textcolor{comment}{//Debug message}
101                \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"SMTP client: %s"}, context->buffer);
102 
103                \textcolor{comment}{//Flush receive buffer}
104                context->bufferPos = 0;
105                context->replyLen = 0;
106 
107                \textcolor{comment}{//Send the second command of the AUTH LOGIN sequence}
108                \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212af10d15d3806fc94483d0a85b77777252}{SMTP\_CLIENT\_STATE\_SUB\_COMMAND\_2});
109             \}
110             \textcolor{keywordflow}{else}
111             \{
112                \textcolor{comment}{//Update SMTP client state}
113                \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a6d4f5c25e53afe04c724c28bf689b53b}{SMTP\_CLIENT\_STATE\_CONNECTED});
114                \textcolor{comment}{//Report an error}
115                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
116             \}
117          \}
118       \}
119       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212af10d15d3806fc94483d0a85b77777252}{SMTP\_CLIENT\_STATE\_SUB\_COMMAND\_2})
120       \{
121          \textcolor{comment}{//Wait for the server's response}
122          error = \hyperlink{smtp__client__misc_8c_a9a573cb6d178025fe0beb8f8dab70f11}{smtpClientSendCommand}(context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
123 
124          \textcolor{comment}{//Check status code}
125          \textcolor{keywordflow}{if}(!error)
126          \{
127             \textcolor{comment}{//Check SMTP response code}
128             \textcolor{keywordflow}{if}(\hyperlink{smtp__client_8h_a17ea972951d6b2d8cf44ada358fd8d59}{SMTP\_REPLY\_CODE\_3YZ}(context->replyCode))
129             \{
130                \textcolor{comment}{//Retrieve the length of the password}
131                n = strlen(password);
132 
133                \textcolor{comment}{//Encode the password with Base64 algorithm}
134                \hyperlink{base64_8c_a6eb49435a26b3297e611264f6d1cbf5f}{base64Encode}(password, n, context->buffer, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
135                \textcolor{comment}{//Terminate the line with a CRLF sequence}
136                strcat(context->buffer, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
137 
138                \textcolor{comment}{//Calculate the length of the SMTP command}
139                context->commandLen = strlen(context->buffer);
140 
141                \textcolor{comment}{//Debug message}
142                \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"SMTP client: %s"}, context->buffer);
143 
144                \textcolor{comment}{//Flush receive buffer}
145                context->bufferPos = 0;
146                context->replyLen = 0;
147 
148                \textcolor{comment}{//Send the third command of the AUTH LOGIN sequence}
149                \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212ae8779b04af528f5a554e46018811efb2}{SMTP\_CLIENT\_STATE\_SUB\_COMMAND\_3});
150             \}
151             \textcolor{keywordflow}{else}
152             \{
153                \textcolor{comment}{//Update SMTP client state}
154                \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a6d4f5c25e53afe04c724c28bf689b53b}{SMTP\_CLIENT\_STATE\_CONNECTED});
155                \textcolor{comment}{//Report an error}
156                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
157             \}
158          \}
159       \}
160       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212ae8779b04af528f5a554e46018811efb2}{SMTP\_CLIENT\_STATE\_SUB\_COMMAND\_3})
161       \{
162          \textcolor{comment}{//Wait for the server's response}
163          error = \hyperlink{smtp__client__misc_8c_a9a573cb6d178025fe0beb8f8dab70f11}{smtpClientSendCommand}(context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
164 
165          \textcolor{comment}{//Check status code}
166          \textcolor{keywordflow}{if}(!error)
167          \{
168             \textcolor{comment}{//Check SMTP response code}
169             \textcolor{keywordflow}{if}(\hyperlink{smtp__client_8h_a9cb6804b6ece6c7b253e111101d57545}{SMTP\_REPLY\_CODE\_2YZ}(context->replyCode))
170             \{
171                \textcolor{comment}{//Update SMTP client state}
172                \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a6d4f5c25e53afe04c724c28bf689b53b}{SMTP\_CLIENT\_STATE\_CONNECTED});
173                \textcolor{comment}{//Successful user authentication}
174                \textcolor{keywordflow}{break};
175             \}
176             \textcolor{keywordflow}{else}
177             \{
178                \textcolor{comment}{//Update SMTP client state}
179                \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a6d4f5c25e53afe04c724c28bf689b53b}{SMTP\_CLIENT\_STATE\_CONNECTED});
180                \textcolor{comment}{//Report an error}
181                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
182             \}
183          \}
184       \}
185       \textcolor{keywordflow}{else}
186       \{
187          \textcolor{comment}{//Invalid state}
188          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
189       \}
190    \}
191 
192    \textcolor{comment}{//Check status code}
193    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
194    \{
195       \textcolor{comment}{//Check whether the timeout has elapsed}
196       error = \hyperlink{smtp__client__misc_8c_ad78e5cfcbf408a9b9c01c176c016100d}{smtpClientCheckTimeout}(context);
197    \}
198 
199    \textcolor{comment}{//Return status code}
200    \textcolor{keywordflow}{return} error;
201 \textcolor{preprocessor}{#else}
202    \textcolor{comment}{//LOGIN authentication is not supported}
203    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca87e6ef81b46229cb03ed0a27e7f45c6e}{ERROR\_AUTHENTICATION\_FAILED};
204 \textcolor{preprocessor}{#endif}
205 \}
\end{DoxyCode}
\mbox{\Hypertarget{smtp__client__auth_8c_adfc4feff558f08272cf14fbc7ce340af}\label{smtp__client__auth_8c_adfc4feff558f08272cf14fbc7ce340af}} 
\index{smtp\+\_\+client\+\_\+auth.\+c@{smtp\+\_\+client\+\_\+auth.\+c}!smtp\+Client\+Plain\+Auth@{smtp\+Client\+Plain\+Auth}}
\index{smtp\+Client\+Plain\+Auth@{smtp\+Client\+Plain\+Auth}!smtp\+\_\+client\+\_\+auth.\+c@{smtp\+\_\+client\+\_\+auth.\+c}}
\subsubsection{\texorpdfstring{smtp\+Client\+Plain\+Auth()}{smtpClientPlainAuth()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} smtp\+Client\+Plain\+Auth (\begin{DoxyParamCaption}\item[{\hyperlink{smtp__client_8h_a1d51e1986667e1138d72dec48c441c89}{Smtp\+Client\+Context} $\ast$}]{context,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{username,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{password }\end{DoxyParamCaption})}



Perform P\+L\+A\+IN authentication. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+M\+TP client context \\
\hline
\mbox{\tt in}  & {\em username} & N\+U\+L\+L-\/terminated string containing the user name \\
\hline
\mbox{\tt in}  & {\em password} & N\+U\+L\+L-\/terminated string containing the user\textquotesingle{}s password \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 216 of file smtp\+\_\+client\+\_\+auth.\+c.


\begin{DoxyCode}
218 \{
219 \textcolor{preprocessor}{#if (SMTP\_CLIENT\_PLAIN\_AUTH\_SUPPORT == ENABLED)}
220    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
221    \textcolor{keywordtype}{size\_t} \hyperlink{ndp_8h_a6b3284d8492267a77ca46948daf5545e}{m};
222    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
223    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
224 
225    \textcolor{comment}{//Initialize status code}
226    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
227 
228    \textcolor{comment}{//Execute SMTP command sequence}
229    \textcolor{keywordflow}{while}(!error)
230    \{
231       \textcolor{comment}{//Check current state}
232       \textcolor{keywordflow}{if}(context->state == \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a6d4f5c25e53afe04c724c28bf689b53b}{SMTP\_CLIENT\_STATE\_CONNECTED})
233       \{
234          \textcolor{comment}{//Point to the buffer}
235          p = context->buffer;
236 
237          \textcolor{comment}{//Format AUTH PLAIN command}
238          m = sprintf(p, \textcolor{stringliteral}{"AUTH PLAIN "});
239 
240          \textcolor{comment}{//Authorization identity}
241          n = sprintf(p + m, username) + 1;
242          \textcolor{comment}{//Authentication identity}
243          n += sprintf(p + m + n, username) + 1;
244          \textcolor{comment}{//Password}
245          n += sprintf(p + m + n, password);
246 
247          \textcolor{comment}{//Base64 encoding}
248          \hyperlink{base64_8c_a6eb49435a26b3297e611264f6d1cbf5f}{base64Encode}(p + m, n, p + m, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
249          \textcolor{comment}{//Terminate the line with a CRLF sequence}
250          strcat(p, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
251 
252          \textcolor{comment}{//Calculate the length of the SMTP command}
253          context->commandLen = strlen(p);
254 
255          \textcolor{comment}{//Debug message}
256          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"SMTP client: %s"}, context->buffer);
257 
258          \textcolor{comment}{//Flush receive buffer}
259          context->bufferPos = 0;
260          context->replyLen = 0;
261 
262          \textcolor{comment}{//Send AUTH PLAIN command and wait for the server's response}
263          \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a604aa223130b82feebda4402f92aace6}{SMTP\_CLIENT\_STATE\_SUB\_COMMAND\_1});
264       \}
265       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a604aa223130b82feebda4402f92aace6}{SMTP\_CLIENT\_STATE\_SUB\_COMMAND\_1})
266       \{
267          \textcolor{comment}{//Send AUTH PLAIN command and wait for the server's response}
268          error = \hyperlink{smtp__client__misc_8c_a9a573cb6d178025fe0beb8f8dab70f11}{smtpClientSendCommand}(context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
269 
270          \textcolor{comment}{//Check status code}
271          \textcolor{keywordflow}{if}(!error)
272          \{
273             \textcolor{comment}{//Check SMTP response code}
274             \textcolor{keywordflow}{if}(\hyperlink{smtp__client_8h_a9cb6804b6ece6c7b253e111101d57545}{SMTP\_REPLY\_CODE\_2YZ}(context->replyCode))
275             \{
276                \textcolor{comment}{//Update SMTP client state}
277                \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a6d4f5c25e53afe04c724c28bf689b53b}{SMTP\_CLIENT\_STATE\_CONNECTED});
278                \textcolor{comment}{//Successful user authentication}
279                \textcolor{keywordflow}{break};
280             \}
281             \textcolor{keywordflow}{else}
282             \{
283                \textcolor{comment}{//Update SMTP client state}
284                \hyperlink{smtp__client__misc_8c_a0b784079ddc4b895d3c299e9d7264c3b}{smtpClientChangeState}(context, 
      \hyperlink{smtp__client_8h_a02fc964f050527db806d949976661212a6d4f5c25e53afe04c724c28bf689b53b}{SMTP\_CLIENT\_STATE\_CONNECTED});
285                \textcolor{comment}{//Report an error}
286                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
287             \}
288          \}
289       \}
290       \textcolor{keywordflow}{else}
291       \{
292          \textcolor{comment}{//Invalid state}
293          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
294       \}
295    \}
296 
297    \textcolor{comment}{//Check status code}
298    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
299    \{
300       \textcolor{comment}{//Check whether the timeout has elapsed}
301       error = \hyperlink{smtp__client__misc_8c_ad78e5cfcbf408a9b9c01c176c016100d}{smtpClientCheckTimeout}(context);
302    \}
303 
304    \textcolor{comment}{//Return status code}
305    \textcolor{keywordflow}{return} error;
306 \textcolor{preprocessor}{#else}
307    \textcolor{comment}{//PLAIN authentication is not supported}
308    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca87e6ef81b46229cb03ed0a27e7f45c6e}{ERROR\_AUTHENTICATION\_FAILED};
309 \textcolor{preprocessor}{#endif}
310 \}
\end{DoxyCode}
