\hypertarget{dns__common_8c}{}\section{cyclone\+\_\+tcp/dns/dns\+\_\+common.c File Reference}
\label{dns__common_8c}\index{cyclone\+\_\+tcp/dns/dns\+\_\+common.\+c@{cyclone\+\_\+tcp/dns/dns\+\_\+common.\+c}}


Common D\+NS routines.  


{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dns/dns\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dns/dns\+\_\+common.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mdns/mdns\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mdns/mdns\+\_\+responder.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mdns/mdns\+\_\+common.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{dns__common_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_ac9a922c1d0cd796bab6e76bfa73b5ee7}{D\+N\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
size\+\_\+t \hyperlink{dns__common_8c_aa375505b90ab1f2473b3084c97ace370}{dns\+Encode\+Name} (const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$src, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$dest)
\begin{DoxyCompactList}\small\item\em Encode a domain name using the D\+NS name notation. \end{DoxyCompactList}\item 
size\+\_\+t \hyperlink{dns__common_8c_a6a5df1aead8f61467e9bf5e739ea5de0}{dns\+Parse\+Name} (const \hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{Dns\+Header} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, size\+\_\+t pos, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$dest, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} \hyperlink{tls_8h_abbb6c7c49508c1ac374683f2d1159e08}{level})
\begin{DoxyCompactList}\small\item\em Decode a domain name that uses the D\+NS name encoding. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a022c65af7f6c8d3947e8a37d64db6ad6}{int\+\_\+t} \hyperlink{dns__common_8c_a09647d0528e53280cc0a35866cb2b224}{dns\+Compare\+Name} (const \hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{Dns\+Header} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, size\+\_\+t pos, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} \hyperlink{tls_8h_abbb6c7c49508c1ac374683f2d1159e08}{level})
\begin{DoxyCompactList}\small\item\em Compare domain names. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a022c65af7f6c8d3947e8a37d64db6ad6}{int\+\_\+t} \hyperlink{dns__common_8c_a5a2a26fa4e4ec615f776176da210541f}{dns\+Compare\+Encoded\+Name} (const \hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{Dns\+Header} $\ast$message1, size\+\_\+t length1, size\+\_\+t pos1, const \hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{Dns\+Header} $\ast$message2, size\+\_\+t length2, size\+\_\+t pos2, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} \hyperlink{tls_8h_abbb6c7c49508c1ac374683f2d1159e08}{level})
\begin{DoxyCompactList}\small\item\em Compare domain names encoded with D\+NS notation. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Common D\+NS routines. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{dns__common_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{dns__common_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{dns\+\_\+common.\+c@{dns\+\_\+common.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!dns\+\_\+common.\+c@{dns\+\_\+common.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_ac9a922c1d0cd796bab6e76bfa73b5ee7}{D\+N\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file dns\+\_\+common.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{dns__common_8c_a5a2a26fa4e4ec615f776176da210541f}\label{dns__common_8c_a5a2a26fa4e4ec615f776176da210541f}} 
\index{dns\+\_\+common.\+c@{dns\+\_\+common.\+c}!dns\+Compare\+Encoded\+Name@{dns\+Compare\+Encoded\+Name}}
\index{dns\+Compare\+Encoded\+Name@{dns\+Compare\+Encoded\+Name}!dns\+\_\+common.\+c@{dns\+\_\+common.\+c}}
\subsubsection{\texorpdfstring{dns\+Compare\+Encoded\+Name()}{dnsCompareEncodedName()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a022c65af7f6c8d3947e8a37d64db6ad6}{int\+\_\+t} dns\+Compare\+Encoded\+Name (\begin{DoxyParamCaption}\item[{const \hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{Dns\+Header} $\ast$}]{message1,  }\item[{size\+\_\+t}]{length1,  }\item[{size\+\_\+t}]{pos1,  }\item[{const \hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{Dns\+Header} $\ast$}]{message2,  }\item[{size\+\_\+t}]{length2,  }\item[{size\+\_\+t}]{pos2,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{level }\end{DoxyParamCaption})}



Compare domain names encoded with D\+NS notation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message1} & Pointer to the first D\+NS message \\
\hline
\mbox{\tt in}  & {\em length1} & Length of the first D\+NS message \\
\hline
\mbox{\tt in}  & {\em pos1} & Offset of the encoded domain name within the first message \\
\hline
\mbox{\tt in}  & {\em message2} & Pointer to the second D\+NS message \\
\hline
\mbox{\tt in}  & {\em length2} & Length of the second D\+NS message \\
\hline
\mbox{\tt in}  & {\em pos2} & Offset of the encoded domain name within the second message \\
\hline
\mbox{\tt in}  & {\em level} & Current level of recursion \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The function returns 0 if the domain names match, -\/1 if the first domain name lexicographically precedes the second name, or 1 if the second domain name lexicographically precedes the first name 
\end{DoxyReturn}


Definition at line 339 of file dns\+\_\+common.\+c.


\begin{DoxyCode}
341 \{
342    \hyperlink{compiler__port_8h_a022c65af7f6c8d3947e8a37d64db6ad6}{int\_t} \hyperlink{resource__manager_8c_a369fab9cf831846ad1a1d6bd33a86fa1}{res};
343    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
344    \textcolor{keywordtype}{size\_t} n1;
345    \textcolor{keywordtype}{size\_t} n2;
346    \textcolor{keywordtype}{size\_t} pointer1;
347    \textcolor{keywordtype}{size\_t} pointer2;
348    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *p1;
349    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *p2;
350 
351    \textcolor{comment}{//Recursion limit exceeded?}
352    \textcolor{keywordflow}{if}(\hyperlink{tls_8h_abbb6c7c49508c1ac374683f2d1159e08}{level} >= \hyperlink{dns__common_8h_ad7c564a6c097ccf95320ec6c83e55751}{DNS\_NAME\_MAX\_RECURSION})
353       \textcolor{keywordflow}{return} -2;
354 
355    \textcolor{comment}{//Cast DNS messages to byte array}
356    p1 = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) message1;
357    p2 = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) message2;
358 
359    \textcolor{comment}{//Compare encoded domain names}
360    \textcolor{keywordflow}{while}(pos1 < length1 && pos2 < length2)
361    \{
362       \textcolor{comment}{//Retrieve the length of each label}
363       n1 = p1[pos1];
364       n2 = p2[pos2];
365 
366       \textcolor{comment}{//End marker found?}
367       \textcolor{keywordflow}{if}(n1 == 0 || n2 == 0)
368       \{
369          \textcolor{comment}{//The domain name which still has remaining data is deemed}
370          \textcolor{comment}{//lexicographically later}
371          \textcolor{keywordflow}{if}(n1 < n2)
372             \textcolor{keywordflow}{return} -1;
373          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(n1 > n2)
374             \textcolor{keywordflow}{return} 1;
375 
376          \textcolor{comment}{//The domain names match each other}
377          \textcolor{keywordflow}{return} 0;
378       \}
379       \textcolor{comment}{//Compression tag found?}
380       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(n1 >= \hyperlink{dns__common_8h_ab8e2a0ad5aad0d460862627ecee69fdb}{DNS\_COMPRESSION\_TAG} || n2 >= 
      \hyperlink{dns__common_8h_ab8e2a0ad5aad0d460862627ecee69fdb}{DNS\_COMPRESSION\_TAG})
381       \{
382          \textcolor{comment}{//First domain name compressed?}
383          \textcolor{keywordflow}{if}(n1 >= \hyperlink{dns__common_8h_ab8e2a0ad5aad0d460862627ecee69fdb}{DNS\_COMPRESSION\_TAG})
384          \{
385             \textcolor{comment}{//Malformed DNS message?}
386             \textcolor{keywordflow}{if}((pos1 + 1) >= length1)
387                \textcolor{keywordflow}{return} -2;
388 
389             \textcolor{comment}{//Read the most significant byte of the pointer}
390             pointer1 = (p1[pos1] & ~\hyperlink{dns__common_8h_ab8e2a0ad5aad0d460862627ecee69fdb}{DNS\_COMPRESSION\_TAG}) << 8;
391             \textcolor{comment}{//Read the least significant byte of the pointer}
392             pointer1 |= p1[pos1 + 1];
393          \}
394          \textcolor{keywordflow}{else}
395          \{
396             \textcolor{comment}{//The first domain name is not compressed}
397             pointer1 = pos1;
398          \}
399 
400          \textcolor{comment}{//Second domain name compressed?}
401          \textcolor{keywordflow}{if}(n2 >= \hyperlink{dns__common_8h_ab8e2a0ad5aad0d460862627ecee69fdb}{DNS\_COMPRESSION\_TAG})
402          \{
403             \textcolor{comment}{//Malformed DNS message?}
404             \textcolor{keywordflow}{if}((pos2 + 1) >= length2)
405                \textcolor{keywordflow}{return} -2;
406 
407             \textcolor{comment}{//Read the most significant byte of the pointer}
408             pointer2 = (p2[pos2] & ~\hyperlink{dns__common_8h_ab8e2a0ad5aad0d460862627ecee69fdb}{DNS\_COMPRESSION\_TAG}) << 8;
409             \textcolor{comment}{//Read the least significant byte of the pointer}
410             pointer2 |= p2[pos2 + 1];
411          \}
412          \textcolor{keywordflow}{else}
413          \{
414             \textcolor{comment}{//The second domain name is not compressed}
415             pointer2 = pos2;
416          \}
417 
418          \textcolor{comment}{//Compare the remaining part}
419          res = \hyperlink{dns__common_8c_a5a2a26fa4e4ec615f776176da210541f}{dnsCompareEncodedName}(message1, length1, pointer1,
420             message2, length2, pointer2, \hyperlink{tls_8h_abbb6c7c49508c1ac374683f2d1159e08}{level} + 1);
421 
422          \textcolor{comment}{//Return comparison result}
423          \textcolor{keywordflow}{return} \hyperlink{resource__manager_8c_a369fab9cf831846ad1a1d6bd33a86fa1}{res};
424       \}
425       \textcolor{keywordflow}{else}
426       \{
427          \textcolor{comment}{//Advance data pointer}
428          pos1++;
429          pos2++;
430 
431          \textcolor{comment}{//Malformed DNS message?}
432          \textcolor{keywordflow}{if}((pos1 + n1) > length1 || (pos2 + n2) > length2)
433             \textcolor{keywordflow}{return} -2;
434 
435          \textcolor{comment}{//Compare as much data as possible}
436          n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(n1, n2);
437 
438          \textcolor{comment}{//Compare labels}
439          res = \hyperlink{os__port__windows_8h_aba00036f71bb67f8600b239a39cf5ec9}{strncasecmp}((\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) p1 + pos1, (\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) p2 + pos2, n);
440          \textcolor{comment}{//Any mismatch?}
441          \textcolor{keywordflow}{if}(res)
442             \textcolor{keywordflow}{return} \hyperlink{resource__manager_8c_a369fab9cf831846ad1a1d6bd33a86fa1}{res};
443 
444          \textcolor{comment}{//The domain name which still has remaining data is deemed}
445          \textcolor{comment}{//lexicographically later}
446          \textcolor{keywordflow}{if}(n1 < n2)
447             \textcolor{keywordflow}{return} -1;
448          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(n1 > n2)
449             \textcolor{keywordflow}{return} 1;
450 
451          \textcolor{comment}{//Advance data pointer}
452          pos1 += n1;
453          pos2 += n2;
454       \}
455    \}
456 
457    \textcolor{comment}{//Malformed DNS message}
458    \textcolor{keywordflow}{return} -2;
459 \}
\end{DoxyCode}
\mbox{\Hypertarget{dns__common_8c_a09647d0528e53280cc0a35866cb2b224}\label{dns__common_8c_a09647d0528e53280cc0a35866cb2b224}} 
\index{dns\+\_\+common.\+c@{dns\+\_\+common.\+c}!dns\+Compare\+Name@{dns\+Compare\+Name}}
\index{dns\+Compare\+Name@{dns\+Compare\+Name}!dns\+\_\+common.\+c@{dns\+\_\+common.\+c}}
\subsubsection{\texorpdfstring{dns\+Compare\+Name()}{dnsCompareName()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a022c65af7f6c8d3947e8a37d64db6ad6}{int\+\_\+t} dns\+Compare\+Name (\begin{DoxyParamCaption}\item[{const \hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{Dns\+Header} $\ast$}]{message,  }\item[{size\+\_\+t}]{length,  }\item[{size\+\_\+t}]{pos,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{name,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{level }\end{DoxyParamCaption})}



Compare domain names. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Pointer to the D\+NS message \\
\hline
\mbox{\tt in}  & {\em length} & Length of the D\+NS message \\
\hline
\mbox{\tt in}  & {\em pos} & Offset of the encoded domain name \\
\hline
\mbox{\tt in}  & {\em name} & N\+U\+L\+L-\/terminated string that holds a domain name \\
\hline
\mbox{\tt in}  & {\em level} & Current level of recursion \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The function returns 0 if the domain names match, -\/1 if the first domain name lexicographically precedes the second name, or 1 if the second domain name lexicographically precedes the first name 
\end{DoxyReturn}


Definition at line 240 of file dns\+\_\+common.\+c.


\begin{DoxyCode}
242 \{
243    \hyperlink{compiler__port_8h_a022c65af7f6c8d3947e8a37d64db6ad6}{int\_t} \hyperlink{resource__manager_8c_a369fab9cf831846ad1a1d6bd33a86fa1}{res};
244    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
245    \textcolor{keywordtype}{size\_t} \hyperlink{icmp_8h_a7d569b4cae06fc4e5b219d6359d5b66b}{pointer};
246    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
247 
248    \textcolor{comment}{//Recursion limit exceeded?}
249    \textcolor{keywordflow}{if}(\hyperlink{tls_8h_abbb6c7c49508c1ac374683f2d1159e08}{level} >= \hyperlink{dns__common_8h_ad7c564a6c097ccf95320ec6c83e55751}{DNS\_NAME\_MAX\_RECURSION})
250       \textcolor{keywordflow}{return} -2;
251 
252    \textcolor{comment}{//Cast the DNS message to byte array}
253    p = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
254 
255    \textcolor{comment}{//Parse encoded domain name}
256    \textcolor{keywordflow}{while}(pos < \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length})
257    \{
258       \textcolor{comment}{//Retrieve the length of the current label}
259       n = p[pos];
260 
261       \textcolor{comment}{//End marker found?}
262       \textcolor{keywordflow}{if}(n == 0)
263       \{
264          \textcolor{comment}{//The domain name which still has remaining data is deemed}
265          \textcolor{comment}{//lexicographically later}
266          \textcolor{keywordflow}{if}(*\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name} != \textcolor{charliteral}{'\(\backslash\)0'})
267             \textcolor{keywordflow}{return} -1;
268 
269          \textcolor{comment}{//The domain names match each other}
270          \textcolor{keywordflow}{return} 0;
271       \}
272       \textcolor{comment}{//Compression tag found?}
273       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(n >= \hyperlink{dns__common_8h_ab8e2a0ad5aad0d460862627ecee69fdb}{DNS\_COMPRESSION\_TAG})
274       \{
275          \textcolor{comment}{//Malformed DNS message?}
276          \textcolor{keywordflow}{if}((pos + 1) >= \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length})
277             \textcolor{keywordflow}{return} \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
278 
279          \textcolor{comment}{//Read the most significant byte of the pointer}
280          pointer = (p[pos] & ~\hyperlink{dns__common_8h_ab8e2a0ad5aad0d460862627ecee69fdb}{DNS\_COMPRESSION\_TAG}) << 8;
281          \textcolor{comment}{//Read the least significant byte of the pointer}
282          pointer |= p[pos + 1];
283 
284          \textcolor{comment}{//Compare the remaining part}
285          res = \hyperlink{dns__common_8c_a09647d0528e53280cc0a35866cb2b224}{dnsCompareName}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, pointer, 
      \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}, \hyperlink{tls_8h_abbb6c7c49508c1ac374683f2d1159e08}{level} + 1);
286 
287          \textcolor{comment}{//Return comparison result}
288          \textcolor{keywordflow}{return} \hyperlink{resource__manager_8c_a369fab9cf831846ad1a1d6bd33a86fa1}{res};
289       \}
290       \textcolor{keywordflow}{else}
291       \{
292          \textcolor{comment}{//Advance data pointer}
293          pos++;
294 
295          \textcolor{comment}{//Malformed DNS message?}
296          \textcolor{keywordflow}{if}((pos + n) > \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length})
297             \textcolor{keywordflow}{return} -2;
298 
299          \textcolor{comment}{//Compare current label}
300          res = \hyperlink{os__port__windows_8h_aba00036f71bb67f8600b239a39cf5ec9}{strncasecmp}((\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) p + pos, \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}, n);
301          \textcolor{comment}{//Any mismatch?}
302          \textcolor{keywordflow}{if}(res)
303             \textcolor{keywordflow}{return} \hyperlink{resource__manager_8c_a369fab9cf831846ad1a1d6bd33a86fa1}{res};
304 
305          \textcolor{comment}{//Advance data pointer}
306          pos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
307          \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
308 
309          \textcolor{comment}{//The domain name which still has remaining data is deemed}
310          \textcolor{comment}{//lexicographically later}
311          \textcolor{keywordflow}{if}(*\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name} != \textcolor{charliteral}{'\(\backslash\)0'} && *\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name} != \textcolor{charliteral}{'.'})
312             \textcolor{keywordflow}{return} -1;
313 
314          \textcolor{comment}{//Skip the separator character, if any}
315          \textcolor{keywordflow}{if}(*\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name} == \textcolor{charliteral}{'.'})
316             \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}++;
317       \}
318    \}
319 
320    \textcolor{comment}{//Malformed DNS message}
321    \textcolor{keywordflow}{return} -2;
322 \}
\end{DoxyCode}
\mbox{\Hypertarget{dns__common_8c_aa375505b90ab1f2473b3084c97ace370}\label{dns__common_8c_aa375505b90ab1f2473b3084c97ace370}} 
\index{dns\+\_\+common.\+c@{dns\+\_\+common.\+c}!dns\+Encode\+Name@{dns\+Encode\+Name}}
\index{dns\+Encode\+Name@{dns\+Encode\+Name}!dns\+\_\+common.\+c@{dns\+\_\+common.\+c}}
\subsubsection{\texorpdfstring{dns\+Encode\+Name()}{dnsEncodeName()}}
{\footnotesize\ttfamily size\+\_\+t dns\+Encode\+Name (\begin{DoxyParamCaption}\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{src,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{dest }\end{DoxyParamCaption})}



Encode a domain name using the D\+NS name notation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em src} & Pointer to the domain name to encode \\
\hline
\mbox{\tt out}  & {\em dest} & Pointer to the encoded domain name (optional parameter) \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Length of the encoded domain name 
\end{DoxyReturn}


Definition at line 56 of file dns\+\_\+common.\+c.


\begin{DoxyCode}
57 \{
58    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i = 0;
59    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = 0;
60 
61    \textcolor{comment}{//Parse input name}
62    \textcolor{keywordflow}{while}(1)
63    \{
64       \textcolor{comment}{//End of string detected?}
65       \textcolor{keywordflow}{if}(src[i] == \textcolor{charliteral}{'\(\backslash\)0'})
66       \{
67          \textcolor{comment}{//Check label length}
68          \textcolor{keywordflow}{if}(i < 1 || i > \hyperlink{dns__common_8h_ac53ada4ab53522bbe32debe54b9141c6}{DNS\_LABEL\_MAX\_SIZE})
69             \textcolor{keywordflow}{return} 0;
70 
71          \textcolor{comment}{//Save label length}
72          \textcolor{keywordflow}{if}(dest != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
73          \{
74             dest[0] = i;
75             dest[i + 1] = 0;
76          \}
77 
78          \textcolor{comment}{//Adjust the length of the resulting string}
79          length += i + 2;
80 
81          \textcolor{comment}{//Stop parsing the input string}
82          \textcolor{keywordflow}{return} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
83       \}
84       \textcolor{comment}{//Separator detected?}
85       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(src[i] == \textcolor{charliteral}{'.'})
86       \{
87          \textcolor{comment}{//Check label length}
88          \textcolor{keywordflow}{if}(i < 1 || i > DNS\_LABEL\_MAX\_SIZE)
89             \textcolor{keywordflow}{return} 0;
90 
91          \textcolor{comment}{//Save label length}
92          \textcolor{keywordflow}{if}(dest != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
93             dest[0] = i;
94 
95          \textcolor{comment}{//Adjust the length of the resulting string}
96          length += i + 1;
97 
98          \textcolor{comment}{//Advance write pointer}
99          \textcolor{keywordflow}{if}(dest != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
100             dest += i + 1;
101 
102          \textcolor{comment}{//Prepare to decode the next label}
103          src += i + 1;
104          i = 0;
105       \}
106       \textcolor{comment}{//Any other character?}
107       \textcolor{keywordflow}{else}
108       \{
109          \textcolor{comment}{//Copy current character}
110          \textcolor{keywordflow}{if}(dest != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
111             dest[i + 1] = src[i];
112 
113          \textcolor{comment}{//Point to the next character}
114          i++;
115       \}
116    \}
117 \}
\end{DoxyCode}
\mbox{\Hypertarget{dns__common_8c_a6a5df1aead8f61467e9bf5e739ea5de0}\label{dns__common_8c_a6a5df1aead8f61467e9bf5e739ea5de0}} 
\index{dns\+\_\+common.\+c@{dns\+\_\+common.\+c}!dns\+Parse\+Name@{dns\+Parse\+Name}}
\index{dns\+Parse\+Name@{dns\+Parse\+Name}!dns\+\_\+common.\+c@{dns\+\_\+common.\+c}}
\subsubsection{\texorpdfstring{dns\+Parse\+Name()}{dnsParseName()}}
{\footnotesize\ttfamily size\+\_\+t dns\+Parse\+Name (\begin{DoxyParamCaption}\item[{const \hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{Dns\+Header} $\ast$}]{message,  }\item[{size\+\_\+t}]{length,  }\item[{size\+\_\+t}]{pos,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{dest,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{level }\end{DoxyParamCaption})}



Decode a domain name that uses the D\+NS name encoding. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Pointer to the D\+NS message \\
\hline
\mbox{\tt in}  & {\em length} & Length of the D\+NS message \\
\hline
\mbox{\tt in}  & {\em pos} & Offset of the name to decode \\
\hline
\mbox{\tt out}  & {\em dest} & Pointer to the decoded name (optional) \\
\hline
\mbox{\tt in}  & {\em level} & Current level of recursion \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The position of the resource record that immediately follows the domain name 
\end{DoxyReturn}


Definition at line 130 of file dns\+\_\+common.\+c.


\begin{DoxyCode}
132 \{
133    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
134    \textcolor{keywordtype}{size\_t} \hyperlink{icmp_8h_a7d569b4cae06fc4e5b219d6359d5b66b}{pointer};
135    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *src;
136 
137    \textcolor{comment}{//Recursion limit exceeded?}
138    \textcolor{keywordflow}{if}(\hyperlink{tls_8h_abbb6c7c49508c1ac374683f2d1159e08}{level} >= \hyperlink{dns__common_8h_ad7c564a6c097ccf95320ec6c83e55751}{DNS\_NAME\_MAX\_RECURSION})
139       \textcolor{keywordflow}{return} 0;
140 
141    \textcolor{comment}{//Cast the input DNS message to byte array}
142    src = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
143 
144    \textcolor{comment}{//Parse encoded domain name}
145    \textcolor{keywordflow}{while}(pos < \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length})
146    \{
147       \textcolor{comment}{//End marker found?}
148       \textcolor{keywordflow}{if}(src[pos] == 0)
149       \{
150          \textcolor{comment}{//Properly terminate the string}
151          \textcolor{keywordflow}{if}(dest != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
152             *dest = \textcolor{charliteral}{'\(\backslash\)0'};
153 
154          \textcolor{comment}{//Return the position of the resource record that}
155          \textcolor{comment}{//is immediately following the domain name}
156          \textcolor{keywordflow}{return} (pos + 1);
157       \}
158       \textcolor{comment}{//Compression tag found?}
159       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(src[pos] >= \hyperlink{dns__common_8h_ab8e2a0ad5aad0d460862627ecee69fdb}{DNS\_COMPRESSION\_TAG})
160       \{
161          \textcolor{comment}{//Malformed DNS message?}
162          \textcolor{keywordflow}{if}((pos + 1) >= \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length})
163             \textcolor{keywordflow}{return} 0;
164 
165          \textcolor{comment}{//Read the most significant byte of the pointer}
166          pointer = (src[pos] & ~\hyperlink{dns__common_8h_ab8e2a0ad5aad0d460862627ecee69fdb}{DNS\_COMPRESSION\_TAG}) << 8;
167          \textcolor{comment}{//Read the least significant byte of the pointer}
168          pointer |= src[pos + 1];
169 
170          \textcolor{comment}{//Decode the remaining part of the domain name}
171          \textcolor{keywordflow}{if}(!\hyperlink{dns__common_8c_a6a5df1aead8f61467e9bf5e739ea5de0}{dnsParseName}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, pointer, dest, 
      \hyperlink{tls_8h_abbb6c7c49508c1ac374683f2d1159e08}{level} + 1))
172          \{
173             \textcolor{comment}{//Domain name decoding failed}
174             \textcolor{keywordflow}{return} 0;
175          \}
176 
177          \textcolor{comment}{//Return the position of the resource record that}
178          \textcolor{comment}{//is immediately following the domain name}
179          \textcolor{keywordflow}{return} (pos + 2);
180       \}
181       \textcolor{comment}{//Valid label length?}
182       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(src[pos] < \hyperlink{dns__common_8h_ac53ada4ab53522bbe32debe54b9141c6}{DNS\_LABEL\_MAX\_SIZE})
183       \{
184          \textcolor{comment}{//Get the length of the current label}
185          n = src[pos++];
186 
187          \textcolor{comment}{//Malformed DNS message?}
188          \textcolor{keywordflow}{if}((pos + n) > \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length})
189             \textcolor{keywordflow}{return} 0;
190 
191          \textcolor{comment}{//The last parameter is optional}
192          \textcolor{keywordflow}{if}(dest != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
193          \{
194             \textcolor{comment}{//Copy current label}
195             memcpy(dest, src + pos, n);
196 
197             \textcolor{comment}{//Advance read pointer}
198             pos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
199             \textcolor{comment}{//Advance write pointer}
200             dest += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
201 
202             \textcolor{comment}{//Append a separator if necessary}
203             \textcolor{keywordflow}{if}(pos < \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} && src[pos] != \textcolor{charliteral}{'\(\backslash\)0'})
204                *(dest++) = \textcolor{charliteral}{'.'};
205          \}
206          \textcolor{keywordflow}{else}
207          \{
208             \textcolor{comment}{//Advance read pointer}
209             pos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
210          \}
211       \}
212       \textcolor{comment}{//Invalid label length?}
213       \textcolor{keywordflow}{else}
214       \{
215          \textcolor{comment}{//Properly terminate the string}
216          \textcolor{keywordflow}{if}(dest != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
217             *dest = \textcolor{charliteral}{'\(\backslash\)0'};
218          \textcolor{comment}{//Domain name decoding failed}
219          \textcolor{keywordflow}{return} 0;
220       \}
221    \}
222 
223    \textcolor{comment}{//Domain name decoding failed}
224    \textcolor{keywordflow}{return} 0;
225 \}
\end{DoxyCode}
