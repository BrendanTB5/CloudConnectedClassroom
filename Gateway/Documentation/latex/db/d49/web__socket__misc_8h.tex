\hypertarget{web__socket__misc_8h}{}\section{cyclone\+\_\+tcp/web\+\_\+socket/web\+\_\+socket\+\_\+misc.h File Reference}
\label{web__socket__misc_8h}\index{cyclone\+\_\+tcp/web\+\_\+socket/web\+\_\+socket\+\_\+misc.\+h@{cyclone\+\_\+tcp/web\+\_\+socket/web\+\_\+socket\+\_\+misc.\+h}}


Helper functions for Web\+Sockets.  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}web\+\_\+socket/web\+\_\+socket.\+h\char`\"{}}\newline
\subsection*{Classes}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structWebSocketStatusCodeDesc}{Web\+Socket\+Status\+Code\+Desc}
\begin{DoxyCompactList}\small\item\em H\+T\+TP status code. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{web__socket__misc_8h_a2950d387e998381f3aab0031a3e13004}{web\+Socket\+Change\+State} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket, \hyperlink{web__socket_8h_a84047dc3e004de841d87c90be9dcd0f0}{Web\+Socket\+State} new\+State)
\begin{DoxyCompactList}\small\item\em Update Web\+Socket state. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_a58c11ba38cafb8acad6b67e587a15839}{web\+Socket\+Parse\+Handshake} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket)
\begin{DoxyCompactList}\small\item\em Parse client or server handshake. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_a58b4f89bc374764f3c156ec85abd3201}{web\+Socket\+Parse\+Request\+Line} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$line)
\begin{DoxyCompactList}\small\item\em Parse the Request-\/\+Line of the client\textquotesingle{}s handshake. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_a2ddaa8a6db8b70f5f3cf8111cb94604a}{web\+Socket\+Parse\+Status\+Line} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$line)
\begin{DoxyCompactList}\small\item\em Parse the Status-\/\+Line of the server\textquotesingle{}s handshake. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_af754c27d8a6c71cceff96f4d9d50a2d7}{web\+Socket\+Parse\+Header\+Field} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$line)
\begin{DoxyCompactList}\small\item\em Parse a header field. \end{DoxyCompactList}\item 
void \hyperlink{web__socket__misc_8h_abdf93eb49e486cfb74205f171cdcef37}{web\+Socket\+Parse\+Connection\+Field} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$\hyperlink{chap_8h_adfa040d04d16520129a735fff8fb1628}{value})
\begin{DoxyCompactList}\small\item\em Parse Connection header field. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_aa15e411e1187dac7e519d9f57e250663}{web\+Socket\+Format\+Client\+Handshake} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} server\+Port)
\begin{DoxyCompactList}\small\item\em Format client\textquotesingle{}s handshake. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_a5514a69c87c82c3c6d3536998e052086}{web\+Socket\+Format\+Server\+Handshake} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket)
\begin{DoxyCompactList}\small\item\em Format server\textquotesingle{}s handshake. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_a6bf091f9d776b556c82d3a5e1cfc8a83}{web\+Socket\+Format\+Error\+Response} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{status\+Code}, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Format H\+T\+TP error response. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_ad7406f924eb34b3a80785dc434ceaf7c}{web\+Socket\+Verify\+Client\+Handshake} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket)
\begin{DoxyCompactList}\small\item\em Verify client\textquotesingle{}s handshake. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_a4b7ac6a29fc417f978a8b2a98e34519a}{web\+Socket\+Verify\+Server\+Handshake} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket)
\begin{DoxyCompactList}\small\item\em Verify server\textquotesingle{}s handshake. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_a0f5423d5e539eb83f757b8b08c2554d7}{web\+Socket\+Generate\+Client\+Key} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket)
\begin{DoxyCompactList}\small\item\em Generate client\textquotesingle{}s key. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_ab04656395be442e453689fe5b009512f}{web\+Socket\+Generate\+Server\+Key} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket)
\begin{DoxyCompactList}\small\item\em Generate server\textquotesingle{}s key. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_a048d6225a8694c41679c280211d983e2}{web\+Socket\+Verify\+Client\+Key} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket)
\begin{DoxyCompactList}\small\item\em Verify client\textquotesingle{}s key. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_a744e26069ab68cf2f40650e8ebb78f44}{web\+Socket\+Verify\+Server\+Key} (\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$web\+Socket)
\begin{DoxyCompactList}\small\item\em Verify server\textquotesingle{}s key. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} \hyperlink{web__socket__misc_8h_a4a58dbe97bf34442601492e7e227a093}{web\+Socket\+Check\+Status\+Code} (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{status\+Code})
\begin{DoxyCompactList}\small\item\em Check whether a status code is valid. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{web__socket__misc_8h_a7bf5ab55037149f9b471ae2a93b25796}{web\+Socket\+Decode\+Percent\+Encoded\+String} (const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$input, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$output, size\+\_\+t output\+Size)
\begin{DoxyCompactList}\small\item\em Decode a percent-\/encoded string. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} \hyperlink{web__socket__misc_8h_af1a30f65aca1d139d377ae373eead15c}{web\+Socket\+Check\+Utf8\+Stream} (\hyperlink{structWebSocketUtf8Context}{Web\+Socket\+Utf8\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, size\+\_\+t remaining)
\begin{DoxyCompactList}\small\item\em Check whether a an U\+T\+F-\/8 stream is valid. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Helper functions for Web\+Sockets. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Function Documentation}
\mbox{\Hypertarget{web__socket__misc_8h_a2950d387e998381f3aab0031a3e13004}\label{web__socket__misc_8h_a2950d387e998381f3aab0031a3e13004}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Change\+State@{web\+Socket\+Change\+State}}
\index{web\+Socket\+Change\+State@{web\+Socket\+Change\+State}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Change\+State()}{webSocketChangeState()}}
{\footnotesize\ttfamily void web\+Socket\+Change\+State (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket,  }\item[{\hyperlink{web__socket_8h_a84047dc3e004de841d87c90be9dcd0f0}{Web\+Socket\+State}}]{new\+State }\end{DoxyParamCaption})}



Update Web\+Socket state. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\mbox{\tt in}  & {\em new\+State} & New state to switch to \\
\hline
\end{DoxyParams}


Definition at line 88 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
89 \{
90    \textcolor{comment}{//Switch to the new state}
91    webSocket->state = newState;
92    \textcolor{comment}{//Save current time;}
93    webSocket->timestamp = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
94 
95    \textcolor{comment}{//Reset sub-state}
96    webSocket->txContext.state = \hyperlink{web__socket_8h_add467139cdc2100a7640faa4fb6c36d7a94a204ec550f4e655177970aeaf89306}{WS\_SUB\_STATE\_INIT};
97    webSocket->rxContext.state = \hyperlink{web__socket_8h_add467139cdc2100a7640faa4fb6c36d7a94a204ec550f4e655177970aeaf89306}{WS\_SUB\_STATE\_INIT};
98 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_a4a58dbe97bf34442601492e7e227a093}\label{web__socket__misc_8h_a4a58dbe97bf34442601492e7e227a093}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Check\+Status\+Code@{web\+Socket\+Check\+Status\+Code}}
\index{web\+Socket\+Check\+Status\+Code@{web\+Socket\+Check\+Status\+Code}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Check\+Status\+Code()}{webSocketCheckStatusCode()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} web\+Socket\+Check\+Status\+Code (\begin{DoxyParamCaption}\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{status\+Code }\end{DoxyParamCaption})}



Check whether a status code is valid. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em status\+Code} & Status code \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The function returns T\+R\+UE is the specified status code is valid. Otherwise, F\+A\+L\+SE is returned 
\end{DoxyReturn}


Definition at line 1140 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
1141 \{
1142    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} valid;
1143 
1144    \textcolor{comment}{//Check status code}
1145    \textcolor{keywordflow}{if}(\hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode} == \hyperlink{web__socket_8h_acd8f55557f218580a4048bba2d0c5192afa052f8cdfa3f02fd4a0700321f66021}{WS\_STATUS\_CODE\_NORMAL\_CLOSURE} ||
1146       \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode} == \hyperlink{web__socket_8h_acd8f55557f218580a4048bba2d0c5192a97fbce392e2d9fd525f741ba0577df3f}{WS\_STATUS\_CODE\_GOING\_AWAY} ||
1147       \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode} == \hyperlink{web__socket_8h_acd8f55557f218580a4048bba2d0c5192a43a574a1eab5c8d022034a5e356ad27c}{WS\_STATUS\_CODE\_PROTOCOL\_ERROR} ||
1148       \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode} == \hyperlink{web__socket_8h_acd8f55557f218580a4048bba2d0c5192af653d00c4d55a84e3a16b20f29d79197}{WS\_STATUS\_CODE\_UNSUPPORTED\_DATA} ||
1149       \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode} == \hyperlink{web__socket_8h_acd8f55557f218580a4048bba2d0c5192abd132bf158d0fa6b7dbf2f06f4caa99d}{WS\_STATUS\_CODE\_INVALID\_PAYLOAD\_DATA} ||
1150       \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode} == \hyperlink{web__socket_8h_acd8f55557f218580a4048bba2d0c5192a0c9f05bfdebc75c106fe6d5dc7d2bb93}{WS\_STATUS\_CODE\_POLICY\_VIOLATION} ||
1151       \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode} == \hyperlink{web__socket_8h_acd8f55557f218580a4048bba2d0c5192af7c887bd2638269ce5f50c25819fc913}{WS\_STATUS\_CODE\_MESSAGE\_TOO\_BIG} ||
1152       \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode} == \hyperlink{web__socket_8h_acd8f55557f218580a4048bba2d0c5192aefddcb5933804a705a4fbd21bebc4788}{WS\_STATUS\_CODE\_MANDATORY\_EXT} ||
1153       \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode} == \hyperlink{web__socket_8h_acd8f55557f218580a4048bba2d0c5192a29c02976289b786b18e6bd88f3f30d5c}{WS\_STATUS\_CODE\_INTERNAL\_ERROR})
1154    \{
1155       valid = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1156    \}
1157    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode} >= 3000)
1158    \{
1159       valid = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1160    \}
1161    \textcolor{keywordflow}{else}
1162    \{
1163       valid = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1164    \}
1165 
1166    \textcolor{comment}{//The function returns TRUE is the specified status code is valid}
1167    \textcolor{keywordflow}{return} valid;
1168 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_af1a30f65aca1d139d377ae373eead15c}\label{web__socket__misc_8h_af1a30f65aca1d139d377ae373eead15c}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Check\+Utf8\+Stream@{web\+Socket\+Check\+Utf8\+Stream}}
\index{web\+Socket\+Check\+Utf8\+Stream@{web\+Socket\+Check\+Utf8\+Stream}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Check\+Utf8\+Stream()}{webSocketCheckUtf8Stream()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} web\+Socket\+Check\+Utf8\+Stream (\begin{DoxyParamCaption}\item[{\hyperlink{structWebSocketUtf8Context}{Web\+Socket\+Utf8\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{length,  }\item[{size\+\_\+t}]{remaining }\end{DoxyParamCaption})}



Check whether a an U\+T\+F-\/8 stream is valid. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & U\+T\+F-\/8 decoding context \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to the chunk of data to be processed \\
\hline
\mbox{\tt in}  & {\em length} & Data chunk length \\
\hline
\mbox{\tt in}  & {\em remaining} & number of remaining bytes in the U\+T\+F-\/8 stream \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The function returns T\+R\+UE is the specified U\+T\+F-\/8 stream is valid. Otherwise, F\+A\+L\+SE is returned 
\end{DoxyReturn}


Definition at line 1241 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
1243 \{
1244    \textcolor{keywordtype}{size\_t} i;
1245    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} valid;
1246 
1247    \textcolor{comment}{//Initialize flag}
1248    valid = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1249 
1250    \textcolor{comment}{//Interpret the byte stream as UTF-8}
1251    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} && valid; i++)
1252    \{
1253       \textcolor{comment}{//Leading or continuation byte?}
1254       \textcolor{keywordflow}{if}(context->\hyperlink{structWebSocketUtf8Context_a8a4c6d59da995f7f9e03da5a8fe3634e}{utf8CharIndex} == 0)
1255       \{
1256          \textcolor{comment}{//7-bit code point?}
1257          \textcolor{keywordflow}{if}((\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i] & 0x80) == 0x00)
1258          \{
1259             \textcolor{comment}{//The code point consist of a single byte}
1260             context->\hyperlink{structWebSocketUtf8Context_a4a16550670061f8c363d4edb044238d0}{utf8CharSize} = 1;
1261             \textcolor{comment}{//Decode the first byte of the sequence}
1262             context->\hyperlink{structWebSocketUtf8Context_a9b49b73c1b03907044863848e71fe3d0}{utf8CodePoint} = \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i] & 0x7F;
1263          \}
1264          \textcolor{comment}{//11-bit code point?}
1265          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}((\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i] & 0xE0) == 0xC0)
1266          \{
1267             \textcolor{comment}{//The code point consist of a 2 bytes}
1268             context->\hyperlink{structWebSocketUtf8Context_a4a16550670061f8c363d4edb044238d0}{utf8CharSize} = 2;
1269             \textcolor{comment}{//Decode the first byte of the sequence}
1270             context->\hyperlink{structWebSocketUtf8Context_a9b49b73c1b03907044863848e71fe3d0}{utf8CodePoint} = (\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i] & 0x1F) << 6;
1271          \}
1272          \textcolor{comment}{//16-bit code point?}
1273          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}((\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i] & 0xF0) == 0xE0)
1274          \{
1275             \textcolor{comment}{//The code point consist of a 3 bytes}
1276             context->\hyperlink{structWebSocketUtf8Context_a4a16550670061f8c363d4edb044238d0}{utf8CharSize} = 3;
1277             \textcolor{comment}{//Decode the first byte of the sequence}
1278             context->\hyperlink{structWebSocketUtf8Context_a9b49b73c1b03907044863848e71fe3d0}{utf8CodePoint} = (\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i] & 0x0F) << 12;
1279          \}
1280          \textcolor{comment}{//21-bit code point?}
1281          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}((\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i] & 0xF8) == 0xF0)
1282          \{
1283             \textcolor{comment}{//The code point consist of a 3 bytes}
1284             context->\hyperlink{structWebSocketUtf8Context_a4a16550670061f8c363d4edb044238d0}{utf8CharSize} = 4;
1285             \textcolor{comment}{//Decode the first byte of the sequence}
1286             context->\hyperlink{structWebSocketUtf8Context_a9b49b73c1b03907044863848e71fe3d0}{utf8CodePoint} = (\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i] & 0x07) << 18;
1287          \}
1288          \textcolor{keywordflow}{else}
1289          \{
1290             \textcolor{comment}{//The UTF-8 stream is not valid}
1291             valid = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1292          \}
1293 
1294          \textcolor{comment}{//This test only applies to frames that are not fragmented}
1295          \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} <= remaining)
1296          \{
1297             \textcolor{comment}{//Make sure the UTF-8 stream is properly terminated}
1298             \textcolor{keywordflow}{if}((i + context->\hyperlink{structWebSocketUtf8Context_a4a16550670061f8c363d4edb044238d0}{utf8CharSize}) > remaining)
1299             \{
1300                \textcolor{comment}{//The UTF-8 stream is not valid}
1301                valid = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1302             \}
1303          \}
1304 
1305          \textcolor{comment}{//Decode the next byte of the sequence}
1306          context->\hyperlink{structWebSocketUtf8Context_a8a4c6d59da995f7f9e03da5a8fe3634e}{utf8CharIndex} = context->\hyperlink{structWebSocketUtf8Context_a4a16550670061f8c363d4edb044238d0}{utf8CharSize} - 1;
1307       \}
1308       \textcolor{keywordflow}{else}
1309       \{
1310          \textcolor{comment}{//Continuation bytes all have 10 in the high-order position}
1311          \textcolor{keywordflow}{if}((\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i] & 0xC0) == 0x80)
1312          \{
1313             \textcolor{comment}{//Decode the multi-byte sequence}
1314             context->\hyperlink{structWebSocketUtf8Context_a8a4c6d59da995f7f9e03da5a8fe3634e}{utf8CharIndex}--;
1315             \textcolor{comment}{//All continuation bytes contain exactly 6 bits from the code point}
1316             context->\hyperlink{structWebSocketUtf8Context_a9b49b73c1b03907044863848e71fe3d0}{utf8CodePoint} |= (\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i] & 0x3F) << (context->
      \hyperlink{structWebSocketUtf8Context_a8a4c6d59da995f7f9e03da5a8fe3634e}{utf8CharIndex} * 6);
1317 
1318             \textcolor{comment}{//The correct encoding of a code point use only the minimum number}
1319             \textcolor{comment}{//of bytes required to hold the significant bits of the code point}
1320             \textcolor{keywordflow}{if}(context->\hyperlink{structWebSocketUtf8Context_a4a16550670061f8c363d4edb044238d0}{utf8CharSize} == 2)
1321             \{
1322                \textcolor{comment}{//Overlong encoding is not supported}
1323                \textcolor{keywordflow}{if}((context->\hyperlink{structWebSocketUtf8Context_a9b49b73c1b03907044863848e71fe3d0}{utf8CodePoint} & ~0x7F) == 0)
1324                   valid = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1325             \}
1326             \textcolor{keywordflow}{if}(context->\hyperlink{structWebSocketUtf8Context_a4a16550670061f8c363d4edb044238d0}{utf8CharSize} == 3 && context->\hyperlink{structWebSocketUtf8Context_a8a4c6d59da995f7f9e03da5a8fe3634e}{utf8CharIndex} < 2)
1327             \{
1328                \textcolor{comment}{//Overlong encoding is not supported}
1329                \textcolor{keywordflow}{if}((context->\hyperlink{structWebSocketUtf8Context_a9b49b73c1b03907044863848e71fe3d0}{utf8CodePoint} & ~0x7FF) == 0)
1330                   valid = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1331             \}
1332             \textcolor{keywordflow}{if}(context->\hyperlink{structWebSocketUtf8Context_a4a16550670061f8c363d4edb044238d0}{utf8CharSize} == 4 && context->\hyperlink{structWebSocketUtf8Context_a8a4c6d59da995f7f9e03da5a8fe3634e}{utf8CharIndex} < 3)
1333             \{
1334                \textcolor{comment}{//Overlong encoding is not supported}
1335                \textcolor{keywordflow}{if}((context->\hyperlink{structWebSocketUtf8Context_a9b49b73c1b03907044863848e71fe3d0}{utf8CodePoint} & ~0xFFFF) == 0)
1336                   valid = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1337             \}
1338 
1339             \textcolor{comment}{//According to the UTF-8 definition (RFC 3629) the high and low}
1340             \textcolor{comment}{//surrogate halves used by UTF-16 (U+D800 through U+DFFF) are not}
1341             \textcolor{comment}{//legal Unicode values, and their UTF-8 encoding should be treated}
1342             \textcolor{comment}{//as an invalid byte sequence}
1343             \textcolor{keywordflow}{if}(context->\hyperlink{structWebSocketUtf8Context_a9b49b73c1b03907044863848e71fe3d0}{utf8CodePoint} >= 0xD800 && context->
      \hyperlink{structWebSocketUtf8Context_a9b49b73c1b03907044863848e71fe3d0}{utf8CodePoint} < 0xE000)
1344                valid = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1345 
1346             \textcolor{comment}{//Code points greater than U+10FFFF are not valid}
1347             \textcolor{keywordflow}{if}(context->\hyperlink{structWebSocketUtf8Context_a9b49b73c1b03907044863848e71fe3d0}{utf8CodePoint} >= 0x110000)
1348                valid = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1349          \}
1350          \textcolor{keywordflow}{else}
1351          \{
1352             \textcolor{comment}{//The start byte is not followed by enough continuation bytes}
1353             valid = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1354          \}
1355       \}
1356    \}
1357 
1358    \textcolor{comment}{//The function returns TRUE is the specified UTF-8 stream is valid}
1359    \textcolor{keywordflow}{return} valid;
1360 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_a7bf5ab55037149f9b471ae2a93b25796}\label{web__socket__misc_8h_a7bf5ab55037149f9b471ae2a93b25796}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Decode\+Percent\+Encoded\+String@{web\+Socket\+Decode\+Percent\+Encoded\+String}}
\index{web\+Socket\+Decode\+Percent\+Encoded\+String@{web\+Socket\+Decode\+Percent\+Encoded\+String}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Decode\+Percent\+Encoded\+String()}{webSocketDecodePercentEncodedString()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Decode\+Percent\+Encoded\+String (\begin{DoxyParamCaption}\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{input,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{output,  }\item[{size\+\_\+t}]{output\+Size }\end{DoxyParamCaption})}



Decode a percent-\/encoded string. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em input} & N\+U\+L\+L-\/terminated string to be decoded \\
\hline
\mbox{\tt out}  & {\em output} & N\+U\+L\+L-\/terminated string resulting from the decoding process \\
\hline
\mbox{\tt in}  & {\em output\+Size} & Size of the output buffer in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1179 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
1181 \{
1182    \textcolor{keywordtype}{size\_t} i;
1183    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} buffer[3];
1184 
1185    \textcolor{comment}{//Check parameters}
1186    \textcolor{keywordflow}{if}(input == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || output == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1187       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
1188 
1189    \textcolor{comment}{//Decode the percent-encoded string}
1190    \textcolor{keywordflow}{for}(i = 0; *input != \textcolor{charliteral}{'\(\backslash\)0'} && i < outputSize; i++)
1191    \{
1192       \textcolor{comment}{//Check current character}
1193       \textcolor{keywordflow}{if}(*input == \textcolor{charliteral}{'+'})
1194       \{
1195          \textcolor{comment}{//Replace '+' characters with spaces}
1196          output[i] = \textcolor{charliteral}{' '};
1197          \textcolor{comment}{//Advance data pointer}
1198          input++;
1199       \}
1200       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(input[0] == \textcolor{charliteral}{'%'} && input[1] != \textcolor{charliteral}{'\(\backslash\)0'} && input[2] != \textcolor{charliteral}{'\(\backslash\)0'})
1201       \{
1202          \textcolor{comment}{//Process percent-encoded characters}
1203          buffer[0] = input[1];
1204          buffer[1] = input[2];
1205          buffer[2] = \textcolor{charliteral}{'\(\backslash\)0'};
1206          \textcolor{comment}{//String to integer conversion}
1207          output[i] = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) strtoul(buffer, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 16);
1208          \textcolor{comment}{//Advance data pointer}
1209          input += 3;
1210       \}
1211       \textcolor{keywordflow}{else}
1212       \{
1213          \textcolor{comment}{//Copy any other characters}
1214          output[i] = *input;
1215          \textcolor{comment}{//Advance data pointer}
1216          input++;
1217       \}
1218    \}
1219 
1220    \textcolor{comment}{//Check whether the output buffer runs out of space}
1221    \textcolor{keywordflow}{if}(i >= outputSize)
1222       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
1223 
1224    \textcolor{comment}{//Properly terminate the resulting string}
1225    output[i] = \textcolor{charliteral}{'\(\backslash\)0'};
1226    \textcolor{comment}{//Successful processing}
1227    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1228 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_aa15e411e1187dac7e519d9f57e250663}\label{web__socket__misc_8h_aa15e411e1187dac7e519d9f57e250663}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Format\+Client\+Handshake@{web\+Socket\+Format\+Client\+Handshake}}
\index{web\+Socket\+Format\+Client\+Handshake@{web\+Socket\+Format\+Client\+Handshake}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Format\+Client\+Handshake()}{webSocketFormatClientHandshake()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Format\+Client\+Handshake (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{server\+Port }\end{DoxyParamCaption})}



Format client\textquotesingle{}s handshake. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\mbox{\tt in}  & {\em server\+Port} & T\+CP port number used to establish the connection \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 643 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
644 \{
645    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
646    \hyperlink{structWebSocketFrameContext}{WebSocketFrameContext} *txContext;
647 
648    \textcolor{comment}{//Point to the TX context}
649    txContext = &webSocket->txContext;
650    \textcolor{comment}{//Point to the buffer where to format the client's handshake}
651    p = (\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) txContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer};
652 
653    \textcolor{comment}{//The Request-Line begins with a method token, followed by the}
654    \textcolor{comment}{//Request-URI and the protocol version, and ending with CRLF}
655    p += sprintf(p, \textcolor{stringliteral}{"GET %s HTTP/1.1\(\backslash\)r\(\backslash\)n"}, webSocket->uri);
656 
657    \textcolor{comment}{//Add Host header field}
658    \textcolor{keywordflow}{if}(webSocket->host[0] != \textcolor{charliteral}{'\(\backslash\)0'})
659    \{
660       \textcolor{comment}{//The Host header field specifies the Internet host and port number of}
661       \textcolor{comment}{//the resource being requested}
662       p += sprintf(p, \textcolor{stringliteral}{"Host: %s:%d\(\backslash\)r\(\backslash\)n"}, webSocket->host, serverPort);
663    \}
664    \textcolor{keywordflow}{else}
665    \{
666       \textcolor{comment}{//If the requested URI does not include a host name for the service being}
667       \textcolor{comment}{//requested, then the Host header field must be given with an empty value}
668       p += sprintf(p, \textcolor{stringliteral}{"Host:\(\backslash\)r\(\backslash\)n"});
669    \}
670 
671 \textcolor{preprocessor}{#if (WEB\_SOCKET\_BASIC\_AUTH\_SUPPORT == ENABLED || WEB\_SOCKET\_DIGEST\_AUTH\_SUPPORT == ENABLED)}
672    \textcolor{comment}{//Check whether authentication is required}
673    \textcolor{keywordflow}{if}(webSocket->authContext.selectedAuthMode != \hyperlink{web__socket_8h_a2c2f8d99948379e06bb22ea64745ba77a80f1f0d41bcc49cb11c7618551dd0bdf}{WS\_AUTH\_MODE\_NONE})
674    \{
675       \textcolor{comment}{//Add Authorization header field}
676       p += \hyperlink{web__socket__auth_8c_a8adbda0a7e2adcf9aeab2613ac830209}{webSocketAddAuthorizationField}(webSocket, p);
677    \}
678 \textcolor{preprocessor}{#endif}
679 
680    \textcolor{comment}{//Add Origin header field}
681    \textcolor{keywordflow}{if}(webSocket->origin[0] != \textcolor{charliteral}{'\(\backslash\)0'})
682       p += sprintf(p, \textcolor{stringliteral}{"Origin: %s\(\backslash\)r\(\backslash\)n"}, webSocket->origin);
683    \textcolor{keywordflow}{else}
684       p += sprintf(p, \textcolor{stringliteral}{"Origin: null\(\backslash\)r\(\backslash\)n"});
685 
686    \textcolor{comment}{//Add Upgrade header field}
687    p += sprintf(p, \textcolor{stringliteral}{"Upgrade: websocket\(\backslash\)r\(\backslash\)n"});
688    \textcolor{comment}{//Add Connection header field}
689    p += sprintf(p, \textcolor{stringliteral}{"Connection: Upgrade\(\backslash\)r\(\backslash\)n"});
690 
691    \textcolor{comment}{//Add Sec-WebSocket-Protocol header field}
692    \textcolor{keywordflow}{if}(webSocket->subProtocol[0] != \textcolor{charliteral}{'\(\backslash\)0'})
693       p += sprintf(p, \textcolor{stringliteral}{"Sec-WebSocket-Protocol: %s\(\backslash\)r\(\backslash\)n"}, webSocket->subProtocol);
694 
695    \textcolor{comment}{//Add Sec-WebSocket-Key header field}
696    p += sprintf(p, \textcolor{stringliteral}{"Sec-WebSocket-Key: %s\(\backslash\)r\(\backslash\)n"},
697       webSocket->handshakeContext.clientKey);
698 
699    \textcolor{comment}{//Add Sec-WebSocket-Version header field}
700    p += sprintf(p, \textcolor{stringliteral}{"Sec-WebSocket-Version: 13\(\backslash\)r\(\backslash\)n"});
701    \textcolor{comment}{//An empty line indicates the end of the header fields}
702    p += sprintf(p, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
703 
704    \textcolor{comment}{//Debug message}
705    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
706    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"WebSocket: client handshake\(\backslash\)r\(\backslash\)n"});
707    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"%s"}, txContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer});
708 
709    \textcolor{comment}{//Rewind to the beginning of the buffer}
710    txContext->\hyperlink{structWebSocketFrameContext_acad756853cbb653f12d4fd64bbf4cf0a}{bufferPos} = 0;
711    \textcolor{comment}{//Update the number of data buffered but not yet sent}
712    txContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} = strlen((\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) txContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer});
713 
714    \textcolor{comment}{//Successful processing}
715    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
716 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_a6bf091f9d776b556c82d3a5e1cfc8a83}\label{web__socket__misc_8h_a6bf091f9d776b556c82d3a5e1cfc8a83}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Format\+Error\+Response@{web\+Socket\+Format\+Error\+Response}}
\index{web\+Socket\+Format\+Error\+Response@{web\+Socket\+Format\+Error\+Response}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Format\+Error\+Response()}{webSocketFormatErrorResponse()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Format\+Error\+Response (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{status\+Code,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{message }\end{DoxyParamCaption})}



Format H\+T\+TP error response. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\mbox{\tt in}  & {\em status\+Code} & H\+T\+TP status code \\
\hline
\mbox{\tt in}  & {\em message} & User message \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 777 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
779 \{
780    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
781    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
782    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
783    \hyperlink{structWebSocketFrameContext}{WebSocketFrameContext} *txContext;
784 
785    \textcolor{comment}{//HTML response template}
786    \textcolor{keyword}{static} \textcolor{keyword}{const} \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} \textcolor{keyword}{template}[] =
787       \textcolor{stringliteral}{"<!doctype html>\(\backslash\)r\(\backslash\)n"}
788       \textcolor{stringliteral}{"<html>\(\backslash\)r\(\backslash\)n"}
789       \textcolor{stringliteral}{"<head><title>Error %03d</title></head>\(\backslash\)r\(\backslash\)n"}
790       \textcolor{stringliteral}{"<body>\(\backslash\)r\(\backslash\)n"}
791       \textcolor{stringliteral}{"<h2>Error %03d</h2>\(\backslash\)r\(\backslash\)n"}
792       \textcolor{stringliteral}{"<p>%s</p>\(\backslash\)r\(\backslash\)n"}
793       \textcolor{stringliteral}{"</body>\(\backslash\)r\(\backslash\)n"}
794       \textcolor{stringliteral}{"</html>\(\backslash\)r\(\backslash\)n"};
795 
796    \textcolor{comment}{//Point to the TX context}
797    txContext = &webSocket->txContext;
798    \textcolor{comment}{//Point to the buffer where to format the client's handshake}
799    p = (\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) txContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer};
800 
801    \textcolor{comment}{//The first line of a response message is the Status-Line, consisting}
802    \textcolor{comment}{//of the protocol version followed by a numeric status code and its}
803    \textcolor{comment}{//associated textual phrase}
804    p += sprintf(p, \textcolor{stringliteral}{"HTTP/%u.%u %u "}, \hyperlink{os__port_8h_aeb61a4e8fff2f4624a632a3189cbd3a0}{MSB}(webSocket->handshakeContext.version),
805       \hyperlink{os__port_8h_a34a3aa6cbadec6a80ab1eae8efd0083d}{LSB}(webSocket->handshakeContext.version), \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode});
806 
807    \textcolor{comment}{//Retrieve the Reason-Phrase that corresponds to the Status-Code}
808    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{os__port_8h_aa1394a41d43c0f3fd30febe41c7bb340}{arraysize}(\hyperlink{web__socket__misc_8c_a04e5039d83d5ae1e97e6574704a23a4a}{statusCodeList}); i++)
809    \{
810       \textcolor{comment}{//Check the status code}
811       \textcolor{keywordflow}{if}(\hyperlink{web__socket__misc_8c_a04e5039d83d5ae1e97e6574704a23a4a}{statusCodeList}[i].\hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value} == \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode})
812       \{
813          \textcolor{comment}{//Append the textual phrase to the Status-Line}
814          p += sprintf(p, \hyperlink{web__socket__misc_8c_a04e5039d83d5ae1e97e6574704a23a4a}{statusCodeList}[i].\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message});
815          \textcolor{comment}{//Break the loop and continue processing}
816          \textcolor{keywordflow}{break};
817       \}
818    \}
819 
820    \textcolor{comment}{//Properly terminate the Status-Line}
821    p += sprintf(p, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
822 
823    \textcolor{comment}{//Content type}
824    p += sprintf(p, \textcolor{stringliteral}{"Content-Type: %s\(\backslash\)r\(\backslash\)n"}, \textcolor{stringliteral}{"text/html"});
825 
826    \textcolor{comment}{//Compute the length of the response}
827    length = strlen(\textcolor{keyword}{template}) + strlen(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}) - 4;
828    \textcolor{comment}{//Set Content-Length field}
829    p += sprintf(p, \textcolor{stringliteral}{"Content-Length: %"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, length);
830 
831    \textcolor{comment}{//Terminate the header with an empty line}
832    p += sprintf(p, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
833 
834    \textcolor{comment}{//Format HTML response}
835    p += sprintf(p, \textcolor{keyword}{template}, \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode}, \hyperlink{dhcpv6__common_8h_ade31e7fd99344e8c35f2c373af659551}{statusCode}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message});
836 
837    \textcolor{comment}{//Rewind to the beginning of the buffer}
838    txContext->\hyperlink{structWebSocketFrameContext_acad756853cbb653f12d4fd64bbf4cf0a}{bufferPos} = 0;
839    \textcolor{comment}{//Update the number of data buffered but not yet sent}
840    txContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} = strlen((\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) txContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer});
841 
842    \textcolor{comment}{//Successful processing}
843    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
844 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_a5514a69c87c82c3c6d3536998e052086}\label{web__socket__misc_8h_a5514a69c87c82c3c6d3536998e052086}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Format\+Server\+Handshake@{web\+Socket\+Format\+Server\+Handshake}}
\index{web\+Socket\+Format\+Server\+Handshake@{web\+Socket\+Format\+Server\+Handshake}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Format\+Server\+Handshake()}{webSocketFormatServerHandshake()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Format\+Server\+Handshake (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket }\end{DoxyParamCaption})}



Format server\textquotesingle{}s handshake. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 725 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
726 \{
727    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
728    \hyperlink{structWebSocketFrameContext}{WebSocketFrameContext} *txContext;
729 
730    \textcolor{comment}{//Point to the TX context}
731    txContext = &webSocket->txContext;
732    \textcolor{comment}{//Point to the buffer where to format the client's handshake}
733    p = (\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) txContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer};
734 
735    \textcolor{comment}{//The first line is an HTTP Status-Line, with the status code 101}
736    p += sprintf(p, \textcolor{stringliteral}{"HTTP/1.1 101 Switching Protocols\(\backslash\)r\(\backslash\)n"});
737 
738    \textcolor{comment}{//Add Upgrade header field}
739    p += sprintf(p, \textcolor{stringliteral}{"Upgrade: websocket\(\backslash\)r\(\backslash\)n"});
740    \textcolor{comment}{//Add Connection header field}
741    p += sprintf(p, \textcolor{stringliteral}{"Connection: Upgrade\(\backslash\)r\(\backslash\)n"});
742 
743    \textcolor{comment}{//Add Sec-WebSocket-Protocol header field}
744    \textcolor{keywordflow}{if}(webSocket->subProtocol[0] != \textcolor{charliteral}{'\(\backslash\)0'})
745       p += sprintf(p, \textcolor{stringliteral}{"Sec-WebSocket-Protocol: %s\(\backslash\)r\(\backslash\)n"}, webSocket->subProtocol);
746 
747    \textcolor{comment}{//Add Sec-WebSocket-Accept header field}
748    p += sprintf(p, \textcolor{stringliteral}{"Sec-WebSocket-Accept: %s\(\backslash\)r\(\backslash\)n"},
749       webSocket->handshakeContext.serverKey);
750 
751    \textcolor{comment}{//An empty line indicates the end of the header fields}
752    p += sprintf(p, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
753 
754    \textcolor{comment}{//Debug message}
755    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
756    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"WebSocket: server handshake\(\backslash\)r\(\backslash\)n"});
757    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"%s"}, txContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer});
758 
759    \textcolor{comment}{//Rewind to the beginning of the buffer}
760    txContext->\hyperlink{structWebSocketFrameContext_acad756853cbb653f12d4fd64bbf4cf0a}{bufferPos} = 0;
761    \textcolor{comment}{//Update the number of data buffered but not yet sent}
762    txContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} = strlen((\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) txContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer});
763 
764    \textcolor{comment}{//Successful processing}
765    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
766 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_a0f5423d5e539eb83f757b8b08c2554d7}\label{web__socket__misc_8h_a0f5423d5e539eb83f757b8b08c2554d7}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Generate\+Client\+Key@{web\+Socket\+Generate\+Client\+Key}}
\index{web\+Socket\+Generate\+Client\+Key@{web\+Socket\+Generate\+Client\+Key}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Generate\+Client\+Key()}{webSocketGenerateClientKey()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Generate\+Client\+Key (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket }\end{DoxyParamCaption})}



Generate client\textquotesingle{}s key. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 965 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
966 \{
967    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
968    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
969    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} nonce[16];
970    \hyperlink{structWebSocketHandshakeContext}{WebSocketHandshakeContext} *handshakeContext;
971 
972    \textcolor{comment}{//Debug message}
973    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"WebSocket: Generating client's key...\(\backslash\)r\(\backslash\)n"});
974 
975    \textcolor{comment}{//Point to the handshake context}
976    handshakeContext = &webSocket->handshakeContext;
977 
978    \textcolor{comment}{//Make sure that the RNG callback function has been registered}
979    \textcolor{keywordflow}{if}(\hyperlink{web__socket_8c_a40c7da11532d9e76959cdfc8ed692b3c}{webSockRandCallback} == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
980    \{
981       \textcolor{comment}{//A cryptographically strong random number generator}
982       \textcolor{comment}{//must be used to generate the nonce}
983       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca2846b744950d419d058ba0f917caf491}{ERROR\_PRNG\_NOT\_READY};
984    \}
985 
986    \textcolor{comment}{//A nonce must be selected randomly for each connection}
987    error = \hyperlink{web__socket_8c_a40c7da11532d9e76959cdfc8ed692b3c}{webSockRandCallback}(nonce, \textcolor{keyword}{sizeof}(nonce));
988    \textcolor{comment}{//Any error to report?}
989    \textcolor{keywordflow}{if}(error)
990       \textcolor{keywordflow}{return} error;
991 
992    \textcolor{comment}{//Encode the client's key}
993    \hyperlink{base64_8c_a6eb49435a26b3297e611264f6d1cbf5f}{base64Encode}(nonce, \textcolor{keyword}{sizeof}(nonce), handshakeContext->\hyperlink{structWebSocketHandshakeContext_af28fef00979612ccfed3ab93d5da1b38}{clientKey}, &n);
994 
995    \textcolor{comment}{//Debug message}
996    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Client key: %s\(\backslash\)r\(\backslash\)n"}, handshakeContext->\hyperlink{structWebSocketHandshakeContext_af28fef00979612ccfed3ab93d5da1b38}{clientKey});
997 
998    \textcolor{comment}{//Successful processing}
999    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1000 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_ab04656395be442e453689fe5b009512f}\label{web__socket__misc_8h_ab04656395be442e453689fe5b009512f}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Generate\+Server\+Key@{web\+Socket\+Generate\+Server\+Key}}
\index{web\+Socket\+Generate\+Server\+Key@{web\+Socket\+Generate\+Server\+Key}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Generate\+Server\+Key()}{webSocketGenerateServerKey()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Generate\+Server\+Key (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket }\end{DoxyParamCaption})}



Generate server\textquotesingle{}s key. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1009 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
1010 \{
1011    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1012    \hyperlink{structWebSocketHandshakeContext}{WebSocketHandshakeContext} *handshakeContext;
1013    \hyperlink{structSha1Context}{Sha1Context} sha1Context;
1014 
1015    \textcolor{comment}{//Debug message}
1016    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"WebSocket: Generating server's key...\(\backslash\)r\(\backslash\)n"});
1017 
1018    \textcolor{comment}{//Point to the handshake context}
1019    handshakeContext = &webSocket->handshakeContext;
1020 
1021    \textcolor{comment}{//Retrieve the length of the client key}
1022    n = strlen(handshakeContext->\hyperlink{structWebSocketHandshakeContext_af28fef00979612ccfed3ab93d5da1b38}{clientKey});
1023 
1024    \textcolor{comment}{//Concatenate the Sec-WebSocket-Key with the GUID string and digest}
1025    \textcolor{comment}{//the resulting string using SHA-1}
1026    \hyperlink{sha1_8c_ab734cb0e0b67798f5cce1f34419982a3}{sha1Init}(&sha1Context);
1027    \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(&sha1Context, handshakeContext->\hyperlink{structWebSocketHandshakeContext_af28fef00979612ccfed3ab93d5da1b38}{clientKey}, n);
1028    \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(&sha1Context, \hyperlink{web__socket__misc_8c_a0b41bfb3ed9ee18d8d92503907086797}{webSocketGuid}, strlen(
      \hyperlink{web__socket__misc_8c_a0b41bfb3ed9ee18d8d92503907086797}{webSocketGuid}));
1029    \hyperlink{sha1_8c_a7b7d2f57b504df6ed98c27d21c1d7a14}{sha1Final}(&sha1Context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
1030 
1031    \textcolor{comment}{//Encode the result using Base64}
1032    \hyperlink{base64_8c_a6eb49435a26b3297e611264f6d1cbf5f}{base64Encode}(sha1Context.\hyperlink{structSha1Context_aa763a9ba0f9014894b8af6171eaf2a20}{digest}, \hyperlink{sha1_8h_a3ba9296b223f1b3c710d6b812fd860e8}{SHA1\_DIGEST\_SIZE},
1033       handshakeContext->\hyperlink{structWebSocketHandshakeContext_a5539a48778d86216622299eb3f76380b}{serverKey}, &n);
1034 
1035    \textcolor{comment}{//Debug message}
1036    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Server key: %s\(\backslash\)r\(\backslash\)n"}, handshakeContext->\hyperlink{structWebSocketHandshakeContext_a5539a48778d86216622299eb3f76380b}{serverKey});
1037 
1038    \textcolor{comment}{//Successful processing}
1039    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1040 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_abdf93eb49e486cfb74205f171cdcef37}\label{web__socket__misc_8h_abdf93eb49e486cfb74205f171cdcef37}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Parse\+Connection\+Field@{web\+Socket\+Parse\+Connection\+Field}}
\index{web\+Socket\+Parse\+Connection\+Field@{web\+Socket\+Parse\+Connection\+Field}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Parse\+Connection\+Field()}{webSocketParseConnectionField()}}
{\footnotesize\ttfamily void web\+Socket\+Parse\+Connection\+Field (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{value }\end{DoxyParamCaption})}



Parse Connection header field. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\mbox{\tt in}  & {\em value} & N\+U\+L\+L-\/terminated string that contains the value of header field \\
\hline
\end{DoxyParams}


Definition at line 599 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
600 \{
601    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
602    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{coap__common_8h_aaa0137cdddb344591e20a2930a1ba54d}{token};
603 
604    \textcolor{comment}{//Get the first value of the list}
605    token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value}, \textcolor{stringliteral}{","}, &p);
606 
607    \textcolor{comment}{//Parse the comma-separated list}
608    \textcolor{keywordflow}{while}(token != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
609    \{
610       \textcolor{comment}{//Trim whitespace characters}
611       \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value} = \hyperlink{str_8c_ade9441b268416af6b024eb2ba3a5847e}{strTrimWhitespace}(token);
612 
613       \textcolor{comment}{//Check current value}
614       \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(\hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value}, \textcolor{stringliteral}{"keep-alive"}))
615       \{
616          \textcolor{comment}{//The connection is persistent}
617          webSocket->handshakeContext.connectionClose = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
618       \}
619       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(\hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value}, \textcolor{stringliteral}{"close"}))
620       \{
621          \textcolor{comment}{//The connection will be closed after completion of the response}
622          webSocket->handshakeContext.connectionClose = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
623       \}
624       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(\hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value}, \textcolor{stringliteral}{"upgrade"}))
625       \{
626          \textcolor{comment}{//Upgrade the connection}
627          webSocket->handshakeContext.connectionUpgrade = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
628       \}
629 
630       \textcolor{comment}{//Get next value}
631       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{","}, &p);
632    \}
633 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_a58c11ba38cafb8acad6b67e587a15839}\label{web__socket__misc_8h_a58c11ba38cafb8acad6b67e587a15839}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Parse\+Handshake@{web\+Socket\+Parse\+Handshake}}
\index{web\+Socket\+Parse\+Handshake@{web\+Socket\+Parse\+Handshake}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Parse\+Handshake()}{webSocketParseHandshake()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Parse\+Handshake (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket }\end{DoxyParamCaption})}



Parse client or server handshake. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 107 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
108 \{
109    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
110    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
111    \hyperlink{structWebSocketFrameContext}{WebSocketFrameContext} *rxContext;
112 
113    \textcolor{comment}{//Point to the RX context}
114    rxContext = &webSocket->rxContext;
115 
116    \textcolor{comment}{//Initialize status code}
117    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
118 
119    \textcolor{comment}{//Wait for the handshake to complete}
120    \textcolor{keywordflow}{while}(1)
121    \{
122       \textcolor{comment}{//Client or server operation?}
123       \textcolor{keywordflow}{if}(webSocket->endpoint == \hyperlink{web__socket_8h_ae7d51561abe243c4f263d6c7d50699a9aa78fcf3108fe2e0b57f32684e9c76076}{WS\_ENDPOINT\_CLIENT})
124       \{
125          \textcolor{keywordflow}{if}(webSocket->state == \hyperlink{web__socket_8h_a84047dc3e004de841d87c90be9dcd0f0ab0325195f22aca5be7491a425f84808c}{WS\_STATE\_OPEN})
126             \textcolor{keywordflow}{break};
127       \}
128       \textcolor{keywordflow}{else}
129       \{
130          \textcolor{keywordflow}{if}(webSocket->state == \hyperlink{web__socket_8h_a84047dc3e004de841d87c90be9dcd0f0af67b597c54a4b89fc2566c326231aa8b}{WS\_STATE\_SERVER\_HANDSHAKE})
131             \textcolor{keywordflow}{break};
132       \}
133 
134       \textcolor{comment}{//Check current sub-state}
135       \textcolor{keywordflow}{if}(rxContext->\hyperlink{structWebSocketFrameContext_ab89eea5d9b9f9a20fd7675db64016dc0}{state} == \hyperlink{web__socket_8h_add467139cdc2100a7640faa4fb6c36d7a94a204ec550f4e655177970aeaf89306}{WS\_SUB\_STATE\_INIT})
136       \{
137          \textcolor{comment}{//Initialize status code}
138          webSocket->statusCode = \hyperlink{web__socket_8h_acd8f55557f218580a4048bba2d0c5192a7911bd0755c0ff03ee1add8df6ab25ba}{WS\_STATUS\_CODE\_NO\_STATUS\_RCVD};
139 
140          \textcolor{comment}{//Initialize FIN flag}
141          rxContext->\hyperlink{structWebSocketFrameContext_a0ac654d7668a4269ca136460a5361b50}{fin} = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
142 
143          \textcolor{comment}{//Flush the receive buffer}
144          rxContext->\hyperlink{structWebSocketFrameContext_acad756853cbb653f12d4fd64bbf4cf0a}{bufferPos} = 0;
145          rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} = 0;
146 
147          \textcolor{comment}{//Initialize variables}
148          webSocket->handshakeContext.statusCode = 0;
149          webSocket->handshakeContext.upgradeWebSocket = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
150          webSocket->handshakeContext.connectionUpgrade = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
151          webSocket->handshakeContext.connectionClose = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
152          webSocket->handshakeContext.contentLength = 0;
153          webSocket->handshakeContext.closingFrameSent = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
154          webSocket->handshakeContext.closingFrameReceived = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
155 
156 \textcolor{preprocessor}{#if (WEB\_SOCKET\_BASIC\_AUTH\_SUPPORT == ENABLED || WEB\_SOCKET\_DIGEST\_AUTH\_SUPPORT == ENABLED)}
157          webSocket->authContext.requiredAuthMode = \hyperlink{web__socket_8h_a2c2f8d99948379e06bb22ea64745ba77a80f1f0d41bcc49cb11c7618551dd0bdf}{WS\_AUTH\_MODE\_NONE};
158 \textcolor{preprocessor}{#endif}
159 
160 \textcolor{preprocessor}{#if (WEB\_SOCKET\_DIGEST\_AUTH\_SUPPORT == ENABLED)}
161          strcpy(webSocket->authContext.nonce, \textcolor{stringliteral}{""});
162          strcpy(webSocket->authContext.opaque, \textcolor{stringliteral}{""});
163          webSocket->authContext.stale = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
164 \textcolor{preprocessor}{#endif}
165 
166          \textcolor{comment}{//Client or server operation?}
167          \textcolor{keywordflow}{if}(webSocket->endpoint == \hyperlink{web__socket_8h_ae7d51561abe243c4f263d6c7d50699a9aa78fcf3108fe2e0b57f32684e9c76076}{WS\_ENDPOINT\_CLIENT})
168          \{
169             \textcolor{comment}{//Clear server key}
170             strcpy(webSocket->handshakeContext.serverKey, \textcolor{stringliteral}{""});
171 
172             \textcolor{comment}{//Debug message}
173             \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"WebSocket: server handshake\(\backslash\)r\(\backslash\)n"});
174          \}
175          \textcolor{keywordflow}{else}
176          \{
177             \textcolor{comment}{//Clear client key}
178             strcpy(webSocket->handshakeContext.clientKey, \textcolor{stringliteral}{""});
179 
180             \textcolor{comment}{//Debug message}
181             \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"WebSocket: client handshake\(\backslash\)r\(\backslash\)n"});
182          \}
183 
184          \textcolor{comment}{//Decode the leading line}
185          rxContext->\hyperlink{structWebSocketFrameContext_ab89eea5d9b9f9a20fd7675db64016dc0}{state} = \hyperlink{web__socket_8h_add467139cdc2100a7640faa4fb6c36d7a747a95957baf6c56acd5a4a6b662e5ce}{WS\_SUB\_STATE\_HANDSHAKE\_LEADING\_LINE};
186       \}
187       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(rxContext->\hyperlink{structWebSocketFrameContext_ab89eea5d9b9f9a20fd7675db64016dc0}{state} == \hyperlink{web__socket_8h_add467139cdc2100a7640faa4fb6c36d7a747a95957baf6c56acd5a4a6b662e5ce}{WS\_SUB\_STATE\_HANDSHAKE\_LEADING\_LINE}
      )
188       \{
189          \textcolor{comment}{//Check whether more data is required}
190          \textcolor{keywordflow}{if}(rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} < 2)
191          \{
192             \textcolor{comment}{//Limit the number of characters to read at a time}
193             n = \hyperlink{web__socket_8h_a4e6ed74586f83eedc4eae5a079f41050}{WEB\_SOCKET\_BUFFER\_SIZE} - 1 - rxContext->
      \hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen};
194 
195             \textcolor{comment}{//Read data until a CLRF character is encountered}
196             error = \hyperlink{web__socket__transport_8c_a18b5d001e9fd3caae71c20355695e2c4}{webSocketReceiveData}(webSocket, rxContext->
      \hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer} +
197                rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen}, n, &n, \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a8a9906d4aacdf7dd4b7203c86271006b}{SOCKET\_FLAG\_BREAK\_CRLF});
198 
199             \textcolor{comment}{//Update the length of the buffer}
200             rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
201          \}
202          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} >= (\hyperlink{web__socket_8h_a4e6ed74586f83eedc4eae5a079f41050}{WEB\_SOCKET\_BUFFER\_SIZE} - 1))
203          \{
204             \textcolor{comment}{//Report an error}
205             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
206          \}
207          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(strncmp((\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) rxContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer} + rxContext->
      \hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} - 2, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, 2))
208          \{
209             \textcolor{comment}{//Limit the number of characters to read at a time}
210             n = \hyperlink{web__socket_8h_a4e6ed74586f83eedc4eae5a079f41050}{WEB\_SOCKET\_BUFFER\_SIZE} - 1 - rxContext->
      \hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen};
211 
212             \textcolor{comment}{//Read data until a CLRF character is encountered}
213             error = \hyperlink{web__socket__transport_8c_a18b5d001e9fd3caae71c20355695e2c4}{webSocketReceiveData}(webSocket, rxContext->
      \hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer} +
214                rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen}, n, &n, \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a8a9906d4aacdf7dd4b7203c86271006b}{SOCKET\_FLAG\_BREAK\_CRLF});
215 
216             \textcolor{comment}{//Update the length of the buffer}
217             rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
218          \}
219          \textcolor{keywordflow}{else}
220          \{
221             \textcolor{comment}{//Properly terminate the string with a NULL character}
222             rxContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer}[rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen}] = \textcolor{charliteral}{'\(\backslash\)0'};
223 
224             \textcolor{comment}{//Client or server operation?}
225             \textcolor{keywordflow}{if}(webSocket->endpoint == \hyperlink{web__socket_8h_ae7d51561abe243c4f263d6c7d50699a9aa78fcf3108fe2e0b57f32684e9c76076}{WS\_ENDPOINT\_CLIENT})
226             \{
227                \textcolor{comment}{//The leading line from the server follows the Status-Line format}
228                error = \hyperlink{web__socket__misc_8c_a2ddaa8a6db8b70f5f3cf8111cb94604a}{webSocketParseStatusLine}(webSocket, (
      \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) rxContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer});
229             \}
230             \textcolor{keywordflow}{else}
231             \{
232                \textcolor{comment}{//The leading line from the client follows the Request-Line format}
233                error = \hyperlink{web__socket__misc_8c_a58b4f89bc374764f3c156ec85abd3201}{webSocketParseRequestLine}(webSocket, (
      \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) rxContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer});
234             \}
235 
236             \textcolor{comment}{//Flush the receive buffer}
237             rxContext->\hyperlink{structWebSocketFrameContext_acad756853cbb653f12d4fd64bbf4cf0a}{bufferPos} = 0;
238             rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} = 0;
239 
240             \textcolor{comment}{//Parse the header fields of the handshake}
241             rxContext->\hyperlink{structWebSocketFrameContext_ab89eea5d9b9f9a20fd7675db64016dc0}{state} = \hyperlink{web__socket_8h_add467139cdc2100a7640faa4fb6c36d7ae6c7088c37c86cacd2822259d9fcad11}{WS\_SUB\_STATE\_HANDSHAKE\_HEADER\_FIELD};
242          \}
243       \}
244       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(rxContext->\hyperlink{structWebSocketFrameContext_ab89eea5d9b9f9a20fd7675db64016dc0}{state} == \hyperlink{web__socket_8h_add467139cdc2100a7640faa4fb6c36d7ae6c7088c37c86cacd2822259d9fcad11}{WS\_SUB\_STATE\_HANDSHAKE\_HEADER\_FIELD}
      )
245       \{
246          \textcolor{comment}{//Check whether more data is required}
247          \textcolor{keywordflow}{if}(rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} < 2)
248          \{
249             \textcolor{comment}{//Limit the number of characters to read at a time}
250             n = \hyperlink{web__socket_8h_a4e6ed74586f83eedc4eae5a079f41050}{WEB\_SOCKET\_BUFFER\_SIZE} - 1 - rxContext->
      \hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen};
251 
252             \textcolor{comment}{//Read data until a CLRF character is encountered}
253             error = \hyperlink{web__socket__transport_8c_a18b5d001e9fd3caae71c20355695e2c4}{webSocketReceiveData}(webSocket, rxContext->
      \hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer} +
254                rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen}, n, &n, \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a8a9906d4aacdf7dd4b7203c86271006b}{SOCKET\_FLAG\_BREAK\_CRLF});
255 
256             \textcolor{comment}{//Update the length of the buffer}
257             rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
258          \}
259          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} >= (\hyperlink{web__socket_8h_a4e6ed74586f83eedc4eae5a079f41050}{WEB\_SOCKET\_BUFFER\_SIZE} - 1))
260          \{
261             \textcolor{comment}{//Report an error}
262             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
263          \}
264          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(strncmp((\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) rxContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer} + rxContext->
      \hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} - 2, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, 2))
265          \{
266             \textcolor{comment}{//Limit the number of characters to read at a time}
267             n = \hyperlink{web__socket_8h_a4e6ed74586f83eedc4eae5a079f41050}{WEB\_SOCKET\_BUFFER\_SIZE} - 1 - rxContext->
      \hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen};
268 
269             \textcolor{comment}{//Read data until a CLRF character is encountered}
270             error = \hyperlink{web__socket__transport_8c_a18b5d001e9fd3caae71c20355695e2c4}{webSocketReceiveData}(webSocket, rxContext->
      \hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer} +
271                rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen}, n, &n, \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a8a9906d4aacdf7dd4b7203c86271006b}{SOCKET\_FLAG\_BREAK\_CRLF});
272 
273             \textcolor{comment}{//Update the length of the buffer}
274             rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
275          \}
276          \textcolor{keywordflow}{else}
277          \{
278             \textcolor{comment}{//Properly terminate the string with a NULL character}
279             rxContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer}[rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen}] = \textcolor{charliteral}{'\(\backslash\)0'};
280 
281             \textcolor{comment}{//An empty line indicates the end of the header fields}
282             \textcolor{keywordflow}{if}(!strcmp((\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) rxContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer}, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}))
283             \{
284                \textcolor{comment}{//Client or server operation?}
285                \textcolor{keywordflow}{if}(webSocket->endpoint == \hyperlink{web__socket_8h_ae7d51561abe243c4f263d6c7d50699a9aa78fcf3108fe2e0b57f32684e9c76076}{WS\_ENDPOINT\_CLIENT})
286                \{
287                   \textcolor{comment}{//Verify server's handshake}
288                   error = \hyperlink{web__socket__misc_8c_a4b7ac6a29fc417f978a8b2a98e34519a}{webSocketVerifyServerHandshake}(webSocket);
289                \}
290                \textcolor{keywordflow}{else}
291                \{
292                   \textcolor{comment}{//Verify client's handshake}
293                   error = \hyperlink{web__socket__misc_8c_ad7406f924eb34b3a80785dc434ceaf7c}{webSocketVerifyClientHandshake}(webSocket);
294                \}
295             \}
296             \textcolor{keywordflow}{else}
297             \{
298                \textcolor{comment}{//Read the next character to detect if the CRLF is immediately}
299                \textcolor{comment}{//followed by a LWSP character}
300                rxContext->\hyperlink{structWebSocketFrameContext_ab89eea5d9b9f9a20fd7675db64016dc0}{state} = \hyperlink{web__socket_8h_add467139cdc2100a7640faa4fb6c36d7a1c64907f57361f3d97250c8a4b6276be}{WS\_SUB\_STATE\_HANDSHAKE\_LWSP};
301             \}
302          \}
303       \}
304       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(rxContext->\hyperlink{structWebSocketFrameContext_ab89eea5d9b9f9a20fd7675db64016dc0}{state} == \hyperlink{web__socket_8h_add467139cdc2100a7640faa4fb6c36d7a1c64907f57361f3d97250c8a4b6276be}{WS\_SUB\_STATE\_HANDSHAKE\_LWSP})
305       \{
306          \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} nextChar;
307 
308          \textcolor{comment}{//Read the next character}
309          error = \hyperlink{web__socket__transport_8c_a18b5d001e9fd3caae71c20355695e2c4}{webSocketReceiveData}(webSocket, &nextChar, \textcolor{keyword}{sizeof}(
      \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t}), &n, 0);
310 
311          \textcolor{comment}{//Successful read operation?}
312          \textcolor{keywordflow}{if}(!error && n == \textcolor{keyword}{sizeof}(\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t}))
313          \{
314             \textcolor{comment}{//LWSP character found?}
315             \textcolor{keywordflow}{if}(nextChar == \textcolor{charliteral}{' '} || nextChar == \textcolor{charliteral}{'\(\backslash\)t'})
316             \{
317                \textcolor{comment}{//Unfolding is accomplished by regarding CRLF immediately}
318                \textcolor{comment}{//followed by a LWSP as equivalent to the LWSP character}
319                \textcolor{keywordflow}{if}(rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} >= 2)
320                \{
321                   \textcolor{comment}{//Remove trailing CRLF sequence}
322                   rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} -= 2;
323                \}
324 
325                \textcolor{comment}{//The header field spans multiple line}
326                rxContext->\hyperlink{structWebSocketFrameContext_ab89eea5d9b9f9a20fd7675db64016dc0}{state} = \hyperlink{web__socket_8h_add467139cdc2100a7640faa4fb6c36d7ae6c7088c37c86cacd2822259d9fcad11}{WS\_SUB\_STATE\_HANDSHAKE\_HEADER\_FIELD}
      ;
327             \}
328             \textcolor{keywordflow}{else}
329             \{
330                \textcolor{comment}{//Parse header field}
331                error = \hyperlink{web__socket__misc_8c_af754c27d8a6c71cceff96f4d9d50a2d7}{webSocketParseHeaderField}(webSocket, (
      \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) rxContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer});
332 
333                \textcolor{comment}{//Restore the very first character of the header field}
334                rxContext->\hyperlink{structWebSocketFrameContext_a3cec5a6cbb2cf4c3d519ddecae1f4726}{buffer}[0] = nextChar;
335                \textcolor{comment}{//Adjust the length of the receive buffer}
336                rxContext->\hyperlink{structWebSocketFrameContext_ac89d1a88498690e3ae1f39c96182ea19}{bufferLen} = \textcolor{keyword}{sizeof}(\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t});
337 
338                \textcolor{comment}{//Decode the next header field}
339                rxContext->\hyperlink{structWebSocketFrameContext_ab89eea5d9b9f9a20fd7675db64016dc0}{state} = \hyperlink{web__socket_8h_add467139cdc2100a7640faa4fb6c36d7ae6c7088c37c86cacd2822259d9fcad11}{WS\_SUB\_STATE\_HANDSHAKE\_HEADER\_FIELD}
      ;
340             \}
341          \}
342       \}
343       \textcolor{keywordflow}{else}
344       \{
345          \textcolor{comment}{//Invalid state}
346          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
347       \}
348 
349       \textcolor{comment}{//Any error to report?}
350       \textcolor{keywordflow}{if}(error)
351          \textcolor{keywordflow}{break};
352    \}
353 
354    \textcolor{comment}{//Return status code}
355    \textcolor{keywordflow}{return} error;
356 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_af754c27d8a6c71cceff96f4d9d50a2d7}\label{web__socket__misc_8h_af754c27d8a6c71cceff96f4d9d50a2d7}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Parse\+Header\+Field@{web\+Socket\+Parse\+Header\+Field}}
\index{web\+Socket\+Parse\+Header\+Field@{web\+Socket\+Parse\+Header\+Field}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Parse\+Header\+Field()}{webSocketParseHeaderField()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Parse\+Header\+Field (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{line }\end{DoxyParamCaption})}



Parse a header field. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\mbox{\tt in}  & {\em line} & N\+U\+L\+L-\/terminated string that contains the header field \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 512 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
513 \{
514    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *separator;
515    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name};
516    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
517    \hyperlink{structWebSocketHandshakeContext}{WebSocketHandshakeContext} *handshakeContext;
518 
519    \textcolor{comment}{//Point to the handshake context}
520    handshakeContext = &webSocket->handshakeContext;
521 
522    \textcolor{comment}{//Debug message}
523    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"%s"}, line);
524 
525    \textcolor{comment}{//Check whether a separator is present}
526    separator = strchr(line, \textcolor{charliteral}{':'});
527 
528    \textcolor{comment}{//Separator found?}
529    \textcolor{keywordflow}{if}(separator != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
530    \{
531       \textcolor{comment}{//Split the line}
532       *separator = \textcolor{charliteral}{'\(\backslash\)0'};
533 
534       \textcolor{comment}{//Get field name and value}
535       name = \hyperlink{str_8c_ade9441b268416af6b024eb2ba3a5847e}{strTrimWhitespace}(line);
536       value = \hyperlink{str_8c_ade9441b268416af6b024eb2ba3a5847e}{strTrimWhitespace}(separator + 1);
537 
538       \textcolor{comment}{//Upgrade header field found?}
539       \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"Upgrade"}))
540       \{
541          \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(value, \textcolor{stringliteral}{"websocket"}))
542             handshakeContext->\hyperlink{structWebSocketHandshakeContext_afcbf1dd5bbba5e6d6dd08868eadd5626}{upgradeWebSocket} = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
543 
544       \}
545       \textcolor{comment}{//Connection header field found?}
546       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"Connection"}))
547       \{
548          \textcolor{comment}{//Parse Connection header field}
549          \hyperlink{web__socket__misc_8c_abdf93eb49e486cfb74205f171cdcef37}{webSocketParseConnectionField}(webSocket, value);
550       \}
551       \textcolor{comment}{//Sec-WebSocket-Key header field found?}
552       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"Sec-WebSocket-Key"}))
553       \{
554          \textcolor{comment}{//Server operation?}
555          \textcolor{keywordflow}{if}(webSocket->endpoint == \hyperlink{web__socket_8h_ae7d51561abe243c4f263d6c7d50699a9a52543e5816b31e31954fe11186a13d4d}{WS\_ENDPOINT\_SERVER})
556          \{
557             \textcolor{comment}{//Save the contents of the Sec-WebSocket-Key header field}
558             \hyperlink{str_8c_ac10cb0bca1fb0c39b2c765afd068486d}{strSafeCopy}(handshakeContext->\hyperlink{structWebSocketHandshakeContext_af28fef00979612ccfed3ab93d5da1b38}{clientKey}, value,
559                \hyperlink{web__socket_8h_aec52a37b246082418c0b6dbf0235e99d}{WEB\_SOCKET\_CLIENT\_KEY\_SIZE} + 1);
560          \}
561       \}
562       \textcolor{comment}{//Sec-WebSocket-Accept header field found?}
563       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"Sec-WebSocket-Accept"}))
564       \{
565          \textcolor{comment}{//Client operation?}
566          \textcolor{keywordflow}{if}(webSocket->endpoint == \hyperlink{web__socket_8h_ae7d51561abe243c4f263d6c7d50699a9aa78fcf3108fe2e0b57f32684e9c76076}{WS\_ENDPOINT\_CLIENT})
567          \{
568             \textcolor{comment}{//Save the contents of the Sec-WebSocket-Accept header field}
569             \hyperlink{str_8c_ac10cb0bca1fb0c39b2c765afd068486d}{strSafeCopy}(handshakeContext->\hyperlink{structWebSocketHandshakeContext_a5539a48778d86216622299eb3f76380b}{serverKey}, value,
570                \hyperlink{web__socket_8h_ab90bffcb2db9573de4a19252616df227}{WEB\_SOCKET\_SERVER\_KEY\_SIZE} + 1);
571          \}
572       \}
573 \textcolor{preprocessor}{#if (WEB\_SOCKET\_BASIC\_AUTH\_SUPPORT == ENABLED || WEB\_SOCKET\_DIGEST\_AUTH\_SUPPORT == ENABLED)}
574       \textcolor{comment}{//WWW-Authenticate header field found?}
575       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"WWW-Authenticate"}))
576       \{
577          \textcolor{comment}{//Parse WWW-Authenticate header field}
578          \hyperlink{web__socket__auth_8c_af798ae15658d57fb91fcc2dbe5f230de}{webSocketParseAuthenticateField}(webSocket, value);
579       \}
580 \textcolor{preprocessor}{#endif}
581       \textcolor{comment}{//Content-Length header field found?}
582       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"Content-Length"}))
583       \{
584          handshakeContext->\hyperlink{structWebSocketHandshakeContext_a7caaa4546b22dbfdc5bbcca9f3e76c09}{contentLength} = strtoul(value, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
585       \}
586    \}
587 
588    \textcolor{comment}{//Successful processing}
589    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
590 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_a58b4f89bc374764f3c156ec85abd3201}\label{web__socket__misc_8h_a58b4f89bc374764f3c156ec85abd3201}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Parse\+Request\+Line@{web\+Socket\+Parse\+Request\+Line}}
\index{web\+Socket\+Parse\+Request\+Line@{web\+Socket\+Parse\+Request\+Line}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Parse\+Request\+Line()}{webSocketParseRequestLine()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Parse\+Request\+Line (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{line }\end{DoxyParamCaption})}



Parse the Request-\/\+Line of the client\textquotesingle{}s handshake. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\mbox{\tt in}  & {\em line} & N\+U\+L\+L-\/terminated string that contains the Request-\/\+Line \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 366 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
367 \{
368    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
369    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{coap__common_8h_aaa0137cdddb344591e20a2930a1ba54d}{token};
370    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
371    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{md2_8c_adf356ff381033f761b7de5f76e763a45}{s};
372 
373    \textcolor{comment}{//Debug message}
374    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"%s"}, line);
375 
376    \textcolor{comment}{//The Request-Line begins with a method token}
377    token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(line, \textcolor{stringliteral}{" \(\backslash\)r\(\backslash\)n"}, &p);
378    \textcolor{comment}{//Unable to retrieve the method?}
379    \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
380       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
381 
382    \textcolor{comment}{//The method of the request must be GET}
383    \textcolor{keywordflow}{if}(\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(token, \textcolor{stringliteral}{"GET"}))
384       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
385 
386    \textcolor{comment}{//The Request-URI is following the method token}
387    token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" \(\backslash\)r\(\backslash\)n"}, &p);
388    \textcolor{comment}{//Unable to retrieve the Request-URI?}
389    \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
390       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
391 
392    \textcolor{comment}{//Check whether a query string is present}
393    s = strchr(token, \textcolor{charliteral}{'?'});
394 
395    \textcolor{comment}{//Query string found?}
396    \textcolor{keywordflow}{if}(s != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
397    \{
398       \textcolor{comment}{//Split the string}
399       *s = \textcolor{charliteral}{'\(\backslash\)0'};
400 
401       \textcolor{comment}{//Save the Request-URI}
402       error = \hyperlink{web__socket__misc_8c_a7bf5ab55037149f9b471ae2a93b25796}{webSocketDecodePercentEncodedString}(token,
403          webSocket->uri, \hyperlink{web__socket_8h_ace530d4ae5bedbea825d9ac103cf2741}{WEB\_SOCKET\_URI\_MAX\_LEN});
404       \textcolor{comment}{//Any error to report?}
405       \textcolor{keywordflow}{if}(error)
406          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
407 
408       \textcolor{comment}{//Check the length of the query string}
409       \textcolor{keywordflow}{if}(strlen(s + 1) > \hyperlink{web__socket_8h_aa438876c03fc0dc137c3aaedc4a3071d}{WEB\_SOCKET\_QUERY\_STRING\_MAX\_LEN})
410          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
411 
412       \textcolor{comment}{//Save the query string}
413       strcpy(webSocket->queryString, s + 1);
414    \}
415    \textcolor{keywordflow}{else}
416    \{
417       \textcolor{comment}{//Save the Request-URI}
418       error = \hyperlink{web__socket__misc_8c_a7bf5ab55037149f9b471ae2a93b25796}{webSocketDecodePercentEncodedString}(token,
419          webSocket->uri, \hyperlink{web__socket_8h_ace530d4ae5bedbea825d9ac103cf2741}{WEB\_SOCKET\_URI\_MAX\_LEN});
420       \textcolor{comment}{//Any error to report?}
421       \textcolor{keywordflow}{if}(error)
422          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
423 
424       \textcolor{comment}{//No query string}
425       webSocket->queryString[0] = \textcolor{charliteral}{'\(\backslash\)0'};
426    \}
427 
428    \textcolor{comment}{//The protocol version is following the Request-URI}
429    token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" \(\backslash\)r\(\backslash\)n"}, &p);
430 
431    \textcolor{comment}{//HTTP version 0.9?}
432    \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
433    \{
434       \textcolor{comment}{//Save version number}
435       webSocket->handshakeContext.version = \hyperlink{web__socket_8h_a1c876c89b2d8e417e1a99a6dbcb1bfacaa86a415cd171b6c10c3a1fad20c166a3}{WS\_HTTP\_VERSION\_0\_9};
436       \textcolor{comment}{//Persistent connections are not supported}
437       webSocket->handshakeContext.connectionClose = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
438    \}
439    \textcolor{comment}{//HTTP version 1.0?}
440    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(token, \textcolor{stringliteral}{"HTTP/1.0"}))
441    \{
442       \textcolor{comment}{//Save version number}
443       webSocket->handshakeContext.version = \hyperlink{web__socket_8h_a1c876c89b2d8e417e1a99a6dbcb1bfacafeaff3b6056dc9cbbf03d1a6a8cf1eba}{WS\_HTTP\_VERSION\_1\_0};
444       \textcolor{comment}{//By default connections are not persistent}
445       webSocket->handshakeContext.connectionClose = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
446    \}
447    \textcolor{comment}{//HTTP version 1.1?}
448    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(token, \textcolor{stringliteral}{"HTTP/1.1"}))
449    \{
450       \textcolor{comment}{//Save version number}
451       webSocket->handshakeContext.version = \hyperlink{web__socket_8h_a1c876c89b2d8e417e1a99a6dbcb1bfacafdefe3d8ccc39d6c50065d47b1c32b6a}{WS\_HTTP\_VERSION\_1\_1};
452       \textcolor{comment}{//HTTP 1.1 makes persistent connections the default}
453       webSocket->handshakeContext.connectionClose = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
454    \}
455    \textcolor{comment}{//HTTP version not supported?}
456    \textcolor{keywordflow}{else}
457    \{
458       \textcolor{comment}{//Report an error}
459       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
460    \}
461 
462    \textcolor{comment}{//Successful processing}
463    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
464 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_a2ddaa8a6db8b70f5f3cf8111cb94604a}\label{web__socket__misc_8h_a2ddaa8a6db8b70f5f3cf8111cb94604a}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Parse\+Status\+Line@{web\+Socket\+Parse\+Status\+Line}}
\index{web\+Socket\+Parse\+Status\+Line@{web\+Socket\+Parse\+Status\+Line}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Parse\+Status\+Line()}{webSocketParseStatusLine()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Parse\+Status\+Line (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{line }\end{DoxyParamCaption})}



Parse the Status-\/\+Line of the server\textquotesingle{}s handshake. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\mbox{\tt in}  & {\em line} & N\+U\+L\+L-\/terminated string that contains the Status-\/\+Line \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 474 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
475 \{
476    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
477    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{coap__common_8h_aaa0137cdddb344591e20a2930a1ba54d}{token};
478 
479    \textcolor{comment}{//Debug message}
480    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"%s"}, line);
481 
482    \textcolor{comment}{//Retrieve the HTTP-Version field}
483    token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(line, \textcolor{stringliteral}{" "}, &p);
484    \textcolor{comment}{//Any parsing error?}
485    \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
486       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
487 
488    \textcolor{comment}{//Retrieve the Status-Code field}
489    token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" "}, &p);
490    \textcolor{comment}{//Any parsing error?}
491    \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
492       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
493 
494    \textcolor{comment}{//Convert the status code}
495    webSocket->handshakeContext.statusCode = strtoul(token, &p, 10);
496    \textcolor{comment}{//Any parsing error?}
497    \textcolor{keywordflow}{if}(*p != \textcolor{charliteral}{'\(\backslash\)0'})
498       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
499 
500    \textcolor{comment}{//Successful processing}
501    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
502 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_ad7406f924eb34b3a80785dc434ceaf7c}\label{web__socket__misc_8h_ad7406f924eb34b3a80785dc434ceaf7c}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Verify\+Client\+Handshake@{web\+Socket\+Verify\+Client\+Handshake}}
\index{web\+Socket\+Verify\+Client\+Handshake@{web\+Socket\+Verify\+Client\+Handshake}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Verify\+Client\+Handshake()}{webSocketVerifyClientHandshake()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Verify\+Client\+Handshake (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket }\end{DoxyParamCaption})}



Verify client\textquotesingle{}s handshake. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 853 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
854 \{
855    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
856    \hyperlink{structWebSocketHandshakeContext}{WebSocketHandshakeContext} *handshakeContext;
857 
858    \textcolor{comment}{//Debug message}
859    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"WebSocket: verifying client handshake\(\backslash\)r\(\backslash\)n"});
860 
861    \textcolor{comment}{//Point to the handshake context}
862    handshakeContext = &webSocket->handshakeContext;
863 
864    \textcolor{comment}{//The HTTP version must be at least 1.1}
865    \textcolor{keywordflow}{if}(handshakeContext->\hyperlink{structWebSocketHandshakeContext_a9496aee1b2e4fcf092e06f99d2e4762d}{version} < \hyperlink{web__socket_8h_a1c876c89b2d8e417e1a99a6dbcb1bfacafdefe3d8ccc39d6c50065d47b1c32b6a}{WS\_HTTP\_VERSION\_1\_1})
866       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
867 
868    \textcolor{comment}{//The request must contain an Upgrade header field whose value}
869    \textcolor{comment}{//must include the "websocket" keyword}
870    \textcolor{keywordflow}{if}(!handshakeContext->\hyperlink{structWebSocketHandshakeContext_afcbf1dd5bbba5e6d6dd08868eadd5626}{upgradeWebSocket})
871       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
872 
873    \textcolor{comment}{//The request must contain a Connection header field whose value}
874    \textcolor{comment}{//must include the "Upgrade" token}
875    \textcolor{keywordflow}{if}(!handshakeContext->\hyperlink{structWebSocketHandshakeContext_adc97c9e21e2aef9c5e743e612ea13bab}{connectionUpgrade})
876       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
877 
878    \textcolor{comment}{//The request must include a header field with the name Sec-WebSocket-Key}
879    \textcolor{keywordflow}{if}(handshakeContext->\hyperlink{structWebSocketHandshakeContext_af28fef00979612ccfed3ab93d5da1b38}{clientKey}[0] == 0)
880       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca58b9865a3dd951988ab2d8f53b0e4166}{ERROR\_INVALID\_REQUEST};
881 
882    \textcolor{comment}{//Check the Sec-WebSocket-Key header field}
883    error = \hyperlink{web__socket__misc_8c_a048d6225a8694c41679c280211d983e2}{webSocketVerifyClientKey}(webSocket);
884    \textcolor{comment}{//Verification failed?}
885    \textcolor{keywordflow}{if}(error)
886       \textcolor{keywordflow}{return} error;
887 
888    \textcolor{comment}{//Generate the server part of the handshake}
889    \hyperlink{web__socket__misc_8c_a2950d387e998381f3aab0031a3e13004}{webSocketChangeState}(webSocket, \hyperlink{web__socket_8h_a84047dc3e004de841d87c90be9dcd0f0af67b597c54a4b89fc2566c326231aa8b}{WS\_STATE\_SERVER\_HANDSHAKE});
890 
891    \textcolor{comment}{//Successful processing}
892    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
893 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_a048d6225a8694c41679c280211d983e2}\label{web__socket__misc_8h_a048d6225a8694c41679c280211d983e2}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Verify\+Client\+Key@{web\+Socket\+Verify\+Client\+Key}}
\index{web\+Socket\+Verify\+Client\+Key@{web\+Socket\+Verify\+Client\+Key}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Verify\+Client\+Key()}{webSocketVerifyClientKey()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Verify\+Client\+Key (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket }\end{DoxyParamCaption})}



Verify client\textquotesingle{}s key. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1049 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
1050 \{
1051    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1052    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1053    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *buffer;
1054    \hyperlink{structWebSocketHandshakeContext}{WebSocketHandshakeContext} *handshakeContext;
1055 
1056    \textcolor{comment}{//Debug message}
1057    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"WebSocket: Verifying client's key...\(\backslash\)r\(\backslash\)n"});
1058 
1059    \textcolor{comment}{//Temporary buffer}
1060    buffer = (\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) webSocket->txContext.buffer;
1061 
1062    \textcolor{comment}{//Point to the handshake context}
1063    handshakeContext = &webSocket->handshakeContext;
1064 
1065    \textcolor{comment}{//Retrieve the length of the client's key}
1066    n = strlen(handshakeContext->\hyperlink{structWebSocketHandshakeContext_af28fef00979612ccfed3ab93d5da1b38}{clientKey});
1067 
1068    \textcolor{comment}{//The value of the Sec-WebSocket-Key header field must be a 16-byte}
1069    \textcolor{comment}{//value that has been Base64-encoded}
1070    error = \hyperlink{base64_8c_ae360cde3e2ef08783ac2e01591b78530}{base64Decode}(handshakeContext->\hyperlink{structWebSocketHandshakeContext_af28fef00979612ccfed3ab93d5da1b38}{clientKey}, n, buffer, &n);
1071    \textcolor{comment}{//Decoding failed?}
1072    \textcolor{keywordflow}{if}(error)
1073       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca31846fcd73423f08cca08d9acf9b3f8e}{ERROR\_INVALID\_KEY};
1074 
1075    \textcolor{comment}{//Check the length of the resulting value}
1076    \textcolor{keywordflow}{if}(n != 16)
1077       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca31846fcd73423f08cca08d9acf9b3f8e}{ERROR\_INVALID\_KEY};
1078 
1079    \textcolor{comment}{//Successful verification}
1080    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1081 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_a4b7ac6a29fc417f978a8b2a98e34519a}\label{web__socket__misc_8h_a4b7ac6a29fc417f978a8b2a98e34519a}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Verify\+Server\+Handshake@{web\+Socket\+Verify\+Server\+Handshake}}
\index{web\+Socket\+Verify\+Server\+Handshake@{web\+Socket\+Verify\+Server\+Handshake}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Verify\+Server\+Handshake()}{webSocketVerifyServerHandshake()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Verify\+Server\+Handshake (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket }\end{DoxyParamCaption})}



Verify server\textquotesingle{}s handshake. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 902 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
903 \{
904    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
905    \hyperlink{structWebSocketHandshakeContext}{WebSocketHandshakeContext} *handshakeContext;
906 
907    \textcolor{comment}{//Debug message}
908    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"WebSocket: verifying server handshake\(\backslash\)r\(\backslash\)n"});
909 
910    \textcolor{comment}{//Point to the handshake context}
911    handshakeContext = &webSocket->handshakeContext;
912 
913    \textcolor{comment}{//If the status code received from the server is not 101, the client}
914    \textcolor{comment}{//handles the response per HTTP procedures}
915    \textcolor{keywordflow}{if}(handshakeContext->\hyperlink{structWebSocketHandshakeContext_a639b95639068873e12af0ad0638c140b}{statusCode} == 401)
916    \{
917       \textcolor{comment}{//Authorization required}
918       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caf39266cb112974885d37b09ef0f40f42}{ERROR\_AUTH\_REQUIRED};
919    \}
920    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(handshakeContext->\hyperlink{structWebSocketHandshakeContext_a639b95639068873e12af0ad0638c140b}{statusCode} != 101)
921    \{
922       \textcolor{comment}{//Unknown status code}
923       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cad08a24e05f290a18fed0f90d007380e1}{ERROR\_INVALID\_STATUS};
924    \}
925 
926    \textcolor{comment}{//If the response lacks an Upgrade header field or the Upgrade header field}
927    \textcolor{comment}{//contains a value that is not an ASCII case-insensitive match for the}
928    \textcolor{comment}{//value "websocket", the client must fail the WebSocket connection}
929    \textcolor{keywordflow}{if}(!handshakeContext->\hyperlink{structWebSocketHandshakeContext_afcbf1dd5bbba5e6d6dd08868eadd5626}{upgradeWebSocket})
930       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
931 
932    \textcolor{comment}{//If the response lacks a Connection header field or the Connection header}
933    \textcolor{comment}{//field doesn't contain a token that is an ASCII case-insensitive match for}
934    \textcolor{comment}{//the value "Upgrade", the client must fail the WebSocket connection}
935    \textcolor{keywordflow}{if}(!handshakeContext->\hyperlink{structWebSocketHandshakeContext_adc97c9e21e2aef9c5e743e612ea13bab}{connectionUpgrade})
936       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
937 
938    \textcolor{comment}{//If the response lacks a Sec-WebSocket-Accept header field, the client}
939    \textcolor{comment}{//must fail the WebSocket connection}
940    \textcolor{keywordflow}{if}(strlen(handshakeContext->\hyperlink{structWebSocketHandshakeContext_a5539a48778d86216622299eb3f76380b}{serverKey}) == 0)
941       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
942 
943    \textcolor{comment}{//Check the Sec-WebSocket-Accept header field}
944    error = \hyperlink{web__socket__misc_8c_a744e26069ab68cf2f40650e8ebb78f44}{webSocketVerifyServerKey}(webSocket);
945    \textcolor{comment}{//Verification failed?}
946    \textcolor{keywordflow}{if}(error)
947       \textcolor{keywordflow}{return} error;
948 
949    \textcolor{comment}{//If the server's response is validated as provided for above, it is}
950    \textcolor{comment}{//said that the WebSocket connection is established and that the}
951    \textcolor{comment}{//WebSocket connection is in the OPEN state}
952    \hyperlink{web__socket__misc_8c_a2950d387e998381f3aab0031a3e13004}{webSocketChangeState}(webSocket, \hyperlink{web__socket_8h_a84047dc3e004de841d87c90be9dcd0f0ab0325195f22aca5be7491a425f84808c}{WS\_STATE\_OPEN});
953 
954    \textcolor{comment}{//Successful processing}
955    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
956 \}
\end{DoxyCode}
\mbox{\Hypertarget{web__socket__misc_8h_a744e26069ab68cf2f40650e8ebb78f44}\label{web__socket__misc_8h_a744e26069ab68cf2f40650e8ebb78f44}} 
\index{web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}!web\+Socket\+Verify\+Server\+Key@{web\+Socket\+Verify\+Server\+Key}}
\index{web\+Socket\+Verify\+Server\+Key@{web\+Socket\+Verify\+Server\+Key}!web\+\_\+socket\+\_\+misc.\+h@{web\+\_\+socket\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{web\+Socket\+Verify\+Server\+Key()}{webSocketVerifyServerKey()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} web\+Socket\+Verify\+Server\+Key (\begin{DoxyParamCaption}\item[{\hyperlink{web__socket_8h_aad796fb4e3af91c4358c5b273d4a2028}{Web\+Socket} $\ast$}]{web\+Socket }\end{DoxyParamCaption})}



Verify server\textquotesingle{}s key. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em web\+Socket} & Handle to a Web\+Socket \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1090 of file web\+\_\+socket\+\_\+misc.\+c.


\begin{DoxyCode}
1091 \{
1092    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1093    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *buffer;
1094    \hyperlink{structWebSocketHandshakeContext}{WebSocketHandshakeContext} *handshakeContext;
1095    \hyperlink{structSha1Context}{Sha1Context} sha1Context;
1096 
1097    \textcolor{comment}{//Debug message}
1098    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"WebSocket: Verifying server's key...\(\backslash\)r\(\backslash\)n"});
1099 
1100    \textcolor{comment}{//Temporary buffer}
1101    buffer = (\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *) webSocket->txContext.buffer;
1102 
1103    \textcolor{comment}{//Point to the handshake context}
1104    handshakeContext = &webSocket->handshakeContext;
1105 
1106    \textcolor{comment}{//Retrieve the length of the client's key}
1107    n = strlen(handshakeContext->\hyperlink{structWebSocketHandshakeContext_af28fef00979612ccfed3ab93d5da1b38}{clientKey});
1108 
1109    \textcolor{comment}{//Concatenate the Sec-WebSocket-Key with the GUID string and digest}
1110    \textcolor{comment}{//the resulting string using SHA-1}
1111    \hyperlink{sha1_8c_ab734cb0e0b67798f5cce1f34419982a3}{sha1Init}(&sha1Context);
1112    \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(&sha1Context, handshakeContext->\hyperlink{structWebSocketHandshakeContext_af28fef00979612ccfed3ab93d5da1b38}{clientKey}, n);
1113    \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(&sha1Context, \hyperlink{web__socket__misc_8c_a0b41bfb3ed9ee18d8d92503907086797}{webSocketGuid}, strlen(
      \hyperlink{web__socket__misc_8c_a0b41bfb3ed9ee18d8d92503907086797}{webSocketGuid}));
1114    \hyperlink{sha1_8c_a7b7d2f57b504df6ed98c27d21c1d7a14}{sha1Final}(&sha1Context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
1115 
1116    \textcolor{comment}{//Encode the result using Base64}
1117    \hyperlink{base64_8c_a6eb49435a26b3297e611264f6d1cbf5f}{base64Encode}(sha1Context.\hyperlink{structSha1Context_aa763a9ba0f9014894b8af6171eaf2a20}{digest}, \hyperlink{sha1_8h_a3ba9296b223f1b3c710d6b812fd860e8}{SHA1\_DIGEST\_SIZE}, buffer, &n);
1118 
1119    \textcolor{comment}{//Debug message}
1120    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Client key: %s\(\backslash\)r\(\backslash\)n"}, handshakeContext->\hyperlink{structWebSocketHandshakeContext_af28fef00979612ccfed3ab93d5da1b38}{clientKey});
1121    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Server key: %s\(\backslash\)r\(\backslash\)n"}, handshakeContext->\hyperlink{structWebSocketHandshakeContext_a5539a48778d86216622299eb3f76380b}{serverKey});
1122    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Calculated key: %s\(\backslash\)r\(\backslash\)n"}, webSocket->txContext.buffer);
1123 
1124    \textcolor{comment}{//Check whether the server's key is valid}
1125    \textcolor{keywordflow}{if}(strcmp(handshakeContext->\hyperlink{structWebSocketHandshakeContext_a5539a48778d86216622299eb3f76380b}{serverKey}, buffer))
1126       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca31846fcd73423f08cca08d9acf9b3f8e}{ERROR\_INVALID\_KEY};
1127 
1128    \textcolor{comment}{//Successful verification}
1129    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1130 \}
\end{DoxyCode}
