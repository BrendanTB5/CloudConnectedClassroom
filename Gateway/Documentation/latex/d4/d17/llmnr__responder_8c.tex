\hypertarget{llmnr__responder_8c}{}\section{cyclone\+\_\+tcp/llmnr/llmnr\+\_\+responder.c File Reference}
\label{llmnr__responder_8c}\index{cyclone\+\_\+tcp/llmnr/llmnr\+\_\+responder.\+c@{cyclone\+\_\+tcp/llmnr/llmnr\+\_\+responder.\+c}}


L\+L\+M\+NR responder (Link-\/\+Local Multicast Name Resolution)  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}llmnr/llmnr\+\_\+responder.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}llmnr/llmnr\+\_\+common.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dns/dns\+\_\+debug.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{llmnr__responder_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_a8a2973772bec962af07b862acac259c0}{L\+L\+M\+N\+R\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{llmnr__responder_8c_af59bcf0f53d8c8e1542ca0718fbb3843}{llmnr\+Responder\+Init} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em L\+L\+M\+NR responder initialization. \end{DoxyCompactList}\item 
void \hyperlink{llmnr__responder_8c_a51cb19f9cd533ba4e98c385de5df4bb0}{llmnr\+Process\+Query} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{structIpPseudoHeader}{Ip\+Pseudo\+Header} $\ast$pseudo\+Header, const \hyperlink{udp_8h_a6877bae1da8326482f5e311875e52bce}{Udp\+Header} $\ast$udp\+Header, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset}, void $\ast$param)
\begin{DoxyCompactList}\small\item\em Process L\+L\+M\+NR query message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{llmnr__responder_8c_a0e9aa4a92c30a928356e82f5977115f7}{llmnr\+Send\+Response} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$\hyperlink{ipcp_8h_a752e1719cf65f78dfec6274352cb56df}{dest\+Ip\+Addr}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{udp_8h_af15d713ad2bc92686abfa6ab012b5039}{dest\+Port}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{nbns__common_8h_a4fc3a0c58dfbd1e68224521185cb9384}{id}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{dns__common_8h_a92ac313e0c65dcd831a91b495aa7b282}{qtype}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{dns__common_8h_ac94c665afc6c72c418f3caa344bc480e}{qclass})
\begin{DoxyCompactList}\small\item\em Send L\+L\+M\+NR response message. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
L\+L\+M\+NR responder (Link-\/\+Local Multicast Name Resolution) 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{llmnr__responder_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{llmnr__responder_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{llmnr\+\_\+responder.\+c@{llmnr\+\_\+responder.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!llmnr\+\_\+responder.\+c@{llmnr\+\_\+responder.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_a8a2973772bec962af07b862acac259c0}{L\+L\+M\+N\+R\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file llmnr\+\_\+responder.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{llmnr__responder_8c_a51cb19f9cd533ba4e98c385de5df4bb0}\label{llmnr__responder_8c_a51cb19f9cd533ba4e98c385de5df4bb0}} 
\index{llmnr\+\_\+responder.\+c@{llmnr\+\_\+responder.\+c}!llmnr\+Process\+Query@{llmnr\+Process\+Query}}
\index{llmnr\+Process\+Query@{llmnr\+Process\+Query}!llmnr\+\_\+responder.\+c@{llmnr\+\_\+responder.\+c}}
\subsubsection{\texorpdfstring{llmnr\+Process\+Query()}{llmnrProcessQuery()}}
{\footnotesize\ttfamily void llmnr\+Process\+Query (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{structIpPseudoHeader}{Ip\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{const \hyperlink{udp_8h_a6877bae1da8326482f5e311875e52bce}{Udp\+Header} $\ast$}]{udp\+Header,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset,  }\item[{void $\ast$}]{param }\end{DoxyParamCaption})}



Process L\+L\+M\+NR query message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & U\+DP pseudo header \\
\hline
\mbox{\tt in}  & {\em udp\+Header} & U\+DP header \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the incoming L\+L\+M\+NR message \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first byte of the L\+L\+M\+NR message \\
\hline
\mbox{\tt in}  & {\em param} & Callback function parameter (not used) \\
\hline
\end{DoxyParams}


Definition at line 93 of file llmnr\+\_\+responder.\+c.


\begin{DoxyCode}
95 \{
96    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
97    \textcolor{keywordtype}{size\_t} pos;
98    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
99    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{tcp_8h_af15d713ad2bc92686abfa6ab012b5039}{destPort};
100    \hyperlink{structIpAddr}{IpAddr} \hyperlink{ipcp_8h_a752e1719cf65f78dfec6274352cb56df}{destIpAddr};
101    \hyperlink{llmnr__common_8h_a53524a15a990495f2db298659ee4044f}{LlmnrHeader} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
102    \hyperlink{dns__common_8h_ac1ef063cc8bc932118463092c282f188}{DnsQuestion} *question;
103 
104    \textcolor{comment}{//Retrieve the length of the LLMNR message}
105    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
106 
107    \textcolor{comment}{//Ensure the LLMNR message is valid}
108    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{llmnr__common_8h_a53524a15a990495f2db298659ee4044f}{LlmnrHeader}))
109       \textcolor{keywordflow}{return};
110    \textcolor{keywordflow}{if}(length > \hyperlink{dns__common_8h_a8578d0d73531c18ef02299543f9b232e}{DNS\_MESSAGE\_MAX\_SIZE})
111       \textcolor{keywordflow}{return};
112 
113    \textcolor{comment}{//Point to the LLMNR message header}
114    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
115    \textcolor{comment}{//Sanity check}
116    \textcolor{keywordflow}{if}(message == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
117       \textcolor{keywordflow}{return};
118 
119    \textcolor{comment}{//Debug message}
120    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"LLMNR message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
121    \textcolor{comment}{//Dump message}
122    \hyperlink{dns__debug_8c_aa6a38c4e74d8b059c64c30456d5c26ad}{dnsDumpMessage}((\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader} *) message, length);
123 
124 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
125    \textcolor{comment}{//IPv4 query received?}
126    \textcolor{keywordflow}{if}(pseudoHeader->\hyperlink{structIpPseudoHeader_aeff06b8d9c3e7e2ef3cdb8a3a14e8ad2}{length} == \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a0e92b64e038199f1bb6383f2a76f30b6}{Ipv4PseudoHeader}))
127    \{
128       \textcolor{comment}{//Unicast UDP queries must be silently discarded (refer to RFC 4795,}
129       \textcolor{comment}{//section 2.4)}
130       \textcolor{keywordflow}{if}(!\hyperlink{ipv4_8h_aada5b622e70acf16bd1cd5a9c08ea107}{ipv4IsMulticastAddr}(pseudoHeader->\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.destAddr))
131          \textcolor{keywordflow}{return};
132 
133       \textcolor{comment}{//A responder responds to a multicast query by sending a unicast UDP}
134       \textcolor{comment}{//response to the sender (refer to RFC 4795, section 2)}
135       destIpAddr.\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} = \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr});
136       destIpAddr.\hyperlink{structIpAddr_a8de6f49cb0461f57c1eda49bb1088916}{ipv4Addr} = pseudoHeader->\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.srcAddr;
137    \}
138    \textcolor{keywordflow}{else}
139 \textcolor{preprocessor}{#endif}
140 \textcolor{preprocessor}{#if (IPV6\_SUPPORT == ENABLED)}
141    \textcolor{comment}{//IPv6 query received?}
142    \textcolor{keywordflow}{if}(pseudoHeader->\hyperlink{structIpPseudoHeader_aeff06b8d9c3e7e2ef3cdb8a3a14e8ad2}{length} == \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader}))
143    \{
144       \textcolor{comment}{//Unicast UDP queries must be silently discarded (refer to RFC 4795,}
145       \textcolor{comment}{//section 2.4)}
146       \textcolor{keywordflow}{if}(!\hyperlink{ipv6_8h_a68fbc1145d242384c90a670196a38495}{ipv6IsMulticastAddr}(&pseudoHeader->\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.destAddr))
147          \textcolor{keywordflow}{return};
148 
149       \textcolor{comment}{//A responder responds to a multicast query by sending a unicast UDP}
150       \textcolor{comment}{//response to the sender (refer to RFC 4795, section 2)}
151       destIpAddr.\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} = \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6Addr});
152       destIpAddr.\hyperlink{structIpAddr_a9bc2340a9c0bc5a0b8aa9695b74e2ee6}{ipv6Addr} = pseudoHeader->\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.srcAddr;
153    \}
154    \textcolor{keywordflow}{else}
155 \textcolor{preprocessor}{#endif}
156    \textcolor{comment}{//Invalid query received?}
157    \{
158       \textcolor{comment}{//Discard the LLMNR query message}
159       \textcolor{keywordflow}{return};
160    \}
161 
162    \textcolor{comment}{//Discard LLMNR responses received on port 5355}
163    \textcolor{keywordflow}{if}(message->qr)
164       \textcolor{keywordflow}{return};
165 
166    \textcolor{comment}{//LLMNR messages received with an opcode other than zero must be silently}
167    \textcolor{comment}{//ignored}
168    \textcolor{keywordflow}{if}(message->opcode != \hyperlink{dns__common_8h_a9f7c2277e233fdeda3757e48282d3314af37862c9f8865288e6df0392930ec0a3}{DNS\_OPCODE\_QUERY})
169       \textcolor{keywordflow}{return};
170 
171    \textcolor{comment}{//LLMNR messages received with non-zero response codes must be silently}
172    \textcolor{comment}{//ignored}
173    \textcolor{keywordflow}{if}(message->rcode != \hyperlink{dns__common_8h_a4e14ab5567efbae42f570bc5bbd1d209a3673e53909ca3bf211abc3f0600158e0}{DNS\_RCODE\_NO\_ERROR})
174       \textcolor{keywordflow}{return};
175 
176    \textcolor{comment}{//LLMNR responders must silently discard LLMNR queries with QDCOUNT not}
177    \textcolor{comment}{//equal to one (refer to RFC 4795, section 2.1.1)}
178    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->qdcount) != 1)
179       \textcolor{keywordflow}{return};
180 
181    \textcolor{comment}{//LLMNR responders must silently discard LLMNR queries with ANCOUNT or}
182    \textcolor{comment}{//NSCOUNT not equal to zero}
183    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->ancount) != 0 || \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->nscount) != 0)
184       \textcolor{keywordflow}{return};
185 
186    \textcolor{comment}{//Point to the first question}
187    pos = \textcolor{keyword}{sizeof}(\hyperlink{llmnr__common_8h_a53524a15a990495f2db298659ee4044f}{LlmnrHeader});
188 
189    \textcolor{comment}{//Parse resource record name}
190    n = \hyperlink{dns__common_8c_a6a5df1aead8f61467e9bf5e739ea5de0}{dnsParseName}((\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader} *) message, length, pos, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 0);
191    \textcolor{comment}{//Invalid name?}
192    \textcolor{keywordflow}{if}(n == 0)
193       \textcolor{keywordflow}{return};
194 
195    \textcolor{comment}{//Malformed LLMNR message?}
196    \textcolor{keywordflow}{if}((n + \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_ac1ef063cc8bc932118463092c282f188}{DnsQuestion})) > length)
197       \textcolor{keywordflow}{return};
198 
199    \textcolor{comment}{//Point to the corresponding entry}
200    question = \hyperlink{dns__common_8h_a66ca704f3f850dcbb2f3ceefe90afcc5}{DNS\_GET\_QUESTION}(message, n);
201 
202    \textcolor{comment}{//Check the class of the query}
203    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(question->qclass) == \hyperlink{dns__common_8h_aa541e7289dae8934f7f37e74c15cc5a5ae4d96c0329f035328ba190627f2782e9}{DNS\_RR\_CLASS\_IN} ||
204       \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(question->qclass) == \hyperlink{dns__common_8h_aa541e7289dae8934f7f37e74c15cc5a5a5bb41b9beab96e5a78ec7023756e8d3b}{DNS\_RR\_CLASS\_ANY})
205    \{
206       \textcolor{comment}{//Responders must respond to LLMNR queries for names and addresses for}
207       \textcolor{comment}{//which they are authoritative}
208       \textcolor{keywordflow}{if}(!\hyperlink{dns__common_8c_a09647d0528e53280cc0a35866cb2b224}{dnsCompareName}((\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader} *) message, length, pos,
209          interface->hostname, 0))
210       \{
211          \textcolor{comment}{//Responders must direct responses to the port from which the query}
212          \textcolor{comment}{//was sent}
213          destPort = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(udpHeader->srcPort);
214 
215          \textcolor{comment}{//Send LLMNR response}
216          \hyperlink{llmnr__responder_8c_a0e9aa4a92c30a928356e82f5977115f7}{llmnrSendResponse}(interface, &destIpAddr, destPort, message->id,
217             \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(question->qtype), \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(question->qclass));
218       \}
219    \}
220 \}
\end{DoxyCode}
\mbox{\Hypertarget{llmnr__responder_8c_af59bcf0f53d8c8e1542ca0718fbb3843}\label{llmnr__responder_8c_af59bcf0f53d8c8e1542ca0718fbb3843}} 
\index{llmnr\+\_\+responder.\+c@{llmnr\+\_\+responder.\+c}!llmnr\+Responder\+Init@{llmnr\+Responder\+Init}}
\index{llmnr\+Responder\+Init@{llmnr\+Responder\+Init}!llmnr\+\_\+responder.\+c@{llmnr\+\_\+responder.\+c}}
\subsubsection{\texorpdfstring{llmnr\+Responder\+Init()}{llmnrResponderInit()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} llmnr\+Responder\+Init (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



L\+L\+M\+NR responder initialization. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 51 of file llmnr\+\_\+responder.\+c.


\begin{DoxyCode}
52 \{
53    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
54 
55 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
56    \textcolor{comment}{//Join the LLMNR IPv4 multicast group}
57    error = \hyperlink{ipv4_8c_ab2a827c952b160ccc0afba106e865183}{ipv4JoinMulticastGroup}(interface, 
      \hyperlink{llmnr__common_8h_a83c2092c6d0395e9a57a380db44ab9a6}{LLMNR\_IPV4\_MULTICAST\_ADDR});
58    \textcolor{comment}{//Any error to report?}
59    \textcolor{keywordflow}{if}(error)
60       \textcolor{keywordflow}{return} error;
61 \textcolor{preprocessor}{#endif}
62 
63 \textcolor{preprocessor}{#if (IPV6\_SUPPORT == ENABLED)}
64    \textcolor{comment}{//Join the LLMNR IPv6 multicast group}
65    error = \hyperlink{ipv6_8c_abbf3683ee76a53fdf931e58fabe6db6f}{ipv6JoinMulticastGroup}(interface, &
      \hyperlink{llmnr__common_8c_a8c3efde1a1d0b22ebf1f766060a5bd31}{LLMNR\_IPV6\_MULTICAST\_ADDR});
66    \textcolor{comment}{//Any error to report?}
67    \textcolor{keywordflow}{if}(error)
68       \textcolor{keywordflow}{return} error;
69 \textcolor{preprocessor}{#endif}
70 
71    \textcolor{comment}{//LLMNR responders must listen on UDP port 5355}
72    error = \hyperlink{udp_8c_a38370e246c2908c710db4773a6423cee}{udpAttachRxCallback}(interface, \hyperlink{llmnr__common_8h_a2ee6754dce5ef0d2cd0a1adf230f436c}{LLMNR\_PORT}, 
      \hyperlink{llmnr__responder_8c_a51cb19f9cd533ba4e98c385de5df4bb0}{llmnrProcessQuery},
73       \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
74    \textcolor{comment}{//Any error to report?}
75    \textcolor{keywordflow}{if}(error)
76       \textcolor{keywordflow}{return} error;
77 
78    \textcolor{comment}{//Successful initialization}
79    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
80 \}
\end{DoxyCode}
\mbox{\Hypertarget{llmnr__responder_8c_a0e9aa4a92c30a928356e82f5977115f7}\label{llmnr__responder_8c_a0e9aa4a92c30a928356e82f5977115f7}} 
\index{llmnr\+\_\+responder.\+c@{llmnr\+\_\+responder.\+c}!llmnr\+Send\+Response@{llmnr\+Send\+Response}}
\index{llmnr\+Send\+Response@{llmnr\+Send\+Response}!llmnr\+\_\+responder.\+c@{llmnr\+\_\+responder.\+c}}
\subsubsection{\texorpdfstring{llmnr\+Send\+Response()}{llmnrSendResponse()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} llmnr\+Send\+Response (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$}]{dest\+Ip\+Addr,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{dest\+Port,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{id,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{qtype,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{qclass }\end{DoxyParamCaption})}



Send L\+L\+M\+NR response message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em dest\+Ip\+Addr} & Destination IP address \\
\hline
\mbox{\tt in}  & {\em dest\+Port} & destination port \\
\hline
\mbox{\tt in}  & {\em id} & 16-\/bit identifier to be used when sending L\+L\+M\+NR query \\
\hline
\mbox{\tt in}  & {\em qtype} & Resource record type \\
\hline
\mbox{\tt in}  & {\em qclass} & Resource record class \\
\hline
\end{DoxyParams}


Definition at line 233 of file llmnr\+\_\+responder.\+c.


\begin{DoxyCode}
235 \{
236    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
237    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
238    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
239    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
240    \hyperlink{llmnr__common_8h_a53524a15a990495f2db298659ee4044f}{LlmnrHeader} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
241    \hyperlink{dns__common_8h_ac1ef063cc8bc932118463092c282f188}{DnsQuestion} *question;
242    \hyperlink{dns__common_8h_a801d4a933cd802d56c5450013b4c0969}{DnsResourceRecord} *record;
243 
244    \textcolor{comment}{//Initialize status code}
245    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
246 
247    \textcolor{comment}{//Allocate a memory buffer to hold the LLMNR response message}
248    buffer = \hyperlink{udp_8c_a2c65cad7c5665fe03f94364e7e52b2be}{udpAllocBuffer}(\hyperlink{dns__common_8h_a8578d0d73531c18ef02299543f9b232e}{DNS\_MESSAGE\_MAX\_SIZE}, &offset);
249    \textcolor{comment}{//Failed to allocate buffer?}
250    \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
251       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
252 
253    \textcolor{comment}{//Point to the LLMNR header}
254    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, offset);
255 
256    \textcolor{comment}{//Take the identifier from the query message}
257    message->id = \hyperlink{dns__common_8h_a4fc3a0c58dfbd1e68224521185cb9384}{id};
258 
259    \textcolor{comment}{//Format LLMNR response header}
260    message->qr = 1;
261    message->opcode = \hyperlink{dns__common_8h_a9f7c2277e233fdeda3757e48282d3314af37862c9f8865288e6df0392930ec0a3}{DNS\_OPCODE\_QUERY};
262    message->c = 0;
263    message->tc = 0;
264    message->t = 0;
265    message->z = 0;
266    message->rcode = \hyperlink{dns__common_8h_a4e14ab5567efbae42f570bc5bbd1d209a3673e53909ca3bf211abc3f0600158e0}{DNS\_RCODE\_NO\_ERROR};
267    message->qdcount = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(1);
268    message->ancount = 0;
269    message->nscount = 0;
270    message->arcount = 0;
271 
272    \textcolor{comment}{//Set the length of the LLMNR response message}
273    length = \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader});
274 
275    \textcolor{comment}{//Encode the requested host name using the DNS name notation}
276    length += \hyperlink{dns__common_8c_aa375505b90ab1f2473b3084c97ace370}{dnsEncodeName}(interface->hostname,
277       (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) message + length);
278 
279    \textcolor{comment}{//Point to the corresponding entry}
280    question = \hyperlink{dns__common_8h_a66ca704f3f850dcbb2f3ceefe90afcc5}{DNS\_GET\_QUESTION}(message, length);
281 
282    \textcolor{comment}{//Fill in resource record}
283    question->qtype = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{dns__common_8h_a92ac313e0c65dcd831a91b495aa7b282}{qtype});
284    question->qclass = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{dns__common_8h_ac94c665afc6c72c418f3caa344bc480e}{qclass});
285 
286    \textcolor{comment}{//Update the length of the response message}
287    length += \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_ac1ef063cc8bc932118463092c282f188}{DnsQuestion});
288 
289 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
290    \textcolor{comment}{//A resource record requested?}
291    \textcolor{keywordflow}{if}(\hyperlink{dns__common_8h_a92ac313e0c65dcd831a91b495aa7b282}{qtype} == \hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a420fd47ef427589e0f1961e35b46756b}{DNS\_RR\_TYPE\_A} || \hyperlink{dns__common_8h_a92ac313e0c65dcd831a91b495aa7b282}{qtype} == \hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a8f6102b9591501cd59e38352db0f94b0}{DNS\_RR\_TYPE\_ANY})
292    \{
293       \textcolor{comment}{//Valid IPv4 host address?}
294       \textcolor{keywordflow}{if}(interface->ipv4Context.addrList[0].state == \hyperlink{ipv4_8h_a7bc59b5d625b1217a91f1db3917e8358a10bd90ad767ea6ae259e9016e6186477}{IPV4\_ADDR\_STATE\_VALID})
295       \{
296          \textcolor{comment}{//Encode the host name using the DNS name notation}
297          length += \hyperlink{dns__common_8c_aa375505b90ab1f2473b3084c97ace370}{dnsEncodeName}(interface->hostname,
298             (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) message + length);
299 
300          \textcolor{comment}{//Point to the corresponding resource record}
301          record = \hyperlink{dns__common_8h_a4f1a2722ba292be26060ec5693e1f280}{DNS\_GET\_RESOURCE\_RECORD}(message, length);
302 
303          \textcolor{comment}{//Fill in resource record}
304          record->rtype = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a420fd47ef427589e0f1961e35b46756b}{DNS\_RR\_TYPE\_A});
305          record->rclass = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{dns__common_8h_aa541e7289dae8934f7f37e74c15cc5a5ae4d96c0329f035328ba190627f2782e9}{DNS\_RR\_CLASS\_IN});
306          record->ttl = \hyperlink{cpu__endian_8h_ac54311f25fef1611a699b949c7410f64}{HTONL}(\hyperlink{llmnr__common_8h_a43919cace2193c9065d47728ed235be3}{LLMNR\_DEFAULT\_RESOURCE\_RECORD\_TTL});
307          record->rdlength = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr}));
308 
309          \textcolor{comment}{//Copy IPv4 address}
310          \hyperlink{ipv4_8h_a36a3af47ec7eec9b1781964eb0494b6f}{ipv4CopyAddr}(record->rdata, &interface->ipv4Context.addrList[0].addr);
311 
312          \textcolor{comment}{//Number of resource records in the answer section}
313          message->ancount++;
314 
315          \textcolor{comment}{//Update the length of the response message}
316          length += \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_a801d4a933cd802d56c5450013b4c0969}{DnsResourceRecord}) + \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr});
317       \}
318    \}
319 \textcolor{preprocessor}{#endif}
320 
321 \textcolor{preprocessor}{#if (IPV6\_SUPPORT == ENABLED)}
322    \textcolor{comment}{//AAAA resource record requested?}
323    \textcolor{keywordflow}{if}(\hyperlink{dns__common_8h_a92ac313e0c65dcd831a91b495aa7b282}{qtype} == \hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a4d0fc3b547030a6a0f32b3ca455927fe}{DNS\_RR\_TYPE\_AAAA} || \hyperlink{dns__common_8h_a92ac313e0c65dcd831a91b495aa7b282}{qtype} == 
      \hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a8f6102b9591501cd59e38352db0f94b0}{DNS\_RR\_TYPE\_ANY})
324    \{
325       \textcolor{comment}{//Valid IPv6 link-local address?}
326       \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_a0650f6186ad38b49662420902ae208ea}{ipv6GetLinkLocalAddrState}(interface) == 
      \hyperlink{ipv6_8h_acb54c5e2b7ee1652f5bf055e14cc518daaa3a0ce422a678d8eb14a36f4c642d16}{IPV6\_ADDR\_STATE\_PREFERRED})
327       \{
328          \textcolor{comment}{//Encode the host name using the DNS name notation}
329          length += \hyperlink{dns__common_8c_aa375505b90ab1f2473b3084c97ace370}{dnsEncodeName}(interface->hostname,
330             (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) message + length);
331 
332          \textcolor{comment}{//Point to the corresponding resource record}
333          record = \hyperlink{dns__common_8h_a4f1a2722ba292be26060ec5693e1f280}{DNS\_GET\_RESOURCE\_RECORD}(message, length);
334 
335          \textcolor{comment}{//Fill in resource record}
336          record->rtype = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a4d0fc3b547030a6a0f32b3ca455927fe}{DNS\_RR\_TYPE\_AAAA});
337          record->rclass = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{dns__common_8h_aa541e7289dae8934f7f37e74c15cc5a5ae4d96c0329f035328ba190627f2782e9}{DNS\_RR\_CLASS\_IN});
338          record->ttl = \hyperlink{cpu__endian_8h_ac54311f25fef1611a699b949c7410f64}{HTONL}(\hyperlink{llmnr__common_8h_a43919cace2193c9065d47728ed235be3}{LLMNR\_DEFAULT\_RESOURCE\_RECORD\_TTL});
339          record->rdlength = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6Addr}));
340 
341          \textcolor{comment}{//Copy IPv6 address}
342          \hyperlink{ipv6_8h_ac22b1fcd381d1c288e269cb8d164bfec}{ipv6CopyAddr}(record->rdata, &interface->ipv6Context.addrList[0].addr);
343 
344          \textcolor{comment}{//Number of resource records in the answer section}
345          message->ancount++;
346 
347          \textcolor{comment}{//Update the length of the response message}
348          length += \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_a801d4a933cd802d56c5450013b4c0969}{DnsResourceRecord}) + \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6Addr});
349       \}
350    \}
351 \textcolor{preprocessor}{#endif}
352 
353    \textcolor{comment}{//Valid LLMNR response?}
354    \textcolor{keywordflow}{if}(message->ancount > 0)
355    \{
356       \textcolor{comment}{//The ANCOUNT field specifies the number of resource records in the}
357       \textcolor{comment}{//answer section}
358       message->ancount = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(message->ancount);
359 
360       \textcolor{comment}{//Adjust the length of the multi-part buffer}
361       \hyperlink{net__mem_8c_ac0a46f396754e069dd1ee65cdc559b28}{netBufferSetLength}(buffer, offset + length);
362 
363       \textcolor{comment}{//Debug message}
364       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending LLMNR message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
365       \textcolor{comment}{//Dump message}
366       \hyperlink{dns__debug_8c_aa6a38c4e74d8b059c64c30456d5c26ad}{dnsDumpMessage}((\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader} *) message, length);
367 
368       \textcolor{comment}{//For UDP responses, the Hop Limit field in the IPv6 header and the TTL}
369       \textcolor{comment}{//field in the IPV4 header MAY be set to any value. However, it is}
370       \textcolor{comment}{//recommended that the value 255 be used for compatibility with early}
371       \textcolor{comment}{//implementations (refer to RFC 4795, section 2.5)}
372       error = \hyperlink{udp_8c_a72a529f723ed1b75bfe98d0708f28eb1}{udpSendDatagramEx}(interface, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \hyperlink{llmnr__common_8h_a2ee6754dce5ef0d2cd0a1adf230f436c}{LLMNR\_PORT}, destIpAddr,
373          \hyperlink{tcp_8h_af15d713ad2bc92686abfa6ab012b5039}{destPort}, buffer, offset, \hyperlink{ip_8h_ad2b4b992325fba597d230405d65e6c98ac6b038dad7629acb28d7fe2f77faa9c5}{IP\_FLAG\_DONT\_ROUTE} | 
      \hyperlink{llmnr__common_8h_af055a37d3c340ba0c2d884e8fe71524c}{LLMNR\_DEFAULT\_IP\_TTL});
374    \}
375 
376    \textcolor{comment}{//Free previously allocated memory}
377    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
378 
379    \textcolor{comment}{//Return status code}
380    \textcolor{keywordflow}{return} error;
381 \}
\end{DoxyCode}
