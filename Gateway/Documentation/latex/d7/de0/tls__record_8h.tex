\hypertarget{tls__record_8h}{}\section{cyclone\+\_\+ssl/tls\+\_\+record.h File Reference}
\label{tls__record_8h}\index{cyclone\+\_\+ssl/tls\+\_\+record.\+h@{cyclone\+\_\+ssl/tls\+\_\+record.\+h}}


T\+LS record protocol.  


{\ttfamily \#include \char`\"{}tls.\+h\char`\"{}}\newline
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record_8h_ae8f8c035d23eb99d1d5642d4ce644715}{tls\+Write\+Protocol\+Data} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type} content\+Type)
\begin{DoxyCompactList}\small\item\em Write protocol data. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record_8h_a801443c458f35a2640ec508b1ec1ecf6}{tls\+Read\+Protocol\+Data} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$$\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type} $\ast$content\+Type)
\begin{DoxyCompactList}\small\item\em Read protocol data. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record_8h_aa0d9e0c356cf90b2f8c0cc986a0702bb}{tls\+Write\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type} content\+Type)
\begin{DoxyCompactList}\small\item\em Send a T\+LS record. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record_8h_a06f4c3b4d5b71bc89eac46ffa49e52f9}{tls\+Read\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t size, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type} $\ast$content\+Type)
\begin{DoxyCompactList}\small\item\em Receive a T\+LS record. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record_8h_a78f759de93bd2ad27efdd0375fcedfbb}{tls\+Process\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{Tls\+Record} $\ast$record)
\begin{DoxyCompactList}\small\item\em Process incoming T\+LS record. \end{DoxyCompactList}\item 
void \hyperlink{tls__record_8h_a2ca833f61cd4672cd6dc3cf323e33a06}{tls\+Set\+Record\+Type} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, void $\ast$record, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{ppp_8h_a1d127017fb298b889f4ba24752d08b8e}{type})
\begin{DoxyCompactList}\small\item\em Set T\+LS record type. \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{tls__record_8h_a6541692151f64ebb3797032c4390d371}{tls\+Get\+Record\+Type} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Get T\+LS record type. \end{DoxyCompactList}\item 
void \hyperlink{tls__record_8h_a956295a326cb475d6e9ad935a91690af}{tls\+Set\+Record\+Length} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, void $\ast$record, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Set T\+LS record length. \end{DoxyCompactList}\item 
size\+\_\+t \hyperlink{tls__record_8h_ab259ff6b1964745a6f4646139c69bfec}{tls\+Get\+Record\+Length} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Get T\+LS record length. \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$ \hyperlink{tls__record_8h_a937201285f16b034ffc504f6151b9f37}{tls\+Get\+Record\+Data} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Get T\+LS record payload. \end{DoxyCompactList}\item 
void \hyperlink{tls__record_8h_ada6e5a7f5801af080907024ae7a9eeb4}{tls\+Format\+Aad} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$encryption\+Engine, const void $\ast$record, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$aad, size\+\_\+t $\ast$aad\+Len)
\begin{DoxyCompactList}\small\item\em Format additional authenticated data (A\+AD) \end{DoxyCompactList}\item 
void \hyperlink{tls__record_8h_aa0aafa9e75cfd27fde215575a44899d8}{tls\+Format\+Nonce} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$encryption\+Engine, const void $\ast$record, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$record\+Iv, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$nonce, size\+\_\+t $\ast$nonce\+Len)
\begin{DoxyCompactList}\small\item\em Format nonce. \end{DoxyCompactList}\item 
void \hyperlink{tls__record_8h_a7033a23b01aeb6f99b9876392eeb4ca4}{tls\+Inc\+Sequence\+Number} (\hyperlink{tls_8h_aadbcbb634b990da0c6d0d07fe08e9f89}{Tls\+Sequence\+Number} $\ast$\hyperlink{tcp_8h_a5c6ae6c0d8819f5ef0fd57e7f9ee6a08}{seq\+Num})
\begin{DoxyCompactList}\small\item\em Increment sequence number. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
T\+LS record protocol. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+S\+SL Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Function Documentation}
\mbox{\Hypertarget{tls__record_8h_ada6e5a7f5801af080907024ae7a9eeb4}\label{tls__record_8h_ada6e5a7f5801af080907024ae7a9eeb4}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Format\+Aad@{tls\+Format\+Aad}}
\index{tls\+Format\+Aad@{tls\+Format\+Aad}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Format\+Aad()}{tlsFormatAad()}}
{\footnotesize\ttfamily void tls\+Format\+Aad (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{encryption\+Engine,  }\item[{const void $\ast$}]{record,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{aad,  }\item[{size\+\_\+t $\ast$}]{aad\+Len }\end{DoxyParamCaption})}



Format additional authenticated data (A\+AD) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em encryption\+Engine} & Pointer to the encryption engine \\
\hline
\mbox{\tt in}  & {\em record} & Pointer to the T\+LS record \\
\hline
\mbox{\tt out}  & {\em aad} & Pointer to the buffer where to store the resulting A\+AD \\
\hline
\mbox{\tt out}  & {\em aad\+Len} & Length of the A\+AD, in bytes \\
\hline
\end{DoxyParams}


Definition at line 905 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
907 \{
908 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
909    \textcolor{comment}{//DTLS protocol?}
910    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
911    \{
912       \textcolor{keyword}{const} \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *dtlsRecord;
913 
914       \textcolor{comment}{//Point to the DTLS record}
915       dtlsRecord = (\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) record;
916 
917       \textcolor{comment}{//Additional data to be authenticated}
918       memcpy(aad, (\textcolor{keywordtype}{void} *) &dtlsRecord->epoch, 2);
919       memcpy(aad + 2, &dtlsRecord->seqNum, 6);
920       memcpy(aad + 8, &dtlsRecord->type, 3);
921       memcpy(aad + 11, (\textcolor{keywordtype}{void} *) &dtlsRecord->length, 2);
922 
923       \textcolor{comment}{//Length of the additional data, in bytes}
924       *aadLen = 13;
925    \}
926    \textcolor{keywordflow}{else}
927 \textcolor{preprocessor}{#endif}
928    \textcolor{comment}{//TLS protocol?}
929    \{
930       \textcolor{comment}{//Version of TLS prior to TLS 1.3?}
931       \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
932       \{
933          \textcolor{comment}{//Additional data to be authenticated}
934          memcpy(aad, &encryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ab9706be268c77258f4c7238721793c}{seqNum}, 8);
935          memcpy(aad + 8, record, 5);
936 
937          \textcolor{comment}{//Length of the additional data, in bytes}
938          *aadLen = 13;
939       \}
940       \textcolor{keywordflow}{else}
941       \{
942          \textcolor{comment}{//The additional data input is the record header (refer to RFC 8446,}
943          \textcolor{comment}{//section 5.2)}
944          memcpy(aad, record, 5);
945 
946          \textcolor{comment}{//Length of the additional data, in bytes}
947          *aadLen = 5;
948       \}
949    \}
950 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record_8h_aa0aafa9e75cfd27fde215575a44899d8}\label{tls__record_8h_aa0aafa9e75cfd27fde215575a44899d8}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Format\+Nonce@{tls\+Format\+Nonce}}
\index{tls\+Format\+Nonce@{tls\+Format\+Nonce}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Format\+Nonce()}{tlsFormatNonce()}}
{\footnotesize\ttfamily void tls\+Format\+Nonce (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{encryption\+Engine,  }\item[{const void $\ast$}]{record,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{record\+Iv,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{nonce,  }\item[{size\+\_\+t $\ast$}]{nonce\+Len }\end{DoxyParamCaption})}



Format nonce. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em encryption\+Engine} & Pointer to the encryption engine \\
\hline
\mbox{\tt in}  & {\em record} & Pointer to the T\+LS record \\
\hline
\mbox{\tt in}  & {\em record\+Iv} & Explicit part of the nonce \\
\hline
\mbox{\tt out}  & {\em nonce} & Pointer to the buffer where to store the resulting nonce \\
\hline
\mbox{\tt out}  & {\em nonce\+Len} & Length of the nonce, in bytes \\
\hline
\end{DoxyParams}


Definition at line 963 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
965 \{
966    \textcolor{keywordtype}{size\_t} i;
967    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
968 
969    \textcolor{comment}{//Check the length of the nonce explicit part}
970    \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen} != 0)
971    \{
972       \textcolor{comment}{//Calculate the total length of the nonce}
973       n = encryptionEngine->\hyperlink{structTlsEncryptionEngine_a40318ca61231c157990a287f4a9c0e2a}{fixedIvLen} + encryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen};
974 
975       \textcolor{comment}{//The salt is the implicit part of the nonce and is not sent in the packet}
976       memcpy(nonce, encryptionEngine->\hyperlink{structTlsEncryptionEngine_af7dda7e3510e4e13458a16c5357143f7}{iv}, encryptionEngine->\hyperlink{structTlsEncryptionEngine_a40318ca61231c157990a287f4a9c0e2a}{fixedIvLen});
977 
978       \textcolor{comment}{//The explicit part of the nonce is chosen by the sender}
979       memcpy(nonce + encryptionEngine->\hyperlink{structTlsEncryptionEngine_a40318ca61231c157990a287f4a9c0e2a}{fixedIvLen}, recordIv,
980          encryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen});
981    \}
982    \textcolor{keywordflow}{else}
983    \{
984       \textcolor{comment}{//Calculate the total length of the nonce}
985       n = encryptionEngine->\hyperlink{structTlsEncryptionEngine_a40318ca61231c157990a287f4a9c0e2a}{fixedIvLen};
986 
987 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
988       \textcolor{comment}{//DTLS protocol?}
989       \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
990       \{
991          \textcolor{keyword}{const} \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *dtlsRecord;
992 
993          \textcolor{comment}{//Point to the DTLS record}
994          dtlsRecord = (\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) record;
995 
996          \textcolor{comment}{//The 64-bit record sequence number is serialized as an 8-byte,}
997          \textcolor{comment}{//big-endian value}
998          memcpy(nonce + n - 8, (\textcolor{keywordtype}{void} *) &dtlsRecord->epoch, 2);
999          memcpy(nonce + n - 6, &dtlsRecord->seqNum, 6);
1000       \}
1001       \textcolor{keywordflow}{else}
1002 \textcolor{preprocessor}{#endif}
1003       \textcolor{comment}{//TLS protocol?}
1004       \{
1005          \textcolor{comment}{//The 64-bit record sequence number is serialized as an 8-byte,}
1006          \textcolor{comment}{//big-endian value}
1007          memcpy(nonce + n - 8, &encryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ab9706be268c77258f4c7238721793c}{seqNum}, 8);
1008       \}
1009 
1010       \textcolor{comment}{//The 64-bit record sequence number is padded on the left by zeros}
1011       memset(nonce, 0, n - 8);
1012 
1013       \textcolor{comment}{//The padded sequence number is XORed with the IV to form the nonce}
1014       \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}; i++)
1015       \{
1016          nonce[i] ^= encryptionEngine->\hyperlink{structTlsEncryptionEngine_af7dda7e3510e4e13458a16c5357143f7}{iv}[i];
1017       \}
1018    \}
1019 
1020    \textcolor{comment}{//Return the total length of the nonce}
1021    *nonceLen = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1022 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record_8h_a937201285f16b034ffc504f6151b9f37}\label{tls__record_8h_a937201285f16b034ffc504f6151b9f37}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Get\+Record\+Data@{tls\+Get\+Record\+Data}}
\index{tls\+Get\+Record\+Data@{tls\+Get\+Record\+Data}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Get\+Record\+Data()}{tlsGetRecordData()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}$\ast$ tls\+Get\+Record\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Get T\+LS record payload. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em record} & Pointer to the T\+LS record \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Pointer to the first byte of the payload 
\end{DoxyReturn}


Definition at line 872 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
873 \{
874    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
875 
876 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
877    \textcolor{comment}{//DTLS protocol?}
878    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
879    \{
880       \textcolor{comment}{//Point to the payload of the DTLS record}
881       data = ((\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) record)->data;
882    \}
883    \textcolor{keywordflow}{else}
884 \textcolor{preprocessor}{#endif}
885    \textcolor{comment}{//TLS protocol?}
886    \{
887       \textcolor{comment}{//Point to the payload of the TLS record}
888       data = ((\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *) record)->data;
889    \}
890 
891    \textcolor{comment}{//Return a pointer to the first byte of the payload}
892    \textcolor{keywordflow}{return} \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
893 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record_8h_ab259ff6b1964745a6f4646139c69bfec}\label{tls__record_8h_ab259ff6b1964745a6f4646139c69bfec}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Get\+Record\+Length@{tls\+Get\+Record\+Length}}
\index{tls\+Get\+Record\+Length@{tls\+Get\+Record\+Length}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Get\+Record\+Length()}{tlsGetRecordLength()}}
{\footnotesize\ttfamily size\+\_\+t tls\+Get\+Record\+Length (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Get T\+LS record length. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em record} & Pointer to the T\+LS record \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Record length 
\end{DoxyReturn}


Definition at line 841 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
842 \{
843    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
844 
845 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
846    \textcolor{comment}{//DTLS protocol?}
847    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
848    \{
849       \textcolor{comment}{//Get the length of the DTLS record}
850       length = ((\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) record)->length;
851    \}
852    \textcolor{keywordflow}{else}
853 \textcolor{preprocessor}{#endif}
854    \textcolor{comment}{//TLS protocol?}
855    \{
856       \textcolor{comment}{//Get the length of the TLS record}
857       length = ((\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *) record)->length;
858    \}
859 
860    \textcolor{comment}{//Convert the length field to host byte order}
861    \textcolor{keywordflow}{return} \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(length);
862 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record_8h_a6541692151f64ebb3797032c4390d371}\label{tls__record_8h_a6541692151f64ebb3797032c4390d371}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Get\+Record\+Type@{tls\+Get\+Record\+Type}}
\index{tls\+Get\+Record\+Type@{tls\+Get\+Record\+Type}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Get\+Record\+Type()}{tlsGetRecordType()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} tls\+Get\+Record\+Type (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Get T\+LS record type. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em record} & Pointer to the T\+LS record \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Record type 
\end{DoxyReturn}


Definition at line 784 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
785 \{
786    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type};
787 
788 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
789    \textcolor{comment}{//DTLS protocol?}
790    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
791    \{
792       \textcolor{comment}{//Get the type of the DTLS record}
793       type = ((\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) record)->type;
794    \}
795    \textcolor{keywordflow}{else}
796 \textcolor{preprocessor}{#endif}
797    \textcolor{comment}{//TLS protocol?}
798    \{
799       \textcolor{comment}{//Get the type of the TLS record}
800       type = ((\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *) record)->type;
801    \}
802 
803    \textcolor{comment}{//Return the content type of the record}
804    \textcolor{keywordflow}{return} \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type};
805 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record_8h_a7033a23b01aeb6f99b9876392eeb4ca4}\label{tls__record_8h_a7033a23b01aeb6f99b9876392eeb4ca4}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Inc\+Sequence\+Number@{tls\+Inc\+Sequence\+Number}}
\index{tls\+Inc\+Sequence\+Number@{tls\+Inc\+Sequence\+Number}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Inc\+Sequence\+Number()}{tlsIncSequenceNumber()}}
{\footnotesize\ttfamily void tls\+Inc\+Sequence\+Number (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_aadbcbb634b990da0c6d0d07fe08e9f89}{Tls\+Sequence\+Number} $\ast$}]{seq\+Num }\end{DoxyParamCaption})}



Increment sequence number. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in,out}  & {\em seq\+Num} & Sequence number to increment \\
\hline
\end{DoxyParams}


Definition at line 1030 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
1031 \{
1032    \hyperlink{compiler__port_8h_a022c65af7f6c8d3947e8a37d64db6ad6}{int\_t} i;
1033 
1034    \textcolor{comment}{//Sequence numbers are stored MSB first}
1035    \textcolor{keywordflow}{for}(i = 7; i >= 0; i--)
1036    \{
1037       \textcolor{comment}{//Increment the current byte}
1038       \hyperlink{dtls__misc_8h_a334ea08fc328b399d92541b8795beed5}{seqNum}->b[i]++;
1039 
1040       \textcolor{comment}{//Propagate the carry if necessary}
1041       \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_a334ea08fc328b399d92541b8795beed5}{seqNum}->b[i] != 0)
1042          \textcolor{keywordflow}{break};
1043    \}
1044 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record_8h_a78f759de93bd2ad27efdd0375fcedfbb}\label{tls__record_8h_a78f759de93bd2ad27efdd0375fcedfbb}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Process\+Record@{tls\+Process\+Record}}
\index{tls\+Process\+Record@{tls\+Process\+Record}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Process\+Record()}{tlsProcessRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Process\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{Tls\+Record} $\ast$}]{record }\end{DoxyParamCaption})}



Process incoming T\+LS record. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em record} & Pointer to the received T\+LS record \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 626 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
627 \{
628    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
629    \hyperlink{structTlsEncryptionEngine}{TlsEncryptionEngine} *decryptionEngine;
630 
631    \textcolor{comment}{//Point to the decryption engine}
632    decryptionEngine = &context->decryptionEngine;
633 
634    \textcolor{comment}{//Check current state}
635    \textcolor{keywordflow}{if}(context->state > \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da69787ce8e1f218e8e47defe7af1c601a}{TLS\_STATE\_SERVER\_HELLO})
636    \{
637       \textcolor{comment}{//Once the server has sent the ServerHello message, enforce the version}
638       \textcolor{comment}{//of incoming records. In TLS 1.3, this field is deprecated. It may be}
639       \textcolor{comment}{//validated to match the fixed constant value 0x0303}
640       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->version) != \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(context->version, \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2}))
641          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca20a00b499b03770ffd859e78470c278f}{ERROR\_VERSION\_NOT\_SUPPORTED};
642    \}
643    \textcolor{keywordflow}{else}
644    \{
645       \textcolor{comment}{//Compliant servers must accept any value \{03,XX\} as the record layer}
646       \textcolor{comment}{//version number for ClientHello}
647       \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a34a3aa6cbadec6a80ab1eae8efd0083d}{LSB}(record->version) != \hyperlink{os__port_8h_aeb61a4e8fff2f4624a632a3189cbd3a0}{MSB}(\hyperlink{tls_8h_adcc8f4321c8f3b847fbea16ca0ff337e}{TLS\_VERSION\_1\_0}))
648          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca20a00b499b03770ffd859e78470c278f}{ERROR\_VERSION\_NOT\_SUPPORTED};
649    \}
650 
651    \textcolor{comment}{//Version of TLS prior to TLS 1.3?}
652    \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
653    \{
654       \textcolor{comment}{//Check whether the record payload is protected}
655       \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} != \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af2b260457a3fa53d37ac1701c7b6502e}{CIPHER\_MODE\_NULL} ||
656          decryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
657       \{
658          \textcolor{comment}{//Decrypt TLS record}
659          error = \hyperlink{tls__record__decryption_8c_a12df36547985f2fbe84fee13de092476}{tlsDecryptRecord}(context, decryptionEngine, record);
660          \textcolor{comment}{//Any error to report?}
661          \textcolor{keywordflow}{if}(error)
662             \textcolor{keywordflow}{return} error;
663       \}
664    \}
665    \textcolor{keywordflow}{else}
666    \{
667       \textcolor{comment}{//An implementation may receive an unencrypted ChangeCipherSpec at a point}
668       \textcolor{comment}{//at the handshake where the implementation is expecting protected records}
669       \textcolor{comment}{//and so it is necessary to detect this condition prior to attempting to}
670       \textcolor{comment}{//deprotect the record}
671       \textcolor{keywordflow}{if}(record->type != \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca4a02e9d014afd5e75b90deefd3e5428c}{TLS\_TYPE\_CHANGE\_CIPHER\_SPEC})
672       \{
673 \textcolor{preprocessor}{#if (TLS\_MAX\_CHANGE\_CIPHER\_SPEC\_MESSAGES > 0)}
674          \textcolor{comment}{//Reset the count of consecutive ChangeCipherSpec messages}
675          context->changeCipherSpecCount = 0;
676 \textcolor{preprocessor}{#endif}
677          \textcolor{comment}{//Check whether the record payload is protected}
678          \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} != \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af2b260457a3fa53d37ac1701c7b6502e}{CIPHER\_MODE\_NULL} ||
679             decryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
680          \{
681             \textcolor{comment}{//Decrypt TLS record}
682             error = \hyperlink{tls__record__decryption_8c_a12df36547985f2fbe84fee13de092476}{tlsDecryptRecord}(context, decryptionEngine, record);
683             \textcolor{comment}{//Any error to report?}
684             \textcolor{keywordflow}{if}(error)
685                \textcolor{keywordflow}{return} error;
686          \}
687 
688          \textcolor{comment}{//Abort the handshake with an unexpected\_message alert if a protected}
689          \textcolor{comment}{//ChangeCipherSpec record was received}
690          \textcolor{keywordflow}{if}(record->type == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca4a02e9d014afd5e75b90deefd3e5428c}{TLS\_TYPE\_CHANGE\_CIPHER\_SPEC})
691             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
692       \}
693 
694       \textcolor{comment}{//Implementations must not send Handshake and Alert records that have a}
695       \textcolor{comment}{//zero-length plaintext content (refer to RFC 8446, section 5.4)}
696       \textcolor{keywordflow}{if}(record->type == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca72077515f40a300c29899b5a3ba48682}{TLS\_TYPE\_HANDSHAKE} ||
697          record->type == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896cac576c866dc3772236d51f16226adfbd9}{TLS\_TYPE\_ALERT})
698       \{
699          \textcolor{comment}{//If such a message is received, the receiving implementation must}
700          \textcolor{comment}{//terminate the connection with an unexpected\_message alert}
701          \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) == 0)
702             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
703       \}
704    \}
705 
706    \textcolor{comment}{//The length of the plaintext record must not exceed 2^14 bytes}
707    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) > \hyperlink{tls_8h_a87485283e0c2c0a9b1b3e5ef9df52975}{TLS\_MAX\_RECORD\_LENGTH})
708       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cacb4ee8addfac0a3444278066663c368a}{ERROR\_RECORD\_OVERFLOW};
709 
710 \textcolor{preprocessor}{#if (TLS\_RECORD\_SIZE\_LIMIT\_SUPPORT == ENABLED)}
711    \textcolor{comment}{//Check whether the RecordSizeLimit extension has been negotiated}
712    \textcolor{keywordflow}{if}(context->recordSizeLimitExtReceived)
713    \{
714       \textcolor{comment}{//The value of RecordSizeLimit is used to limit the size of records}
715       \textcolor{comment}{//that are created when encoding application data and the protected}
716       \textcolor{comment}{//handshake message into records}
717       \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} != \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af2b260457a3fa53d37ac1701c7b6502e}{CIPHER\_MODE\_NULL} ||
718          decryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
719       \{
720          \textcolor{comment}{//A TLS endpoint that receives a record larger than its advertised}
721          \textcolor{comment}{//limit must generate a fatal record\_overflow alert}
722          \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) > decryptionEngine->\hyperlink{structTlsEncryptionEngine_a5191d4d46b33d01d0128e3ef42d73920}{recordSizeLimit})
723             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cacb4ee8addfac0a3444278066663c368a}{ERROR\_RECORD\_OVERFLOW};
724       \}
725    \}
726 \textcolor{preprocessor}{#endif}
727 
728 \textcolor{preprocessor}{#if (TLS\_MAX\_EMPTY\_RECORDS > 0)}
729    \textcolor{comment}{//Empty record received?}
730    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) == 0)
731    \{
732       \textcolor{comment}{//Increment the count of consecutive empty records}
733       context->emptyRecordCount++;
734 
735       \textcolor{comment}{//Do not allow too many consecutive empty records}
736       \textcolor{keywordflow}{if}(context->emptyRecordCount > \hyperlink{tls_8h_a733a0e0362db4ad6016254df0a5cc600}{TLS\_MAX\_EMPTY\_RECORDS})
737          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
738    \}
739    \textcolor{keywordflow}{else}
740    \{
741       \textcolor{comment}{//Reset the count of consecutive empty records}
742       context->emptyRecordCount = 0;
743    \}
744 \textcolor{preprocessor}{#endif}
745 
746    \textcolor{comment}{//Successful processing}
747    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
748 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record_8h_a801443c458f35a2640ec508b1ec1ecf6}\label{tls__record_8h_a801443c458f35a2640ec508b1ec1ecf6}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Read\+Protocol\+Data@{tls\+Read\+Protocol\+Data}}
\index{tls\+Read\+Protocol\+Data@{tls\+Read\+Protocol\+Data}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Read\+Protocol\+Data()}{tlsReadProtocolData()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Read\+Protocol\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$$\ast$}]{data,  }\item[{size\+\_\+t $\ast$}]{length,  }\item[{\hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type} $\ast$}]{content\+Type }\end{DoxyParamCaption})}



Read protocol data. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt out}  & {\em data} & Pointer to the received data \\
\hline
\mbox{\tt out}  & {\em length} & Number of data bytes that were received \\
\hline
\mbox{\tt out}  & {\em content\+Type} & Higher level protocol \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 158 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
160 \{
161    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
162    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
163    \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{TlsContentType} \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type};
164    \hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
165 
166    \textcolor{comment}{//Initialize status code}
167    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
168 
169    \textcolor{comment}{//Fragment reassembly process}
170    \textcolor{keywordflow}{do}
171    \{
172       \textcolor{comment}{//Empty receive buffer?}
173       \textcolor{keywordflow}{if}(context->rxBufferLen == 0)
174       \{
175          \textcolor{comment}{//Read a TLS record}
176          error = \hyperlink{tls__record_8c_a06f4c3b4d5b71bc89eac46ffa49e52f9}{tlsReadRecord}(context, context->rxBuffer,
177             context->rxBufferSize, &n, &type);
178 
179          \textcolor{comment}{//Check status code}
180          \textcolor{keywordflow}{if}(!error)
181          \{
182             \textcolor{comment}{//Save record type}
183             context->rxBufferType = \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type};
184             \textcolor{comment}{//Number of bytes available for reading}
185             context->rxBufferLen = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
186             \textcolor{comment}{//Rewind to the beginning of the buffer}
187             context->rxBufferPos = 0;
188          \}
189       \}
190       \textcolor{comment}{//Imcomplete message received?}
191       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caf4b0e1b500002f089c5e705ce18adec4}{ERROR\_MORE\_DATA\_REQUIRED})
192       \{
193          \textcolor{comment}{//Make room at the end of the buffer}
194          \textcolor{keywordflow}{if}(context->rxBufferPos > 0)
195          \{
196             \textcolor{comment}{//Move unread data to the beginning of the buffer}
197             memmove(context->rxBuffer, context->rxBuffer +
198                context->rxBufferPos, context->rxBufferLen);
199 
200             \textcolor{comment}{//Rewind to the beginning of the buffer}
201             context->rxBufferPos = 0;
202          \}
203 
204          \textcolor{comment}{//Read a TLS record}
205          error = \hyperlink{tls__record_8c_a06f4c3b4d5b71bc89eac46ffa49e52f9}{tlsReadRecord}(context, context->rxBuffer + context->rxBufferLen,
206             context->rxBufferSize - context->rxBufferLen, &n, &type);
207 
208          \textcolor{comment}{//Check status code}
209          \textcolor{keywordflow}{if}(!error)
210          \{
211             \textcolor{comment}{//Fragmented records with mixed types cannot be interleaved}
212             \textcolor{keywordflow}{if}(type != context->rxBufferType)
213                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
214          \}
215 
216          \textcolor{comment}{//Check status code}
217          \textcolor{keywordflow}{if}(!error)
218          \{
219             \textcolor{comment}{//Number of bytes available for reading}
220             context->rxBufferLen += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
221          \}
222       \}
223 
224       \textcolor{comment}{//Check status code}
225       \textcolor{keywordflow}{if}(!error)
226       \{
227          \textcolor{comment}{//Handshake message received?}
228          \textcolor{keywordflow}{if}(context->rxBufferType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca72077515f40a300c29899b5a3ba48682}{TLS\_TYPE\_HANDSHAKE})
229          \{
230             \textcolor{comment}{//A message may be fragmented across several records}
231             \textcolor{keywordflow}{if}(context->rxBufferLen < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake}))
232             \{
233                \textcolor{comment}{//Read an additional record}
234                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caf4b0e1b500002f089c5e705ce18adec4}{ERROR\_MORE\_DATA\_REQUIRED};
235             \}
236             \textcolor{keywordflow}{else}
237             \{
238                \textcolor{comment}{//Point to the handshake message}
239                message = (\hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake} *) (context->rxBuffer + context->rxBufferPos);
240                \textcolor{comment}{//Retrieve the length of the handshake message}
241                n = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake}) + \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->length);
242 
243                \textcolor{comment}{//A message may be fragmented across several records}
244                \textcolor{keywordflow}{if}(context->rxBufferLen < n)
245                \{
246                   \textcolor{comment}{//Read an additional record}
247                   error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caf4b0e1b500002f089c5e705ce18adec4}{ERROR\_MORE\_DATA\_REQUIRED};
248                \}
249                \textcolor{keywordflow}{else}
250                \{
251                   \textcolor{comment}{//Pass the handshake message to the higher layer}
252                   error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
253                \}
254             \}
255          \}
256          \textcolor{comment}{//ChangeCipherSpec message received?}
257          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->rxBufferType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca4a02e9d014afd5e75b90deefd3e5428c}{TLS\_TYPE\_CHANGE\_CIPHER\_SPEC})
258          \{
259             \textcolor{comment}{//A message may be fragmented across several records}
260             \textcolor{keywordflow}{if}(context->rxBufferLen < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a589c515096324e0d72dbaf58631c0501}{TlsChangeCipherSpec}))
261             \{
262                \textcolor{comment}{//Read an additional record}
263                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caf4b0e1b500002f089c5e705ce18adec4}{ERROR\_MORE\_DATA\_REQUIRED};
264             \}
265             \textcolor{keywordflow}{else}
266             \{
267                \textcolor{comment}{//Length of the ChangeCipherSpec message}
268                n = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a589c515096324e0d72dbaf58631c0501}{TlsChangeCipherSpec});
269                \textcolor{comment}{//Pass the ChangeCipherSpec message to the higher layer}
270                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
271             \}
272          \}
273          \textcolor{comment}{//Alert message received?}
274          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->rxBufferType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896cac576c866dc3772236d51f16226adfbd9}{TLS\_TYPE\_ALERT})
275          \{
276             \textcolor{comment}{//A message may be fragmented across several records}
277             \textcolor{keywordflow}{if}(context->rxBufferLen < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_aae4f7171708af263a31b184f9747b17a}{TlsAlert}))
278             \{
279                \textcolor{comment}{//Read an additional record}
280                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caf4b0e1b500002f089c5e705ce18adec4}{ERROR\_MORE\_DATA\_REQUIRED};
281             \}
282             \textcolor{keywordflow}{else}
283             \{
284                \textcolor{comment}{//Length of the Alert message}
285                n = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_aae4f7171708af263a31b184f9747b17a}{TlsAlert});
286                \textcolor{comment}{//Pass the Alert message to the higher layer}
287                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
288             \}
289          \}
290          \textcolor{comment}{//Application data received?}
291          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->rxBufferType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896caa8233b89b5c8f35ce7fcd1f644cbc0fc}{TLS\_TYPE\_APPLICATION\_DATA})
292          \{
293             \textcolor{comment}{//Length of the application data}
294             n = context->rxBufferLen;
295             \textcolor{comment}{//Pass the application data to the higher layer}
296             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
297          \}
298          \textcolor{comment}{//Unknown content type?}
299          \textcolor{keywordflow}{else}
300          \{
301             \textcolor{comment}{//Report an error}
302             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
303          \}
304       \}
305 
306       \textcolor{comment}{//Read as many records as necessary to reassemble the data}
307    \} \textcolor{keywordflow}{while}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caf4b0e1b500002f089c5e705ce18adec4}{ERROR\_MORE\_DATA\_REQUIRED});
308 
309    \textcolor{comment}{//Successful processing?}
310    \textcolor{keywordflow}{if}(!error)
311    \{
312 \textcolor{preprocessor}{#if (TLS\_MAX\_WARNING\_ALERTS > 0)}
313       \textcolor{comment}{//Reset the count of consecutive warning alerts}
314       \textcolor{keywordflow}{if}(context->rxBufferType != \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896cac576c866dc3772236d51f16226adfbd9}{TLS\_TYPE\_ALERT})
315          context->alertCount = 0;
316 \textcolor{preprocessor}{#endif}
317 \textcolor{preprocessor}{#if (TLS\_MAX\_KEY\_UPDATE\_MESSAGES > 0)}
318       \textcolor{comment}{//Reset the count of consecutive KeyUpdate messages}
319       \textcolor{keywordflow}{if}(context->rxBufferType != \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca72077515f40a300c29899b5a3ba48682}{TLS\_TYPE\_HANDSHAKE})
320          context->keyUpdateCount = 0;
321 \textcolor{preprocessor}{#endif}
322 
323       \textcolor{comment}{//Pointer to the received data}
324       *\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} = context->rxBuffer + context->rxBufferPos;
325       \textcolor{comment}{//Length, in byte, of the data}
326       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
327       \textcolor{comment}{//Protocol type}
328       *contentType = context->rxBufferType;
329    \}
330 
331    \textcolor{comment}{//Return status code}
332    \textcolor{keywordflow}{return} error;
333 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record_8h_a06f4c3b4d5b71bc89eac46ffa49e52f9}\label{tls__record_8h_a06f4c3b4d5b71bc89eac46ffa49e52f9}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Read\+Record@{tls\+Read\+Record}}
\index{tls\+Read\+Record@{tls\+Read\+Record}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Read\+Record()}{tlsReadRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Read\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{size,  }\item[{size\+\_\+t $\ast$}]{length,  }\item[{\hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type} $\ast$}]{content\+Type }\end{DoxyParamCaption})}



Receive a T\+LS record. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt out}  & {\em data} & Buffer where to store the record data \\
\hline
\mbox{\tt in}  & {\em size} & Maximum acceptable size for the incoming record \\
\hline
\mbox{\tt out}  & {\em length} & Length of the record data \\
\hline
\mbox{\tt out}  & {\em content\+Type} & Record type \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 450 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
452 \{
453    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
454    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
455    \hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *record;
456 
457    \textcolor{comment}{//Initialize status code}
458    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
459 
460    \textcolor{comment}{//Point to the buffer where to store the incoming TLS record}
461    record = (\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *) \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
462 
463    \textcolor{comment}{//Receive process}
464    \textcolor{keywordflow}{while}(!error)
465    \{
466       \textcolor{comment}{//Read as much data as possible}
467       \textcolor{keywordflow}{if}(context->rxRecordPos < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}))
468       \{
469          \textcolor{comment}{//Make sure that the buffer is large enough to hold the record header}
470          \textcolor{keywordflow}{if}(size >= \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}))
471          \{
472             \textcolor{comment}{//Total number of bytes that have been received}
473             n = 0;
474 
475             \textcolor{comment}{//Read TLS record header}
476             error = context->socketReceiveCallback(context->socketHandle,
477                \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} + context->rxRecordPos,
478                \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}) - context->rxRecordPos, &n, 0);
479 
480             \textcolor{comment}{//Check status code}
481             \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == 
      \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
482             \{
483                \textcolor{comment}{//Advance data pointer}
484                context->rxRecordPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
485 
486                \textcolor{comment}{//TLS record header successfully received?}
487                \textcolor{keywordflow}{if}(context->rxRecordPos >= \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}))
488                \{
489                   \textcolor{comment}{//Debug message}
490                   \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Record header received:\(\backslash\)r\(\backslash\)n"});
491                   \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, \textcolor{keyword}{sizeof}(
      \hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
492 
493                   \textcolor{comment}{//Retrieve the length of the TLS record}
494                   context->rxRecordLen = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}) + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length);
495                \}
496             \}
497             \textcolor{keywordflow}{else}
498             \{
499                \textcolor{comment}{//The read operation has failed}
500                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cacf545b4d693b270f9d01d54d86efedc2}{ERROR\_READ\_FAILED};
501             \}
502          \}
503          \textcolor{keywordflow}{else}
504          \{
505             \textcolor{comment}{//Report an error}
506             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cacb4ee8addfac0a3444278066663c368a}{ERROR\_RECORD\_OVERFLOW};
507          \}
508       \}
509       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->rxRecordPos < context->rxRecordLen)
510       \{
511          \textcolor{comment}{//Make sure that the buffer is large enough to hold the entire record}
512          \textcolor{keywordflow}{if}(size >= context->rxRecordLen)
513          \{
514             \textcolor{comment}{//Total number of bytes that have been received}
515             n = 0;
516 
517             \textcolor{comment}{//Read TLS record contents}
518             error = context->socketReceiveCallback(context->socketHandle,
519                \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} + context->rxRecordPos,
520                context->rxRecordLen - context->rxRecordPos, &n, 0);
521 
522             \textcolor{comment}{//Check status code}
523             \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == 
      \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
524             \{
525                \textcolor{comment}{//Advance data pointer}
526                context->rxRecordPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
527             \}
528             \textcolor{keywordflow}{else}
529             \{
530                \textcolor{comment}{//The read operation has failed}
531                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cacf545b4d693b270f9d01d54d86efedc2}{ERROR\_READ\_FAILED};
532             \}
533          \}
534          \textcolor{keywordflow}{else}
535          \{
536             \textcolor{comment}{//Report an error}
537             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cacb4ee8addfac0a3444278066663c368a}{ERROR\_RECORD\_OVERFLOW};
538          \}
539       \}
540       \textcolor{keywordflow}{else}
541       \{
542          \textcolor{comment}{//Process the incoming TLS record}
543          error = \hyperlink{tls__record_8c_a78f759de93bd2ad27efdd0375fcedfbb}{tlsProcessRecord}(context, record);
544 
545          \textcolor{comment}{//Check status code}
546          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
547          \{
548             \textcolor{comment}{//Actual length of the record data}
549             *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length);
550             \textcolor{comment}{//Record type}
551             *contentType = (\hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{TlsContentType}) record->type;
552 
553             \textcolor{comment}{//Debug message}
554             \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"TLS record received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, *
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
555             \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} + \textcolor{keyword}{sizeof}(
      \hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
556 
557             \textcolor{comment}{//Discard record header}
558             memmove(\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, record->data, *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
559 
560             \textcolor{comment}{//Prepare to receive the next TLS record}
561             context->rxRecordLen = 0;
562             context->rxRecordPos = 0;
563 
564             \textcolor{comment}{//We are done}
565             \textcolor{keywordflow}{break};
566          \}
567 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
568          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5e1d50ad3e2e1310d0414656ca3e7bde}{ERROR\_BAD\_RECORD\_MAC})
569          \{
570              \hyperlink{debug_8h_aaf9a5c67ad0ffd97cfca6d77c6af536f}{TRACE\_ERROR}(\textcolor{stringliteral}{"MAYBE FIX\(\backslash\)r\(\backslash\)n"});
571             \textcolor{comment}{//Check current state}
572             \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_ab44dc642afbfbd72926ab1f94634cd4d}{TLS\_VERSION\_1\_3} &&
573                context->entity == \hyperlink{tls_8h_acb21bc158664d823d899d760edd8135ba3ddde9cb0be1b78b5b7e1e2ba1704a44}{TLS\_CONNECTION\_END\_SERVER} &&
574                context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da3cb415075672864bb35731a372a18fbd}{TLS\_STATE\_CLIENT\_FINISHED} &&
575                context->rxBufferLen == 0)
576             \{
577                 \hyperlink{debug_8h_aaf9a5c67ad0ffd97cfca6d77c6af536f}{TRACE\_ERROR}(\textcolor{stringliteral}{"MAYBE FIX 1\(\backslash\)r\(\backslash\)n"});
578                \textcolor{comment}{//Early data received?}
579                \textcolor{keywordflow}{if}(!context->updatedClientHelloReceived &&
580                   context->earlyDataExtReceived)
581                \{
582                    \hyperlink{debug_8h_aaf9a5c67ad0ffd97cfca6d77c6af536f}{TRACE\_ERROR}(\textcolor{stringliteral}{"MAYBE FIX 2\(\backslash\)r\(\backslash\)n"});
583                   \textcolor{comment}{//Amount of 0-RTT data received by the server}
584                   context->earlyDataLen += \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length);
585 
586                   \textcolor{comment}{//Discard records which fail deprotection (up to the configured}
587                   \textcolor{comment}{//max\_early\_data\_size)}
588                   \textcolor{keywordflow}{if}(context->earlyDataLen <= context->maxEarlyDataSize)
589                   \{
590                       \hyperlink{debug_8h_aaf9a5c67ad0ffd97cfca6d77c6af536f}{TRACE\_ERROR}(\textcolor{stringliteral}{"FIX\(\backslash\)r\(\backslash\)n"});
591                      \textcolor{comment}{//Debug message}
592                      \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Discarding early data (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
593                         \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length));
594 
595                      \textcolor{comment}{//Prepare to receive the next TLS record}
596                      context->rxRecordLen = 0;
597                      context->rxRecordPos = 0;
598 
599                      \textcolor{comment}{//Catch exception}
600                      error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
601                      
602                   \}
603                \}
604             \}
605          \}
606 \textcolor{preprocessor}{#endif}
607          \textcolor{keywordflow}{else}
608          \{
609             \textcolor{comment}{//Invalid record received}
610          \}
611       \}
612    \}
613 
614    \textcolor{comment}{//Return status code}
615    \textcolor{keywordflow}{return} error;
616 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record_8h_a956295a326cb475d6e9ad935a91690af}\label{tls__record_8h_a956295a326cb475d6e9ad935a91690af}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Set\+Record\+Length@{tls\+Set\+Record\+Length}}
\index{tls\+Set\+Record\+Length@{tls\+Set\+Record\+Length}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Set\+Record\+Length()}{tlsSetRecordLength()}}
{\footnotesize\ttfamily void tls\+Set\+Record\+Length (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{void $\ast$}]{record,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Set T\+LS record length. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em record} & Pointer to the T\+LS record \\
\hline
\mbox{\tt in}  & {\em length} & Record length \\
\hline
\end{DoxyParams}


Definition at line 815 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
816 \{
817 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
818    \textcolor{comment}{//DTLS protocol?}
819    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
820    \{
821       \textcolor{comment}{//Set the length of the DTLS record}
822       ((\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) record)->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
823    \}
824    \textcolor{keywordflow}{else}
825 \textcolor{preprocessor}{#endif}
826    \textcolor{comment}{//TLS protocol?}
827    \{
828       \textcolor{comment}{//Set the length of the DTLS record}
829       ((\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *) record)->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
830    \}
831 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record_8h_a2ca833f61cd4672cd6dc3cf323e33a06}\label{tls__record_8h_a2ca833f61cd4672cd6dc3cf323e33a06}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Set\+Record\+Type@{tls\+Set\+Record\+Type}}
\index{tls\+Set\+Record\+Type@{tls\+Set\+Record\+Type}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Set\+Record\+Type()}{tlsSetRecordType()}}
{\footnotesize\ttfamily void tls\+Set\+Record\+Type (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{void $\ast$}]{record,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{type }\end{DoxyParamCaption})}



Set T\+LS record type. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em record} & Pointer to the T\+LS record \\
\hline
\mbox{\tt in}  & {\em type} & Record type \\
\hline
\end{DoxyParams}


Definition at line 758 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
759 \{
760 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
761    \textcolor{comment}{//DTLS protocol?}
762    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
763    \{
764       \textcolor{comment}{//Set the type of the DTLS record}
765       ((\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) record)->type = \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type};
766    \}
767    \textcolor{keywordflow}{else}
768 \textcolor{preprocessor}{#endif}
769    \textcolor{comment}{//TLS protocol?}
770    \{
771       \textcolor{comment}{//Set the type of the DTLS record}
772       ((\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *) record)->type = \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type};
773    \}
774 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record_8h_ae8f8c035d23eb99d1d5642d4ce644715}\label{tls__record_8h_ae8f8c035d23eb99d1d5642d4ce644715}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Write\+Protocol\+Data@{tls\+Write\+Protocol\+Data}}
\index{tls\+Write\+Protocol\+Data@{tls\+Write\+Protocol\+Data}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Write\+Protocol\+Data()}{tlsWriteProtocolData()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Write\+Protocol\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{length,  }\item[{\hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type}}]{content\+Type }\end{DoxyParamCaption})}



Write protocol data. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to the data buffer \\
\hline
\mbox{\tt in}  & {\em length} & Number of data bytes to be written \\
\hline
\mbox{\tt in}  & {\em content\+Type} & Higher level protocol \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 55 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
57 \{
58    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
59    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
60    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
61 
62    \textcolor{comment}{//Initialize status code}
63    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
64 
65    \textcolor{comment}{//Fragmentation process}
66    \textcolor{keywordflow}{while}(!error)
67    \{
68       \textcolor{keywordflow}{if}(context->txBufferLen == 0)
69       \{
70          \textcolor{comment}{//Check the length of the data}
71          \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} > context->txBufferMaxLen)
72          \{
73             \textcolor{comment}{//Report an error}
74             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca67f2e3bde0b243044afa635130f722cf}{ERROR\_MESSAGE\_TOO\_LONG};
75          \}
76          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} > 0)
77          \{
78             \textcolor{comment}{//Make room for the encryption overhead}
79             memmove(context->txBuffer + context->txBufferSize - \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, 
      \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data},
80                \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
81 
82             \textcolor{comment}{//Save record type}
83             context->txBufferType = contentType;
84             \textcolor{comment}{//Set the length of the buffer}
85             context->txBufferLen = \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
86             \textcolor{comment}{//Point to the beginning of the buffer}
87             context->txBufferPos = 0;
88          \}
89          \textcolor{keywordflow}{else}
90          \{
91             \textcolor{comment}{//We are done}
92             \textcolor{keywordflow}{break};
93          \}
94       \}
95       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->txBufferPos < context->txBufferLen)
96       \{
97          \textcolor{comment}{//Number of bytes left to send}
98          n = context->txBufferLen - context->txBufferPos;
99          \textcolor{comment}{//Point to the current fragment}
100          p = context->txBuffer + context->txBufferSize - \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
101 
102          \textcolor{comment}{//The record length must not exceed 16384 bytes}
103          n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(n, \hyperlink{tls_8h_a87485283e0c2c0a9b1b3e5ef9df52975}{TLS\_MAX\_RECORD\_LENGTH});
104 
105 \textcolor{preprocessor}{#if (TLS\_MAX\_FRAG\_LEN\_SUPPORT == ENABLED)}
106          \textcolor{comment}{//Do not exceed the negotiated maximum fragment length}
107          n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(n, context->maxFragLen);
108 \textcolor{preprocessor}{#endif}
109 
110 \textcolor{preprocessor}{#if (TLS\_RECORD\_SIZE\_LIMIT\_SUPPORT == ENABLED)}
111          \textcolor{comment}{//The value of RecordSizeLimit is used to limit the size of records}
112          \textcolor{comment}{//that are created when encoding application data and the protected}
113          \textcolor{comment}{//handshake message into records}
114          \textcolor{keywordflow}{if}(context->encryptionEngine.cipherMode != \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af2b260457a3fa53d37ac1701c7b6502e}{CIPHER\_MODE\_NULL} ||
115             context->encryptionEngine.hashAlgo != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
116          \{
117             \textcolor{comment}{//An endpoint must not generate a protected record with plaintext}
118             \textcolor{comment}{//that is larger than the RecordSizeLimit value it receives from}
119             \textcolor{comment}{//its peer (refer to RFC 8449, section 4)}
120             n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(n, context->encryptionEngine.recordSizeLimit);
121          \}
122 \textcolor{preprocessor}{#endif}
123          \textcolor{comment}{//Send TLS record}
124          error = \hyperlink{tls__record_8c_aa0d9e0c356cf90b2f8c0cc986a0702bb}{tlsWriteRecord}(context, p, n, context->txBufferType);
125 
126          \textcolor{comment}{//Check status code}
127          \textcolor{keywordflow}{if}(!error)
128          \{
129             \textcolor{comment}{//Advance data pointer}
130             context->txBufferPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
131          \}
132       \}
133       \textcolor{keywordflow}{else}
134       \{
135          \textcolor{comment}{//Prepare to send new protocol data}
136          context->txBufferLen = 0;
137          context->txBufferPos = 0;
138 
139          \textcolor{comment}{//We are done}
140          \textcolor{keywordflow}{break};
141       \}
142    \}
143 
144    \textcolor{comment}{//Return status code}
145    \textcolor{keywordflow}{return} error;
146 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record_8h_aa0d9e0c356cf90b2f8c0cc986a0702bb}\label{tls__record_8h_aa0d9e0c356cf90b2f8c0cc986a0702bb}} 
\index{tls\+\_\+record.\+h@{tls\+\_\+record.\+h}!tls\+Write\+Record@{tls\+Write\+Record}}
\index{tls\+Write\+Record@{tls\+Write\+Record}!tls\+\_\+record.\+h@{tls\+\_\+record.\+h}}
\subsubsection{\texorpdfstring{tls\+Write\+Record()}{tlsWriteRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Write\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{length,  }\item[{\hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type}}]{content\+Type }\end{DoxyParamCaption})}



Send a T\+LS record. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to the record data \\
\hline
\mbox{\tt in}  & {\em length} & Length of the record data \\
\hline
\mbox{\tt in}  & {\em content\+Type} & Record type \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 345 of file tls\+\_\+record.\+c.


\begin{DoxyCode}
347 \{
348    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
349    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
350    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} legacyVersion;
351    \hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *record;
352    \hyperlink{structTlsEncryptionEngine}{TlsEncryptionEngine} *encryptionEngine;
353 
354    \textcolor{comment}{//Point to the encryption engine}
355    encryptionEngine = &context->encryptionEngine;
356 
357    \textcolor{comment}{//Point to the TLS record}
358    record = (\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *) context->txBuffer;
359 
360    \textcolor{comment}{//Initialize status code}
361    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
362 
363    \textcolor{comment}{//Send process}
364    \textcolor{keywordflow}{while}(!error)
365    \{
366       \textcolor{comment}{//Send as much data as possible}
367       \textcolor{keywordflow}{if}(context->txRecordLen == 0)
368       \{
369          \textcolor{comment}{//The record version must be set to 0x0303 for all records generated}
370          \textcolor{comment}{//by a TLS 1.3 implementation other than an initial ClientHello}
371          legacyVersion = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(context->version, \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2});
372 
373          \textcolor{comment}{//Format TLS record}
374          record->type = contentType;
375          record->version = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(legacyVersion);
376          record->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
377 
378          \textcolor{comment}{//Copy record data}
379          memmove(record->data, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
380 
381          \textcolor{comment}{//Debug message}
382          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Sending TLS record (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
383          \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} + \textcolor{keyword}{sizeof}(
      \hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
384 
385          \textcolor{comment}{//Protect record payload?}
386          \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} != \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af2b260457a3fa53d37ac1701c7b6502e}{CIPHER\_MODE\_NULL} ||
387             encryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
388          \{
389             \textcolor{comment}{//Encrypt TLS record}
390             error = \hyperlink{tls__record__encryption_8c_a570ea69586ebaeac3279b864b4630a02}{tlsEncryptRecord}(context, encryptionEngine, record);
391          \}
392 
393          \textcolor{comment}{//Check status code}
394          \textcolor{keywordflow}{if}(!error)
395          \{
396             \textcolor{comment}{//Actual length of the record data}
397             context->txRecordLen = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}) + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length);
398             \textcolor{comment}{//Point to the beginning of the record}
399             context->txRecordPos = 0;
400          \}
401       \}
402       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->txRecordPos < context->txRecordLen)
403       \{
404          \textcolor{comment}{//Total number of bytes that have been written}
405          n = 0;
406 
407          \textcolor{comment}{//Send more data}
408          error = context->socketSendCallback(context->socketHandle,
409             context->txBuffer + context->txRecordPos,
410             context->txRecordLen - context->txRecordPos, &n, 0);
411 
412          \textcolor{comment}{//Check status code}
413          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == 
      \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
414          \{
415             \textcolor{comment}{//Advance data pointer}
416             context->txRecordPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
417          \}
418          \textcolor{keywordflow}{else}
419          \{
420             \textcolor{comment}{//The write operation has failed}
421             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca7446f962c635e715f75bc4aff05feb77}{ERROR\_WRITE\_FAILED};
422          \}
423       \}
424       \textcolor{keywordflow}{else}
425       \{
426          \textcolor{comment}{//Prepare to send the next TLS record}
427          context->txRecordLen = 0;
428          context->txRecordPos = 0;
429 
430          \textcolor{comment}{//We are done}
431          \textcolor{keywordflow}{break};
432       \}
433    \}
434 
435    \textcolor{comment}{//Return status code}
436    \textcolor{keywordflow}{return} error;
437 \}
\end{DoxyCode}
