\hypertarget{tls__server_8c}{}\section{cyclone\+\_\+ssl/tls\+\_\+server.c File Reference}
\label{tls__server_8c}\index{cyclone\+\_\+ssl/tls\+\_\+server.\+c@{cyclone\+\_\+ssl/tls\+\_\+server.\+c}}


Handshake message processing (T\+LS server)  


{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include \char`\"{}tls.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+cipher\+\_\+suites.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+handshake.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+server.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+server\+\_\+extensions.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+server\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+common.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+extensions.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+signature.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+key\+\_\+material.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+transcript\+\_\+hash.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+cache.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+ffdhe.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+record.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls13\+\_\+server.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls13\+\_\+server\+\_\+extensions.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls13\+\_\+server\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dtls\+\_\+record.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dtls\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}pkix/pem\+\_\+import.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}pkix/x509\+\_\+cert\+\_\+parse.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}date\+\_\+time.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{tls__server_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{tls__config_8h_afee42a623033dac888291d1993985206}{T\+L\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server_8c_a67975b6b6f060d494e01cc75e171fecf}{tls\+Send\+Server\+Hello} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Send Server\+Hello message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server_8c_a5b4084306cc9d8e1d083e272cd98aef1}{tls\+Send\+Server\+Key\+Exchange} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Send Server\+Key\+Exchange message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server_8c_a5f8b0853322153b88ff07e7bea633835}{tls\+Send\+Certificate\+Request} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Send Certificate\+Request message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server_8c_a1bc3bb08a169817c6105f9f5f13f58ac}{tls\+Send\+Server\+Hello\+Done} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Send Server\+Hello\+Done message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server_8c_a4d8dee25b92b399334e45683b466f403}{tls\+Format\+Server\+Hello} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{tls_8h_a3b37d03b4f71ce65b23f369d2040a245}{Tls\+Server\+Hello} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Format Server\+Hello message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server_8c_ae9133776b8d42f0da84f6b8446448069}{tls\+Format\+Server\+Key\+Exchange} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{tls_8h_a69c0b3ab7349e73b2e8f9452dbdfef5a}{Tls\+Server\+Key\+Exchange} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Format Server\+Key\+Exchange message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server_8c_a422aa0a39a41b30d586a06b9d42dbbdf}{tls\+Format\+Certificate\+Request} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{tls_8h_a207a823320ed0904352de25ac220b5d8}{Tls\+Certificate\+Request} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Format Certificate\+Request message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server_8c_ac2375898dec7aa0ceaff2faefd467f76}{tls\+Format\+Server\+Hello\+Done} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{tls_8h_a71e29f87ab91f2adb5655ad8157e7aea}{Tls\+Server\+Hello\+Done} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Format Server\+Hello\+Done message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server_8c_a38ce6b990031f07a875c795599ccd5d4}{tls\+Parse\+Client\+Hello} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{tls_8h_ac78d39e638430eb19c4017e5f9797d16}{Tls\+Client\+Hello} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Parse Client\+Hello message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server_8c_a204fb38ba0d5de7703844660c79e0b40}{tls\+Parse\+Client\+Key\+Exchange} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{tls_8h_a88521372020709c027828954c0208b8f}{Tls\+Client\+Key\+Exchange} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Parse Client\+Key\+Exchange message. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Handshake message processing (T\+LS server) 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+S\+SL Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.\hypertarget{tftp__server_8c_Description}{}\subsection{Description}\label{tftp__server_8c_Description}
The T\+LS protocol provides communications security over the Internet. The protocol allows client/server applications to communicate in a way that is designed to prevent eavesdropping, tampering, or message forgery

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{tls__server_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{tls__server_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{tls\+\_\+server.\+c@{tls\+\_\+server.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!tls\+\_\+server.\+c@{tls\+\_\+server.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{tls__config_8h_afee42a623033dac888291d1993985206}{T\+L\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 38 of file tls\+\_\+server.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{tls__server_8c_a422aa0a39a41b30d586a06b9d42dbbdf}\label{tls__server_8c_a422aa0a39a41b30d586a06b9d42dbbdf}} 
\index{tls\+\_\+server.\+c@{tls\+\_\+server.\+c}!tls\+Format\+Certificate\+Request@{tls\+Format\+Certificate\+Request}}
\index{tls\+Format\+Certificate\+Request@{tls\+Format\+Certificate\+Request}!tls\+\_\+server.\+c@{tls\+\_\+server.\+c}}
\subsubsection{\texorpdfstring{tls\+Format\+Certificate\+Request()}{tlsFormatCertificateRequest()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Format\+Certificate\+Request (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{tls_8h_a207a823320ed0904352de25ac220b5d8}{Tls\+Certificate\+Request} $\ast$}]{message,  }\item[{size\+\_\+t $\ast$}]{length }\end{DoxyParamCaption})}



Format Certificate\+Request message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt out}  & {\em message} & Buffer where to format the Certificate\+Request message \\
\hline
\mbox{\tt out}  & {\em length} & Length of the resulting Certificate\+Request message \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 802 of file tls\+\_\+server.\+c.


\begin{DoxyCode}
804 \{
805    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
806    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
807    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
808 
809    \textcolor{comment}{//Initialize status code}
810    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
811 
812    \textcolor{comment}{//Point to the beginning of the message}
813    p = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
814 
815 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
816    \textcolor{comment}{//Version of TLS prior to TLS 1.3?}
817    \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
818    \{
819       \textcolor{keywordtype}{size\_t} pemCertLen;
820       \textcolor{keyword}{const} \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{demo_2microchip_2pic32mz__ef__curiosity_2wifi__http__server__demo_2src_2main_8c_a52d999bffef4c5d89345bd0ce7d91042}{trustedCaList};
821       \textcolor{keywordtype}{size\_t} trustedCaListLen;
822       \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *derCert;
823       \textcolor{keywordtype}{size\_t} derCertLen;
824       \hyperlink{structX509CertificateInfo}{X509CertificateInfo} *certInfo;
825       \hyperlink{tls_8h_a96ef533723d450ad6c4903a78c756f9e}{TlsCertAuthorities} *certAuthorities;
826 
827       \textcolor{comment}{//Enumerate the types of certificate types that the client may offer}
828       n = 0;
829 
830 \textcolor{preprocessor}{#if (TLS\_RSA\_SIGN\_SUPPORT == ENABLED || TLS\_RSA\_PSS\_SIGN\_SUPPORT == ENABLED)}
831       \textcolor{comment}{//Accept certificates that contain an RSA public key}
832       \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->certificateTypes[n++] = \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda3a76023fc80c787bffed357a4560351b}{TLS\_CERT\_RSA\_SIGN};
833 \textcolor{preprocessor}{#endif}
834 \textcolor{preprocessor}{#if (TLS\_DSA\_SIGN\_SUPPORT == ENABLED)}
835       \textcolor{comment}{//Accept certificates that contain a DSA public key}
836       \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->certificateTypes[n++] = \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda925aea3c96483609ae2867b10693b4c4}{TLS\_CERT\_DSS\_SIGN};
837 \textcolor{preprocessor}{#endif}
838 \textcolor{preprocessor}{#if (TLS\_ECDSA\_SIGN\_SUPPORT == ENABLED)}
839       \textcolor{comment}{//Accept certificates that contain an ECDSA public key}
840       \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->certificateTypes[n++] = \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffdab47f2dd2c4d36761f920f8a1af97f6ec}{TLS\_CERT\_ECDSA\_SIGN};
841 \textcolor{preprocessor}{#endif}
842 
843       \textcolor{comment}{//Fix the length of the list}
844       \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->certificateTypesLen = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) n;
845       \textcolor{comment}{//Length of the handshake message}
846       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a207a823320ed0904352de25ac220b5d8}{TlsCertificateRequest}) + n;
847 
848       \textcolor{comment}{//TLS 1.2 currently selected?}
849       \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
850       \{
851          \hyperlink{tls_8h_a52f8ea223987ee1e857b6687f38d3888}{TlsSignHashAlgos} *supportedSignAlgos;
852 
853          \textcolor{comment}{//Point to the list of the hash/signature algorithm pairs that the server}
854          \textcolor{comment}{//is able to verify. Servers can minimize the computation cost by offering}
855          \textcolor{comment}{//a restricted set of digest algorithms}
856          supportedSignAlgos = \hyperlink{os__port_8h_ab20fce5a8cce390611c29101c2e48dd9}{PTR\_OFFSET}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
857 
858          \textcolor{comment}{//Enumerate the hash/signature algorithm pairs in descending}
859          \textcolor{comment}{//order of preference}
860          n = 0;
861 
862 \textcolor{preprocessor}{#if (TLS\_SHA256\_SUPPORT == ENABLED)}
863          \textcolor{comment}{//The hash algorithm used for PRF operations can also be used for signing}
864          \textcolor{keywordflow}{if}(context->cipherSuite.prfHashAlgo == \hyperlink{sha256_8h_ac65e86d6ed85707af5486ff4d9f87c71}{SHA256\_HASH\_ALGO})
865          \{
866 \textcolor{preprocessor}{#if (TLS\_ECDSA\_SIGN\_SUPPORT == ENABLED)}
867             \textcolor{comment}{//ECDSA signature algorithm with SHA-256}
868             supportedSignAlgos->value[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}].signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a47f4ec2313cd5ce1755fc2485cfdd49a}{TLS\_SIGN\_ALGO\_ECDSA};
869             supportedSignAlgos->value[n++].hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156da7912aa0ea6b40af839a3d4be331fe182}{TLS\_HASH\_ALGO\_SHA256};
870 \textcolor{preprocessor}{#endif}
871 \textcolor{preprocessor}{#if (TLS\_RSA\_PSS\_SIGN\_SUPPORT == ENABLED)}
872             \textcolor{comment}{//Check whether the X.509 parser supports RSA-PSS signatures}
873             \textcolor{keywordflow}{if}(\hyperlink{certificate_2x509__common_8c_ab4fb04ff1cc1ecd24548e967fb7acb5a}{x509IsSignAlgoSupported}(
      \hyperlink{certificate_2x509__common_8h_ac7f323ef3436e8cc3a89862a5e818078ae780ed4bee657c707e10479fc8f55c0a}{X509\_SIGN\_ALGO\_RSA\_PSS}))
874             \{
875                \textcolor{comment}{//RSASSA-PSS PSS signature algorithm with SHA-256}
876                supportedSignAlgos->value[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}].signature = 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ad23a08f2a2e5d3231cc9c2ce2e223a8d}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA256};
877                supportedSignAlgos->value[n++].hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156dab77721d4496c39c41f5984cfd7515882}{TLS\_HASH\_ALGO\_INTRINSIC};
878             \}
879 \textcolor{preprocessor}{#endif}
880 \textcolor{preprocessor}{#if (TLS\_RSA\_PSS\_SIGN\_SUPPORT == ENABLED)}
881             \textcolor{comment}{//RSASSA-PSS RSAE signature algorithm with SHA-256}
882             supportedSignAlgos->value[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}].signature = 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ae82458ac6b05ba0e3851a5804f7d5e57}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA256};
883             supportedSignAlgos->value[n++].hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156dab77721d4496c39c41f5984cfd7515882}{TLS\_HASH\_ALGO\_INTRINSIC};
884 \textcolor{preprocessor}{#endif}
885 \textcolor{preprocessor}{#if (TLS\_RSA\_SIGN\_SUPPORT == ENABLED)}
886             \textcolor{comment}{//RSASSA-PKCS1-v1\_5 signature algorithm with SHA-256}
887             supportedSignAlgos->value[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}].signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a84a0f0f40c0affb557a7e5f157b4e1f5}{TLS\_SIGN\_ALGO\_RSA};
888             supportedSignAlgos->value[n++].hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156da7912aa0ea6b40af839a3d4be331fe182}{TLS\_HASH\_ALGO\_SHA256};
889 \textcolor{preprocessor}{#endif}
890 \textcolor{preprocessor}{#if (TLS\_DSA\_SIGN\_SUPPORT == ENABLED)}
891             \textcolor{comment}{//DSA signature algorithm with SHA-256}
892             supportedSignAlgos->value[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}].signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a8d024e93d33282e5cb2a1665fb69153d}{TLS\_SIGN\_ALGO\_DSA};
893             supportedSignAlgos->value[n++].hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156da7912aa0ea6b40af839a3d4be331fe182}{TLS\_HASH\_ALGO\_SHA256};
894 \textcolor{preprocessor}{#endif}
895          \}
896 \textcolor{preprocessor}{#endif}
897 
898 \textcolor{preprocessor}{#if (TLS\_SHA384\_SUPPORT == ENABLED)}
899          \textcolor{comment}{//The hash algorithm used for PRF operations can also be used for signing}
900          \textcolor{keywordflow}{if}(context->cipherSuite.prfHashAlgo == \hyperlink{sha384_8h_a3dd6226e61249284db3162706a53ea39}{SHA384\_HASH\_ALGO})
901          \{
902 \textcolor{preprocessor}{#if (TLS\_ECDSA\_SIGN\_SUPPORT == ENABLED)}
903             \textcolor{comment}{//ECDSA signature algorithm with SHA-384}
904             supportedSignAlgos->value[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}].signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a47f4ec2313cd5ce1755fc2485cfdd49a}{TLS\_SIGN\_ALGO\_ECDSA};
905             supportedSignAlgos->value[n++].hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156da53b125010bbd797aa333a41bd1264edb}{TLS\_HASH\_ALGO\_SHA384};
906 \textcolor{preprocessor}{#endif}
907 \textcolor{preprocessor}{#if (TLS\_RSA\_PSS\_SIGN\_SUPPORT == ENABLED)}
908             \textcolor{comment}{//Check whether the X.509 parser supports RSA-PSS signatures}
909             \textcolor{keywordflow}{if}(\hyperlink{certificate_2x509__common_8c_ab4fb04ff1cc1ecd24548e967fb7acb5a}{x509IsSignAlgoSupported}(
      \hyperlink{certificate_2x509__common_8h_ac7f323ef3436e8cc3a89862a5e818078ae780ed4bee657c707e10479fc8f55c0a}{X509\_SIGN\_ALGO\_RSA\_PSS}))
910             \{
911                \textcolor{comment}{//RSASSA-PSS PSS signature algorithm with SHA-384}
912                supportedSignAlgos->value[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}].signature = 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aeb67836989d29de8af7c31ea0ddbe1b7}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA384};
913                supportedSignAlgos->value[n++].hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156dab77721d4496c39c41f5984cfd7515882}{TLS\_HASH\_ALGO\_INTRINSIC};
914             \}
915 \textcolor{preprocessor}{#endif}
916 \textcolor{preprocessor}{#if (TLS\_RSA\_PSS\_SIGN\_SUPPORT == ENABLED)}
917             \textcolor{comment}{//RSASSA-PSS RSAE signature algorithm with SHA-384}
918             supportedSignAlgos->value[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}].signature = 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aef95b8f001c19481fef0409a91b56ce4}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA384};
919             supportedSignAlgos->value[n++].hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156dab77721d4496c39c41f5984cfd7515882}{TLS\_HASH\_ALGO\_INTRINSIC};
920 \textcolor{preprocessor}{#endif}
921 \textcolor{preprocessor}{#if (TLS\_RSA\_SIGN\_SUPPORT == ENABLED)}
922             \textcolor{comment}{//RSASSA-PKCS1-v1\_5 signature algorithm with SHA-384}
923             supportedSignAlgos->value[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}].signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a84a0f0f40c0affb557a7e5f157b4e1f5}{TLS\_SIGN\_ALGO\_RSA};
924             supportedSignAlgos->value[n++].hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156da53b125010bbd797aa333a41bd1264edb}{TLS\_HASH\_ALGO\_SHA384};
925 \textcolor{preprocessor}{#endif}
926          \}
927 \textcolor{preprocessor}{#endif}
928 
929 \textcolor{preprocessor}{#if (TLS\_SHA1\_SUPPORT == ENABLED)}
930 \textcolor{preprocessor}{#if (TLS\_ECDSA\_SIGN\_SUPPORT == ENABLED)}
931          \textcolor{comment}{//ECDSA signature algorithm with SHA-1}
932          supportedSignAlgos->value[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}].signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a47f4ec2313cd5ce1755fc2485cfdd49a}{TLS\_SIGN\_ALGO\_ECDSA};
933          supportedSignAlgos->value[n++].hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156daf10e82baa9d43e28ef949fd55fcfb65f}{TLS\_HASH\_ALGO\_SHA1};
934 \textcolor{preprocessor}{#endif}
935 \textcolor{preprocessor}{#if (TLS\_RSA\_SIGN\_SUPPORT == ENABLED)}
936          \textcolor{comment}{//RSASSA-PKCS1-v1\_5 signature algorithm with SHA-1}
937          supportedSignAlgos->value[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}].signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a84a0f0f40c0affb557a7e5f157b4e1f5}{TLS\_SIGN\_ALGO\_RSA};
938          supportedSignAlgos->value[n++].hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156daf10e82baa9d43e28ef949fd55fcfb65f}{TLS\_HASH\_ALGO\_SHA1};
939 \textcolor{preprocessor}{#endif}
940 \textcolor{preprocessor}{#if (TLS\_DSA\_SIGN\_SUPPORT == ENABLED)}
941          \textcolor{comment}{//DSA signature algorithm with SHA-1}
942          supportedSignAlgos->value[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}].signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a8d024e93d33282e5cb2a1665fb69153d}{TLS\_SIGN\_ALGO\_DSA};
943          supportedSignAlgos->value[n++].hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156daf10e82baa9d43e28ef949fd55fcfb65f}{TLS\_HASH\_ALGO\_SHA1};
944 \textcolor{preprocessor}{#endif}
945 \textcolor{preprocessor}{#endif}
946          \textcolor{comment}{//Fix the length of the list}
947          supportedSignAlgos->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(n * \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a5c96bca6675e08f0abe6e3efb0a78eb3}{TlsSignHashAlgo}));
948          \textcolor{comment}{//Adjust the length of the message}
949          *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a52f8ea223987ee1e857b6687f38d3888}{TlsSignHashAlgos}) + n * \textcolor{keyword}{sizeof}(
      \hyperlink{tls_8h_a5c96bca6675e08f0abe6e3efb0a78eb3}{TlsSignHashAlgo});
950       \}
951 
952       \textcolor{comment}{//Point to the list of the distinguished names of acceptable certificate}
953       \textcolor{comment}{//authorities}
954       certAuthorities = \hyperlink{os__port_8h_ab20fce5a8cce390611c29101c2e48dd9}{PTR\_OFFSET}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
955       \textcolor{comment}{//Adjust the length of the message}
956       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a96ef533723d450ad6c4903a78c756f9e}{TlsCertAuthorities});
957 
958       \textcolor{comment}{//Point to the first certificate authority}
959       p = certAuthorities->value;
960       \textcolor{comment}{//Length of the list in bytes}
961       n = 0;
962 
963       \textcolor{comment}{//Point to the first trusted CA certificate}
964       trustedCaList = context->trustedCaList;
965       \textcolor{comment}{//Get the total length, in bytes, of the trusted CA list}
966       trustedCaListLen = context->trustedCaListLen;
967 
968       \textcolor{comment}{//Allocate a memory buffer to store X.509 certificate info}
969       certInfo = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structX509CertificateInfo}{X509CertificateInfo}));
970 
971       \textcolor{comment}{//Successful memory allocation?}
972       \textcolor{keywordflow}{if}(certInfo != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
973       \{
974          \textcolor{comment}{//Loop through the list of trusted CA certificates}
975          \textcolor{keywordflow}{while}(trustedCaListLen > 0 && error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
976          \{
977             \textcolor{comment}{//The first pass calculates the length of the DER-encoded certificate}
978             error = \hyperlink{certificate_2pem__import_8c_a861695b3eda2ba8ca5ea2a5b2715c152}{pemImportCertificate}(trustedCaList, trustedCaListLen, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL},
979                &derCertLen, &pemCertLen);
980 
981             \textcolor{comment}{//Check status code}
982             \textcolor{keywordflow}{if}(!error)
983             \{
984                \textcolor{comment}{//Allocate a memory buffer to hold the DER-encoded certificate}
985                derCert = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(derCertLen);
986 
987                \textcolor{comment}{//Successful memory allocation?}
988                \textcolor{keywordflow}{if}(derCert != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
989                \{
990                   \textcolor{comment}{//The second pass decodes the PEM certificate}
991                   error = \hyperlink{certificate_2pem__import_8c_a861695b3eda2ba8ca5ea2a5b2715c152}{pemImportCertificate}(trustedCaList, trustedCaListLen,
992                      derCert, &derCertLen, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
993 
994                   \textcolor{comment}{//Check status code}
995                   \textcolor{keywordflow}{if}(!error)
996                   \{
997                      \textcolor{comment}{//Parse X.509 certificate}
998                      error = \hyperlink{certificate_2x509__cert__parse_8c_a0c8997b0f608c1fee25bdd281e7c4acb}{x509ParseCertificate}(derCert, derCertLen, certInfo);
999                   \}
1000 
1001                   \textcolor{comment}{//Valid CA certificate?}
1002                   \textcolor{keywordflow}{if}(!error)
1003                   \{
1004                      \textcolor{comment}{//Adjust the length of the message}
1005                      *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += certInfo->\hyperlink{structX509CertificateInfo_acfa4445df39031f204f8936a2eec189e}{tbsCert}.\hyperlink{structX509TbsCertificate_a68e21bffb3f287f4e57378b275e1d178}{subject}.
      \hyperlink{structX509Name_a0f57dd73feee5e3a4aa769fa1ecf3766}{rawDataLen} + 2;
1006 
1007                      \textcolor{comment}{//Sanity check}
1008                      \textcolor{keywordflow}{if}(*length <= context->txBufferMaxLen)
1009                      \{
1010                         \textcolor{comment}{//Each distinguished name is preceded by a 2-byte length field}
1011                         \hyperlink{cpu__endian_8h_a8e657bcdf3842380d2d0006859029240}{STORE16BE}(certInfo->\hyperlink{structX509CertificateInfo_acfa4445df39031f204f8936a2eec189e}{tbsCert}.\hyperlink{structX509TbsCertificate_a68e21bffb3f287f4e57378b275e1d178}{subject}.
      \hyperlink{structX509Name_a0f57dd73feee5e3a4aa769fa1ecf3766}{rawDataLen}, p);
1012 
1013                         \textcolor{comment}{//The distinguished name shall be DER-encoded}
1014                         memcpy(p + 2, certInfo->\hyperlink{structX509CertificateInfo_acfa4445df39031f204f8936a2eec189e}{tbsCert}.\hyperlink{structX509TbsCertificate_a68e21bffb3f287f4e57378b275e1d178}{subject}.
      \hyperlink{structX509Name_a16f889e11f79b38a1ade245692857253}{rawData},
1015                            certInfo->\hyperlink{structX509CertificateInfo_acfa4445df39031f204f8936a2eec189e}{tbsCert}.\hyperlink{structX509TbsCertificate_a68e21bffb3f287f4e57378b275e1d178}{subject}.\hyperlink{structX509Name_a0f57dd73feee5e3a4aa769fa1ecf3766}{rawDataLen});
1016 
1017                         \textcolor{comment}{//Advance write pointer}
1018                         p += certInfo->\hyperlink{structX509CertificateInfo_acfa4445df39031f204f8936a2eec189e}{tbsCert}.\hyperlink{structX509TbsCertificate_a68e21bffb3f287f4e57378b275e1d178}{subject}.\hyperlink{structX509Name_a0f57dd73feee5e3a4aa769fa1ecf3766}{rawDataLen} + 2;
1019                         n += certInfo->\hyperlink{structX509CertificateInfo_acfa4445df39031f204f8936a2eec189e}{tbsCert}.\hyperlink{structX509TbsCertificate_a68e21bffb3f287f4e57378b275e1d178}{subject}.\hyperlink{structX509Name_a0f57dd73feee5e3a4aa769fa1ecf3766}{rawDataLen} + 2;
1020                      \}
1021                      \textcolor{keywordflow}{else}
1022                      \{
1023                         \textcolor{comment}{//Report an error}
1024                         error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca67f2e3bde0b243044afa635130f722cf}{ERROR\_MESSAGE\_TOO\_LONG};
1025                      \} 
1026                   \}
1027                   \textcolor{keywordflow}{else}
1028                   \{
1029                      \textcolor{comment}{//Discard current CA certificate}
1030                      error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1031                   \}
1032 
1033                   \textcolor{comment}{//Free previously allocated memory}
1034                   \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(derCert);
1035                \}
1036                \textcolor{keywordflow}{else}
1037                \{
1038                   \textcolor{comment}{//Failed to allocate memory}
1039                   error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
1040                \}
1041 
1042                \textcolor{comment}{//Advance read pointer}
1043                trustedCaList += pemCertLen;
1044                trustedCaListLen -= pemCertLen;
1045             \}
1046             \textcolor{keywordflow}{else}
1047             \{
1048                \textcolor{comment}{//End of file detected}
1049                trustedCaListLen = 0;
1050                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1051             \}
1052          \}
1053 
1054          \textcolor{comment}{//Fix the length of the list}
1055          certAuthorities->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(n);
1056 
1057          \textcolor{comment}{//Free previously allocated memory}
1058          \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(certInfo);
1059       \}
1060       \textcolor{keywordflow}{else}
1061       \{
1062          \textcolor{comment}{//Failed to allocate memory}
1063          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
1064       \}
1065    \}
1066    \textcolor{keywordflow}{else}
1067 \textcolor{preprocessor}{#endif}
1068 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
1069    \textcolor{comment}{//TLS 1.3 currently selected?}
1070    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_ab44dc642afbfbd72926ab1f94634cd4d}{TLS\_VERSION\_1\_3})
1071    \{
1072       \hyperlink{tls13__misc_8h_a7a73aa4b5d0ca0a547bc83636546f438}{Tls13CertRequestContext} *certRequestContext;
1073       \hyperlink{tls_8h_a7bbdd7bf690ae50dd1106ebc0bd92b0c}{TlsExtensionList} *extensionList;
1074 
1075       \textcolor{comment}{//Point to the certificate\_request\_context field}
1076       certRequestContext = (\hyperlink{tls13__misc_8h_a7a73aa4b5d0ca0a547bc83636546f438}{Tls13CertRequestContext} *) p;
1077 
1078       \textcolor{comment}{//The certificate\_request\_context field shall be zero length unless}
1079       \textcolor{comment}{//used for the post-handshake authentication exchange}
1080       certRequestContext->length = 0;
1081 
1082       \textcolor{comment}{//Point to the next field}
1083       p += \textcolor{keyword}{sizeof}(\hyperlink{tls13__misc_8h_a7a73aa4b5d0ca0a547bc83636546f438}{Tls13CertRequestContext});
1084       \textcolor{comment}{//Length of the handshake message}
1085       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{tls13__misc_8h_a7a73aa4b5d0ca0a547bc83636546f438}{Tls13CertRequestContext});
1086 
1087       \textcolor{comment}{//The extensions describe the parameters of the certificate being}
1088       \textcolor{comment}{//requested}
1089       extensionList = (\hyperlink{tls_8h_a7bbdd7bf690ae50dd1106ebc0bd92b0c}{TlsExtensionList} *) p;
1090       \textcolor{comment}{//Total length of the extension list}
1091       extensionList->length = 0;
1092 
1093       \textcolor{comment}{//Point to the first extension of the list}
1094       p += \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a7bbdd7bf690ae50dd1106ebc0bd92b0c}{TlsExtensionList});
1095       \textcolor{comment}{//Adjust the length of the message}
1096       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a7bbdd7bf690ae50dd1106ebc0bd92b0c}{TlsExtensionList});
1097 
1098       \textcolor{comment}{//The SignatureAlgorithms extension must be specified}
1099       error = \hyperlink{tls__common_8c_a3e8da6ef31b6d88603dd0b9ff5c9899c}{tlsFormatSignatureAlgorithmsExtension}(context,
1100          \hyperlink{tls__cipher__suites_8h_aa19934da0d53bda533624f13ba98303ba876aff9a6f283b9cc44eeb7c668cad43}{TLS\_CIPHER\_SUITE\_TYPE\_ECC}, p, &n);
1101 
1102 \textcolor{preprocessor}{#if (TLS\_SIGN\_ALGOS\_CERT\_SUPPORT == ENABLED)}
1103       \textcolor{comment}{//Check status code}
1104       \textcolor{keywordflow}{if}(!error)
1105       \{
1106          \textcolor{comment}{//Fix the length of the extension list}
1107          extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
1108          \textcolor{comment}{//Point to the next field}
1109          p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1110 
1111          \textcolor{comment}{//The SignatureAlgorithmsCert extension may optionally be included}
1112          error = \hyperlink{tls__common_8c_a2cb196a73d9b8d67091a344fe3551789}{tlsFormatSignatureAlgorithmsCertExtension}(context
      , p, &n);
1113       \}
1114 \textcolor{preprocessor}{#endif}
1115 
1116       \textcolor{comment}{//Check status code}
1117       \textcolor{keywordflow}{if}(!error)
1118       \{
1119          \textcolor{comment}{//Fix the length of the extension list}
1120          extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
1121          \textcolor{comment}{//Point to the next field}
1122          p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1123       \}
1124 
1125       \textcolor{comment}{//Convert the length of the extension list to network byte order}
1126       extensionList->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(extensionList->length);
1127       \textcolor{comment}{//Total length of the message}
1128       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(extensionList->length);
1129    \}
1130    \textcolor{keywordflow}{else}
1131 \textcolor{preprocessor}{#endif}
1132    \textcolor{comment}{//Invalid TLS version?}
1133    \{
1134       \textcolor{comment}{//Report an error}
1135       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
1136    \}
1137 
1138    \textcolor{comment}{//Return status code}
1139    \textcolor{keywordflow}{return} error;
1140 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server_8c_a4d8dee25b92b399334e45683b466f403}\label{tls__server_8c_a4d8dee25b92b399334e45683b466f403}} 
\index{tls\+\_\+server.\+c@{tls\+\_\+server.\+c}!tls\+Format\+Server\+Hello@{tls\+Format\+Server\+Hello}}
\index{tls\+Format\+Server\+Hello@{tls\+Format\+Server\+Hello}!tls\+\_\+server.\+c@{tls\+\_\+server.\+c}}
\subsubsection{\texorpdfstring{tls\+Format\+Server\+Hello()}{tlsFormatServerHello()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Format\+Server\+Hello (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{tls_8h_a3b37d03b4f71ce65b23f369d2040a245}{Tls\+Server\+Hello} $\ast$}]{message,  }\item[{size\+\_\+t $\ast$}]{length }\end{DoxyParamCaption})}



Format Server\+Hello message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt out}  & {\em message} & Buffer where to format the Server\+Hello message \\
\hline
\mbox{\tt out}  & {\em length} & Length of the resulting Server\+Hello message \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 386 of file tls\+\_\+server.\+c.


\begin{DoxyCode}
388 \{
389    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
390    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version};
391    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
392    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
393    \hyperlink{tls_8h_a7bbdd7bf690ae50dd1106ebc0bd92b0c}{TlsExtensionList} *extensionList;
394 
395    \textcolor{comment}{//In TLS 1.3, the client indicates its version preferences in the}
396    \textcolor{comment}{//SupportedVersions extension and the legacy\_version field must be}
397    \textcolor{comment}{//set to 0x0303, which is the version number for TLS 1.2}
398    version = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(context->version, \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2});
399 
400 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
401    \textcolor{comment}{//DTLS protocol?}
402    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
403    \{
404       \textcolor{comment}{//Get the corresponding DTLS version}
405       version = \hyperlink{dtls__misc_8c_a309abf8d9966cd0d5a28be1d94859970}{dtlsTranslateVersion}(version);
406    \}
407 \textcolor{preprocessor}{#endif}
408 
409    \textcolor{comment}{//In previous versions of TLS, the version field contains the lower of}
410    \textcolor{comment}{//the version suggested by the client in the ClientHello and the highest}
411    \textcolor{comment}{//supported by the server}
412    \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->serverVersion = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(version);
413 
414    \textcolor{comment}{//Server random value}
415    memcpy(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->random, context->serverRandom, 32);
416 
417    \textcolor{comment}{//Point to the session ID}
418    p = \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionId;
419    \textcolor{comment}{//Length of the handshake message}
420    *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a3b37d03b4f71ce65b23f369d2040a245}{TlsServerHello});
421 
422    \textcolor{comment}{//Version of TLS prior to TLS 1.3?}
423    \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
424    \{
425 \textcolor{preprocessor}{#if (TLS\_SESSION\_RESUME\_SUPPORT == ENABLED)}
426       \textcolor{comment}{//The session ID uniquely identifies the current session}
427       memcpy(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionId, context->sessionId, context->sessionIdLen);
428       \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) context->sessionIdLen;
429 #\textcolor{keywordflow}{else}
430       \textcolor{comment}{//The server may return an empty session ID to indicate that the session}
431       \textcolor{comment}{//will not be cached and therefore cannot be resumed}
432       \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen = 0;
433 #endif
434    \}
435    \textcolor{keywordflow}{else}
436    \{
437       \textcolor{comment}{//The legacy\_session\_id\_echo echoes the contents of the client's}
438       \textcolor{comment}{//legacy\_session\_id field}
439       memcpy(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionId, context->sessionId, context->sessionIdLen);
440       \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) context->sessionIdLen;
441    \}
442 
443    \textcolor{comment}{//Debug message}
444    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Session ID (%"} PRIu8 \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen);
445    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionId, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen);
446 
447    \textcolor{comment}{//Advance data pointer}
448    p += \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen;
449    \textcolor{comment}{//Adjust the length of the message}
450    *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen;
451 
452    \textcolor{comment}{//The cipher\_suite field contains the single cipher suite selected by}
453    \textcolor{comment}{//the server}
454    \hyperlink{cpu__endian_8h_a8e657bcdf3842380d2d0006859029240}{STORE16BE}(context->cipherSuite.identifier, p);
455 
456    \textcolor{comment}{//Advance data pointer}
457    p += \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t});
458    \textcolor{comment}{//Adjust the length of the message}
459    *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t});
460 
461    \textcolor{comment}{//The CRIME exploit takes advantage of TLS compression, so conservative}
462    \textcolor{comment}{//implementations do not enable compression at the TLS level}
463    *p = \hyperlink{tls_8h_a27ce2afc296aeccf0726bf834d2df74da9e6d39fe3397b578757793795b18d882}{TLS\_COMPRESSION\_METHOD\_NULL};
464 
465    \textcolor{comment}{//Advance data pointer}
466    p += \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t});
467    \textcolor{comment}{//Adjust the length of the message}
468    *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t});
469 
470    \textcolor{comment}{//Only extensions offered by the client can appear in the server's list}
471    extensionList = (\hyperlink{tls_8h_a7bbdd7bf690ae50dd1106ebc0bd92b0c}{TlsExtensionList} *) p;
472    \textcolor{comment}{//Total length of the extension list}
473    extensionList->length = 0;
474 
475    \textcolor{comment}{//Point to the first extension of the list}
476    p += \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a7bbdd7bf690ae50dd1106ebc0bd92b0c}{TlsExtensionList});
477 
478 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
479    \textcolor{comment}{//SSL 3.0, TLS 1.0, TLS 1.1 or TLS 1.2 selected by the server?}
480    \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
481    \{
482 \textcolor{preprocessor}{#if (TLS\_SNI\_SUPPORT == ENABLED)}
483       \textcolor{comment}{//The server may include a SNI extension in the ServerHello}
484       error = \hyperlink{tls__server__extensions_8c_abe85c18235cfd55be223b44c6c30d464}{tlsFormatServerSniExtension}(context, p, &n);
485       \textcolor{comment}{//Any error to report?}
486       \textcolor{keywordflow}{if}(error)
487          \textcolor{keywordflow}{return} error;
488 
489       \textcolor{comment}{//Fix the length of the extension list}
490       extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
491       \textcolor{comment}{//Point to the next field}
492       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
493 \textcolor{preprocessor}{#endif}
494 
495 \textcolor{preprocessor}{#if (TLS\_MAX\_FRAG\_LEN\_SUPPORT == ENABLED)}
496       \textcolor{comment}{//Servers that receive an ClientHello containing a MaxFragmentLength}
497       \textcolor{comment}{//extension may accept the requested maximum fragment length by including}
498       \textcolor{comment}{//an extension of type MaxFragmentLength in the ServerHello}
499       error = \hyperlink{tls__server__extensions_8c_a83a033674e9efbf357891a543c3f4ed3}{tlsFormatServerMaxFragLenExtension}(context, p, &n);
500       \textcolor{comment}{//Any error to report?}
501       \textcolor{keywordflow}{if}(error)
502          \textcolor{keywordflow}{return} error;
503 
504       \textcolor{comment}{//Fix the length of the extension list}
505       extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
506       \textcolor{comment}{//Point to the next field}
507       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
508 \textcolor{preprocessor}{#endif}
509 
510 \textcolor{preprocessor}{#if (TLS\_RECORD\_SIZE\_LIMIT\_SUPPORT == ENABLED)}
511       \textcolor{comment}{//The value of RecordSizeLimit is the maximum size of record in octets}
512       \textcolor{comment}{//that the endpoint is willing to receive}
513       error = \hyperlink{tls__server__extensions_8c_ae228e4be4faa6572a4e6506cab404887}{tlsFormatServerRecordSizeLimitExtension}(context, p, &n
      );
514       \textcolor{comment}{//Any error to report?}
515       \textcolor{keywordflow}{if}(error)
516          \textcolor{keywordflow}{return} error;
517 
518       \textcolor{comment}{//Fix the length of the extension list}
519       extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
520       \textcolor{comment}{//Point to the next field}
521       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
522 \textcolor{preprocessor}{#endif}
523 
524 \textcolor{preprocessor}{#if (TLS\_ECDH\_ANON\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_RSA\_KE\_SUPPORT == ENABLED || \(\backslash\)}
525 \textcolor{preprocessor}{   TLS\_ECDHE\_ECDSA\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
526       \textcolor{comment}{//A server that selects an ECC cipher suite in response to a ClientHello}
527       \textcolor{comment}{//message including an EcPointFormats extension appends this extension}
528       \textcolor{comment}{//to its ServerHello message}
529       error = \hyperlink{tls__server__extensions_8c_aa856298d8714aca4f310519e76694417}{tlsFormatServerEcPointFormatsExtension}(context, p, &n);
530       \textcolor{comment}{//Any error to report?}
531       \textcolor{keywordflow}{if}(error)
532          \textcolor{keywordflow}{return} error;
533 
534       \textcolor{comment}{//Fix the length of the extension list}
535       extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
536       \textcolor{comment}{//Point to the next field}
537       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
538 \textcolor{preprocessor}{#endif}
539 
540 \textcolor{preprocessor}{#if (TLS\_ALPN\_SUPPORT == ENABLED)}
541       \textcolor{comment}{//The ALPN extension contains the name of the selected protocol}
542       error = \hyperlink{tls__server__extensions_8c_ae9f0a3949fe6785f04c1b7fe18fdc607}{tlsFormatServerAlpnExtension}(context, p, &n);
543       \textcolor{comment}{//Any error to report?}
544       \textcolor{keywordflow}{if}(error)
545          \textcolor{keywordflow}{return} error;
546 
547       \textcolor{comment}{//Fix the length of the extension list}
548       extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
549       \textcolor{comment}{//Point to the next field}
550       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
551 \textcolor{preprocessor}{#endif}
552 
553 \textcolor{preprocessor}{#if (TLS\_RAW\_PUBLIC\_KEY\_SUPPORT == ENABLED)}
554       \textcolor{comment}{//The ClientCertType extension in the ServerHello indicates the type}
555       \textcolor{comment}{//of certificates the client is requested to provide in a subsequent}
556       \textcolor{comment}{//certificate payload}
557       error = \hyperlink{tls__server__extensions_8c_a5eb2cc5e804ae91309a4a2459e171463}{tlsFormatClientCertTypeExtension}(context, p, &n);
558       \textcolor{comment}{//Any error to report?}
559       \textcolor{keywordflow}{if}(error)
560          \textcolor{keywordflow}{return} error;
561 
562       \textcolor{comment}{//Fix the length of the extension list}
563       extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
564       \textcolor{comment}{//Point to the next field}
565       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
566 
567       \textcolor{comment}{//With the ServerCertType extension in the ServerHello, the TLS server}
568       \textcolor{comment}{//indicates the certificate type carried in the certificate payload}
569       error = \hyperlink{tls__server__extensions_8c_a4b410a15ac55feeba5986c6a9e15b3a6}{tlsFormatServerCertTypeExtension}(context, p, &n);
570       \textcolor{comment}{//Any error to report?}
571       \textcolor{keywordflow}{if}(error)
572          \textcolor{keywordflow}{return} error;
573 
574       \textcolor{comment}{//Fix the length of the extension list}
575       extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
576       \textcolor{comment}{//Point to the next field}
577       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
578 \textcolor{preprocessor}{#endif}
579 
580 \textcolor{preprocessor}{#if (TLS\_EXT\_MASTER\_SECRET\_SUPPORT == ENABLED)}
581       \textcolor{comment}{//If a server implementing RFC 7627 receives the ExtendedMasterSecret}
582       \textcolor{comment}{//extension, it must include the extension in its ServerHello message}
583       error = \hyperlink{tls__server__extensions_8c_a02581afedcbbb2656e478ba98700a679}{tlsFormatServerEmsExtension}(context, p, &n);
584       \textcolor{comment}{//Any error to report?}
585       \textcolor{keywordflow}{if}(error)
586          \textcolor{keywordflow}{return} error;
587 
588       \textcolor{comment}{//Fix the length of the extension list}
589       extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
590       \textcolor{comment}{//Point to the next field}
591       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
592 \textcolor{preprocessor}{#endif}
593 
594 \textcolor{preprocessor}{#if (TLS\_SECURE\_RENEGOTIATION\_SUPPORT == ENABLED)}
595       \textcolor{comment}{//During secure renegotiation, the server must include a renegotiation\_info}
596       \textcolor{comment}{//extension containing the saved client\_verify\_data and server\_verify\_data}
597       error = \hyperlink{tls__server__extensions_8c_ae3a2681db3e04378ed7cedff914875d3}{tlsFormatServerRenegoInfoExtension}(context, p, &n);
598       \textcolor{comment}{//Any error to report?}
599       \textcolor{keywordflow}{if}(error)
600          \textcolor{keywordflow}{return} error;
601 
602       \textcolor{comment}{//Fix the length of the extension list}
603       extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
604       \textcolor{comment}{//Point to the next field}
605       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
606 \textcolor{preprocessor}{#endif}
607    \}
608    \textcolor{keywordflow}{else}
609 \textcolor{preprocessor}{#endif}
610 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
611    \textcolor{comment}{//TLS 1.3 selected by the server?}
612    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_ab44dc642afbfbd72926ab1f94634cd4d}{TLS\_VERSION\_1\_3})
613    \{
614       \textcolor{comment}{//A server which negotiates TLS 1.3 must respond by sending a}
615       \textcolor{comment}{//SupportedVersions extension containing the selected version value}
616       error = \hyperlink{tls13__server__extensions_8h_aea9f239bca2d7c4ee1afff4fe77c98c1}{tls13FormatServerSupportedVersionsExtension}(
      context, p, &n);
617       \textcolor{comment}{//Any error to report?}
618       \textcolor{keywordflow}{if}(error)
619          \textcolor{keywordflow}{return} error;
620 
621       \textcolor{comment}{//Fix the length of the extension list}
622       extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
623       \textcolor{comment}{//Point to the next field}
624       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
625 
626       \textcolor{comment}{//If using (EC)DHE key establishment, servers offer exactly one}
627       \textcolor{comment}{//KeyShareEntry in the ServerHello}
628       error = \hyperlink{tls13__server__extensions_8h_a7500e6dd20343dd41fa023fbce015a77}{tls13FormatServerKeyShareExtension}(context, p, &n);
629       \textcolor{comment}{//Any error to report?}
630       \textcolor{keywordflow}{if}(error)
631          \textcolor{keywordflow}{return} error;
632 
633       \textcolor{comment}{//Fix the length of the extension list}
634       extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
635       \textcolor{comment}{//Point to the next field}
636       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
637 
638       \textcolor{comment}{//In order to accept PSK key establishment, the server sends a}
639       \textcolor{comment}{//PreSharedKey extension indicating the selected identity}
640       error = \hyperlink{tls13__server__extensions_8h_a989030b6604ad5e1f0b360b5e3634264}{tls13FormatServerPreSharedKeyExtension}(context, p, &n);
641       \textcolor{comment}{//Any error to report?}
642       \textcolor{keywordflow}{if}(error)
643          \textcolor{keywordflow}{return} error;
644 
645       \textcolor{comment}{//Fix the length of the extension list}
646       extensionList->length += (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) n;
647       \textcolor{comment}{//Point to the next field}
648       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
649    \}
650    \textcolor{keywordflow}{else}
651 \textcolor{preprocessor}{#endif}
652    \textcolor{comment}{//Invalid TLS version?}
653    \{
654       \textcolor{comment}{//Report an error}
655       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
656    \}
657 
658    \textcolor{comment}{//Any extensions included in the ServerHello message?}
659    \textcolor{keywordflow}{if}(extensionList->length > 0)
660    \{
661       \textcolor{comment}{//Convert the length of the extension list to network byte order}
662       extensionList->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(extensionList->length);
663       \textcolor{comment}{//Total length of the message}
664       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a7bbdd7bf690ae50dd1106ebc0bd92b0c}{TlsExtensionList}) + \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(extensionList->length);
665    \}
666 
667    \textcolor{comment}{//Successful processing}
668    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
669 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server_8c_ac2375898dec7aa0ceaff2faefd467f76}\label{tls__server_8c_ac2375898dec7aa0ceaff2faefd467f76}} 
\index{tls\+\_\+server.\+c@{tls\+\_\+server.\+c}!tls\+Format\+Server\+Hello\+Done@{tls\+Format\+Server\+Hello\+Done}}
\index{tls\+Format\+Server\+Hello\+Done@{tls\+Format\+Server\+Hello\+Done}!tls\+\_\+server.\+c@{tls\+\_\+server.\+c}}
\subsubsection{\texorpdfstring{tls\+Format\+Server\+Hello\+Done()}{tlsFormatServerHelloDone()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Format\+Server\+Hello\+Done (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{tls_8h_a71e29f87ab91f2adb5655ad8157e7aea}{Tls\+Server\+Hello\+Done} $\ast$}]{message,  }\item[{size\+\_\+t $\ast$}]{length }\end{DoxyParamCaption})}



Format Server\+Hello\+Done message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt out}  & {\em message} & Buffer where to format the Server\+Hello\+Done message \\
\hline
\mbox{\tt out}  & {\em length} & Length of the resulting Server\+Hello\+Done message \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1151 of file tls\+\_\+server.\+c.


\begin{DoxyCode}
1153 \{
1154    \textcolor{comment}{//The ServerHelloDone message does not contain any data}
1155    *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = 0;
1156 
1157    \textcolor{comment}{//Successful processing}
1158    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1159 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server_8c_ae9133776b8d42f0da84f6b8446448069}\label{tls__server_8c_ae9133776b8d42f0da84f6b8446448069}} 
\index{tls\+\_\+server.\+c@{tls\+\_\+server.\+c}!tls\+Format\+Server\+Key\+Exchange@{tls\+Format\+Server\+Key\+Exchange}}
\index{tls\+Format\+Server\+Key\+Exchange@{tls\+Format\+Server\+Key\+Exchange}!tls\+\_\+server.\+c@{tls\+\_\+server.\+c}}
\subsubsection{\texorpdfstring{tls\+Format\+Server\+Key\+Exchange()}{tlsFormatServerKeyExchange()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Format\+Server\+Key\+Exchange (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{tls_8h_a69c0b3ab7349e73b2e8f9452dbdfef5a}{Tls\+Server\+Key\+Exchange} $\ast$}]{message,  }\item[{size\+\_\+t $\ast$}]{length }\end{DoxyParamCaption})}



Format Server\+Key\+Exchange message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt out}  & {\em message} & Buffer where to format the Server\+Key\+Exchange message \\
\hline
\mbox{\tt out}  & {\em length} & Length of the resulting Server\+Key\+Exchange message \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 680 of file tls\+\_\+server.\+c.


\begin{DoxyCode}
682 \{
683    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
684    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
685    \textcolor{keywordtype}{size\_t} paramsLen;
686    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
687    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *params;
688 
689    \textcolor{comment}{//Point to the beginning of the handshake message}
690    p = \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
691    \textcolor{comment}{//Length of the handshake message}
692    *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = 0;
693 
694 \textcolor{preprocessor}{#if (TLS\_PSK\_KE\_SUPPORT == ENABLED || TLS\_RSA\_PSK\_KE\_SUPPORT == ENABLED || \(\backslash\)}
695 \textcolor{preprocessor}{   TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
696    \textcolor{comment}{//PSK key exchange method?}
697    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aed949c3b521aa45b6685846fa9a3b8f0}{TLS\_KEY\_EXCH\_PSK} ||
698       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a38a6d0551d2fbd9480b6c233c1242d4c}{TLS\_KEY\_EXCH\_RSA\_PSK} ||
699       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a32a252b7c7befeccaa088290d6a71dfe}{TLS\_KEY\_EXCH\_DHE\_PSK} ||
700       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aebba2060dba7ad92238668218f3a6520}{TLS\_KEY\_EXCH\_ECDHE\_PSK})
701    \{
702       \textcolor{comment}{//To help the client in selecting which identity to use, the server}
703       \textcolor{comment}{//can provide a PSK identity hint in the ServerKeyExchange message}
704       error = \hyperlink{tls__server__misc_8c_aef25ac0a386d26b16921691ef75a97d1}{tlsFormatPskIdentityHint}(context, p, &n);
705       \textcolor{comment}{//Any error to report?}
706       \textcolor{keywordflow}{if}(error)
707          \textcolor{keywordflow}{return} error;
708 
709       \textcolor{comment}{//Advance data pointer}
710       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
711       \textcolor{comment}{//Adjust the length of the message}
712       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
713    \}
714 \textcolor{preprocessor}{#endif}
715 
716    \textcolor{comment}{//Diffie-Hellman or ECDH key exchange method?}
717    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a33535bd987c46f1ba621d6e28b0b3bfa}{TLS\_KEY\_EXCH\_DH\_ANON} ||
718       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01660ec1808dd6a8b5250b16d81502e4}{TLS\_KEY\_EXCH\_DHE\_RSA} ||
719       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ac256323d1e243a2e7a435abce34dbd39}{TLS\_KEY\_EXCH\_DHE\_DSS} ||
720       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a32a252b7c7befeccaa088290d6a71dfe}{TLS\_KEY\_EXCH\_DHE\_PSK} ||
721       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a895e0af86b29640264f699235be22953}{TLS\_KEY\_EXCH\_ECDH\_ANON} ||
722       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ad9ebbdd436027753829ea5b6cd4b810b}{TLS\_KEY\_EXCH\_ECDHE\_RSA} ||
723       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a14c521a28278eecd181953c37b784cb7}{TLS\_KEY\_EXCH\_ECDHE\_ECDSA} ||
724       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aebba2060dba7ad92238668218f3a6520}{TLS\_KEY\_EXCH\_ECDHE\_PSK})
725    \{
726       \textcolor{comment}{//Point to the server's key exchange parameters}
727       params = \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
728 
729       \textcolor{comment}{//Format server's key exchange parameters}
730       error = \hyperlink{tls__server__misc_8c_a066a88bee17c444813a6b631b1f442cd}{tlsFormatServerKeyParams}(context, p, &paramsLen);
731       \textcolor{comment}{//Any error to report?}
732       \textcolor{keywordflow}{if}(error)
733          \textcolor{keywordflow}{return} error;
734 
735       \textcolor{comment}{//Advance data pointer}
736       p += paramsLen;
737       \textcolor{comment}{//Adjust the length of the message}
738       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += paramsLen;
739    \}
740    \textcolor{keywordflow}{else}
741    \{
742       \textcolor{comment}{//Just for sanity}
743       params = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
744       paramsLen = 0;
745    \}
746 
747    \textcolor{comment}{//For non-anonymous Diffie-Hellman and ECDH key exchanges, a signature}
748    \textcolor{comment}{//over the server's key exchange parameters shall be generated}
749    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01660ec1808dd6a8b5250b16d81502e4}{TLS\_KEY\_EXCH\_DHE\_RSA} ||
750       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ac256323d1e243a2e7a435abce34dbd39}{TLS\_KEY\_EXCH\_DHE\_DSS} ||
751       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ad9ebbdd436027753829ea5b6cd4b810b}{TLS\_KEY\_EXCH\_ECDHE\_RSA} ||
752       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a14c521a28278eecd181953c37b784cb7}{TLS\_KEY\_EXCH\_ECDHE\_ECDSA})
753    \{
754 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_1)}
755       \textcolor{comment}{//SSL 3.0, TLS 1.0 or TLS 1.1 currently selected?}
756       \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_a9e359f668824d16983a41f8deb338979}{TLS\_VERSION\_1\_1})
757       \{
758          \textcolor{comment}{//Sign server's key exchange parameters}
759          error = \hyperlink{tls__server__misc_8c_abf2189814fc56621fbab70c7af9a0ea2}{tlsGenerateServerKeySignature}(context,
760             (\hyperlink{tls_8h_a8e07cba48fef31563460ba8f90ad5f1d}{TlsDigitalSignature} *) p, params, paramsLen, &n);
761       \}
762       \textcolor{keywordflow}{else}
763 \textcolor{preprocessor}{#endif}
764 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_2 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
765       \textcolor{comment}{//TLS 1.2 currently selected?}
766       \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
767       \{
768          \textcolor{comment}{//Sign server's key exchange parameters}
769          error = \hyperlink{tls__server__misc_8c_a1ac1dcf9d144fb9eb54018ac25b22801}{tls12GenerateServerKeySignature}(context,
770             (\hyperlink{tls_8h_ad6758810e829828a20529e27e0f1fb6a}{Tls12DigitalSignature} *) p, params, paramsLen, &n);
771       \}
772       \textcolor{keywordflow}{else}
773 \textcolor{preprocessor}{#endif}
774       \{
775          \textcolor{comment}{//Report an error}
776          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
777       \}
778 
779       \textcolor{comment}{//Any error to report?}
780       \textcolor{keywordflow}{if}(error)
781          \textcolor{keywordflow}{return} error;
782 
783       \textcolor{comment}{//Advance data pointer}
784       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
785       \textcolor{comment}{//Adjust the length of the message}
786       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
787    \}
788 
789    \textcolor{comment}{//Successful processing}
790    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
791 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server_8c_a38ce6b990031f07a875c795599ccd5d4}\label{tls__server_8c_a38ce6b990031f07a875c795599ccd5d4}} 
\index{tls\+\_\+server.\+c@{tls\+\_\+server.\+c}!tls\+Parse\+Client\+Hello@{tls\+Parse\+Client\+Hello}}
\index{tls\+Parse\+Client\+Hello@{tls\+Parse\+Client\+Hello}!tls\+\_\+server.\+c@{tls\+\_\+server.\+c}}
\subsubsection{\texorpdfstring{tls\+Parse\+Client\+Hello()}{tlsParseClientHello()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Parse\+Client\+Hello (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{tls_8h_ac78d39e638430eb19c4017e5f9797d16}{Tls\+Client\+Hello} $\ast$}]{message,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Parse Client\+Hello message. 

When a client first connects to a server, it is required to send the Client\+Hello as its first message. The client can also send a Client\+Hello in response to a Hello\+Request or on its own initiative in order to renegotiate the security parameters in an existing connection


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em message} & Incoming Client\+Hello message to parse \\
\hline
\mbox{\tt in}  & {\em length} & Message length \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1177 of file tls\+\_\+server.\+c.


\begin{DoxyCode}
1179 \{
1180    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1181    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1182    \textcolor{keyword}{const} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
1183    \textcolor{keyword}{const} \hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{TlsCipherSuites} *cipherSuites;
1184    \textcolor{keyword}{const} \hyperlink{tls_8h_a73df667e4fbedd6b3dd66620b4d5d018}{TlsCompressMethods} *compressMethods;
1185    \hyperlink{structTlsHelloExtensions}{TlsHelloExtensions} \hyperlink{tls13__misc_8h_a7b8cc84c920376c616d85d575080d28e}{extensions};
1186 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
1187    \textcolor{keyword}{const} \hyperlink{dtls__misc_8h_a60a5bbbe761197a18b2793a1148d56f9}{DtlsCookie} *\hyperlink{dtls__misc_8h_a126a9f1c8e75ec207f319533d142c88d}{cookie};
1188 \textcolor{preprocessor}{#endif}
1189 
1190    \textcolor{comment}{//Debug message}
1191    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"ClientHello message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
1192    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
1193 
1194    \textcolor{comment}{//Check current state}
1195    \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dade201db86ae38480c06696f3a48e0170}{TLS\_STATE\_CLIENT\_HELLO})
1196    \{
1197       \textcolor{comment}{//When a client first connects to a server, it is required to send}
1198       \textcolor{comment}{//the ClientHello as its first message}
1199    \}
1200    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da535ebf5eb2c0397b2d6ed43669f63a7d}{TLS\_STATE\_CLIENT\_HELLO\_2})
1201    \{
1202 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
1203       \textcolor{comment}{//The client will also send a updated ClientHello when the server has}
1204       \textcolor{comment}{//responded to its initial ClientHello with a HelloRetryRequest}
1205       context->updatedClientHelloReceived = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1206 \textcolor{preprocessor}{#endif}
1207    \}
1208    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da7ff3a76e0b1787b6d0026e533a89649b}{TLS\_STATE\_APPLICATION\_DATA})
1209    \{
1210 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
1211       \textcolor{comment}{//Version of TLS prior to TLS 1.3?}
1212       \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1213       \{
1214 \textcolor{preprocessor}{#if (TLS\_SECURE\_RENEGOTIATION\_SUPPORT == ENABLED)}
1215          \textcolor{comment}{//Check whether secure renegotiation is enabled}
1216          \textcolor{keywordflow}{if}(context->secureRenegoEnabled)
1217          \{
1218             \textcolor{comment}{//Make sure the secure\_renegociation flag is set}
1219             \textcolor{keywordflow}{if}(!context->secureRenegoFlag)
1220             \{
1221                \textcolor{comment}{//If the connection's secure\_renegotiation flag is set to}
1222                \textcolor{comment}{//FALSE, it is recommended that servers do not permit legacy}
1223                \textcolor{comment}{//renegotiation (refer to RFC 5746, section 4.4)}
1224                \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca70d82df53df56c9d4a943d5539ccc4bc}{ERROR\_HANDSHAKE\_FAILED};
1225             \}
1226          \}
1227          \textcolor{keywordflow}{else}
1228 \textcolor{preprocessor}{#endif}
1229          \{
1230             \textcolor{comment}{//Secure renegotiation is disabled}
1231             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca70d82df53df56c9d4a943d5539ccc4bc}{ERROR\_HANDSHAKE\_FAILED};
1232          \}
1233       \}
1234       \textcolor{keywordflow}{else}
1235 \textcolor{preprocessor}{#endif}
1236       \{
1237          \textcolor{comment}{//Because TLS 1.3 forbids renegotiation, if a server has negotiated}
1238          \textcolor{comment}{//TLS 1.3 and receives a ClientHello at any other time, it must}
1239          \textcolor{comment}{//terminate the connection with an unexpected\_message alert}
1240          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
1241       \}
1242    \}
1243    \textcolor{keywordflow}{else}
1244    \{
1245       \textcolor{comment}{//Report an error}
1246       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
1247    \}
1248 
1249    \textcolor{comment}{//Check the length of the ClientHello message}
1250    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_ac78d39e638430eb19c4017e5f9797d16}{TlsClientHello}))
1251       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1252 
1253    \textcolor{comment}{//Get the version the client wishes to use during this session}
1254    context->clientVersion = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->clientVersion);
1255 
1256    \textcolor{comment}{//Point to the session ID}
1257    p = \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionId;
1258    \textcolor{comment}{//Remaining bytes to process}
1259    n = \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_ac78d39e638430eb19c4017e5f9797d16}{TlsClientHello});
1260 
1261    \textcolor{comment}{//Check the length of the session ID}
1262    \textcolor{keywordflow}{if}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen > n)
1263       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1264    \textcolor{keywordflow}{if}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen > 32)
1265       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1266 
1267    \textcolor{comment}{//Debug message}
1268    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Session ID (%"} PRIu8 \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen);
1269    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionId, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen);
1270 
1271    \textcolor{comment}{//Point to the next field}
1272    p += \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen;
1273    \textcolor{comment}{//Remaining bytes to process}
1274    n -= \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen;
1275 
1276 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
1277    \textcolor{comment}{//DTLS protocol?}
1278    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
1279    \{
1280       \textcolor{comment}{//Point to the Cookie field}
1281       cookie = (\hyperlink{dtls__misc_8h_a60a5bbbe761197a18b2793a1148d56f9}{DtlsCookie} *) p;
1282 
1283       \textcolor{comment}{//Malformed ClientHello message?}
1284       \textcolor{keywordflow}{if}(n < \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_a60a5bbbe761197a18b2793a1148d56f9}{DtlsCookie}))
1285          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1286       \textcolor{keywordflow}{if}(n < (\textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_a60a5bbbe761197a18b2793a1148d56f9}{DtlsCookie}) + cookie->length))
1287          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1288 
1289       \textcolor{comment}{//Check the length of the cookie}
1290       \textcolor{keywordflow}{if}(cookie->length > \hyperlink{dtls__misc_8h_a64a1e901ad7f80e35590f9595348c410}{DTLS\_MAX\_COOKIE\_SIZE})
1291          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
1292 
1293       \textcolor{comment}{//Point to the next field}
1294       p += \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_a60a5bbbe761197a18b2793a1148d56f9}{DtlsCookie}) + cookie->length;
1295       \textcolor{comment}{//Remaining bytes to process}
1296       n -= \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_a60a5bbbe761197a18b2793a1148d56f9}{DtlsCookie}) + cookie->length;
1297    \}
1298    \textcolor{keywordflow}{else}
1299    \{
1300       \textcolor{comment}{//Just for sanity}
1301       cookie = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1302    \}
1303 \textcolor{preprocessor}{#endif}
1304 
1305    \textcolor{comment}{//List of cryptographic algorithms supported by the client}
1306    cipherSuites = (\hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{TlsCipherSuites} *) p;
1307 
1308    \textcolor{comment}{//Malformed ClientHello message?}
1309    \textcolor{keywordflow}{if}(n < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{TlsCipherSuites}))
1310       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1311    \textcolor{keywordflow}{if}(n < (\textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{TlsCipherSuites}) + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->length)))
1312       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1313 
1314    \textcolor{comment}{//Check the length of the list}
1315    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->length) == 0)
1316       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1317    \textcolor{keywordflow}{if}((\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->length) % 2) != 0)
1318       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1319 
1320    \textcolor{comment}{//Point to the next field}
1321    p += \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{TlsCipherSuites}) + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->length);
1322    \textcolor{comment}{//Remaining bytes to process}
1323    n -= \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{TlsCipherSuites}) + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->length);
1324 
1325    \textcolor{comment}{//List of compression algorithms supported by the client}
1326    compressMethods = (\hyperlink{tls_8h_a73df667e4fbedd6b3dd66620b4d5d018}{TlsCompressMethods} *) p;
1327 
1328    \textcolor{comment}{//Malformed ClientHello message?}
1329    \textcolor{keywordflow}{if}(n < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a73df667e4fbedd6b3dd66620b4d5d018}{TlsCompressMethods}))
1330       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1331    \textcolor{keywordflow}{if}(n < (\textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a73df667e4fbedd6b3dd66620b4d5d018}{TlsCompressMethods}) + compressMethods->length))
1332       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1333 
1334    \textcolor{comment}{//Check the length of the list}
1335    \textcolor{keywordflow}{if}(compressMethods->length == 0)
1336       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1337 
1338    \textcolor{comment}{//Point to the next field}
1339    p += \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a73df667e4fbedd6b3dd66620b4d5d018}{TlsCompressMethods}) + compressMethods->length;
1340    \textcolor{comment}{//Remaining bytes to process}
1341    n -= \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a73df667e4fbedd6b3dd66620b4d5d018}{TlsCompressMethods}) + compressMethods->length;
1342 
1343    \textcolor{comment}{//Parse the list of extensions offered by the client}
1344    error = \hyperlink{tls__extensions_8c_a44cc44e114cbc3c28245bdfa6546cb5c}{tlsParseHelloExtensions}(\hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba374f2754185de2cef4ffb42530ce16a8}{TLS\_TYPE\_CLIENT\_HELLO}, p, n,
       &extensions);
1345    \textcolor{comment}{//Any error to report?}
1346    \textcolor{keywordflow}{if}(error)
1347       \textcolor{keywordflow}{return} error;
1348 
1349    \textcolor{comment}{//Check whether the ClientHello includes any SCSV cipher suites}
1350    error = \hyperlink{tls__server__misc_8c_acd0ea01bfbd67e0d7ccbdfc03c595f4f}{tlsCheckSignalingCipherSuiteValues}(context, cipherSuites);
1351    \textcolor{comment}{//Any error to report?}
1352    \textcolor{keywordflow}{if}(error)
1353       \textcolor{keywordflow}{return} error;
1354 
1355 \textcolor{preprocessor}{#if (TLS\_SECURE\_RENEGOTIATION\_SUPPORT == ENABLED)}
1356    \textcolor{comment}{//Parse RenegotiationInfo extension}
1357    error = \hyperlink{tls__server__extensions_8c_adddc100a1d10d444b0735b69491619a2}{tlsParseClientRenegoInfoExtension}(context, extensions.
      \hyperlink{structTlsHelloExtensions_aecf5a78a44bd06ba8018bd5f4a5043de}{renegoInfo});
1358    \textcolor{comment}{//Any error to report?}
1359    \textcolor{keywordflow}{if}(error)
1360       \textcolor{keywordflow}{return} error;
1361 \textcolor{preprocessor}{#endif}
1362 
1363 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
1364    \textcolor{comment}{//DTLS protocol?}
1365    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
1366    \{
1367       \hyperlink{structDtlsClientParameters}{DtlsClientParameters} clientParams;
1368 
1369       \textcolor{comment}{//The server should use client parameters (version, random, session\_id,}
1370       \textcolor{comment}{//cipher\_suites, compression\_method) to generate its cookie}
1371       clientParams.\hyperlink{structDtlsClientParameters_a76502088d967b0f240e8804b585e019a}{version} = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->clientVersion);
1372       clientParams.\hyperlink{structDtlsClientParameters_af465b2ea577f66ff4ebf3b83e5c0b854}{random} = \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->random;
1373       clientParams.\hyperlink{structDtlsClientParameters_a08ff7ceea84f110d641bc30a7adcdd9e}{randomLen} = 32;
1374       clientParams.\hyperlink{structDtlsClientParameters_a6671f99ef473de11b1b7c1b76e8e2cb8}{sessionId} = \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionId;
1375       clientParams.\hyperlink{structDtlsClientParameters_aca04db05a88059730c97a3dcc25705c0}{sessionIdLen} = \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen;
1376       clientParams.\hyperlink{structDtlsClientParameters_ab32c1230661533668c5675127371f0d3}{cipherSuites} = (\textcolor{keyword}{const} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) cipherSuites->value;
1377       clientParams.\hyperlink{structDtlsClientParameters_a06be73dd013213bf25b4f651f6d5efa8}{cipherSuitesLen} = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->length);
1378       clientParams.\hyperlink{structDtlsClientParameters_a233abf95be55fe711b945119c08ffd07}{compressMethods} = compressMethods->value;
1379       clientParams.\hyperlink{structDtlsClientParameters_a0910d54a373e1c9b1dbfe47cc45458d6}{compressMethodsLen} = compressMethods->length;
1380 
1381       \textcolor{comment}{//Verify that the cookie is valid}
1382       error = \hyperlink{dtls__misc_8c_af5608ff09d69338af8269eaf548c70d3}{dtlsVerifyCookie}(context, cookie, &clientParams);
1383       \textcolor{comment}{//Any error to report?}
1384       \textcolor{keywordflow}{if}(error)
1385          \textcolor{keywordflow}{return} error;
1386 
1387       \textcolor{comment}{//The server may respond with a HelloVerifyRequest message containing}
1388       \textcolor{comment}{//a stateless cookie}
1389       \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da28df1d3e7276c71ab9e2f8c75cdeef2e}{TLS\_STATE\_HELLO\_VERIFY\_REQUEST})
1390       \{
1391          \textcolor{comment}{//Exit immediately}
1392          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1393       \}
1394    \}
1395 \textcolor{preprocessor}{#endif}
1396 
1397    \textcolor{comment}{//Perform version negotiation}
1398    error = \hyperlink{tls__server__misc_8c_ad99a99db09cdc1ac0f3cb60f15711035}{tlsNegotiateVersion}(context, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->clientVersion),
1399       extensions.\hyperlink{structTlsHelloExtensions_ad2c1f8bd3e6432fe17b9ac339fc35a0b}{supportedVersionList});
1400    \textcolor{comment}{//Any error to report?}
1401    \textcolor{keywordflow}{if}(error)
1402       \textcolor{keywordflow}{return} error;
1403 
1404    \textcolor{comment}{//Check the list of extensions offered by the client}
1405    error = \hyperlink{tls__extensions_8c_a67e977c5311fc3d9b3503ca226f2ea7a}{tlsCheckHelloExtensions}(\hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba374f2754185de2cef4ffb42530ce16a8}{TLS\_TYPE\_CLIENT\_HELLO}, 
      context->version,
1406       &extensions);
1407    \textcolor{comment}{//Any error to report?}
1408    \textcolor{keywordflow}{if}(error)
1409       \textcolor{keywordflow}{return} error;
1410 
1411    \textcolor{comment}{//The SignatureAlgorithms extension is not meaningful for TLS versions}
1412    \textcolor{comment}{//prior to 1.2 (refer to RFC 5246, section 7.4.1.4.1)}
1413    \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_a9e359f668824d16983a41f8deb338979}{TLS\_VERSION\_1\_1})
1414    \{
1415       \textcolor{comment}{//Even if clients do offer it, the rules specified in RFC 6066 require}
1416       \textcolor{comment}{//servers to ignore extensions they do not understand}
1417       extensions.\hyperlink{structTlsHelloExtensions_a7903ad9cf319d5f27990432c4e719544}{signAlgoList} = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1418       extensions.\hyperlink{structTlsHelloExtensions_a640637c05b8aec2ef15420d5005830cb}{certSignAlgoList} = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1419    \}
1420 
1421    \textcolor{comment}{//Save client random value}
1422    memcpy(context->clientRandom, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->random, 32);
1423 
1424 \textcolor{preprocessor}{#if (TLS\_SNI\_SUPPORT == ENABLED)}
1425    \textcolor{comment}{//In order to provide the server name, clients may include a ServerName}
1426    \textcolor{comment}{//extension}
1427    error = \hyperlink{tls__server__extensions_8c_ab34de7891d354995208e858a53a14b57}{tlsParseClientSniExtension}(context, extensions.
      \hyperlink{structTlsHelloExtensions_a53acaa1dcce86449741ea9a780331d46}{serverNameList});
1428    \textcolor{comment}{//Any error to report?}
1429    \textcolor{keywordflow}{if}(error)
1430       \textcolor{keywordflow}{return} error;
1431 \textcolor{preprocessor}{#endif}
1432 
1433 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
1434    \textcolor{comment}{//SSL 3.0, TLS 1.0, TLS 1.1 or TLS 1.2 currently selected?}
1435    \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1436    \{
1437       \textcolor{comment}{//The server attempts to resume TLS session via session ID}
1438       error = \hyperlink{tls__server__misc_8c_a5f4a1b96d929e08c6e62fa2f5408a894}{tlsResumeServerSession}(context, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionId,
1439          \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen, cipherSuites, &extensions);
1440       \textcolor{comment}{//Any error to report?}
1441       \textcolor{keywordflow}{if}(error)
1442          \textcolor{keywordflow}{return} error;
1443 
1444       \textcolor{comment}{//Full handshake?}
1445       \textcolor{keywordflow}{if}(!context->resume)
1446       \{
1447          \textcolor{comment}{//Perform cipher suite negotiation}
1448          error = \hyperlink{tls__server__misc_8c_a634953aa0fd11d11c625673b3edb2456}{tlsNegotiateCipherSuite}(context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, cipherSuites,
1449             &extensions);
1450          \textcolor{comment}{//If no acceptable choices are presented, terminate the handshake}
1451          \textcolor{keywordflow}{if}(error)
1452             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca70d82df53df56c9d4a943d5539ccc4bc}{ERROR\_HANDSHAKE\_FAILED};
1453 
1454          \textcolor{comment}{//Parse the list of compression methods supported by the client}
1455          error = \hyperlink{tls__server__misc_8c_a7aec22c82399ab4173339771d47ceff7}{tlsParseCompressMethods}(context, compressMethods);
1456          \textcolor{comment}{//Any error to report?}
1457          \textcolor{keywordflow}{if}(error)
1458             \textcolor{keywordflow}{return} error;
1459       \}
1460 
1461       \textcolor{comment}{//Initialize handshake message hashing}
1462       error = \hyperlink{tls__transcript__hash_8c_a96f18526c55951964667477c4134f092}{tlsInitTranscriptHash}(context);
1463       \textcolor{comment}{//Any error to report?}
1464       \textcolor{keywordflow}{if}(error)
1465          \textcolor{keywordflow}{return} error;
1466 
1467 \textcolor{preprocessor}{#if (TLS\_ECDH\_ANON\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_RSA\_KE\_SUPPORT == ENABLED || \(\backslash\)}
1468 \textcolor{preprocessor}{   TLS\_ECDHE\_ECDSA\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
1469       \textcolor{comment}{//A client that proposes ECC cipher suites in its ClientHello message}
1470       \textcolor{comment}{//may send the EcPointFormats extension}
1471       error = \hyperlink{tls__server__extensions_8c_ae22d1c58492882319be6973f889a2244}{tlsParseClientEcPointFormatsExtension}(context,
1472          extensions.\hyperlink{structTlsHelloExtensions_aeea7fd9313f97525e78c56a722b0dcfd}{ecPointFormatList});
1473       \textcolor{comment}{//Any error to report?}
1474       \textcolor{keywordflow}{if}(error)
1475          \textcolor{keywordflow}{return} error;
1476 \textcolor{preprocessor}{#endif}
1477 
1478 \textcolor{preprocessor}{#if (TLS\_EXT\_MASTER\_SECRET\_SUPPORT == ENABLED)}
1479       \textcolor{comment}{//Parse ExtendedMasterSecret extension}
1480       error = \hyperlink{tls__server__extensions_8c_a1964c308b6b9b35f1c6fc81e59ba2a83}{tlsParseClientEmsExtension}(context,
1481          extensions.\hyperlink{structTlsHelloExtensions_a04cc0ffcf992700820ec12d6f43212bf}{extendedMasterSecret});
1482       \textcolor{comment}{//Any error to report?}
1483       \textcolor{keywordflow}{if}(error)
1484          \textcolor{keywordflow}{return} error;
1485 \textcolor{preprocessor}{#endif}
1486    \}
1487    \textcolor{keywordflow}{else}
1488 \textcolor{preprocessor}{#endif}
1489 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
1490    \textcolor{comment}{//TLS 1.3 currently selected?}
1491    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_ab44dc642afbfbd72926ab1f94634cd4d}{TLS\_VERSION\_1\_3})
1492    \{
1493       \textcolor{comment}{//Save the client's legacy\_session\_id field}
1494       memcpy(context->sessionId, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionId, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen);
1495       context->sessionIdLen = \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sessionIdLen;
1496 
1497       \textcolor{comment}{//Perform cipher suite and key exchange method negotiation}
1498       error = \hyperlink{tls13__server__misc_8h_a649ccf93c250a1d8a6c1c4a63ca1660a}{tls13NegotiateCipherSuite}(context, 
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, cipherSuites,
1499          &extensions);
1500       \textcolor{comment}{//If no acceptable choices are presented, terminate the handshake}
1501       \textcolor{keywordflow}{if}(error)
1502          \textcolor{keywordflow}{return} error;
1503 
1504       \textcolor{comment}{//Parse the list of compression methods supported by the client}
1505       error = \hyperlink{tls__server__misc_8c_a7aec22c82399ab4173339771d47ceff7}{tlsParseCompressMethods}(context, compressMethods);
1506       \textcolor{comment}{//Any error to report?}
1507       \textcolor{keywordflow}{if}(error)
1508          \textcolor{keywordflow}{return} error;
1509 
1510       \textcolor{comment}{//When a PSK is used and early data is allowed for that PSK, the client}
1511       \textcolor{comment}{//can send application data in its first flight of messages}
1512       \textcolor{keywordflow}{if}(extensions.earlyDataIndication != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1513       \{
1514          \textcolor{comment}{//If the client opts to do so, it must supply both the PreSharedKey}
1515          \textcolor{comment}{//and EarlyData extensions (refer to RFC 8446, section 4.2.10)}
1516          \textcolor{keywordflow}{if}(extensions.identityList == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || extensions.binderList == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1517          \{
1518             context->earlyDataRejected = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1519          \}
1520       \}
1521    \}
1522    \textcolor{keywordflow}{else}
1523 \textcolor{preprocessor}{#endif}
1524    \textcolor{comment}{//Invalid TLS version?}
1525    \{
1526       \textcolor{comment}{//Just for sanity}
1527       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
1528    \}
1529 
1530 \textcolor{preprocessor}{#if (TLS\_MAX\_FRAG\_LEN\_SUPPORT == ENABLED && TLS\_RECORD\_SIZE\_LIMIT\_SUPPORT == ENABLED)}
1531    \textcolor{comment}{//A server that supports the RecordSizeLimit extension must ignore a}
1532    \textcolor{comment}{//MaxFragmentLength that appears in a ClientHello if both extensions}
1533    \textcolor{comment}{//appear (refer to RFC 8449, section 5)}
1534    \textcolor{keywordflow}{if}(extensions.\hyperlink{structTlsHelloExtensions_a45f3337429c669574aaedfcc6a1a2d23}{maxFragLen} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && extensions.\hyperlink{structTlsHelloExtensions_a35167138c60de81d1635fc1d87fc3b8f}{recordSizeLimit} != 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1535       extensions.\hyperlink{structTlsHelloExtensions_a45f3337429c669574aaedfcc6a1a2d23}{maxFragLen} = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1536 \textcolor{preprocessor}{#endif}
1537 
1538 \textcolor{preprocessor}{#if (TLS\_MAX\_FRAG\_LEN\_SUPPORT == ENABLED)}
1539    \textcolor{comment}{//In order to negotiate smaller maximum fragment lengths, clients may}
1540    \textcolor{comment}{//include a MaxFragmentLength extension}
1541    error = \hyperlink{tls__server__extensions_8c_a9cc022e4c7f789f6c9a82d1999e77c6a}{tlsParseClientMaxFragLenExtension}(context, extensions.
      \hyperlink{structTlsHelloExtensions_a45f3337429c669574aaedfcc6a1a2d23}{maxFragLen});
1542    \textcolor{comment}{//Any error to report?}
1543    \textcolor{keywordflow}{if}(error)
1544       \textcolor{keywordflow}{return} error;
1545 \textcolor{preprocessor}{#endif}
1546 
1547 \textcolor{preprocessor}{#if (TLS\_RECORD\_SIZE\_LIMIT\_SUPPORT == ENABLED)}
1548    \textcolor{comment}{//The value of RecordSizeLimit is the maximum size of record in octets}
1549    \textcolor{comment}{//that the peer is willing to receive}
1550    error = \hyperlink{tls__server__extensions_8c_a4525618ed7ee2f566b94acf4ae6b15af}{tlsParseClientRecordSizeLimitExtension}(context,
1551       extensions.\hyperlink{structTlsHelloExtensions_a35167138c60de81d1635fc1d87fc3b8f}{recordSizeLimit});
1552    \textcolor{comment}{//Any error to report?}
1553    \textcolor{keywordflow}{if}(error)
1554       \textcolor{keywordflow}{return} error;
1555 \textcolor{preprocessor}{#endif}
1556 
1557 \textcolor{preprocessor}{#if (TLS\_ALPN\_SUPPORT == ENABLED)}
1558    \textcolor{comment}{//Parse ALPN extension}
1559    error = \hyperlink{tls__server__extensions_8c_a951a27c0cca43690037251630f6511c2}{tlsParseClientAlpnExtension}(context, extensions.
      \hyperlink{structTlsHelloExtensions_a0752d52c09a933f5b001385db60159b1}{protocolNameList});
1560    \textcolor{comment}{//Any error to report?}
1561    \textcolor{keywordflow}{if}(error)
1562       \textcolor{keywordflow}{return} error;
1563 \textcolor{preprocessor}{#endif}
1564 
1565 \textcolor{preprocessor}{#if (TLS\_RAW\_PUBLIC\_KEY\_SUPPORT == ENABLED)}
1566    \textcolor{comment}{//Parse ClientCertType extension}
1567    error = \hyperlink{tls__server__extensions_8c_a8a2885ab0aadaad5b643aaccc0cc5949}{tlsParseClientCertTypeListExtension}(context,
1568       extensions.\hyperlink{structTlsHelloExtensions_a3091449503c4dcce58f3e62d70c24cd0}{clientCertTypeList});
1569    \textcolor{comment}{//Any error to report?}
1570    \textcolor{keywordflow}{if}(error)
1571       \textcolor{keywordflow}{return} error;
1572 
1573    \textcolor{comment}{//Parse ServerCertType extension}
1574    error = \hyperlink{tls__server__extensions_8c_aa5440eb1a18caf8461d6418167d79c5c}{tlsParseServerCertTypeListExtension}(context,
1575       extensions.\hyperlink{structTlsHelloExtensions_a7e4a609ad6013ea6bcab97286320cf16}{serverCertTypeList});
1576    \textcolor{comment}{//Any error to report?}
1577    \textcolor{keywordflow}{if}(error)
1578       \textcolor{keywordflow}{return} error;
1579 \textcolor{preprocessor}{#endif}
1580 
1581    \textcolor{comment}{//Version of TLS prior to TLS 1.3?}
1582    \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1583    \{
1584       \textcolor{comment}{//Send a ServerHello message to the client}
1585       context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da69787ce8e1f218e8e47defe7af1c601a}{TLS\_STATE\_SERVER\_HELLO};
1586    \}
1587    \textcolor{keywordflow}{else}
1588    \{
1589       \textcolor{comment}{//Send a ServerHello or a HelloRetryRequest message to the client}
1590       \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dade201db86ae38480c06696f3a48e0170}{TLS\_STATE\_CLIENT\_HELLO})
1591          context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da69787ce8e1f218e8e47defe7af1c601a}{TLS\_STATE\_SERVER\_HELLO};
1592       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da535ebf5eb2c0397b2d6ed43669f63a7d}{TLS\_STATE\_CLIENT\_HELLO\_2})
1593          context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da22971523377f52c52b251553e373b4c8}{TLS\_STATE\_SERVER\_HELLO\_2};
1594       \textcolor{keywordflow}{else}
1595          context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daa874b96bf23b3215942a719bbad609b5}{TLS\_STATE\_HELLO\_RETRY\_REQUEST};
1596    \}
1597 
1598    \textcolor{comment}{//Successful processing}
1599    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1600 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server_8c_a204fb38ba0d5de7703844660c79e0b40}\label{tls__server_8c_a204fb38ba0d5de7703844660c79e0b40}} 
\index{tls\+\_\+server.\+c@{tls\+\_\+server.\+c}!tls\+Parse\+Client\+Key\+Exchange@{tls\+Parse\+Client\+Key\+Exchange}}
\index{tls\+Parse\+Client\+Key\+Exchange@{tls\+Parse\+Client\+Key\+Exchange}!tls\+\_\+server.\+c@{tls\+\_\+server.\+c}}
\subsubsection{\texorpdfstring{tls\+Parse\+Client\+Key\+Exchange()}{tlsParseClientKeyExchange()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Parse\+Client\+Key\+Exchange (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{tls_8h_a88521372020709c027828954c0208b8f}{Tls\+Client\+Key\+Exchange} $\ast$}]{message,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Parse Client\+Key\+Exchange message. 

This message is always sent by the client. It must immediately follow the client Certificate message, if it is sent. Otherwise, it must be the first message sent by the client after it receives the Server\+Hello\+Done message


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em message} & Incoming Client\+Key\+Exchange message to parse \\
\hline
\mbox{\tt in}  & {\em length} & Message length \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1617 of file tls\+\_\+server.\+c.


\begin{DoxyCode}
1619 \{
1620    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1621    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1622    \textcolor{keyword}{const} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
1623 
1624    \textcolor{comment}{//Debug message}
1625    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"ClientKeyExchange message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
1626    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
1627 
1628    \textcolor{comment}{//Check TLS version}
1629    \textcolor{keywordflow}{if}(context->version > \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1630       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
1631 
1632    \textcolor{comment}{//Check current state}
1633    \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daf228b75114f59a280fff6ec472c5a251}{TLS\_STATE\_CLIENT\_CERTIFICATE})
1634    \{
1635       \textcolor{comment}{//A an non-anonymous server can optionally request a certificate from the client}
1636       \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01c48fe0c56e76f59032069e7c7da49e}{TLS\_KEY\_EXCH\_RSA} ||
1637          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01660ec1808dd6a8b5250b16d81502e4}{TLS\_KEY\_EXCH\_DHE\_RSA} ||
1638          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ac256323d1e243a2e7a435abce34dbd39}{TLS\_KEY\_EXCH\_DHE\_DSS} ||
1639          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ad9ebbdd436027753829ea5b6cd4b810b}{TLS\_KEY\_EXCH\_ECDHE\_RSA} ||
1640          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a14c521a28278eecd181953c37b784cb7}{TLS\_KEY\_EXCH\_ECDHE\_ECDSA} ||
1641          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a38a6d0551d2fbd9480b6c233c1242d4c}{TLS\_KEY\_EXCH\_RSA\_PSK})
1642       \{
1643          \textcolor{comment}{//If client authentication is required by the server for the handshake}
1644          \textcolor{comment}{//to continue, it may respond with a fatal handshake failure alert}
1645          \textcolor{keywordflow}{if}(context->clientAuthMode == \hyperlink{tls_8h_a657708ec632fe90da5a94cf667118527a5cbcc6f0c66081f9c833381df854d994}{TLS\_CLIENT\_AUTH\_REQUIRED})
1646             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca70d82df53df56c9d4a943d5539ccc4bc}{ERROR\_HANDSHAKE\_FAILED};
1647       \}
1648    \}
1649    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state != \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daec55a02fa5725d9b44460666d30b3a5c}{TLS\_STATE\_CLIENT\_KEY\_EXCHANGE})
1650    \{
1651       \textcolor{comment}{//Send a fatal alert to the client}
1652       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
1653    \}
1654 
1655    \textcolor{comment}{//Point to the beginning of the handshake message}
1656    p = \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
1657 
1658 \textcolor{preprocessor}{#if (TLS\_PSK\_KE\_SUPPORT == ENABLED || TLS\_RSA\_PSK\_KE\_SUPPORT == ENABLED || \(\backslash\)}
1659 \textcolor{preprocessor}{   TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
1660    \textcolor{comment}{//PSK key exchange method?}
1661    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aed949c3b521aa45b6685846fa9a3b8f0}{TLS\_KEY\_EXCH\_PSK} ||
1662       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a38a6d0551d2fbd9480b6c233c1242d4c}{TLS\_KEY\_EXCH\_RSA\_PSK} ||
1663       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a32a252b7c7befeccaa088290d6a71dfe}{TLS\_KEY\_EXCH\_DHE\_PSK} ||
1664       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aebba2060dba7ad92238668218f3a6520}{TLS\_KEY\_EXCH\_ECDHE\_PSK})
1665    \{
1666       \textcolor{comment}{//The PSK identity is sent in cleartext}
1667       error = \hyperlink{tls__server__misc_8c_a83d2e7ba7af8d605e367229331aabbbb}{tlsParsePskIdentity}(context, p, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, &n);
1668       \textcolor{comment}{//Any error to report?}
1669       \textcolor{keywordflow}{if}(error)
1670          \textcolor{keywordflow}{return} error;
1671 
1672       \textcolor{comment}{//Point to the next field}
1673       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1674       \textcolor{comment}{//Remaining bytes to process}
1675       \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1676    \}
1677 \textcolor{preprocessor}{#endif}
1678 
1679    \textcolor{comment}{//RSA, Diffie-Hellman or ECDH key exchange method?}
1680    \textcolor{keywordflow}{if}(context->keyExchMethod != \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aed949c3b521aa45b6685846fa9a3b8f0}{TLS\_KEY\_EXCH\_PSK})
1681    \{
1682       \textcolor{comment}{//Parse client's key exchange parameters}
1683       error = \hyperlink{tls__server__misc_8c_aeb2235551aa3828c696652a82ca808b6}{tlsParseClientKeyParams}(context, p, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, &n);
1684       \textcolor{comment}{//Any error to report?}
1685       \textcolor{keywordflow}{if}(error)
1686          \textcolor{keywordflow}{return} error;
1687 
1688       \textcolor{comment}{//Point to the next field}
1689       p += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1690       \textcolor{comment}{//Remaining bytes to process}
1691       \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1692    \}
1693 
1694    \textcolor{comment}{//If the amount of data in the message does not precisely match the format}
1695    \textcolor{comment}{//of the ClientKeyExchange message, then send a fatal alert}
1696    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} != 0)
1697       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1698 
1699 \textcolor{preprocessor}{#if (TLS\_PSK\_KE\_SUPPORT == ENABLED || TLS\_RSA\_PSK\_KE\_SUPPORT == ENABLED || \(\backslash\)}
1700 \textcolor{preprocessor}{   TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
1701    \textcolor{comment}{//PSK key exchange method?}
1702    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aed949c3b521aa45b6685846fa9a3b8f0}{TLS\_KEY\_EXCH\_PSK} ||
1703       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a38a6d0551d2fbd9480b6c233c1242d4c}{TLS\_KEY\_EXCH\_RSA\_PSK} ||
1704       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a32a252b7c7befeccaa088290d6a71dfe}{TLS\_KEY\_EXCH\_DHE\_PSK} ||
1705       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aebba2060dba7ad92238668218f3a6520}{TLS\_KEY\_EXCH\_ECDHE\_PSK})
1706    \{
1707       \textcolor{comment}{//Invalid pre-shared key?}
1708       \textcolor{keywordflow}{if}(context->pskLen == 0)
1709          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca3764b2929469f1eb1bf7af50b40df62f}{ERROR\_INVALID\_KEY\_LENGTH};
1710 
1711       \textcolor{comment}{//Generate premaster secret}
1712       error = \hyperlink{tls__key__material_8c_ac5650a18e65eed6e74b8d5ebec573a0d}{tlsGeneratePskPremasterSecret}(context);
1713       \textcolor{comment}{//Any error to report?}
1714       \textcolor{keywordflow}{if}(error)
1715          \textcolor{keywordflow}{return} error;
1716    \}
1717 \textcolor{preprocessor}{#endif}
1718 
1719    \textcolor{comment}{//Derive session keys from the premaster secret}
1720    error = \hyperlink{tls__key__material_8c_a48b57409ac1d3429ddc2e236ba8beeb3}{tlsGenerateSessionKeys}(context);
1721    \textcolor{comment}{//Unable to generate key material?}
1722    \textcolor{keywordflow}{if}(error)
1723       \textcolor{keywordflow}{return} error;
1724 
1725    \textcolor{comment}{//Update FSM state}
1726    \textcolor{keywordflow}{if}(context->peerCertType != \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffdae8286884ac120d31a1c3bbf125d116ec}{TLS\_CERT\_NONE})
1727       context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da0f0ff1805dfdec56bba42cbd8f42097b}{TLS\_STATE\_CLIENT\_CERTIFICATE\_VERIFY};
1728    \textcolor{keywordflow}{else}
1729       context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daf4ad5e0b1c92eb5991962aa9f3a6932b}{TLS\_STATE\_CLIENT\_CHANGE\_CIPHER\_SPEC};
1730 
1731    \textcolor{comment}{//Successful processing}
1732    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1733 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server_8c_a5f8b0853322153b88ff07e7bea633835}\label{tls__server_8c_a5f8b0853322153b88ff07e7bea633835}} 
\index{tls\+\_\+server.\+c@{tls\+\_\+server.\+c}!tls\+Send\+Certificate\+Request@{tls\+Send\+Certificate\+Request}}
\index{tls\+Send\+Certificate\+Request@{tls\+Send\+Certificate\+Request}!tls\+\_\+server.\+c@{tls\+\_\+server.\+c}}
\subsubsection{\texorpdfstring{tls\+Send\+Certificate\+Request()}{tlsSendCertificateRequest()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Send\+Certificate\+Request (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Send Certificate\+Request message. 

A server can optionally request a certificate from the client, if appropriate for the selected cipher suite. This message will immediately follow the Server\+Key\+Exchange message


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 262 of file tls\+\_\+server.\+c.


\begin{DoxyCode}
263 \{
264    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
265    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
266    \hyperlink{tls_8h_a207a823320ed0904352de25ac220b5d8}{TlsCertificateRequest} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
267 
268    \textcolor{comment}{//Initialize status code}
269    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
270 
271 \textcolor{preprocessor}{#if (TLS\_RSA\_SIGN\_SUPPORT == ENABLED || TLS\_RSA\_PSS\_SIGN\_SUPPORT == ENABLED || \(\backslash\)}
272 \textcolor{preprocessor}{   TLS\_DSA\_SIGN\_SUPPORT == ENABLED || TLS\_ECDSA\_SIGN\_SUPPORT == ENABLED)}
273    \textcolor{comment}{//A server can optionally request a certificate from the client}
274    \textcolor{keywordflow}{if}(context->clientAuthMode != \hyperlink{tls_8h_a657708ec632fe90da5a94cf667118527a8aeb84d9835fccbae53eac318679053d}{TLS\_CLIENT\_AUTH\_NONE})
275    \{
276       \textcolor{comment}{//Non-anonymous key exchange?}
277       \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01c48fe0c56e76f59032069e7c7da49e}{TLS\_KEY\_EXCH\_RSA} ||
278          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01660ec1808dd6a8b5250b16d81502e4}{TLS\_KEY\_EXCH\_DHE\_RSA} ||
279          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ac256323d1e243a2e7a435abce34dbd39}{TLS\_KEY\_EXCH\_DHE\_DSS} ||
280          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ad9ebbdd436027753829ea5b6cd4b810b}{TLS\_KEY\_EXCH\_ECDHE\_RSA} ||
281          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a14c521a28278eecd181953c37b784cb7}{TLS\_KEY\_EXCH\_ECDHE\_ECDSA} ||
282          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a38a6d0551d2fbd9480b6c233c1242d4c}{TLS\_KEY\_EXCH\_RSA\_PSK} ||
283          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a73afc728c1b23fef9f03ce4a08d0e20b}{TLS13\_KEY\_EXCH\_DHE} ||
284          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a3cde206533769f2a174205875bd0b8da}{TLS13\_KEY\_EXCH\_ECDHE})
285       \{
286          \textcolor{comment}{//Point to the buffer where to format the message}
287          message = (\hyperlink{tls_8h_a207a823320ed0904352de25ac220b5d8}{TlsCertificateRequest} *) (context->txBuffer + context->txBufferLen
      );
288 
289          \textcolor{comment}{//Format CertificateRequest message}
290          error = \hyperlink{tls__server_8c_a422aa0a39a41b30d586a06b9d42dbbdf}{tlsFormatCertificateRequest}(context, message, &length);
291 
292          \textcolor{comment}{//Check status code}
293          \textcolor{keywordflow}{if}(!error)
294          \{
295             \textcolor{comment}{//Debug message}
296             \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending CertificateRequest message (%"} 
      \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
297             \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, message, length);
298 
299             \textcolor{comment}{//Send handshake message}
300             error = \hyperlink{tls__handshake_8c_ad729f5d4a23f051eebf844a6fe4964cd}{tlsSendHandshakeMessage}(context, message, length,
301                \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9badf4f63379ab93eec891cdbae8f8a2717}{TLS\_TYPE\_CERTIFICATE\_REQUEST});
302          \}
303       \}
304    \}
305 \textcolor{preprocessor}{#endif}
306 
307    \textcolor{comment}{//Check status code}
308    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == 
      \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
309    \{
310       \textcolor{comment}{//Version of TLS prior to TLS 1.3?}
311       \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
312       \{
313          \textcolor{comment}{//Send a ServerHelloDone message to the client}
314          context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dacfeeaa75eec1aecc4c975236b2af1f9c}{TLS\_STATE\_SERVER\_HELLO\_DONE};
315       \}
316       \textcolor{keywordflow}{else}
317       \{
318          \textcolor{comment}{//Send a Certificate message to the client}
319          context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da09790eaca7bac9c6bfd5b3e0775b6074}{TLS\_STATE\_SERVER\_CERTIFICATE};
320       \}
321    \}
322 
323    \textcolor{comment}{//Return status code}
324    \textcolor{keywordflow}{return} error;
325 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server_8c_a67975b6b6f060d494e01cc75e171fecf}\label{tls__server_8c_a67975b6b6f060d494e01cc75e171fecf}} 
\index{tls\+\_\+server.\+c@{tls\+\_\+server.\+c}!tls\+Send\+Server\+Hello@{tls\+Send\+Server\+Hello}}
\index{tls\+Send\+Server\+Hello@{tls\+Send\+Server\+Hello}!tls\+\_\+server.\+c@{tls\+\_\+server.\+c}}
\subsubsection{\texorpdfstring{tls\+Send\+Server\+Hello()}{tlsSendServerHello()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Send\+Server\+Hello (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Send Server\+Hello message. 

The server will send this message in response to a Client\+Hello message when it was able to find an acceptable set of algorithms. If it cannot find such a match, it will respond with a handshake failure alert


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 83 of file tls\+\_\+server.\+c.


\begin{DoxyCode}
84 \{
85    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
86    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
87    \hyperlink{tls_8h_a3b37d03b4f71ce65b23f369d2040a245}{TlsServerHello} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
88 
89    \textcolor{comment}{//Point to the buffer where to format the message}
90    message = (\hyperlink{tls_8h_a3b37d03b4f71ce65b23f369d2040a245}{TlsServerHello} *) (context->txBuffer + context->txBufferLen);
91 
92    \textcolor{comment}{//Generate the server random value using a cryptographically-safe}
93    \textcolor{comment}{//pseudorandom number generator}
94    error = \hyperlink{tls__misc_8c_a316db53174c47a590bc25a2aadae6af6}{tlsGenerateRandomValue}(context, context->serverRandom);
95 
96    \textcolor{comment}{//Check status code}
97    \textcolor{keywordflow}{if}(!error)
98    \{
99       \textcolor{comment}{//Format ServerHello message}
100       error = \hyperlink{tls__server_8c_a4d8dee25b92b399334e45683b466f403}{tlsFormatServerHello}(context, message, &length);
101    \}
102 
103    \textcolor{comment}{//Check status code}
104    \textcolor{keywordflow}{if}(!error)
105    \{
106       \textcolor{comment}{//Debug message}
107       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending ServerHello message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
108       \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, message, length);
109 
110       \textcolor{comment}{//Send handshake message}
111       error = \hyperlink{tls__handshake_8c_ad729f5d4a23f051eebf844a6fe4964cd}{tlsSendHandshakeMessage}(context, message, length,
112          \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba0ec92de95e5ea4899b69affe1bc7aeac}{TLS\_TYPE\_SERVER\_HELLO});
113    \}
114 
115    \textcolor{comment}{//Check status code}
116    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == 
      \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
117    \{
118       \textcolor{comment}{//Version of TLS prior to TLS 1.3?}
119       \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
120       \{
121 \textcolor{preprocessor}{#if (TLS\_SESSION\_RESUME\_SUPPORT == ENABLED)}
122          \textcolor{comment}{//Use abbreviated handshake?}
123          \textcolor{keywordflow}{if}(context->resume)
124          \{
125             \textcolor{comment}{//Derive session keys from the master secret}
126             error = \hyperlink{tls__key__material_8c_a48b57409ac1d3429ddc2e236ba8beeb3}{tlsGenerateSessionKeys}(context);
127 
128             \textcolor{comment}{//Key material successfully generated?}
129             \textcolor{keywordflow}{if}(!error)
130             \{
131                \textcolor{comment}{//At this point, both client and server must send ChangeCipherSpec}
132                \textcolor{comment}{//messages and proceed directly to Finished messages}
133                context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da0023cfdc8ed0f0062637380bee3683a0}{TLS\_STATE\_SERVER\_CHANGE\_CIPHER\_SPEC};
134             \}
135          \}
136          \textcolor{keywordflow}{else}
137 \textcolor{preprocessor}{#endif}
138          \{
139             \textcolor{comment}{//Perform a full handshake}
140             context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da09790eaca7bac9c6bfd5b3e0775b6074}{TLS\_STATE\_SERVER\_CERTIFICATE};
141          \}
142       \}
143       \textcolor{keywordflow}{else}
144       \{
145 \textcolor{preprocessor}{#if (TLS13\_MIDDLEBOX\_COMPAT\_SUPPORT == ENABLED)}
146          \textcolor{comment}{//First handshake message sent by the server?}
147          \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da69787ce8e1f218e8e47defe7af1c601a}{TLS\_STATE\_SERVER\_HELLO})
148          \{
149             \textcolor{comment}{//In middlebox compatibility mode, the server must send a dummy}
150             \textcolor{comment}{//ChangeCipherSpec record immediately after its first handshake}
151             \textcolor{comment}{//message}
152             context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da0023cfdc8ed0f0062637380bee3683a0}{TLS\_STATE\_SERVER\_CHANGE\_CIPHER\_SPEC};
153          \}
154          \textcolor{keywordflow}{else}
155 \textcolor{preprocessor}{#endif}
156          \{
157             \textcolor{comment}{//All handshake messages after the ServerHello are now encrypted}
158             context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daeb443224abb7649fc9e8adf3e51864a2}{TLS\_STATE\_HANDSHAKE\_TRAFFIC\_KEYS};
159          \}
160       \}
161    \}
162 
163    \textcolor{comment}{//Return status code}
164    \textcolor{keywordflow}{return} error;
165 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server_8c_a1bc3bb08a169817c6105f9f5f13f58ac}\label{tls__server_8c_a1bc3bb08a169817c6105f9f5f13f58ac}} 
\index{tls\+\_\+server.\+c@{tls\+\_\+server.\+c}!tls\+Send\+Server\+Hello\+Done@{tls\+Send\+Server\+Hello\+Done}}
\index{tls\+Send\+Server\+Hello\+Done@{tls\+Send\+Server\+Hello\+Done}!tls\+\_\+server.\+c@{tls\+\_\+server.\+c}}
\subsubsection{\texorpdfstring{tls\+Send\+Server\+Hello\+Done()}{tlsSendServerHelloDone()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Send\+Server\+Hello\+Done (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Send Server\+Hello\+Done message. 

The Server\+Hello\+Done message is sent by the server to indicate the end of the Server\+Hello and associated messages. After sending this message, the server will wait for a client response


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 339 of file tls\+\_\+server.\+c.


\begin{DoxyCode}
340 \{
341    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
342    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
343    \hyperlink{tls_8h_a71e29f87ab91f2adb5655ad8157e7aea}{TlsServerHelloDone} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
344 
345    \textcolor{comment}{//Point to the buffer where to format the message}
346    message = (\hyperlink{tls_8h_a71e29f87ab91f2adb5655ad8157e7aea}{TlsServerHelloDone} *) (context->txBuffer + context->txBufferLen);
347 
348    \textcolor{comment}{//Format ServerHelloDone message}
349    error = \hyperlink{tls__server_8c_ac2375898dec7aa0ceaff2faefd467f76}{tlsFormatServerHelloDone}(context, message, &length);
350 
351    \textcolor{comment}{//Check status code}
352    \textcolor{keywordflow}{if}(!error)
353    \{
354       \textcolor{comment}{//Debug message}
355       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending ServerHelloDone message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
356       \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, message, length);
357 
358       \textcolor{comment}{//Send handshake message}
359       error = \hyperlink{tls__handshake_8c_ad729f5d4a23f051eebf844a6fe4964cd}{tlsSendHandshakeMessage}(context, message, length,
360          \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba979c5881efc687024fa12190b925ac1f}{TLS\_TYPE\_SERVER\_HELLO\_DONE});
361    \}
362 
363    \textcolor{comment}{//Check status code}
364    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == 
      \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
365    \{
366       \textcolor{comment}{//The client must send a Certificate message if the server requests it}
367       \textcolor{keywordflow}{if}(context->clientAuthMode != \hyperlink{tls_8h_a657708ec632fe90da5a94cf667118527a8aeb84d9835fccbae53eac318679053d}{TLS\_CLIENT\_AUTH\_NONE})
368          context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daf228b75114f59a280fff6ec472c5a251}{TLS\_STATE\_CLIENT\_CERTIFICATE};
369       \textcolor{keywordflow}{else}
370          context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daec55a02fa5725d9b44460666d30b3a5c}{TLS\_STATE\_CLIENT\_KEY\_EXCHANGE};
371    \}
372 
373    \textcolor{comment}{//Return status code}
374    \textcolor{keywordflow}{return} error;
375 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server_8c_a5b4084306cc9d8e1d083e272cd98aef1}\label{tls__server_8c_a5b4084306cc9d8e1d083e272cd98aef1}} 
\index{tls\+\_\+server.\+c@{tls\+\_\+server.\+c}!tls\+Send\+Server\+Key\+Exchange@{tls\+Send\+Server\+Key\+Exchange}}
\index{tls\+Send\+Server\+Key\+Exchange@{tls\+Send\+Server\+Key\+Exchange}!tls\+\_\+server.\+c@{tls\+\_\+server.\+c}}
\subsubsection{\texorpdfstring{tls\+Send\+Server\+Key\+Exchange()}{tlsSendServerKeyExchange()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Send\+Server\+Key\+Exchange (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Send Server\+Key\+Exchange message. 

The Server\+Key\+Exchange message is sent by the server only when the server Certificate message does not contain enough data to allow the client to exchange a premaster secret


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 179 of file tls\+\_\+server.\+c.


\begin{DoxyCode}
180 \{
181    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
182    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
183    \hyperlink{tls_8h_a69c0b3ab7349e73b2e8f9452dbdfef5a}{TlsServerKeyExchange} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
184 
185    \textcolor{comment}{//Initialize status code}
186    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
187 
188    \textcolor{comment}{//Point to the buffer where to format the message}
189    message = (\hyperlink{tls_8h_a69c0b3ab7349e73b2e8f9452dbdfef5a}{TlsServerKeyExchange} *) (context->txBuffer + context->txBufferLen);
190    \textcolor{comment}{//Initialize length}
191    length = 0;
192 
193    \textcolor{comment}{//The ServerKeyExchange message is sent by the server only when the server}
194    \textcolor{comment}{//Certificate message (if sent) does not contain enough data to allow the}
195    \textcolor{comment}{//client to exchange a premaster secret}
196    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a33535bd987c46f1ba621d6e28b0b3bfa}{TLS\_KEY\_EXCH\_DH\_ANON} ||
197       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01660ec1808dd6a8b5250b16d81502e4}{TLS\_KEY\_EXCH\_DHE\_RSA} ||
198       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ac256323d1e243a2e7a435abce34dbd39}{TLS\_KEY\_EXCH\_DHE\_DSS} ||
199       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a32a252b7c7befeccaa088290d6a71dfe}{TLS\_KEY\_EXCH\_DHE\_PSK} ||
200       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a895e0af86b29640264f699235be22953}{TLS\_KEY\_EXCH\_ECDH\_ANON} ||
201       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ad9ebbdd436027753829ea5b6cd4b810b}{TLS\_KEY\_EXCH\_ECDHE\_RSA} ||
202       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a14c521a28278eecd181953c37b784cb7}{TLS\_KEY\_EXCH\_ECDHE\_ECDSA} ||
203       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aebba2060dba7ad92238668218f3a6520}{TLS\_KEY\_EXCH\_ECDHE\_PSK})
204    \{
205       \textcolor{comment}{//Format ServerKeyExchange message}
206       error = \hyperlink{tls__server_8c_ae9133776b8d42f0da84f6b8446448069}{tlsFormatServerKeyExchange}(context, message, &length);
207    \}
208    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aed949c3b521aa45b6685846fa9a3b8f0}{TLS\_KEY\_EXCH\_PSK} ||
209       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a38a6d0551d2fbd9480b6c233c1242d4c}{TLS\_KEY\_EXCH\_RSA\_PSK})
210    \{
211 \textcolor{preprocessor}{#if (TLS\_PSK\_KE\_SUPPORT == ENABLED || TLS\_RSA\_PSK\_KE\_SUPPORT == ENABLED || \(\backslash\)}
212 \textcolor{preprocessor}{   TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
213       \textcolor{comment}{//If no PSK identity hint is provided by the server, the}
214       \textcolor{comment}{//ServerKeyExchange message is omitted...}
215       \textcolor{keywordflow}{if}(context->pskIdentityHint != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
216       \{
217          \textcolor{comment}{//Format ServerKeyExchange message}
218          error = \hyperlink{tls__server_8c_ae9133776b8d42f0da84f6b8446448069}{tlsFormatServerKeyExchange}(context, message, &length);
219       \}
220 \textcolor{preprocessor}{#endif}
221    \}
222 
223    \textcolor{comment}{//Check status code}
224    \textcolor{keywordflow}{if}(!error)
225    \{
226       \textcolor{comment}{//Any message to send?}
227       \textcolor{keywordflow}{if}(length > 0)
228       \{
229          \textcolor{comment}{//Debug message}
230          \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending ServerKeyExchange message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      length);
231          \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, message, length);
232 
233          \textcolor{comment}{//Send handshake message}
234          error = \hyperlink{tls__handshake_8c_ad729f5d4a23f051eebf844a6fe4964cd}{tlsSendHandshakeMessage}(context, message, length,
235             \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9baa4910b2d8fcdfb42e1e3199e634ce290}{TLS\_TYPE\_SERVER\_KEY\_EXCHANGE});
236       \}
237    \}
238 
239    \textcolor{comment}{//Check status code}
240    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == 
      \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
241    \{
242       \textcolor{comment}{//A server can optionally request a certificate from the client}
243       context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dae316fcecd0b42b329c94f5c3102d8783}{TLS\_STATE\_CERTIFICATE\_REQUEST};
244    \}
245 
246    \textcolor{comment}{//Return status code}
247    \textcolor{keywordflow}{return} error;
248 \}
\end{DoxyCode}
