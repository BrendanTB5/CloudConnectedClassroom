\hypertarget{ksz8851__driver_8c}{}\section{cyclone\+\_\+tcp/drivers/eth/ksz8851\+\_\+driver.c File Reference}
\label{ksz8851__driver_8c}\index{cyclone\+\_\+tcp/drivers/eth/ksz8851\+\_\+driver.\+c@{cyclone\+\_\+tcp/drivers/eth/ksz8851\+\_\+driver.\+c}}


K\+S\+Z8851 Ethernet controller.  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}drivers/eth/ksz8851\+\_\+driver.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{ksz8851__driver_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_a880f48968c7969b328d5061cd3db0f36}{N\+I\+C\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ksz8851__driver_8c_a186b0060fd6765f41161c4627848dcd6}{ksz8851\+Init} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em K\+S\+Z8851 controller initialization. \end{DoxyCompactList}\item 
void \hyperlink{ksz8851__driver_8c_a365f1ffe985b4c6659aa073d09be1915}{ksz8851\+Tick} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em K\+S\+Z8851 timer handler. \end{DoxyCompactList}\item 
void \hyperlink{ksz8851__driver_8c_a42cb93cb84b62261bb79831984a3c424}{ksz8851\+Enable\+Irq} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Enable interrupts. \end{DoxyCompactList}\item 
void \hyperlink{ksz8851__driver_8c_adc5dafbc3317849b70d9adebffdd406f}{ksz8851\+Disable\+Irq} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Disable interrupts. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} \hyperlink{ksz8851__driver_8c_ae585abc2f8c0c4f7c40185adbbe2b8e2}{ksz8851\+Irq\+Handler} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em K\+S\+Z8851 interrupt service routine. \end{DoxyCompactList}\item 
void \hyperlink{ksz8851__driver_8c_ab18e69306f5d7c095355ee869f9534bc}{ksz8851\+Event\+Handler} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em K\+S\+Z8851 event handler. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ksz8851__driver_8c_a3c86aab5a7d93e8113fec206d81ed919}{ksz8851\+Send\+Packet} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset})
\begin{DoxyCompactList}\small\item\em Send a packet. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ksz8851__driver_8c_a9b698a3429eee4429854e20d0da4b846}{ksz8851\+Receive\+Packet} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Receive a packet. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ksz8851__driver_8c_a07ebd7cb74831854ec0f495962a70d4f}{ksz8851\+Update\+Mac\+Addr\+Filter} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Configure M\+AC address filtering. \end{DoxyCompactList}\item 
void \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851\+Write\+Reg} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data})
\begin{DoxyCompactList}\small\item\em Write K\+S\+Z8851 register. \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851\+Read\+Reg} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address})
\begin{DoxyCompactList}\small\item\em Read K\+S\+Z8851 register. \end{DoxyCompactList}\item 
void \hyperlink{ksz8851__driver_8c_ab9e070e0729fadead1c9234759fff35e}{ksz8851\+Write\+Fifo} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Write TX F\+I\+FO. \end{DoxyCompactList}\item 
void \hyperlink{ksz8851__driver_8c_a7d58bda818d6ec73381eeded55a953ab}{ksz8851\+Read\+Fifo} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Read RX F\+I\+FO. \end{DoxyCompactList}\item 
void \hyperlink{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}{ksz8851\+Set\+Bit} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{web__socket_8h_a8a74907784be6c7786c2d060c8d7e10b}{mask})
\begin{DoxyCompactList}\small\item\em Set bit field. \end{DoxyCompactList}\item 
void \hyperlink{ksz8851__driver_8c_ac499452d26bdeee97af794c569b15461}{ksz8851\+Clear\+Bit} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{web__socket_8h_a8a74907784be6c7786c2d060c8d7e10b}{mask})
\begin{DoxyCompactList}\small\item\em Clear bit field. \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{ksz8851__driver_8c_a5bff5fc708e670bad154ff80fe10ab15}{ksz8851\+Calc\+Crc} (const void $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em C\+RC calculation. \end{DoxyCompactList}\item 
void \hyperlink{ksz8851__driver_8c_a2590da7dfc5fc52ecbe8fd6c051a661c}{ksz8851\+Dump\+Reg} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Dump registers for debugging purpose. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
const \hyperlink{structNicDriver}{Nic\+Driver} \hyperlink{ksz8851__driver_8c_a48192455996c9bc18f57ebaf765ff2a3}{ksz8851\+Driver}
\begin{DoxyCompactList}\small\item\em K\+S\+Z8851 driver. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
K\+S\+Z8851 Ethernet controller. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{ksz8851__driver_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{ksz8851__driver_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_a880f48968c7969b328d5061cd3db0f36}{N\+I\+C\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file ksz8851\+\_\+driver.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{ksz8851__driver_8c_a5bff5fc708e670bad154ff80fe10ab15}\label{ksz8851__driver_8c_a5bff5fc708e670bad154ff80fe10ab15}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Calc\+Crc@{ksz8851\+Calc\+Crc}}
\index{ksz8851\+Calc\+Crc@{ksz8851\+Calc\+Crc}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Calc\+Crc()}{ksz8851CalcCrc()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} ksz8851\+Calc\+Crc (\begin{DoxyParamCaption}\item[{const void $\ast$}]{data,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



C\+RC calculation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em data} & Pointer to the data over which to calculate the C\+RC \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes to process \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Resulting C\+RC value 
\end{DoxyReturn}


Definition at line 776 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
777 \{
778    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
779    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} j;
780 
781    \textcolor{comment}{//Point to the data over which to calculate the CRC}
782    \textcolor{keyword}{const} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
783    \textcolor{comment}{//CRC preset value}
784    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} crc = 0xFFFFFFFF;
785 
786    \textcolor{comment}{//Loop through data}
787    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}; i++)
788    \{
789       \textcolor{comment}{//The message is processed bit by bit}
790       \textcolor{keywordflow}{for}(j = 0; j < 8; j++)
791       \{
792          \textcolor{comment}{//Update CRC value}
793          \textcolor{keywordflow}{if}(((crc >> 31) ^ (p[i] >> j)) & 0x01)
794             crc = (crc << 1) ^ 0x04C11DB7;
795          \textcolor{keywordflow}{else}
796             crc = crc << 1;
797       \}
798    \}
799 
800    \textcolor{comment}{//Return CRC value}
801    \textcolor{keywordflow}{return} crc;
802 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_ac499452d26bdeee97af794c569b15461}\label{ksz8851__driver_8c_ac499452d26bdeee97af794c569b15461}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Clear\+Bit@{ksz8851\+Clear\+Bit}}
\index{ksz8851\+Clear\+Bit@{ksz8851\+Clear\+Bit}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Clear\+Bit()}{ksz8851ClearBit()}}
{\footnotesize\ttfamily void ksz8851\+Clear\+Bit (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{address,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{mask }\end{DoxyParamCaption})}



Clear bit field. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em address} & Register address \\
\hline
\mbox{\tt in}  & {\em mask} & Bits to clear in the target register \\
\hline
\end{DoxyParams}


Definition at line 758 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
759 \{
760    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
761 
762    \textcolor{comment}{//Read current register value}
763    value = \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address});
764    \textcolor{comment}{//Clear specified bits}
765    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address}, value & ~\hyperlink{web__socket_8h_a8a74907784be6c7786c2d060c8d7e10b}{mask});
766 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_adc5dafbc3317849b70d9adebffdd406f}\label{ksz8851__driver_8c_adc5dafbc3317849b70d9adebffdd406f}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Disable\+Irq@{ksz8851\+Disable\+Irq}}
\index{ksz8851\+Disable\+Irq@{ksz8851\+Disable\+Irq}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Disable\+Irq()}{ksz8851DisableIrq()}}
{\footnotesize\ttfamily void ksz8851\+Disable\+Irq (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Disable interrupts. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 200 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
201 \{
202    \textcolor{comment}{//Disable interrupts}
203    interface->extIntDriver->disableIrq();
204 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_a2590da7dfc5fc52ecbe8fd6c051a661c}\label{ksz8851__driver_8c_a2590da7dfc5fc52ecbe8fd6c051a661c}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Dump\+Reg@{ksz8851\+Dump\+Reg}}
\index{ksz8851\+Dump\+Reg@{ksz8851\+Dump\+Reg}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Dump\+Reg()}{ksz8851DumpReg()}}
{\footnotesize\ttfamily void ksz8851\+Dump\+Reg (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Dump registers for debugging purpose. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 810 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
811 \{
812 \textcolor{preprocessor}{#if (TRACE\_LEVEL >= TRACE\_LEVEL\_DEBUG)}
813    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
814    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} j;
815    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
816 
817    \textcolor{comment}{//Loop through register addresses}
818    \textcolor{keywordflow}{for}(i = 0; i < 256; i += 16)
819    \{
820       \textcolor{comment}{//Display register address}
821       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"%02"} PRIu8 \textcolor{stringliteral}{": "}, i);
822 
823       \textcolor{comment}{//Display 8 registers at a time}
824       \textcolor{keywordflow}{for}(j = 0; j < 16; j += 2)
825       \{
826          \textcolor{comment}{//Format register address}
827          address = i + j;
828          \textcolor{comment}{//Display register contents}
829          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"0x%04"} PRIX16 \textcolor{stringliteral}{"  "}, \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, address));
830       \}
831 
832       \textcolor{comment}{//Jump to the following line}
833       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
834    \}
835 
836    \textcolor{comment}{//Terminate with a line feed}
837    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
838 \textcolor{preprocessor}{#endif}
839 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_a42cb93cb84b62261bb79831984a3c424}\label{ksz8851__driver_8c_a42cb93cb84b62261bb79831984a3c424}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Enable\+Irq@{ksz8851\+Enable\+Irq}}
\index{ksz8851\+Enable\+Irq@{ksz8851\+Enable\+Irq}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Enable\+Irq()}{ksz8851EnableIrq()}}
{\footnotesize\ttfamily void ksz8851\+Enable\+Irq (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Enable interrupts. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 188 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
189 \{
190    \textcolor{comment}{//Enable interrupts}
191    interface->extIntDriver->enableIrq();
192 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_ab18e69306f5d7c095355ee869f9534bc}\label{ksz8851__driver_8c_ab18e69306f5d7c095355ee869f9534bc}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Event\+Handler@{ksz8851\+Event\+Handler}}
\index{ksz8851\+Event\+Handler@{ksz8851\+Event\+Handler}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Event\+Handler()}{ksz8851EventHandler()}}
{\footnotesize\ttfamily void ksz8851\+Event\+Handler (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



K\+S\+Z8851 event handler. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 285 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
286 \{
287    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} status;
288    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} frameCount;
289 
290    \textcolor{comment}{//Read interrupt status register}
291    status = \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, \hyperlink{ksz8851__driver_8h_aec91ddf2f7c70dce4b2353c33c9ad734}{KSZ8851\_REG\_ISR});
292 
293    \textcolor{comment}{//Check whether the link status has changed?}
294    \textcolor{keywordflow}{if}(status & \hyperlink{ksz8851__driver_8h_a8ae5166d52e93ddb6a0969033a6d315e}{ISR\_LCIS})
295    \{
296       \textcolor{comment}{//Clear interrupt flag}
297       \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_aec91ddf2f7c70dce4b2353c33c9ad734}{KSZ8851\_REG\_ISR}, ISR\_LCIS);
298       \textcolor{comment}{//Read PHY status register}
299       status = \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, \hyperlink{ksz8851__driver_8h_add77e1d9a6bef2d8ea89ef40b5eca443}{KSZ8851\_REG\_P1SR});
300 
301       \textcolor{comment}{//Check link state}
302       \textcolor{keywordflow}{if}(status & \hyperlink{ksz8851__driver_8h_aea6ffbf6b44c8508b828d98bfe7998b3}{P1SR\_LINK\_GOOD})
303       \{
304          \textcolor{comment}{//Get current speed}
305          \textcolor{keywordflow}{if}(status & \hyperlink{ksz8851__driver_8h_a04b8205d66b4b69fafc385712710c58d}{P1SR\_OPERATION\_SPEED})
306             interface->linkSpeed = \hyperlink{nic_8h_afef666155a43e0a2a3a1f0df9e50bab4a3001394d2b59b22c97f6957e07ca28fd}{NIC\_LINK\_SPEED\_100MBPS};
307          \textcolor{keywordflow}{else}
308             interface->linkSpeed = \hyperlink{nic_8h_afef666155a43e0a2a3a1f0df9e50bab4a43656b0244470a43d497c77353f3da84}{NIC\_LINK\_SPEED\_10MBPS};
309 
310          \textcolor{comment}{//Determine the new duplex mode}
311          \textcolor{keywordflow}{if}(status & \hyperlink{ksz8851__driver_8h_a2c10013457f26027066e702988463079}{P1SR\_OPERATION\_DUPLEX})
312             interface->duplexMode = \hyperlink{nic_8h_ae96e77ca948a3796e2d1900a73f133daa2c75584234136d8fd79f372116d26340}{NIC\_FULL\_DUPLEX\_MODE};
313          \textcolor{keywordflow}{else}
314             interface->duplexMode = \hyperlink{nic_8h_ae96e77ca948a3796e2d1900a73f133daa60856f1c6ecbcb1227b653fb48205f41}{NIC\_HALF\_DUPLEX\_MODE};
315 
316          \textcolor{comment}{//Link is up}
317          interface->linkState = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
318       \}
319       \textcolor{keywordflow}{else}
320       \{
321          \textcolor{comment}{//Link is down}
322          interface->linkState = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
323       \}
324 
325       \textcolor{comment}{//Process link state change event}
326       \hyperlink{nic_8c_ae9054795c5d49a4db97396bf1d16b413}{nicNotifyLinkChange}(interface);
327    \}
328 
329    \textcolor{comment}{//Check whether a packet has been received?}
330    \textcolor{keywordflow}{if}(status & \hyperlink{ksz8851__driver_8h_a6a0cf2021712e7bb54ebed8e70706b8b}{ISR\_RXIS})
331    \{
332       \textcolor{comment}{//Clear interrupt flag}
333       \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_aec91ddf2f7c70dce4b2353c33c9ad734}{KSZ8851\_REG\_ISR}, ISR\_RXIS);
334       \textcolor{comment}{//Get the total number of frames that are pending in the buffer}
335       frameCount = \hyperlink{os__port_8h_aeb61a4e8fff2f4624a632a3189cbd3a0}{MSB}(\hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, 
      \hyperlink{ksz8851__driver_8h_a1d96b972d8816d782250278882173582}{KSZ8851\_REG\_RXFCTR}));
336 
337       \textcolor{comment}{//Process all pending packets}
338       \textcolor{keywordflow}{while}(frameCount > 0)
339       \{
340          \textcolor{comment}{//Read incoming packet}
341          \hyperlink{ksz8851__driver_8c_a9b698a3429eee4429854e20d0da4b846}{ksz8851ReceivePacket}(interface);
342          \textcolor{comment}{//Decrement frame counter}
343          frameCount--;
344       \}
345    \}
346 
347    \textcolor{comment}{//Re-enable LCIE and RXIE interrupts}
348    \hyperlink{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}{ksz8851SetBit}(interface, \hyperlink{ksz8851__driver_8h_aee6696fa9779cdef71b67fc997e683c0}{KSZ8851\_REG\_IER}, 
      \hyperlink{ksz8851__driver_8h_a2e9e6254a5bcddc2a17fe4066f2c7aed}{IER\_LCIE} | \hyperlink{ksz8851__driver_8h_ac9d5863509c80a2dcc7af046ff2a0f68}{IER\_RXIE});
349 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_a186b0060fd6765f41161c4627848dcd6}\label{ksz8851__driver_8c_a186b0060fd6765f41161c4627848dcd6}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Init@{ksz8851\+Init}}
\index{ksz8851\+Init@{ksz8851\+Init}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Init()}{ksz8851Init()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ksz8851\+Init (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



K\+S\+Z8851 controller initialization. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 71 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
72 \{
73    \textcolor{comment}{//Point to the driver context}
74    \hyperlink{structKsz8851Context}{Ksz8851Context} *context = (\hyperlink{structKsz8851Context}{Ksz8851Context} *) interface->nicContext;
75 
76    \textcolor{comment}{//Debug message}
77    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Initializing KSZ8851 Ethernet controller...\(\backslash\)r\(\backslash\)n"});
78 
79 \textcolor{preprocessor}{#if (KSZ8851\_SPI\_SUPPORT == ENABLED)}
80    \textcolor{comment}{//Initialize SPI}
81    interface->spiDriver->init();
82 \textcolor{preprocessor}{#endif}
83 
84    \textcolor{comment}{//Initialize external interrupt line}
85    interface->extIntDriver->init();
86 
87    \textcolor{comment}{//Debug message}
88    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"CIDER=0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, 
      \hyperlink{ksz8851__driver_8h_a95699e55cc1c0bd84e1c94d9743da593}{KSZ8851\_REG\_CIDER}));
89    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"PHY1ILR=0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, 
      \hyperlink{ksz8851__driver_8h_a5d6ef9aebd96ae4e21b9d31cf34bc900}{KSZ8851\_REG\_PHY1ILR}));
90    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"PHY1IHR=0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, 
      \hyperlink{ksz8851__driver_8h_a355b68999fbed28a79ec07db21df519e}{KSZ8851\_REG\_PHY1IHR}));
91 
92    \textcolor{comment}{//Check device ID and revision ID}
93    \textcolor{keywordflow}{if}(\hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, \hyperlink{ksz8851__driver_8h_a95699e55cc1c0bd84e1c94d9743da593}{KSZ8851\_REG\_CIDER}) != 
      \hyperlink{ksz8851__driver_8h_a6fbcd30e7b76929bb7a6873ef0a65119}{KSZ8851\_REV\_A3\_ID})
94       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca2bc2298123e24e3d82592b5c68c20612}{ERROR\_WRONG\_IDENTIFIER};
95 
96    \textcolor{comment}{//Dump registers for debugging purpose}
97    \hyperlink{ksz8851__driver_8c_a2590da7dfc5fc52ecbe8fd6c051a661c}{ksz8851DumpReg}(interface);
98 
99    \textcolor{comment}{//Initialize driver specific variables}
100    context->\hyperlink{structKsz8851Context_a424b2fc6743cfc3c31cf59164610ee89}{frameId} = 0;
101 
102    \textcolor{comment}{//Allocate TX and RX buffers}
103    context->\hyperlink{structKsz8851Context_a9eef3244c4dcc6554dc1e8a0243491eb}{txBuffer} = \hyperlink{net__mem_8c_abe64a91cd872768817509cc08eed6689}{memPoolAlloc}(\hyperlink{ethernet_8h_aa40569f19ea64ddc1cf273d095e517f4}{ETH\_MAX\_FRAME\_SIZE});
104    context->\hyperlink{structKsz8851Context_aedfff3a17d92a82fb7bd5ce91ef8d865}{rxBuffer} = \hyperlink{net__mem_8c_abe64a91cd872768817509cc08eed6689}{memPoolAlloc}(\hyperlink{ethernet_8h_aa40569f19ea64ddc1cf273d095e517f4}{ETH\_MAX\_FRAME\_SIZE});
105 
106    \textcolor{comment}{//Failed to allocate memory?}
107    \textcolor{keywordflow}{if}(context->\hyperlink{structKsz8851Context_a9eef3244c4dcc6554dc1e8a0243491eb}{txBuffer} == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || context->\hyperlink{structKsz8851Context_aedfff3a17d92a82fb7bd5ce91ef8d865}{rxBuffer} == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
108    \{
109       \textcolor{comment}{//Clean up side effects}
110       \hyperlink{net__mem_8c_a5e8a514f3dfcb35008de9beb39bcdcde}{memPoolFree}(context->\hyperlink{structKsz8851Context_a9eef3244c4dcc6554dc1e8a0243491eb}{txBuffer});
111       \hyperlink{net__mem_8c_a5e8a514f3dfcb35008de9beb39bcdcde}{memPoolFree}(context->\hyperlink{structKsz8851Context_aedfff3a17d92a82fb7bd5ce91ef8d865}{rxBuffer});
112 
113       \textcolor{comment}{//Report an error}
114       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
115    \}
116 
117    \textcolor{comment}{//Initialize MAC address}
118    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_aecca6c5060a5ec59015d456379fbcf9d}{KSZ8851\_REG\_MARH}, 
      \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(interface->macAddr.w[0]));
119    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_ae936e2ce14284d8fa4152ac7dc6023db}{KSZ8851\_REG\_MARM}, 
      \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(interface->macAddr.w[1]));
120    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_ac1f6f50ac4b9f63353b5c9d5665fbddf}{KSZ8851\_REG\_MARL}, 
      \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(interface->macAddr.w[2]));
121 
122    \textcolor{comment}{//Packets shorter than 64 bytes are padded and the CRC is automatically generated}
123    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_ac83eb9324bc51a46a6386e1be5ee088d}{KSZ8851\_REG\_TXCR}, 
      \hyperlink{ksz8851__driver_8h_aace46b6732bee3b0f2ce9f465397aaa6}{TXCR\_TXFCE} | \hyperlink{ksz8851__driver_8h_acee4a5f345b72f7f91bca071f79c19d4}{TXCR\_TXPE} | \hyperlink{ksz8851__driver_8h_ab813400769513bad46c03860e83bec31}{TXCR\_TXCE});
124    \textcolor{comment}{//Automatically increment TX data pointer}
125    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_adeb7ca97277487903bc08f0034c60b53}{KSZ8851\_REG\_TXFDPR}, 
      \hyperlink{ksz8851__driver_8h_aef7ef1b5e322028e743bf834257f8127}{TXFDPR\_TXFPAI});
126 
127    \textcolor{comment}{//Configure address filtering}
128    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_a60800f85693e1304da86f14b3af3f48a}{KSZ8851\_REG\_RXCR1},
129       \hyperlink{ksz8851__driver_8h_a1a07853443c9d11a0b4dc08a0927cc00}{RXCR1\_RXPAFMA} | \hyperlink{ksz8851__driver_8h_af525da966b9466c5a653497e841d48be}{RXCR1\_RXFCE} | \hyperlink{ksz8851__driver_8h_a7a02e3039cdde73931f823e0b76ea22a}{RXCR1\_RXBE} | 
      \hyperlink{ksz8851__driver_8h_a1f2ed4d15bd332000db84a0dbb3bb77a}{RXCR1\_RXME} | \hyperlink{ksz8851__driver_8h_a2795c789651539d9f08e265cf028bc15}{RXCR1\_RXUE});
130 
131    \textcolor{comment}{//No checksum verification}
132    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_a3ec6137ccf8d31b6e07366e6831ff06d}{KSZ8851\_REG\_RXCR2},
133       \hyperlink{ksz8851__driver_8h_a9a40e915ac049ca366dfd49469f90dce}{RXCR2\_SRDBL2} | \hyperlink{ksz8851__driver_8h_a48b9eea233df37b753dd4b9175b610e9}{RXCR2\_IUFFP} | \hyperlink{ksz8851__driver_8h_aa1155b338c65c53fcd797c6315489e9f}{RXCR2\_RXIUFCEZ});
134 
135    \textcolor{comment}{//Enable automatic RXQ frame buffer dequeue}
136    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_a76bcb087216ef6739383cb26b04fe2f9}{KSZ8851\_REG\_RXQCR}, 
      \hyperlink{ksz8851__driver_8h_a85b9dd40783b0925dc495b8a5a77eafb}{RXQCR\_RXFCTE} | \hyperlink{ksz8851__driver_8h_a2b80a660f953e4fd8c9f60af49453d59}{RXQCR\_ADRFE});
137    \textcolor{comment}{//Automatically increment RX data pointer}
138    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_a240b0efcd686e3ff54a63f86fef4a8f1}{KSZ8851\_REG\_RXFDPR}, 
      \hyperlink{ksz8851__driver_8h_a785a0f287411995a6cf8b4b038c9c106}{RXFDPR\_RXFPAI});
139    \textcolor{comment}{//Configure receive frame count threshold}
140    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_a1d96b972d8816d782250278882173582}{KSZ8851\_REG\_RXFCTR}, 1);
141 
142    \textcolor{comment}{//Force link in half-duplex if auto-negotiation failed}
143    \hyperlink{ksz8851__driver_8c_ac499452d26bdeee97af794c569b15461}{ksz8851ClearBit}(interface, \hyperlink{ksz8851__driver_8h_aefae091246db7a449e02f4de649fb875}{KSZ8851\_REG\_P1CR}, 
      \hyperlink{ksz8851__driver_8h_afa6768ae313cf3563ffbd9585f20dbc5}{P1CR\_FORCE\_DUPLEX});
144    \textcolor{comment}{//Restart auto-negotiation}
145    \hyperlink{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}{ksz8851SetBit}(interface, \hyperlink{ksz8851__driver_8h_aefae091246db7a449e02f4de649fb875}{KSZ8851\_REG\_P1CR}, 
      \hyperlink{ksz8851__driver_8h_a80e6601210f5cd336bf974612139357e}{P1CR\_RESTART\_AN});
146 
147    \textcolor{comment}{//Clear interrupt flags}
148    \hyperlink{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}{ksz8851SetBit}(interface, \hyperlink{ksz8851__driver_8h_aec91ddf2f7c70dce4b2353c33c9ad734}{KSZ8851\_REG\_ISR}, 
      \hyperlink{ksz8851__driver_8h_a8ae5166d52e93ddb6a0969033a6d315e}{ISR\_LCIS} | \hyperlink{ksz8851__driver_8h_a09e639a45368bdcd1b06e7d4cece4df3}{ISR\_TXIS} |
149       \hyperlink{ksz8851__driver_8h_a6a0cf2021712e7bb54ebed8e70706b8b}{ISR\_RXIS} | \hyperlink{ksz8851__driver_8h_a5a7e171041fa2aa49b75bfb6957511e8}{ISR\_RXOIS} | \hyperlink{ksz8851__driver_8h_a44deb88be7afa72499cc9fc0e57b09f5}{ISR\_TXPSIS} | \hyperlink{ksz8851__driver_8h_aabd2c2909e7805058377d3dfef61e8bb}{ISR\_RXPSIS} | 
      \hyperlink{ksz8851__driver_8h_add3fa3b2df2778399e5f8fb344ed1db7}{ISR\_TXSAIS} |
150       \hyperlink{ksz8851__driver_8h_a69d3569ae6e65702b92d84f287568f86}{ISR\_RXWFDIS} | \hyperlink{ksz8851__driver_8h_a34e60ab72e8d3965fbbfa8417c5519f6}{ISR\_RXMPDIS} | \hyperlink{ksz8851__driver_8h_aabda1e5391edf83e91d23fe034e5c55d}{ISR\_LDIS} | 
      \hyperlink{ksz8851__driver_8h_a3ce87343b53f6aa3b6caff00946bf2aa}{ISR\_EDIS} | \hyperlink{ksz8851__driver_8h_a2747a4e417e01e0e4445d3ae619edaa6}{ISR\_SPIBEIS});
151 
152    \textcolor{comment}{//Configure interrupts as desired}
153    \hyperlink{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}{ksz8851SetBit}(interface, \hyperlink{ksz8851__driver_8h_aee6696fa9779cdef71b67fc997e683c0}{KSZ8851\_REG\_IER}, 
      \hyperlink{ksz8851__driver_8h_a2e9e6254a5bcddc2a17fe4066f2c7aed}{IER\_LCIE} | \hyperlink{ksz8851__driver_8h_a050554451a5af6536c34ded801683ffe}{IER\_TXIE} | \hyperlink{ksz8851__driver_8h_ac9d5863509c80a2dcc7af046ff2a0f68}{IER\_RXIE});
154 
155    \textcolor{comment}{//Enable TX operation}
156    \hyperlink{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}{ksz8851SetBit}(interface, \hyperlink{ksz8851__driver_8h_ac83eb9324bc51a46a6386e1be5ee088d}{KSZ8851\_REG\_TXCR}, 
      \hyperlink{ksz8851__driver_8h_aa0184a31e029f8bbfc199b50bc265612}{TXCR\_TXE});
157    \textcolor{comment}{//Enable RX operation}
158    \hyperlink{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}{ksz8851SetBit}(interface, \hyperlink{ksz8851__driver_8h_a60800f85693e1304da86f14b3af3f48a}{KSZ8851\_REG\_RXCR1}, 
      \hyperlink{ksz8851__driver_8h_a27e8705b3bacbbce695056eddc1b3bed}{RXCR1\_RXE});
159 
160    \textcolor{comment}{//Accept any packets from the upper layer}
161    \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&interface->nicTxEvent);
162 
163    \textcolor{comment}{//Force the TCP/IP stack to poll the link state at startup}
164    interface->nicEvent = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
165    \textcolor{comment}{//Notify the TCP/IP stack of the event}
166    \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&\hyperlink{net_8c_a4ad5a175123589d00e402e0c1c842fdc}{netEvent});
167 
168    \textcolor{comment}{//Successful initialization}
169    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
170 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_ae585abc2f8c0c4f7c40185adbbe2b8e2}\label{ksz8851__driver_8c_ae585abc2f8c0c4f7c40185adbbe2b8e2}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Irq\+Handler@{ksz8851\+Irq\+Handler}}
\index{ksz8851\+Irq\+Handler@{ksz8851\+Irq\+Handler}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Irq\+Handler()}{ksz8851IrqHandler()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} ksz8851\+Irq\+Handler (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



K\+S\+Z8851 interrupt service routine. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
T\+R\+UE if a higher priority task must be woken. Else F\+A\+L\+SE is returned 
\end{DoxyReturn}


Definition at line 213 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
214 \{
215    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} flag;
216    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
217    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} ier;
218    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{m2m__hif_8c_ad3c50b24a4b59659a8219108a080c7cc}{isr};
219 
220    \textcolor{comment}{//This flag will be set if a higher priority task must be woken}
221    flag = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
222 
223    \textcolor{comment}{//Save IER register value}
224    ier = \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, \hyperlink{ksz8851__driver_8h_aee6696fa9779cdef71b67fc997e683c0}{KSZ8851\_REG\_IER});
225    \textcolor{comment}{//Disable interrupts to release the interrupt line}
226    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_aee6696fa9779cdef71b67fc997e683c0}{KSZ8851\_REG\_IER}, 0);
227 
228    \textcolor{comment}{//Read interrupt status register}
229    isr = \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, \hyperlink{ksz8851__driver_8h_aec91ddf2f7c70dce4b2353c33c9ad734}{KSZ8851\_REG\_ISR});
230 
231    \textcolor{comment}{//Link status change?}
232    \textcolor{keywordflow}{if}(isr & \hyperlink{ksz8851__driver_8h_a8ae5166d52e93ddb6a0969033a6d315e}{ISR\_LCIS})
233    \{
234       \textcolor{comment}{//Disable LCIE interrupt}
235       ier &= ~\hyperlink{ksz8851__driver_8h_a2e9e6254a5bcddc2a17fe4066f2c7aed}{IER\_LCIE};
236 
237       \textcolor{comment}{//Set event flag}
238       interface->nicEvent = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
239       \textcolor{comment}{//Notify the TCP/IP stack of the event}
240       flag |= \hyperlink{os__port__chibios_8c_aa30d505571a03dd645af374f40bd7016}{osSetEventFromIsr}(&\hyperlink{net_8c_a4ad5a175123589d00e402e0c1c842fdc}{netEvent});
241    \}
242 
243    \textcolor{comment}{//Packet transmission complete?}
244    \textcolor{keywordflow}{if}(isr & \hyperlink{ksz8851__driver_8h_a09e639a45368bdcd1b06e7d4cece4df3}{ISR\_TXIS})
245    \{
246       \textcolor{comment}{//Clear interrupt flag}
247       \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_aec91ddf2f7c70dce4b2353c33c9ad734}{KSZ8851\_REG\_ISR}, ISR\_TXIS);
248 
249       \textcolor{comment}{//Get the amount of free memory available in the TX FIFO}
250       n = \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, \hyperlink{ksz8851__driver_8h_a299c058ff5ba3bc651193e7965d6c0dd}{KSZ8851\_REG\_TXMIR}) & 
      \hyperlink{ksz8851__driver_8h_a20d14967156d1cfc80ba24d8811b0584}{TXMIR\_TXMA\_MASK};
251 
252       \textcolor{comment}{//Check whether the TX FIFO is available for writing}
253       \textcolor{keywordflow}{if}(n >= (\hyperlink{ethernet_8h_aa40569f19ea64ddc1cf273d095e517f4}{ETH\_MAX\_FRAME\_SIZE} + 8))
254       \{
255          \textcolor{comment}{//Notify the TCP/IP stack that the transmitter is ready to send}
256          flag |= \hyperlink{os__port__chibios_8c_aa30d505571a03dd645af374f40bd7016}{osSetEventFromIsr}(&interface->nicTxEvent);
257       \}
258    \}
259 
260    \textcolor{comment}{//Packet received?}
261    \textcolor{keywordflow}{if}(isr & \hyperlink{ksz8851__driver_8h_a6a0cf2021712e7bb54ebed8e70706b8b}{ISR\_RXIS})
262    \{
263       \textcolor{comment}{//Disable RXIE interrupt}
264       ier &= ~\hyperlink{ksz8851__driver_8h_ac9d5863509c80a2dcc7af046ff2a0f68}{IER\_RXIE};
265 
266       \textcolor{comment}{//Set event flag}
267       interface->nicEvent = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
268       \textcolor{comment}{//Notify the TCP/IP stack of the event}
269       flag |= \hyperlink{os__port__chibios_8c_aa30d505571a03dd645af374f40bd7016}{osSetEventFromIsr}(&\hyperlink{net_8c_a4ad5a175123589d00e402e0c1c842fdc}{netEvent});
270    \}
271 
272    \textcolor{comment}{//Re-enable interrupts once the interrupt has been serviced}
273    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_aee6696fa9779cdef71b67fc997e683c0}{KSZ8851\_REG\_IER}, ier);
274 
275    \textcolor{comment}{//A higher priority task must be woken?}
276    \textcolor{keywordflow}{return} flag;
277 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_a7d58bda818d6ec73381eeded55a953ab}\label{ksz8851__driver_8c_a7d58bda818d6ec73381eeded55a953ab}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Read\+Fifo@{ksz8851\+Read\+Fifo}}
\index{ksz8851\+Read\+Fifo@{ksz8851\+Read\+Fifo}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Read\+Fifo()}{ksz8851ReadFifo()}}
{\footnotesize\ttfamily void ksz8851\+Read\+Fifo (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Read RX F\+I\+FO. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em data} & Buffer where to store the incoming data \\
\hline
\mbox{\tt in}  & {\em length} & Number of data to read \\
\hline
\end{DoxyParams}


Definition at line 678 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
679 \{
680 \textcolor{preprocessor}{#if (KSZ8851\_SPI\_SUPPORT == ENABLED)}
681    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
682 
683    \textcolor{comment}{//Pull the CS pin low}
684    interface->spiDriver->assertCs();
685 
686    \textcolor{comment}{//Command phase}
687    interface->spiDriver->transfer(\hyperlink{ksz8851__driver_8h_a133b68e329239648033c69789b686043}{KSZ8851\_CMD\_RD\_FIFO});
688 
689    \textcolor{comment}{//The first 4 bytes are dummy data and must be discarded}
690    \textcolor{keywordflow}{for}(i = 0; i < 4; i++)
691       interface->spiDriver->transfer(0x00);
692 
693    \textcolor{comment}{//Ignore RX packet header}
694    \textcolor{keywordflow}{for}(i = 0; i < 4; i++)
695       interface->spiDriver->transfer(0x00);
696 
697    \textcolor{comment}{//Data phase}
698    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}; i++)
699       \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i] = interface->spiDriver->transfer(0x00);
700 
701    \textcolor{comment}{//Maintain alignment to 4-byte boundaries}
702    \textcolor{keywordflow}{for}(; i % 4; i++)
703       interface->spiDriver->transfer(0x00);
704 
705    \textcolor{comment}{//Terminate the operation by raising the CS pin}
706    interface->spiDriver->deassertCs();
707 \textcolor{preprocessor}{#else}
708    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
709    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} temp;
710 
711    \textcolor{comment}{//The first 2 bytes are dummy data and must be discarded}
712    temp = \hyperlink{ksz8851__driver_8h_a9d190328ce0d6e301e8090d01680f645}{KSZ8851\_DATA\_REG};
713 
714    \textcolor{comment}{//Ignore RX packet header}
715    temp = \hyperlink{ksz8851__driver_8h_a9d190328ce0d6e301e8090d01680f645}{KSZ8851\_DATA\_REG};
716    temp = \hyperlink{ksz8851__driver_8h_a9d190328ce0d6e301e8090d01680f645}{KSZ8851\_DATA\_REG};
717 
718    \textcolor{comment}{//Data phase}
719    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}; i+=2)
720    \{
721       temp = \hyperlink{ksz8851__driver_8h_a9d190328ce0d6e301e8090d01680f645}{KSZ8851\_DATA\_REG};
722       \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} [i] = temp & 0xFF;
723       \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} [i+1] = (temp>>8) & 0xFF;
724    \}
725 
726    \textcolor{comment}{//Maintain alignment to 4-byte boundaries}
727    \textcolor{keywordflow}{for}(; i % 4; i+=2)
728       temp = \hyperlink{ksz8851__driver_8h_a9d190328ce0d6e301e8090d01680f645}{KSZ8851\_DATA\_REG};
729 \textcolor{preprocessor}{#endif}
730 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}\label{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Read\+Reg@{ksz8851\+Read\+Reg}}
\index{ksz8851\+Read\+Reg@{ksz8851\+Read\+Reg}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Read\+Reg()}{ksz8851ReadReg()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} ksz8851\+Read\+Reg (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{address }\end{DoxyParamCaption})}



Read K\+S\+Z8851 register. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em address} & Register address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Register value 
\end{DoxyReturn}


Definition at line 586 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
587 \{
588 \textcolor{preprocessor}{#if (KSZ8851\_SPI\_SUPPORT == ENABLED)}
589    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} command;
590    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
591 
592    \textcolor{comment}{//Form the read command}
593    \textcolor{keywordflow}{if}(\hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address} & 0x02)
594       command = \hyperlink{ksz8851__driver_8h_aabcf108157a7fe5c6c9adfe805648091}{KSZ8851\_CMD\_RD\_REG} | \hyperlink{ksz8851__driver_8h_a6db3d4f899f79a03e6c2cad1b95c60a5}{KSZ8851\_CMD\_B3} | 
      \hyperlink{ksz8851__driver_8h_a12e15d7f3a18c794dd12b7298aeee3fd}{KSZ8851\_CMD\_B2};
595    \textcolor{keywordflow}{else}
596       command = \hyperlink{ksz8851__driver_8h_aabcf108157a7fe5c6c9adfe805648091}{KSZ8851\_CMD\_RD\_REG} | \hyperlink{ksz8851__driver_8h_a62e0254d4f1e2badbebf35fa75e32dd8}{KSZ8851\_CMD\_B1} | 
      \hyperlink{ksz8851__driver_8h_afbe555027a2a0ea334935152f9797c09}{KSZ8851\_CMD\_B0};
597 
598    \textcolor{comment}{//Pull the CS pin low}
599    interface->spiDriver->assertCs();
600 
601    \textcolor{comment}{//Command phase}
602    interface->spiDriver->transfer(command | (\hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address} >> 6));
603    interface->spiDriver->transfer(\hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address} << 2);
604 
605    \textcolor{comment}{//Data phase (lower 8 bits)}
606    data = interface->spiDriver->transfer(0x00);
607    \textcolor{comment}{//Data phase (upper 8 bits)}
608    data |= interface->spiDriver->transfer(0x00) << 8;
609 
610    \textcolor{comment}{//Terminate the operation by raising the CS pin}
611    interface->spiDriver->deassertCs();
612 
613    \textcolor{comment}{//Return register value}
614    \textcolor{keywordflow}{return} \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
615 \textcolor{preprocessor}{#else}
616    \textcolor{comment}{//Set register address}
617    \textcolor{keywordflow}{if}(\hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address} & 0x02)
618       \hyperlink{ksz8851__driver_8h_ac9413f53fa8bdb88278d8a21338ee6c8}{KSZ8851\_CMD\_REG} = \hyperlink{ksz8851__driver_8h_a6db3d4f899f79a03e6c2cad1b95c60a5}{KSZ8851\_CMD\_B3} | 
      \hyperlink{ksz8851__driver_8h_a12e15d7f3a18c794dd12b7298aeee3fd}{KSZ8851\_CMD\_B2} | \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
619    \textcolor{keywordflow}{else}
620       \hyperlink{ksz8851__driver_8h_ac9413f53fa8bdb88278d8a21338ee6c8}{KSZ8851\_CMD\_REG} = \hyperlink{ksz8851__driver_8h_a62e0254d4f1e2badbebf35fa75e32dd8}{KSZ8851\_CMD\_B1} | 
      \hyperlink{ksz8851__driver_8h_afbe555027a2a0ea334935152f9797c09}{KSZ8851\_CMD\_B0} | \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
621 
622    \textcolor{comment}{//Return register value}
623    \textcolor{keywordflow}{return} \hyperlink{ksz8851__driver_8h_a9d190328ce0d6e301e8090d01680f645}{KSZ8851\_DATA\_REG};
624 \textcolor{preprocessor}{#endif}
625 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_a9b698a3429eee4429854e20d0da4b846}\label{ksz8851__driver_8c_a9b698a3429eee4429854e20d0da4b846}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Receive\+Packet@{ksz8851\+Receive\+Packet}}
\index{ksz8851\+Receive\+Packet@{ksz8851\+Receive\+Packet}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Receive\+Packet()}{ksz8851ReceivePacket()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ksz8851\+Receive\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Receive a packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 431 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
432 \{
433    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
434    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} status;
435    \hyperlink{structKsz8851Context}{Ksz8851Context} *context;
436 
437    \textcolor{comment}{//Point to the driver context}
438    context = (\hyperlink{structKsz8851Context}{Ksz8851Context} *) interface->nicContext;
439 
440    \textcolor{comment}{//Read received frame status from RXFHSR}
441    status = \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, \hyperlink{ksz8851__driver_8h_a3815c326d1fcc0dc81ab06dcae9e28ba}{KSZ8851\_REG\_RXFHSR});
442 
443    \textcolor{comment}{//Make sure the frame is valid}
444    \textcolor{keywordflow}{if}(status & \hyperlink{ksz8851__driver_8h_ab1e3aff13e5365932b4e4eb6f133c334}{RXFHSR\_RXFV})
445    \{
446       \textcolor{comment}{//Check error flags}
447       \textcolor{keywordflow}{if}(!(status & (\hyperlink{ksz8851__driver_8h_a6323eae9369a428a4da1ba7b6e8d29d7}{RXFHSR\_RXMR} | \hyperlink{ksz8851__driver_8h_abc7d318b836b43d24182ccb520147f14}{RXFHSR\_RXFTL} | 
      \hyperlink{ksz8851__driver_8h_a501254601e235fad1eb2cf5ca03be3ea}{RXFHSR\_RXRF} | \hyperlink{ksz8851__driver_8h_aed985381e73956d9b96c214a1136b6b1}{RXFHSR\_RXCE})))
448       \{
449          \textcolor{comment}{//Read received frame byte size from RXFHBCR}
450          n = \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, \hyperlink{ksz8851__driver_8h_a5311b485e3e5cf26d090d9d1d780803a}{KSZ8851\_REG\_RXFHBCR}) & 
      \hyperlink{ksz8851__driver_8h_ab39c0a1ae50e5232094280f81d8b01c0}{RXFHBCR\_RXBC\_MASK};
451 
452          \textcolor{comment}{//Ensure the frame size is acceptable}
453          \textcolor{keywordflow}{if}(n > 0 && n <= \hyperlink{ethernet_8h_aa40569f19ea64ddc1cf273d095e517f4}{ETH\_MAX\_FRAME\_SIZE})
454          \{
455             \textcolor{comment}{//Reset QMU RXQ frame pointer to zero}
456             \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_a240b0efcd686e3ff54a63f86fef4a8f1}{KSZ8851\_REG\_RXFDPR}, 
      \hyperlink{ksz8851__driver_8h_a785a0f287411995a6cf8b4b038c9c106}{RXFDPR\_RXFPAI});
457             \textcolor{comment}{//Enable RXQ read access}
458             \hyperlink{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}{ksz8851SetBit}(interface, \hyperlink{ksz8851__driver_8h_a76bcb087216ef6739383cb26b04fe2f9}{KSZ8851\_REG\_RXQCR}, 
      \hyperlink{ksz8851__driver_8h_ad84f83ef9378109fda6547b07be992e8}{RXQCR\_SDA});
459             \textcolor{comment}{//Read data}
460             \hyperlink{ksz8851__driver_8c_a7d58bda818d6ec73381eeded55a953ab}{ksz8851ReadFifo}(interface, context->\hyperlink{structKsz8851Context_aedfff3a17d92a82fb7bd5ce91ef8d865}{rxBuffer}, n);
461             \textcolor{comment}{//End RXQ read access}
462             \hyperlink{ksz8851__driver_8c_ac499452d26bdeee97af794c569b15461}{ksz8851ClearBit}(interface, \hyperlink{ksz8851__driver_8h_a76bcb087216ef6739383cb26b04fe2f9}{KSZ8851\_REG\_RXQCR}, 
      \hyperlink{ksz8851__driver_8h_ad84f83ef9378109fda6547b07be992e8}{RXQCR\_SDA});
463 
464             \textcolor{comment}{//Pass the packet to the upper layer}
465             \hyperlink{nic_8c_a5e5ef3b84649c36ebfe1e70edb1a0f75}{nicProcessPacket}(interface, context->\hyperlink{structKsz8851Context_aedfff3a17d92a82fb7bd5ce91ef8d865}{rxBuffer}, n);
466             \textcolor{comment}{//Valid packet received}
467             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
468          \}
469       \}
470    \}
471 
472    \textcolor{comment}{//Release the current error frame from RXQ}
473    \hyperlink{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}{ksz8851SetBit}(interface, \hyperlink{ksz8851__driver_8h_a76bcb087216ef6739383cb26b04fe2f9}{KSZ8851\_REG\_RXQCR}, 
      \hyperlink{ksz8851__driver_8h_aaff700df4fcfa7fcff479f52df8cfeb0}{RXQCR\_RRXEF});
474    \textcolor{comment}{//Report an error}
475    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caccf6070ae61f26a48b523757a3168ad2}{ERROR\_INVALID\_PACKET};
476 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_a3c86aab5a7d93e8113fec206d81ed919}\label{ksz8851__driver_8c_a3c86aab5a7d93e8113fec206d81ed919}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Send\+Packet@{ksz8851\+Send\+Packet}}
\index{ksz8851\+Send\+Packet@{ksz8851\+Send\+Packet}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Send\+Packet()}{ksz8851SendPacket()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ksz8851\+Send\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset }\end{DoxyParamCaption})}



Send a packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the data to send \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first data byte \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 360 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
362 \{
363    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
364    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
365    \hyperlink{ksz8851__driver_8h_a8938095de62cfb6a057fbd2707b8f70d}{Ksz8851TxHeader} header;
366    \hyperlink{structKsz8851Context}{Ksz8851Context} *context;
367 
368    \textcolor{comment}{//Point to the driver context}
369    context = (\hyperlink{structKsz8851Context}{Ksz8851Context} *) interface->nicContext;
370 
371    \textcolor{comment}{//Retrieve the length of the packet}
372    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
373 
374    \textcolor{comment}{//Check the frame length}
375    \textcolor{keywordflow}{if}(length > \hyperlink{ethernet_8h_aa40569f19ea64ddc1cf273d095e517f4}{ETH\_MAX\_FRAME\_SIZE})
376    \{
377       \textcolor{comment}{//The transmitter can accept another packet}
378       \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&interface->nicTxEvent);
379       \textcolor{comment}{//Report an error}
380       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
381    \}
382 
383    \textcolor{comment}{//Get the amount of free memory available in the TX FIFO}
384    n = \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, \hyperlink{ksz8851__driver_8h_a299c058ff5ba3bc651193e7965d6c0dd}{KSZ8851\_REG\_TXMIR}) & 
      \hyperlink{ksz8851__driver_8h_a20d14967156d1cfc80ba24d8811b0584}{TXMIR\_TXMA\_MASK};
385 
386    \textcolor{comment}{//Make sure the TX FIFO is available for writing}
387    \textcolor{keywordflow}{if}(n < (length + 8))
388       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
389 
390    \textcolor{comment}{//Copy user data}
391    \hyperlink{net__mem_8c_af3ed1bc3f7d55f830cbbe6aa12e61af0}{netBufferRead}(context->\hyperlink{structKsz8851Context_a9eef3244c4dcc6554dc1e8a0243491eb}{txBuffer}, buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset}, length);
392 
393    \textcolor{comment}{//Format control word}
394    header.controlWord = \hyperlink{ksz8851__driver_8h_ae6a763999584fa29f7bb0ba64b070643}{TX\_CTRL\_TXIC} | (context->\hyperlink{structKsz8851Context_a424b2fc6743cfc3c31cf59164610ee89}{frameId}++ & 
      \hyperlink{ksz8851__driver_8h_a97a251493692ce64f18226416b0d34b6}{TX\_CTRL\_TXFID});
395    \textcolor{comment}{//Total number of bytes to be transmitted}
396    header.byteCount = \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
397 
398    \textcolor{comment}{//Enable TXQ write access}
399    \hyperlink{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}{ksz8851SetBit}(interface, \hyperlink{ksz8851__driver_8h_a76bcb087216ef6739383cb26b04fe2f9}{KSZ8851\_REG\_RXQCR}, 
      \hyperlink{ksz8851__driver_8h_ad84f83ef9378109fda6547b07be992e8}{RXQCR\_SDA});
400    \textcolor{comment}{//Write TX packet header}
401    \hyperlink{ksz8851__driver_8c_ab9e070e0729fadead1c9234759fff35e}{ksz8851WriteFifo}(interface, (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) &header, \textcolor{keyword}{sizeof}(
      \hyperlink{ksz8851__driver_8h_a8938095de62cfb6a057fbd2707b8f70d}{Ksz8851TxHeader}));
402    \textcolor{comment}{//Write data}
403    \hyperlink{ksz8851__driver_8c_ab9e070e0729fadead1c9234759fff35e}{ksz8851WriteFifo}(interface, context->\hyperlink{structKsz8851Context_a9eef3244c4dcc6554dc1e8a0243491eb}{txBuffer}, length);
404    \textcolor{comment}{//End TXQ write access}
405    \hyperlink{ksz8851__driver_8c_ac499452d26bdeee97af794c569b15461}{ksz8851ClearBit}(interface, \hyperlink{ksz8851__driver_8h_a76bcb087216ef6739383cb26b04fe2f9}{KSZ8851\_REG\_RXQCR}, 
      \hyperlink{ksz8851__driver_8h_ad84f83ef9378109fda6547b07be992e8}{RXQCR\_SDA});
406 
407    \textcolor{comment}{//Start transmission}
408    \hyperlink{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}{ksz8851SetBit}(interface, \hyperlink{ksz8851__driver_8h_a2596b50b592d841c1dd509877b942c01}{KSZ8851\_REG\_TXQCR}, 
      \hyperlink{ksz8851__driver_8h_a36fffa5f697b86c38044f60318bf75c6}{TXQCR\_METFE});
409 
410    \textcolor{comment}{//Get the amount of free memory available in the TX FIFO}
411    n = \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, \hyperlink{ksz8851__driver_8h_a299c058ff5ba3bc651193e7965d6c0dd}{KSZ8851\_REG\_TXMIR}) & 
      \hyperlink{ksz8851__driver_8h_a20d14967156d1cfc80ba24d8811b0584}{TXMIR\_TXMA\_MASK};
412 
413    \textcolor{comment}{//Check whether the TX FIFO is available for writing}
414    \textcolor{keywordflow}{if}(n >= (\hyperlink{ethernet_8h_aa40569f19ea64ddc1cf273d095e517f4}{ETH\_MAX\_FRAME\_SIZE} + 8))
415    \{
416       \textcolor{comment}{//The transmitter can accept another packet}
417       \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&interface->nicTxEvent);
418    \}
419 
420    \textcolor{comment}{//Successful processing}
421    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
422 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}\label{ksz8851__driver_8c_a6168d88fc272318a4661f85739012bca}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Set\+Bit@{ksz8851\+Set\+Bit}}
\index{ksz8851\+Set\+Bit@{ksz8851\+Set\+Bit}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Set\+Bit()}{ksz8851SetBit()}}
{\footnotesize\ttfamily void ksz8851\+Set\+Bit (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{address,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{mask }\end{DoxyParamCaption})}



Set bit field. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em address} & Register address \\
\hline
\mbox{\tt in}  & {\em mask} & Bits to set in the target register \\
\hline
\end{DoxyParams}


Definition at line 740 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
741 \{
742    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
743 
744    \textcolor{comment}{//Read current register value}
745    value = \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address});
746    \textcolor{comment}{//Set specified bits}
747    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address}, value | \hyperlink{web__socket_8h_a8a74907784be6c7786c2d060c8d7e10b}{mask});
748 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_a365f1ffe985b4c6659aa073d09be1915}\label{ksz8851__driver_8c_a365f1ffe985b4c6659aa073d09be1915}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Tick@{ksz8851\+Tick}}
\index{ksz8851\+Tick@{ksz8851\+Tick}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Tick()}{ksz8851Tick()}}
{\footnotesize\ttfamily void ksz8851\+Tick (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



K\+S\+Z8851 timer handler. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 178 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
179 \{
180 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_a07ebd7cb74831854ec0f495962a70d4f}\label{ksz8851__driver_8c_a07ebd7cb74831854ec0f495962a70d4f}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Update\+Mac\+Addr\+Filter@{ksz8851\+Update\+Mac\+Addr\+Filter}}
\index{ksz8851\+Update\+Mac\+Addr\+Filter@{ksz8851\+Update\+Mac\+Addr\+Filter}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Update\+Mac\+Addr\+Filter()}{ksz8851UpdateMacAddrFilter()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ksz8851\+Update\+Mac\+Addr\+Filter (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Configure M\+AC address filtering. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 485 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
486 \{
487    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
488    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{md5_8c_af11ea3cdbca7345eb6a4a8ac5ce0434d}{k};
489    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} crc;
490    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} hashTable[4];
491    \hyperlink{structMacFilterEntry}{MacFilterEntry} *entry;
492 
493    \textcolor{comment}{//Debug message}
494    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Updating MAC filter...\(\backslash\)r\(\backslash\)n"});
495 
496    \textcolor{comment}{//Clear hash table}
497    memset(hashTable, 0, \textcolor{keyword}{sizeof}(hashTable));
498 
499    \textcolor{comment}{//The MAC address filter contains the list of MAC addresses to accept}
500    \textcolor{comment}{//when receiving an Ethernet frame}
501    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{ethernet_8h_ab64acae68b5723774fa272c62efd7c2b}{MAC\_ADDR\_FILTER\_SIZE}; i++)
502    \{
503       \textcolor{comment}{//Point to the current entry}
504       entry = &interface->macAddrFilter[i];
505 
506       \textcolor{comment}{//Valid entry?}
507       \textcolor{keywordflow}{if}(entry->\hyperlink{structMacFilterEntry_a4a1195d4086f58ef57862fa43551e73a}{refCount} > 0)
508       \{
509          \textcolor{comment}{//Compute CRC over the current MAC address}
510          crc = \hyperlink{ksz8851__driver_8c_a5bff5fc708e670bad154ff80fe10ab15}{ksz8851CalcCrc}(&entry->\hyperlink{structMacFilterEntry_a30caa211d6cc1bb2416165526a2ab6cb}{addr}, \textcolor{keyword}{sizeof}(\hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{MacAddr}));
511          \textcolor{comment}{//Calculate the corresponding index in the table}
512          k = (crc >> 26) & 0x3F;
513          \textcolor{comment}{//Update hash table contents}
514          hashTable[k / 16] |= (1 << (k % 16));
515       \}
516    \}
517 
518    \textcolor{comment}{//Write the hash table to the KSZ8851 controller}
519    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_aef15692128fcbe7b1c666bfa5b25ecfd}{KSZ8851\_REG\_MAHTR0}, hashTable[0]);
520    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_ad38034a862bfe257ca74e6b9900f049e}{KSZ8851\_REG\_MAHTR1}, hashTable[1]);
521    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_ae2ce7f6383372889ec53ff40ff66b03d}{KSZ8851\_REG\_MAHTR2}, hashTable[2]);
522    \hyperlink{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}{ksz8851WriteReg}(interface, \hyperlink{ksz8851__driver_8h_aa6199c8fed5008bf7337e46e74f5c517}{KSZ8851\_REG\_MAHTR3}, hashTable[3]);
523 
524    \textcolor{comment}{//Debug message}
525    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  MAHTR0 = %04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, 
      \hyperlink{ksz8851__driver_8h_aef15692128fcbe7b1c666bfa5b25ecfd}{KSZ8851\_REG\_MAHTR0}));
526    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  MAHTR1 = %04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, 
      \hyperlink{ksz8851__driver_8h_ad38034a862bfe257ca74e6b9900f049e}{KSZ8851\_REG\_MAHTR1}));
527    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  MAHTR2 = %04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, 
      \hyperlink{ksz8851__driver_8h_ae2ce7f6383372889ec53ff40ff66b03d}{KSZ8851\_REG\_MAHTR2}));
528    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  MAHTR3 = %04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{ksz8851__driver_8c_af44a5c7b1fd30d47c5593a7260bb7e7e}{ksz8851ReadReg}(interface, 
      \hyperlink{ksz8851__driver_8h_aa6199c8fed5008bf7337e46e74f5c517}{KSZ8851\_REG\_MAHTR3}));
529 
530    \textcolor{comment}{//Successful processing}
531    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
532 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_ab9e070e0729fadead1c9234759fff35e}\label{ksz8851__driver_8c_ab9e070e0729fadead1c9234759fff35e}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Write\+Fifo@{ksz8851\+Write\+Fifo}}
\index{ksz8851\+Write\+Fifo@{ksz8851\+Write\+Fifo}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Write\+Fifo()}{ksz8851WriteFifo()}}
{\footnotesize\ttfamily void ksz8851\+Write\+Fifo (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Write TX F\+I\+FO. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to the data being written \\
\hline
\mbox{\tt in}  & {\em length} & Number of data to write \\
\hline
\end{DoxyParams}


Definition at line 635 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
637 \{
638 \textcolor{preprocessor}{#if (KSZ8851\_SPI\_SUPPORT == ENABLED)}
639    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
640 
641    \textcolor{comment}{//Pull the CS pin low}
642    interface->spiDriver->assertCs();
643 
644    \textcolor{comment}{//Command phase}
645    interface->spiDriver->transfer(\hyperlink{ksz8851__driver_8h_abb432586d4d1e44e51bb45adda488eef}{KSZ8851\_CMD\_WR\_FIFO});
646 
647    \textcolor{comment}{//Data phase}
648    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}; i++)
649       interface->spiDriver->transfer(\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i]);
650 
651    \textcolor{comment}{//Maintain alignment to 4-byte boundaries}
652    \textcolor{keywordflow}{for}(; i % 4; i++)
653       interface->spiDriver->transfer(0x00);
654 
655    \textcolor{comment}{//Terminate the operation by raising the CS pin}
656    interface->spiDriver->deassertCs();
657 \textcolor{preprocessor}{#else}
658    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
659 
660    \textcolor{comment}{//Data phase}
661    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}; i+=2)
662       \hyperlink{ksz8851__driver_8h_a9d190328ce0d6e301e8090d01680f645}{KSZ8851\_DATA\_REG} = \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i] | \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i+1]<<8;
663 
664    \textcolor{comment}{//Maintain alignment to 4-byte boundaries}
665    \textcolor{keywordflow}{for}(; i % 4; i+=2)
666       \hyperlink{ksz8851__driver_8h_a9d190328ce0d6e301e8090d01680f645}{KSZ8851\_DATA\_REG} = 0x0000;
667 \textcolor{preprocessor}{#endif}
668 \}
\end{DoxyCode}
\mbox{\Hypertarget{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}\label{ksz8851__driver_8c_a10c580074457999176ed89132e2e7dac}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Write\+Reg@{ksz8851\+Write\+Reg}}
\index{ksz8851\+Write\+Reg@{ksz8851\+Write\+Reg}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Write\+Reg()}{ksz8851WriteReg()}}
{\footnotesize\ttfamily void ksz8851\+Write\+Reg (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{address,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{data }\end{DoxyParamCaption})}



Write K\+S\+Z8851 register. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em address} & Register address \\
\hline
\mbox{\tt in}  & {\em data} & Register value \\
\hline
\end{DoxyParams}


Definition at line 542 of file ksz8851\+\_\+driver.\+c.


\begin{DoxyCode}
543 \{
544 \textcolor{preprocessor}{#if (KSZ8851\_SPI\_SUPPORT == ENABLED)}
545    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} command;
546 
547    \textcolor{comment}{//Form the write command}
548    \textcolor{keywordflow}{if}(\hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address} & 0x02)
549       command = \hyperlink{ksz8851__driver_8h_a31072c460d38bfbfbba2fb90e7e0c40a}{KSZ8851\_CMD\_WR\_REG} | \hyperlink{ksz8851__driver_8h_a6db3d4f899f79a03e6c2cad1b95c60a5}{KSZ8851\_CMD\_B3} | 
      \hyperlink{ksz8851__driver_8h_a12e15d7f3a18c794dd12b7298aeee3fd}{KSZ8851\_CMD\_B2};
550    \textcolor{keywordflow}{else}
551       command = \hyperlink{ksz8851__driver_8h_a31072c460d38bfbfbba2fb90e7e0c40a}{KSZ8851\_CMD\_WR\_REG} | \hyperlink{ksz8851__driver_8h_a62e0254d4f1e2badbebf35fa75e32dd8}{KSZ8851\_CMD\_B1} | 
      \hyperlink{ksz8851__driver_8h_afbe555027a2a0ea334935152f9797c09}{KSZ8851\_CMD\_B0};
552 
553    \textcolor{comment}{//Pull the CS pin low}
554    interface->spiDriver->assertCs();
555 
556    \textcolor{comment}{//Command phase}
557    interface->spiDriver->transfer(command | (\hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address} >> 6));
558    interface->spiDriver->transfer(\hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address} << 2);
559 
560    \textcolor{comment}{//Data phase}
561    interface->spiDriver->transfer(\hyperlink{os__port_8h_a34a3aa6cbadec6a80ab1eae8efd0083d}{LSB}(\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}));
562    interface->spiDriver->transfer(\hyperlink{os__port_8h_aeb61a4e8fff2f4624a632a3189cbd3a0}{MSB}(\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}));
563 
564    \textcolor{comment}{//Terminate the operation by raising the CS pin}
565    interface->spiDriver->deassertCs();
566 \textcolor{preprocessor}{#else}
567    \textcolor{comment}{//Set register address}
568    \textcolor{keywordflow}{if}(\hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address} & 0x02)
569       \hyperlink{ksz8851__driver_8h_ac9413f53fa8bdb88278d8a21338ee6c8}{KSZ8851\_CMD\_REG} = \hyperlink{ksz8851__driver_8h_a6db3d4f899f79a03e6c2cad1b95c60a5}{KSZ8851\_CMD\_B3} | 
      \hyperlink{ksz8851__driver_8h_a12e15d7f3a18c794dd12b7298aeee3fd}{KSZ8851\_CMD\_B2} | \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
570    \textcolor{keywordflow}{else}
571       \hyperlink{ksz8851__driver_8h_ac9413f53fa8bdb88278d8a21338ee6c8}{KSZ8851\_CMD\_REG} = \hyperlink{ksz8851__driver_8h_a62e0254d4f1e2badbebf35fa75e32dd8}{KSZ8851\_CMD\_B1} | 
      \hyperlink{ksz8851__driver_8h_afbe555027a2a0ea334935152f9797c09}{KSZ8851\_CMD\_B0} | \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
572 
573    \textcolor{comment}{//Write register value}
574    \hyperlink{ksz8851__driver_8h_a9d190328ce0d6e301e8090d01680f645}{KSZ8851\_DATA\_REG} = \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
575 \textcolor{preprocessor}{#endif}
576 \}
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{ksz8851__driver_8c_a48192455996c9bc18f57ebaf765ff2a3}\label{ksz8851__driver_8c_a48192455996c9bc18f57ebaf765ff2a3}} 
\index{ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}!ksz8851\+Driver@{ksz8851\+Driver}}
\index{ksz8851\+Driver@{ksz8851\+Driver}!ksz8851\+\_\+driver.\+c@{ksz8851\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{ksz8851\+Driver}{ksz8851Driver}}
{\footnotesize\ttfamily const \hyperlink{structNicDriver}{Nic\+Driver} ksz8851\+Driver}

{\bfseries Initial value\+:}
\begin{DoxyCode}
=
\{
   \hyperlink{nic_8h_ac1ce8659a9797513ecd9cc1afedce40ba84802cab6ee937691c3d76122ffaffcd}{NIC\_TYPE\_ETHERNET},
   \hyperlink{ethernet_8h_a6f29d2b24a262d91b7158713728d45f2}{ETH\_MTU},
   \hyperlink{ksz8851__driver_8c_a186b0060fd6765f41161c4627848dcd6}{ksz8851Init},
   \hyperlink{ksz8851__driver_8c_a365f1ffe985b4c6659aa073d09be1915}{ksz8851Tick},
   \hyperlink{ksz8851__driver_8c_a42cb93cb84b62261bb79831984a3c424}{ksz8851EnableIrq},
   \hyperlink{ksz8851__driver_8c_adc5dafbc3317849b70d9adebffdd406f}{ksz8851DisableIrq},
   \hyperlink{ksz8851__driver_8c_ab18e69306f5d7c095355ee869f9534bc}{ksz8851EventHandler},
   \hyperlink{ksz8851__driver_8c_a3c86aab5a7d93e8113fec206d81ed919}{ksz8851SendPacket},
   \hyperlink{ksz8851__driver_8c_a07ebd7cb74831854ec0f495962a70d4f}{ksz8851UpdateMacAddrFilter},
   \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL},
   \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL},
   \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL},
   \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE},
   \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE},
   \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE},
   \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
\}
\end{DoxyCode}


K\+S\+Z8851 driver. 



Definition at line 44 of file ksz8851\+\_\+driver.\+c.

