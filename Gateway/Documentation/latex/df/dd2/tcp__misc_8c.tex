\hypertarget{tcp__misc_8c}{}\section{cyclone\+\_\+tcp/core/tcp\+\_\+misc.c File Reference}
\label{tcp__misc_8c}\index{cyclone\+\_\+tcp/core/tcp\+\_\+misc.\+c@{cyclone\+\_\+tcp/core/tcp\+\_\+misc.\+c}}


Helper functions for T\+CP.  


{\ttfamily \#include $<$stdlib.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}core/socket.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}core/tcp.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}core/tcp\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}core/tcp\+\_\+timer.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}core/ip.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv4/ipv4.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/ipv6.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mibs/mib2\+\_\+module.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mibs/tcp\+\_\+mib\+\_\+module.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}date\+\_\+time.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{tcp__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_a1543cbd65f7ef07345d2b4e4ad740347}{T\+C\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcp\+Send\+Segment} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{nbns__common_8h_a1e87af3c18a2fd36c61faf89949bdc3f}{flags}, \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{tcp_8h_a5c6ae6c0d8819f5ef0fd57e7f9ee6a08}{seq\+Num}, \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{tcp_8h_a077154909d67fa134c81b5a3c4ed57f4}{ack\+Num}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} add\+To\+Queue)
\begin{DoxyCompactList}\small\item\em Send a T\+CP segment. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tcp__misc_8c_a07b59bd89778b5fd8cd9c57dfd7f2866}{tcp\+Send\+Reset\+Segment} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{structIpPseudoHeader}{Ip\+Pseudo\+Header} $\ast$pseudo\+Header, \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Send a T\+CP reset in response to an invalid segment. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tcp__misc_8c_aaa03069a05ec6f7a88f92854a12566be}{tcp\+Add\+Option} (\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{tcp_8h_a9aca84b04dfc09a4eeae08b3b3266eb6}{kind}, const void $\ast$\hyperlink{chap_8h_adfa040d04d16520129a735fff8fb1628}{value}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Append an option to a T\+CP segment. \end{DoxyCompactList}\item 
\hyperlink{tcp_8h_a5562fc6b2b8e28e99a3c0d1c36054b72}{Tcp\+Option} $\ast$ \hyperlink{tcp__misc_8c_aaf3149cdcf1570bfcfcec9c637f34e3b}{tcp\+Get\+Option} (\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{tcp_8h_a9aca84b04dfc09a4eeae08b3b3266eb6}{kind})
\begin{DoxyCompactList}\small\item\em Find a specified option in a T\+CP segment. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tcp__misc_8c_a3aa461df53441116e0217086b8fc705a}{tcp\+Check\+Sequence\+Number} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Test the sequence number of an incoming segment. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tcp__misc_8c_ad62359b91161be196effb675a48647c3}{tcp\+Check\+Syn} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Check the S\+YN bit of an incoming segment. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tcp__misc_8c_ab0f130378ae1ace2ca64d905d15b6f68}{tcp\+Check\+Ack} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Test the A\+CK field of an incoming segment. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} \hyperlink{tcp__misc_8c_ac969fab95bfe0fe6d70d06c57e217640}{tcp\+Is\+Duplicate\+Syn} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{structIpPseudoHeader}{Ip\+Pseudo\+Header} $\ast$pseudo\+Header, \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment)
\begin{DoxyCompactList}\small\item\em Test whether the incoming S\+YN segment is a duplicate. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} \hyperlink{tcp__misc_8c_a7bdb0899eb2dfc03a134c5ba789984ae}{tcp\+Is\+Duplicate\+Ack} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Test whether the incoming acknowledgment is a duplicate. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_a01f0b914b0f9f9f172be7dbb04686b30}{tcp\+Fast\+Retransmit} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket})
\begin{DoxyCompactList}\small\item\em Fast retransmit procedure. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_a966ddcc4168bcae79f40a895ae55fec4}{tcp\+Fast\+Recovery} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n})
\begin{DoxyCompactList}\small\item\em Fast recovery procedure. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_a358215778785524565d6a5f17a7e5b0d}{tcp\+Fast\+Loss\+Recovery} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment)
\begin{DoxyCompactList}\small\item\em Fast loss recovery procedure. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_ac10b3d33d536daffca5246fc1374ba1f}{tcp\+Process\+Segment\+Data} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process the segment text. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_afdcebf22cbad213fdb1d751829db9fb3}{tcp\+Delete\+Control\+Block} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket})
\begin{DoxyCompactList}\small\item\em Delete T\+CB structure. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_a18731fd3f3545ac38f21ad9d570816d6}{tcp\+Update\+Retransmit\+Queue} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket})
\begin{DoxyCompactList}\small\item\em Remove acknowledged segments from retransmission queue. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_a50404ff6be52744d5720b41d6ea544bf}{tcp\+Flush\+Retransmit\+Queue} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket})
\begin{DoxyCompactList}\small\item\em Flush retransmission queue. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_ae6760551554cbe2e5f003565dbe8ab79}{tcp\+Flush\+Syn\+Queue} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket})
\begin{DoxyCompactList}\small\item\em Flush S\+YN queue. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_aa129fd8807bfc2d84d45974b6e21d304}{tcp\+Update\+Sack\+Blocks} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} $\ast$left\+Edge, \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} $\ast$right\+Edge)
\begin{DoxyCompactList}\small\item\em Update the list of non-\/contiguous blocks that have been received. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_aef94daad203698a149c4056b7bbd836a}{tcp\+Update\+Send\+Window} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment)
\begin{DoxyCompactList}\small\item\em Update send window. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_aa1656bdca8c8970333412696664c3064}{tcp\+Update\+Receive\+Window} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket})
\begin{DoxyCompactList}\small\item\em Update receive window so as to avoid Silly Window Syndrome. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} \hyperlink{tcp__misc_8c_a585e1a8e92af5a4740c55f0c0bd7ae08}{tcp\+Compute\+Rto} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket})
\begin{DoxyCompactList}\small\item\em Compute retransmission timeout. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tcp__misc_8c_aee22faafb5104e4cc56a505621050616}{tcp\+Retransmit\+Segment} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket})
\begin{DoxyCompactList}\small\item\em T\+CP segment retransmission. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tcp__misc_8c_ab354828c280bda2e01554f5ea827d752}{tcp\+Nagle\+Algo} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} \hyperlink{nbns__common_8h_a1e87af3c18a2fd36c61faf89949bdc3f}{flags})
\begin{DoxyCompactList}\small\item\em Nagle algorithm implementation. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_af8741d2662dcc13ed4695fec3ef5a365}{tcp\+Change\+State} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfec}{Tcp\+State} new\+State)
\begin{DoxyCompactList}\small\item\em Update T\+CP F\+SM current state. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_a1d69d8ed2662a74417c757291f540077}{tcp\+Update\+Events} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket})
\begin{DoxyCompactList}\small\item\em Update T\+CP related events. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} \hyperlink{tcp__misc_8c_a004bf9b96c5217222960bc09c2e48a78}{tcp\+Wait\+For\+Events} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} event\+Mask, \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t} timeout)
\begin{DoxyCompactList}\small\item\em Wait for a particular T\+CP event. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_a9bbd4fc8a09ba17e2b064ac4674b5d09}{tcp\+Write\+Tx\+Buffer} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{tcp_8h_a5c6ae6c0d8819f5ef0fd57e7f9ee6a08}{seq\+Num}, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Copy incoming data to the send buffer. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tcp__misc_8c_ad88122545f2bfada890011b9057701ed}{tcp\+Read\+Tx\+Buffer} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{tcp_8h_a5c6ae6c0d8819f5ef0fd57e7f9ee6a08}{seq\+Num}, \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Copy data from the send buffer. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_a9a639edc348cbd2e86a240177099120a}{tcp\+Write\+Rx\+Buffer} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{tcp_8h_a5c6ae6c0d8819f5ef0fd57e7f9ee6a08}{seq\+Num}, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{tcp_8h_ae0743b8326e63b450642f96ca32a3bea}{data\+Offset}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Copy incoming data to the receive buffer. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_aa97c7d519e5e230fcdd62de48d790776}{tcp\+Read\+Rx\+Buffer} (\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$\hyperlink{bsd__socket_8h_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{tcp_8h_a5c6ae6c0d8819f5ef0fd57e7f9ee6a08}{seq\+Num}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Copy data from the receive buffer. \end{DoxyCompactList}\item 
void \hyperlink{tcp__misc_8c_a73fae08a3e43bdbf6a01ab32d8802949}{tcp\+Dump\+Header} (const \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$segment, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} iss, \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} irs)
\begin{DoxyCompactList}\small\item\em Dump T\+CP header for debugging purpose. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Helper functions for T\+CP. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{tcp__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{tcp__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_a1543cbd65f7ef07345d2b4e4ad740347}{T\+C\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file tcp\+\_\+misc.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{tcp__misc_8c_aaa03069a05ec6f7a88f92854a12566be}\label{tcp__misc_8c_aaa03069a05ec6f7a88f92854a12566be}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Add\+Option@{tcp\+Add\+Option}}
\index{tcp\+Add\+Option@{tcp\+Add\+Option}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Add\+Option()}{tcpAddOption()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tcp\+Add\+Option (\begin{DoxyParamCaption}\item[{\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{kind,  }\item[{const void $\ast$}]{value,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{length }\end{DoxyParamCaption})}



Append an option to a T\+CP segment. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em segment} & Pointer to the T\+CP header \\
\hline
\mbox{\tt in}  & {\em kind} & Option code \\
\hline
\mbox{\tt in}  & {\em value} & Option value \\
\hline
\mbox{\tt in}  & {\em length} & Length of the option value \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 421 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
423 \{
424    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
425    \textcolor{keywordtype}{size\_t} paddingSize;
426    \hyperlink{tcp_8h_a5562fc6b2b8e28e99a3c0d1c36054b72}{TcpOption} *option;
427 
428    \textcolor{comment}{//Length of the complete option field}
429    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} += \textcolor{keyword}{sizeof}(\hyperlink{tcp_8h_a5562fc6b2b8e28e99a3c0d1c36054b72}{TcpOption});
430 
431    \textcolor{comment}{//Make sure there is enough space to add the specified option}
432    \textcolor{keywordflow}{if}((segment->dataOffset * 4 + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}) > \hyperlink{tcp_8h_a296869e905bda7013716794027a5b07c}{TCP\_MAX\_HEADER\_LENGTH})
433       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
434 
435    \textcolor{comment}{//Index of the first available byte}
436    i = segment->dataOffset * 4 - \textcolor{keyword}{sizeof}(\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader});
437 
438    \textcolor{comment}{//Calculate the number of padding bytes}
439    paddingSize = (\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} % 4) ? 4 - (\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} % 4) : 0;
440    \textcolor{comment}{//Write padding bytes}
441    \textcolor{keywordflow}{while}(paddingSize--)
442       segment->options[i++] = \hyperlink{tcp_8h_a064186fb289be38d3e1a71ecf446fe8cae9a7564649350c5c35115c0284fe79ba}{TCP\_OPTION\_NOP};
443 
444    \textcolor{comment}{//Point to the current location}
445    option = (\hyperlink{tcp_8h_a5562fc6b2b8e28e99a3c0d1c36054b72}{TcpOption} *) (segment->options + i);
446    \textcolor{comment}{//Write specified option}
447    option->kind = \hyperlink{tcp_8h_a9aca84b04dfc09a4eeae08b3b3266eb6}{kind};
448    option->length = \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
449    memcpy(option->value, \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - \textcolor{keyword}{sizeof}(\hyperlink{tcp_8h_a5562fc6b2b8e28e99a3c0d1c36054b72}{TcpOption}));
450    \textcolor{comment}{//Adjust index value}
451    i += \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
452 
453    \textcolor{comment}{//Update TCP header length}
454    segment->dataOffset = (\textcolor{keyword}{sizeof}(\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader}) + i) / 4;
455 
456    \textcolor{comment}{//Option successfully added}
457    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
458 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_af8741d2662dcc13ed4695fec3ef5a365}\label{tcp__misc_8c_af8741d2662dcc13ed4695fec3ef5a365}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Change\+State@{tcp\+Change\+State}}
\index{tcp\+Change\+State@{tcp\+Change\+State}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Change\+State()}{tcpChangeState()}}
{\footnotesize\ttfamily void tcp\+Change\+State (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfec}{Tcp\+State}}]{new\+State }\end{DoxyParamCaption})}



Update T\+CP F\+SM current state. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\mbox{\tt in}  & {\em new\+State} & New T\+CP state to switch to \\
\hline
\end{DoxyParams}


Definition at line 1725 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1726 \{
1727    \textcolor{comment}{//Enter CLOSED state?}
1728    \textcolor{keywordflow}{if}(newState == \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfeca1af39131036c81d79f09174d2fb6f788}{TCP\_STATE\_CLOSED})
1729    \{
1730       \textcolor{comment}{//Check previous state}
1731       \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state == \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfeca29f7d016b33a1856dfba699643c69260}{TCP\_STATE\_LAST\_ACK} ||
1732          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state == \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfeca8fa1774b3f785db85813df1b8e158c56}{TCP\_STATE\_TIME\_WAIT})
1733       \{
1734          \textcolor{comment}{//The connection has been closed properly}
1735          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->closedFlag = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1736       \}
1737       \textcolor{keywordflow}{else}
1738       \{
1739          \textcolor{comment}{//The connection has been reset by the peer}
1740          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->resetFlag = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1741       \}
1742    \}
1743 
1744    \textcolor{comment}{//Enter the desired state}
1745    \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state = newState;
1746    \textcolor{comment}{//Update TCP related events}
1747    \hyperlink{tcp__misc_8c_a1d69d8ed2662a74417c757291f540077}{tcpUpdateEvents}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
1748 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_ab0f130378ae1ace2ca64d905d15b6f68}\label{tcp__misc_8c_ab0f130378ae1ace2ca64d905d15b6f68}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Check\+Ack@{tcp\+Check\+Ack}}
\index{tcp\+Check\+Ack@{tcp\+Check\+Ack}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Check\+Ack()}{tcpCheckAck()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tcp\+Check\+Ack (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Test the A\+CK field of an incoming segment. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the current socket \\
\hline
\mbox{\tt in}  & {\em segment} & Pointer to the T\+CP segment to check \\
\hline
\mbox{\tt in}  & {\em length} & Length of the segment data \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
N\+O\+\_\+\+E\+R\+R\+OR if the acknowledgment is acceptable, E\+R\+R\+O\+R\+\_\+\+F\+A\+I\+L\+U\+RE otherwise 
\end{DoxyReturn}


Definition at line 628 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
629 \{
630    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
631    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} ownd;
632    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} thresh;
633    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} duplicateFlag;
634    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} updateFlag;
635 
636    \textcolor{comment}{//If the ACK bit is off drop the segment and return}
637    \textcolor{keywordflow}{if}(!(segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK}))
638       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
639 
640    \textcolor{comment}{//Test the case where SEG.ACK < SND.UNA}
641    \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->ackNum, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna) < 0)
642    \{
643       \textcolor{comment}{//An old duplicate ACK has been received}
644       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
645    \}
646    \textcolor{comment}{//Test the case where SEG.ACK > SND.NXT}
647    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->ackNum, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt) > 0)
648    \{
649       \textcolor{comment}{//Send an ACK segment indicating the current send sequence number}
650       \textcolor{comment}{//and the acknowledgment number expected to be received}
651       \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcpSendSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK}, 
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt, 0, \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
652 
653       \textcolor{comment}{//The ACK segment acknowledges something not yet sent}
654       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
655    \}
656 
657    \textcolor{comment}{//Check whether the ACK is a duplicate}
658    duplicateFlag = \hyperlink{tcp__misc_8c_a7bdb0899eb2dfc03a134c5ba789984ae}{tcpIsDuplicateAck}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, segment, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
659 
660    \textcolor{comment}{//The send window should be updated}
661    \hyperlink{tcp__misc_8c_aef94daad203698a149c4056b7bbd836a}{tcpUpdateSendWindow}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, segment);
662 
663    \textcolor{comment}{//The incoming ACK segment acknowledges new data?}
664    \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->ackNum, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna) > 0)
665    \{
666 \textcolor{preprocessor}{#if (TCP\_CONGEST\_CONTROL\_SUPPORT == ENABLED)}
667       \textcolor{comment}{//Compute the number of bytes acknowledged by the incoming ACK}
668       n = segment->ackNum - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna;
669 
670       \textcolor{comment}{//Check whether the ACK segment acknowledges our SYN}
671       \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna == \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->iss)
672          n--;
673 
674       \textcolor{comment}{//Total number of bytes acknowledged during the whole round-trip}
675       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->n += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
676 \textcolor{preprocessor}{#endif}
677       \textcolor{comment}{//Update SND.UNA pointer}
678       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna = segment->ackNum;
679 
680       \textcolor{comment}{//Compute retransmission timeout}
681       updateFlag = \hyperlink{tcp__misc_8c_a585e1a8e92af5a4740c55f0c0bd7ae08}{tcpComputeRto}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
682 
683       \textcolor{comment}{//Any segments on the retransmission queue which are thereby}
684       \textcolor{comment}{//entirely acknowledged are removed}
685       \hyperlink{tcp__misc_8c_a18731fd3f3545ac38f21ad9d570816d6}{tcpUpdateRetransmitQueue}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
686 
687 \textcolor{preprocessor}{#if (TCP\_CONGEST\_CONTROL\_SUPPORT == ENABLED)}
688       \textcolor{comment}{//Check congestion state}
689       \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->congestState == \hyperlink{tcp_8h_ac69e0e40557f11fc979456965cdcd2f1a8a8b065a15d7f4d16740a5745ff49fb2}{TCP\_CONGEST\_STATE\_RECOVERY})
690       \{
691          \textcolor{comment}{//Invoke fast recovery (refer to RFC 6582)}
692          \hyperlink{tcp__misc_8c_a966ddcc4168bcae79f40a895ae55fec4}{tcpFastRecovery}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, segment, n);
693       \}
694       \textcolor{keywordflow}{else}
695       \{
696          \textcolor{comment}{//Reset duplicate ACK counter}
697          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->dupAckCount = 0;
698 
699          \textcolor{comment}{//Check congestion state}
700          \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->congestState == \hyperlink{tcp_8h_ac69e0e40557f11fc979456965cdcd2f1a5c24204654ace8731ab8676ce459dc9a}{TCP\_CONGEST\_STATE\_LOSS\_RECOVERY})
701          \{
702             \textcolor{comment}{//Invoke fast loss recovery}
703             \hyperlink{tcp__misc_8c_a358215778785524565d6a5f17a7e5b0d}{tcpFastLossRecovery}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, segment);
704          \}
705 
706          \textcolor{comment}{//Slow start algorithm is used when cwnd is lower than ssthresh}
707          \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd < \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->ssthresh)
708          \{
709             \textcolor{comment}{//During slow start, TCP increments cwnd by at most SMSS bytes}
710             \textcolor{comment}{//for each ACK received that cumulatively acknowledges new data}
711             \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd += \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(n, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss);
712          \}
713          \textcolor{comment}{//Congestion avoidance algorithm is used when cwnd exceeds ssthres}
714          \textcolor{keywordflow}{else}
715          \{
716             \textcolor{comment}{//Congestion window is updated once per RTT}
717             \textcolor{keywordflow}{if}(updateFlag)
718             \{
719                \textcolor{comment}{//TCP must not increment cwnd by more than SMSS bytes}
720                \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd += \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->n, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss);
721             \}
722          \}
723       \}
724 
725       \textcolor{comment}{//Limit the size of the congestion window}
726       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize);
727 \textcolor{preprocessor}{#endif}
728    \}
729    \textcolor{comment}{//The incoming ACK segment does not acknowledge new data?}
730    \textcolor{keywordflow}{else}
731    \{
732 \textcolor{preprocessor}{#if (TCP\_CONGEST\_CONTROL\_SUPPORT == ENABLED)}
733       \textcolor{comment}{//Check whether the acknowledgment is a duplicate}
734       \textcolor{keywordflow}{if}(duplicateFlag)
735       \{
736          \textcolor{comment}{//Increment duplicate ACK counter}
737          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->dupAckCount++;
738          \textcolor{comment}{//Debug message}
739          \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"TCP duplicate ACK #%u\(\backslash\)r\(\backslash\)n"}, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->dupAckCount);
740       \}
741       \textcolor{keywordflow}{else}
742       \{
743          \textcolor{comment}{//Reset duplicate ACK counter}
744          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->dupAckCount = 0;
745       \}
746 
747       \textcolor{comment}{//Check congestion state}
748       \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->congestState == \hyperlink{tcp_8h_ac69e0e40557f11fc979456965cdcd2f1ae65a75edff829ef84c7a96ac82a6e0f3}{TCP\_CONGEST\_STATE\_IDLE})
749       \{
750          \textcolor{comment}{//Use default duplicate ACK threshold}
751          thresh = \hyperlink{tcp_8h_a71e45bd21d93e12c4720cce4c2a890fe}{TCP\_FAST\_RETRANSMIT\_THRES};
752          \textcolor{comment}{//Amount of data sent but not yet acknowledged}
753          ownd = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna;
754 
755          \textcolor{comment}{//Test if there is either no unsent data ready for transmission at}
756          \textcolor{comment}{//the sender, or the advertised receive window does not permit new}
757          \textcolor{comment}{//segments to be transmitted (refer to RFC 5827 section 3.1)}
758          \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUser == 0 || \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWnd <= (\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt - 
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna))
759          \{
760             \textcolor{comment}{//Compute the duplicate ACK threshold used to trigger a}
761             \textcolor{comment}{//retransmission}
762             \textcolor{keywordflow}{if}(ownd <= (3 * \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss))
763                thresh = 1;
764             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(ownd <= (4 * \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss))
765                thresh = 2;
766          \}
767 
768          \textcolor{comment}{//Check the number of duplicate ACKs that have been received}
769          \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->dupAckCount >= thresh)
770          \{
771             \textcolor{comment}{//The TCP sender first checks the value of recover to see if the}
772             \textcolor{comment}{//cumulative acknowledgment field covers more than recover}
773             \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->ackNum, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->recover + 1) > 0)
774             \{
775                \textcolor{comment}{//Invoke Fast Retransmit (refer to RFC 6582)}
776                \hyperlink{tcp__misc_8c_a01f0b914b0f9f9f172be7dbb04686b30}{tcpFastRetransmit}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
777             \}
778             \textcolor{keywordflow}{else}
779             \{
780                \textcolor{comment}{//If not, the TCP does not enter fast retransmit and does not}
781                \textcolor{comment}{//reset ssthres...}
782             \}
783          \}
784       \}
785       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->congestState == \hyperlink{tcp_8h_ac69e0e40557f11fc979456965cdcd2f1a8a8b065a15d7f4d16740a5745ff49fb2}{TCP\_CONGEST\_STATE\_RECOVERY})
786       \{
787          \textcolor{comment}{//Duplicate ACK received?}
788          \textcolor{keywordflow}{if}(duplicateFlag)
789          \{
790             \textcolor{comment}{//For each additional duplicate ACK received (after the third),}
791             \textcolor{comment}{//cwnd must be incremented by SMSS. This artificially inflates}
792             \textcolor{comment}{//the congestion window in order to reflect the additional}
793             \textcolor{comment}{//segment that has left the network}
794             \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd += \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss;
795          \}
796       \}
797 
798       \textcolor{comment}{//Limit the size of the congestion window}
799       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize);
800 \textcolor{preprocessor}{#endif}
801    \}
802 
803    \textcolor{comment}{//Update TX events}
804    \hyperlink{tcp__misc_8c_a1d69d8ed2662a74417c757291f540077}{tcpUpdateEvents}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
805 
806    \textcolor{comment}{//No error to report}
807    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
808 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a3aa461df53441116e0217086b8fc705a}\label{tcp__misc_8c_a3aa461df53441116e0217086b8fc705a}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Check\+Sequence\+Number@{tcp\+Check\+Sequence\+Number}}
\index{tcp\+Check\+Sequence\+Number@{tcp\+Check\+Sequence\+Number}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Check\+Sequence\+Number()}{tcpCheckSequenceNumber()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tcp\+Check\+Sequence\+Number (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Test the sequence number of an incoming segment. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the current socket \\
\hline
\mbox{\tt in}  & {\em segment} & Pointer to the T\+CP segment to check \\
\hline
\mbox{\tt in}  & {\em length} & Length of the segment data \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
N\+O\+\_\+\+E\+R\+R\+OR if the incoming segment is acceptable, E\+R\+R\+O\+R\+\_\+\+F\+A\+I\+L\+U\+RE otherwise 
\end{DoxyReturn}


Definition at line 525 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
526 \{
527    \textcolor{comment}{//Acceptability test for an incoming segment}
528    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} acceptable = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
529 
530    \textcolor{comment}{//Case where both segment length and receive window are zero}
531    \textcolor{keywordflow}{if}(!\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} && !\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd)
532    \{
533       \textcolor{comment}{//Make sure that SEG.SEQ = RCV.NXT}
534       \textcolor{keywordflow}{if}(segment->seqNum == \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt)
535       \{
536          acceptable = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
537       \}
538    \}
539    \textcolor{comment}{//Case where segment length is zero and receive window is non zero}
540    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} && \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd)
541    \{
542       \textcolor{comment}{//Make sure that RCV.NXT <= SEG.SEQ < RCV.NXT+RCV.WND}
543       \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->seqNum, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt) >= 0 &&
544          \hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->seqNum, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt + \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd) < 0)
545       \{
546          acceptable = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
547       \}
548    \}
549    \textcolor{comment}{//Case where both segment length and receive window are non zero}
550    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} && \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd)
551    \{
552       \textcolor{comment}{//Check whether RCV.NXT <= SEG.SEQ < RCV.NXT+RCV.WND}
553       \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->seqNum, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt) >= 0 &&
554          \hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->seqNum, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt + \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd) < 0)
555       \{
556          acceptable = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
557       \}
558       \textcolor{comment}{//or RCV.NXT <= SEG.SEQ+SEG.LEN-1 < RCV.NXT+RCV.WND}
559       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->seqNum + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - 1, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt) >= 0 &&
560          \hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->seqNum + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - 1, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt + 
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd) < 0)
561       \{
562          acceptable = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
563       \}
564    \}
565 
566    \textcolor{comment}{//Non acceptable sequence number?}
567    \textcolor{keywordflow}{if}(!acceptable)
568    \{
569       \textcolor{comment}{//Debug message}
570       \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"Sequence number is not acceptable!\(\backslash\)r\(\backslash\)n"});
571 
572       \textcolor{comment}{//If an incoming segment is not acceptable, an acknowledgment}
573       \textcolor{comment}{//should be sent in reply (unless the RST bit is set)}
574       \textcolor{keywordflow}{if}(!(segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a2eaeb7e7c1984d0bd4d1cbb48b2b5ce4}{TCP\_FLAG\_RST}))
575          \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcpSendSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK}, 
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt, 0, \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
576 
577       \textcolor{comment}{//Return status code}
578       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
579    \}
580 
581    \textcolor{comment}{//Sequence number is acceptable}
582    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
583 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_ad62359b91161be196effb675a48647c3}\label{tcp__misc_8c_ad62359b91161be196effb675a48647c3}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Check\+Syn@{tcp\+Check\+Syn}}
\index{tcp\+Check\+Syn@{tcp\+Check\+Syn}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Check\+Syn()}{tcpCheckSyn()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tcp\+Check\+Syn (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Check the S\+YN bit of an incoming segment. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the current socket \\
\hline
\mbox{\tt in}  & {\em segment} & Pointer to the T\+CP segment to check \\
\hline
\mbox{\tt in}  & {\em length} & Length of the segment data \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
E\+R\+R\+O\+R\+\_\+\+F\+A\+I\+L\+U\+RE if the S\+YN is in the window, N\+O\+\_\+\+E\+R\+R\+OR otherwise 
\end{DoxyReturn}


Definition at line 594 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
595 \{
596    \textcolor{comment}{//Check the SYN bit}
597    \textcolor{keywordflow}{if}(segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7af2f8a42ff8bff07cbca1cd2ed6df9fae}{TCP\_FLAG\_SYN})
598    \{
599       \textcolor{comment}{//If this step is reached, the SYN is in the window. It is an error}
600       \textcolor{comment}{//and a reset shall be sent in response}
601       \textcolor{keywordflow}{if}(segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK})
602       \{
603          \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcpSendSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a2eaeb7e7c1984d0bd4d1cbb48b2b5ce4}{TCP\_FLAG\_RST}, segment->ackNum, 0, 0, 
      \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
604       \}
605       \textcolor{keywordflow}{else}
606       \{
607          \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcpSendSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a2eaeb7e7c1984d0bd4d1cbb48b2b5ce4}{TCP\_FLAG\_RST} | 
      \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK}, 0,
608             segment->seqNum + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} + 1, 0, \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
609       \}
610 
611       \textcolor{comment}{//Return immediately}
612       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
613    \}
614 
615    \textcolor{comment}{//No error to report}
616    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
617 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a585e1a8e92af5a4740c55f0c0bd7ae08}\label{tcp__misc_8c_a585e1a8e92af5a4740c55f0c0bd7ae08}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Compute\+Rto@{tcp\+Compute\+Rto}}
\index{tcp\+Compute\+Rto@{tcp\+Compute\+Rto}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Compute\+Rto()}{tcpComputeRto()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} tcp\+Compute\+Rto (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket }\end{DoxyParamCaption})}



Compute retransmission timeout. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
T\+R\+UE if the R\+TT measurement is complete, else F\+A\+L\+SE 
\end{DoxyReturn}


Definition at line 1424 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1425 \{
1426    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} flag;
1427    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{ndp_8h_a4c5c6ceb8ed33456261fa907136e0c3a}{r};
1428    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{coap__common_8h_ab90adf2873f721fb4a969230dbcd7a59}{delta};
1429 
1430    \textcolor{comment}{//Clear flag}
1431    flag = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1432 
1433    \textcolor{comment}{//TCP implementation takes one RTT measurement at a time}
1434    \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttBusy)
1435    \{
1436       \textcolor{comment}{//Ensure the incoming ACK number covers the expected sequence number}
1437       \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttSeqNum) > 0)
1438       \{
1439          \textcolor{comment}{//Calculate round-time trip}
1440          r = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}() - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttStartTime;
1441 
1442          \textcolor{comment}{//First RTT measurement?}
1443          \textcolor{keywordflow}{if}(!\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->srtt && !\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttvar)
1444          \{
1445             \textcolor{comment}{//Initialize RTO calculation algorithm}
1446             \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->srtt = \hyperlink{ndp_8h_a4c5c6ceb8ed33456261fa907136e0c3a}{r};
1447             \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttvar = r / 2;
1448          \}
1449          \textcolor{keywordflow}{else}
1450          \{
1451             \textcolor{comment}{//Calculate the difference between the measured value and the}
1452             \textcolor{comment}{//current RTT estimator}
1453             delta = (r > \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->srtt) ? (r - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->srtt) : (
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->srtt - \hyperlink{ndp_8h_a4c5c6ceb8ed33456261fa907136e0c3a}{r});
1454 
1455             \textcolor{comment}{//Implement Van Jacobson's algorithm (as specified in RFC 6298 2.3)}
1456             \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttvar = (3 * \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttvar + \hyperlink{coap__common_8h_ab90adf2873f721fb4a969230dbcd7a59}{delta}) / 4;
1457             \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->srtt = (7 * \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->srtt + \hyperlink{ndp_8h_a4c5c6ceb8ed33456261fa907136e0c3a}{r}) / 8;
1458          \}
1459 
1460          \textcolor{comment}{//Calculate the next retransmission timeout}
1461          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rto = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->srtt + 4 * \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttvar;
1462 
1463          \textcolor{comment}{//Whenever RTO is computed, if it is less than 1 second, then the RTO}
1464          \textcolor{comment}{//should be rounded up to 1 second}
1465          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rto = \hyperlink{os__port_8h_afa99ec4acc4ecb2dc3c2d05da15d0e3f}{MAX}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rto, \hyperlink{tcp_8h_a305211e7eb6a1e212f4e0647da3cf92b}{TCP\_MIN\_RTO});
1466 
1467          \textcolor{comment}{//A maximum value may be placed on RTO provided it is at least 60}
1468          \textcolor{comment}{//seconds}
1469          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rto = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rto, \hyperlink{tcp_8h_ab10a9785dd0ff10bb73ddbcf6f8f43a8}{TCP\_MAX\_RTO});
1470 
1471          \textcolor{comment}{//Debug message}
1472          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"R=%"} PRIu32 \textcolor{stringliteral}{", SRTT=%"} PRIu32 \textcolor{stringliteral}{", RTTVAR=%"} PRIu32 \textcolor{stringliteral}{", RTO=%"} PRIu32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"},
1473             r, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->srtt, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttvar, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rto);
1474 
1475          \textcolor{comment}{//RTT measurement is complete}
1476          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttBusy = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1477          \textcolor{comment}{//Set flag}
1478          flag = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1479       \}
1480    \}
1481 
1482    \textcolor{comment}{//Return TRUE if the RTT measurement is complete}
1483    \textcolor{keywordflow}{return} flag;
1484 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_afdcebf22cbad213fdb1d751829db9fb3}\label{tcp__misc_8c_afdcebf22cbad213fdb1d751829db9fb3}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Delete\+Control\+Block@{tcp\+Delete\+Control\+Block}}
\index{tcp\+Delete\+Control\+Block@{tcp\+Delete\+Control\+Block}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Delete\+Control\+Block()}{tcpDeleteControlBlock()}}
{\footnotesize\ttfamily void tcp\+Delete\+Control\+Block (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket }\end{DoxyParamCaption})}



Delete T\+CB structure. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\end{DoxyParams}


Definition at line 1130 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1131 \{
1132    \textcolor{comment}{//Delete retransmission queue}
1133    \hyperlink{tcp__misc_8c_a50404ff6be52744d5720b41d6ea544bf}{tcpFlushRetransmitQueue}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
1134 
1135    \textcolor{comment}{//Delete SYN queue}
1136    \hyperlink{tcp__misc_8c_ae6760551554cbe2e5f003565dbe8ab79}{tcpFlushSynQueue}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
1137 
1138    \textcolor{comment}{//Release transmit buffer}
1139    \hyperlink{net__mem_8c_ac0a46f396754e069dd1ee65cdc559b28}{netBufferSetLength}((\hyperlink{structNetBuffer}{NetBuffer} *) &\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBuffer, 0);
1140 
1141    \textcolor{comment}{//Release receive buffer}
1142    \hyperlink{net__mem_8c_ac0a46f396754e069dd1ee65cdc559b28}{netBufferSetLength}((\hyperlink{structNetBuffer}{NetBuffer} *) &\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBuffer, 0);
1143 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a73fae08a3e43bdbf6a01ab32d8802949}\label{tcp__misc_8c_a73fae08a3e43bdbf6a01ab32d8802949}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Dump\+Header@{tcp\+Dump\+Header}}
\index{tcp\+Dump\+Header@{tcp\+Dump\+Header}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Dump\+Header()}{tcpDumpHeader()}}
{\footnotesize\ttfamily void tcp\+Dump\+Header (\begin{DoxyParamCaption}\item[{const \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment,  }\item[{size\+\_\+t}]{length,  }\item[{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t}}]{iss,  }\item[{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t}}]{irs }\end{DoxyParamCaption})}



Dump T\+CP header for debugging purpose. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em segment} & Pointer to the T\+CP header \\
\hline
\mbox{\tt in}  & {\em length} & Length of the segment data \\
\hline
\mbox{\tt in}  & {\em iss} & Initial send sequence number (needed to compute relative S\+EQ number) \\
\hline
\mbox{\tt in}  & {\em irs} & Initial receive sequence number (needed to compute relative A\+CK number) \\
\hline
\end{DoxyParams}


Definition at line 2067 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
2069 \{
2070    \textcolor{comment}{//Dump TCP header contents}
2071    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"%"} PRIu16 \textcolor{stringliteral}{" > %"} PRIu16 \textcolor{stringliteral}{": %c%c%c%c%c%c seq=%"} PRIu32 \textcolor{stringliteral}{"(%"} PRIu32 \textcolor{stringliteral}{") "}
2072       \textcolor{stringliteral}{"ack=%"} PRIu32 \textcolor{stringliteral}{"(%"} PRIu32 \textcolor{stringliteral}{") win=%"} PRIu16 \textcolor{stringliteral}{" len=%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"},
2073       \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(segment->srcPort), \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(segment->destPort),
2074       (segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a332cfb33224b794e0be773cba056efa1}{TCP\_FLAG\_FIN}) ? \textcolor{charliteral}{'F'} : \textcolor{charliteral}{'-'},
2075       (segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7af2f8a42ff8bff07cbca1cd2ed6df9fae}{TCP\_FLAG\_SYN}) ? \textcolor{charliteral}{'S'} : \textcolor{charliteral}{'-'},
2076       (segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a2eaeb7e7c1984d0bd4d1cbb48b2b5ce4}{TCP\_FLAG\_RST}) ? \textcolor{charliteral}{'R'} : \textcolor{charliteral}{'-'},
2077       (segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a44a138e095774788c0f16e906d5a4c25}{TCP\_FLAG\_PSH}) ? \textcolor{charliteral}{'P'} : \textcolor{charliteral}{'-'},
2078       (segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK}) ? \textcolor{charliteral}{'A'} : \textcolor{charliteral}{'-'},
2079       (segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7ae04489b7fa5cac77c12d26a0d0d1e398}{TCP\_FLAG\_URG}) ? \textcolor{charliteral}{'U'} : \textcolor{charliteral}{'-'},
2080       \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(segment->seqNum), \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(segment->seqNum) - iss,
2081       \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(segment->ackNum), \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(segment->ackNum) - irs,
2082       \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(segment->window), \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
2083 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a358215778785524565d6a5f17a7e5b0d}\label{tcp__misc_8c_a358215778785524565d6a5f17a7e5b0d}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Fast\+Loss\+Recovery@{tcp\+Fast\+Loss\+Recovery}}
\index{tcp\+Fast\+Loss\+Recovery@{tcp\+Fast\+Loss\+Recovery}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Fast\+Loss\+Recovery()}{tcpFastLossRecovery()}}
{\footnotesize\ttfamily void tcp\+Fast\+Loss\+Recovery (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment }\end{DoxyParamCaption})}



Fast loss recovery procedure. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the current socket \\
\hline
\mbox{\tt in}  & {\em segment} & Pointer to the incoming T\+CP segment \\
\hline
\end{DoxyParams}


Definition at line 1025 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1026 \{
1027 \textcolor{preprocessor}{#if (TCP\_CONGEST\_CONTROL\_SUPPORT == ENABLED)}
1028    \textcolor{comment}{//Check whether this ACK acknowledges all of the data up to and}
1029    \textcolor{comment}{//including recover}
1030    \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->ackNum, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->recover) > 0)
1031    \{
1032       \textcolor{comment}{//This is a full acknowledgment}
1033       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"TCP full acknowledgment\(\backslash\)r\(\backslash\)n"});
1034 
1035       \textcolor{comment}{//Exit the fast loss recovery procedure}
1036       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->congestState = \hyperlink{tcp_8h_ac69e0e40557f11fc979456965cdcd2f1ae65a75edff829ef84c7a96ac82a6e0f3}{TCP\_CONGEST\_STATE\_IDLE};
1037    \}
1038    \textcolor{keywordflow}{else}
1039    \{
1040       \textcolor{comment}{//If this ACK does not acknowledge all of the data up to and including}
1041       \textcolor{comment}{//recover, then this is a partial ACK}
1042       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"TCP partial acknowledgment\(\backslash\)r\(\backslash\)n"});
1043 
1044       \textcolor{comment}{//Retransmit the first unacknowledged segment}
1045       \hyperlink{tcp__misc_8c_aee22faafb5104e4cc56a505621050616}{tcpRetransmitSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
1046 
1047       \textcolor{comment}{//Do not exit the fast loss recovery procedure...}
1048       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->congestState = \hyperlink{tcp_8h_ac69e0e40557f11fc979456965cdcd2f1a5c24204654ace8731ab8676ce459dc9a}{TCP\_CONGEST\_STATE\_LOSS\_RECOVERY};
1049    \}
1050 \textcolor{preprocessor}{#endif}
1051 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a966ddcc4168bcae79f40a895ae55fec4}\label{tcp__misc_8c_a966ddcc4168bcae79f40a895ae55fec4}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Fast\+Recovery@{tcp\+Fast\+Recovery}}
\index{tcp\+Fast\+Recovery@{tcp\+Fast\+Recovery}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Fast\+Recovery()}{tcpFastRecovery()}}
{\footnotesize\ttfamily void tcp\+Fast\+Recovery (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{n }\end{DoxyParamCaption})}



Fast recovery procedure. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the current socket \\
\hline
\mbox{\tt in}  & {\em segment} & Pointer to the incoming T\+CP segment \\
\hline
\mbox{\tt in}  & {\em n} & Number of bytes acknowledged by the incoming A\+CK \\
\hline
\end{DoxyParams}


Definition at line 976 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
977 \{
978 \textcolor{preprocessor}{#if (TCP\_CONGEST\_CONTROL\_SUPPORT == ENABLED)}
979    \textcolor{comment}{//Check whether this ACK acknowledges all of the data up to and including}
980    \textcolor{comment}{//recover}
981    \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->ackNum, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->recover) > 0)
982    \{
983       \textcolor{comment}{//This is a full acknowledgment}
984       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"TCP full acknowledgment\(\backslash\)r\(\backslash\)n"});
985 
986       \textcolor{comment}{//Set cwnd to ssthresh}
987       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->ssthresh;
988       \textcolor{comment}{//Exit the fast recovery procedure}
989       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->congestState = \hyperlink{tcp_8h_ac69e0e40557f11fc979456965cdcd2f1ae65a75edff829ef84c7a96ac82a6e0f3}{TCP\_CONGEST\_STATE\_IDLE};
990    \}
991    \textcolor{keywordflow}{else}
992    \{
993       \textcolor{comment}{//If this ACK does not acknowledge all of the data up to and including}
994       \textcolor{comment}{//recover, then this is a partial ACK}
995       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"TCP partial acknowledgment\(\backslash\)r\(\backslash\)n"});
996 
997       \textcolor{comment}{//Retransmit the first unacknowledged segment}
998       \hyperlink{tcp__misc_8c_aee22faafb5104e4cc56a505621050616}{tcpRetransmitSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
999 
1000       \textcolor{comment}{//Deflate the congestion window by the amount of new data acknowledged}
1001       \textcolor{comment}{//by the cumulative acknowledgment field}
1002       \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd > \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n})
1003          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1004 
1005       \textcolor{comment}{//If the partial ACK acknowledges at least one SMSS of new data, then}
1006       \textcolor{comment}{//add back SMSS bytes to the congestion window. This artificially}
1007       \textcolor{comment}{//inflates the congestion window in order to reflect the additional}
1008       \textcolor{comment}{//segment that has left the network}
1009       \textcolor{keywordflow}{if}(\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n} >= \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss)
1010          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd += \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss;
1011 
1012       \textcolor{comment}{//Do not exit the fast recovery procedure...}
1013       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->congestState = \hyperlink{tcp_8h_ac69e0e40557f11fc979456965cdcd2f1a8a8b065a15d7f4d16740a5745ff49fb2}{TCP\_CONGEST\_STATE\_RECOVERY};
1014    \}
1015 \textcolor{preprocessor}{#endif}
1016 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a01f0b914b0f9f9f172be7dbb04686b30}\label{tcp__misc_8c_a01f0b914b0f9f9f172be7dbb04686b30}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Fast\+Retransmit@{tcp\+Fast\+Retransmit}}
\index{tcp\+Fast\+Retransmit@{tcp\+Fast\+Retransmit}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Fast\+Retransmit()}{tcpFastRetransmit()}}
{\footnotesize\ttfamily void tcp\+Fast\+Retransmit (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket }\end{DoxyParamCaption})}



Fast retransmit procedure. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the current socket \\
\hline
\end{DoxyParams}


Definition at line 937 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
938 \{
939 \textcolor{preprocessor}{#if (TCP\_CONGEST\_CONTROL\_SUPPORT == ENABLED)}
940    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} flightSize;
941 
942    \textcolor{comment}{//Amount of data that has been sent but not yet acknowledged}
943    flightSize = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna;
944    \textcolor{comment}{//After receiving 3 duplicate ACKs, ssthresh must be adjusted}
945    \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->ssthresh = \hyperlink{os__port_8h_afa99ec4acc4ecb2dc3c2d05da15d0e3f}{MAX}(flightSize / 2, 2 * \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss);
946 
947    \textcolor{comment}{//The value of recover is incremented to the value of the highest}
948    \textcolor{comment}{//sequence number transmitted by the TCP so far}
949    \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->recover = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt - 1;
950 
951    \textcolor{comment}{//Debug message}
952    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"TCP fast retransmit...\(\backslash\)r\(\backslash\)n"});
953 
954    \textcolor{comment}{//TCP performs a retransmission of what appears to be the missing segment,}
955    \textcolor{comment}{//without waiting for the retransmission timer to expire}
956    \hyperlink{tcp__misc_8c_aee22faafb5104e4cc56a505621050616}{tcpRetransmitSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
957 
958    \textcolor{comment}{//cwnd must set to ssthresh plus 3*SMSS. This artificially inflates the}
959    \textcolor{comment}{//congestion window by the number of segments (three) that have left the}
960    \textcolor{comment}{//network and which the receiver has buffered}
961    \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->ssthresh + \hyperlink{tcp_8h_a71e45bd21d93e12c4720cce4c2a890fe}{TCP\_FAST\_RETRANSMIT\_THRES} * 
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss;
962 
963    \textcolor{comment}{//Enter the fast recovery procedure}
964    \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->congestState = \hyperlink{tcp_8h_ac69e0e40557f11fc979456965cdcd2f1a8a8b065a15d7f4d16740a5745ff49fb2}{TCP\_CONGEST\_STATE\_RECOVERY};
965 \textcolor{preprocessor}{#endif}
966 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a50404ff6be52744d5720b41d6ea544bf}\label{tcp__misc_8c_a50404ff6be52744d5720b41d6ea544bf}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Flush\+Retransmit\+Queue@{tcp\+Flush\+Retransmit\+Queue}}
\index{tcp\+Flush\+Retransmit\+Queue@{tcp\+Flush\+Retransmit\+Queue}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Flush\+Retransmit\+Queue()}{tcpFlushRetransmitQueue()}}
{\footnotesize\ttfamily void tcp\+Flush\+Retransmit\+Queue (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket }\end{DoxyParamCaption})}



Flush retransmission queue. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\end{DoxyParams}


Definition at line 1227 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1228 \{
1229    \textcolor{comment}{//Point to the first item in the retransmission queue}
1230    \hyperlink{struct__TcpQueueItem}{TcpQueueItem} *queueItem = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitQueue;
1231 
1232    \textcolor{comment}{//Loop through retransmission queue}
1233    \textcolor{keywordflow}{while}(queueItem != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1234    \{
1235       \textcolor{comment}{//Keep track of the next item in the queue}
1236       \hyperlink{struct__TcpQueueItem}{TcpQueueItem} *nextQueueItem = queueItem->\hyperlink{struct__TcpQueueItem_a5e46d57271b1dcbf0a5d647ca67f2a86}{next};
1237       \textcolor{comment}{//Free previously allocated memory}
1238       \hyperlink{net__mem_8c_a5e8a514f3dfcb35008de9beb39bcdcde}{memPoolFree}(queueItem);
1239       \textcolor{comment}{//Point to the next item}
1240       queueItem = nextQueueItem;
1241    \}
1242 
1243    \textcolor{comment}{//The retransmission queue is now flushed}
1244    \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitQueue = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1245 
1246    \textcolor{comment}{//Turn off the retransmission timer}
1247    \hyperlink{tcp__timer_8c_a3064f1c41511310223cdbaae4ab75674}{tcpTimerStop}(&\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitTimer);
1248 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_ae6760551554cbe2e5f003565dbe8ab79}\label{tcp__misc_8c_ae6760551554cbe2e5f003565dbe8ab79}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Flush\+Syn\+Queue@{tcp\+Flush\+Syn\+Queue}}
\index{tcp\+Flush\+Syn\+Queue@{tcp\+Flush\+Syn\+Queue}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Flush\+Syn\+Queue()}{tcpFlushSynQueue()}}
{\footnotesize\ttfamily void tcp\+Flush\+Syn\+Queue (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket }\end{DoxyParamCaption})}



Flush S\+YN queue. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\end{DoxyParams}


Definition at line 1256 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1257 \{
1258    \textcolor{comment}{//Point to the first item in the SYN queue}
1259    \hyperlink{struct__TcpSynQueueItem}{TcpSynQueueItem} *queueItem = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->synQueue;
1260 
1261    \textcolor{comment}{//Loop through SYN queue}
1262    \textcolor{keywordflow}{while}(queueItem != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1263    \{
1264       \textcolor{comment}{//Keep track of the next item in the queue}
1265       \hyperlink{struct__TcpSynQueueItem}{TcpSynQueueItem} *nextQueueItem = queueItem->\hyperlink{struct__TcpSynQueueItem_aec234d81bcfbfba730e21c3affa37848}{next};
1266       \textcolor{comment}{//Free previously allocated memory}
1267       \hyperlink{net__mem_8c_a5e8a514f3dfcb35008de9beb39bcdcde}{memPoolFree}(queueItem);
1268       \textcolor{comment}{//Point to the next item}
1269       queueItem = nextQueueItem;
1270    \}
1271 
1272    \textcolor{comment}{//SYN queue was successfully flushed}
1273    \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->synQueue = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1274 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_aaf3149cdcf1570bfcfcec9c637f34e3b}\label{tcp__misc_8c_aaf3149cdcf1570bfcfcec9c637f34e3b}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Get\+Option@{tcp\+Get\+Option}}
\index{tcp\+Get\+Option@{tcp\+Get\+Option}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Get\+Option()}{tcpGetOption()}}
{\footnotesize\ttfamily \hyperlink{tcp_8h_a5562fc6b2b8e28e99a3c0d1c36054b72}{Tcp\+Option}$\ast$ tcp\+Get\+Option (\begin{DoxyParamCaption}\item[{\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{kind }\end{DoxyParamCaption})}



Find a specified option in a T\+CP segment. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em segment} & Pointer to the T\+CP header \\
\hline
\mbox{\tt in}  & {\em kind} & Code of the option to find \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
If the specified option is found, a pointer to the corresponding option is returned. Otherwise N\+U\+LL pointer is returned 
\end{DoxyReturn}


Definition at line 469 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
470 \{
471    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
472    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
473    \hyperlink{tcp_8h_a5562fc6b2b8e28e99a3c0d1c36054b72}{TcpOption} *option;
474 
475    \textcolor{comment}{//Make sure the TCP header is valid}
476    \textcolor{keywordflow}{if}(segment->dataOffset < 5)
477       \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
478 
479    \textcolor{comment}{//Compute the length of the options field}
480    length = segment->dataOffset * 4 - \textcolor{keyword}{sizeof}(\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader});
481 
482    \textcolor{comment}{//Point to the very first option}
483    i = 0;
484 
485    \textcolor{comment}{//Parse TCP options}
486    \textcolor{keywordflow}{while}(i < length)
487    \{
488       \textcolor{comment}{//Point to the current option}
489       option = (\hyperlink{tcp_8h_a5562fc6b2b8e28e99a3c0d1c36054b72}{TcpOption} *) (segment->options + i);
490 
491       \textcolor{comment}{//NOP option detected?}
492       \textcolor{keywordflow}{if}(option->kind == \hyperlink{tcp_8h_a064186fb289be38d3e1a71ecf446fe8cae9a7564649350c5c35115c0284fe79ba}{TCP\_OPTION\_NOP})
493       \{
494          i++;
495          \textcolor{keywordflow}{continue};
496       \}
497       \textcolor{comment}{//END option detected?}
498       \textcolor{keywordflow}{if}(option->kind == \hyperlink{tcp_8h_a064186fb289be38d3e1a71ecf446fe8caf07244108eff002a75f229d8f61da372}{TCP\_OPTION\_END})
499          \textcolor{keywordflow}{break};
500       \textcolor{comment}{//Check option length}
501       \textcolor{keywordflow}{if}((i + 1) >= length || (i + option->length) > length)
502          \textcolor{keywordflow}{break};
503 
504       \textcolor{comment}{//Current option kind match the specified one?}
505       \textcolor{keywordflow}{if}(option->kind == \hyperlink{tcp_8h_a9aca84b04dfc09a4eeae08b3b3266eb6}{kind})
506          \textcolor{keywordflow}{return} option;
507 
508       \textcolor{comment}{//Jump to next the next option}
509       i += option->length;
510    \}
511 
512    \textcolor{comment}{//Specified option code not found}
513    \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
514 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a7bdb0899eb2dfc03a134c5ba789984ae}\label{tcp__misc_8c_a7bdb0899eb2dfc03a134c5ba789984ae}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Is\+Duplicate\+Ack@{tcp\+Is\+Duplicate\+Ack}}
\index{tcp\+Is\+Duplicate\+Ack@{tcp\+Is\+Duplicate\+Ack}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Is\+Duplicate\+Ack()}{tcpIsDuplicateAck()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} tcp\+Is\+Duplicate\+Ack (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Test whether the incoming acknowledgment is a duplicate. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the current socket \\
\hline
\mbox{\tt in}  & {\em segment} & Pointer to the T\+CP segment to check \\
\hline
\mbox{\tt in}  & {\em length} & Length of the segment data \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
T\+R\+UE if the A\+CK is duplicate, else F\+A\+L\+SE 
\end{DoxyReturn}


Definition at line 895 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
896 \{
897    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} flag;
898 
899    \textcolor{comment}{//An ACK is considered a duplicate when the following conditions are met}
900    flag = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
901 
902    \textcolor{comment}{//The receiver of the ACK has outstanding data}
903    \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitQueue != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
904    \{
905       \textcolor{comment}{//The incoming acknowledgment carries no data}
906       \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} == 0)
907       \{
908          \textcolor{comment}{//the SYN and FIN bits are both off}
909          \textcolor{keywordflow}{if}(!(segment->flags & (\hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7af2f8a42ff8bff07cbca1cd2ed6df9fae}{TCP\_FLAG\_SYN} | \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a332cfb33224b794e0be773cba056efa1}{TCP\_FLAG\_FIN})))
910          \{
911             \textcolor{comment}{//The acknowledgment number is equal to the greatest acknowledgment}
912             \textcolor{comment}{//received on the given connection}
913             \textcolor{keywordflow}{if}(segment->ackNum == \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna)
914             \{
915                \textcolor{comment}{//The advertised window in the incoming acknowledgment equals}
916                \textcolor{comment}{//the advertised window in the last incoming acknowledgment}
917                \textcolor{keywordflow}{if}(segment->window == \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWnd)
918                \{
919                   \textcolor{comment}{//Duplicate ACK}
920                   flag = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
921                \}
922             \}
923          \}
924       \}
925    \}
926 
927    \textcolor{comment}{//Return TRUE if the acknowledgment is a duplicate}
928    \textcolor{keywordflow}{return} flag;
929 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_ac969fab95bfe0fe6d70d06c57e217640}\label{tcp__misc_8c_ac969fab95bfe0fe6d70d06c57e217640}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Is\+Duplicate\+Syn@{tcp\+Is\+Duplicate\+Syn}}
\index{tcp\+Is\+Duplicate\+Syn@{tcp\+Is\+Duplicate\+Syn}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Is\+Duplicate\+Syn()}{tcpIsDuplicateSyn()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} tcp\+Is\+Duplicate\+Syn (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{structIpPseudoHeader}{Ip\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment }\end{DoxyParamCaption})}



Test whether the incoming S\+YN segment is a duplicate. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the current socket \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & T\+CP pseudo header \\
\hline
\mbox{\tt in}  & {\em segment} & Pointer to the T\+CP segment to check \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
T\+R\+UE if the S\+YN segment is duplicate, else F\+A\+L\+SE 
\end{DoxyReturn}


Definition at line 819 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
821 \{
822    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} flag;
823    \hyperlink{struct__TcpSynQueueItem}{TcpSynQueueItem} *queueItem;
824 
825    \textcolor{comment}{//Initialize flag}
826    flag = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
827 
828    \textcolor{comment}{//Point to the very first item}
829    queueItem = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->synQueue;
830 
831    \textcolor{comment}{//Loop through the SYN queue}
832    \textcolor{keywordflow}{while}(queueItem != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
833    \{
834 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
835       \textcolor{comment}{//IPv4 packet received?}
836       \textcolor{keywordflow}{if}(queueItem->\hyperlink{struct__TcpSynQueueItem_a6a25919b9ea8c17c7e85fcacfa52f6a1}{srcAddr}.\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} == \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr}) &&
837          queueItem->\hyperlink{struct__TcpSynQueueItem_a6187af43e120966851c614da06753e2c}{destAddr}.\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} == \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr}) &&
838          pseudoHeader->\hyperlink{structIpPseudoHeader_aeff06b8d9c3e7e2ef3cdb8a3a14e8ad2}{length} == \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a0e92b64e038199f1bb6383f2a76f30b6}{Ipv4PseudoHeader}))
839       \{
840          \textcolor{comment}{//Check source and destination addresses}
841          \textcolor{keywordflow}{if}(queueItem->\hyperlink{struct__TcpSynQueueItem_a6a25919b9ea8c17c7e85fcacfa52f6a1}{srcAddr}.\hyperlink{structIpAddr_a8de6f49cb0461f57c1eda49bb1088916}{ipv4Addr} == pseudoHeader->\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.srcAddr &&
842             queueItem->\hyperlink{struct__TcpSynQueueItem_a6187af43e120966851c614da06753e2c}{destAddr}.\hyperlink{structIpAddr_a8de6f49cb0461f57c1eda49bb1088916}{ipv4Addr} == pseudoHeader->
      \hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.destAddr)
843          \{
844             \textcolor{comment}{//Check source port}
845             \textcolor{keywordflow}{if}(queueItem->\hyperlink{struct__TcpSynQueueItem_ab6f9b3ec9b271f14661b6c6d18fb3066}{srcPort} == segment->srcPort)
846             \{
847                \textcolor{comment}{//Duplicate SYN}
848                flag = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
849             \}
850          \}
851       \}
852       \textcolor{keywordflow}{else}
853 \textcolor{preprocessor}{#endif}
854 \textcolor{preprocessor}{#if (IPV6\_SUPPORT == ENABLED)}
855       \textcolor{comment}{//IPv6 packet received?}
856       \textcolor{keywordflow}{if}(queueItem->\hyperlink{struct__TcpSynQueueItem_a6a25919b9ea8c17c7e85fcacfa52f6a1}{srcAddr}.\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} == \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6Addr}) &&
857          queueItem->\hyperlink{struct__TcpSynQueueItem_a6187af43e120966851c614da06753e2c}{destAddr}.\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} == \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6Addr}) &&
858          pseudoHeader->\hyperlink{structIpPseudoHeader_aeff06b8d9c3e7e2ef3cdb8a3a14e8ad2}{length} == \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader}))
859       \{
860          \textcolor{comment}{//Check source and destination addresses}
861          \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(&queueItem->\hyperlink{struct__TcpSynQueueItem_a6a25919b9ea8c17c7e85fcacfa52f6a1}{srcAddr}.\hyperlink{structIpAddr_a9bc2340a9c0bc5a0b8aa9695b74e2ee6}{ipv6Addr}, &pseudoHeader->
      \hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.srcAddr) &&
862             \hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(&queueItem->\hyperlink{struct__TcpSynQueueItem_a6187af43e120966851c614da06753e2c}{destAddr}.\hyperlink{structIpAddr_a9bc2340a9c0bc5a0b8aa9695b74e2ee6}{ipv6Addr}, &pseudoHeader->
      \hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.destAddr))
863          \{
864             \textcolor{comment}{//Check source port}
865             \textcolor{keywordflow}{if}(queueItem->\hyperlink{struct__TcpSynQueueItem_ab6f9b3ec9b271f14661b6c6d18fb3066}{srcPort} == segment->srcPort)
866             \{
867                \textcolor{comment}{//Duplicate SYN}
868                flag = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
869             \}
870          \}
871       \}
872       \textcolor{keywordflow}{else}
873 \textcolor{preprocessor}{#endif}
874       \{
875          \textcolor{comment}{//Just for sanity}
876       \}
877 
878       \textcolor{comment}{//Next item}
879       queueItem = queueItem->\hyperlink{struct__TcpSynQueueItem_aec234d81bcfbfba730e21c3affa37848}{next};
880    \}
881 
882    \textcolor{comment}{//Return TRUE if the SYN segment is a duplicate}
883    \textcolor{keywordflow}{return} flag;
884 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_ab354828c280bda2e01554f5ea827d752}\label{tcp__misc_8c_ab354828c280bda2e01554f5ea827d752}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Nagle\+Algo@{tcp\+Nagle\+Algo}}
\index{tcp\+Nagle\+Algo@{tcp\+Nagle\+Algo}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Nagle\+Algo()}{tcpNagleAlgo()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tcp\+Nagle\+Algo (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{flags }\end{DoxyParamCaption})}



Nagle algorithm implementation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\mbox{\tt in}  & {\em flags} & Set of flags that influences the behavior of this function \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1596 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1597 \{
1598    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1599    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1600    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} u;
1601 
1602    \textcolor{comment}{//The amount of data that can be sent at any given time is}
1603    \textcolor{comment}{//limited by the receiver window and the congestion window}
1604    n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWnd, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize);
1605 
1606 \textcolor{preprocessor}{#if (TCP\_CONGEST\_CONTROL\_SUPPORT == ENABLED)}
1607    \textcolor{comment}{//Check the congestion window}
1608    n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(n, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->cwnd);
1609 \textcolor{preprocessor}{#endif}
1610 
1611    \textcolor{comment}{//Retrieve the size of the usable window}
1612    u = n - (\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna);
1613 
1614    \textcolor{comment}{//The Nagle algorithm discourages sending tiny segments when}
1615    \textcolor{comment}{//the data to be sent increases in small increments}
1616    \textcolor{keywordflow}{while}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUser > 0)
1617    \{
1618       \textcolor{comment}{//The usable window size may become zero or negative,}
1619       \textcolor{comment}{//preventing packet transmission}
1620       \textcolor{keywordflow}{if}((\hyperlink{compiler__port_8h_a022c65af7f6c8d3947e8a37d64db6ad6}{int\_t}) u <= 0)
1621          \textcolor{keywordflow}{break};
1622 
1623       \textcolor{comment}{//Calculate the number of bytes to send at a time}
1624       n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(u, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUser);
1625       n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(n, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss);
1626 
1627       \textcolor{comment}{//Disable Nagle algorithm?}
1628       \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags} & \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a2a3399f24cd678390ebf586c4ffefc8c}{SOCKET\_FLAG\_NO\_DELAY})
1629       \{
1630          \textcolor{comment}{//All packets will be send no matter what size they have}
1631          \textcolor{keywordflow}{if}(n > 0)
1632          \{
1633             \textcolor{comment}{//Send TCP segment}
1634             error = \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcpSendSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a44a138e095774788c0f16e906d5a4c25}{TCP\_FLAG\_PSH} | 
      \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK},
1635                \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt, n, \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
1636             \textcolor{comment}{//Failed to send TCP segment?}
1637             \textcolor{keywordflow}{if}(error)
1638                \textcolor{keywordflow}{return} error;
1639          \}
1640          \textcolor{keywordflow}{else}
1641          \{
1642             \textcolor{comment}{//We are done...}
1643             \textcolor{keywordflow}{break};
1644          \}
1645       \}
1646       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags} & \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16afefe15f8a60383ccfa6f48b8e5b54c76}{SOCKET\_FLAG\_DELAY})
1647       \{
1648          \textcolor{comment}{//Transmit data if a maximum-sized segment can be sent}
1649          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUser, u) >= \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss)
1650          \{
1651             \textcolor{comment}{//Send TCP segment}
1652             error = \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcpSendSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a44a138e095774788c0f16e906d5a4c25}{TCP\_FLAG\_PSH} | 
      \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK},
1653                \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt, n, \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
1654             \textcolor{comment}{//Failed to send TCP segment?}
1655             \textcolor{keywordflow}{if}(error)
1656                \textcolor{keywordflow}{return} error;
1657          \}
1658          \textcolor{keywordflow}{else}
1659          \{
1660             \textcolor{comment}{//Prevent the sender from sending tiny segments...}
1661             \textcolor{keywordflow}{break};
1662          \}
1663       \}
1664       \textcolor{keywordflow}{else}
1665       \{
1666          \textcolor{comment}{//Transmit data if a maximum-sized segment can be sent}
1667          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUser, u) >= \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss)
1668          \{
1669             \textcolor{comment}{//Send TCP segment}
1670             error = \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcpSendSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a44a138e095774788c0f16e906d5a4c25}{TCP\_FLAG\_PSH} | 
      \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK},
1671                \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt, n, \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
1672             \textcolor{comment}{//Failed to send TCP segment?}
1673             \textcolor{keywordflow}{if}(error)
1674                \textcolor{keywordflow}{return} error;
1675          \}
1676          \textcolor{comment}{//Or if all queued data can be sent now}
1677          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt == \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna && \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUser <= u)
1678          \{
1679             \textcolor{comment}{//Send TCP segment}
1680             error = \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcpSendSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a44a138e095774788c0f16e906d5a4c25}{TCP\_FLAG\_PSH} | 
      \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK},
1681                \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt, n, \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
1682             \textcolor{comment}{//Failed to send TCP segment?}
1683             \textcolor{keywordflow}{if}(error)
1684                \textcolor{keywordflow}{return} error;
1685          \}
1686          \textcolor{comment}{//Or if at least a fraction of the maximum window can be sent}
1687          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUser, u) >= (\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->maxSndWnd / 2))
1688          \{
1689             \textcolor{comment}{//Send TCP segment}
1690             error = \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcpSendSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a44a138e095774788c0f16e906d5a4c25}{TCP\_FLAG\_PSH} | 
      \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK},
1691                \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt, n, \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
1692             \textcolor{comment}{//Failed to send TCP segment?}
1693             \textcolor{keywordflow}{if}(error)
1694                \textcolor{keywordflow}{return} error;
1695          \}
1696          \textcolor{keywordflow}{else}
1697          \{
1698             \textcolor{comment}{//Prevent the sender from sending tiny segments...}
1699             \textcolor{keywordflow}{break};
1700          \}
1701       \}
1702 
1703       \textcolor{comment}{//Advance SND.NXT pointer}
1704       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1705       \textcolor{comment}{//Update the number of data buffered but not yet sent}
1706       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUser -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1707       \textcolor{comment}{//Update the size of the usable window}
1708       u -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1709    \}
1710 
1711    \textcolor{comment}{//Check whether the transmitter can accept more data}
1712    \hyperlink{tcp__misc_8c_a1d69d8ed2662a74417c757291f540077}{tcpUpdateEvents}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
1713 
1714    \textcolor{comment}{//No error to report}
1715    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1716 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_ac10b3d33d536daffca5246fc1374ba1f}\label{tcp__misc_8c_ac10b3d33d536daffca5246fc1374ba1f}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Process\+Segment\+Data@{tcp\+Process\+Segment\+Data}}
\index{tcp\+Process\+Segment\+Data@{tcp\+Process\+Segment\+Data}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Process\+Segment\+Data()}{tcpProcessSegmentData()}}
{\footnotesize\ttfamily void tcp\+Process\+Segment\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process the segment text. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the current socket \\
\hline
\mbox{\tt in}  & {\em segment} & Pointer to the T\+CP header \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the incoming T\+CP segment \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first data byte \\
\hline
\mbox{\tt in}  & {\em length} & Length of the segment data \\
\hline
\end{DoxyParams}


Definition at line 1063 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1065 \{
1066    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} leftEdge;
1067    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} rightEdge;
1068 
1069    \textcolor{comment}{//First sequence number occupied by the incoming segment}
1070    leftEdge = segment->seqNum;
1071    \textcolor{comment}{//Sequence number immediately following the incoming segment}
1072    rightEdge = segment->seqNum + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1073 
1074    \textcolor{comment}{//Check whether some data falls outside the receive window}
1075    \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(leftEdge, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt) < 0)
1076    \{
1077       \textcolor{comment}{//Position of the first byte to be read}
1078       \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset} += \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt - leftEdge;
1079       \textcolor{comment}{//Ignore the data that falls outside the receive window}
1080       leftEdge = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt;
1081    \}
1082    \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(rightEdge, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt + \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd) > 0)
1083    \{
1084       \textcolor{comment}{//Ignore the data that falls outside the receive window}
1085       rightEdge = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt + \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd;
1086    \}
1087 
1088    \textcolor{comment}{//Copy the incoming data to the receive buffer}
1089    \hyperlink{tcp__misc_8c_a9a639edc348cbd2e86a240177099120a}{tcpWriteRxBuffer}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, leftEdge, buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset}, rightEdge - leftEdge);
1090 
1091    \textcolor{comment}{//Update the list of non-contiguous blocks of data that}
1092    \textcolor{comment}{//have been received and queued}
1093    \hyperlink{tcp__misc_8c_aa129fd8807bfc2d84d45974b6e21d304}{tcpUpdateSackBlocks}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, &leftEdge, &rightEdge);
1094 
1095    \textcolor{comment}{//Check whether the segment was received out of order}
1096    \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(leftEdge, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt) > 0)
1097    \{
1098       \textcolor{comment}{//Out of order data segments should be acknowledged immediately, in}
1099       \textcolor{comment}{//order to accelerate loss recovery}
1100       \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcpSendSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK}, 
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt, 0,
1101          \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
1102    \}
1103    \textcolor{keywordflow}{else}
1104    \{
1105       \textcolor{comment}{//Number of contiguous bytes that have been received}
1106       \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = rightEdge - leftEdge;
1107 
1108       \textcolor{comment}{//Next sequence number expected on incoming segments}
1109       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt += \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1110       \textcolor{comment}{//Number of data available in the receive buffer}
1111       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvUser += \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1112       \textcolor{comment}{//Update the receive window}
1113       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd -= \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1114 
1115       \textcolor{comment}{//Acknowledge the received data (delayed ACK not supported)}
1116       \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcpSendSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK}, 
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt, 0,
1117          \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
1118 
1119       \textcolor{comment}{//Notify user task that data is available}
1120       \hyperlink{tcp__misc_8c_a1d69d8ed2662a74417c757291f540077}{tcpUpdateEvents}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
1121    \}
1122 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_aa97c7d519e5e230fcdd62de48d790776}\label{tcp__misc_8c_aa97c7d519e5e230fcdd62de48d790776}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Read\+Rx\+Buffer@{tcp\+Read\+Rx\+Buffer}}
\index{tcp\+Read\+Rx\+Buffer@{tcp\+Read\+Rx\+Buffer}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Read\+Rx\+Buffer()}{tcpReadRxBuffer()}}
{\footnotesize\ttfamily void tcp\+Read\+Rx\+Buffer (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t}}]{seq\+Num,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Copy data from the receive buffer. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\mbox{\tt in}  & {\em seq\+Num} & Sequence number of the first data to read \\
\hline
\mbox{\tt out}  & {\em data} & Pointer to the output buffer \\
\hline
\mbox{\tt in}  & {\em length} & Number of data to read \\
\hline
\end{DoxyParams}


Definition at line 2034 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
2036 \{
2037    \textcolor{comment}{//Offset of the first byte to read in the circular buffer}
2038    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset} = (\hyperlink{dtls__misc_8h_a334ea08fc328b399d92541b8795beed5}{seqNum} - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->irs - 1) % \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize;
2039 
2040    \textcolor{comment}{//Check whether the specified data crosses buffer boundaries}
2041    \textcolor{keywordflow}{if}((offset + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}) <= \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize)
2042    \{
2043       \textcolor{comment}{//Copy the payload}
2044       \hyperlink{net__mem_8c_af3ed1bc3f7d55f830cbbe6aa12e61af0}{netBufferRead}(\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, (\hyperlink{structNetBuffer}{NetBuffer} *) &\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBuffer,
2045          offset, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
2046    \}
2047    \textcolor{keywordflow}{else}
2048    \{
2049       \textcolor{comment}{//Copy the first part of the payload}
2050       \hyperlink{net__mem_8c_af3ed1bc3f7d55f830cbbe6aa12e61af0}{netBufferRead}(\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, (\hyperlink{structNetBuffer}{NetBuffer} *) &\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBuffer,
2051          offset, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize - offset);
2052       \textcolor{comment}{//Wrap around to the beginning of the circular buffer}
2053       \hyperlink{net__mem_8c_af3ed1bc3f7d55f830cbbe6aa12e61af0}{netBufferRead}(\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} + \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize - offset, (
      \hyperlink{structNetBuffer}{NetBuffer} *) &\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBuffer,
2054          0, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize + offset);
2055    \}
2056 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_ad88122545f2bfada890011b9057701ed}\label{tcp__misc_8c_ad88122545f2bfada890011b9057701ed}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Read\+Tx\+Buffer@{tcp\+Read\+Tx\+Buffer}}
\index{tcp\+Read\+Tx\+Buffer@{tcp\+Read\+Tx\+Buffer}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Read\+Tx\+Buffer()}{tcpReadTxBuffer()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tcp\+Read\+Tx\+Buffer (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t}}]{seq\+Num,  }\item[{\hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Copy data from the send buffer. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\mbox{\tt in}  & {\em seq\+Num} & Sequence number of the first data to read \\
\hline
\mbox{\tt out}  & {\em buffer} & Pointer to the output buffer \\
\hline
\mbox{\tt in}  & {\em length} & Number of data to read \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1957 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1959 \{
1960    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1961 
1962    \textcolor{comment}{//Offset of the first byte to read in the circular buffer}
1963    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset} = (\hyperlink{dtls__misc_8h_a334ea08fc328b399d92541b8795beed5}{seqNum} - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->iss - 1) % \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize;
1964 
1965    \textcolor{comment}{//Check whether the specified data crosses buffer boundaries}
1966    \textcolor{keywordflow}{if}((offset + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}) <= \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize)
1967    \{
1968       \textcolor{comment}{//Copy the payload}
1969       error = \hyperlink{net__mem_8c_aba4fe2d850142e40a9a668afeb2a0c8a}{netBufferConcat}(buffer, (\hyperlink{structNetBuffer}{NetBuffer} *) &
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBuffer,
1970          offset, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
1971    \}
1972    \textcolor{keywordflow}{else}
1973    \{
1974       \textcolor{comment}{//Copy the first part of the payload}
1975       error = \hyperlink{net__mem_8c_aba4fe2d850142e40a9a668afeb2a0c8a}{netBufferConcat}(buffer, (\hyperlink{structNetBuffer}{NetBuffer} *) &
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBuffer,
1976          offset, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize - offset);
1977 
1978       \textcolor{comment}{//Check status code}
1979       \textcolor{keywordflow}{if}(!error)
1980       \{
1981          \textcolor{comment}{//Wrap around to the beginning of the circular buffer}
1982          error = \hyperlink{net__mem_8c_aba4fe2d850142e40a9a668afeb2a0c8a}{netBufferConcat}(buffer, (\hyperlink{structNetBuffer}{NetBuffer} *) &
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBuffer,
1983             0, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize + offset);
1984       \}
1985    \}
1986 
1987    \textcolor{comment}{//Return status code}
1988    \textcolor{keywordflow}{return} error;
1989 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_aee22faafb5104e4cc56a505621050616}\label{tcp__misc_8c_aee22faafb5104e4cc56a505621050616}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Retransmit\+Segment@{tcp\+Retransmit\+Segment}}
\index{tcp\+Retransmit\+Segment@{tcp\+Retransmit\+Segment}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Retransmit\+Segment()}{tcpRetransmitSegment()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tcp\+Retransmit\+Segment (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket }\end{DoxyParamCaption})}



T\+CP segment retransmission. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1493 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1494 \{
1495    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1496    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
1497    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1498    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
1499    \hyperlink{struct__TcpQueueItem}{TcpQueueItem} *queueItem;
1500    \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader} *header;
1501 
1502    \textcolor{comment}{//Initialize error code}
1503    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1504    \textcolor{comment}{//Total number of bytes that have been retransmitted}
1505    length = 0;
1506 
1507    \textcolor{comment}{//Point to the retransmission queue}
1508    queueItem = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitQueue;
1509 
1510    \textcolor{comment}{//Any segment in the retransmission queue?}
1511    \textcolor{keywordflow}{while}(queueItem != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1512    \{
1513       \textcolor{comment}{//Total number of bytes that have been retransmitted}
1514       length += queueItem->\hyperlink{struct__TcpQueueItem_a3c42cb4d2046a392570ab6f8dfa7a398}{length};
1515 
1516       \textcolor{comment}{//The amount of data that can be sent cannot exceed the MSS}
1517       \textcolor{keywordflow}{if}(length > \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->smss)
1518       \{
1519          \textcolor{comment}{//We are done}
1520          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1521          \textcolor{comment}{//Exit immediately}
1522          \textcolor{keywordflow}{break};
1523       \}
1524 
1525       \textcolor{comment}{//Point to the TCP header}
1526       header = (\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader} *) queueItem->\hyperlink{struct__TcpQueueItem_a61325506bbe534b89f9308b7a1374d08}{header};
1527 
1528       \textcolor{comment}{//Allocate a memory buffer to hold the TCP segment}
1529       buffer = \hyperlink{ip_8c_a2222fb64b1b18140283119eea309c1b3}{ipAllocBuffer}(0, &offset);
1530       \textcolor{comment}{//Failed to allocate memory?}
1531       \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1532       \{
1533          \textcolor{comment}{//Report an error}
1534          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
1535          \textcolor{comment}{//Exit immediately}
1536          \textcolor{keywordflow}{break};
1537       \}
1538 
1539       \textcolor{comment}{//Start of exception handling block}
1540       \textcolor{keywordflow}{do}
1541       \{
1542          \textcolor{comment}{//Copy TCP header}
1543          error = \hyperlink{net__mem_8c_aceae1188a93321e1d4daed11bb8005df}{netBufferAppend}(buffer, header, header->dataOffset * 4);
1544          \textcolor{comment}{//Any error to report?}
1545          \textcolor{keywordflow}{if}(error)
1546             \textcolor{keywordflow}{break};
1547 
1548          \textcolor{comment}{//Copy data from send buffer}
1549          error = \hyperlink{tcp__misc_8c_ad88122545f2bfada890011b9057701ed}{tcpReadTxBuffer}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(header->seqNum), buffer,
1550             queueItem->\hyperlink{struct__TcpQueueItem_a3c42cb4d2046a392570ab6f8dfa7a398}{length});
1551          \textcolor{comment}{//Any error to report?}
1552          \textcolor{keywordflow}{if}(error)
1553             \textcolor{keywordflow}{break};
1554 
1555          \textcolor{comment}{//Total number of segments retransmitted}
1556          \hyperlink{mib2__module_8h_abac73a39224e47d597f3b461620d2119}{MIB2\_INC\_COUNTER32}(tcpGroup.tcpRetransSegs, 1);
1557          \hyperlink{tcp__mib__module_8h_a296ad60b53152af0749116138a8ae227}{TCP\_MIB\_INC\_COUNTER32}(tcpRetransSegs, 1);
1558 
1559          \textcolor{comment}{//Dump TCP header contents for debugging purpose}
1560          \hyperlink{tcp__misc_8c_a73fae08a3e43bdbf6a01ab32d8802949}{tcpDumpHeader}(header, queueItem->\hyperlink{struct__TcpQueueItem_a3c42cb4d2046a392570ab6f8dfa7a398}{length}, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->iss, 
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->irs);
1561 
1562          \textcolor{comment}{//Retransmit the lost segment without waiting for the retransmission}
1563          \textcolor{comment}{//timer to expire}
1564          error = \hyperlink{ip_8c_ac39710faa96e88364ef7007fee711c5e}{ipSendDatagram}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->interface, &queueItem->
      \hyperlink{struct__TcpQueueItem_a2ddf7abb88b02f243eae7461ced90ef0}{pseudoHeader},
1565             buffer, offset, 0);
1566 
1567          \textcolor{comment}{//End of exception handling block}
1568       \} \textcolor{keywordflow}{while}(0);
1569 
1570       \textcolor{comment}{//Free previously allocated memory}
1571       \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
1572 
1573       \textcolor{comment}{//Any error to report?}
1574       \textcolor{keywordflow}{if}(error)
1575       \{
1576          \textcolor{comment}{//Exit immediately}
1577          \textcolor{keywordflow}{break};
1578       \}
1579 
1580       \textcolor{comment}{//Point to the next segment in the queue}
1581       queueItem = queueItem->\hyperlink{struct__TcpQueueItem_a5e46d57271b1dcbf0a5d647ca67f2a86}{next};
1582    \}
1583 
1584    \textcolor{comment}{//Return status code}
1585    \textcolor{keywordflow}{return} error;
1586 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a07b59bd89778b5fd8cd9c57dfd7f2866}\label{tcp__misc_8c_a07b59bd89778b5fd8cd9c57dfd7f2866}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Send\+Reset\+Segment@{tcp\+Send\+Reset\+Segment}}
\index{tcp\+Send\+Reset\+Segment@{tcp\+Send\+Reset\+Segment}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Send\+Reset\+Segment()}{tcpSendResetSegment()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tcp\+Send\+Reset\+Segment (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{structIpPseudoHeader}{Ip\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Send a T\+CP reset in response to an invalid segment. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & T\+CP pseudo header describing the incoming segment \\
\hline
\mbox{\tt in}  & {\em segment} & Incoming T\+CP segment \\
\hline
\mbox{\tt in}  & {\em length} & Length of the incoming segment data \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 285 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
287 \{
288    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
289    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
290    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags};
291    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} \hyperlink{dtls__misc_8h_a334ea08fc328b399d92541b8795beed5}{seqNum};
292    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} \hyperlink{tcp_8h_a077154909d67fa134c81b5a3c4ed57f4}{ackNum};
293    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
294    \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader} *segment2;
295    \hyperlink{structIpPseudoHeader}{IpPseudoHeader} pseudoHeader2;
296 
297    \textcolor{comment}{//Check whether the ACK bit is set}
298    \textcolor{keywordflow}{if}(segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK})
299    \{
300       \textcolor{comment}{//If the incoming segment has an ACK field, the reset takes}
301       \textcolor{comment}{//its sequence number from the ACK field of the segment}
302       flags = \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a2eaeb7e7c1984d0bd4d1cbb48b2b5ce4}{TCP\_FLAG\_RST};
303       seqNum = segment->ackNum;
304       ackNum = 0;
305    \}
306    \textcolor{keywordflow}{else}
307    \{
308       \textcolor{comment}{//Otherwise the reset has sequence number zero and the ACK field is set to}
309       \textcolor{comment}{//the sum of the sequence number and segment length of the incoming segment}
310       flags = \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a2eaeb7e7c1984d0bd4d1cbb48b2b5ce4}{TCP\_FLAG\_RST} | \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK};
311       seqNum = 0;
312       ackNum = segment->seqNum + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
313 
314       \textcolor{comment}{//Advance the acknowledgment number over the SYN or the FIN}
315       \textcolor{keywordflow}{if}(segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7af2f8a42ff8bff07cbca1cd2ed6df9fae}{TCP\_FLAG\_SYN})
316          ackNum++;
317       \textcolor{keywordflow}{if}(segment->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a332cfb33224b794e0be773cba056efa1}{TCP\_FLAG\_FIN})
318          ackNum++;
319    \}
320 
321    \textcolor{comment}{//Allocate a memory buffer to hold the reset segment}
322    buffer = \hyperlink{ip_8c_a2222fb64b1b18140283119eea309c1b3}{ipAllocBuffer}(\textcolor{keyword}{sizeof}(\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader}), &offset);
323    \textcolor{comment}{//Failed to allocate memory?}
324    \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
325       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
326 
327    \textcolor{comment}{//Point to the beginning of the TCP segment}
328    segment2 = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, offset);
329 
330    \textcolor{comment}{//Format TCP header}
331    segment2->srcPort = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(segment->destPort);
332    segment2->destPort = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(segment->srcPort);
333    segment2->seqNum = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(seqNum);
334    segment2->ackNum = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(ackNum);
335    segment2->reserved1 = 0;
336    segment2->dataOffset = 5;
337    segment2->flags = \hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags};
338    segment2->reserved2 = 0;
339    segment2->window = 0;
340    segment2->checksum = 0;
341    segment2->urgentPointer = 0;
342 
343 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
344    \textcolor{comment}{//Destination address is an IPv4 address?}
345    \textcolor{keywordflow}{if}(pseudoHeader->\hyperlink{structIpPseudoHeader_aeff06b8d9c3e7e2ef3cdb8a3a14e8ad2}{length} == \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a0e92b64e038199f1bb6383f2a76f30b6}{Ipv4PseudoHeader}))
346    \{
347       \textcolor{comment}{//Format IPv4 pseudo header}
348       pseudoHeader2.\hyperlink{structIpPseudoHeader_aeff06b8d9c3e7e2ef3cdb8a3a14e8ad2}{length} = \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a0e92b64e038199f1bb6383f2a76f30b6}{Ipv4PseudoHeader});
349       pseudoHeader2.\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.srcAddr = pseudoHeader->\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.destAddr;
350       pseudoHeader2.\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.destAddr = pseudoHeader->\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.srcAddr;
351       pseudoHeader2.\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.reserved = 0;
352       pseudoHeader2.\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.protocol = \hyperlink{ipv4_8h_a113cd13f7321e81a3f55491fa3b7db23afef0a32d4295a591764b3e73dcf0a96d}{IPV4\_PROTOCOL\_TCP};
353       pseudoHeader2.\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.length = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\textcolor{keyword}{sizeof}(\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader}));
354 
355       \textcolor{comment}{//Calculate TCP header checksum}
356       segment2->checksum = \hyperlink{ip_8c_a9ec0593d9dbb2adf3e67894c0349cef3}{ipCalcUpperLayerChecksumEx}(&pseudoHeader2.
      \hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data},
357          \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a0e92b64e038199f1bb6383f2a76f30b6}{Ipv4PseudoHeader}), buffer, offset, \textcolor{keyword}{sizeof}(
      \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader}));
358    \}
359    \textcolor{keywordflow}{else}
360 \textcolor{preprocessor}{#endif}
361 \textcolor{preprocessor}{#if (IPV6\_SUPPORT == ENABLED)}
362    \textcolor{comment}{//Destination address is an IPv6 address?}
363    \textcolor{keywordflow}{if}(pseudoHeader->\hyperlink{structIpPseudoHeader_aeff06b8d9c3e7e2ef3cdb8a3a14e8ad2}{length} == \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader}))
364    \{
365       \textcolor{comment}{//Format IPv6 pseudo header}
366       pseudoHeader2.\hyperlink{structIpPseudoHeader_aeff06b8d9c3e7e2ef3cdb8a3a14e8ad2}{length} = \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader});
367       pseudoHeader2.\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.srcAddr = pseudoHeader->\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.destAddr;
368       pseudoHeader2.\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.destAddr = pseudoHeader->\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.srcAddr;
369       pseudoHeader2.\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.length = \hyperlink{cpu__endian_8h_ac54311f25fef1611a699b949c7410f64}{HTONL}(\textcolor{keyword}{sizeof}(\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader}));
370       pseudoHeader2.\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.reserved = 0;
371       pseudoHeader2.\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.nextHeader = \hyperlink{ipv6_8h_a551bec2628dfcc3b67c0fff52e486fa5a7db3654cd07645b0b0f9c4844b88f27f}{IPV6\_TCP\_HEADER};
372 
373       \textcolor{comment}{//Calculate TCP header checksum}
374       segment2->checksum = \hyperlink{ip_8c_a9ec0593d9dbb2adf3e67894c0349cef3}{ipCalcUpperLayerChecksumEx}(&pseudoHeader2.
      \hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data},
375          \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader}), buffer, offset, \textcolor{keyword}{sizeof}(
      \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader}));
376    \}
377    \textcolor{keywordflow}{else}
378 \textcolor{preprocessor}{#endif}
379    \textcolor{comment}{//Destination address is not valid?}
380    \{
381       \textcolor{comment}{//Free previously allocated memory}
382       \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
383       \textcolor{comment}{//This should never occur...}
384       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
385    \}
386 
387    \textcolor{comment}{//Total number of segments sent}
388    \hyperlink{mib2__module_8h_abac73a39224e47d597f3b461620d2119}{MIB2\_INC\_COUNTER32}(tcpGroup.tcpOutSegs, 1);
389    \hyperlink{tcp__mib__module_8h_a296ad60b53152af0749116138a8ae227}{TCP\_MIB\_INC\_COUNTER32}(tcpOutSegs, 1);
390    \hyperlink{tcp__mib__module_8h_a253ad9db6b20e52ec432bb8c23ee309c}{TCP\_MIB\_INC\_COUNTER64}(tcpHCOutSegs, 1);
391 
392    \textcolor{comment}{//Number of TCP segments sent containing the RST flag}
393    \hyperlink{mib2__module_8h_abac73a39224e47d597f3b461620d2119}{MIB2\_INC\_COUNTER32}(tcpGroup.tcpOutRsts, 1);
394    \hyperlink{tcp__mib__module_8h_a296ad60b53152af0749116138a8ae227}{TCP\_MIB\_INC\_COUNTER32}(tcpOutRsts, 1);
395 
396    \textcolor{comment}{//Debug message}
397    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"%s: Sending TCP reset segment...\(\backslash\)r\(\backslash\)n"},
398       \hyperlink{date__time_8c_ae15b3e664208ca7e4d6983921865cd74}{formatSystemTime}(\hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}(), \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
399    \textcolor{comment}{//Dump TCP header contents for debugging purpose}
400    \hyperlink{tcp__misc_8c_a73fae08a3e43bdbf6a01ab32d8802949}{tcpDumpHeader}(segment2, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, 0, 0);
401 
402    \textcolor{comment}{//Send TCP segment}
403    error = \hyperlink{ip_8c_ac39710faa96e88364ef7007fee711c5e}{ipSendDatagram}(interface, &pseudoHeader2, buffer, offset, 0);
404 
405    \textcolor{comment}{//Free previously allocated memory}
406    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
407    \textcolor{comment}{//Return error code}
408    \textcolor{keywordflow}{return} error;
409 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}\label{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Send\+Segment@{tcp\+Send\+Segment}}
\index{tcp\+Send\+Segment@{tcp\+Send\+Segment}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Send\+Segment()}{tcpSendSegment()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tcp\+Send\+Segment (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{flags,  }\item[{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t}}]{seq\+Num,  }\item[{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t}}]{ack\+Num,  }\item[{size\+\_\+t}]{length,  }\item[{\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t}}]{add\+To\+Queue }\end{DoxyParamCaption})}



Send a T\+CP segment. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing a socket \\
\hline
\mbox{\tt in}  & {\em flags} & Value that contains bitwise OR of flags (see \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7}{Tcp\+Flags} enumeration) \\
\hline
\mbox{\tt in}  & {\em seq\+Num} & Sequence number \\
\hline
\mbox{\tt in}  & {\em ack\+Num} & Acknowledgment number \\
\hline
\mbox{\tt in}  & {\em length} & Length of the segment data \\
\hline
\mbox{\tt in}  & {\em add\+To\+Queue} & Add the segment to retransmission queue \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 65 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
67 \{
68    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
69    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
70    \textcolor{keywordtype}{size\_t} totalLength;
71    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
72    \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader} *segment;
73    \hyperlink{struct__TcpQueueItem}{TcpQueueItem} *queueItem;
74    \hyperlink{structIpPseudoHeader}{IpPseudoHeader} pseudoHeader;
75 
76    \textcolor{comment}{//Maximum segment size}
77    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} mss = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rmss);
78 
79    \textcolor{comment}{//Allocate a memory buffer to hold the TCP segment}
80    buffer = \hyperlink{ip_8c_a2222fb64b1b18140283119eea309c1b3}{ipAllocBuffer}(\hyperlink{tcp_8h_a296869e905bda7013716794027a5b07c}{TCP\_MAX\_HEADER\_LENGTH}, &offset);
81    \textcolor{comment}{//Failed to allocate memory?}
82    \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
83       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
84 
85    \textcolor{comment}{//Point to the beginning of the TCP segment}
86    segment = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, offset);
87 
88    \textcolor{comment}{//Format TCP header}
89    segment->srcPort = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->localPort);
90    segment->destPort = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->remotePort);
91    segment->seqNum = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(\hyperlink{dtls__misc_8h_a334ea08fc328b399d92541b8795beed5}{seqNum});
92    segment->ackNum = (\hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags} & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK}) ? \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(\hyperlink{tcp_8h_a077154909d67fa134c81b5a3c4ed57f4}{ackNum}) : 0;
93    segment->reserved1 = 0;
94    segment->dataOffset = 5;
95    segment->flags = \hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags};
96    segment->reserved2 = 0;
97    segment->window = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd);
98    segment->checksum = 0;
99    segment->urgentPointer = 0;
100 
101    \textcolor{comment}{//SYN flag set?}
102    \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags} & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7af2f8a42ff8bff07cbca1cd2ed6df9fae}{TCP\_FLAG\_SYN})
103    \{
104       \textcolor{comment}{//Append MSS option}
105       \hyperlink{tcp__misc_8c_aaa03069a05ec6f7a88f92854a12566be}{tcpAddOption}(segment, \hyperlink{tcp_8h_a064186fb289be38d3e1a71ecf446fe8caa534c3934b8bd83794d7892083275375}{TCP\_OPTION\_MAX\_SEGMENT\_SIZE}, &mss, \textcolor{keyword}{
      sizeof}(mss));
106 
107 \textcolor{preprocessor}{#if (TCP\_SACK\_SUPPORT == ENABLED)}
108       \textcolor{comment}{//Append SACK Permitted option}
109       \hyperlink{tcp__misc_8c_aaa03069a05ec6f7a88f92854a12566be}{tcpAddOption}(segment, \hyperlink{tcp_8h_a064186fb289be38d3e1a71ecf446fe8ca99d8f487511fc1d0c5db7204e0c14abf}{TCP\_OPTION\_SACK\_PERMITTED}, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 0);
110 \textcolor{preprocessor}{#endif}
111    \}
112 
113    \textcolor{comment}{//Adjust the length of the multi-part buffer}
114    \hyperlink{net__mem_8c_ac0a46f396754e069dd1ee65cdc559b28}{netBufferSetLength}(buffer, offset + segment->dataOffset * 4);
115 
116    \textcolor{comment}{//Any data to send?}
117    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} > 0)
118    \{
119       \textcolor{comment}{//Copy data}
120       error = \hyperlink{tcp__misc_8c_ad88122545f2bfada890011b9057701ed}{tcpReadTxBuffer}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{dtls__misc_8h_a334ea08fc328b399d92541b8795beed5}{seqNum}, buffer, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
121       \textcolor{comment}{//Any error to report?}
122       \textcolor{keywordflow}{if}(error)
123       \{
124          \textcolor{comment}{//Clean up side effects}
125          \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
126          \textcolor{comment}{//Exit immediately}
127          \textcolor{keywordflow}{return} error;
128       \}
129    \}
130 
131    \textcolor{comment}{//Calculate the length of the complete TCP segment}
132    totalLength = segment->dataOffset * 4 + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
133 
134 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
135    \textcolor{comment}{//Destination address is an IPv4 address?}
136    \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->remoteIpAddr.length == \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr}))
137    \{
138       \textcolor{comment}{//Format IPv4 pseudo header}
139       pseudoHeader.\hyperlink{structIpPseudoHeader_aeff06b8d9c3e7e2ef3cdb8a3a14e8ad2}{length} = \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a0e92b64e038199f1bb6383f2a76f30b6}{Ipv4PseudoHeader});
140       pseudoHeader.\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.srcAddr = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->localIpAddr.ipv4Addr;
141       pseudoHeader.\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.destAddr = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->remoteIpAddr.ipv4Addr;
142       pseudoHeader.\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.reserved = 0;
143       pseudoHeader.\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.protocol = \hyperlink{ipv4_8h_a113cd13f7321e81a3f55491fa3b7db23afef0a32d4295a591764b3e73dcf0a96d}{IPV4\_PROTOCOL\_TCP};
144       pseudoHeader.\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data}.length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(totalLength);
145 
146       \textcolor{comment}{//Calculate TCP header checksum}
147       segment->checksum = \hyperlink{ip_8c_a9ec0593d9dbb2adf3e67894c0349cef3}{ipCalcUpperLayerChecksumEx}(&pseudoHeader.
      \hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data},
148          \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a0e92b64e038199f1bb6383f2a76f30b6}{Ipv4PseudoHeader}), buffer, offset, totalLength);
149    \}
150    \textcolor{keywordflow}{else}
151 \textcolor{preprocessor}{#endif}
152 \textcolor{preprocessor}{#if (IPV6\_SUPPORT == ENABLED)}
153    \textcolor{comment}{//Destination address is an IPv6 address?}
154    \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->remoteIpAddr.length == \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6Addr}))
155    \{
156       \textcolor{comment}{//Format IPv6 pseudo header}
157       pseudoHeader.\hyperlink{structIpPseudoHeader_aeff06b8d9c3e7e2ef3cdb8a3a14e8ad2}{length} = \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader});
158       pseudoHeader.\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.srcAddr = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->localIpAddr.ipv6Addr;
159       pseudoHeader.\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.destAddr = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->remoteIpAddr.ipv6Addr;
160       pseudoHeader.\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.length = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(totalLength);
161       pseudoHeader.\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.reserved = 0;
162       pseudoHeader.\hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data}.nextHeader = \hyperlink{ipv6_8h_a551bec2628dfcc3b67c0fff52e486fa5a7db3654cd07645b0b0f9c4844b88f27f}{IPV6\_TCP\_HEADER};
163 
164       \textcolor{comment}{//Calculate TCP header checksum}
165       segment->checksum = \hyperlink{ip_8c_a9ec0593d9dbb2adf3e67894c0349cef3}{ipCalcUpperLayerChecksumEx}(&pseudoHeader.
      \hyperlink{structIpPseudoHeader_a5155846ca7e85218407a8374d035aab7}{ipv6Data},
166          \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader}), buffer, offset, totalLength);
167    \}
168    \textcolor{keywordflow}{else}
169 \textcolor{preprocessor}{#endif}
170    \textcolor{comment}{//Destination address is not valid?}
171    \{
172       \textcolor{comment}{//Free previously allocated memory}
173       \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
174       \textcolor{comment}{//This should never occur...}
175       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
176    \}
177 
178    \textcolor{comment}{//Add current segment to retransmission queue?}
179    \textcolor{keywordflow}{if}(addToQueue)
180    \{
181       \textcolor{comment}{//Empty retransmission queue?}
182       \textcolor{keywordflow}{if}(!\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitQueue)
183       \{
184          \textcolor{comment}{//Create a new item}
185          queueItem = \hyperlink{net__mem_8c_abe64a91cd872768817509cc08eed6689}{memPoolAlloc}(\textcolor{keyword}{sizeof}(\hyperlink{struct__TcpQueueItem}{TcpQueueItem}));
186          \textcolor{comment}{//Add the newly created item to the queue}
187          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitQueue = queueItem;
188       \}
189       \textcolor{keywordflow}{else}
190       \{
191          \textcolor{comment}{//Point to the very first item}
192          queueItem = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitQueue;
193          \textcolor{comment}{//Reach the last item of the retransmission queue}
194          \textcolor{keywordflow}{while}(queueItem->\hyperlink{struct__TcpQueueItem_a5e46d57271b1dcbf0a5d647ca67f2a86}{next}) queueItem = queueItem->\hyperlink{struct__TcpQueueItem_a5e46d57271b1dcbf0a5d647ca67f2a86}{next};
195          \textcolor{comment}{//Create a new item}
196          queueItem->\hyperlink{struct__TcpQueueItem_a5e46d57271b1dcbf0a5d647ca67f2a86}{next} = \hyperlink{net__mem_8c_abe64a91cd872768817509cc08eed6689}{memPoolAlloc}(\textcolor{keyword}{sizeof}(\hyperlink{struct__TcpQueueItem}{TcpQueueItem}));
197          \textcolor{comment}{//Point to the newly created item}
198          queueItem = queueItem->\hyperlink{struct__TcpQueueItem_a5e46d57271b1dcbf0a5d647ca67f2a86}{next};
199       \}
200 
201       \textcolor{comment}{//Failed to allocate memory?}
202       \textcolor{keywordflow}{if}(queueItem == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
203       \{
204          \textcolor{comment}{//Free previously allocated memory}
205          \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
206          \textcolor{comment}{//Return status}
207          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
208       \}
209 
210       \textcolor{comment}{//Retransmission mechanism requires additional information}
211       queueItem->\hyperlink{struct__TcpQueueItem_a5e46d57271b1dcbf0a5d647ca67f2a86}{next} = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
212       queueItem->\hyperlink{struct__TcpQueueItem_a3c42cb4d2046a392570ab6f8dfa7a398}{length} = \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
213       queueItem->\hyperlink{struct__TcpQueueItem_a18ca123a9505da49954d6af37058c6fd}{sacked} = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
214       \textcolor{comment}{//Save TCP header}
215       memcpy(queueItem->\hyperlink{struct__TcpQueueItem_a61325506bbe534b89f9308b7a1374d08}{header}, segment, segment->dataOffset * 4);
216       \textcolor{comment}{//Save pseudo header}
217       queueItem->\hyperlink{struct__TcpQueueItem_a2ddf7abb88b02f243eae7461ced90ef0}{pseudoHeader} = pseudoHeader;
218 
219       \textcolor{comment}{//Take one RTT measurement at a time}
220       \textcolor{keywordflow}{if}(!\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttBusy)
221       \{
222          \textcolor{comment}{//Save round-trip start time}
223          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttStartTime = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
224          \textcolor{comment}{//Record current sequence number}
225          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttSeqNum = \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(segment->seqNum);
226          \textcolor{comment}{//Wait for an acknowledgment that covers that sequence number...}
227          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rttBusy = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
228 
229 \textcolor{preprocessor}{#if (TCP\_CONGEST\_CONTROL\_SUPPORT == ENABLED)}
230          \textcolor{comment}{//Reset the byte counter}
231          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->n = 0;
232 \textcolor{preprocessor}{#endif}
233       \}
234 
235       \textcolor{comment}{//Check whether the RTO timer is already running}
236       \textcolor{keywordflow}{if}(!\hyperlink{tcp__timer_8c_a23e3bb081c9510f93e437a9a424b2983}{tcpTimerRunning}(&\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitTimer))
237       \{
238          \textcolor{comment}{//If the timer is not running, start it running so that}
239          \textcolor{comment}{//it will expire after RTO seconds}
240          \hyperlink{tcp__timer_8c_ac28b31fb6e44b56d37fb37f2b34f8a67}{tcpTimerStart}(&\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitTimer, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rto);
241          \textcolor{comment}{//Reset retransmission counter}
242          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitCount = 0;
243       \}
244    \}
245 
246    \textcolor{comment}{//Total number of segments sent}
247    \hyperlink{mib2__module_8h_abac73a39224e47d597f3b461620d2119}{MIB2\_INC\_COUNTER32}(tcpGroup.tcpOutSegs, 1);
248    \hyperlink{tcp__mib__module_8h_a296ad60b53152af0749116138a8ae227}{TCP\_MIB\_INC\_COUNTER32}(tcpOutSegs, 1);
249    \hyperlink{tcp__mib__module_8h_a253ad9db6b20e52ec432bb8c23ee309c}{TCP\_MIB\_INC\_COUNTER64}(tcpHCOutSegs, 1);
250 
251    \textcolor{comment}{//RST flag set?}
252    \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags} & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a2eaeb7e7c1984d0bd4d1cbb48b2b5ce4}{TCP\_FLAG\_RST})
253    \{
254       \textcolor{comment}{//Number of TCP segments sent containing the RST flag}
255       \hyperlink{mib2__module_8h_abac73a39224e47d597f3b461620d2119}{MIB2\_INC\_COUNTER32}(tcpGroup.tcpOutRsts, 1);
256       \hyperlink{tcp__mib__module_8h_a296ad60b53152af0749116138a8ae227}{TCP\_MIB\_INC\_COUNTER32}(tcpOutRsts, 1);
257    \}
258 
259    \textcolor{comment}{//Debug message}
260    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"%s: Sending TCP segment (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" data bytes)...\(\backslash\)r\(\backslash\)n"},
261       \hyperlink{date__time_8c_ae15b3e664208ca7e4d6983921865cd74}{formatSystemTime}(\hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}(), \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}), 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
262 
263    \textcolor{comment}{//Dump TCP header contents for debugging purpose}
264    \hyperlink{tcp__misc_8c_a73fae08a3e43bdbf6a01ab32d8802949}{tcpDumpHeader}(segment, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->iss, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->irs);
265 
266    \textcolor{comment}{//Send TCP segment}
267    error = \hyperlink{ip_8c_ac39710faa96e88364ef7007fee711c5e}{ipSendDatagram}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->interface, &pseudoHeader, buffer, offset, 0);
268 
269    \textcolor{comment}{//Free previously allocated memory}
270    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
271    \textcolor{comment}{//Return error code}
272    \textcolor{keywordflow}{return} error;
273 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a1d69d8ed2662a74417c757291f540077}\label{tcp__misc_8c_a1d69d8ed2662a74417c757291f540077}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Update\+Events@{tcp\+Update\+Events}}
\index{tcp\+Update\+Events@{tcp\+Update\+Events}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Update\+Events()}{tcpUpdateEvents()}}
{\footnotesize\ttfamily void tcp\+Update\+Events (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket }\end{DoxyParamCaption})}



Update T\+CP related events. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\end{DoxyParams}


Definition at line 1756 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1757 \{
1758    \textcolor{comment}{//Clear event flags}
1759    \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags = 0;
1760 
1761    \textcolor{comment}{//Check current TCP state}
1762    \textcolor{keywordflow}{switch}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state)
1763    \{
1764    \textcolor{comment}{//ESTABLISHED or FIN-WAIT-1 state?}
1765    \textcolor{keywordflow}{case} \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfecaacb7ccce8d3fcdbc6635983251b22189}{TCP\_STATE\_ESTABLISHED}:
1766    \textcolor{keywordflow}{case} \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfecad80d0b794cc52f39180e65bd1da1b555}{TCP\_STATE\_FIN\_WAIT\_1}:
1767       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea007de01376b29a77df52df9f87676ad6}{SOCKET\_EVENT\_CONNECTED};
1768       \textcolor{keywordflow}{break};
1769    \textcolor{comment}{//FIN-WAIT-2 state?}
1770    \textcolor{keywordflow}{case} \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfecac50f13616eeb349dc1aaa5cfd3422018}{TCP\_STATE\_FIN\_WAIT\_2}:
1771       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea007de01376b29a77df52df9f87676ad6}{SOCKET\_EVENT\_CONNECTED};
1772       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea7c192744b90c583effbac921fe00c4a0}{SOCKET\_EVENT\_TX\_SHUTDOWN};
1773       \textcolor{keywordflow}{break};
1774    \textcolor{comment}{//CLOSE-WAIT, LAST-ACK or CLOSING state?}
1775    \textcolor{keywordflow}{case} \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfecabd723866a1772c3180b372605cfbc963}{TCP\_STATE\_CLOSE\_WAIT}:
1776    \textcolor{keywordflow}{case} \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfeca29f7d016b33a1856dfba699643c69260}{TCP\_STATE\_LAST\_ACK}:
1777    \textcolor{keywordflow}{case} \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfecad9c881087c2449f9d8c7a2a2ab188f22}{TCP\_STATE\_CLOSING}:
1778       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea007de01376b29a77df52df9f87676ad6}{SOCKET\_EVENT\_CONNECTED};
1779       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea0578189399787b74acb9636b9eef30fc}{SOCKET\_EVENT\_RX\_SHUTDOWN};
1780       \textcolor{keywordflow}{break};
1781    \textcolor{comment}{//TIME-WAIT or CLOSED state?}
1782    \textcolor{keywordflow}{case} \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfeca8fa1774b3f785db85813df1b8e158c56}{TCP\_STATE\_TIME\_WAIT}:
1783    \textcolor{keywordflow}{case} \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfeca1af39131036c81d79f09174d2fb6f788}{TCP\_STATE\_CLOSED}:
1784       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea7a2ec59a16cf8b477fa5d5617131e649}{SOCKET\_EVENT\_CLOSED};
1785       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea7c192744b90c583effbac921fe00c4a0}{SOCKET\_EVENT\_TX\_SHUTDOWN};
1786       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea0578189399787b74acb9636b9eef30fc}{SOCKET\_EVENT\_RX\_SHUTDOWN};
1787       \textcolor{keywordflow}{break};
1788    \textcolor{comment}{//Any other state}
1789    \textcolor{keywordflow}{default}:
1790       \textcolor{keywordflow}{break};
1791    \}
1792 
1793    \textcolor{comment}{//Handle TX specific events}
1794    \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state == \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfeca63834296a6449f272b397d54a5536bfc}{TCP\_STATE\_SYN\_SENT} ||
1795       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state == \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfecadfce7e58cb083022157243f993d4ddc3}{TCP\_STATE\_SYN\_RECEIVED})
1796    \{
1797       \textcolor{comment}{//Disallow write operations until the connection is established}
1798       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea18bba7ecd37cc15131588d430017f205}{SOCKET\_EVENT\_TX\_DONE};
1799       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea9303c52298e0adf175b7064fbe7ce077}{SOCKET\_EVENT\_TX\_ACKED};
1800    \}
1801    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state == \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfecaacb7ccce8d3fcdbc6635983251b22189}{TCP\_STATE\_ESTABLISHED} ||
1802       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state == \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfecabd723866a1772c3180b372605cfbc963}{TCP\_STATE\_CLOSE\_WAIT})
1803    \{
1804       \textcolor{comment}{//Check whether the send buffer is full or not}
1805       \textcolor{keywordflow}{if}((\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUser + \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna) < 
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize)
1806          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea078fc309f8e29689ee08e584f00a73b6}{SOCKET\_EVENT\_TX\_READY};
1807 
1808       \textcolor{comment}{//Check whether all the data in the send buffer has been transmitted}
1809       \textcolor{keywordflow}{if}(!\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUser)
1810       \{
1811          \textcolor{comment}{//All the pending data has been sent out}
1812          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea18bba7ecd37cc15131588d430017f205}{SOCKET\_EVENT\_TX\_DONE};
1813 
1814          \textcolor{comment}{//Check whether an acknowledgment has been received}
1815          \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt) >= 0)
1816             \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea9303c52298e0adf175b7064fbe7ce077}{SOCKET\_EVENT\_TX\_ACKED};
1817       \}
1818    \}
1819    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state != \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfeca7f99d4d604cb5009b50f04f84f5cb1c6}{TCP\_STATE\_LISTEN})
1820    \{
1821       \textcolor{comment}{//Unblock user task if the connection is being closed}
1822       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea078fc309f8e29689ee08e584f00a73b6}{SOCKET\_EVENT\_TX\_READY};
1823       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea18bba7ecd37cc15131588d430017f205}{SOCKET\_EVENT\_TX\_DONE};
1824       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea9303c52298e0adf175b7064fbe7ce077}{SOCKET\_EVENT\_TX\_ACKED};
1825    \}
1826 
1827    \textcolor{comment}{//Handle RX specific events}
1828    \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state == \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfecaacb7ccce8d3fcdbc6635983251b22189}{TCP\_STATE\_ESTABLISHED} ||
1829       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state == \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfecad80d0b794cc52f39180e65bd1da1b555}{TCP\_STATE\_FIN\_WAIT\_1} ||
1830       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state == \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfecac50f13616eeb349dc1aaa5cfd3422018}{TCP\_STATE\_FIN\_WAIT\_2})
1831    \{
1832       \textcolor{comment}{//Data is available for reading?}
1833       \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvUser > 0)
1834          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY};
1835    \}
1836    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state == \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfeca7f99d4d604cb5009b50f04f84f5cb1c6}{TCP\_STATE\_LISTEN})
1837    \{
1838       \textcolor{comment}{//If the socket is currently in the listen state, it will be marked}
1839       \textcolor{comment}{//as readable if an incoming connection request has been received}
1840       \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->synQueue != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1841          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY};
1842    \}
1843    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state != \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfeca63834296a6449f272b397d54a5536bfc}{TCP\_STATE\_SYN\_SENT} &&
1844       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->state != \hyperlink{tcp_8h_a4310b47e70de394d33f7cf601e35bfecadfce7e58cb083022157243f993d4ddc3}{TCP\_STATE\_SYN\_RECEIVED})
1845    \{
1846       \textcolor{comment}{//Readability can also indicate that a request to close}
1847       \textcolor{comment}{//the socket has been received from the peer}
1848       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY};
1849    \}
1850 
1851    \textcolor{comment}{//Check whether the socket is bound to a particular network interface}
1852    \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->interface != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1853    \{
1854       \textcolor{comment}{//Handle link up and link down events}
1855       \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->interface->linkState)
1856          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6eafe461e492995403ea5964dd740210c2e}{SOCKET\_EVENT\_LINK\_UP};
1857       \textcolor{keywordflow}{else}
1858          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags |= \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6eab971918883e240c24d301f7eb44f08cd}{SOCKET\_EVENT\_LINK\_DOWN};
1859    \}
1860 
1861    \textcolor{comment}{//Mask unused events}
1862    \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags &= \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventMask;
1863 
1864    \textcolor{comment}{//Any event to signal?}
1865    \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags)
1866    \{
1867       \textcolor{comment}{//Unblock I/O operations currently in waiting state}
1868       \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->event);
1869 
1870       \textcolor{comment}{//Set user event to signaled state if necessary}
1871       \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->userEvent != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1872          \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->userEvent);
1873    \}
1874 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_aa1656bdca8c8970333412696664c3064}\label{tcp__misc_8c_aa1656bdca8c8970333412696664c3064}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Update\+Receive\+Window@{tcp\+Update\+Receive\+Window}}
\index{tcp\+Update\+Receive\+Window@{tcp\+Update\+Receive\+Window}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Update\+Receive\+Window()}{tcpUpdateReceiveWindow()}}
{\footnotesize\ttfamily void tcp\+Update\+Receive\+Window (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket }\end{DoxyParamCaption})}



Update receive window so as to avoid Silly Window Syndrome. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\end{DoxyParams}


Definition at line 1387 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1388 \{
1389    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} reduction;
1390 
1391    \textcolor{comment}{//Space available but not yet advertised}
1392    reduction = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvUser - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd;
1393 
1394    \textcolor{comment}{//To avoid SWS, the receiver should not advertise small windows}
1395    \textcolor{keywordflow}{if}((\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd + reduction) >= \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rmss, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize / 2))
1396    \{
1397       \textcolor{comment}{//Check whether a window update should be sent}
1398       \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd < \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rmss, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize / 2))
1399       \{
1400          \textcolor{comment}{//Debug message}
1401          \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"%s: TCP sending window update...\(\backslash\)r\(\backslash\)n"},
1402             \hyperlink{date__time_8c_ae15b3e664208ca7e4d6983921865cd74}{formatSystemTime}(\hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}(), 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
1403 
1404          \textcolor{comment}{//Update the receive window}
1405          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd += reduction;
1406          \textcolor{comment}{//Send an ACK segment to advertise the new window size}
1407          \hyperlink{tcp__misc_8c_acf2944966efe796f3bb867f9d7233591}{tcpSendSegment}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}, \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7aae4cbb82c7a2373576547ed119498a4a}{TCP\_FLAG\_ACK}, 
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndNxt, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt, 0, \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
1408       \}
1409       \textcolor{keywordflow}{else}
1410       \{
1411          \textcolor{comment}{//The receive window can be updated}
1412          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvWnd += reduction;
1413       \}
1414    \}
1415 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a18731fd3f3545ac38f21ad9d570816d6}\label{tcp__misc_8c_a18731fd3f3545ac38f21ad9d570816d6}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Update\+Retransmit\+Queue@{tcp\+Update\+Retransmit\+Queue}}
\index{tcp\+Update\+Retransmit\+Queue@{tcp\+Update\+Retransmit\+Queue}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Update\+Retransmit\+Queue()}{tcpUpdateRetransmitQueue()}}
{\footnotesize\ttfamily void tcp\+Update\+Retransmit\+Queue (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket }\end{DoxyParamCaption})}



Remove acknowledged segments from retransmission queue. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\end{DoxyParams}


Definition at line 1151 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1152 \{
1153    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1154    \hyperlink{struct__TcpQueueItem}{TcpQueueItem} *prevQueueItem;
1155    \hyperlink{struct__TcpQueueItem}{TcpQueueItem} *queueItem;
1156    \hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader} *header;
1157 
1158    \textcolor{comment}{//Point to the first item of the retransmission queue}
1159    prevQueueItem = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1160    queueItem = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitQueue;
1161 
1162    \textcolor{comment}{//Loop through retransmission queue}
1163    \textcolor{keywordflow}{while}(queueItem != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1164    \{
1165       \textcolor{comment}{//Point to the TCP header}
1166       header = (\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{TcpHeader} *) queueItem->\hyperlink{struct__TcpQueueItem_a61325506bbe534b89f9308b7a1374d08}{header};
1167 
1168       \textcolor{comment}{//Calculate the length of the TCP segment}
1169       \textcolor{keywordflow}{if}(header->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7af2f8a42ff8bff07cbca1cd2ed6df9fae}{TCP\_FLAG\_SYN})
1170          length = 1;
1171       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(header->flags & \hyperlink{tcp_8h_a4e6d97f0f2a3dc780d192efcdfe64aa7a332cfb33224b794e0be773cba056efa1}{TCP\_FLAG\_FIN})
1172          length = queueItem->\hyperlink{struct__TcpQueueItem_a3c42cb4d2046a392570ab6f8dfa7a398}{length} + 1;
1173       \textcolor{keywordflow}{else}
1174          length = queueItem->\hyperlink{struct__TcpQueueItem_a3c42cb4d2046a392570ab6f8dfa7a398}{length};
1175 
1176       \textcolor{comment}{//If an acknowledgment is received for a segment before its timer}
1177       \textcolor{comment}{//expires, the segment is removed from the retransmission queue}
1178       \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndUna, \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(header->seqNum) + length) >= 0)
1179       \{
1180          \textcolor{comment}{//First item of the queue?}
1181          \textcolor{keywordflow}{if}(prevQueueItem == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1182          \{
1183             \textcolor{comment}{//Remove the current item from the queue}
1184             \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitQueue = queueItem->\hyperlink{struct__TcpQueueItem_a5e46d57271b1dcbf0a5d647ca67f2a86}{next};
1185             \textcolor{comment}{//The item can now be safely deleted}
1186             \hyperlink{net__mem_8c_a5e8a514f3dfcb35008de9beb39bcdcde}{memPoolFree}(queueItem);
1187             \textcolor{comment}{//Point to the next item}
1188             queueItem = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitQueue;
1189          \}
1190          \textcolor{keywordflow}{else}
1191          \{
1192             \textcolor{comment}{//Remove the current item from the queue}
1193             prevQueueItem->\hyperlink{struct__TcpQueueItem_a5e46d57271b1dcbf0a5d647ca67f2a86}{next} = queueItem->\hyperlink{struct__TcpQueueItem_a5e46d57271b1dcbf0a5d647ca67f2a86}{next};
1194             \textcolor{comment}{//The item can now be safely deleted}
1195             \hyperlink{net__mem_8c_a5e8a514f3dfcb35008de9beb39bcdcde}{memPoolFree}(queueItem);
1196             \textcolor{comment}{//Point to the next item}
1197             queueItem = prevQueueItem->\hyperlink{struct__TcpQueueItem_a5e46d57271b1dcbf0a5d647ca67f2a86}{next};
1198          \}
1199 
1200          \textcolor{comment}{//When an ACK is received that acknowledges new data, restart the}
1201          \textcolor{comment}{//retransmission timer so that it will expire after RTO seconds}
1202          \hyperlink{tcp__timer_8c_ac28b31fb6e44b56d37fb37f2b34f8a67}{tcpTimerStart}(&\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitTimer, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rto);
1203          \textcolor{comment}{//Reset retransmission counter}
1204          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitCount = 0;
1205       \}
1206       \textcolor{comment}{//No acknowledgment received for the current segment...}
1207       \textcolor{keywordflow}{else}
1208       \{
1209          \textcolor{comment}{//Point to the next item}
1210          prevQueueItem = queueItem;
1211          queueItem = queueItem->\hyperlink{struct__TcpQueueItem_a5e46d57271b1dcbf0a5d647ca67f2a86}{next};
1212       \}
1213    \}
1214 
1215    \textcolor{comment}{//When all outstanding data has been acknowledged,}
1216    \textcolor{comment}{//turn off the retransmission timer}
1217    \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitQueue == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1218       \hyperlink{tcp__timer_8c_a3064f1c41511310223cdbaae4ab75674}{tcpTimerStop}(&\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->retransmitTimer);
1219 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_aa129fd8807bfc2d84d45974b6e21d304}\label{tcp__misc_8c_aa129fd8807bfc2d84d45974b6e21d304}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Update\+Sack\+Blocks@{tcp\+Update\+Sack\+Blocks}}
\index{tcp\+Update\+Sack\+Blocks@{tcp\+Update\+Sack\+Blocks}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Update\+Sack\+Blocks()}{tcpUpdateSackBlocks()}}
{\footnotesize\ttfamily void tcp\+Update\+Sack\+Blocks (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} $\ast$}]{left\+Edge,  }\item[{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} $\ast$}]{right\+Edge }\end{DoxyParamCaption})}



Update the list of non-\/contiguous blocks that have been received. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\mbox{\tt in,out}  & {\em left\+Edge} & First sequence number occupied by the incoming data \\
\hline
\mbox{\tt in,out}  & {\em right\+Edge} & Sequence number immediately following the incoming data \\
\hline
\end{DoxyParams}


Definition at line 1284 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1285 \{
1286    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i = 0;
1287 
1288    \textcolor{comment}{//Loop through the blocks}
1289    \textcolor{keywordflow}{while}(i < socket->sackBlockCount)
1290    \{
1291       \textcolor{comment}{//Find each block that overlaps the specified one}
1292       \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(*rightEdge, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlock[i].leftEdge) >= 0 &&
1293          \hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(*leftEdge, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlock[i].rightEdge) <= 0)
1294       \{
1295          \textcolor{comment}{//Merge blocks to form a contiguous one}
1296          *leftEdge = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(*leftEdge, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlock[i].leftEdge);
1297          *rightEdge = \hyperlink{os__port_8h_afa99ec4acc4ecb2dc3c2d05da15d0e3f}{MAX}(*rightEdge, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlock[i].rightEdge);
1298 
1299          \textcolor{comment}{//Delete current block}
1300          memmove(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlock + i, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlock + i + 1,
1301             (\hyperlink{tcp_8h_a8d978686549f4d2aec3526cadf667dc1}{TCP\_MAX\_SACK\_BLOCKS} - i - 1) * \textcolor{keyword}{sizeof}(
      \hyperlink{structTcpSackBlock}{TcpSackBlock}));
1302 
1303          \textcolor{comment}{//Decrement the number of non-contiguous blocks}
1304          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlockCount--;
1305       \}
1306       \textcolor{keywordflow}{else}
1307       \{
1308          \textcolor{comment}{//Point to the next block}
1309          i++;
1310       \}
1311    \}
1312 
1313    \textcolor{comment}{//Check whether the incoming segment was received out of order}
1314    \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(*leftEdge, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rcvNxt) > 0)
1315    \{
1316       \textcolor{comment}{//Make room for the new non-contiguous block}
1317       memmove(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlock + 1, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlock,
1318          (\hyperlink{tcp_8h_a8d978686549f4d2aec3526cadf667dc1}{TCP\_MAX\_SACK\_BLOCKS} - 1) * \textcolor{keyword}{sizeof}(\hyperlink{structTcpSackBlock}{TcpSackBlock}));
1319 
1320       \textcolor{comment}{//Insert the element in the list}
1321       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlock[0].leftEdge = *leftEdge;
1322       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlock[0].rightEdge = *rightEdge;
1323 
1324       \textcolor{comment}{//Increment the number of non-contiguous blocks}
1325       \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlockCount < \hyperlink{tcp_8h_a8d978686549f4d2aec3526cadf667dc1}{TCP\_MAX\_SACK\_BLOCKS})
1326          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sackBlockCount++;
1327    \}
1328 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_aef94daad203698a149c4056b7bbd836a}\label{tcp__misc_8c_aef94daad203698a149c4056b7bbd836a}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Update\+Send\+Window@{tcp\+Update\+Send\+Window}}
\index{tcp\+Update\+Send\+Window@{tcp\+Update\+Send\+Window}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Update\+Send\+Window()}{tcpUpdateSendWindow()}}
{\footnotesize\ttfamily void tcp\+Update\+Send\+Window (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{tcp_8h_a38f08160c28f0a8e104907d2ee71fed5}{Tcp\+Header} $\ast$}]{segment }\end{DoxyParamCaption})}



Update send window. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\mbox{\tt in}  & {\em segment} & Pointer to the incoming T\+CP segment \\
\hline
\end{DoxyParams}


Definition at line 1337 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1338 \{
1339    \textcolor{comment}{//Case where neither the sequence nor the acknowledgment number is increased}
1340    \textcolor{keywordflow}{if}(segment->seqNum == \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWl1 && segment->ackNum == \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWl2)
1341    \{
1342       \textcolor{comment}{//TCP may ignore a window update with a smaller window than previously}
1343       \textcolor{comment}{//offered if neither the sequence number nor the acknowledgment number}
1344       \textcolor{comment}{//is increased (refer to RFC 1122, section 4.2.2.16)}
1345       \textcolor{keywordflow}{if}(segment->window > \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWnd)
1346       \{
1347          \textcolor{comment}{//Update the send window and record the sequence number and the}
1348          \textcolor{comment}{//acknowledgment number used to update SND.WND}
1349          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWnd = segment->window;
1350          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWl1 = segment->seqNum;
1351          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWl2 = segment->ackNum;
1352 
1353          \textcolor{comment}{//Maximum send window it has seen so far on the connection}
1354          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->maxSndWnd = \hyperlink{os__port_8h_afa99ec4acc4ecb2dc3c2d05da15d0e3f}{MAX}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->maxSndWnd, segment->window);
1355       \}
1356    \}
1357    \textcolor{comment}{//Case where the sequence or the acknowledgment number is increased}
1358    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->seqNum, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWl1) >= 0 &&
1359       \hyperlink{tcp_8h_adcfa1a4af128e2438f93db11c81c09cf}{TCP\_CMP\_SEQ}(segment->ackNum, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWl2) >= 0)
1360    \{
1361       \textcolor{comment}{//The remote host advertises a zero window?}
1362       \textcolor{keywordflow}{if}(!segment->window && \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWnd)
1363       \{
1364          \textcolor{comment}{//Start the persist timer}
1365          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->wndProbeCount = 0;
1366          \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->wndProbeInterval = \hyperlink{tcp_8h_a166c09148b661e84c948345c4bcd9aab}{TCP\_DEFAULT\_PROBE\_INTERVAL};
1367          \hyperlink{tcp__timer_8c_ac28b31fb6e44b56d37fb37f2b34f8a67}{tcpTimerStart}(&\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->persistTimer, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->wndProbeInterval);
1368       \}
1369 
1370       \textcolor{comment}{//Update the send window and record the sequence number and the}
1371       \textcolor{comment}{//acknowledgment number used to update SND.WND}
1372       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWnd = segment->window;
1373       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWl1 = segment->seqNum;
1374       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->sndWl2 = segment->ackNum;
1375 
1376       \textcolor{comment}{//Maximum send window it has seen so far on the connection}
1377       \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->maxSndWnd = \hyperlink{os__port_8h_afa99ec4acc4ecb2dc3c2d05da15d0e3f}{MAX}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->maxSndWnd, segment->window);
1378    \}
1379 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a004bf9b96c5217222960bc09c2e48a78}\label{tcp__misc_8c_a004bf9b96c5217222960bc09c2e48a78}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Wait\+For\+Events@{tcp\+Wait\+For\+Events}}
\index{tcp\+Wait\+For\+Events@{tcp\+Wait\+For\+Events}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Wait\+For\+Events()}{tcpWaitForEvents()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} tcp\+Wait\+For\+Events (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{event\+Mask,  }\item[{\hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t}}]{timeout }\end{DoxyParamCaption})}



Wait for a particular T\+CP event. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\mbox{\tt in}  & {\em event\+Mask} & Logic OR of all the T\+CP events that will complete the wait \\
\hline
\mbox{\tt in}  & {\em timeout} & Maximum time to wait \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Logic OR of all the T\+CP events that satisfied the wait 
\end{DoxyReturn}


Definition at line 1885 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1886 \{
1887    \textcolor{comment}{//Sanity check}
1888    \textcolor{keywordflow}{if}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket} == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1889       \textcolor{keywordflow}{return} 0;
1890 
1891    \textcolor{comment}{//Only one of the events listed here may complete the wait}
1892    \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventMask = eventMask;
1893    \textcolor{comment}{//Update TCP related events}
1894    \hyperlink{tcp__misc_8c_a1d69d8ed2662a74417c757291f540077}{tcpUpdateEvents}(\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket});
1895 
1896    \textcolor{comment}{//No event is signaled?}
1897    \textcolor{keywordflow}{if}(!\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags)
1898    \{
1899       \textcolor{comment}{//Reset the event object}
1900       \hyperlink{os__port__chibios_8c_a9122a1cf258caef553a6b224ef8ef6bf}{osResetEvent}(&\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->event);
1901 
1902       \textcolor{comment}{//Release exclusive access}
1903       \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
1904       \textcolor{comment}{//Wait until an event is triggered}
1905       \hyperlink{os__port__chibios_8c_a1dc707247e44dfefae5bec4a322fc78a}{osWaitForEvent}(&\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->event, timeout);
1906       \textcolor{comment}{//Get exclusive access}
1907       \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
1908    \}
1909 
1910    \textcolor{comment}{//Return the list of TCP events that satisfied the wait}
1911    \textcolor{keywordflow}{return} \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->eventFlags;
1912 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a9a639edc348cbd2e86a240177099120a}\label{tcp__misc_8c_a9a639edc348cbd2e86a240177099120a}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Write\+Rx\+Buffer@{tcp\+Write\+Rx\+Buffer}}
\index{tcp\+Write\+Rx\+Buffer@{tcp\+Write\+Rx\+Buffer}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Write\+Rx\+Buffer()}{tcpWriteRxBuffer()}}
{\footnotesize\ttfamily void tcp\+Write\+Rx\+Buffer (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t}}]{seq\+Num,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{data,  }\item[{size\+\_\+t}]{data\+Offset,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Copy incoming data to the receive buffer. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\mbox{\tt in}  & {\em seq\+Num} & First sequence number occupied by the incoming data \\
\hline
\mbox{\tt in}  & {\em data} & Multi-\/part buffer containing the incoming data \\
\hline
\mbox{\tt in}  & {\em data\+Offset} & Offset to the first data byte \\
\hline
\mbox{\tt in}  & {\em length} & Number of data to write \\
\hline
\end{DoxyParams}


Definition at line 2001 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
2003 \{
2004    \textcolor{comment}{//Offset of the first byte to write in the circular buffer}
2005    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset} = (\hyperlink{dtls__misc_8h_a334ea08fc328b399d92541b8795beed5}{seqNum} - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->irs - 1) % \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize;
2006 
2007    \textcolor{comment}{//Check whether the specified data crosses buffer boundaries}
2008    \textcolor{keywordflow}{if}((offset + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}) <= \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize)
2009    \{
2010       \textcolor{comment}{//Copy the payload}
2011       \hyperlink{net__mem_8c_a553a02631efd217192800ad3cdf9bbba}{netBufferCopy}((\hyperlink{structNetBuffer}{NetBuffer} *) &\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBuffer,
2012          offset, data, \hyperlink{tcp_8h_ae0743b8326e63b450642f96ca32a3bea}{dataOffset}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
2013    \}
2014    \textcolor{keywordflow}{else}
2015    \{
2016       \textcolor{comment}{//Copy the first part of the payload}
2017       \hyperlink{net__mem_8c_a553a02631efd217192800ad3cdf9bbba}{netBufferCopy}((\hyperlink{structNetBuffer}{NetBuffer} *) &\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBuffer,
2018          offset, data, \hyperlink{tcp_8h_ae0743b8326e63b450642f96ca32a3bea}{dataOffset}, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize - offset);
2019       \textcolor{comment}{//Wrap around to the beginning of the circular buffer}
2020       \hyperlink{net__mem_8c_a553a02631efd217192800ad3cdf9bbba}{netBufferCopy}((\hyperlink{structNetBuffer}{NetBuffer} *) &\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBuffer, 0, data,
2021          \hyperlink{tcp_8h_ae0743b8326e63b450642f96ca32a3bea}{dataOffset} + \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize - offset, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - 
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->rxBufferSize + offset);
2022    \}
2023 \}
\end{DoxyCode}
\mbox{\Hypertarget{tcp__misc_8c_a9bbd4fc8a09ba17e2b064ac4674b5d09}\label{tcp__misc_8c_a9bbd4fc8a09ba17e2b064ac4674b5d09}} 
\index{tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}!tcp\+Write\+Tx\+Buffer@{tcp\+Write\+Tx\+Buffer}}
\index{tcp\+Write\+Tx\+Buffer@{tcp\+Write\+Tx\+Buffer}!tcp\+\_\+misc.\+c@{tcp\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tcp\+Write\+Tx\+Buffer()}{tcpWriteTxBuffer()}}
{\footnotesize\ttfamily void tcp\+Write\+Tx\+Buffer (\begin{DoxyParamCaption}\item[{\hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} $\ast$}]{socket,  }\item[{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t}}]{seq\+Num,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Copy incoming data to the send buffer. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em socket} & Handle referencing the socket \\
\hline
\mbox{\tt in}  & {\em seq\+Num} & First sequence number occupied by the incoming data \\
\hline
\mbox{\tt in}  & {\em data} & Data to write \\
\hline
\mbox{\tt in}  & {\em length} & Number of data to write \\
\hline
\end{DoxyParams}


Definition at line 1923 of file tcp\+\_\+misc.\+c.


\begin{DoxyCode}
1925 \{
1926    \textcolor{comment}{//Offset of the first byte to write in the circular buffer}
1927    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset} = (\hyperlink{dtls__misc_8h_a334ea08fc328b399d92541b8795beed5}{seqNum} - \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->iss - 1) % \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize;
1928 
1929    \textcolor{comment}{//Check whether the specified data crosses buffer boundaries}
1930    \textcolor{keywordflow}{if}((offset + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}) <= \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize)
1931    \{
1932       \textcolor{comment}{//Copy the payload}
1933       \hyperlink{net__mem_8c_a977e79aab71b4b39772ff8256abb8b55}{netBufferWrite}((\hyperlink{structNetBuffer}{NetBuffer} *) &\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBuffer,
1934          offset, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
1935    \}
1936    \textcolor{keywordflow}{else}
1937    \{
1938       \textcolor{comment}{//Copy the first part of the payload}
1939       \hyperlink{net__mem_8c_a977e79aab71b4b39772ff8256abb8b55}{netBufferWrite}((\hyperlink{structNetBuffer}{NetBuffer} *) &\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBuffer,
1940          offset, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize - offset);
1941       \textcolor{comment}{//Wrap around to the beginning of the circular buffer}
1942       \hyperlink{net__mem_8c_a977e79aab71b4b39772ff8256abb8b55}{netBufferWrite}((\hyperlink{structNetBuffer}{NetBuffer} *) &\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBuffer,
1943          0, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} + \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize - offset, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - 
      \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket}->txBufferSize + offset);
1944    \}
1945 \}
\end{DoxyCode}
