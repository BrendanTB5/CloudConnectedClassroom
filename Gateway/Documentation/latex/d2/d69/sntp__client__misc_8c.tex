\hypertarget{sntp__client__misc_8c}{}\section{cyclone\+\_\+tcp/sntp/sntp\+\_\+client\+\_\+misc.c File Reference}
\label{sntp__client__misc_8c}\index{cyclone\+\_\+tcp/sntp/sntp\+\_\+client\+\_\+misc.\+c@{cyclone\+\_\+tcp/sntp/sntp\+\_\+client\+\_\+misc.\+c}}
{\ttfamily \#include $<$ctype.\+h$>$}\newline
{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}sntp/sntp\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}sntp/sntp\+\_\+client\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{sntp__client__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_a17d00fe38ec2c4ff847a3d2365025b7e}{S\+N\+T\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{sntp__client__misc_8c_a73106b6ab0a614ff867c1d9c8b03f16a}{sntp\+Client\+Open\+Connection} (\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Open U\+DP connection. \end{DoxyCompactList}\item 
void \hyperlink{sntp__client__misc_8c_af495d67158e5920dd0b555f041c39edd}{sntp\+Client\+Close\+Connection} (\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Close U\+DP connection. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{sntp__client__misc_8c_a6c9f4f0e97e4f052300b253bcb01dc0f}{sntp\+Client\+Send\+Request} (\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Send request to the N\+TP server. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{sntp__client__misc_8c_a483ec1f91330a633b15832853c5416d6}{sntp\+Client\+Receive\+Response} (\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Wait for N\+TP server\textquotesingle{}s response. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{sntp__client__misc_8c_a22215ba0c12d71e1132309151fea1a28}{sntp\+Client\+Check\+Response} (\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$context, const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$\hyperlink{ipcp_8h_a11542dd5a4de5976a89188df3d53b42d}{ip\+Addr}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port}, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Check whether the N\+TP response is valid. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{sntp__client__misc_8c_ae58e62ccf938f6dee79f204404d8a642}{sntp\+Client\+Parse\+Response} (\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$context, \hyperlink{ntp__common_8h_a4b0bee470029fbe2a20b9d804bd15ab5}{Ntp\+Timestamp} $\ast$timestamp)
\begin{DoxyCompactList}\small\item\em Parse N\+TP server\textquotesingle{}s response. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{sntp__client__misc_8c_a6faf9bb1b15cb68afdb64507ad797673}{sntp\+Client\+Check\+Timeout} (\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Determine whether a timeout error has occurred. \end{DoxyCompactList}\item 
void \hyperlink{sntp__client__misc_8c_aee5e45bda3b95e43cef24c87f24e8ac4}{sntp\+Client\+Dump\+Message} (const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Dump N\+TP message for debugging purpose. \end{DoxyCompactList}\item 
void \hyperlink{sntp__client__misc_8c_ad7919ecfaca5cd534c5976743c6320c2}{sntp\+Client\+Dump\+Timestamp} (const \hyperlink{ntp__common_8h_a4b0bee470029fbe2a20b9d804bd15ab5}{Ntp\+Timestamp} $\ast$timestamp)
\begin{DoxyCompactList}\small\item\em Dump N\+TP timestamp. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{sntp__client__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{sntp__client__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_a17d00fe38ec2c4ff847a3d2365025b7e}{S\+N\+T\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 37 of file sntp\+\_\+client\+\_\+misc.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{sntp__client__misc_8c_a22215ba0c12d71e1132309151fea1a28}\label{sntp__client__misc_8c_a22215ba0c12d71e1132309151fea1a28}} 
\index{sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}!sntp\+Client\+Check\+Response@{sntp\+Client\+Check\+Response}}
\index{sntp\+Client\+Check\+Response@{sntp\+Client\+Check\+Response}!sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{sntp\+Client\+Check\+Response()}{sntpClientCheckResponse()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} sntp\+Client\+Check\+Response (\begin{DoxyParamCaption}\item[{\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$}]{context,  }\item[{const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$}]{ip\+Addr,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{port,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{message,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Check whether the N\+TP response is valid. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+TP client context \\
\hline
\mbox{\tt in}  & {\em ip\+Addr} & Remote IP address \\
\hline
\mbox{\tt in}  & {\em port} & Remote port number \\
\hline
\mbox{\tt in}  & {\em message} & Pointer to the N\+TP message \\
\hline
\mbox{\tt in}  & {\em length} & Length of the N\+TP message, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 241 of file sntp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
244 \{
245    \hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader} *header;
246 
247    \textcolor{comment}{//Ensure the NTP packet is valid}
248    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader}))
249       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6b1c5652c82e48ada5b4348c0ebb95e6}{ERROR\_INVALID\_MESSAGE};
250 
251    \textcolor{comment}{//Point to the NTP response}
252    header = (\hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader} *) context->\hyperlink{structSntpClientContext_a01d165c31bb0453f58841511183b37cc}{message};
253 
254    \textcolor{comment}{//Debug message}
255    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"NTP response message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
256       \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
257 
258    \textcolor{comment}{//Dump NTP message}
259    \hyperlink{sntp__client__misc_8c_aee5e45bda3b95e43cef24c87f24e8ac4}{sntpClientDumpMessage}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
260 
261    \textcolor{comment}{//The server reply should be discarded if the VN field is 0}
262    \textcolor{keywordflow}{if}(header->vn == 0)
263       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6b1c5652c82e48ada5b4348c0ebb95e6}{ERROR\_INVALID\_MESSAGE};
264 
265    \textcolor{comment}{//The server reply should be discarded if the Transmit Timestamp fields is 0}
266    \textcolor{keywordflow}{if}(header->transmitTimestamp.seconds == 0 &&
267       header->transmitTimestamp.fraction == 0)
268    \{
269       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6b1c5652c82e48ada5b4348c0ebb95e6}{ERROR\_INVALID\_MESSAGE};
270    \}
271 
272    \textcolor{comment}{//The server reply should be discarded if the Mode field is not 4 (unicast)}
273    \textcolor{comment}{//or 5 (broadcast)}
274    \textcolor{keywordflow}{if}(header->mode != \hyperlink{ntp__common_8h_a5339531aa522fb037c8137a2f27da552a896ac3a0a356bc3eeffeb3aff0c9f09a}{NTP\_MODE\_SERVER} && header->mode != 
      \hyperlink{ntp__common_8h_a5339531aa522fb037c8137a2f27da552ac5ec18994784b7c1a2467cd742ed3882}{NTP\_MODE\_BROADCAST})
275       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6b1c5652c82e48ada5b4348c0ebb95e6}{ERROR\_INVALID\_MESSAGE};
276 
277    \textcolor{comment}{//The Originate Timestamp in the server reply should match the Transmit}
278    \textcolor{comment}{//Timestamp used in the client request}
279    \textcolor{keywordflow}{if}(header->originateTimestamp.seconds != 0)
280       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6b1c5652c82e48ada5b4348c0ebb95e6}{ERROR\_INVALID\_MESSAGE};
281    \textcolor{keywordflow}{if}(header->originateTimestamp.fraction != \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(context->
      \hyperlink{structSntpClientContext_a15b1f25abf336af057af833edb2ef979}{retransmitStartTime}))
282       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6b1c5652c82e48ada5b4348c0ebb95e6}{ERROR\_INVALID\_MESSAGE};
283 
284    \textcolor{comment}{//The NTP response message is acceptable}
285    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
286 \}
\end{DoxyCode}
\mbox{\Hypertarget{sntp__client__misc_8c_a6faf9bb1b15cb68afdb64507ad797673}\label{sntp__client__misc_8c_a6faf9bb1b15cb68afdb64507ad797673}} 
\index{sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}!sntp\+Client\+Check\+Timeout@{sntp\+Client\+Check\+Timeout}}
\index{sntp\+Client\+Check\+Timeout@{sntp\+Client\+Check\+Timeout}!sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{sntp\+Client\+Check\+Timeout()}{sntpClientCheckTimeout()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} sntp\+Client\+Check\+Timeout (\begin{DoxyParamCaption}\item[{\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Determine whether a timeout error has occurred. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+TP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 338 of file sntp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
339 \{
340    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
341    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
342 
343    \textcolor{comment}{//Get current time}
344    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
345 
346    \textcolor{comment}{//Check whether the timeout has elapsed}
347    \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, context->\hyperlink{structSntpClientContext_ae6aa657a6ac2d5a76fc8e026066fa77c}{startTime} + context->
      \hyperlink{structSntpClientContext_aeaec29fda82d9d620c9078d06a4d7b17}{timeout}) >= 0)
348    \{
349       \textcolor{comment}{//Report a timeout error}
350       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT};
351    \}
352    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, context->\hyperlink{structSntpClientContext_a15b1f25abf336af057af833edb2ef979}{retransmitStartTime} + context->
      \hyperlink{structSntpClientContext_a09a8ebb9934b44dfbcca76edab7ceb76}{retransmitTimeout}) >= 0)
353    \{
354       \textcolor{comment}{//The timeout value is doubled for each subsequent retransmission}
355       context->\hyperlink{structSntpClientContext_a09a8ebb9934b44dfbcca76edab7ceb76}{retransmitTimeout} = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(context->
      \hyperlink{structSntpClientContext_a09a8ebb9934b44dfbcca76edab7ceb76}{retransmitTimeout} * 2,
356          \hyperlink{sntp__client_8h_a4e3d83b30d113c375f65cbdf2f780dee}{SNTP\_CLIENT\_MAX\_RETRANSMIT\_TIMEOUT});
357 
358       \textcolor{comment}{//Retransmit NTP request}
359       context->\hyperlink{structSntpClientContext_af141be1c1ac01635b9788482dc791184}{state} = \hyperlink{sntp__client_8h_aeca73741bdca77b9eb50411f0c77136dadf9aa7041528b41d59b6b8e3604a18a0}{SNTP\_CLIENT\_STATE\_SENDING};
360 
361       \textcolor{comment}{//Continue processing}
362       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
363    \}
364    \textcolor{keywordflow}{else}
365    \{
366 \textcolor{preprocessor}{#if (NET\_RTOS\_SUPPORT == ENABLED)}
367       \textcolor{comment}{//Report a timeout error}
368       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT};
369 \textcolor{preprocessor}{#else}
370       \textcolor{comment}{//The operation would block}
371       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK};
372 \textcolor{preprocessor}{#endif}
373    \}
374 
375    \textcolor{comment}{//Return status code}
376    \textcolor{keywordflow}{return} error;
377 \}
\end{DoxyCode}
\mbox{\Hypertarget{sntp__client__misc_8c_af495d67158e5920dd0b555f041c39edd}\label{sntp__client__misc_8c_af495d67158e5920dd0b555f041c39edd}} 
\index{sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}!sntp\+Client\+Close\+Connection@{sntp\+Client\+Close\+Connection}}
\index{sntp\+Client\+Close\+Connection@{sntp\+Client\+Close\+Connection}!sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{sntp\+Client\+Close\+Connection()}{sntpClientCloseConnection()}}
{\footnotesize\ttfamily void sntp\+Client\+Close\+Connection (\begin{DoxyParamCaption}\item[{\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Close U\+DP connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+TP client context \\
\hline
\end{DoxyParams}


Definition at line 85 of file sntp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
86 \{
87    \textcolor{comment}{//Valid socket?}
88    \textcolor{keywordflow}{if}(context->\hyperlink{structSntpClientContext_aa81b4c38e5803188b89f1d13473235b0}{socket} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
89    \{
90       \textcolor{comment}{//Close UDP socket}
91       \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(context->\hyperlink{structSntpClientContext_aa81b4c38e5803188b89f1d13473235b0}{socket});
92       context->\hyperlink{structSntpClientContext_aa81b4c38e5803188b89f1d13473235b0}{socket} = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
93    \}
94 \}
\end{DoxyCode}
\mbox{\Hypertarget{sntp__client__misc_8c_aee5e45bda3b95e43cef24c87f24e8ac4}\label{sntp__client__misc_8c_aee5e45bda3b95e43cef24c87f24e8ac4}} 
\index{sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}!sntp\+Client\+Dump\+Message@{sntp\+Client\+Dump\+Message}}
\index{sntp\+Client\+Dump\+Message@{sntp\+Client\+Dump\+Message}!sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{sntp\+Client\+Dump\+Message()}{sntpClientDumpMessage()}}
{\footnotesize\ttfamily void sntp\+Client\+Dump\+Message (\begin{DoxyParamCaption}\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{message,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Dump N\+TP message for debugging purpose. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Pointer to the N\+TP message \\
\hline
\mbox{\tt in}  & {\em length} & Length of the N\+TP message \\
\hline
\end{DoxyParams}


Definition at line 386 of file sntp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
387 \{
388 \textcolor{preprocessor}{#if (SNTP\_TRACE\_LEVEL >= TRACE\_LEVEL\_DEBUG)}
389    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} kissCode;
390    \textcolor{keyword}{const} \hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader} *header;
391    \textcolor{keyword}{const} \hyperlink{ntp__common_8h_a67afa0b50f9dbb601de9e23bc04146a3}{NtpAuthenticator} *auth;
392 
393    \textcolor{comment}{//Valid NTP packet?}
394    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} >= \textcolor{keyword}{sizeof}(\hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader}))
395    \{
396       \textcolor{comment}{//Point to the NTP packet header}
397       header = (\hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader} *) \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
398 
399       \textcolor{comment}{//Dump NTP message}
400       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Mode = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, header->mode);
401       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Version = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, header->vn);
402       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Leap indicator = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, header->li);
403       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Stratum = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, header->stratum);
404       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Poll = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, header->poll);
405       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Precision = %"} PRId8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, header->precision);
406       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Root Delay = %"} PRIu32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(header->rootDelay));
407       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Root Dispersion = %"} PRIu32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(header->rootDispersion));
408 
409       \textcolor{comment}{//Retrieve kiss code}
410       kissCode = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(header->referenceId);
411 
412       \textcolor{comment}{//Valid kiss code?}
413       \textcolor{keywordflow}{if}(isalnum((kissCode >> 24) & 0xFF) &&
414          isalnum((kissCode >> 16) & 0xFF) &&
415          isalnum((kissCode >> 8) & 0xFF) &&
416          isalnum(kissCode & 0xFF))
417       \{
418          \textcolor{comment}{//Dump kiss code}
419          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Kiss Code = '%c%c%c%c'\(\backslash\)r\(\backslash\)n"}, (kissCode >> 24) & 0xFF,
420             (kissCode >> 16) & 0xFF, (kissCode >> 8) & 0xFF, kissCode & 0xFF);
421       \}
422       \textcolor{keywordflow}{else}
423       \{
424          \textcolor{comment}{//Dump reference identifier}
425          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Reference Identifier = %"} PRIu32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"},
426             header->referenceId);
427       \}
428 
429       \textcolor{comment}{//Dump reference timestamp}
430       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  ReferenceTimestamp\(\backslash\)r\(\backslash\)n"});
431       \hyperlink{sntp__client__misc_8c_ad7919ecfaca5cd534c5976743c6320c2}{sntpClientDumpTimestamp}(&header->referenceTimestamp);
432 
433       \textcolor{comment}{//Dump originate timestamp}
434       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Originate Timestamp\(\backslash\)r\(\backslash\)n"});
435       \hyperlink{sntp__client__misc_8c_ad7919ecfaca5cd534c5976743c6320c2}{sntpClientDumpTimestamp}(&header->originateTimestamp);
436 
437       \textcolor{comment}{//Dump receive timestamp}
438       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Receive Timestamp\(\backslash\)r\(\backslash\)n"});
439       \hyperlink{sntp__client__misc_8c_ad7919ecfaca5cd534c5976743c6320c2}{sntpClientDumpTimestamp}(&header->receiveTimestamp);
440 
441       \textcolor{comment}{//Dump transmit timestamp}
442       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Transmit Timestamp\(\backslash\)r\(\backslash\)n"});
443       \hyperlink{sntp__client__misc_8c_ad7919ecfaca5cd534c5976743c6320c2}{sntpClientDumpTimestamp}(&header->transmitTimestamp);
444    \}
445 
446    \textcolor{comment}{//When the NTP authentication scheme is implemented, the Key Identifier}
447    \textcolor{comment}{//and Message Digest fields contain the message authentication code (MAC)}
448    \textcolor{comment}{//information}
449    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} >= (\textcolor{keyword}{sizeof}(\hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader}) + \textcolor{keyword}{sizeof}(\hyperlink{ntp__common_8h_a67afa0b50f9dbb601de9e23bc04146a3}{NtpAuthenticator})))
450    \{
451       \textcolor{comment}{//The Authenticator field is optional}
452       auth = (\hyperlink{ntp__common_8h_a67afa0b50f9dbb601de9e23bc04146a3}{NtpAuthenticator} *) (\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message} + \textcolor{keyword}{sizeof}(
      \hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader}));
453 
454       \textcolor{comment}{//Dump key identifier}
455       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Key Identifier = %"} PRIu32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(auth->keyId));
456 
457       \textcolor{comment}{//Dump message digest}
458       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Message Digest\(\backslash\)r\(\backslash\)n"});
459       \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"    "}, auth->messageDigest, 16);
460    \}
461 \textcolor{preprocessor}{#endif}
462 \}
\end{DoxyCode}
\mbox{\Hypertarget{sntp__client__misc_8c_ad7919ecfaca5cd534c5976743c6320c2}\label{sntp__client__misc_8c_ad7919ecfaca5cd534c5976743c6320c2}} 
\index{sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}!sntp\+Client\+Dump\+Timestamp@{sntp\+Client\+Dump\+Timestamp}}
\index{sntp\+Client\+Dump\+Timestamp@{sntp\+Client\+Dump\+Timestamp}!sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{sntp\+Client\+Dump\+Timestamp()}{sntpClientDumpTimestamp()}}
{\footnotesize\ttfamily void sntp\+Client\+Dump\+Timestamp (\begin{DoxyParamCaption}\item[{const \hyperlink{ntp__common_8h_a4b0bee470029fbe2a20b9d804bd15ab5}{Ntp\+Timestamp} $\ast$}]{timestamp }\end{DoxyParamCaption})}



Dump N\+TP timestamp. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em timestamp} & Pointer to the N\+TP timestamp \\
\hline
\end{DoxyParams}


Definition at line 470 of file sntp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
471 \{
472    \textcolor{comment}{//Dump seconds}
473    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"    Seconds = %"} PRIu32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(timestamp->seconds));
474    \textcolor{comment}{//Dump fraction field}
475    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"    Fraction = %"} PRIu32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(timestamp->fraction));
476 \}
\end{DoxyCode}
\mbox{\Hypertarget{sntp__client__misc_8c_a73106b6ab0a614ff867c1d9c8b03f16a}\label{sntp__client__misc_8c_a73106b6ab0a614ff867c1d9c8b03f16a}} 
\index{sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}!sntp\+Client\+Open\+Connection@{sntp\+Client\+Open\+Connection}}
\index{sntp\+Client\+Open\+Connection@{sntp\+Client\+Open\+Connection}!sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{sntp\+Client\+Open\+Connection()}{sntpClientOpenConnection()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} sntp\+Client\+Open\+Connection (\begin{DoxyParamCaption}\item[{\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Open U\+DP connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+TP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 56 of file sntp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
57 \{
58    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
59 
60    \textcolor{comment}{//Open a UDP socket}
61    context->\hyperlink{structSntpClientContext_aa81b4c38e5803188b89f1d13473235b0}{socket} = \hyperlink{socket_8c_aa139bbf42b326b52eb08cf52771ac337}{socketOpen}(\hyperlink{socket_8h_aa78c7398fa81f7f62aa233159d4d8d97a26963b01dac3a99a930779035d3796a7}{SOCKET\_TYPE\_DGRAM}, 
      \hyperlink{socket_8h_a56eb0e60bda5d1d8a2e702228405d969a53c45ffdb9dee4a8f885b816386a99b8}{SOCKET\_IP\_PROTO\_UDP});
62 
63    \textcolor{comment}{//Valid socket?}
64    \textcolor{keywordflow}{if}(context->\hyperlink{structSntpClientContext_aa81b4c38e5803188b89f1d13473235b0}{socket} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
65    \{
66       \textcolor{comment}{//Associate the socket with the relevant interface}
67       error = \hyperlink{net__legacy_8h_a80bc49fa99e5654d8c345cd5c70d36d3}{socketBindToInterface}(context->\hyperlink{structSntpClientContext_aa81b4c38e5803188b89f1d13473235b0}{socket}, context->
      \hyperlink{structSntpClientContext_a201932df4f0b97e8b837d05658fb1a48}{interface});
68    \}
69    \textcolor{keywordflow}{else}
70    \{
71       \textcolor{comment}{//Report an error}
72       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab721230e985e398cc0977dd729a12c61}{ERROR\_OPEN\_FAILED};
73    \}
74 
75    \textcolor{comment}{//Return status code}
76    \textcolor{keywordflow}{return} error;
77 \}
\end{DoxyCode}
\mbox{\Hypertarget{sntp__client__misc_8c_ae58e62ccf938f6dee79f204404d8a642}\label{sntp__client__misc_8c_ae58e62ccf938f6dee79f204404d8a642}} 
\index{sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}!sntp\+Client\+Parse\+Response@{sntp\+Client\+Parse\+Response}}
\index{sntp\+Client\+Parse\+Response@{sntp\+Client\+Parse\+Response}!sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{sntp\+Client\+Parse\+Response()}{sntpClientParseResponse()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} sntp\+Client\+Parse\+Response (\begin{DoxyParamCaption}\item[{\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$}]{context,  }\item[{\hyperlink{ntp__common_8h_a4b0bee470029fbe2a20b9d804bd15ab5}{Ntp\+Timestamp} $\ast$}]{timestamp }\end{DoxyParamCaption})}



Parse N\+TP server\textquotesingle{}s response. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+TP client context \\
\hline
\mbox{\tt out}  & {\em timestamp} & Pointer to the N\+TP timestamp \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 296 of file sntp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
298 \{
299    \hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader} *header;
300 
301    \textcolor{comment}{//Ensure the NTP packet is valid}
302    \textcolor{keywordflow}{if}(context->\hyperlink{structSntpClientContext_a488494d0644f9278a86389cb442aa49e}{messageLen} < \textcolor{keyword}{sizeof}(\hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader}))
303       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
304 
305    \textcolor{comment}{//Point to the NTP response}
306    header = (\hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader} *) context->\hyperlink{structSntpClientContext_a01d165c31bb0453f58841511183b37cc}{message};
307 
308    \textcolor{comment}{//Clear kiss code}
309    context->\hyperlink{structSntpClientContext_af69b89fcaec3ccf3949de106a1768c77}{kissCode} = 0;
310 
311    \textcolor{comment}{//Kiss-of-Death packet received?}
312    \textcolor{keywordflow}{if}(header->stratum == 0)
313    \{
314       \textcolor{comment}{//The kiss code is encoded in four-character ASCII strings left}
315       \textcolor{comment}{//justified and zero filled}
316       context->\hyperlink{structSntpClientContext_af69b89fcaec3ccf3949de106a1768c77}{kissCode} = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(header->referenceId);
317 
318       \textcolor{comment}{//An SNTP client should stop sending to a particular server if that}
319       \textcolor{comment}{//server returns a reply with a Stratum field of 0}
320       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac26eec5bbb83dd552d12e20de474b326}{ERROR\_REQUEST\_REJECTED};
321    \}
322 
323    \textcolor{comment}{//Extract NTP timestamp from server's response}
324    timestamp->seconds = \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(header->transmitTimestamp.seconds);
325    timestamp->fraction = \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(header->transmitTimestamp.fraction);
326 
327    \textcolor{comment}{//Successful processing}
328    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
329 \}
\end{DoxyCode}
\mbox{\Hypertarget{sntp__client__misc_8c_a483ec1f91330a633b15832853c5416d6}\label{sntp__client__misc_8c_a483ec1f91330a633b15832853c5416d6}} 
\index{sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}!sntp\+Client\+Receive\+Response@{sntp\+Client\+Receive\+Response}}
\index{sntp\+Client\+Receive\+Response@{sntp\+Client\+Receive\+Response}!sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{sntp\+Client\+Receive\+Response()}{sntpClientReceiveResponse()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} sntp\+Client\+Receive\+Response (\begin{DoxyParamCaption}\item[{\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Wait for N\+TP server\textquotesingle{}s response. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+TP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 162 of file sntp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
163 \{
164    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
165    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{tiger_8c_a5017152cac85e29a2dc5d8d74de9e07c}{t1};
166    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{tiger_8c_a42a80c4c472115c0fcb04a076526ecf5}{t2};
167    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
168    \hyperlink{structIpAddr}{IpAddr} \hyperlink{mib__common_8h_a3860e959b1b7dd73686a6e11424805e2}{ipAddr};
169    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port};
170 
171    \textcolor{comment}{//Get current time}
172    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
173 
174    \textcolor{comment}{//Compute request timeout}
175    \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(context->\hyperlink{structSntpClientContext_ae6aa657a6ac2d5a76fc8e026066fa77c}{startTime} + context->\hyperlink{structSntpClientContext_aeaec29fda82d9d620c9078d06a4d7b17}{timeout}, time) > 0)
176       t1 = context->\hyperlink{structSntpClientContext_ae6aa657a6ac2d5a76fc8e026066fa77c}{startTime} + context->\hyperlink{structSntpClientContext_aeaec29fda82d9d620c9078d06a4d7b17}{timeout} - \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
177    \textcolor{keywordflow}{else}
178       t1 = 0;
179 
180    \textcolor{comment}{//Compute retransmission timeout}
181    \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(context->\hyperlink{structSntpClientContext_a15b1f25abf336af057af833edb2ef979}{retransmitStartTime} + context->
      \hyperlink{structSntpClientContext_a09a8ebb9934b44dfbcca76edab7ceb76}{retransmitTimeout}, time) > 0)
182       t2 = context->\hyperlink{structSntpClientContext_a15b1f25abf336af057af833edb2ef979}{retransmitStartTime} + context->
      \hyperlink{structSntpClientContext_a09a8ebb9934b44dfbcca76edab7ceb76}{retransmitTimeout} - \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
183    \textcolor{keywordflow}{else}
184       t2 = 0;
185 
186    \textcolor{comment}{//Adjust receive timeout}
187    error = \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->\hyperlink{structSntpClientContext_aa81b4c38e5803188b89f1d13473235b0}{socket}, \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(t1, t2));
188 
189    \textcolor{comment}{//Check status code}
190    \textcolor{keywordflow}{if}(!error)
191    \{
192       \textcolor{comment}{//Wait for server's response}
193       error = \hyperlink{socket_8c_a26af4b642b71708e1408fc94483f90bb}{socketReceiveFrom}(context->\hyperlink{structSntpClientContext_aa81b4c38e5803188b89f1d13473235b0}{socket}, &ipAddr, &port,
194          context->\hyperlink{structSntpClientContext_a01d165c31bb0453f58841511183b37cc}{message}, \hyperlink{ntp__common_8h_a5820e5e5d218c5509145b98842d55c70}{NTP\_MAX\_MSG\_SIZE}, &context->
      \hyperlink{structSntpClientContext_a488494d0644f9278a86389cb442aa49e}{messageLen}, 0);
195    \}
196 
197    \textcolor{comment}{//Any datagram received?}
198    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
199    \{
200       \textcolor{comment}{//Check NTP response}
201       error = \hyperlink{sntp__client__misc_8c_a22215ba0c12d71e1132309151fea1a28}{sntpClientCheckResponse}(context, &ipAddr, port,
202          context->\hyperlink{structSntpClientContext_a01d165c31bb0453f58841511183b37cc}{message}, context->\hyperlink{structSntpClientContext_a488494d0644f9278a86389cb442aa49e}{messageLen});
203 
204       \textcolor{comment}{//Check status code}
205       \textcolor{keywordflow}{if}(!error)
206       \{
207          \textcolor{comment}{//A valid NTP response has been received}
208          context->\hyperlink{structSntpClientContext_af141be1c1ac01635b9788482dc791184}{state} = \hyperlink{sntp__client_8h_aeca73741bdca77b9eb50411f0c77136da6d083d60c47f1d0fadbb8db705aa8820}{SNTP\_CLIENT\_STATE\_COMPLETE};
209       \}
210       \textcolor{keywordflow}{else}
211       \{
212          \textcolor{comment}{//Silently discard invalid NTP packets}
213          error = \hyperlink{sntp__client__misc_8c_a6faf9bb1b15cb68afdb64507ad797673}{sntpClientCheckTimeout}(context);
214       \}
215    \}
216    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
217    \{
218       \textcolor{comment}{//Check whether the timeout has elapsed}
219       error = \hyperlink{sntp__client__misc_8c_a6faf9bb1b15cb68afdb64507ad797673}{sntpClientCheckTimeout}(context);
220    \}
221    \textcolor{keywordflow}{else}
222    \{
223       \textcolor{comment}{//A communication error has occured}
224    \}
225 
226    \textcolor{comment}{//Return status code}
227    \textcolor{keywordflow}{return} error;
228 \}
\end{DoxyCode}
\mbox{\Hypertarget{sntp__client__misc_8c_a6c9f4f0e97e4f052300b253bcb01dc0f}\label{sntp__client__misc_8c_a6c9f4f0e97e4f052300b253bcb01dc0f}} 
\index{sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}!sntp\+Client\+Send\+Request@{sntp\+Client\+Send\+Request}}
\index{sntp\+Client\+Send\+Request@{sntp\+Client\+Send\+Request}!sntp\+\_\+client\+\_\+misc.\+c@{sntp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{sntp\+Client\+Send\+Request()}{sntpClientSendRequest()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} sntp\+Client\+Send\+Request (\begin{DoxyParamCaption}\item[{\hyperlink{structSntpClientContext}{Sntp\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Send request to the N\+TP server. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+TP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 103 of file sntp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
104 \{
105    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
106    \hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader} *header;
107 
108    \textcolor{comment}{//Point to the buffer where to format the NTP message}
109    header = (\hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader} *) context->\hyperlink{structSntpClientContext_a01d165c31bb0453f58841511183b37cc}{message};
110 
111    \textcolor{comment}{//The client initializes the NTP message header. For this purpose, all}
112    \textcolor{comment}{//the NTP header fields are set to 0, except the Mode, VN, and optional}
113    \textcolor{comment}{//Transmit Timestamp fields}
114    memset(header, 0, \textcolor{keyword}{sizeof}(\hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader}));
115 
116    \textcolor{comment}{//Format NTP request}
117    header->vn = \hyperlink{ntp__common_8h_a430b10d3974bb9575eff7ec5dcc37e18a03d4aa2f5798384b217113cf76e87045}{NTP\_VERSION\_3};
118    header->mode = \hyperlink{ntp__common_8h_a5339531aa522fb037c8137a2f27da552a054404be1f74df66af5936341ee14d64}{NTP\_MODE\_CLIENT};
119 
120    \textcolor{comment}{//Time at which the NTP request was sent}
121    context->\hyperlink{structSntpClientContext_a15b1f25abf336af057af833edb2ef979}{retransmitStartTime} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
122 
123    \textcolor{comment}{//The Transmit Timestamp allows a simple calculation to determine the}
124    \textcolor{comment}{//propagation delay between the server and client and to align the system}
125    \textcolor{comment}{//clock generally within a few tens of milliseconds relative to the server}
126    header->transmitTimestamp.seconds = 0;
127    header->transmitTimestamp.fraction = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(context->\hyperlink{structSntpClientContext_a15b1f25abf336af057af833edb2ef979}{retransmitStartTime});
128 
129    \textcolor{comment}{//Length of the NTP request}
130    context->\hyperlink{structSntpClientContext_a488494d0644f9278a86389cb442aa49e}{messageLen} = \textcolor{keyword}{sizeof}(\hyperlink{ntp__common_8h_adffb5d103904e51ac01956c2a74e9c7e}{NtpHeader});
131 
132    \textcolor{comment}{//Debug message}
133    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending NTP request message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
134       context->\hyperlink{structSntpClientContext_a488494d0644f9278a86389cb442aa49e}{messageLen});
135 
136    \textcolor{comment}{//Dump the contents of the NTP message for debugging purpose}
137    \hyperlink{sntp__client__misc_8c_aee5e45bda3b95e43cef24c87f24e8ac4}{sntpClientDumpMessage}(context->\hyperlink{structSntpClientContext_a01d165c31bb0453f58841511183b37cc}{message}, context->
      \hyperlink{structSntpClientContext_a488494d0644f9278a86389cb442aa49e}{messageLen});
138 
139    \textcolor{comment}{//Send the request to the designated NTP server}
140    error = \hyperlink{socket_8c_a5985321fef9f287f84c4004aaa78920e}{socketSendTo}(context->\hyperlink{structSntpClientContext_aa81b4c38e5803188b89f1d13473235b0}{socket}, &context->
      \hyperlink{structSntpClientContext_a28000ab694ab2426a9cba5958e77cd2e}{serverIpAddr},
141       context->\hyperlink{structSntpClientContext_aea4ed19ae27784311580a393fe350705}{serverPort}, context->\hyperlink{structSntpClientContext_a01d165c31bb0453f58841511183b37cc}{message}, context->
      \hyperlink{structSntpClientContext_a488494d0644f9278a86389cb442aa49e}{messageLen},
142       \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 0);
143 
144    \textcolor{comment}{//Check status code}
145    \textcolor{keywordflow}{if}(!error)
146    \{
147       \textcolor{comment}{//Wait for server's response}
148       context->\hyperlink{structSntpClientContext_af141be1c1ac01635b9788482dc791184}{state} = \hyperlink{sntp__client_8h_aeca73741bdca77b9eb50411f0c77136dae3843b94899523529e54c4ae1222353c}{SNTP\_CLIENT\_STATE\_RECEIVING};
149    \}
150 
151    \textcolor{comment}{//Return status code}
152    \textcolor{keywordflow}{return} error;
153 \}
\end{DoxyCode}
