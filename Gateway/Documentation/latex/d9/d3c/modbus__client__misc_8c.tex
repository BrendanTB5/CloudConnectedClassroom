\hypertarget{modbus__client__misc_8c}{}\section{cyclone\+\_\+tcp/modbus/modbus\+\_\+client\+\_\+misc.c File Reference}
\label{modbus__client__misc_8c}\index{cyclone\+\_\+tcp/modbus/modbus\+\_\+client\+\_\+misc.\+c@{cyclone\+\_\+tcp/modbus/modbus\+\_\+client\+\_\+misc.\+c}}


Helper functions for Modbus/\+T\+CP client.  


{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+client\+\_\+pdu.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+client\+\_\+transport.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+client\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+debug.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{modbus__client__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_aa132de375069fd85fe54b72fe90f445f}{M\+O\+D\+B\+U\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__client__misc_8c_ac25fde56e74cd8409c114708958f7439}{modbus\+Client\+Transaction} (\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Perform Modbus transaction. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__client__misc_8c_aaff33481964bfd16f79469a6235820d7}{modbus\+Client\+Check\+Resp} (\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Check whether the received response matches the request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__client__misc_8c_acb2507388b42c35c5b798efbae04bea7}{modbus\+Client\+Format\+Mbap\+Header} (\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$context, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Format M\+B\+AP header. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__client__misc_8c_ae5f2e9441c2aca1f2b3d949f623ab4df}{modbus\+Client\+Parse\+Mbap\+Header} (\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Parse M\+B\+AP header. \end{DoxyCompactList}\item 
void $\ast$ \hyperlink{modbus__client__misc_8c_acd0d7bb7f621eb8b0d8d37c2d2cc8e42}{modbus\+Client\+Get\+Request\+Pdu} (\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Retrieve request P\+DU. \end{DoxyCompactList}\item 
void $\ast$ \hyperlink{modbus__client__misc_8c_ac190f02d3cb9e1882240d7de4587092a}{modbus\+Client\+Get\+Response\+Pdu} (\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$context, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Retrieve response P\+DU. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__client__misc_8c_af527bcdeb9340f03e495ccaba8b65187}{modbus\+Client\+Check\+Timeout} (\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Determine whether a timeout error has occurred. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Helper functions for Modbus/\+T\+CP client. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{modbus__client__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{modbus__client__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_aa132de375069fd85fe54b72fe90f445f}{M\+O\+D\+B\+U\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file modbus\+\_\+client\+\_\+misc.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{modbus__client__misc_8c_aaff33481964bfd16f79469a6235820d7}\label{modbus__client__misc_8c_aaff33481964bfd16f79469a6235820d7}} 
\index{modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}!modbus\+Client\+Check\+Resp@{modbus\+Client\+Check\+Resp}}
\index{modbus\+Client\+Check\+Resp@{modbus\+Client\+Check\+Resp}!modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Client\+Check\+Resp()}{modbusClientCheckResp()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Client\+Check\+Resp (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Check whether the received response matches the request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Modbus/\+T\+CP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 211 of file modbus\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
212 \{
213    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
214    \hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *requestHeader;
215    \hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *responseHeader;
216 
217    \textcolor{comment}{//Malformed request?}
218    \textcolor{keywordflow}{if}(context->requestAduLen < (\textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}) + \textcolor{keyword}{sizeof}(
      \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t})))
219       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
220 
221    \textcolor{comment}{//Malformed response?}
222    \textcolor{keywordflow}{if}(context->responseAduLen < (\textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}) + \textcolor{keyword}{sizeof}(
      \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t})))
223       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
224 
225    \textcolor{comment}{//Point to the MBAP header of the Modbus request}
226    requestHeader = (\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *) context->requestAdu;
227    \textcolor{comment}{//Point to the MBAP header of the Modbus response}
228    responseHeader = (\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *) context->responseAdu;
229 
230    \textcolor{comment}{//Check transaction identifier}
231    \textcolor{keywordflow}{if}(responseHeader->transactionId != requestHeader->transactionId)
232       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca2bc2298123e24e3d82592b5c68c20612}{ERROR\_WRONG\_IDENTIFIER};
233 
234    \textcolor{comment}{//Check unit identifier}
235    \textcolor{keywordflow}{if}(responseHeader->unitId != requestHeader->unitId)
236       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
237 
238    \textcolor{comment}{//Check function code}
239    \textcolor{keywordflow}{if}((responseHeader->pdu[0] & \hyperlink{modbus__common_8h_a3537f53a00870fe94c5a3453eaec0775}{MODBUS\_FUNCTION\_CODE\_MASK}) !=
240       (requestHeader->pdu[0] & \hyperlink{modbus__common_8h_a3537f53a00870fe94c5a3453eaec0775}{MODBUS\_FUNCTION\_CODE\_MASK}))
241    \{
242       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
243    \}
244 
245    \textcolor{comment}{//Exception response?}
246    \textcolor{keywordflow}{if}(responseHeader->pdu[0] & \hyperlink{modbus__common_8h_ab61e7a8d3e7254830873c58f657c460c}{MODBUS\_EXCEPTION\_MASK})
247    \{
248       \textcolor{comment}{//If the server receives the request without a communication error,}
249       \textcolor{comment}{//but cannot handle it, the server will return an exception response}
250       \textcolor{comment}{//informing the client of the nature of the error}
251       error = \hyperlink{modbus__client__pdu_8c_a8f5e0fe62aa8de28a7fad79c147b7f95}{modbusClientParseExceptionResp}(context);
252    \}
253    \textcolor{keywordflow}{else}
254    \{
255       \textcolor{comment}{//A normal response has been received}
256       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
257    \}
258 
259    \textcolor{comment}{//Return status code}
260    \textcolor{keywordflow}{return} error;
261 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__client__misc_8c_af527bcdeb9340f03e495ccaba8b65187}\label{modbus__client__misc_8c_af527bcdeb9340f03e495ccaba8b65187}} 
\index{modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}!modbus\+Client\+Check\+Timeout@{modbus\+Client\+Check\+Timeout}}
\index{modbus\+Client\+Check\+Timeout@{modbus\+Client\+Check\+Timeout}!modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Client\+Check\+Timeout()}{modbusClientCheckTimeout()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Client\+Check\+Timeout (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Determine whether a timeout error has occurred. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Modbus/\+T\+CP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 413 of file modbus\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
414 \{
415 \textcolor{preprocessor}{#if (NET\_RTOS\_SUPPORT == DISABLED)}
416    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
417    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
418 
419    \textcolor{comment}{//Get current time}
420    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
421 
422    \textcolor{comment}{//Check whether the timeout has elapsed}
423    \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, context->timestamp + context->timeout) >= 0)
424    \{
425       \textcolor{comment}{//Report a timeout error}
426       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT};
427    \}
428    \textcolor{keywordflow}{else}
429    \{
430       \textcolor{comment}{//The operation would block}
431       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK};
432    \}
433 
434    \textcolor{comment}{//Return status code}
435    \textcolor{keywordflow}{return} error;
436 \textcolor{preprocessor}{#else}
437    \textcolor{comment}{//Report a timeout error}
438    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT};
439 \textcolor{preprocessor}{#endif}
440 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__client__misc_8c_acb2507388b42c35c5b798efbae04bea7}\label{modbus__client__misc_8c_acb2507388b42c35c5b798efbae04bea7}} 
\index{modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}!modbus\+Client\+Format\+Mbap\+Header@{modbus\+Client\+Format\+Mbap\+Header}}
\index{modbus\+Client\+Format\+Mbap\+Header@{modbus\+Client\+Format\+Mbap\+Header}!modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Client\+Format\+Mbap\+Header()}{modbusClientFormatMbapHeader()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Client\+Format\+Mbap\+Header (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$}]{context,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Format M\+B\+AP header. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Modbus/\+T\+CP client context \\
\hline
\mbox{\tt in}  & {\em length} & Length of the P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 271 of file modbus\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
273 \{
274    \hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *header;
275 
276    \textcolor{comment}{//Point to the beginning of the request ADU}
277    header = (\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *) context->requestAdu;
278 
279    \textcolor{comment}{//The transaction identifier is used to uniquely identify the matching}
280    \textcolor{comment}{//requests and responses}
281    context->transactionId++;
282 
283    \textcolor{comment}{//Format MBAP header}
284    header->transactionId = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(context->transactionId);
285    header->protocolId = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{modbus__common_8h_a92758c6251edab8a886e0aae9601166a}{MODBUS\_PROTOCOL\_ID});
286    header->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} + \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}));
287    header->unitId = context->unitId;
288 
289    \textcolor{comment}{//Compute the length of the request ADU}
290    context->requestAduLen = \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} + \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader});
291 
292    \textcolor{comment}{//Debug message}
293    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Modbus Client: Sending ADU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
294       context->requestAduLen);
295 
296    \textcolor{comment}{//Dump MBAP header}
297    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Transaction ID = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(header->transactionId));
298    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Protocol ID = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(header->protocolId));
299    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Length = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(header->length));
300    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Unit ID = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, header->unitId);
301 
302    \textcolor{comment}{//Rewind to the beginning of the transmit buffer}
303    context->requestAduPos = 0;
304    \textcolor{comment}{//Save current time}
305    context->timestamp = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
306    \textcolor{comment}{//Send the request ADU to the server}
307    context->state = \hyperlink{modbus__client_8h_af9e4aa6eb4ddde054d9f23f72b3fb3fda0277ca3aa14d4a942d45da1478f79267}{MODBUS\_CLIENT\_STATE\_SENDING};
308 
309    \textcolor{comment}{//Successful processing}
310    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
311 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__client__misc_8c_acd0d7bb7f621eb8b0d8d37c2d2cc8e42}\label{modbus__client__misc_8c_acd0d7bb7f621eb8b0d8d37c2d2cc8e42}} 
\index{modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}!modbus\+Client\+Get\+Request\+Pdu@{modbus\+Client\+Get\+Request\+Pdu}}
\index{modbus\+Client\+Get\+Request\+Pdu@{modbus\+Client\+Get\+Request\+Pdu}!modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Client\+Get\+Request\+Pdu()}{modbusClientGetRequestPdu()}}
{\footnotesize\ttfamily void$\ast$ modbus\+Client\+Get\+Request\+Pdu (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Retrieve request P\+DU. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Modbus/\+T\+CP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Pointer to the request P\+DU 
\end{DoxyReturn}


Definition at line 375 of file modbus\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
376 \{
377    \textcolor{comment}{//Point to the request PDU}
378    \textcolor{keywordflow}{return} context->requestAdu + \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader});
379 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__client__misc_8c_ac190f02d3cb9e1882240d7de4587092a}\label{modbus__client__misc_8c_ac190f02d3cb9e1882240d7de4587092a}} 
\index{modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}!modbus\+Client\+Get\+Response\+Pdu@{modbus\+Client\+Get\+Response\+Pdu}}
\index{modbus\+Client\+Get\+Response\+Pdu@{modbus\+Client\+Get\+Response\+Pdu}!modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Client\+Get\+Response\+Pdu()}{modbusClientGetResponsePdu()}}
{\footnotesize\ttfamily void$\ast$ modbus\+Client\+Get\+Response\+Pdu (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$}]{context,  }\item[{size\+\_\+t $\ast$}]{length }\end{DoxyParamCaption})}



Retrieve response P\+DU. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Modbus/\+T\+CP client context \\
\hline
\mbox{\tt out}  & {\em length} & Length of the response P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Pointer to the response P\+DU 
\end{DoxyReturn}


Definition at line 389 of file modbus\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
390 \{
391    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *responsePdu;
392 
393    \textcolor{comment}{//Point to the response PDU}
394    responsePdu = context->responseAdu + \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader});
395 
396    \textcolor{comment}{//Retrieve the length of the PDU}
397    \textcolor{keywordflow}{if}(context->responseAduLen >= \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}))
398       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = context->responseAduLen - \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader});
399    \textcolor{keywordflow}{else}
400       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = 0;
401 
402    \textcolor{comment}{//Return a pointer to the response PDU}
403    \textcolor{keywordflow}{return} responsePdu;
404 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__client__misc_8c_ae5f2e9441c2aca1f2b3d949f623ab4df}\label{modbus__client__misc_8c_ae5f2e9441c2aca1f2b3d949f623ab4df}} 
\index{modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}!modbus\+Client\+Parse\+Mbap\+Header@{modbus\+Client\+Parse\+Mbap\+Header}}
\index{modbus\+Client\+Parse\+Mbap\+Header@{modbus\+Client\+Parse\+Mbap\+Header}!modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Client\+Parse\+Mbap\+Header()}{modbusClientParseMbapHeader()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Client\+Parse\+Mbap\+Header (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Parse M\+B\+AP header. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Modbus/\+T\+CP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 320 of file modbus\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
321 \{
322    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
323    \hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *header;
324 
325    \textcolor{comment}{//Sanity check}
326    \textcolor{keywordflow}{if}(context->responseAduPos < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}))
327       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
328 
329    \textcolor{comment}{//Point to the beginning of the response ADU}
330    header = (\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *) context->responseAdu;
331 
332    \textcolor{comment}{//The length field is a byte count of the following fields, including the}
333    \textcolor{comment}{//unit identifier and data fields}
334    n = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(header->length);
335 
336    \textcolor{comment}{//Malformed Modbus response?}
337    \textcolor{keywordflow}{if}(n < \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}))
338       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
339 
340    \textcolor{comment}{//Retrieve the length of the PDU}
341    n -= \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t});
342 
343    \textcolor{comment}{//Debug message}
344    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Modbus Client: ADU received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
345       \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}) + n);
346 
347    \textcolor{comment}{//Dump MBAP header}
348    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Transaction ID = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(header->transactionId));
349    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Protocol ID = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(header->protocolId));
350    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Length = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(header->length));
351    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Unit ID = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, header->unitId);
352 
353    \textcolor{comment}{//Check protocol identifier}
354    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(header->protocolId) != \hyperlink{modbus__common_8h_a92758c6251edab8a886e0aae9601166a}{MODBUS\_PROTOCOL\_ID})
355       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca2bc2298123e24e3d82592b5c68c20612}{ERROR\_WRONG\_IDENTIFIER};
356 
357    \textcolor{comment}{//The length of the Modbus PDU is limited to 253 bytes}
358    \textcolor{keywordflow}{if}(n > \hyperlink{modbus__common_8h_af6dd61317e85109e7c854e40eeb039f5}{MODBUS\_MAX\_PDU\_SIZE})
359       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
360 
361    \textcolor{comment}{//Compute the length of the response ADU}
362    context->responseAduLen = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}) + n;
363 
364    \textcolor{comment}{//Successful processing}
365    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
366 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__client__misc_8c_ac25fde56e74cd8409c114708958f7439}\label{modbus__client__misc_8c_ac25fde56e74cd8409c114708958f7439}} 
\index{modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}!modbus\+Client\+Transaction@{modbus\+Client\+Transaction}}
\index{modbus\+Client\+Transaction@{modbus\+Client\+Transaction}!modbus\+\_\+client\+\_\+misc.\+c@{modbus\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Client\+Transaction()}{modbusClientTransaction()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Client\+Transaction (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__client_8h_afb534cba0b839b960b7afd907b978713}{Modbus\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Perform Modbus transaction. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Modbus/\+T\+CP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 52 of file modbus\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
53 \{
54    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
55    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
56    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
57    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{modbus__common_8h_abc72fe7576ac2f623a0b5bc54a8b0f1e}{pdu};
58 
59    \textcolor{comment}{//Initialize status code}
60    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
61 
62    \textcolor{comment}{//Get current time}
63    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
64 
65    \textcolor{comment}{//Adjust timeout}
66    \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(context->timestamp + context->timeout, time) > 0)
67    \{
68       \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->socket, context->timestamp +
69          context->timeout - time);
70    \}
71    \textcolor{keywordflow}{else}
72    \{
73       \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->socket, 0);
74    \}
75 
76    \textcolor{comment}{//Check current state}
77    \textcolor{keywordflow}{if}(context->state == \hyperlink{modbus__client_8h_af9e4aa6eb4ddde054d9f23f72b3fb3fda0277ca3aa14d4a942d45da1478f79267}{MODBUS\_CLIENT\_STATE\_SENDING})
78    \{
79       \textcolor{comment}{//Send Modbus request}
80       \textcolor{keywordflow}{if}(context->requestAduPos < context->requestAduLen)
81       \{
82          \textcolor{comment}{//Send more data}
83          error = \hyperlink{modbus__client__transport_8c_a85972acaa06cd757074fcf5fe8f73936}{modbusClientSendData}(context,
84             context->requestAdu + context->requestAduPos,
85             context->requestAduLen - context->requestAduPos,
86             &n, \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a2a3399f24cd678390ebf586c4ffefc8c}{SOCKET\_FLAG\_NO\_DELAY});
87 
88          \textcolor{comment}{//Check status code}
89          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
90          \{
91             \textcolor{comment}{//Advance data pointer}
92             context->requestAduPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
93          \}
94       \}
95       \textcolor{keywordflow}{else}
96       \{
97          \textcolor{comment}{//Flush receive buffer}
98          context->responseAduLen = 0;
99          context->responseAduPos = 0;
100 
101          \textcolor{comment}{//Wait for response ADU}
102          context->state = \hyperlink{modbus__client_8h_af9e4aa6eb4ddde054d9f23f72b3fb3fda9748b537005fc36f8dd4cb4b396703bf}{MODBUS\_CLIENT\_STATE\_RECEIVING};
103       \}
104    \}
105    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{modbus__client_8h_af9e4aa6eb4ddde054d9f23f72b3fb3fda9748b537005fc36f8dd4cb4b396703bf}{MODBUS\_CLIENT\_STATE\_RECEIVING})
106    \{
107       \textcolor{comment}{//Receive Modbus response}
108       \textcolor{keywordflow}{if}(context->responseAduPos < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}))
109       \{
110          \textcolor{comment}{//Receive more data}
111          error = \hyperlink{modbus__client__transport_8c_a68d9f4b1a68260fb83012565ae86e94a}{modbusClientReceiveData}(context,
112             context->responseAdu + context->responseAduPos,
113             \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}) - context->responseAduPos, &n, 0);
114 
115          \textcolor{comment}{//Check status code}
116          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
117          \{
118             \textcolor{comment}{//Advance data pointer}
119             context->responseAduPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
120 
121             \textcolor{comment}{//MBAP header successfully received?}
122             \textcolor{keywordflow}{if}(context->responseAduPos >= \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}))
123             \{
124                \textcolor{comment}{//Parse MBAP header}
125                error = \hyperlink{modbus__client__misc_8c_ae5f2e9441c2aca1f2b3d949f623ab4df}{modbusClientParseMbapHeader}(context);
126             \}
127          \}
128       \}
129       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->responseAduPos < context->responseAduLen)
130       \{
131          \textcolor{comment}{//Receive more data}
132          error = \hyperlink{modbus__client__transport_8c_a68d9f4b1a68260fb83012565ae86e94a}{modbusClientReceiveData}(context,
133             context->responseAdu + context->responseAduPos,
134             context->responseAduLen - context->responseAduPos, &n, 0);
135 
136          \textcolor{comment}{//Check status code}
137          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
138          \{
139             \textcolor{comment}{//Advance data pointer}
140             context->responseAduPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
141          \}
142       \}
143       \textcolor{keywordflow}{else}
144       \{
145          \textcolor{comment}{//Point to the Modbus response PDU}
146          pdu = \hyperlink{modbus__client__misc_8c_ac190f02d3cb9e1882240d7de4587092a}{modbusClientGetResponsePdu}(context, &n);
147 
148          \textcolor{comment}{//Debug message}
149          \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Client: Response PDU received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      n);
150          \textcolor{comment}{//Dump the contents of the PDU for debugging purpose}
151          \hyperlink{modbus__debug_8c_a56d568c9a4e450ea4be0275521ba09b7}{modbusDumpResponsePdu}(pdu, n);
152 
153          \textcolor{comment}{//Check whether the received response matches the request}
154          error = \hyperlink{modbus__client__misc_8c_aaff33481964bfd16f79469a6235820d7}{modbusClientCheckResp}(context);
155 
156          \textcolor{comment}{//Check status code}
157          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
158          \{
159             \textcolor{comment}{//If the transaction identifier refers to a pending transaction,}
160             \textcolor{comment}{//the response must be parsed in order to send a confirmation to}
161             \textcolor{comment}{//the user application}
162             context->state = \hyperlink{modbus__client_8h_af9e4aa6eb4ddde054d9f23f72b3fb3fda5623f903086a8d5c77f628c81007db64}{MODBUS\_CLIENT\_STATE\_COMPLETE};
163          \}
164          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca2bc2298123e24e3d82592b5c68c20612}{ERROR\_WRONG\_IDENTIFIER})
165          \{
166             \textcolor{comment}{//If the transaction identifier does not refer to any pending}
167             \textcolor{comment}{//transaction, the response must be discarded}
168             context->responseAduLen = 0;
169             context->responseAduPos = 0;
170 
171             \textcolor{comment}{//Catch exception}
172             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
173          \}
174          \textcolor{keywordflow}{else}
175          \{
176             \textcolor{comment}{//A protocol error has occurred}
177          \}
178       \}
179    \}
180    \textcolor{keywordflow}{else}
181    \{
182       \textcolor{comment}{//Report an error}
183       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
184    \}
185 
186    \textcolor{comment}{//Check status code}
187    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
188    \{
189       \textcolor{comment}{//Check whether the timeout has elapsed}
190       error = \hyperlink{modbus__client__misc_8c_af527bcdeb9340f03e495ccaba8b65187}{modbusClientCheckTimeout}(context);
191    \}
192 
193    \textcolor{comment}{//Modbus transaction failed?}
194    \textcolor{keywordflow}{if}(error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} && error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK})
195    \{
196       \textcolor{comment}{//Revert to default state}
197       context->state = \hyperlink{modbus__client_8h_af9e4aa6eb4ddde054d9f23f72b3fb3fda1387eb84ed026967f245481eb6b17ee4}{MODBUS\_CLIENT\_STATE\_CONNECTED};
198    \}
199 
200    \textcolor{comment}{//Return status code}
201    \textcolor{keywordflow}{return} error;
202 \}
\end{DoxyCode}
