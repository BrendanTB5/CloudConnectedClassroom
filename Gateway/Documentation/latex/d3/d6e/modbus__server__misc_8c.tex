\hypertarget{modbus__server__misc_8c}{}\section{cyclone\+\_\+tcp/modbus/modbus\+\_\+server\+\_\+misc.c File Reference}
\label{modbus__server__misc_8c}\index{cyclone\+\_\+tcp/modbus/modbus\+\_\+server\+\_\+misc.\+c@{cyclone\+\_\+tcp/modbus/modbus\+\_\+server\+\_\+misc.\+c}}


Helper functions for Modbus/\+T\+CP server.  


{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+server.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+server\+\_\+pdu.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+server\+\_\+security.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+server\+\_\+transport.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+server\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{modbus__server__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_aa132de375069fd85fe54b72fe90f445f}{M\+O\+D\+B\+U\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{modbus__server__misc_8c_a839382ddf99808cd6d4c3ea3afe34083}{modbus\+Server\+Tick} (\hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{Modbus\+Server\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Handle periodic operations. \end{DoxyCompactList}\item 
void \hyperlink{modbus__server__misc_8c_a9d1e16a5acf533e708f0d7e240bca868}{modbus\+Server\+Process\+Connection\+Events} (\hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{Modbus\+Server\+Context} $\ast$context, \hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Connection event handler. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__misc_8c_a75a8e9241bbfe09cdcb68da442a2de9a}{modbus\+Server\+Parse\+Mbap\+Header} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Parse request M\+B\+AP header. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}{modbus\+Server\+Format\+Mbap\+Header} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Format response M\+B\+AP header. \end{DoxyCompactList}\item 
void $\ast$ \hyperlink{modbus__server__misc_8c_abe2e4dc73cd1260eb2bbbc7862c13a91}{modbus\+Server\+Get\+Request\+Pdu} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Retrieve request P\+DU. \end{DoxyCompactList}\item 
void $\ast$ \hyperlink{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}{modbus\+Server\+Get\+Response\+Pdu} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Retrieve response P\+DU. \end{DoxyCompactList}\item 
void \hyperlink{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}{modbus\+Server\+Lock} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Lock Modbus table. \end{DoxyCompactList}\item 
void \hyperlink{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}{modbus\+Server\+Unlock} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Unlock Modbus table. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__misc_8c_abd6a4ec07d872ffd8165b1b20f670d52}{modbus\+Server\+Read\+Coil} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address}, \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} $\ast$state)
\begin{DoxyCompactList}\small\item\em Get coil state. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__misc_8c_a8377f33fbff980a2b4ae0e361ca427b0}{modbus\+Server\+Read\+Discrete\+Input} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address}, \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} $\ast$state)
\begin{DoxyCompactList}\small\item\em Get discrete input state. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__misc_8c_a64f402c2e18183ee2eece59ed7e552f2}{modbus\+Server\+Write\+Coil} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address}, \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} state, \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} commit)
\begin{DoxyCompactList}\small\item\em Set coil state. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__misc_8c_aa21275a0aedb09f8232538300dfe5c12}{modbus\+Server\+Read\+Holding\+Reg} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} $\ast$\hyperlink{chap_8h_adfa040d04d16520129a735fff8fb1628}{value})
\begin{DoxyCompactList}\small\item\em Get holding register value. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__misc_8c_a9a0997751459063835bc76ef41bf51b2}{modbus\+Server\+Read\+Input\+Reg} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} $\ast$\hyperlink{chap_8h_adfa040d04d16520129a735fff8fb1628}{value})
\begin{DoxyCompactList}\small\item\em Get input register value. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__misc_8c_a1f56a7850a7fa591bab6c1b6764a9f09}{modbus\+Server\+Write\+Reg} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{chap_8h_adfa040d04d16520129a735fff8fb1628}{value}, \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} commit)
\begin{DoxyCompactList}\small\item\em Set register value. \end{DoxyCompactList}\item 
\hyperlink{modbus__common_8h_a0b7f726dfaa2b4cf98aaaed1eb42fa72}{Modbus\+Exception\+Code} \hyperlink{modbus__server__misc_8c_a30545bfadafe40e691b671a1978c09c0}{modbus\+Server\+Translate\+Exception\+Code} (\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} status)
\begin{DoxyCompactList}\small\item\em Translate exception code. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Helper functions for Modbus/\+T\+CP server. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{modbus__server__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{modbus__server__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_aa132de375069fd85fe54b72fe90f445f}{M\+O\+D\+B\+U\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file modbus\+\_\+server\+\_\+misc.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}\label{modbus__server__misc_8c_a2ad3351726fbd7d8f4da2727d4fd057a}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Format\+Mbap\+Header@{modbus\+Server\+Format\+Mbap\+Header}}
\index{modbus\+Server\+Format\+Mbap\+Header@{modbus\+Server\+Format\+Mbap\+Header}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Format\+Mbap\+Header()}{modbusServerFormatMbapHeader()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Format\+Mbap\+Header (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Format response M\+B\+AP header. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em length} & Length of the P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 309 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
311 \{
312    \hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *requestHeader;
313    \hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *responseHeader;
314 
315    \textcolor{comment}{//Sanity check}
316    \textcolor{keywordflow}{if}(connection->requestAduPos < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}))
317       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
318 
319    \textcolor{comment}{//Point to the beginning of the request ADU}
320    requestHeader = (\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *) connection->requestAdu;
321    \textcolor{comment}{//Point to the beginning of the response ADU}
322    responseHeader = (\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *) connection->responseAdu;
323 
324    \textcolor{comment}{//Format MBAP header}
325    responseHeader->transactionId = requestHeader->transactionId;
326    responseHeader->protocolId = requestHeader->protocolId;
327    responseHeader->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} + \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}));
328    responseHeader->unitId = requestHeader->unitId;
329 
330    \textcolor{comment}{//Compute the length of the response ADU}
331    connection->responseAduLen = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}) + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
332 
333    \textcolor{comment}{//Debug message}
334    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Modbus Server: Sending ADU (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
335       connection->responseAduLen);
336 
337    \textcolor{comment}{//Dump MBAP header}
338    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Transaction ID = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(responseHeader->transactionId));
339    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Protocol ID = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(responseHeader->protocolId));
340    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Length = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(responseHeader->length));
341    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Unit ID = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, responseHeader->unitId);
342 
343    \textcolor{comment}{//Rewind to the beginning of the transmit buffer}
344    connection->responseAduPos = 0;
345    \textcolor{comment}{//Send the response ADU to the client}
346    connection->state = \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbca1ca6f65bfb319297513e97e29860d88e}{MODBUS\_CONNECTION\_STATE\_SEND};
347 
348    \textcolor{comment}{//Successful processing}
349    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
350 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_abe2e4dc73cd1260eb2bbbc7862c13a91}\label{modbus__server__misc_8c_abe2e4dc73cd1260eb2bbbc7862c13a91}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Get\+Request\+Pdu@{modbus\+Server\+Get\+Request\+Pdu}}
\index{modbus\+Server\+Get\+Request\+Pdu@{modbus\+Server\+Get\+Request\+Pdu}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Get\+Request\+Pdu()}{modbusServerGetRequestPdu()}}
{\footnotesize\ttfamily void$\ast$ modbus\+Server\+Get\+Request\+Pdu (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{size\+\_\+t $\ast$}]{length }\end{DoxyParamCaption})}



Retrieve request P\+DU. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt out}  & {\em length} & Length request the request P\+DU, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Pointer to the request P\+DU 
\end{DoxyReturn}


Definition at line 360 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
362 \{
363    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *requestPdu;
364 
365    \textcolor{comment}{//Point to the request PDU}
366    requestPdu = connection->requestAdu + \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader});
367 
368    \textcolor{comment}{//Retrieve the length of the PDU}
369    \textcolor{keywordflow}{if}(connection->requestAduLen >= \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}))
370       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = connection->requestAduLen - \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader});
371    \textcolor{keywordflow}{else}
372       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = 0;
373 
374    \textcolor{comment}{//Return a pointer to the request PDU}
375    \textcolor{keywordflow}{return} requestPdu;
376 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}\label{modbus__server__misc_8c_a77e0cd21034af560dc44a46f8a6ab78f}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Get\+Response\+Pdu@{modbus\+Server\+Get\+Response\+Pdu}}
\index{modbus\+Server\+Get\+Response\+Pdu@{modbus\+Server\+Get\+Response\+Pdu}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Get\+Response\+Pdu()}{modbusServerGetResponsePdu()}}
{\footnotesize\ttfamily void$\ast$ modbus\+Server\+Get\+Response\+Pdu (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Retrieve response P\+DU. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Pointer to the response P\+DU 
\end{DoxyReturn}


Definition at line 385 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
386 \{
387    \textcolor{comment}{//Point to the response PDU}
388    \textcolor{keywordflow}{return} connection->responseAdu + \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader});
389 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}\label{modbus__server__misc_8c_afc6c2c6eb7ce8839d9fbc373b7026b88}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Lock@{modbus\+Server\+Lock}}
\index{modbus\+Server\+Lock@{modbus\+Server\+Lock}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Lock()}{modbusServerLock()}}
{\footnotesize\ttfamily void modbus\+Server\+Lock (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Lock Modbus table. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}


Definition at line 397 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
398 \{
399    \hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{ModbusServerContext} *context;
400 
401    \textcolor{comment}{//Point to the Modbus/TCP server context}
402    context = connection->context;
403 
404    \textcolor{comment}{//Any registered callback?}
405    \textcolor{keywordflow}{if}(context->settings.lockCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
406    \{
407       \textcolor{comment}{//Invoke user callback function}
408       context->settings.lockCallback();
409    \}
410 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_a75a8e9241bbfe09cdcb68da442a2de9a}\label{modbus__server__misc_8c_a75a8e9241bbfe09cdcb68da442a2de9a}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Parse\+Mbap\+Header@{modbus\+Server\+Parse\+Mbap\+Header}}
\index{modbus\+Server\+Parse\+Mbap\+Header@{modbus\+Server\+Parse\+Mbap\+Header}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Parse\+Mbap\+Header()}{modbusServerParseMbapHeader()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Parse\+Mbap\+Header (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Parse request M\+B\+AP header. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 251 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
252 \{
253    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
254    \hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *requestHeader;
255 
256    \textcolor{comment}{//Sanity check}
257    \textcolor{keywordflow}{if}(connection->requestAduPos < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}))
258       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
259 
260    \textcolor{comment}{//Point to the beginning of the request ADU}
261    requestHeader = (\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader} *) connection->requestAdu;
262 
263    \textcolor{comment}{//The length field is a byte count of the following fields, including}
264    \textcolor{comment}{//the unit identifier and data fields}
265    n = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(requestHeader->length);
266 
267    \textcolor{comment}{//Malformed Modbus request?}
268    \textcolor{keywordflow}{if}(n < \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}))
269       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
270 
271    \textcolor{comment}{//Retrieve the length of the PDU}
272    n -= \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t});
273 
274    \textcolor{comment}{//Debug message}
275    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)nModbus Server: ADU received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
276       \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}) + n);
277 
278    \textcolor{comment}{//Dump MBAP header}
279    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Transaction ID = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(requestHeader->transactionId));
280    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Protocol ID = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(requestHeader->protocolId));
281    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Length = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(requestHeader->length));
282    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Unit ID = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, requestHeader->unitId);
283 
284    \textcolor{comment}{//Check protocol identifier}
285    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(requestHeader->protocolId) != \hyperlink{modbus__common_8h_a92758c6251edab8a886e0aae9601166a}{MODBUS\_PROTOCOL\_ID})
286       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca2bc2298123e24e3d82592b5c68c20612}{ERROR\_WRONG\_IDENTIFIER};
287 
288    \textcolor{comment}{//The length of the Modbus PDU is limited to 253 bytes}
289    \textcolor{keywordflow}{if}(n > \hyperlink{modbus__common_8h_af6dd61317e85109e7c854e40eeb039f5}{MODBUS\_MAX\_PDU\_SIZE})
290       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
291 
292    \textcolor{comment}{//Save unit identifier}
293    connection->requestUnitId = requestHeader->unitId;
294    \textcolor{comment}{//Compute the length of the request ADU}
295    connection->requestAduLen = \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}) + n;
296 
297    \textcolor{comment}{//Successful processing}
298    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
299 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_a9d1e16a5acf533e708f0d7e240bca868}\label{modbus__server__misc_8c_a9d1e16a5acf533e708f0d7e240bca868}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Process\+Connection\+Events@{modbus\+Server\+Process\+Connection\+Events}}
\index{modbus\+Server\+Process\+Connection\+Events@{modbus\+Server\+Process\+Connection\+Events}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Process\+Connection\+Events()}{modbusServerProcessConnectionEvents()}}
{\footnotesize\ttfamily void modbus\+Server\+Process\+Connection\+Events (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{Modbus\+Server\+Context} $\ast$}]{context,  }\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Connection event handler. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Modbus/\+T\+CP server context \\
\hline
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}


Definition at line 88 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
90 \{
91    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
92    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
93 
94    \textcolor{comment}{//Initialize status code}
95    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
96 
97    \textcolor{comment}{//Update time stamp}
98    connection->timestamp = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
99 
100    \textcolor{comment}{//Check the state of the connection}
101    \textcolor{keywordflow}{if}(connection->state == \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbca6c28a65402d48838ba46c3b4895aea2a}{MODBUS\_CONNECTION\_STATE\_CONNECT\_TLS})
102    \{
103 \textcolor{preprocessor}{#if (MODBUS\_SERVER\_TLS\_SUPPORT == ENABLED)}
104       \textcolor{comment}{//Perform TLS handshake}
105       error = \hyperlink{modbus__server__security_8c_afc0b4a729eae06ddd2602f161897ee75}{modbusServerEstablishSecureConnection}(connection);
106 
107       \textcolor{comment}{//Check status code}
108       \textcolor{keywordflow}{if}(!error)
109       \{
110          \textcolor{comment}{//Wait for incoming Modbus requests}
111          connection->state = \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbca695ff92b63e218a16af678dfb23d39fe}{MODBUS\_CONNECTION\_STATE\_RECEIVE};
112       \}
113 \textcolor{preprocessor}{#else}
114       \textcolor{comment}{//Modbus/TCP security is not implemented}
115       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
116 \textcolor{preprocessor}{#endif}
117    \}
118    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->state == \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbca695ff92b63e218a16af678dfb23d39fe}{MODBUS\_CONNECTION\_STATE\_RECEIVE})
119    \{
120       \textcolor{comment}{//Receive Modbus request}
121       \textcolor{keywordflow}{if}(connection->requestAduPos < \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}))
122       \{
123          \textcolor{comment}{//Receive more data}
124          error = \hyperlink{modbus__server__transport_8c_ac42714d64ead5f741c3167181de09121}{modbusServerReceiveData}(connection,
125             connection->requestAdu + connection->requestAduPos,
126             \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}) - connection->requestAduPos, &n, 0);
127 
128          \textcolor{comment}{//Check status code}
129          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
130          \{
131             \textcolor{comment}{//Advance data pointer}
132             connection->requestAduPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
133 
134             \textcolor{comment}{//MBAP header successfully received?}
135             \textcolor{keywordflow}{if}(connection->requestAduPos >= \textcolor{keyword}{sizeof}(\hyperlink{modbus__common_8h_a4bcab4566d36cce8cd1ca1ba064d7b7b}{ModbusHeader}))
136             \{
137                \textcolor{comment}{//Parse MBAP header}
138                error = \hyperlink{modbus__server__misc_8c_a75a8e9241bbfe09cdcb68da442a2de9a}{modbusServerParseMbapHeader}(connection);
139             \}
140          \}
141          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca8b7223773301a4f3dd811f1d35e13ce4}{ERROR\_END\_OF\_STREAM})
142          \{
143             \textcolor{comment}{//Initiate a graceful connection shutdown}
144             error = \hyperlink{modbus__server__transport_8c_a5bd75a54a1ae882e617c6aaadb3fa2b7}{modbusServerShutdownConnection}(connection);
145          \}
146          \textcolor{keywordflow}{else}
147          \{
148             \textcolor{comment}{//Just for sanity}
149          \}
150       \}
151       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->requestAduPos < connection->requestAduLen)
152       \{
153          \textcolor{comment}{//Receive more data}
154          error = \hyperlink{modbus__server__transport_8c_ac42714d64ead5f741c3167181de09121}{modbusServerReceiveData}(connection,
155             connection->requestAdu + connection->requestAduPos,
156             connection->requestAduLen - connection->requestAduPos, &n, 0);
157 
158          \textcolor{comment}{//Check status code}
159          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
160          \{
161             \textcolor{comment}{//Advance data pointer}
162             connection->requestAduPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
163 
164             \textcolor{comment}{//Modbus request successfully received?}
165             \textcolor{keywordflow}{if}(connection->requestAduPos >= connection->requestAduLen)
166             \{
167                \textcolor{comment}{//Check unit identifier}
168                \textcolor{keywordflow}{if}(context->settings.unitId == 0 ||
169                   context->settings.unitId == 255 ||
170                   context->settings.unitId == connection->requestUnitId)
171                \{
172                   \textcolor{comment}{//Process Modbus request}
173                   error = \hyperlink{modbus__server__pdu_8c_abd690a574433bb829e14d0b441231e92}{modbusServerProcessRequest}(connection);
174                \}
175             \}
176          \}
177       \}
178       \textcolor{keywordflow}{else}
179       \{
180          \textcolor{comment}{//Just for sanity}
181          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
182       \}
183    \}
184    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->state == \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbca1ca6f65bfb319297513e97e29860d88e}{MODBUS\_CONNECTION\_STATE\_SEND})
185    \{
186       \textcolor{comment}{//Send Modbus response}
187       \textcolor{keywordflow}{if}(connection->responseAduPos < connection->responseAduLen)
188       \{
189          \textcolor{comment}{//Send more data}
190          error = \hyperlink{modbus__server__transport_8c_ac9ac428565a9d3386974118b5f392731}{modbusServerSendData}(connection,
191             connection->responseAdu + connection->responseAduPos,
192             connection->responseAduLen - connection->responseAduPos,
193             &n, \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a2a3399f24cd678390ebf586c4ffefc8c}{SOCKET\_FLAG\_NO\_DELAY});
194 
195          \textcolor{comment}{//Check status code}
196          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
197          \{
198             \textcolor{comment}{//Advance data pointer}
199             connection->responseAduPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
200 
201             \textcolor{comment}{//Modbus response successfully sent?}
202             \textcolor{keywordflow}{if}(connection->responseAduPos >= connection->responseAduLen)
203             \{
204                \textcolor{comment}{//Flush receive buffer}
205                connection->requestAduLen = 0;
206                connection->requestAduPos = 0;
207 
208                \textcolor{comment}{//Wait for the next Modbus request}
209                connection->state = \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbca695ff92b63e218a16af678dfb23d39fe}{MODBUS\_CONNECTION\_STATE\_RECEIVE};
210             \}
211          \}
212       \}
213       \textcolor{keywordflow}{else}
214       \{
215          \textcolor{comment}{//Just for sanity}
216          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
217       \}
218    \}
219    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->state == \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbca71d3d4f43ce3f104b57faecd7f13f00d}{MODBUS\_CONNECTION\_STATE\_SHUTDOWN\_TLS} ||
220       connection->state == \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbcadce5cb26624490f2c00f0fcb745ec8e7}{MODBUS\_CONNECTION\_STATE\_SHUTDOWN\_TX})
221    \{
222       \textcolor{comment}{//Graceful connection shutdown}
223       error = \hyperlink{modbus__server__transport_8c_a5bd75a54a1ae882e617c6aaadb3fa2b7}{modbusServerShutdownConnection}(connection);
224    \}
225    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->state == \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbcaa138bd6f722ab8588e3b5e8e0d3b4420}{MODBUS\_CONNECTION\_STATE\_SHUTDOWN\_RX})
226    \{
227       \textcolor{comment}{//Close the Modbus/TCP connection}
228       \hyperlink{modbus__server__transport_8c_a9e14f681b81e91e9dfbe259c4bd63c04}{modbusServerCloseConnection}(connection);
229    \}
230    \textcolor{keywordflow}{else}
231    \{
232       \textcolor{comment}{//Invalid state}
233       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
234    \}
235 
236    \textcolor{comment}{//Any communication error?}
237    \textcolor{keywordflow}{if}(error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} && error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
238    \{
239       \textcolor{comment}{//Close the Modbus/TCP connection}
240       \hyperlink{modbus__server__transport_8c_a9e14f681b81e91e9dfbe259c4bd63c04}{modbusServerCloseConnection}(connection);
241    \}
242 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_abd6a4ec07d872ffd8165b1b20f670d52}\label{modbus__server__misc_8c_abd6a4ec07d872ffd8165b1b20f670d52}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Read\+Coil@{modbus\+Server\+Read\+Coil}}
\index{modbus\+Server\+Read\+Coil@{modbus\+Server\+Read\+Coil}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Read\+Coil()}{modbusServerReadCoil()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Read\+Coil (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{address,  }\item[{\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} $\ast$}]{state }\end{DoxyParamCaption})}



Get coil state. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em address} & Coil address \\
\hline
\mbox{\tt out}  & {\em state} & Current coil state \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 442 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
444 \{
445    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
446    \hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{ModbusServerContext} *context;
447 
448    \textcolor{comment}{//Point to the Modbus/TCP server context}
449    context = connection->context;
450 
451    \textcolor{comment}{//Any registered callback?}
452    \textcolor{keywordflow}{if}(context->settings.readCoilCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
453    \{
454       \textcolor{comment}{//Invoke user callback function}
455       error = context->settings.readCoilCallback(connection->role, \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address},
456          state);
457    \}
458    \textcolor{keywordflow}{else}
459    \{
460       \textcolor{comment}{//Report an error}
461       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
462    \}
463 
464    \textcolor{comment}{//Return status code}
465    \textcolor{keywordflow}{return} error;
466 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_a8377f33fbff980a2b4ae0e361ca427b0}\label{modbus__server__misc_8c_a8377f33fbff980a2b4ae0e361ca427b0}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Read\+Discrete\+Input@{modbus\+Server\+Read\+Discrete\+Input}}
\index{modbus\+Server\+Read\+Discrete\+Input@{modbus\+Server\+Read\+Discrete\+Input}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Read\+Discrete\+Input()}{modbusServerReadDiscreteInput()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Read\+Discrete\+Input (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{address,  }\item[{\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} $\ast$}]{state }\end{DoxyParamCaption})}



Get discrete input state. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em address} & Coil address \\
\hline
\mbox{\tt out}  & {\em state} & Current coil state \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 477 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
479 \{
480    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
481    \hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{ModbusServerContext} *context;
482 
483    \textcolor{comment}{//Point to the Modbus/TCP server context}
484    context = connection->context;
485 
486    \textcolor{comment}{//Any registered callback?}
487    \textcolor{keywordflow}{if}(context->settings.readDiscreteInputCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
488    \{
489       \textcolor{comment}{//Invoke user callback function}
490       error = context->settings.readDiscreteInputCallback(connection->role,
491          \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address}, state);
492    \}
493    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.readCoilCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
494    \{
495       \textcolor{comment}{//Invoke user callback function}
496       error = context->settings.readCoilCallback(connection->role, \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address},
497          state);
498    \}
499    \textcolor{keywordflow}{else}
500    \{
501       \textcolor{comment}{//Report an error}
502       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
503    \}
504 
505    \textcolor{comment}{//Return status code}
506    \textcolor{keywordflow}{return} error;
507 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_aa21275a0aedb09f8232538300dfe5c12}\label{modbus__server__misc_8c_aa21275a0aedb09f8232538300dfe5c12}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Read\+Holding\+Reg@{modbus\+Server\+Read\+Holding\+Reg}}
\index{modbus\+Server\+Read\+Holding\+Reg@{modbus\+Server\+Read\+Holding\+Reg}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Read\+Holding\+Reg()}{modbusServerReadHoldingReg()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Read\+Holding\+Reg (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{address,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} $\ast$}]{value }\end{DoxyParamCaption})}



Get holding register value. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em address} & Register address \\
\hline
\mbox{\tt out}  & {\em value} & Current register value \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 555 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
557 \{
558    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
559    \hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{ModbusServerContext} *context;
560 
561    \textcolor{comment}{//Point to the Modbus/TCP server context}
562    context = connection->context;
563 
564    \textcolor{comment}{//Any registered callback?}
565    \textcolor{keywordflow}{if}(context->settings.readHoldingRegCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
566    \{
567       \textcolor{comment}{//Invoke user callback function}
568       error = context->settings.readHoldingRegCallback(connection->role,
569          \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address}, \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value});
570    \}
571    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.readRegCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
572    \{
573       \textcolor{comment}{//Invoke user callback function}
574       error = context->settings.readRegCallback(connection->role, \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address},
575          \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value});
576    \}
577    \textcolor{keywordflow}{else}
578    \{
579       \textcolor{comment}{//Report an error}
580       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
581    \}
582 
583    \textcolor{comment}{//Return status code}
584    \textcolor{keywordflow}{return} error;
585 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_a9a0997751459063835bc76ef41bf51b2}\label{modbus__server__misc_8c_a9a0997751459063835bc76ef41bf51b2}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Read\+Input\+Reg@{modbus\+Server\+Read\+Input\+Reg}}
\index{modbus\+Server\+Read\+Input\+Reg@{modbus\+Server\+Read\+Input\+Reg}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Read\+Input\+Reg()}{modbusServerReadInputReg()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Read\+Input\+Reg (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{address,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} $\ast$}]{value }\end{DoxyParamCaption})}



Get input register value. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em address} & Register address \\
\hline
\mbox{\tt out}  & {\em value} & Current register value \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 596 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
598 \{
599    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
600    \hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{ModbusServerContext} *context;
601 
602    \textcolor{comment}{//Point to the Modbus/TCP server context}
603    context = connection->context;
604 
605    \textcolor{comment}{//Any registered callback?}
606    \textcolor{keywordflow}{if}(context->settings.readInputRegCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
607    \{
608       \textcolor{comment}{//Invoke user callback function}
609       error = context->settings.readInputRegCallback(connection->role,
610          \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address}, \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value});
611    \}
612    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.readRegCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
613    \{
614       \textcolor{comment}{//Invoke user callback function}
615       error = context->settings.readRegCallback(connection->role, \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address},
616          \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value});
617    \}
618    \textcolor{keywordflow}{else}
619    \{
620       \textcolor{comment}{//Report an error}
621       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
622    \}
623 
624    \textcolor{comment}{//Return status code}
625    \textcolor{keywordflow}{return} error;
626 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_a839382ddf99808cd6d4c3ea3afe34083}\label{modbus__server__misc_8c_a839382ddf99808cd6d4c3ea3afe34083}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Tick@{modbus\+Server\+Tick}}
\index{modbus\+Server\+Tick@{modbus\+Server\+Tick}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Tick()}{modbusServerTick()}}
{\footnotesize\ttfamily void modbus\+Server\+Tick (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{Modbus\+Server\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Handle periodic operations. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Modbus/\+T\+CP server context \\
\hline
\end{DoxyParams}


Definition at line 51 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
52 \{
53    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
54    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
55    \hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{ModbusClientConnection} *connection;
56 
57    \textcolor{comment}{//Get current time}
58    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
59 
60    \textcolor{comment}{//Loop through the connection table}
61    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{modbus__server_8h_ae256368c84a889cda6e1e67109c23ee6}{MODBUS\_SERVER\_MAX\_CONNECTIONS}; i++)
62    \{
63       \textcolor{comment}{//Point to the current entry}
64       connection = &context->connection[i];
65 
66       \textcolor{comment}{//Check the state of the current connection}
67       \textcolor{keywordflow}{if}(connection->state != \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbcafd635128f09907421773ddeaf15196bb}{MODBUS\_CONNECTION\_STATE\_CLOSED})
68       \{
69          \textcolor{comment}{//Disconnect inactive client after idle timeout}
70          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, connection->timestamp + 
      \hyperlink{modbus__server_8h_a499c34fda45ee3411764d3da3900233e}{MODBUS\_SERVER\_TIMEOUT}) >= 0)
71          \{
72             \textcolor{comment}{//Debug message}
73             \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus server: Closing inactive connection...\(\backslash\)r\(\backslash\)n"});
74             \textcolor{comment}{//Close the Modbus/TCP connection}
75             \hyperlink{modbus__server__transport_8c_a9e14f681b81e91e9dfbe259c4bd63c04}{modbusServerCloseConnection}(connection);
76          \}
77       \}
78    \}
79 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_a30545bfadafe40e691b671a1978c09c0}\label{modbus__server__misc_8c_a30545bfadafe40e691b671a1978c09c0}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Translate\+Exception\+Code@{modbus\+Server\+Translate\+Exception\+Code}}
\index{modbus\+Server\+Translate\+Exception\+Code@{modbus\+Server\+Translate\+Exception\+Code}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Translate\+Exception\+Code()}{modbusServerTranslateExceptionCode()}}
{\footnotesize\ttfamily \hyperlink{modbus__common_8h_a0b7f726dfaa2b4cf98aaaed1eb42fa72}{Modbus\+Exception\+Code} modbus\+Server\+Translate\+Exception\+Code (\begin{DoxyParamCaption}\item[{\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t}}]{status }\end{DoxyParamCaption})}



Translate exception code. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em status} & Status code \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Exception code 
\end{DoxyReturn}


Definition at line 672 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
673 \{
674    \hyperlink{modbus__common_8h_a0b7f726dfaa2b4cf98aaaed1eb42fa72}{ModbusExceptionCode} \hyperlink{modbus__common_8h_a87000e9fd18fc68c309200e9abe4bb68}{exceptionCode};
675 
676    \textcolor{comment}{//Check status code}
677    \textcolor{keywordflow}{switch}(status)
678    \{
679    \textcolor{keywordflow}{case} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca1b349e84bdbdf3372adce06ef426b735}{ERROR\_INVALID\_FUNCTION\_CODE}:
680       \textcolor{comment}{//The function code received in the query is not an allowable action}
681       \textcolor{comment}{//for the server}
682       exceptionCode = \hyperlink{modbus__common_8h_a0b7f726dfaa2b4cf98aaaed1eb42fa72ab82b03e8308d8b59dbfe9ab65f1384ab}{MODBUS\_EXCEPTION\_ILLEGAL\_FUNCTION};
683       \textcolor{keywordflow}{break};
684    \textcolor{keywordflow}{case} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS}:
685       \textcolor{comment}{//The data address received in the query is not an allowable address}
686       \textcolor{comment}{//for the server}
687       exceptionCode = \hyperlink{modbus__common_8h_a0b7f726dfaa2b4cf98aaaed1eb42fa72a680b30f0c30b63efe7a4789779b8cbc2}{MODBUS\_EXCEPTION\_ILLEGAL\_DATA\_ADDRESS};
688       \textcolor{keywordflow}{break};
689    \textcolor{keywordflow}{case} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca979424b1dc1779fe6193ab5161329513}{ERROR\_INVALID\_VALUE}:
690       \textcolor{comment}{//A value contained in the query data field is not an allowable value}
691       \textcolor{comment}{//for the server}
692       exceptionCode = \hyperlink{modbus__common_8h_a0b7f726dfaa2b4cf98aaaed1eb42fa72a430fae73907652578aacb8a8ea3dc93a}{MODBUS\_EXCEPTION\_ILLEGAL\_DATA\_VALUE};
693       \textcolor{keywordflow}{break};
694    \textcolor{keywordflow}{case} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cad277e4824b55c91dc5e9ff4f177ba208}{ERROR\_DEVICE\_BUSY}:
695       \textcolor{comment}{//The client should retransmit the message later when the server is free}
696       exceptionCode = \hyperlink{modbus__common_8h_a0b7f726dfaa2b4cf98aaaed1eb42fa72a5327456038e020b7601bf66d86f22409}{MODBUS\_EXCEPTION\_SLAVE\_DEVICE\_BUSY};
697       \textcolor{keywordflow}{break};
698    \textcolor{keywordflow}{default}:
699       \textcolor{comment}{//An unrecoverable error occurred while the server was attempting to}
700       \textcolor{comment}{//perform the requested action}
701       exceptionCode = \hyperlink{modbus__common_8h_a0b7f726dfaa2b4cf98aaaed1eb42fa72a6d9e3787be9fde135e42fa8a837b540d}{MODBUS\_EXCEPTION\_SLAVE\_DEVICE\_FAILURE};
702       \textcolor{keywordflow}{break};
703    \}
704 
705    \textcolor{comment}{//Return exception code}
706    \textcolor{keywordflow}{return} \hyperlink{modbus__common_8h_a87000e9fd18fc68c309200e9abe4bb68}{exceptionCode};
707 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}\label{modbus__server__misc_8c_aa3520e73846f8b853d4154207ca913cc}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Unlock@{modbus\+Server\+Unlock}}
\index{modbus\+Server\+Unlock@{modbus\+Server\+Unlock}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Unlock()}{modbusServerUnlock()}}
{\footnotesize\ttfamily void modbus\+Server\+Unlock (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Unlock Modbus table. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}


Definition at line 418 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
419 \{
420    \hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{ModbusServerContext} *context;
421 
422    \textcolor{comment}{//Point to the Modbus/TCP server context}
423    context = connection->context;
424 
425    \textcolor{comment}{//Any registered callback?}
426    \textcolor{keywordflow}{if}(context->settings.lockCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
427    \{
428       \textcolor{comment}{//Invoke user callback function}
429       context->settings.unlockCallback();
430    \}
431 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_a64f402c2e18183ee2eece59ed7e552f2}\label{modbus__server__misc_8c_a64f402c2e18183ee2eece59ed7e552f2}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Write\+Coil@{modbus\+Server\+Write\+Coil}}
\index{modbus\+Server\+Write\+Coil@{modbus\+Server\+Write\+Coil}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Write\+Coil()}{modbusServerWriteCoil()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Write\+Coil (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{address,  }\item[{\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t}}]{state,  }\item[{\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t}}]{commit }\end{DoxyParamCaption})}



Set coil state. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em address} & Address of the coil \\
\hline
\mbox{\tt in}  & {\em state} & Desired coil state \\
\hline
\mbox{\tt in}  & {\em commit} & This flag indicates the current phase (validation phase or write phase if the validation was successful) \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 520 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
522 \{
523    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
524    \hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{ModbusServerContext} *context;
525 
526    \textcolor{comment}{//Point to the Modbus/TCP server context}
527    context = connection->context;
528 
529    \textcolor{comment}{//Any registered callback?}
530    \textcolor{keywordflow}{if}(context->settings.writeCoilCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
531    \{
532       \textcolor{comment}{//Invoke user callback function}
533       error = context->settings.writeCoilCallback(connection->role, \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address},
534          state, commit);
535    \}
536    \textcolor{keywordflow}{else}
537    \{
538       \textcolor{comment}{//Report an error}
539       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
540    \}
541 
542    \textcolor{comment}{//Return status code}
543    \textcolor{keywordflow}{return} error;
544 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__misc_8c_a1f56a7850a7fa591bab6c1b6764a9f09}\label{modbus__server__misc_8c_a1f56a7850a7fa591bab6c1b6764a9f09}} 
\index{modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}!modbus\+Server\+Write\+Reg@{modbus\+Server\+Write\+Reg}}
\index{modbus\+Server\+Write\+Reg@{modbus\+Server\+Write\+Reg}!modbus\+\_\+server\+\_\+misc.\+c@{modbus\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Write\+Reg()}{modbusServerWriteReg()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Write\+Reg (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{address,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{value,  }\item[{\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t}}]{commit }\end{DoxyParamCaption})}



Set register value. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em address} & Register address \\
\hline
\mbox{\tt in}  & {\em value} & Desired register value \\
\hline
\mbox{\tt in}  & {\em commit} & This flag indicates the current phase (validation phase or write phase if the validation was successful) \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 639 of file modbus\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
641 \{
642    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
643    \hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{ModbusServerContext} *context;
644 
645    \textcolor{comment}{//Point to the Modbus/TCP server context}
646    context = connection->context;
647 
648    \textcolor{comment}{//Any registered callback?}
649    \textcolor{keywordflow}{if}(context->settings.writeRegCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
650    \{
651       \textcolor{comment}{//Invoke user callback function}
652       error = context->settings.writeRegCallback(connection->role, \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address},
653          \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value}, commit);
654    \}
655    \textcolor{keywordflow}{else}
656    \{
657       \textcolor{comment}{//Report an error}
658       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
659    \}
660 
661    \textcolor{comment}{//Return status code}
662    \textcolor{keywordflow}{return} error;
663 \}
\end{DoxyCode}
