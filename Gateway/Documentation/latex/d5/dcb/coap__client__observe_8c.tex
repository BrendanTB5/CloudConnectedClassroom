\hypertarget{coap__client__observe_8c}{}\section{cyclone\+\_\+tcp/coap/coap\+\_\+client\+\_\+observe.c File Reference}
\label{coap__client__observe_8c}\index{cyclone\+\_\+tcp/coap/coap\+\_\+client\+\_\+observe.\+c@{cyclone\+\_\+tcp/coap/coap\+\_\+client\+\_\+observe.\+c}}


Co\+AP observe.  


{\ttfamily \#include $<$stdlib.\+h$>$}\newline
{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}coap/coap\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}coap/coap\+\_\+client\+\_\+observe.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}coap/coap\+\_\+client\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}error.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{coap__client__observe_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_a7725033334034dcb4eb808f148f791fb}{C\+O\+A\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{coap__client__observe_8c_adc6fc309da18ce4890fadf2f7acb9dff}{coap\+Client\+Process\+Notification} (\hyperlink{coap__client_8h_a3dac6728ded461f458ffd870eca7afe7}{Coap\+Client\+Request} $\ast$request, const \hyperlink{structCoapMessage}{Coap\+Message} $\ast$response)
\begin{DoxyCompactList}\small\item\em Process notification response. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} \hyperlink{coap__client__observe_8c_a1aab261e07010f49e6b1e5015f491e68}{coap\+Client\+Check\+Sequence\+Number} (\hyperlink{coap__client_8h_a3dac6728ded461f458ffd870eca7afe7}{Coap\+Client\+Request} $\ast$request, \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} v2, \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t} \hyperlink{pic32mz_2isr__support_8h_a2d14ee35cd552c730fe5c5864082226e}{t2})
\begin{DoxyCompactList}\small\item\em Check the order of arrival for incoming notification. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Co\+AP observe. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{coap__client__observe_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{coap__client__observe_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{coap\+\_\+client\+\_\+observe.\+c@{coap\+\_\+client\+\_\+observe.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!coap\+\_\+client\+\_\+observe.\+c@{coap\+\_\+client\+\_\+observe.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_a7725033334034dcb4eb808f148f791fb}{C\+O\+A\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file coap\+\_\+client\+\_\+observe.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{coap__client__observe_8c_a1aab261e07010f49e6b1e5015f491e68}\label{coap__client__observe_8c_a1aab261e07010f49e6b1e5015f491e68}} 
\index{coap\+\_\+client\+\_\+observe.\+c@{coap\+\_\+client\+\_\+observe.\+c}!coap\+Client\+Check\+Sequence\+Number@{coap\+Client\+Check\+Sequence\+Number}}
\index{coap\+Client\+Check\+Sequence\+Number@{coap\+Client\+Check\+Sequence\+Number}!coap\+\_\+client\+\_\+observe.\+c@{coap\+\_\+client\+\_\+observe.\+c}}
\subsubsection{\texorpdfstring{coap\+Client\+Check\+Sequence\+Number()}{coapClientCheckSequenceNumber()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} coap\+Client\+Check\+Sequence\+Number (\begin{DoxyParamCaption}\item[{\hyperlink{coap__client_8h_a3dac6728ded461f458ffd870eca7afe7}{Coap\+Client\+Request} $\ast$}]{request,  }\item[{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t}}]{v2,  }\item[{\hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t}}]{t2 }\end{DoxyParamCaption})}



Check the order of arrival for incoming notification. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em request} & Co\+AP request handle \\
\hline
\mbox{\tt in}  & {\em v2} & Value of the Observe option in the incoming notification \\
\hline
\mbox{\tt in}  & {\em t2} & Client-\/local timestamp for the incoming notification \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
T\+R\+UE if the incoming notification was sent more recently than the freshest notification so far. Otherwise F\+A\+L\+SE is returned 
\end{DoxyReturn}


Definition at line 133 of file coap\+\_\+client\+\_\+observe.\+c.


\begin{DoxyCode}
135 \{
136    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} \hyperlink{pic32mx_2isr__support_8h_aafd40fe8ac88a1eabd8379d8bda0ecb2}{v1};
137    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{tiger_8c_a5017152cac85e29a2dc5d8d74de9e07c}{t1};
138    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} valid;
139 
140    \textcolor{comment}{//Check current state}
141    \textcolor{keywordflow}{if}(request->state != \hyperlink{coap__client__request_8h_ae23250f18b3b2a3d2dc7dc98cc664d04a08c3e3ce4b37f7db53eeea653fa15e1d}{COAP\_REQ\_STATE\_OBSERVE})
142    \{
143       \textcolor{comment}{//The first notification has been received}
144       valid = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
145    \}
146    \textcolor{keywordflow}{else}
147    \{
148       \textcolor{comment}{//Value of the Observe option in the freshest notification so far}
149       v1 = request->observeSeqNum;
150       \textcolor{comment}{//Client-local timestamp for the freshest notification so far}
151       t1 = request->retransmitStartTime;
152 
153       \textcolor{comment}{//An incoming notification was sent more recently than the freshest}
154       \textcolor{comment}{//notification so far when one of the following conditions is met}
155       \textcolor{keywordflow}{if}(v1 < v2 && (v2 - v1) < 0x00800000)
156       \{
157          \textcolor{comment}{//V1 is less than V2 in 24-bit serial number arithmetic}
158          valid = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
159       \}
160       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(v1 > v2 && (v1 - v2) > 0x00800000)
161       \{
162          \textcolor{comment}{//V1 is less than V2 in 24-bit serial number arithmetic}
163          valid = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
164       \}
165       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(\hyperlink{tiger_8c_a42a80c4c472115c0fcb04a076526ecf5}{t2}, t1 + 128000) > 0)
166       \{
167          \textcolor{comment}{//After 128 seconds have elapsed without any notification, a client}
168          \textcolor{comment}{//does not need to check the sequence numbers to assume that an}
169          \textcolor{comment}{//incoming notification was sent more recently than the freshest}
170          \textcolor{comment}{//notification it has received so far}
171          valid = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
172       \}
173       \textcolor{keywordflow}{else}
174       \{
175          \textcolor{comment}{//An out-of-order sequence number has been detected}
176          valid = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
177       \}
178    \}
179 
180    \textcolor{comment}{//Return TRUE if the incoming notification was sent more recently than the}
181    \textcolor{comment}{//freshest notification so far}
182    \textcolor{keywordflow}{return} valid;
183 \}
\end{DoxyCode}
\mbox{\Hypertarget{coap__client__observe_8c_adc6fc309da18ce4890fadf2f7acb9dff}\label{coap__client__observe_8c_adc6fc309da18ce4890fadf2f7acb9dff}} 
\index{coap\+\_\+client\+\_\+observe.\+c@{coap\+\_\+client\+\_\+observe.\+c}!coap\+Client\+Process\+Notification@{coap\+Client\+Process\+Notification}}
\index{coap\+Client\+Process\+Notification@{coap\+Client\+Process\+Notification}!coap\+\_\+client\+\_\+observe.\+c@{coap\+\_\+client\+\_\+observe.\+c}}
\subsubsection{\texorpdfstring{coap\+Client\+Process\+Notification()}{coapClientProcessNotification()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} coap\+Client\+Process\+Notification (\begin{DoxyParamCaption}\item[{\hyperlink{coap__client_8h_a3dac6728ded461f458ffd870eca7afe7}{Coap\+Client\+Request} $\ast$}]{request,  }\item[{const \hyperlink{structCoapMessage}{Coap\+Message} $\ast$}]{response }\end{DoxyParamCaption})}



Process notification response. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em request} & Co\+AP request handle \\
\hline
\mbox{\tt in}  & {\em response} & Pointer to the response message \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 54 of file coap\+\_\+client\+\_\+observe.\+c.


\begin{DoxyCode}
56 \{
57    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
58    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
59    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
60 
61    \textcolor{comment}{//The only difference between a notification and a normal response}
62    \textcolor{comment}{//is the presence of the Observe option}
63    error = \hyperlink{coap__option_8c_a4098de0a9fbec04954546ce1978572d9}{coapGetUintOption}(response, \hyperlink{coap__option_8h_ab833642841b9ddc4cab90acf5cffb0e7ac327e2341a2ed78310270fa285b0a7d9}{COAP\_OPT\_OBSERVE}, 0, &value);
64 
65    \textcolor{comment}{//Observe option included in the response?}
66    \textcolor{keywordflow}{if}(!error)
67    \{
68       \textcolor{comment}{//Get current time}
69       time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
70 
71       \textcolor{comment}{//Check the order of arrival for incoming notification}
72       \textcolor{keywordflow}{if}(\hyperlink{coap__client__observe_8c_a1aab261e07010f49e6b1e5015f491e68}{coapClientCheckSequenceNumber}(request, value, time))
73       \{
74          \textcolor{comment}{//Save the value of the Observe option}
75          request->observeSeqNum = \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
76          \textcolor{comment}{//Save the time at which the notification was received}
77          request->retransmitStartTime = \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
78 
79          \textcolor{comment}{//Search the CoAP response for a Max-Age option}
80          error = \hyperlink{coap__option_8c_a4098de0a9fbec04954546ce1978572d9}{coapGetUintOption}(response, \hyperlink{coap__option_8h_ab833642841b9ddc4cab90acf5cffb0e7ae1d2594f4e92d466cd196de5656aa449}{COAP\_OPT\_MAX\_AGE}, 0, &value);
81 
82          \textcolor{comment}{//Max-Age option not included in the response?}
83          \textcolor{keywordflow}{if}(error)
84          \{
85             \textcolor{comment}{//A default value of 60 seconds is assumed in the absence of the}
86             \textcolor{comment}{//option in a response}
87             value = \hyperlink{coap__option_8h_a171a87c853e3bd8ecc0d0bcd84cf3fc7}{COAP\_DEFAULT\_MAX\_AGE};
88          \}
89 
90          \textcolor{comment}{//A notification is considered fresh while its age is not greater}
91          \textcolor{comment}{//than the value indicated by the Max-Age option}
92          request->retransmitTimeout = value * 1000;
93 
94          \textcolor{comment}{//Additionally, the client should at least wait for a random amount}
95          \textcolor{comment}{//of time between 5 and 15 seconds after Max-Age expired to reduce}
96          \textcolor{comment}{//collisions with other clients (refer to RFC 7641, section 3.3.1)}
97          request->retransmitTimeout += \hyperlink{net_8c_af45ea0afc9806749114ec85e507014e1}{netGetRandRange}(
      \hyperlink{coap__client_8h_a1af981fb807fd5ccd6a0f8716ac6488d}{COAP\_CLIENT\_RAND\_DELAY\_MIN},
98             \hyperlink{coap__client_8h_ad06bf355fe7fdeaa05d9a8f58b471242}{COAP\_CLIENT\_RAND\_DELAY\_MAX});
99 
100          \textcolor{comment}{//The user is notified of changes to the resource state}
101          error = \hyperlink{coap__client__misc_8c_a937370fda4c0d4c5b8c9b559127f8a27}{coapClientChangeRequestState}(request,
102             \hyperlink{coap__client__request_8h_ae23250f18b3b2a3d2dc7dc98cc664d04a08c3e3ce4b37f7db53eeea653fa15e1d}{COAP\_REQ\_STATE\_OBSERVE});
103       \}
104       \textcolor{keywordflow}{else}
105       \{
106          \textcolor{comment}{//Drop the incoming notification...}
107          \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Out-of-order notification received!\(\backslash\)r\(\backslash\)n"});
108       \}
109    \}
110    \textcolor{keywordflow}{else}
111    \{
112       \textcolor{comment}{//The client is notified of changes to the resource state}
113       \hyperlink{coap__client__misc_8c_a937370fda4c0d4c5b8c9b559127f8a27}{coapClientChangeRequestState}(request, 
      \hyperlink{coap__client__request_8h_ae23250f18b3b2a3d2dc7dc98cc664d04a08c3e3ce4b37f7db53eeea653fa15e1d}{COAP\_REQ\_STATE\_OBSERVE});
114 
115       \textcolor{comment}{//The observation has been canceled}
116       error = \hyperlink{coap__client__misc_8c_a937370fda4c0d4c5b8c9b559127f8a27}{coapClientChangeRequestState}(request, 
      \hyperlink{coap__client__request_8h_ae23250f18b3b2a3d2dc7dc98cc664d04ac66544d370695c9859f214b4d1fa7946}{COAP\_REQ\_STATE\_CANCELED});
117    \}
118 
119    \textcolor{comment}{//Return status code}
120    \textcolor{keywordflow}{return} error;
121 \}
\end{DoxyCode}
