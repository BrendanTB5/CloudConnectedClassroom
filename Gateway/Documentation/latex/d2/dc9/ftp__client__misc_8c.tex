\hypertarget{ftp__client__misc_8c}{}\section{cyclone\+\_\+tcp/ftp/ftp\+\_\+client\+\_\+misc.c File Reference}
\label{ftp__client__misc_8c}\index{cyclone\+\_\+tcp/ftp/ftp\+\_\+client\+\_\+misc.\+c@{cyclone\+\_\+tcp/ftp/ftp\+\_\+client\+\_\+misc.\+c}}


Helper functions for F\+TP client.  


{\ttfamily \#include $<$stdlib.\+h$>$}\newline
{\ttfamily \#include $<$ctype.\+h$>$}\newline
{\ttfamily \#include \char`\"{}ftp/ftp\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ftp/ftp\+\_\+client\+\_\+transport.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ftp/ftp\+\_\+client\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}str.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}error.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{ftp__client__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_ae398facab6ce5126fa3b23996aafefa5}{F\+T\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftp\+Client\+Change\+State} (\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$context, \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32f}{Ftp\+Client\+State} new\+State)
\begin{DoxyCompactList}\small\item\em Update F\+TP client state. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ftp__client__misc_8c_a649a89ff88deef2eeb980a4265da37f7}{ftp\+Client\+Send\+Command} (\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Send F\+TP command and wait for a reply. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ftp__client__misc_8c_a76c2f71fc8ddb8c7f14b5b7d14ab3437}{ftp\+Client\+Format\+Command} (\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$context, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$command, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$argument)
\begin{DoxyCompactList}\small\item\em Format F\+TP command. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ftp__client__misc_8c_abcf17456a7ba45b8b5a325b9e30281c6}{ftp\+Client\+Format\+Port\+Command} (\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$context, const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$\hyperlink{ipcp_8h_a11542dd5a4de5976a89188df3d53b42d}{ip\+Addr}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port})
\begin{DoxyCompactList}\small\item\em Format P\+O\+RT or E\+P\+RT command. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ftp__client__misc_8c_aa9fd329ac93ad18aad112b3685163e19}{ftp\+Client\+Format\+Pasv\+Command} (\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Format P\+A\+SV or E\+P\+SV command. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ftp__client__misc_8c_a6fe18d85e376a84922d6901d9778febe}{ftp\+Client\+Parse\+Pasv\+Reply} (\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$context, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} $\ast$\hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port})
\begin{DoxyCompactList}\small\item\em Parse P\+A\+SV or E\+P\+SV response. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ftp__client__misc_8c_a56a1ac3a81b06fcb5ff851ea80cb5a6d}{ftp\+Client\+Parse\+Pwd\+Reply} (\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$context, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$path, size\+\_\+t max\+Len)
\begin{DoxyCompactList}\small\item\em Parse P\+WD response. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ftp__client__misc_8c_a1a1d50512c554596deefde727b660c19}{ftp\+Client\+Parse\+Dir\+Entry} (\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$line, \hyperlink{structFtpDirEntry}{Ftp\+Dir\+Entry} $\ast$dir\+Entry)
\begin{DoxyCompactList}\small\item\em Parse directory entry. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ftp__client__misc_8c_a54b9ae93bd843cdaa71ddae086ca024a}{ftp\+Client\+Init\+Data\+Transfer} (\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$context, \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} direction)
\begin{DoxyCompactList}\small\item\em Initiate data transfer. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ftp__client__misc_8c_a243badf54f4ee24b2575991fd4d7d01d}{ftp\+Client\+Terminate\+Data\+Transfer} (\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Terminate data transfer. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ftp__client__misc_8c_ae6a4a166626630754fdeae2b17e611de}{ftp\+Client\+Check\+Timeout} (\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Determine whether a timeout error has occurred. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Helper functions for F\+TP client. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{ftp__client__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{ftp__client__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_ae398facab6ce5126fa3b23996aafefa5}{F\+T\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file ftp\+\_\+client\+\_\+misc.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}\label{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}} 
\index{ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}!ftp\+Client\+Change\+State@{ftp\+Client\+Change\+State}}
\index{ftp\+Client\+Change\+State@{ftp\+Client\+Change\+State}!ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{ftp\+Client\+Change\+State()}{ftpClientChangeState()}}
{\footnotesize\ttfamily void ftp\+Client\+Change\+State (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$}]{context,  }\item[{\hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32f}{Ftp\+Client\+State}}]{new\+State }\end{DoxyParamCaption})}



Update F\+TP client state. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP client context \\
\hline
\mbox{\tt in}  & {\em new\+State} & New state to switch to \\
\hline
\end{DoxyParams}


Definition at line 54 of file ftp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
55 \{
56    \textcolor{comment}{//Switch to the new state}
57    context->state = newState;
58 
59    \textcolor{comment}{//Save current time}
60    context->timestamp = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
61 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__client__misc_8c_ae6a4a166626630754fdeae2b17e611de}\label{ftp__client__misc_8c_ae6a4a166626630754fdeae2b17e611de}} 
\index{ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}!ftp\+Client\+Check\+Timeout@{ftp\+Client\+Check\+Timeout}}
\index{ftp\+Client\+Check\+Timeout@{ftp\+Client\+Check\+Timeout}!ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{ftp\+Client\+Check\+Timeout()}{ftpClientCheckTimeout()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ftp\+Client\+Check\+Timeout (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Determine whether a timeout error has occurred. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1165 of file ftp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
1166 \{
1167 \textcolor{preprocessor}{#if (NET\_RTOS\_SUPPORT == DISABLED)}
1168    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1169    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
1170 
1171    \textcolor{comment}{//Get current time}
1172    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
1173 
1174    \textcolor{comment}{//Check whether the timeout has elapsed}
1175    \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, context->timestamp + context->timeout) >= 0)
1176    \{
1177       \textcolor{comment}{//Report a timeout error}
1178       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT};
1179    \}
1180    \textcolor{keywordflow}{else}
1181    \{
1182       \textcolor{comment}{//The operation would block}
1183       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK};
1184    \}
1185 
1186    \textcolor{comment}{//Return status code}
1187    \textcolor{keywordflow}{return} error;
1188 \textcolor{preprocessor}{#else}
1189    \textcolor{comment}{//Report a timeout error}
1190    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT};
1191 \textcolor{preprocessor}{#endif}
1192 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__client__misc_8c_a76c2f71fc8ddb8c7f14b5b7d14ab3437}\label{ftp__client__misc_8c_a76c2f71fc8ddb8c7f14b5b7d14ab3437}} 
\index{ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}!ftp\+Client\+Format\+Command@{ftp\+Client\+Format\+Command}}
\index{ftp\+Client\+Format\+Command@{ftp\+Client\+Format\+Command}!ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{ftp\+Client\+Format\+Command()}{ftpClientFormatCommand()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ftp\+Client\+Format\+Command (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$}]{context,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{command,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{argument }\end{DoxyParamCaption})}



Format F\+TP command. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP client context \\
\hline
\mbox{\tt in}  & {\em command} & N\+U\+L\+L-\/terminated string containing the F\+TP command \\
\hline
\mbox{\tt in}  & {\em argument} & N\+U\+L\+L-\/terminated string containing the argument \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 180 of file ftp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
182 \{
183    \textcolor{comment}{//The argument is optional}
184    \textcolor{keywordflow}{if}(argument != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
185    \{
186       \textcolor{comment}{//Format FTP command}
187       sprintf(context->buffer, \textcolor{stringliteral}{"%s %s\(\backslash\)r\(\backslash\)n"}, command, argument);
188    \}
189    \textcolor{keywordflow}{else}
190    \{
191       \textcolor{comment}{//Format FTP command}
192       sprintf(context->buffer, \textcolor{stringliteral}{"%s\(\backslash\)r\(\backslash\)n"}, command);
193    \}
194 
195    \textcolor{comment}{//Calculate the length of the FTP command}
196    context->commandLen = strlen(context->buffer);
197 
198    \textcolor{comment}{//Debug message}
199    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"FTP client: %s"}, context->buffer);
200 
201    \textcolor{comment}{//Flush receive buffer}
202    context->bufferPos = 0;
203    context->replyLen = 0;
204 
205    \textcolor{comment}{//Successful processing}
206    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
207 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__client__misc_8c_aa9fd329ac93ad18aad112b3685163e19}\label{ftp__client__misc_8c_aa9fd329ac93ad18aad112b3685163e19}} 
\index{ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}!ftp\+Client\+Format\+Pasv\+Command@{ftp\+Client\+Format\+Pasv\+Command}}
\index{ftp\+Client\+Format\+Pasv\+Command@{ftp\+Client\+Format\+Pasv\+Command}!ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{ftp\+Client\+Format\+Pasv\+Command()}{ftpClientFormatPasvCommand()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ftp\+Client\+Format\+Pasv\+Command (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Format P\+A\+SV or E\+P\+SV command. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 296 of file ftp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
297 \{
298    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
299 
300    \textcolor{comment}{//Initialize status code}
301    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
302 
303 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
304    \textcolor{comment}{//IPv4 address?}
305    \textcolor{keywordflow}{if}(context->serverIpAddr.length == \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr}))
306    \{
307       \textcolor{comment}{//Format PASV command}
308       strcpy(context->buffer, \textcolor{stringliteral}{"PASV\(\backslash\)r\(\backslash\)n"});
309    \}
310    \textcolor{keywordflow}{else}
311 \textcolor{preprocessor}{#endif}
312 \textcolor{preprocessor}{#if (IPV6\_SUPPORT == ENABLED)}
313    \textcolor{comment}{//IPv6 address?}
314    \textcolor{keywordflow}{if}(context->serverIpAddr.length == \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6Addr}))
315    \{
316       \textcolor{comment}{//Format EPSV command}
317       strcpy(context->buffer, \textcolor{stringliteral}{"EPSV\(\backslash\)r\(\backslash\)n"});
318    \}
319    \textcolor{keywordflow}{else}
320 \textcolor{preprocessor}{#endif}
321    \textcolor{comment}{//Invalid IP address?}
322    \{
323       \textcolor{comment}{//Report an error}
324       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
325    \}
326 
327    \textcolor{comment}{//Check status code}
328    \textcolor{keywordflow}{if}(!error)
329    \{
330       \textcolor{comment}{//Calculate the length of the FTP command}
331       context->commandLen = strlen(context->buffer);
332 
333       \textcolor{comment}{//Debug message}
334       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"FTP client: %s"}, context->buffer);
335 
336       \textcolor{comment}{//Flush receive buffer}
337       context->bufferPos = 0;
338       context->replyLen = 0;
339    \}
340 
341    \textcolor{comment}{//Return status code}
342    \textcolor{keywordflow}{return} error;
343 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__client__misc_8c_abcf17456a7ba45b8b5a325b9e30281c6}\label{ftp__client__misc_8c_abcf17456a7ba45b8b5a325b9e30281c6}} 
\index{ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}!ftp\+Client\+Format\+Port\+Command@{ftp\+Client\+Format\+Port\+Command}}
\index{ftp\+Client\+Format\+Port\+Command@{ftp\+Client\+Format\+Port\+Command}!ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{ftp\+Client\+Format\+Port\+Command()}{ftpClientFormatPortCommand()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ftp\+Client\+Format\+Port\+Command (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$}]{context,  }\item[{const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$}]{ip\+Addr,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{port }\end{DoxyParamCaption})}



Format P\+O\+RT or E\+P\+RT command. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP client context \\
\hline
\mbox{\tt in}  & {\em ip\+Addr} & Host IP address \\
\hline
\mbox{\tt in}  & {\em port} & T\+CP port number \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 219 of file ftp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
221 \{
222    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
223    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
224    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
225 
226    \textcolor{comment}{//Initialize status code}
227    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
228 
229 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
230    \textcolor{comment}{//IPv4 address?}
231    \textcolor{keywordflow}{if}(ipAddr->\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} == \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr}))
232    \{
233       \textcolor{comment}{//Format the PORT command}
234       n = sprintf(context->buffer, \textcolor{stringliteral}{"PORT "});
235 
236       \textcolor{comment}{//Append host address}
237       \hyperlink{ipv4_8c_a6d826409fb54a5cc0ce23c5f88f5c7c1}{ipv4AddrToString}(ipAddr->\hyperlink{structIpAddr_a8de6f49cb0461f57c1eda49bb1088916}{ipv4Addr}, context->buffer + n);
238       \textcolor{comment}{//Change dots to commas}
239       \hyperlink{str_8c_aaef0a79f30913d2fb6025453ad2b9d69}{strReplaceChar}(context->buffer, \textcolor{charliteral}{'.'}, \textcolor{charliteral}{','});
240 
241       \textcolor{comment}{//Point to the end of the resulting string}
242       p = context->buffer + strlen(context->buffer);
243       \textcolor{comment}{//Append port number}
244       sprintf(p, \textcolor{stringliteral}{",%"} PRIu8 \textcolor{stringliteral}{",%"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{os__port_8h_aeb61a4e8fff2f4624a632a3189cbd3a0}{MSB}(\hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port}), \hyperlink{os__port_8h_a34a3aa6cbadec6a80ab1eae8efd0083d}{LSB}(\hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port}));
245    \}
246    \textcolor{keywordflow}{else}
247 \textcolor{preprocessor}{#endif}
248 \textcolor{preprocessor}{#if (IPV6\_SUPPORT == ENABLED)}
249    \textcolor{comment}{//IPv6 address?}
250    \textcolor{keywordflow}{if}(ipAddr->\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} == \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6Addr}))
251    \{
252       \textcolor{comment}{//Format the EPRT command}
253       n = sprintf(context->buffer, \textcolor{stringliteral}{"EPRT |2|"});
254 
255       \textcolor{comment}{//Append host address}
256       \hyperlink{ipv6_8c_a96e27d88ffdf1b2ca6fca448dc6b4e7e}{ipv6AddrToString}(&ipAddr->\hyperlink{structIpAddr_a9bc2340a9c0bc5a0b8aa9695b74e2ee6}{ipv6Addr}, context->buffer + n);
257 
258       \textcolor{comment}{//Point to the end of the resulting string}
259       p = context->buffer + strlen(context->buffer);
260       \textcolor{comment}{//Append port number}
261       sprintf(p, \textcolor{stringliteral}{"|%"} PRIu16 \textcolor{stringliteral}{"|\(\backslash\)r\(\backslash\)n"}, \hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port});
262    \}
263    \textcolor{keywordflow}{else}
264 \textcolor{preprocessor}{#endif}
265    \textcolor{comment}{//Invalid IP address?}
266    \{
267       \textcolor{comment}{//Report an error}
268       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
269    \}
270 
271    \textcolor{comment}{//Check status code}
272    \textcolor{keywordflow}{if}(!error)
273    \{
274       \textcolor{comment}{//Calculate the length of the FTP command}
275       context->commandLen = strlen(context->buffer);
276 
277       \textcolor{comment}{//Debug message}
278       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"FTP client: %s"}, context->buffer);
279 
280       \textcolor{comment}{//Flush receive buffer}
281       context->bufferPos = 0;
282       context->replyLen = 0;
283    \}
284 
285    \textcolor{comment}{//Return status code}
286    \textcolor{keywordflow}{return} error;
287 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__client__misc_8c_a54b9ae93bd843cdaa71ddae086ca024a}\label{ftp__client__misc_8c_a54b9ae93bd843cdaa71ddae086ca024a}} 
\index{ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}!ftp\+Client\+Init\+Data\+Transfer@{ftp\+Client\+Init\+Data\+Transfer}}
\index{ftp\+Client\+Init\+Data\+Transfer@{ftp\+Client\+Init\+Data\+Transfer}!ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{ftp\+Client\+Init\+Data\+Transfer()}{ftpClientInitDataTransfer()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ftp\+Client\+Init\+Data\+Transfer (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$}]{context,  }\item[{\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t}}]{direction }\end{DoxyParamCaption})}



Initiate data transfer. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP client context \\
\hline
\mbox{\tt in}  & {\em direction} & Data transfer direction \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 712 of file ftp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
713 \{
714    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
715    \hyperlink{structIpAddr}{IpAddr} \hyperlink{mib__common_8h_a3860e959b1b7dd73686a6e11424805e2}{ipAddr};
716    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port};
717    \hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} *\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket};
718 
719    \textcolor{comment}{//Initialize status code}
720    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
721 
722    \textcolor{comment}{//Check current state}
723    \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa2e4d355339e5c264d559e05a9ebcdfe4}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_2})
724    \{
725 \textcolor{preprocessor}{#if (FTP\_CLIENT\_TLS\_SUPPORT == ENABLED)}
726       \textcolor{comment}{//TLS-secured connection?}
727       \textcolor{keywordflow}{if}(context->controlChannel.tlsContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
728       \{
729          \textcolor{comment}{//A PBSZ command must be issued, but must have a parameter}
730          \textcolor{comment}{//of '0' to indicate that no buffering is taking place and}
731          \textcolor{comment}{//the data connection should not be encapsulated}
732          error = \hyperlink{ftp__client__misc_8c_a76c2f71fc8ddb8c7f14b5b7d14ab3437}{ftpClientFormatCommand}(context, \textcolor{stringliteral}{"PBSZ"}, \textcolor{stringliteral}{"0"});
733 
734          \textcolor{comment}{//Check status code}
735          \textcolor{keywordflow}{if}(!error)
736          \{
737             \textcolor{comment}{//Send PBSZ command and wait for the server's response}
738             \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa1806c8b99d233854c982c58e1585004e}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_3});
739          \}
740       \}
741       \textcolor{keywordflow}{else}
742 \textcolor{preprocessor}{#endif}
743       \{
744          \textcolor{comment}{//Update FTP client state}
745          \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa1fb8b7d6675ce730ecf86001251b4060}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_5});
746       \}
747    \}
748    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa1806c8b99d233854c982c58e1585004e}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_3})
749    \{
750       \textcolor{comment}{//Send PBSZ command and wait for the server's response}
751       error = \hyperlink{ftp__client__misc_8c_a649a89ff88deef2eeb980a4265da37f7}{ftpClientSendCommand}(context);
752 
753       \textcolor{comment}{//Check status code}
754       \textcolor{keywordflow}{if}(!error)
755       \{
756          \textcolor{comment}{//Check FTP response code}
757          \textcolor{keywordflow}{if}(\hyperlink{ftp__client_8h_a8af0e6630256513516df045fb43012e7}{FTP\_REPLY\_CODE\_2YZ}(context->replyCode))
758          \{
759             \textcolor{comment}{//If the data connection security level is 'Private', then a TLS}
760             \textcolor{comment}{//negotiation must take place on the data connection}
761             error = \hyperlink{ftp__client__misc_8c_a76c2f71fc8ddb8c7f14b5b7d14ab3437}{ftpClientFormatCommand}(context, \textcolor{stringliteral}{"PROT"}, \textcolor{stringliteral}{"P"});
762 
763             \textcolor{comment}{//Check status code}
764             \textcolor{keywordflow}{if}(!error)
765             \{
766                \textcolor{comment}{//Send PROT command and wait for the server's response}
767                \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa77a6285324fb149d8fe889bcf8ce3438}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_4});
768             \}
769          \}
770          \textcolor{keywordflow}{else}
771          \{
772             \textcolor{comment}{//Report an error}
773             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
774          \}
775       \}
776    \}
777    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa77a6285324fb149d8fe889bcf8ce3438}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_4})
778    \{
779       \textcolor{comment}{//Send PROT command and wait for the server's response}
780       error = \hyperlink{ftp__client__misc_8c_a649a89ff88deef2eeb980a4265da37f7}{ftpClientSendCommand}(context);
781 
782       \textcolor{comment}{//Check status code}
783       \textcolor{keywordflow}{if}(!error)
784       \{
785          \textcolor{comment}{//Check FTP response code}
786          \textcolor{keywordflow}{if}(\hyperlink{ftp__client_8h_a8af0e6630256513516df045fb43012e7}{FTP\_REPLY\_CODE\_2YZ}(context->replyCode))
787          \{
788             \textcolor{comment}{//Update FTP client state}
789             \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa1fb8b7d6675ce730ecf86001251b4060}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_5});
790          \}
791          \textcolor{keywordflow}{else}
792          \{
793             \textcolor{comment}{//Report an error}
794             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
795          \}
796       \}
797    \}
798    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa1fb8b7d6675ce730ecf86001251b4060}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_5})
799    \{
800       \textcolor{comment}{//Check data transfer direction}
801       \textcolor{keywordflow}{if}(direction)
802       \{
803          \textcolor{comment}{//Open data socket}
804          error = \hyperlink{ftp__client__transport_8c_aaa807208fbb7ea7d5c66f81c672f6049}{ftpClientOpenChannel}(context, &context->dataChannel,
805             \hyperlink{ftp__client_8h_a9d8297ceeeefe897ccdc2c01bc1f9da3}{FTP\_CLIENT\_MAX\_TCP\_BUFFER\_SIZE}, 
      \hyperlink{ftp__client_8h_a861f579f177610c6aad23f30c480df16}{FTP\_CLIENT\_MIN\_TCP\_BUFFER\_SIZE});
806       \}
807       \textcolor{keywordflow}{else}
808       \{
809          \textcolor{comment}{//Open data socket}
810          error = \hyperlink{ftp__client__transport_8c_aaa807208fbb7ea7d5c66f81c672f6049}{ftpClientOpenChannel}(context, &context->dataChannel,
811             \hyperlink{ftp__client_8h_a861f579f177610c6aad23f30c480df16}{FTP\_CLIENT\_MIN\_TCP\_BUFFER\_SIZE}, 
      \hyperlink{ftp__client_8h_a9d8297ceeeefe897ccdc2c01bc1f9da3}{FTP\_CLIENT\_MAX\_TCP\_BUFFER\_SIZE});
812       \}
813 
814       \textcolor{comment}{//Check status code}
815       \textcolor{keywordflow}{if}(!error)
816       \{
817          \textcolor{comment}{//Check transfer mode}
818          \textcolor{keywordflow}{if}(!context->passiveMode)
819          \{
820             \textcolor{comment}{//Place the data socket in the listening state}
821             error = \hyperlink{socket_8c_a96b275d0dd033cf5fc36ba1a9c4543e3}{socketListen}(context->dataChannel.socket, 1);
822 
823             \textcolor{comment}{//Check status code}
824             \textcolor{keywordflow}{if}(!error)
825             \{
826                \textcolor{comment}{//Retrieve local IP address}
827                error = \hyperlink{socket_8c_aee73814e98b4258f707284521341420a}{socketGetLocalAddr}(context->controlChannel.socket,
828                   &ipAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
829             \}
830 
831             \textcolor{comment}{//Check status code}
832             \textcolor{keywordflow}{if}(!error)
833             \{
834                \textcolor{comment}{//Retrieve local port number}
835                error = \hyperlink{socket_8c_aee73814e98b4258f707284521341420a}{socketGetLocalAddr}(context->dataChannel.socket,
836                   \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, &port);
837             \}
838 
839             \textcolor{comment}{//Check status code}
840             \textcolor{keywordflow}{if}(!error)
841             \{
842                \textcolor{comment}{//Set the port to be used in data connection}
843                error = \hyperlink{ftp__client__misc_8c_abcf17456a7ba45b8b5a325b9e30281c6}{ftpClientFormatPortCommand}(context, &ipAddr, port);
844             \}
845 
846             \textcolor{comment}{//Check status code}
847             \textcolor{keywordflow}{if}(!error)
848             \{
849                \textcolor{comment}{//Send PORT command and wait for the server's response}
850                \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa4beba177d9e600bd1876434ac2645f2c}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_6});
851             \}
852          \}
853          \textcolor{keywordflow}{else}
854          \{
855             \textcolor{comment}{//Enter passive mode}
856             error = \hyperlink{ftp__client__misc_8c_aa9fd329ac93ad18aad112b3685163e19}{ftpClientFormatPasvCommand}(context);
857 
858             \textcolor{comment}{//Check status code}
859             \textcolor{keywordflow}{if}(!error)
860             \{
861                \textcolor{comment}{//Send PASV command and wait for the server's response}
862                \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa4beba177d9e600bd1876434ac2645f2c}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_6});
863             \}
864          \}
865       \}
866    \}
867    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa4beba177d9e600bd1876434ac2645f2c}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_6})
868    \{
869       \textcolor{comment}{//Send PORT/PASV command and wait for the server's response}
870       error = \hyperlink{ftp__client__misc_8c_a649a89ff88deef2eeb980a4265da37f7}{ftpClientSendCommand}(context);
871 
872       \textcolor{comment}{//Check status code}
873       \textcolor{keywordflow}{if}(!error)
874       \{
875          \textcolor{comment}{//Check FTP response code}
876          \textcolor{keywordflow}{if}(\hyperlink{ftp__client_8h_a8af0e6630256513516df045fb43012e7}{FTP\_REPLY\_CODE\_2YZ}(context->replyCode))
877          \{
878             \textcolor{comment}{//Check transfer mode}
879             \textcolor{keywordflow}{if}(!context->passiveMode)
880             \{
881                \textcolor{comment}{//Update FTP client state}
882                \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa166cfbe8775d76927440d0fa3cb12b39}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_7});
883             \}
884             \textcolor{keywordflow}{else}
885             \{
886                \textcolor{comment}{//Parse server's response}
887                error = \hyperlink{ftp__client__misc_8c_a6fe18d85e376a84922d6901d9778febe}{ftpClientParsePasvReply}(context, &context->serverPort);
888 
889                \textcolor{comment}{//Check status code}
890                \textcolor{keywordflow}{if}(!error)
891                \{
892                   \textcolor{comment}{//Establish data connection}
893                   \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa24afa64a4115d1d4ca0ae9492c04de45}{FTP\_CLIENT\_STATE\_CONNECTING\_TCP});
894                \}
895             \}
896          \}
897          \textcolor{keywordflow}{else}
898          \{
899             \textcolor{comment}{//Report an error}
900             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
901          \}
902       \}
903    \}
904    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa24afa64a4115d1d4ca0ae9492c04de45}{FTP\_CLIENT\_STATE\_CONNECTING\_TCP})
905    \{
906       \textcolor{comment}{//Establish data connection}
907       error = \hyperlink{socket_8c_aff3e3c0abc332f42189fce8f362fbd63}{socketConnect}(context->dataChannel.socket,
908          &context->serverIpAddr, context->serverPort);
909 
910       \textcolor{comment}{//Check status code}
911       \textcolor{keywordflow}{if}(!error)
912       \{
913          \textcolor{comment}{//Update FTP client state}
914          \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa166cfbe8775d76927440d0fa3cb12b39}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_7});
915       \}
916    \}
917    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa4f4457f5e04d4c3e70cfe9d835611669}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_8})
918    \{
919       \textcolor{comment}{//Send STOR/APPE/RETR/LIST command and wait for the server's response}
920       error = \hyperlink{ftp__client__misc_8c_a649a89ff88deef2eeb980a4265da37f7}{ftpClientSendCommand}(context);
921 
922       \textcolor{comment}{//Check status code}
923       \textcolor{keywordflow}{if}(!error)
924       \{
925          \textcolor{comment}{//Check FTP response code}
926          \textcolor{keywordflow}{if}(\hyperlink{ftp__client_8h_aa3e6cbc49fbb7664739da5f1715fcc99}{FTP\_REPLY\_CODE\_1YZ}(context->replyCode))
927          \{
928             \textcolor{comment}{//Check transfer mode}
929             \textcolor{keywordflow}{if}(!context->passiveMode)
930             \{
931                \textcolor{comment}{//Wait for the server to connect back to the client's data port}
932                \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32faf5f5133f943d08c1331ae055a612f2a7}{FTP\_CLIENT\_STATE\_ACCEPTING\_TCP});
933             \}
934             \textcolor{keywordflow}{else}
935             \{
936 \textcolor{preprocessor}{#if (FTP\_CLIENT\_TLS\_SUPPORT == ENABLED)}
937                \textcolor{comment}{//TLS-secured connection?}
938                \textcolor{keywordflow}{if}(context->controlChannel.tlsContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
939                \{
940                   \textcolor{comment}{//Check data transfer direction}
941                   \textcolor{keywordflow}{if}(direction)
942                   \{
943                      \textcolor{comment}{//TLS initialization}
944                      error = \hyperlink{ftp__client__transport_8c_a4b2ce1a2547da977bc2e8cef2c3bf733}{ftpClientOpenSecureChannel}(context,
945                         &context->dataChannel, \hyperlink{ftp__client_8h_a16e96dcb837dd6a2abadefb614eb1ab2}{FTP\_CLIENT\_TLS\_TX\_BUFFER\_SIZE},
946                         \hyperlink{ftp__client_8h_aecc713f96f6b886d0d8f9f689100b2d2}{FTP\_CLIENT\_MIN\_TLS\_RX\_BUFFER\_SIZE});
947                   \}
948                   \textcolor{keywordflow}{else}
949                   \{
950                      \textcolor{comment}{//TLS initialization}
951                      error = \hyperlink{ftp__client__transport_8c_a4b2ce1a2547da977bc2e8cef2c3bf733}{ftpClientOpenSecureChannel}(context,
952                         &context->dataChannel, \hyperlink{ftp__client_8h_a16e96dcb837dd6a2abadefb614eb1ab2}{FTP\_CLIENT\_TLS\_TX\_BUFFER\_SIZE},
953                         \hyperlink{ftp__client_8h_ae2766f6e0c3f8057339968ffb2659d2b}{FTP\_CLIENT\_MAX\_TLS\_RX\_BUFFER\_SIZE});
954                   \}
955 
956                   \textcolor{comment}{//Check status code}
957                   \textcolor{keywordflow}{if}(!error)
958                   \{
959                      \textcolor{comment}{//Perform TLS handshake}
960                      \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32faf3242b1228a16b3a667a094e462ab176}{FTP\_CLIENT\_STATE\_CONNECTING\_TLS});
961                   \}
962                \}
963                \textcolor{keywordflow}{else}
964 \textcolor{preprocessor}{#endif}
965                \{
966                   \textcolor{comment}{//Update FTP client state}
967                   \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa42bc805eaf83619710da7f5aee8a56e8}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_9});
968                \}
969             \}
970          \}
971          \textcolor{keywordflow}{else}
972          \{
973             \textcolor{comment}{//Report an error}
974             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
975          \}
976       \}
977    \}
978    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32faf5f5133f943d08c1331ae055a612f2a7}{FTP\_CLIENT\_STATE\_ACCEPTING\_TCP})
979    \{
980       \textcolor{comment}{//Wait for the server to connect back to the client's data port}
981       socket = \hyperlink{socket_8c_a00ec8a49fe1ee3597a0f7a2afbe46f00}{socketAccept}(context->dataChannel.socket, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
982 
983       \textcolor{comment}{//Valid socket handle?}
984       \textcolor{keywordflow}{if}(socket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
985       \{
986          \textcolor{comment}{//Close the listening socket}
987          \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(context->dataChannel.socket);
988          \textcolor{comment}{//Save socket handle}
989          context->dataChannel.socket = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket};
990 
991          \textcolor{comment}{//Set timeout}
992          error = \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->dataChannel.socket,
993             context->timeout);
994 
995 \textcolor{preprocessor}{#if (FTP\_CLIENT\_TLS\_SUPPORT == ENABLED)}
996          \textcolor{comment}{//TLS-secured connection?}
997          \textcolor{keywordflow}{if}(context->controlChannel.tlsContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
998          \{
999             \textcolor{comment}{//Check status code}
1000             \textcolor{keywordflow}{if}(!error)
1001             \{
1002                \textcolor{comment}{//Check data transfer direction}
1003                \textcolor{keywordflow}{if}(direction)
1004                \{
1005                   \textcolor{comment}{//TLS initialization}
1006                   error = \hyperlink{ftp__client__transport_8c_a4b2ce1a2547da977bc2e8cef2c3bf733}{ftpClientOpenSecureChannel}(context,
1007                      &context->dataChannel, \hyperlink{ftp__client_8h_a16e96dcb837dd6a2abadefb614eb1ab2}{FTP\_CLIENT\_TLS\_TX\_BUFFER\_SIZE},
1008                      \hyperlink{ftp__client_8h_aecc713f96f6b886d0d8f9f689100b2d2}{FTP\_CLIENT\_MIN\_TLS\_RX\_BUFFER\_SIZE});
1009                \}
1010                \textcolor{keywordflow}{else}
1011                \{
1012                   \textcolor{comment}{//TLS initialization}
1013                   error = \hyperlink{ftp__client__transport_8c_a4b2ce1a2547da977bc2e8cef2c3bf733}{ftpClientOpenSecureChannel}(context,
1014                      &context->dataChannel, \hyperlink{ftp__client_8h_a16e96dcb837dd6a2abadefb614eb1ab2}{FTP\_CLIENT\_TLS\_TX\_BUFFER\_SIZE},
1015                      \hyperlink{ftp__client_8h_ae2766f6e0c3f8057339968ffb2659d2b}{FTP\_CLIENT\_MAX\_TLS\_RX\_BUFFER\_SIZE});
1016                \}
1017             \}
1018 
1019             \textcolor{comment}{//Check status code}
1020             \textcolor{keywordflow}{if}(!error)
1021             \{
1022                \textcolor{comment}{//Perform TLS handshake}
1023                \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32faf3242b1228a16b3a667a094e462ab176}{FTP\_CLIENT\_STATE\_CONNECTING\_TLS});
1024             \}
1025          \}
1026          \textcolor{keywordflow}{else}
1027 \textcolor{preprocessor}{#endif}
1028          \{
1029             \textcolor{comment}{//Update FTP client state}
1030             \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa42bc805eaf83619710da7f5aee8a56e8}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_9});
1031          \}
1032       \}
1033       \textcolor{keywordflow}{else}
1034       \{
1035          \textcolor{comment}{//Report an error}
1036          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK};
1037       \}
1038    \}
1039    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32faf3242b1228a16b3a667a094e462ab176}{FTP\_CLIENT\_STATE\_CONNECTING\_TLS})
1040    \{
1041       \textcolor{comment}{//Perform TLS handshake}
1042       error = \hyperlink{ftp__client__transport_8c_abc76a2bf28a5663e909f042693b79fe0}{ftpClientEstablishSecureChannel}(&context->dataChannel);
1043 
1044       \textcolor{comment}{//Check status code}
1045       \textcolor{keywordflow}{if}(!error)
1046       \{
1047          \textcolor{comment}{//The content of the file can be transferred via the data connection}
1048          \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa42bc805eaf83619710da7f5aee8a56e8}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_9});
1049       \}
1050    \}
1051    \textcolor{keywordflow}{else}
1052    \{
1053       \textcolor{comment}{//Invalid state}
1054       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
1055    \}
1056 
1057    \textcolor{comment}{//Return status code}
1058    \textcolor{keywordflow}{return} error;
1059 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__client__misc_8c_a1a1d50512c554596deefde727b660c19}\label{ftp__client__misc_8c_a1a1d50512c554596deefde727b660c19}} 
\index{ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}!ftp\+Client\+Parse\+Dir\+Entry@{ftp\+Client\+Parse\+Dir\+Entry}}
\index{ftp\+Client\+Parse\+Dir\+Entry@{ftp\+Client\+Parse\+Dir\+Entry}!ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{ftp\+Client\+Parse\+Dir\+Entry()}{ftpClientParseDirEntry()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ftp\+Client\+Parse\+Dir\+Entry (\begin{DoxyParamCaption}\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{line,  }\item[{\hyperlink{structFtpDirEntry}{Ftp\+Dir\+Entry} $\ast$}]{dir\+Entry }\end{DoxyParamCaption})}



Parse directory entry. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em line} & N\+U\+L\+L-\/terminated string \\
\hline
\mbox{\tt out}  & {\em dir\+Entry} & Pointer to a directory entry \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 482 of file ftp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
483 \{
484    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
485    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
486    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
487    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{coap__common_8h_aaa0137cdddb344591e20a2930a1ba54d}{token};
488 
489    \textcolor{comment}{//Abbreviated months}
490    \textcolor{keyword}{static} \textcolor{keyword}{const} \textcolor{keywordtype}{char} \hyperlink{date__time_8c_a28e16ae8240a8338b89ff5929f9b274f}{months}[13][4] =
491    \{
492       \textcolor{stringliteral}{"   "},
493       \textcolor{stringliteral}{"Jan"},
494       \textcolor{stringliteral}{"Feb"},
495       \textcolor{stringliteral}{"Mar"},
496       \textcolor{stringliteral}{"Apr"},
497       \textcolor{stringliteral}{"May"},
498       \textcolor{stringliteral}{"Jun"},
499       \textcolor{stringliteral}{"Jul"},
500       \textcolor{stringliteral}{"Aug"},
501       \textcolor{stringliteral}{"Sep"},
502       \textcolor{stringliteral}{"Oct"},
503       \textcolor{stringliteral}{"Nov"},
504       \textcolor{stringliteral}{"Dec"}
505    \};
506 
507    \textcolor{comment}{//Read first field}
508    token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(line, \textcolor{stringliteral}{" \(\backslash\)t"}, &p);
509    \textcolor{comment}{//Invalid directory entry?}
510    \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
511       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
512 
513    \textcolor{comment}{//MS-DOS listing format?}
514    \textcolor{keywordflow}{if}(isdigit((\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) token[0]))
515    \{
516       \textcolor{comment}{//Check modification date format}
517       \textcolor{keywordflow}{if}(strlen(token) == 8 && token[2] == \textcolor{charliteral}{'-'} && token[5] == \textcolor{charliteral}{'-'})
518       \{
519          \textcolor{comment}{//The format of the date is mm-dd-yy}
520          dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_ac895afb51c74941c50205f746b709148}{month} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) strtoul(token, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
521          dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_a727866b5ecdfda1edf946efe86aa74af}{day} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) strtoul(token + 3, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
522          dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_a0a61d60280541502e47f9a7fd6e1c8d2}{year} = (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) strtoul(token + 6, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10) + 2000;
523       \}
524       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(strlen(token) == 10 && token[2] == \textcolor{charliteral}{'/'} && token[5] == \textcolor{charliteral}{'/'})
525       \{
526          \textcolor{comment}{//The format of the date is mm/dd/yyyy}
527          dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_ac895afb51c74941c50205f746b709148}{month} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) strtoul(token, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
528          dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_a727866b5ecdfda1edf946efe86aa74af}{day} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) strtoul(token + 3, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
529          dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_a0a61d60280541502e47f9a7fd6e1c8d2}{year} = (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) strtoul(token + 6, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
530       \}
531       \textcolor{keywordflow}{else}
532       \{
533          \textcolor{comment}{//Invalid time format}
534          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
535       \}
536 
537       \textcolor{comment}{//Read modification time}
538       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" "}, &p);
539       \textcolor{comment}{//Invalid directory entry?}
540       \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
541          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
542 
543       \textcolor{comment}{//Check modification time format}
544       \textcolor{keywordflow}{if}(strlen(token) >= 5 && token[2] == \textcolor{charliteral}{':'})
545       \{
546          \textcolor{comment}{//The format of the time hh:mm}
547          dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_a46fa4e0c13c7fc19c8ae97a5642c4a15}{hours} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) strtoul(token, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
548          dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_a9e705a28fc51e333616553313107d579}{minutes} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) strtoul(token + 3, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
549 
550          \textcolor{comment}{//The PM period covers the 12 hours from noon to midnight}
551          \textcolor{keywordflow}{if}(strstr(token, \textcolor{stringliteral}{"PM"}) != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
552             dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_a46fa4e0c13c7fc19c8ae97a5642c4a15}{hours} += 12;
553       \}
554       \textcolor{keywordflow}{else}
555       \{
556          \textcolor{comment}{//Invalid time format}
557          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
558       \}
559 
560       \textcolor{comment}{//Read next field}
561       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" "}, &p);
562       \textcolor{comment}{//Invalid directory entry?}
563       \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
564          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
565 
566       \textcolor{comment}{//Check whether the current entry is a directory}
567       \textcolor{keywordflow}{if}(!strcmp(token, \textcolor{stringliteral}{"<DIR>"}))
568       \{
569          \textcolor{comment}{//Update attributes}
570          dirEntry->\hyperlink{structFtpDirEntry_a25056eeb26b6c0b259286b9f53b2caa7}{attributes} |= \hyperlink{ftp__client_8h_a6fe531a12cfe081a6a5cd09b3da575cdada08427b2bd7d0d8deabad2d83abd807}{FTP\_FILE\_ATTR\_DIRECTORY};
571       \}
572       \textcolor{keywordflow}{else}
573       \{
574          \textcolor{comment}{//Save the size of the file}
575          dirEntry->\hyperlink{structFtpDirEntry_ab40397e2e28f76f64b2416a99bb6fada}{size} = strtoul(token, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
576       \}
577 
578       \textcolor{comment}{//Read filename field}
579       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" \(\backslash\)r\(\backslash\)n"}, &p);
580       \textcolor{comment}{//Invalid directory entry?}
581       \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
582          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
583 
584       \textcolor{comment}{//Retrieve the length of the filename}
585       n = strlen(token);
586       \textcolor{comment}{//Limit the number of characters to copy}
587       n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(n, \hyperlink{ftp__client_8h_a44901b0f271514699875d70f5da8130f}{FTP\_CLIENT\_MAX\_FILENAME\_LEN});
588 
589       \textcolor{comment}{//Copy the filename}
590       strncpy(dirEntry->\hyperlink{structFtpDirEntry_ac3a25e8ecf4a41cb49e0606e96b5cd44}{name}, token, n);
591       \textcolor{comment}{//Properly terminate the string with a NULL character}
592       dirEntry->\hyperlink{structFtpDirEntry_ac3a25e8ecf4a41cb49e0606e96b5cd44}{name}[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}] = \textcolor{charliteral}{'\(\backslash\)0'};
593    \}
594    \textcolor{comment}{//Unix listing format?}
595    \textcolor{keywordflow}{else}
596    \{
597       \textcolor{comment}{//Check file permissions}
598       \textcolor{keywordflow}{if}(strchr(token, \textcolor{charliteral}{'d'}) != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
599          dirEntry->\hyperlink{structFtpDirEntry_a25056eeb26b6c0b259286b9f53b2caa7}{attributes} |= \hyperlink{ftp__client_8h_a6fe531a12cfe081a6a5cd09b3da575cdada08427b2bd7d0d8deabad2d83abd807}{FTP\_FILE\_ATTR\_DIRECTORY};
600       \textcolor{keywordflow}{if}(strchr(token, \textcolor{charliteral}{'w'}) == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
601          dirEntry->\hyperlink{structFtpDirEntry_a25056eeb26b6c0b259286b9f53b2caa7}{attributes} |= \hyperlink{ftp__client_8h_a6fe531a12cfe081a6a5cd09b3da575cda6b785d993710ab4744fdbb051db0b9fd}{FTP\_FILE\_ATTR\_READ\_ONLY};
602 
603       \textcolor{comment}{//Read next field}
604       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" "}, &p);
605       \textcolor{comment}{//Invalid directory entry?}
606       \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
607          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
608 
609       \textcolor{comment}{//Discard owner field}
610       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" "}, &p);
611       \textcolor{comment}{//Invalid directory entry?}
612       \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
613          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
614 
615       \textcolor{comment}{//Discard group field}
616       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" "}, &p);
617       \textcolor{comment}{//Invalid directory entry?}
618       \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
619          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
620 
621       \textcolor{comment}{//Read size field}
622       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" "}, &p);
623       \textcolor{comment}{//Invalid directory entry?}
624       \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
625          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
626 
627       \textcolor{comment}{//Save the size of the file}
628       dirEntry->\hyperlink{structFtpDirEntry_ab40397e2e28f76f64b2416a99bb6fada}{size} = strtoul(token, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
629 
630       \textcolor{comment}{//Read modification time (month)}
631       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" "}, &p);
632       \textcolor{comment}{//Invalid directory entry?}
633       \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
634          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
635 
636       \textcolor{comment}{//Decode the 3-letter month name}
637       \textcolor{keywordflow}{for}(i = 1; i <= 12; i++)
638       \{
639          \textcolor{comment}{//Compare month name}
640          \textcolor{keywordflow}{if}(!strcmp(token, months[i]))
641          \{
642             \textcolor{comment}{//Save month number}
643             dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_ac895afb51c74941c50205f746b709148}{month} = i;
644             \textcolor{keywordflow}{break};
645          \}
646       \}
647 
648       \textcolor{comment}{//Read modification time (day)}
649       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" "}, &p);
650       \textcolor{comment}{//Invalid directory entry?}
651       \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
652          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
653 
654       \textcolor{comment}{//Save day number}
655       dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_a727866b5ecdfda1edf946efe86aa74af}{day} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) strtoul(token, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
656 
657       \textcolor{comment}{//Read next field}
658       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" "}, &p);
659       \textcolor{comment}{//Invalid directory entry?}
660       \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
661          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
662 
663       \textcolor{comment}{//Check modification time format}
664       \textcolor{keywordflow}{if}(strlen(token) == 4)
665       \{
666          \textcolor{comment}{//The format of the year is yyyy}
667          dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_a0a61d60280541502e47f9a7fd6e1c8d2}{year} = (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) strtoul(token, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
668 
669       \}
670       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(strlen(token) == 5)
671       \{
672          \textcolor{comment}{//The format of the time hh:mm}
673          token[2] = \textcolor{charliteral}{'\(\backslash\)0'};
674          dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_a46fa4e0c13c7fc19c8ae97a5642c4a15}{hours} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) strtoul(token, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
675          dirEntry->\hyperlink{structFtpDirEntry_a21b61636bb8282399bba62f16bf016d1}{modified}.\hyperlink{structDateTime_a9e705a28fc51e333616553313107d579}{minutes} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) strtoul(token + 3, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
676       \}
677       \textcolor{keywordflow}{else}
678       \{
679          \textcolor{comment}{//Invalid time format}
680          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
681       \}
682 
683       \textcolor{comment}{//Read filename field}
684       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" \(\backslash\)r\(\backslash\)n"}, &p);
685       \textcolor{comment}{//Invalid directory entry?}
686       \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
687          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
688 
689       \textcolor{comment}{//Retrieve the length of the filename}
690       n = strlen(token);
691       \textcolor{comment}{//Limit the number of characters to copy}
692       n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(n, \hyperlink{ftp__client_8h_a44901b0f271514699875d70f5da8130f}{FTP\_CLIENT\_MAX\_FILENAME\_LEN});
693 
694       \textcolor{comment}{//Copy the filename}
695       strncpy(dirEntry->\hyperlink{structFtpDirEntry_ac3a25e8ecf4a41cb49e0606e96b5cd44}{name}, token, n);
696       \textcolor{comment}{//Properly terminate the string with a NULL character}
697       dirEntry->\hyperlink{structFtpDirEntry_ac3a25e8ecf4a41cb49e0606e96b5cd44}{name}[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}] = \textcolor{charliteral}{'\(\backslash\)0'};
698    \}
699 
700    \textcolor{comment}{//The directory entry is valid}
701    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
702 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__client__misc_8c_a6fe18d85e376a84922d6901d9778febe}\label{ftp__client__misc_8c_a6fe18d85e376a84922d6901d9778febe}} 
\index{ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}!ftp\+Client\+Parse\+Pasv\+Reply@{ftp\+Client\+Parse\+Pasv\+Reply}}
\index{ftp\+Client\+Parse\+Pasv\+Reply@{ftp\+Client\+Parse\+Pasv\+Reply}!ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{ftp\+Client\+Parse\+Pasv\+Reply()}{ftpClientParsePasvReply()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ftp\+Client\+Parse\+Pasv\+Reply (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} $\ast$}]{port }\end{DoxyParamCaption})}



Parse P\+A\+SV or E\+P\+SV response. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP client context \\
\hline
\mbox{\tt out}  & {\em port} & The T\+CP port number the server is listening on \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 353 of file ftp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
354 \{
355    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
356    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} delimiter;
357 
358 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
359    \textcolor{comment}{//IPv4 address?}
360    \textcolor{keywordflow}{if}(context->serverIpAddr.length == \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr}))
361    \{
362       \textcolor{comment}{//Delimiter character}
363       delimiter = \textcolor{charliteral}{','};
364 
365       \textcolor{comment}{//Retrieve the low byte of the port number}
366       p = strrchr(context->buffer, delimiter);
367       \textcolor{comment}{//Failed to parse the response?}
368       \textcolor{keywordflow}{if}(p == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
369          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
370 
371       \textcolor{comment}{//Convert the resulting string}
372       *\hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port} = (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) strtoul(p + 1, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
373       \textcolor{comment}{//Split the string}
374       *p = \textcolor{charliteral}{'\(\backslash\)0'};
375 
376       \textcolor{comment}{//Retrieve the high byte of the port number}
377       p = strrchr(context->buffer, delimiter);
378       \textcolor{comment}{//Failed to parse the response?}
379       \textcolor{keywordflow}{if}(p == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
380          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
381 
382       \textcolor{comment}{//Convert the resulting string}
383       *\hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port} |= (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) strtoul(p + 1, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10) << 8;
384    \}
385    \textcolor{keywordflow}{else}
386 \textcolor{preprocessor}{#endif}
387 \textcolor{preprocessor}{#if (IPV6\_SUPPORT == ENABLED)}
388    \textcolor{comment}{//IPv6 address?}
389    \textcolor{keywordflow}{if}(context->serverIpAddr.length == \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6Addr}))
390    \{
391       \textcolor{comment}{//Search for the opening parenthesis}
392       p = strrchr(context->buffer, \textcolor{charliteral}{'('});
393       \textcolor{comment}{//Failed to parse the response?}
394       \textcolor{keywordflow}{if}(p == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || p[1] == \textcolor{charliteral}{'\(\backslash\)0'})
395          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
396 
397       \textcolor{comment}{//Retrieve the delimiter character}
398       delimiter = p[1];
399 
400       \textcolor{comment}{//Search for the last delimiter character}
401       p = strrchr(context->buffer, delimiter);
402       \textcolor{comment}{//Failed to parse the response?}
403       \textcolor{keywordflow}{if}(p == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
404          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
405 
406       \textcolor{comment}{//Split the string}
407       *p = \textcolor{charliteral}{'\(\backslash\)0'};
408 
409       \textcolor{comment}{//Search for the last but one delimiter character}
410       p = strrchr(context->buffer, delimiter);
411       \textcolor{comment}{//Failed to parse the response?}
412       \textcolor{keywordflow}{if}(p == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
413          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
414 
415       \textcolor{comment}{//Convert the resulting string}
416       *\hyperlink{dns__common_8h_a8e0798404bf2cf5dabb84c5ba9a4f236}{port} = (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) strtoul(p + 1, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
417    \}
418    \textcolor{keywordflow}{else}
419 \textcolor{preprocessor}{#endif}
420    \textcolor{comment}{//Invalid IP address?}
421    \{
422       \textcolor{comment}{//Report an error}
423       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
424    \}
425 
426    \textcolor{comment}{//Successful processing}
427    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
428 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__client__misc_8c_a56a1ac3a81b06fcb5ff851ea80cb5a6d}\label{ftp__client__misc_8c_a56a1ac3a81b06fcb5ff851ea80cb5a6d}} 
\index{ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}!ftp\+Client\+Parse\+Pwd\+Reply@{ftp\+Client\+Parse\+Pwd\+Reply}}
\index{ftp\+Client\+Parse\+Pwd\+Reply@{ftp\+Client\+Parse\+Pwd\+Reply}!ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{ftp\+Client\+Parse\+Pwd\+Reply()}{ftpClientParsePwdReply()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ftp\+Client\+Parse\+Pwd\+Reply (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$}]{context,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{path,  }\item[{size\+\_\+t}]{max\+Len }\end{DoxyParamCaption})}



Parse P\+WD response. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP client context \\
\hline
\mbox{\tt out}  & {\em path} & Output buffer where to store the current directory \\
\hline
\mbox{\tt in}  & {\em max\+Len} & Maximum number of characters the buffer can hold \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 439 of file ftp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
441 \{
442    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
443    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
444 
445    \textcolor{comment}{//Search for the last double quote}
446    p = strrchr(context->buffer, \textcolor{charliteral}{'\(\backslash\)"'});
447    \textcolor{comment}{//Failed to parse the response?}
448    \textcolor{keywordflow}{if}(p == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
449       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
450 
451    \textcolor{comment}{//Split the string}
452    *p = \textcolor{charliteral}{'\(\backslash\)0'};
453 
454    \textcolor{comment}{//Search for the first double quote}
455    p = strchr(context->buffer, \textcolor{charliteral}{'\(\backslash\)"'});
456    \textcolor{comment}{//Failed to parse the response?}
457    \textcolor{keywordflow}{if}(p == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
458       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca92e7b26953f11d1bc4f4526fad39aed0}{ERROR\_INVALID\_SYNTAX};
459 
460    \textcolor{comment}{//Retrieve the length of the working directory}
461    length = strlen(p + 1);
462    \textcolor{comment}{//Limit the number of characters to copy}
463    length = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(length, maxLen);
464 
465    \textcolor{comment}{//Copy the string}
466    strncpy(path, p + 1, length);
467    \textcolor{comment}{//Properly terminate the string with a NULL character}
468    path[\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}] = \textcolor{charliteral}{'\(\backslash\)0'};
469 
470    \textcolor{comment}{//Successful processing}
471    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
472 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__client__misc_8c_a649a89ff88deef2eeb980a4265da37f7}\label{ftp__client__misc_8c_a649a89ff88deef2eeb980a4265da37f7}} 
\index{ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}!ftp\+Client\+Send\+Command@{ftp\+Client\+Send\+Command}}
\index{ftp\+Client\+Send\+Command@{ftp\+Client\+Send\+Command}!ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{ftp\+Client\+Send\+Command()}{ftpClientSendCommand()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ftp\+Client\+Send\+Command (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Send F\+TP command and wait for a reply. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 70 of file ftp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
71 \{
72    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
73    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
74    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} more;
75    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *reply;
76 
77    \textcolor{comment}{//Initialize status code}
78    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
79 
80    \textcolor{comment}{//Point to the server's response}
81    reply = context->buffer;
82 
83    \textcolor{comment}{//Send FTP command and wait for the FTP reply to be received}
84    \textcolor{keywordflow}{while}(!error)
85    \{
86       \textcolor{comment}{//Send FTP command}
87       \textcolor{keywordflow}{if}(context->bufferPos < context->commandLen)
88       \{
89          \textcolor{comment}{//Send more data}
90          error = \hyperlink{ftp__client__transport_8c_a24f702fa1973795506a38654502758dd}{ftpClientWriteChannel}(&context->controlChannel,
91             context->buffer + context->bufferPos,
92             context->commandLen - context->bufferPos, &n, 0);
93 
94          \textcolor{comment}{//Check status code}
95          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
96          \{
97             \textcolor{comment}{//Advance data pointer}
98             context->bufferPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
99          \}
100       \}
101       \textcolor{keywordflow}{else}
102       \{
103          \textcolor{comment}{//Determine whether more data should be collected}
104          \textcolor{keywordflow}{if}(context->replyLen != 0 && reply[context->replyLen - 1] == \textcolor{charliteral}{'\(\backslash\)n'})
105             more = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
106          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->replyLen == (\hyperlink{ftp__client_8h_a686faf7a79b419726b351d164f0f14c4}{FTP\_CLIENT\_BUFFER\_SIZE} - 1))
107             more = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
108          \textcolor{keywordflow}{else}
109             more = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
110 
111          \textcolor{comment}{//Receive FTP response}
112          \textcolor{keywordflow}{if}(more)
113          \{
114             \textcolor{comment}{//Receive more data}
115             error = \hyperlink{ftp__client__transport_8c_ab044b2eba7eac515c754805151d24176}{ftpClientReadChannel}(&context->controlChannel,
116                context->buffer + context->replyLen,
117                \hyperlink{ftp__client_8h_a686faf7a79b419726b351d164f0f14c4}{FTP\_CLIENT\_BUFFER\_SIZE} - 1 - context->replyLen,
118                &n, \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a8a9906d4aacdf7dd4b7203c86271006b}{SOCKET\_FLAG\_BREAK\_CRLF});
119 
120             \textcolor{comment}{//Check status code}
121             \textcolor{keywordflow}{if}(!error)
122             \{
123                \textcolor{comment}{//Advance data pointer}
124                context->replyLen += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
125             \}
126          \}
127          \textcolor{keywordflow}{else}
128          \{
129             \textcolor{comment}{//Properly terminate the response with a NULL character}
130             reply[context->replyLen] = \textcolor{charliteral}{'\(\backslash\)0'};
131 
132             \textcolor{comment}{//Remove trailing whitespace from the response}
133             \hyperlink{str_8c_a213a401a08b4083cbddd0fb4673ba430}{strRemoveTrailingSpace}(reply);
134 
135             \textcolor{comment}{//All replies begin with a three digit numeric code}
136             \textcolor{keywordflow}{if}(isdigit((\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) reply[0]) &&
137                isdigit((\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) reply[1]) &&
138                isdigit((\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) reply[2]))
139             \{
140                \textcolor{comment}{//A space character follows the response code for the last line}
141                \textcolor{keywordflow}{if}(reply[3] == \textcolor{charliteral}{' '} || reply[3] == \textcolor{charliteral}{'\(\backslash\)0'})
142                \{
143                   \textcolor{comment}{//Debug message}
144                   \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"FTP server: %s\(\backslash\)r\(\backslash\)n"}, reply);
145 
146                   \textcolor{comment}{//Retrieve FTP reply code}
147                   context->replyCode = strtoul(reply, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 10);
148 
149                   \textcolor{comment}{//A valid FTP response has been received}
150                   \textcolor{keywordflow}{break};
151                \}
152                \textcolor{keywordflow}{else}
153                \{
154                   \textcolor{comment}{//Ignore all intermediary lines}
155                   context->replyLen = 0;
156                \}
157             \}
158             \textcolor{keywordflow}{else}
159             \{
160                \textcolor{comment}{//Ignore all intermediary lines}
161                context->replyLen = 0;
162             \}
163          \}
164       \}
165    \}
166 
167    \textcolor{comment}{//Return status code}
168    \textcolor{keywordflow}{return} error;
169 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__client__misc_8c_a243badf54f4ee24b2575991fd4d7d01d}\label{ftp__client__misc_8c_a243badf54f4ee24b2575991fd4d7d01d}} 
\index{ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}!ftp\+Client\+Terminate\+Data\+Transfer@{ftp\+Client\+Terminate\+Data\+Transfer}}
\index{ftp\+Client\+Terminate\+Data\+Transfer@{ftp\+Client\+Terminate\+Data\+Transfer}!ftp\+\_\+client\+\_\+misc.\+c@{ftp\+\_\+client\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{ftp\+Client\+Terminate\+Data\+Transfer()}{ftpClientTerminateDataTransfer()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ftp\+Client\+Terminate\+Data\+Transfer (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__client_8h_a416e53a7e79ecd46ffcbeb50db323252}{Ftp\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Terminate data transfer. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1068 of file ftp\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
1069 \{
1070    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1071 
1072    \textcolor{comment}{//Initialize status code}
1073    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1074 
1075    \textcolor{comment}{//Execute FTP command sequence}
1076    \textcolor{keywordflow}{while}(!error)
1077    \{
1078       \textcolor{comment}{//Check current state}
1079       \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa11d90c2ee78b510440317a3488c77741}{FTP\_CLIENT\_STATE\_WRITING\_DATA} ||
1080          context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa008316382d31e1f518b1f7f21f54ad91}{FTP\_CLIENT\_STATE\_READING\_DATA})
1081       \{
1082          \textcolor{comment}{//Update FTP client state}
1083          \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa6a105a2c6fa25af8035317b857ca1f68}{FTP\_CLIENT\_STATE\_DISCONNECTING\_1});
1084       \}
1085       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa6a105a2c6fa25af8035317b857ca1f68}{FTP\_CLIENT\_STATE\_DISCONNECTING\_1})
1086       \{
1087          \textcolor{comment}{//Shutdown data connection}
1088          error = \hyperlink{ftp__client__transport_8c_afa869ec7d2815eb9a74ed79022f10369}{ftpClientShutdownChannel}(&context->dataChannel);
1089 
1090          \textcolor{comment}{//Check status code}
1091          \textcolor{keywordflow}{if}(!error)
1092          \{
1093             \textcolor{comment}{//Close data connection}
1094             \hyperlink{ftp__client__transport_8c_afb29bfd2ee65af8f4526777355c3a171}{ftpClientCloseChannel}(&context->dataChannel);
1095 
1096             \textcolor{comment}{//Flush buffer}
1097             context->bufferPos = 0;
1098             context->commandLen = 0;
1099             context->replyLen = 0;
1100 
1101             \textcolor{comment}{//Wait for the transfer status}
1102             \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fad41efafde5188577bede053e2d80eb97}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_1});
1103          \}
1104       \}
1105       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fad41efafde5188577bede053e2d80eb97}{FTP\_CLIENT\_STATE\_SUB\_COMMAND\_1})
1106       \{
1107          \textcolor{comment}{//Wait for the transfer status}
1108          error = \hyperlink{ftp__client__misc_8c_a649a89ff88deef2eeb980a4265da37f7}{ftpClientSendCommand}(context);
1109 
1110          \textcolor{comment}{//Check status code}
1111          \textcolor{keywordflow}{if}(!error)
1112          \{
1113             \textcolor{comment}{//Check FTP response code}
1114             \textcolor{keywordflow}{if}(\hyperlink{ftp__client_8h_a8af0e6630256513516df045fb43012e7}{FTP\_REPLY\_CODE\_2YZ}(context->replyCode))
1115             \{
1116                \textcolor{comment}{//Update FTP client state}
1117                \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa3174f58da917af93a38b144a1e0d2527}{FTP\_CLIENT\_STATE\_CONNECTED});
1118             \}
1119             \textcolor{keywordflow}{else}
1120             \{
1121                \textcolor{comment}{//Report an error}
1122                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caa71f5ec9e991d033d622bd5fb6f6633f}{ERROR\_UNEXPECTED\_RESPONSE};
1123             \}
1124          \}
1125       \}
1126       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa3174f58da917af93a38b144a1e0d2527}{FTP\_CLIENT\_STATE\_CONNECTED})
1127       \{
1128          \textcolor{comment}{//We are done}
1129          \textcolor{keywordflow}{break};
1130       \}
1131       \textcolor{keywordflow}{else}
1132       \{
1133          \textcolor{comment}{//Invalid state}
1134          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
1135       \}
1136    \}
1137 
1138    \textcolor{comment}{//Check status code}
1139    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
1140    \{
1141       \textcolor{comment}{//Check whether the timeout has elapsed}
1142       error = \hyperlink{ftp__client__misc_8c_ae6a4a166626630754fdeae2b17e611de}{ftpClientCheckTimeout}(context);
1143    \}
1144 
1145    \textcolor{comment}{//Failed to close file?}
1146    \textcolor{keywordflow}{if}(error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} && error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK})
1147    \{
1148       \textcolor{comment}{//Close data connection}
1149       \hyperlink{ftp__client__transport_8c_afb29bfd2ee65af8f4526777355c3a171}{ftpClientCloseChannel}(&context->dataChannel);
1150       \textcolor{comment}{//Update FTP client state}
1151       \hyperlink{ftp__client__misc_8c_ac32e3c219bd538aae5fd6f92002db7c9}{ftpClientChangeState}(context, 
      \hyperlink{ftp__client_8h_a27b79c28175d6b10ba3395f09b15d32fa3174f58da917af93a38b144a1e0d2527}{FTP\_CLIENT\_STATE\_CONNECTED});
1152    \}
1153 
1154    \textcolor{comment}{//Return status code}
1155    \textcolor{keywordflow}{return} error;
1156 \}
\end{DoxyCode}
