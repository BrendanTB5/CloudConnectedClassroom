\hypertarget{modbus__server__transport_8c}{}\section{cyclone\+\_\+tcp/modbus/modbus\+\_\+server\+\_\+transport.c File Reference}
\label{modbus__server__transport_8c}\index{cyclone\+\_\+tcp/modbus/modbus\+\_\+server\+\_\+transport.\+c@{cyclone\+\_\+tcp/modbus/modbus\+\_\+server\+\_\+transport.\+c}}


Transport protocol abstraction layer.  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+server.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+server\+\_\+security.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}modbus/modbus\+\_\+server\+\_\+transport.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{modbus__server__transport_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_aa132de375069fd85fe54b72fe90f445f}{M\+O\+D\+B\+U\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{modbus__server__transport_8c_a032f78cca9279673cd876e5ad16ec0c3}{modbus\+Server\+Accept\+Connection} (\hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{Modbus\+Server\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Accept connection request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__transport_8c_a5bd75a54a1ae882e617c6aaadb3fa2b7}{modbus\+Server\+Shutdown\+Connection} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Shutdown network connection. \end{DoxyCompactList}\item 
void \hyperlink{modbus__server__transport_8c_a9e14f681b81e91e9dfbe259c4bd63c04}{modbus\+Server\+Close\+Connection} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Close network connection. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__transport_8c_ac9ac428565a9d3386974118b5f392731}{modbus\+Server\+Send\+Data} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, const void $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, size\+\_\+t $\ast$written, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} \hyperlink{nbns__common_8h_a1e87af3c18a2fd36c61faf89949bdc3f}{flags})
\begin{DoxyCompactList}\small\item\em Send data using the relevant transport protocol. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{modbus__server__transport_8c_ac42714d64ead5f741c3167181de09121}{modbus\+Server\+Receive\+Data} (\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$connection, void $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t size, size\+\_\+t $\ast$received, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} \hyperlink{nbns__common_8h_a1e87af3c18a2fd36c61faf89949bdc3f}{flags})
\begin{DoxyCompactList}\small\item\em Receive data using the relevant transport protocol. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Transport protocol abstraction layer. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{modbus__server__transport_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{modbus__server__transport_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{modbus\+\_\+server\+\_\+transport.\+c@{modbus\+\_\+server\+\_\+transport.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!modbus\+\_\+server\+\_\+transport.\+c@{modbus\+\_\+server\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_aa132de375069fd85fe54b72fe90f445f}{M\+O\+D\+B\+U\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file modbus\+\_\+server\+\_\+transport.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{modbus__server__transport_8c_a032f78cca9279673cd876e5ad16ec0c3}\label{modbus__server__transport_8c_a032f78cca9279673cd876e5ad16ec0c3}} 
\index{modbus\+\_\+server\+\_\+transport.\+c@{modbus\+\_\+server\+\_\+transport.\+c}!modbus\+Server\+Accept\+Connection@{modbus\+Server\+Accept\+Connection}}
\index{modbus\+Server\+Accept\+Connection@{modbus\+Server\+Accept\+Connection}!modbus\+\_\+server\+\_\+transport.\+c@{modbus\+\_\+server\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Accept\+Connection()}{modbusServerAcceptConnection()}}
{\footnotesize\ttfamily void modbus\+Server\+Accept\+Connection (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a3a5f2957951349d3c053b1ebe94fe4f7}{Modbus\+Server\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Accept connection request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Modbus/\+T\+CP server context \\
\hline
\end{DoxyParams}


Definition at line 50 of file modbus\+\_\+server\+\_\+transport.\+c.


\begin{DoxyCode}
51 \{
52    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
53    \hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} *\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket};
54    \hyperlink{structIpAddr}{IpAddr} clientIpAddr;
55    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} clientPort;
56    \hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{ModbusClientConnection} *connection;
57 
58    \textcolor{comment}{//Accept incoming connection}
59    socket = \hyperlink{socket_8c_a00ec8a49fe1ee3597a0f7a2afbe46f00}{socketAccept}(context->socket, &clientIpAddr, &clientPort);
60 
61    \textcolor{comment}{//Make sure the socket handle is valid}
62    \textcolor{keywordflow}{if}(socket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
63    \{
64       \textcolor{comment}{//Force the socket to operate in non-blocking mode}
65       \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(socket, 0);
66 
67       \textcolor{comment}{//Initialize pointer}
68       connection = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
69 
70       \textcolor{comment}{//Loop through the connection table}
71       \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{modbus__server_8h_ae256368c84a889cda6e1e67109c23ee6}{MODBUS\_SERVER\_MAX\_CONNECTIONS}; i++)
72       \{
73          \textcolor{comment}{//Check the state of the current connection}
74          \textcolor{keywordflow}{if}(context->connection[i].state == \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbcafd635128f09907421773ddeaf15196bb}{MODBUS\_CONNECTION\_STATE\_CLOSED})
75          \{
76             \textcolor{comment}{//The current entry is free}
77             connection = &context->connection[i];
78             \textcolor{keywordflow}{break};
79          \}
80       \}
81 
82       \textcolor{comment}{//If the connection table runs out of space, then the client's connection}
83       \textcolor{comment}{//request is rejected}
84       \textcolor{keywordflow}{if}(connection != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
85       \{
86          \textcolor{comment}{//Debug message}
87          \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Connection established with client %s port %"}
88             PRIu16 \textcolor{stringliteral}{"...\(\backslash\)r\(\backslash\)n"}, \hyperlink{ip_8c_aecdb577de79f65f8c814d5f101c7c6ae}{ipAddrToString}(&clientIpAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}), clientPort);
89 
90          \textcolor{comment}{//Clear the structure describing the connection}
91          memset(connection, 0, \textcolor{keyword}{sizeof}(\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{ModbusClientConnection}));
92 
93          \textcolor{comment}{//Attach Modbus/TCP server context}
94          connection->context = context;
95          \textcolor{comment}{//Save socket handle}
96          connection->socket = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket};
97          \textcolor{comment}{//Initialize time stamp}
98          connection->timestamp = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
99 
100 \textcolor{preprocessor}{#if (MODBUS\_SERVER\_TLS\_SUPPORT == ENABLED)}
101          \textcolor{comment}{//TLS-secured connection?}
102          \textcolor{keywordflow}{if}(context->settings.tlsInitCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
103          \{
104             \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
105 
106             \textcolor{comment}{//TLS initialization}
107             error = \hyperlink{modbus__server__security_8c_abc0750f80b3eb72360c6bfc7f34bc935}{modbusServerOpenSecureConnection}(context, connection);
108 
109             \textcolor{comment}{//Check status code}
110             \textcolor{keywordflow}{if}(!error)
111             \{
112                \textcolor{comment}{//Perform TLS handshake}
113                connection->state = \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbca6c28a65402d48838ba46c3b4895aea2a}{MODBUS\_CONNECTION\_STATE\_CONNECT\_TLS};
114             \}
115             \textcolor{keywordflow}{else}
116             \{
117                \textcolor{comment}{//Close connection with the client}
118                \hyperlink{modbus__server__transport_8c_a9e14f681b81e91e9dfbe259c4bd63c04}{modbusServerCloseConnection}(connection);
119             \}
120          \}
121          \textcolor{keywordflow}{else}
122 \textcolor{preprocessor}{#endif}
123          \{
124             \textcolor{comment}{//Wait for incoming Modbus requests}
125             connection->state = \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbca695ff92b63e218a16af678dfb23d39fe}{MODBUS\_CONNECTION\_STATE\_RECEIVE};
126          \}
127       \}
128       \textcolor{keywordflow}{else}
129       \{
130          \textcolor{comment}{//Debug message}
131          \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Connection refused with client %s port %"}
132             PRIu16 \textcolor{stringliteral}{"...\(\backslash\)r\(\backslash\)n"}, \hyperlink{ip_8c_aecdb577de79f65f8c814d5f101c7c6ae}{ipAddrToString}(&clientIpAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}), clientPort);
133 
134          \textcolor{comment}{//The Modbus/TCP server cannot accept the incoming connection request}
135          \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(socket);
136       \}
137    \}
138 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__transport_8c_a9e14f681b81e91e9dfbe259c4bd63c04}\label{modbus__server__transport_8c_a9e14f681b81e91e9dfbe259c4bd63c04}} 
\index{modbus\+\_\+server\+\_\+transport.\+c@{modbus\+\_\+server\+\_\+transport.\+c}!modbus\+Server\+Close\+Connection@{modbus\+Server\+Close\+Connection}}
\index{modbus\+Server\+Close\+Connection@{modbus\+Server\+Close\+Connection}!modbus\+\_\+server\+\_\+transport.\+c@{modbus\+\_\+server\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Close\+Connection()}{modbusServerCloseConnection()}}
{\footnotesize\ttfamily void modbus\+Server\+Close\+Connection (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Close network connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}


Definition at line 215 of file modbus\+\_\+server\+\_\+transport.\+c.


\begin{DoxyCode}
216 \{
217    \textcolor{comment}{//Debug message}
218    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Modbus Server: Closing connection...\(\backslash\)r\(\backslash\)n"});
219 
220 \textcolor{preprocessor}{#if (MODBUS\_SERVER\_TLS\_SUPPORT == ENABLED)}
221    \textcolor{comment}{//Release TLS context}
222    \textcolor{keywordflow}{if}(connection->tlsContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
223    \{
224       \hyperlink{tls_8c_aec8c1957ad13f5ad67d07a872d5fe66b}{tlsFree}(connection->tlsContext);
225       connection->tlsContext = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
226    \}
227 \textcolor{preprocessor}{#endif}
228 
229    \textcolor{comment}{//Close TCP connection}
230    \textcolor{keywordflow}{if}(connection->socket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
231    \{
232       \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(connection->socket);
233       connection->socket = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
234    \}
235 
236    \textcolor{comment}{//Mark the connection as closed}
237    connection->state = \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbcafd635128f09907421773ddeaf15196bb}{MODBUS\_CONNECTION\_STATE\_CLOSED};
238 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__transport_8c_ac42714d64ead5f741c3167181de09121}\label{modbus__server__transport_8c_ac42714d64ead5f741c3167181de09121}} 
\index{modbus\+\_\+server\+\_\+transport.\+c@{modbus\+\_\+server\+\_\+transport.\+c}!modbus\+Server\+Receive\+Data@{modbus\+Server\+Receive\+Data}}
\index{modbus\+Server\+Receive\+Data@{modbus\+Server\+Receive\+Data}!modbus\+\_\+server\+\_\+transport.\+c@{modbus\+\_\+server\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Receive\+Data()}{modbusServerReceiveData()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Receive\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{void $\ast$}]{data,  }\item[{size\+\_\+t}]{size,  }\item[{size\+\_\+t $\ast$}]{received,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{flags }\end{DoxyParamCaption})}



Receive data using the relevant transport protocol. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt out}  & {\em data} & Buffer into which received data will be placed \\
\hline
\mbox{\tt in}  & {\em size} & Maximum number of bytes that can be received \\
\hline
\mbox{\tt out}  & {\em received} & Number of bytes that have been received \\
\hline
\mbox{\tt in}  & {\em flags} & Set of flags that influences the behavior of this function \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 285 of file modbus\+\_\+server\+\_\+transport.\+c.


\begin{DoxyCode}
287 \{
288    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
289 
290 \textcolor{preprocessor}{#if (MODBUS\_SERVER\_TLS\_SUPPORT == ENABLED)}
291    \textcolor{comment}{//TLS-secured connection?}
292    \textcolor{keywordflow}{if}(connection->tlsContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
293    \{
294       \textcolor{comment}{//Receive TLS-encrypted data}
295       error = \hyperlink{tls_8c_a6aa09693d0cdc6e93d9b88a6331bc247}{tlsRead}(connection->tlsContext, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size, received, 
      \hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags});
296    \}
297    \textcolor{keywordflow}{else}
298 \textcolor{preprocessor}{#endif}
299    \{
300       \textcolor{comment}{//Receive data}
301       error = \hyperlink{socket_8c_a894c7bf0bfd4e3886fc584ed7ebbb087}{socketReceive}(connection->socket, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size, received, 
      \hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags});
302    \}
303 
304    \textcolor{comment}{//Return status code}
305    \textcolor{keywordflow}{return} error;
306 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__transport_8c_ac9ac428565a9d3386974118b5f392731}\label{modbus__server__transport_8c_ac9ac428565a9d3386974118b5f392731}} 
\index{modbus\+\_\+server\+\_\+transport.\+c@{modbus\+\_\+server\+\_\+transport.\+c}!modbus\+Server\+Send\+Data@{modbus\+Server\+Send\+Data}}
\index{modbus\+Server\+Send\+Data@{modbus\+Server\+Send\+Data}!modbus\+\_\+server\+\_\+transport.\+c@{modbus\+\_\+server\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Send\+Data()}{modbusServerSendData()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Send\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection,  }\item[{const void $\ast$}]{data,  }\item[{size\+\_\+t}]{length,  }\item[{size\+\_\+t $\ast$}]{written,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{flags }\end{DoxyParamCaption})}



Send data using the relevant transport protocol. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to a buffer containing the data to be transmitted \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes to be transmitted \\
\hline
\mbox{\tt out}  & {\em written} & Actual number of bytes written (optional parameter) \\
\hline
\mbox{\tt in}  & {\em flags} & Set of flags that influences the behavior of this function \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 251 of file modbus\+\_\+server\+\_\+transport.\+c.


\begin{DoxyCode}
253 \{
254    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
255 
256 \textcolor{preprocessor}{#if (MODBUS\_SERVER\_TLS\_SUPPORT == ENABLED)}
257    \textcolor{comment}{//TLS-secured connection?}
258    \textcolor{keywordflow}{if}(connection->tlsContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
259    \{
260       \textcolor{comment}{//Send TLS-encrypted data}
261       error = \hyperlink{tls_8c_a1b4b22502217a601f7f094403e700b4b}{tlsWrite}(connection->tlsContext, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, written, 
      \hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags});
262    \}
263    \textcolor{keywordflow}{else}
264 \textcolor{preprocessor}{#endif}
265    \{
266       \textcolor{comment}{//Transmit data}
267       error = \hyperlink{socket_8c_aa4eeb3a3294d14d681675ba9f0d3e568}{socketSend}(connection->socket, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, written, 
      \hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags});
268    \}
269 
270    \textcolor{comment}{//Return status code}
271    \textcolor{keywordflow}{return} error;
272 \}
\end{DoxyCode}
\mbox{\Hypertarget{modbus__server__transport_8c_a5bd75a54a1ae882e617c6aaadb3fa2b7}\label{modbus__server__transport_8c_a5bd75a54a1ae882e617c6aaadb3fa2b7}} 
\index{modbus\+\_\+server\+\_\+transport.\+c@{modbus\+\_\+server\+\_\+transport.\+c}!modbus\+Server\+Shutdown\+Connection@{modbus\+Server\+Shutdown\+Connection}}
\index{modbus\+Server\+Shutdown\+Connection@{modbus\+Server\+Shutdown\+Connection}!modbus\+\_\+server\+\_\+transport.\+c@{modbus\+\_\+server\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{modbus\+Server\+Shutdown\+Connection()}{modbusServerShutdownConnection()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} modbus\+Server\+Shutdown\+Connection (\begin{DoxyParamCaption}\item[{\hyperlink{modbus__server_8h_a9bb52dfbcf1ed2f018736b720a3b0748}{Modbus\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Shutdown network connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 147 of file modbus\+\_\+server\+\_\+transport.\+c.


\begin{DoxyCode}
148 \{
149    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
150 
151    \textcolor{comment}{//Initialize status code}
152    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
153 
154    \textcolor{comment}{//Check the state of the connection}
155    \textcolor{keywordflow}{if}(connection->state == \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbca695ff92b63e218a16af678dfb23d39fe}{MODBUS\_CONNECTION\_STATE\_RECEIVE})
156    \{
157 \textcolor{preprocessor}{#if (MODBUS\_SERVER\_TLS\_SUPPORT == ENABLED)}
158       \textcolor{comment}{//TLS-secured connection?}
159       \textcolor{keywordflow}{if}(connection->tlsContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
160       \{
161          \textcolor{comment}{//Gracefully close TLS connection}
162          connection->state = \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbca71d3d4f43ce3f104b57faecd7f13f00d}{MODBUS\_CONNECTION\_STATE\_SHUTDOWN\_TLS};
163       \}
164       \textcolor{keywordflow}{else}
165 \textcolor{preprocessor}{#endif}
166       \{
167          \textcolor{comment}{//Shutdown transmission}
168          error = \hyperlink{socket_8c_acc736b53dba4a0d3b11b63f75cdcfffb}{socketShutdown}(connection->socket, \hyperlink{socket_8h_a36ee33c18de64f549a6336d1aa7333b7a535dc5f70a642b86e56e6e83ce2a3378}{SOCKET\_SD\_SEND});
169          \textcolor{comment}{//Update connection state}
170          connection->state = \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbcadce5cb26624490f2c00f0fcb745ec8e7}{MODBUS\_CONNECTION\_STATE\_SHUTDOWN\_TX};
171       \}
172    \}
173    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->state == \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbca71d3d4f43ce3f104b57faecd7f13f00d}{MODBUS\_CONNECTION\_STATE\_SHUTDOWN\_TLS})
174    \{
175 \textcolor{preprocessor}{#if (MODBUS\_SERVER\_TLS\_SUPPORT == ENABLED)}
176       \textcolor{comment}{//Gracefully close TLS session}
177       error = \hyperlink{tls_8c_ae6a631703510008537d2cd97ab3425ef}{tlsShutdown}(connection->tlsContext);
178 
179       \textcolor{comment}{//Check status code}
180       \textcolor{keywordflow}{if}(!error)
181       \{
182          \textcolor{comment}{//Shutdown transmission}
183          error = \hyperlink{socket_8c_acc736b53dba4a0d3b11b63f75cdcfffb}{socketShutdown}(connection->socket, \hyperlink{socket_8h_a36ee33c18de64f549a6336d1aa7333b7a535dc5f70a642b86e56e6e83ce2a3378}{SOCKET\_SD\_SEND});
184          \textcolor{comment}{//Update connection state}
185          connection->state = \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbcadce5cb26624490f2c00f0fcb745ec8e7}{MODBUS\_CONNECTION\_STATE\_SHUTDOWN\_TX};
186       \}
187 \textcolor{preprocessor}{#else}
188       \textcolor{comment}{//Modbus/TCP security is not implemented}
189       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
190 \textcolor{preprocessor}{#endif}
191    \}
192    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->state == \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbcadce5cb26624490f2c00f0fcb745ec8e7}{MODBUS\_CONNECTION\_STATE\_SHUTDOWN\_TX})
193    \{
194       \textcolor{comment}{//Shutdown reception}
195       error = \hyperlink{socket_8c_acc736b53dba4a0d3b11b63f75cdcfffb}{socketShutdown}(connection->socket, \hyperlink{socket_8h_a36ee33c18de64f549a6336d1aa7333b7a88cccdaadbcce09cccd7561d10af6a39}{SOCKET\_SD\_RECEIVE});
196       \textcolor{comment}{//Update connection state}
197       connection->state = \hyperlink{modbus__server_8h_a833fbe8b8a0937e5fd644bcad5b11fbcaa138bd6f722ab8588e3b5e8e0d3b4420}{MODBUS\_CONNECTION\_STATE\_SHUTDOWN\_RX};
198    \}
199    \textcolor{keywordflow}{else}
200    \{
201       \textcolor{comment}{//Invalid state}
202       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac3190fa1f36c6acf147c7ce453a655e2}{ERROR\_WRONG\_STATE};
203    \}
204 
205    \textcolor{comment}{//Return status code}
206    \textcolor{keywordflow}{return} error;
207 \}
\end{DoxyCode}
