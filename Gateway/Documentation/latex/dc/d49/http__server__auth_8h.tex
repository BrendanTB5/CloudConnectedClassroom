\hypertarget{http__server__auth_8h}{}\section{cyclone\+\_\+tcp/http/http\+\_\+server\+\_\+auth.h File Reference}
\label{http__server__auth_8h}\index{cyclone\+\_\+tcp/http/http\+\_\+server\+\_\+auth.\+h@{cyclone\+\_\+tcp/http/http\+\_\+server\+\_\+auth.\+h}}


H\+T\+TP authentication.  


{\ttfamily \#include \char`\"{}http/http\+\_\+server.\+h\char`\"{}}\newline
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} \hyperlink{http__server__auth_8h_ab7b495fbb0dc6b79ab4567a62c04f550}{http\+Check\+Password} (\hyperlink{http__server_8h_a3506ecffde998ab02629dca83587d2f9}{Http\+Connection} $\ast$connection, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$password, \hyperlink{http__common_8h_ad435f9e57a3351beaec6fc809eff4f31}{Http\+Auth\+Mode} \hyperlink{ntp__common_8h_a37e90f5e3bd99fac2021fb3a326607d4}{mode})
\begin{DoxyCompactList}\small\item\em Password verification. \end{DoxyCompactList}\item 
void \hyperlink{http__server__auth_8h_a9bd78533b70da214a81f5db0ff6094c4}{http\+Parse\+Authorization\+Field} (\hyperlink{http__server_8h_a3506ecffde998ab02629dca83587d2f9}{Http\+Connection} $\ast$connection, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$\hyperlink{chap_8h_adfa040d04d16520129a735fff8fb1628}{value})
\begin{DoxyCompactList}\small\item\em Parse Authorization header field. \end{DoxyCompactList}\item 
size\+\_\+t \hyperlink{http__server__auth_8h_aa50426334c1e185f62b4436afcddbe6c}{http\+Add\+Authenticate\+Field} (\hyperlink{http__server_8h_a3506ecffde998ab02629dca83587d2f9}{Http\+Connection} $\ast$connection, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$output)
\begin{DoxyCompactList}\small\item\em Format W\+W\+W-\/\+Authenticate header field. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{http__server__auth_8h_a8918b57f2757f94905439ed02e9f54ba}{http\+Generate\+Nonce} (\hyperlink{http__server_8h_a952abbfa31a2188c3d65357e79531e03}{Http\+Server\+Context} $\ast$context, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$output, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Nonce generation. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{http__server__auth_8h_ae3937b17c870ba6ff31c9242d3c7b526}{http\+Verify\+Nonce} (\hyperlink{http__server_8h_a952abbfa31a2188c3d65357e79531e03}{Http\+Server\+Context} $\ast$context, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$nonce, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$nc)
\begin{DoxyCompactList}\small\item\em Nonce verification. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
H\+T\+TP authentication. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Function Documentation}
\mbox{\Hypertarget{http__server__auth_8h_aa50426334c1e185f62b4436afcddbe6c}\label{http__server__auth_8h_aa50426334c1e185f62b4436afcddbe6c}} 
\index{http\+\_\+server\+\_\+auth.\+h@{http\+\_\+server\+\_\+auth.\+h}!http\+Add\+Authenticate\+Field@{http\+Add\+Authenticate\+Field}}
\index{http\+Add\+Authenticate\+Field@{http\+Add\+Authenticate\+Field}!http\+\_\+server\+\_\+auth.\+h@{http\+\_\+server\+\_\+auth.\+h}}
\subsubsection{\texorpdfstring{http\+Add\+Authenticate\+Field()}{httpAddAuthenticateField()}}
{\footnotesize\ttfamily size\+\_\+t http\+Add\+Authenticate\+Field (\begin{DoxyParamCaption}\item[{\hyperlink{http__server_8h_a3506ecffde998ab02629dca83587d2f9}{Http\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{output }\end{DoxyParamCaption})}



Format W\+W\+W-\/\+Authenticate header field. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Structure representing an H\+T\+TP connection \\
\hline
\mbox{\tt out}  & {\em output} & Buffer where to format the header field \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Total length of the header field 
\end{DoxyReturn}


Definition at line 400 of file http\+\_\+server\+\_\+auth.\+c.


\begin{DoxyCode}
401 \{
402    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
403 
404 \textcolor{preprocessor}{#if (HTTP\_SERVER\_BASIC\_AUTH\_SUPPORT == ENABLED)}
405    \textcolor{comment}{//Basic authentication scheme?}
406    \textcolor{keywordflow}{if}(connection->response.auth.mode == \hyperlink{http__common_8h_ad435f9e57a3351beaec6fc809eff4f31ae59e35c78d081e09a92601aedbde57d5}{HTTP\_AUTH\_MODE\_BASIC})
407    \{
408       \textcolor{comment}{//Set WWW-Authenticate field}
409       n = sprintf(output, \textcolor{stringliteral}{"WWW-Authenticate: Basic realm=\(\backslash\)"Protected Area\(\backslash\)"\(\backslash\)r\(\backslash\)n"});
410    \}
411    \textcolor{keywordflow}{else}
412 \textcolor{preprocessor}{#endif}
413 \textcolor{preprocessor}{#if (HTTP\_SERVER\_DIGEST\_AUTH\_SUPPORT == ENABLED)}
414    \textcolor{comment}{//Digest authentication scheme?}
415    \textcolor{keywordflow}{if}(connection->response.auth.mode == \hyperlink{http__common_8h_ad435f9e57a3351beaec6fc809eff4f31a0ca9d6eab847100994632261a80833df}{HTTP\_AUTH\_MODE\_DIGEST})
416    \{
417       \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
418       \textcolor{keywordtype}{size\_t} \hyperlink{md5_8c_af11ea3cdbca7345eb6a4a8ac5ce0434d}{k};
419       \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} opaque[16];
420 
421       \textcolor{comment}{//Set WWW-Authenticate field}
422       n = sprintf(output, \textcolor{stringliteral}{"WWW-Authenticate: Digest\(\backslash\)r\(\backslash\)n"});
423       n += sprintf(output + n, \textcolor{stringliteral}{"  realm=\(\backslash\)"Protected Area\(\backslash\)",\(\backslash\)r\(\backslash\)n"});
424       n += sprintf(output + n, \textcolor{stringliteral}{"  qop=\(\backslash\)"auth\(\backslash\)",\(\backslash\)r\(\backslash\)n"});
425       n += sprintf(output + n, \textcolor{stringliteral}{"  nonce=\(\backslash\)""});
426 
427       \textcolor{comment}{//The nonce is a server-specified data string which should be uniquely}
428       \textcolor{comment}{//generated each time a 401 response is made}
429       error = \hyperlink{http__server__auth_8c_a8918b57f2757f94905439ed02e9f54ba}{httpGenerateNonce}(connection->serverContext, output + n, &k);
430       \textcolor{comment}{//Any error to report?}
431       \textcolor{keywordflow}{if}(error)
432          \textcolor{keywordflow}{return} error;
433 
434       \textcolor{comment}{//Advance pointer}
435       n += \hyperlink{md5_8c_af11ea3cdbca7345eb6a4a8ac5ce0434d}{k};
436       \textcolor{comment}{//Properly terminate the nonce string}
437       n += sprintf(output + n, \textcolor{stringliteral}{"\(\backslash\)",\(\backslash\)r\(\backslash\)n"});
438 
439       \textcolor{comment}{//Format opaque parameter}
440       n += sprintf(output + n, \textcolor{stringliteral}{"  opaque=\(\backslash\)""});
441 
442       \textcolor{comment}{//Generate a random value}
443       \textcolor{keywordflow}{if}(connection->settings->randCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
444          error = connection->settings->randCallback(opaque, 16);
445       \textcolor{keywordflow}{else}
446          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
447 
448       \textcolor{comment}{//Random number generation failed?}
449       \textcolor{keywordflow}{if}(error)
450          \textcolor{keywordflow}{return} error;
451 
452       \textcolor{comment}{//Convert the byte array to hex string}
453       \hyperlink{http__server__misc_8c_a645bdf3cbf9b810deecbe5258790ae4d}{httpConvertArrayToHexString}(opaque, 16, output + n);
454 
455       \textcolor{comment}{//Advance pointer}
456       n += 32;
457       \textcolor{comment}{//Properly terminate the opaque string}
458       n += sprintf(output + n, \textcolor{stringliteral}{"\(\backslash\)""});
459 
460       \textcolor{comment}{//The STALE flag indicates that the previous request from the client}
461       \textcolor{comment}{//was rejected because the nonce value was stale}
462       \textcolor{keywordflow}{if}(connection->response.auth.stale)
463          n += sprintf(output + n, \textcolor{stringliteral}{",\(\backslash\)r\(\backslash\)n  stale=TRUE"});
464 
465       \textcolor{comment}{//Properly terminate the WWW-Authenticate field}
466       n += sprintf(output + n, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"});
467    \}
468    \textcolor{keywordflow}{else}
469 \textcolor{preprocessor}{#endif}
470    \textcolor{comment}{//Unknown authentication scheme?}
471    \{
472       \textcolor{comment}{//No need to add the WWW-Authenticate header field}
473       n = 0;
474    \}
475 
476    \textcolor{comment}{//Return the total length of the WWW-Authenticate header field}
477    \textcolor{keywordflow}{return} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
478 \}
\end{DoxyCode}
\mbox{\Hypertarget{http__server__auth_8h_ab7b495fbb0dc6b79ab4567a62c04f550}\label{http__server__auth_8h_ab7b495fbb0dc6b79ab4567a62c04f550}} 
\index{http\+\_\+server\+\_\+auth.\+h@{http\+\_\+server\+\_\+auth.\+h}!http\+Check\+Password@{http\+Check\+Password}}
\index{http\+Check\+Password@{http\+Check\+Password}!http\+\_\+server\+\_\+auth.\+h@{http\+\_\+server\+\_\+auth.\+h}}
\subsubsection{\texorpdfstring{http\+Check\+Password()}{httpCheckPassword()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} http\+Check\+Password (\begin{DoxyParamCaption}\item[{\hyperlink{http__server_8h_a3506ecffde998ab02629dca83587d2f9}{Http\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{password,  }\item[{\hyperlink{http__common_8h_ad435f9e57a3351beaec6fc809eff4f31}{Http\+Auth\+Mode}}]{mode }\end{DoxyParamCaption})}



Password verification. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Structure representing an H\+T\+TP connection \\
\hline
\mbox{\tt in}  & {\em password} & N\+U\+L\+L-\/terminated string containing the password to be checked \\
\hline
\mbox{\tt in}  & {\em mode} & H\+T\+TP authentication scheme to be used. Acceptable values are H\+T\+T\+P\+\_\+\+A\+U\+T\+H\+\_\+\+M\+O\+D\+E\+\_\+\+B\+A\+S\+IC or H\+T\+T\+P\+\_\+\+A\+U\+T\+H\+\_\+\+M\+O\+D\+E\+\_\+\+D\+I\+G\+E\+ST \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
T\+R\+UE if the password is valid, else F\+A\+L\+SE 
\end{DoxyReturn}


Definition at line 56 of file http\+\_\+server\+\_\+auth.\+c.


\begin{DoxyCode}
58 \{
59    \textcolor{comment}{//This flag tells whether the password is valid}
60    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} status = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
61 
62    \textcolor{comment}{//Debug message}
63    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"HTTP password verification...\(\backslash\)r\(\backslash\)n"});
64 
65 \textcolor{preprocessor}{#if (HTTP\_SERVER\_BASIC\_AUTH\_SUPPORT == ENABLED)}
66    \textcolor{comment}{//Basic authentication scheme?}
67    \textcolor{keywordflow}{if}(\hyperlink{ntp__common_8h_a37e90f5e3bd99fac2021fb3a326607d4}{mode} == \hyperlink{http__common_8h_ad435f9e57a3351beaec6fc809eff4f31ae59e35c78d081e09a92601aedbde57d5}{HTTP\_AUTH\_MODE\_BASIC})
68    \{
69       \textcolor{comment}{//Point to the authentication credentials}
70       \hyperlink{structHttpAuthorizationHeader}{HttpAuthorizationHeader} *auth = &connection->request.auth;
71 
72       \textcolor{comment}{//Make sure authentication credentials have been found}
73       \textcolor{keywordflow}{if}(auth->\hyperlink{structHttpAuthorizationHeader_a9d3817d89289e9abd71f3d6140ea4551}{found} && auth->\hyperlink{structHttpAuthorizationHeader_a806d5ed8b0f618361cfe251571605623}{mode} == \hyperlink{http__common_8h_ad435f9e57a3351beaec6fc809eff4f31ae59e35c78d081e09a92601aedbde57d5}{HTTP\_AUTH\_MODE\_BASIC})
74       \{
75          \textcolor{comment}{//Sanity check}
76          \textcolor{keywordflow}{if}(auth->\hyperlink{structHttpAuthorizationHeader_aee82edefb89b600f4cd02d20e060c81f}{password} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
77          \{
78             \textcolor{comment}{//Check whether the password is valid}
79             \textcolor{keywordflow}{if}(!strcmp(password, auth->\hyperlink{structHttpAuthorizationHeader_aee82edefb89b600f4cd02d20e060c81f}{password}))
80                status = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
81          \}
82       \}
83    \}
84 \textcolor{preprocessor}{#endif}
85 \textcolor{preprocessor}{#if (HTTP\_SERVER\_DIGEST\_AUTH\_SUPPORT == ENABLED)}
86    \textcolor{comment}{//Digest authentication scheme?}
87    \textcolor{keywordflow}{if}(\hyperlink{ntp__common_8h_a37e90f5e3bd99fac2021fb3a326607d4}{mode} == \hyperlink{http__common_8h_ad435f9e57a3351beaec6fc809eff4f31a0ca9d6eab847100994632261a80833df}{HTTP\_AUTH\_MODE\_DIGEST})
88    \{
89       \textcolor{comment}{//Point to the authentication credentials}
90       \hyperlink{structHttpAuthorizationHeader}{HttpAuthorizationHeader} *auth = &connection->request.auth;
91 
92       \textcolor{comment}{//Make sure authentication credentials have been found}
93       \textcolor{keywordflow}{if}(auth->\hyperlink{structHttpAuthorizationHeader_a9d3817d89289e9abd71f3d6140ea4551}{found} && auth->\hyperlink{structHttpAuthorizationHeader_a806d5ed8b0f618361cfe251571605623}{mode} == \hyperlink{http__common_8h_ad435f9e57a3351beaec6fc809eff4f31a0ca9d6eab847100994632261a80833df}{HTTP\_AUTH\_MODE\_DIGEST})
94       \{
95          \textcolor{comment}{//Sanity check}
96          \textcolor{keywordflow}{if}(auth->\hyperlink{structHttpAuthorizationHeader_a1a9b313d0b2bcb0f2de620d87f3638cf}{realm} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && auth->\hyperlink{structHttpAuthorizationHeader_ad414b477649a2aab5094559a281786b3}{nonce} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} &&
97             auth->\hyperlink{structHttpAuthorizationHeader_a50fc4f4b4c0adbc85cfbd93a31ff6cfa}{uri} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && auth->\hyperlink{structHttpAuthorizationHeader_aa4898fb5e5bf52971ec735c9111ce9dd}{qop} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} &&
98             auth->\hyperlink{structHttpAuthorizationHeader_a7ecc070d92b64c544a5a3d036a3ff2d6}{nc} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && auth->\hyperlink{structHttpAuthorizationHeader_aa5dda5ba9a1648e6532776151b09fe0e}{cnonce} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} &&
99             auth->\hyperlink{structHttpAuthorizationHeader_ab9af82caf503c954449395b5d3473d42}{response} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
100          \{
101             \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
102             \hyperlink{structMd5Context}{Md5Context} *md5Context;
103             \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} ha1[2 * \hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE} + 1];
104             \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} ha2[2 * \hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE} + 1];
105 
106             \textcolor{comment}{//Allocate a memory buffer to hold the MD5 context}
107             md5Context = \hyperlink{os__port__chibios_8c_ae86758dcd9fc3c98247ae19815987c9a}{osAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structMd5Context}{Md5Context}));
108 
109             \textcolor{comment}{//MD5 context successfully allocated?}
110             \textcolor{keywordflow}{if}(md5Context != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
111             \{
112                \textcolor{comment}{//Compute HA1 = MD5(username : realm : password)}
113                \hyperlink{md5_8c_acc37d4333236797f144067f5c39f345e}{md5Init}(md5Context);
114                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, auth->\hyperlink{structHttpAuthorizationHeader_aef9993b1c33a9664627f69962471772d}{user}, strlen(auth->\hyperlink{structHttpAuthorizationHeader_aef9993b1c33a9664627f69962471772d}{user}));
115                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, \textcolor{stringliteral}{":"}, 1);
116                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, auth->\hyperlink{structHttpAuthorizationHeader_a1a9b313d0b2bcb0f2de620d87f3638cf}{realm}, strlen(auth->
      \hyperlink{structHttpAuthorizationHeader_a1a9b313d0b2bcb0f2de620d87f3638cf}{realm}));
117                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, \textcolor{stringliteral}{":"}, 1);
118                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, password, strlen(password));
119                \hyperlink{md5_8c_add832f9f73d9df95f48bed551122df55}{md5Final}(md5Context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
120 
121                \textcolor{comment}{//Convert MD5 hash to hex string}
122                \hyperlink{http__server__misc_8c_a645bdf3cbf9b810deecbe5258790ae4d}{httpConvertArrayToHexString}(md5Context->
      \hyperlink{structMd5Context_a2f29146370d91b5b9b9a6bd6f9b8f79b}{digest}, \hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE}, ha1);
123                \textcolor{comment}{//Debug message}
124                \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  HA1: %s\(\backslash\)r\(\backslash\)n"}, ha1);
125 
126                \textcolor{comment}{//Compute HA2 = MD5(method : uri)}
127                \hyperlink{md5_8c_acc37d4333236797f144067f5c39f345e}{md5Init}(md5Context);
128                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, connection->request.method, strlen(connection->request.method
      ));
129                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, \textcolor{stringliteral}{":"}, 1);
130                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, auth->\hyperlink{structHttpAuthorizationHeader_a50fc4f4b4c0adbc85cfbd93a31ff6cfa}{uri}, strlen(auth->\hyperlink{structHttpAuthorizationHeader_a50fc4f4b4c0adbc85cfbd93a31ff6cfa}{uri}));
131                \hyperlink{md5_8c_add832f9f73d9df95f48bed551122df55}{md5Final}(md5Context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
132 
133                \textcolor{comment}{//Convert MD5 hash to hex string}
134                \hyperlink{http__server__misc_8c_a645bdf3cbf9b810deecbe5258790ae4d}{httpConvertArrayToHexString}(md5Context->
      \hyperlink{structMd5Context_a2f29146370d91b5b9b9a6bd6f9b8f79b}{digest}, \hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE}, ha2);
135                \textcolor{comment}{//Debug message}
136                \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  HA2: %s\(\backslash\)r\(\backslash\)n"}, ha2);
137 
138                \textcolor{comment}{//Compute MD5(HA1 : nonce : nc : cnonce : qop : HA2)}
139                \hyperlink{md5_8c_acc37d4333236797f144067f5c39f345e}{md5Init}(md5Context);
140                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, ha1, strlen(ha1));
141                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, \textcolor{stringliteral}{":"}, 1);
142                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, auth->\hyperlink{structHttpAuthorizationHeader_ad414b477649a2aab5094559a281786b3}{nonce}, strlen(auth->
      \hyperlink{structHttpAuthorizationHeader_ad414b477649a2aab5094559a281786b3}{nonce}));
143                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, \textcolor{stringliteral}{":"}, 1);
144                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, auth->\hyperlink{structHttpAuthorizationHeader_a7ecc070d92b64c544a5a3d036a3ff2d6}{nc}, strlen(auth->\hyperlink{structHttpAuthorizationHeader_a7ecc070d92b64c544a5a3d036a3ff2d6}{nc}));
145                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, \textcolor{stringliteral}{":"}, 1);
146                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, auth->\hyperlink{structHttpAuthorizationHeader_aa5dda5ba9a1648e6532776151b09fe0e}{cnonce}, strlen(auth->
      \hyperlink{structHttpAuthorizationHeader_aa5dda5ba9a1648e6532776151b09fe0e}{cnonce}));
147                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, \textcolor{stringliteral}{":"}, 1);
148                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, auth->\hyperlink{structHttpAuthorizationHeader_aa4898fb5e5bf52971ec735c9111ce9dd}{qop}, strlen(auth->\hyperlink{structHttpAuthorizationHeader_aa4898fb5e5bf52971ec735c9111ce9dd}{qop}));
149                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, \textcolor{stringliteral}{":"}, 1);
150                \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, ha2, strlen(ha2));
151                \hyperlink{md5_8c_add832f9f73d9df95f48bed551122df55}{md5Final}(md5Context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
152 
153                \textcolor{comment}{//Convert MD5 hash to hex string}
154                \hyperlink{http__server__misc_8c_a645bdf3cbf9b810deecbe5258790ae4d}{httpConvertArrayToHexString}(md5Context->
      \hyperlink{structMd5Context_a2f29146370d91b5b9b9a6bd6f9b8f79b}{digest}, \hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE}, ha1);
155                \textcolor{comment}{//Debug message}
156                \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  response: %s\(\backslash\)r\(\backslash\)n"}, ha1);
157 
158                \textcolor{comment}{//Release MD5 context}
159                \hyperlink{os__port__chibios_8c_a68e4fa4326f2031eab28b92a25f2d68d}{osFreeMem}(md5Context);
160 
161                \textcolor{comment}{//Check response}
162                \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(auth->\hyperlink{structHttpAuthorizationHeader_ab9af82caf503c954449395b5d3473d42}{response}, ha1))
163                \{
164                   \textcolor{comment}{//Perform nonce verification}
165                   error = \hyperlink{http__server__auth_8c_ae3937b17c870ba6ff31c9242d3c7b526}{httpVerifyNonce}(connection->serverContext, auth->
      \hyperlink{structHttpAuthorizationHeader_ad414b477649a2aab5094559a281786b3}{nonce}, auth->\hyperlink{structHttpAuthorizationHeader_a7ecc070d92b64c544a5a3d036a3ff2d6}{nc});
166 
167                   \textcolor{comment}{//Valid nonce?}
168                   \textcolor{keywordflow}{if}(!error)
169                   \{
170                      \textcolor{comment}{//Access to the resource is granted}
171                      status = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
172                   \}
173                   \textcolor{keywordflow}{else}
174                   \{
175                      \textcolor{comment}{//The client may wish to simply retry the request with a}
176                      \textcolor{comment}{//new encrypted response, without re-prompting the user}
177                      \textcolor{comment}{//for a new username and password}
178                      connection->response.auth.stale = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
179                   \}
180                \}
181             \}
182          \}
183       \}
184    \}
185 \textcolor{preprocessor}{#endif}
186 
187    \textcolor{comment}{//Return TRUE is the password is valid, else FALSE}
188    \textcolor{keywordflow}{return} status;
189 \}
\end{DoxyCode}
\mbox{\Hypertarget{http__server__auth_8h_a8918b57f2757f94905439ed02e9f54ba}\label{http__server__auth_8h_a8918b57f2757f94905439ed02e9f54ba}} 
\index{http\+\_\+server\+\_\+auth.\+h@{http\+\_\+server\+\_\+auth.\+h}!http\+Generate\+Nonce@{http\+Generate\+Nonce}}
\index{http\+Generate\+Nonce@{http\+Generate\+Nonce}!http\+\_\+server\+\_\+auth.\+h@{http\+\_\+server\+\_\+auth.\+h}}
\subsubsection{\texorpdfstring{http\+Generate\+Nonce()}{httpGenerateNonce()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} http\+Generate\+Nonce (\begin{DoxyParamCaption}\item[{\hyperlink{http__server_8h_a952abbfa31a2188c3d65357e79531e03}{Http\+Server\+Context} $\ast$}]{context,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{output,  }\item[{size\+\_\+t $\ast$}]{length }\end{DoxyParamCaption})}



Nonce generation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the H\+T\+TP server context \\
\hline
\mbox{\tt in}  & {\em output} & N\+U\+L\+L-\/terminated string containing the nonce \\
\hline
\mbox{\tt in}  & {\em length} & N\+U\+L\+L-\/terminated string containing the nonce count \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 489 of file http\+\_\+server\+\_\+auth.\+c.


\begin{DoxyCode}
491 \{
492 \textcolor{preprocessor}{#if (HTTP\_SERVER\_DIGEST\_AUTH\_SUPPORT == ENABLED)}
493    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
494    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
495    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
496    \hyperlink{structHttpNonceCacheEntry}{HttpNonceCacheEntry} *entry;
497    \hyperlink{structHttpNonceCacheEntry}{HttpNonceCacheEntry} *oldestEntry;
498    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} nonce[\hyperlink{http__server_8h_abdefce676451bc1bf439d264f510abd7}{HTTP\_SERVER\_NONCE\_SIZE}];
499 
500    \textcolor{comment}{//Acquire exclusive access to the nonce cache}
501    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&context->nonceCacheMutex);
502 
503    \textcolor{comment}{//Get current time}
504    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
505 
506    \textcolor{comment}{//Keep track of the oldest entry}
507    oldestEntry = &context->nonceCache[0];
508 
509    \textcolor{comment}{//Loop through nonce cache entries}
510    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{http__server_8h_ad440bedce9872300d063b72fa5e2cd7a}{HTTP\_SERVER\_NONCE\_CACHE\_SIZE}; i++)
511    \{
512       \textcolor{comment}{//Point to the current entry}
513       entry = &context->nonceCache[i];
514 
515       \textcolor{comment}{//Check whether the entry is currently in used or not}
516       \textcolor{keywordflow}{if}(!entry->\hyperlink{structHttpNonceCacheEntry_af4406b01e0c26184c5374d4287b6a07b}{count})
517          \textcolor{keywordflow}{break};
518 
519       \textcolor{comment}{//Keep track of the oldest entry in the table}
520       \textcolor{keywordflow}{if}((time - entry->\hyperlink{structHttpNonceCacheEntry_aeb380011ddae3854b054d0a06ce7af97}{timestamp}) > (time - oldestEntry->\hyperlink{structHttpNonceCacheEntry_aeb380011ddae3854b054d0a06ce7af97}{timestamp}))
521       \{
522          oldestEntry = entry;
523       \}
524    \}
525 
526    \textcolor{comment}{//The oldest entry is removed whenever the table runs out of space}
527    \textcolor{keywordflow}{if}(i >= HTTP\_SERVER\_NONCE\_CACHE\_SIZE)
528       entry = oldestEntry;
529 
530    \textcolor{comment}{//Generate a new nonce}
531    \textcolor{keywordflow}{if}(context->settings.randCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
532       error = context->settings.randCallback(nonce, \hyperlink{http__server_8h_abdefce676451bc1bf439d264f510abd7}{HTTP\_SERVER\_NONCE\_SIZE});
533    \textcolor{keywordflow}{else}
534       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
535 
536    \textcolor{comment}{//Check status code}
537    \textcolor{keywordflow}{if}(!error)
538    \{
539       \textcolor{comment}{//Convert the byte array to hex string}
540       \hyperlink{http__server__misc_8c_a645bdf3cbf9b810deecbe5258790ae4d}{httpConvertArrayToHexString}(nonce, 
      \hyperlink{http__server_8h_abdefce676451bc1bf439d264f510abd7}{HTTP\_SERVER\_NONCE\_SIZE}, entry->\hyperlink{structHttpNonceCacheEntry_a49cca6a1603b77d4d91b2b7f91db726b}{nonce});
541       \textcolor{comment}{//Clear nonce count}
542       entry->\hyperlink{structHttpNonceCacheEntry_af4406b01e0c26184c5374d4287b6a07b}{count} = 1;
543       \textcolor{comment}{//Save the time at which the nonce was generated}
544       entry->\hyperlink{structHttpNonceCacheEntry_aeb380011ddae3854b054d0a06ce7af97}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
545 
546       \textcolor{comment}{//Copy the nonce to the output buffer}
547       strcpy(output, entry->\hyperlink{structHttpNonceCacheEntry_a49cca6a1603b77d4d91b2b7f91db726b}{nonce});
548       \textcolor{comment}{//Return the length of the nonce excluding the NULL character}
549       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \hyperlink{http__server_8h_abdefce676451bc1bf439d264f510abd7}{HTTP\_SERVER\_NONCE\_SIZE} * 2;
550    \}
551    \textcolor{keywordflow}{else}
552    \{
553       \textcolor{comment}{//Random number generation failed}
554       memset(entry, 0, \textcolor{keyword}{sizeof}(\hyperlink{structHttpNonceCacheEntry}{HttpNonceCacheEntry}));
555    \}
556 
557    \textcolor{comment}{//Release exclusive access to the nonce cache}
558    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&context->nonceCacheMutex);
559    \textcolor{comment}{//Return status code}
560    \textcolor{keywordflow}{return} error;
561 
562 \textcolor{preprocessor}{#else}
563    \textcolor{comment}{//Not implemented}
564    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
565 \textcolor{preprocessor}{#endif}
566 \}
\end{DoxyCode}
\mbox{\Hypertarget{http__server__auth_8h_a9bd78533b70da214a81f5db0ff6094c4}\label{http__server__auth_8h_a9bd78533b70da214a81f5db0ff6094c4}} 
\index{http\+\_\+server\+\_\+auth.\+h@{http\+\_\+server\+\_\+auth.\+h}!http\+Parse\+Authorization\+Field@{http\+Parse\+Authorization\+Field}}
\index{http\+Parse\+Authorization\+Field@{http\+Parse\+Authorization\+Field}!http\+\_\+server\+\_\+auth.\+h@{http\+\_\+server\+\_\+auth.\+h}}
\subsubsection{\texorpdfstring{http\+Parse\+Authorization\+Field()}{httpParseAuthorizationField()}}
{\footnotesize\ttfamily void http\+Parse\+Authorization\+Field (\begin{DoxyParamCaption}\item[{\hyperlink{http__server_8h_a3506ecffde998ab02629dca83587d2f9}{Http\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{value }\end{DoxyParamCaption})}



Parse Authorization header field. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Structure representing an H\+T\+TP connection \\
\hline
\mbox{\tt in}  & {\em value} & Authorization field value \\
\hline
\end{DoxyParams}


Definition at line 198 of file http\+\_\+server\+\_\+auth.\+c.


\begin{DoxyCode}
199 \{
200    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
201    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{coap__common_8h_aaa0137cdddb344591e20a2930a1ba54d}{token};
202 
203    \textcolor{comment}{//Retrieve the authentication scheme}
204    token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value}, \textcolor{stringliteral}{" \(\backslash\)t"}, &p);
205 
206    \textcolor{comment}{//Any parsing error?}
207    \textcolor{keywordflow}{if}(token == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
208    \{
209       \textcolor{comment}{//Exit immediately}
210       \textcolor{keywordflow}{return};
211    \}
212 \textcolor{preprocessor}{#if (HTTP\_SERVER\_BASIC\_AUTH\_SUPPORT == ENABLED)}
213    \textcolor{comment}{//Basic access authentication?}
214    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(token, \textcolor{stringliteral}{"Basic"}))
215    \{
216       \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
217       \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
218       \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *separator;
219 
220       \textcolor{comment}{//Use the relevant authentication scheme}
221       connection->request.auth.mode = \hyperlink{http__common_8h_ad435f9e57a3351beaec6fc809eff4f31ae59e35c78d081e09a92601aedbde57d5}{HTTP\_AUTH\_MODE\_BASIC};
222       \textcolor{comment}{//Retrieve the credentials}
223       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{" \(\backslash\)t"}, &p);
224 
225       \textcolor{comment}{//Any parsing error?}
226       \textcolor{keywordflow}{if}(token != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
227       \{
228          \textcolor{comment}{//Decrypt the Base64-encoded string}
229          error = \hyperlink{base64_8c_ae360cde3e2ef08783ac2e01591b78530}{base64Decode}(token, strlen(token), token, &n);
230 
231          \textcolor{comment}{//Successful decoding?}
232          \textcolor{keywordflow}{if}(!error)
233          \{
234             \textcolor{comment}{//Properly terminate the string}
235             token[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}] = \textcolor{charliteral}{'\(\backslash\)0'};
236             \textcolor{comment}{//Check whether a separator is present}
237             separator = strchr(token, \textcolor{charliteral}{':'});
238 
239             \textcolor{comment}{//Separator found?}
240             \textcolor{keywordflow}{if}(separator != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
241             \{
242                \textcolor{comment}{//Split the line}
243                *separator = \textcolor{charliteral}{'\(\backslash\)0'};
244 
245                \textcolor{comment}{//Save user name}
246                \hyperlink{str_8c_ac10cb0bca1fb0c39b2c765afd068486d}{strSafeCopy}(connection->request.auth.user,
247                   token, \hyperlink{http__server_8h_a8dad23eb13064267d7c9d5ffa2dca8fe}{HTTP\_SERVER\_USERNAME\_MAX\_LEN});
248 
249                \textcolor{comment}{//Point to the password}
250                token = separator + 1;
251                \textcolor{comment}{//Save password}
252                connection->request.auth.password = \hyperlink{coap__common_8h_aaa0137cdddb344591e20a2930a1ba54d}{token};
253             \}
254          \}
255       \}
256 
257       \textcolor{comment}{//Debug message}
258       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Authorization header:\(\backslash\)r\(\backslash\)n"});
259       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  username: %s\(\backslash\)r\(\backslash\)n"}, connection->request.auth.user);
260       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  password: %s\(\backslash\)r\(\backslash\)n"}, connection->request.auth.password);
261    \}
262 \textcolor{preprocessor}{#endif}
263 \textcolor{preprocessor}{#if (HTTP\_SERVER\_DIGEST\_AUTH\_SUPPORT == ENABLED)}
264    \textcolor{comment}{//Digest access authentication?}
265    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(token, \textcolor{stringliteral}{"Digest"}))
266    \{
267       \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
268       \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *separator;
269       \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name};
270 
271       \textcolor{comment}{//Use the relevant authentication scheme}
272       connection->request.auth.mode = \hyperlink{http__common_8h_ad435f9e57a3351beaec6fc809eff4f31a0ca9d6eab847100994632261a80833df}{HTTP\_AUTH\_MODE\_DIGEST};
273       \textcolor{comment}{//Get the first parameter}
274       token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{","}, &p);
275 
276       \textcolor{comment}{//Parse the Authorization header field}
277       \textcolor{keywordflow}{while}(token != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
278       \{
279          \textcolor{comment}{//Check whether a separator is present}
280          separator = strchr(token, \textcolor{charliteral}{'='});
281 
282          \textcolor{comment}{//Separator found?}
283          \textcolor{keywordflow}{if}(separator != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
284          \{
285             \textcolor{comment}{//Split the string}
286             *separator = \textcolor{charliteral}{'\(\backslash\)0'};
287 
288             \textcolor{comment}{//Get field name and value}
289             name = \hyperlink{str_8c_ade9441b268416af6b024eb2ba3a5847e}{strTrimWhitespace}(token);
290             \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value} = \hyperlink{str_8c_ade9441b268416af6b024eb2ba3a5847e}{strTrimWhitespace}(separator + 1);
291 
292             \textcolor{comment}{//Retrieve the length of the value field}
293             n = strlen(\hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value});
294 
295             \textcolor{comment}{//Discard the surrounding quotes}
296             \textcolor{keywordflow}{if}(n > 0 && \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value}[n - 1] == \textcolor{charliteral}{'\(\backslash\)"'})
297                \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value}[n - 1] = \textcolor{charliteral}{'\(\backslash\)0'};
298             \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value}[0] == \textcolor{charliteral}{'\(\backslash\)"'})
299                \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value}++;
300 
301             \textcolor{comment}{//Check parameter name}
302             \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"username"}))
303             \{
304                \textcolor{comment}{//Save user name}
305                \hyperlink{str_8c_ac10cb0bca1fb0c39b2c765afd068486d}{strSafeCopy}(connection->request.auth.user,
306                   \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value}, \hyperlink{http__server_8h_a8dad23eb13064267d7c9d5ffa2dca8fe}{HTTP\_SERVER\_USERNAME\_MAX\_LEN});
307             \}
308             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"realm"}))
309             \{
310                \textcolor{comment}{//Save realm}
311                connection->request.auth.realm = \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
312             \}
313             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"nonce"}))
314             \{
315                \textcolor{comment}{//Save nonce parameter}
316                connection->request.auth.nonce = \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
317             \}
318             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"uri"}))
319             \{
320                \textcolor{comment}{//Save uri parameter}
321                connection->request.auth.uri = \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
322             \}
323             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"qop"}))
324             \{
325                \textcolor{comment}{//Save qop parameter}
326                connection->request.auth.qop = \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
327             \}
328             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"nc"}))
329             \{
330                \textcolor{comment}{//Save nc parameter}
331                connection->request.auth.nc = \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
332             \}
333             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"cnonce"}))
334             \{
335                \textcolor{comment}{//Save cnonce parameter}
336                connection->request.auth.cnonce = \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
337             \}
338             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"response"}))
339             \{
340                \textcolor{comment}{//Save response parameter}
341                connection->request.auth.response = \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
342             \}
343             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(name, \textcolor{stringliteral}{"opaque"}))
344             \{
345                \textcolor{comment}{//Save opaque parameter}
346                connection->request.auth.opaque = \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
347             \}
348 
349             \textcolor{comment}{//Get next parameter}
350             token = \hyperlink{strtok__r_8c_af18c3fca5cc30bc1313728d45c031ae9}{strtok\_r}(\hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \textcolor{stringliteral}{","}, &p);
351          \}
352       \}
353 
354       \textcolor{comment}{//Debug message}
355       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Authorization header:\(\backslash\)r\(\backslash\)n"});
356       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  username: %s\(\backslash\)r\(\backslash\)n"}, connection->request.auth.user);
357       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  realm: %s\(\backslash\)r\(\backslash\)n"}, connection->request.auth.realm);
358       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  nonce: %s\(\backslash\)r\(\backslash\)n"}, connection->request.auth.nonce);
359       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  uri: %s\(\backslash\)r\(\backslash\)n"}, connection->request.auth.uri);
360       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  qop: %s\(\backslash\)r\(\backslash\)n"}, connection->request.auth.qop);
361       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  nc: %s\(\backslash\)r\(\backslash\)n"}, connection->request.auth.nc);
362       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  cnonce: %s\(\backslash\)r\(\backslash\)n"}, connection->request.auth.cnonce);
363       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  response: %s\(\backslash\)r\(\backslash\)n"}, connection->request.auth.response);
364       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  opaque: %s\(\backslash\)r\(\backslash\)n"}, connection->request.auth.opaque);
365    \}
366 \textcolor{preprocessor}{#endif}
367    \textcolor{keywordflow}{else}
368    \{
369       \textcolor{comment}{//The specified authentication scheme is not supported}
370       \textcolor{keywordflow}{return};
371    \}
372 
373 \textcolor{preprocessor}{#if (HTTP\_SERVER\_BASIC\_AUTH\_SUPPORT == ENABLED || HTTP\_SERVER\_DIGEST\_AUTH\_SUPPORT == ENABLED)}
374    \textcolor{comment}{//The Authorization header has been found}
375    connection->request.auth.found = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
376 
377    \textcolor{comment}{//Invoke user-defined callback, if any}
378    \textcolor{keywordflow}{if}(connection->settings->authCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
379    \{
380       \textcolor{comment}{//Check whether the access to the specified URI is authorized}
381       connection->status = connection->settings->authCallback(connection,
382          connection->request.auth.user, connection->request.uri);
383    \}
384    \textcolor{keywordflow}{else}
385    \{
386       \textcolor{comment}{//Access to the specified URI is allowed}
387       connection->status = \hyperlink{http__server_8h_a208042b9481360af1650fad94cd93769a22350b4ac7e0624f6052e5d841540476}{HTTP\_ACCESS\_ALLOWED};
388    \}
389 \textcolor{preprocessor}{#endif}
390 \}
\end{DoxyCode}
\mbox{\Hypertarget{http__server__auth_8h_ae3937b17c870ba6ff31c9242d3c7b526}\label{http__server__auth_8h_ae3937b17c870ba6ff31c9242d3c7b526}} 
\index{http\+\_\+server\+\_\+auth.\+h@{http\+\_\+server\+\_\+auth.\+h}!http\+Verify\+Nonce@{http\+Verify\+Nonce}}
\index{http\+Verify\+Nonce@{http\+Verify\+Nonce}!http\+\_\+server\+\_\+auth.\+h@{http\+\_\+server\+\_\+auth.\+h}}
\subsubsection{\texorpdfstring{http\+Verify\+Nonce()}{httpVerifyNonce()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} http\+Verify\+Nonce (\begin{DoxyParamCaption}\item[{\hyperlink{http__server_8h_a952abbfa31a2188c3d65357e79531e03}{Http\+Server\+Context} $\ast$}]{context,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{nonce,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{nc }\end{DoxyParamCaption})}



Nonce verification. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the H\+T\+TP server context \\
\hline
\mbox{\tt in}  & {\em nonce} & N\+U\+L\+L-\/terminated string containing the nonce \\
\hline
\mbox{\tt in}  & {\em nc} & N\+U\+L\+L-\/terminated string containing the nonce count \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 577 of file http\+\_\+server\+\_\+auth.\+c.


\begin{DoxyCode}
579 \{
580 \textcolor{preprocessor}{#if (HTTP\_SERVER\_DIGEST\_AUTH\_SUPPORT == ENABLED)}
581    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
582    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
583    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} count;
584    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
585    \hyperlink{structHttpNonceCacheEntry}{HttpNonceCacheEntry} *entry;
586 
587    \textcolor{comment}{//Check parameters}
588    \textcolor{keywordflow}{if}(nonce == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || nc == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
589       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
590 
591    \textcolor{comment}{//Convert the nonce count to integer}
592    count = strtoul(nc, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 16);
593    \textcolor{comment}{//Get current time}
594    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
595 
596    \textcolor{comment}{//Acquire exclusive access to the nonce cache}
597    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&context->nonceCacheMutex);
598 
599    \textcolor{comment}{//Loop through nonce cache entries}
600    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{http__server_8h_ad440bedce9872300d063b72fa5e2cd7a}{HTTP\_SERVER\_NONCE\_CACHE\_SIZE}; i++)
601    \{
602       \textcolor{comment}{//Point to the current entry}
603       entry = &context->nonceCache[i];
604 
605       \textcolor{comment}{//Check nonce value}
606       \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(entry->\hyperlink{structHttpNonceCacheEntry_a49cca6a1603b77d4d91b2b7f91db726b}{nonce}, nonce))
607       \{
608          \textcolor{comment}{//Make sure the nonce timestamp has not expired}
609          \textcolor{keywordflow}{if}((time - entry->\hyperlink{structHttpNonceCacheEntry_aeb380011ddae3854b054d0a06ce7af97}{timestamp}) < \hyperlink{http__server_8h_a397eca7c40d72061f21289a4e668178b}{HTTP\_SERVER\_NONCE\_LIFETIME})
610          \{
611             \textcolor{comment}{//Check nonce count to prevent replay attacks}
612             \textcolor{keywordflow}{if}(count >= entry->\hyperlink{structHttpNonceCacheEntry_af4406b01e0c26184c5374d4287b6a07b}{count})
613             \{
614                \textcolor{comment}{//Update nonce count to the next expected value}
615                entry->\hyperlink{structHttpNonceCacheEntry_af4406b01e0c26184c5374d4287b6a07b}{count} = count + 1;
616                \textcolor{comment}{//We are done}
617                \textcolor{keywordflow}{break};
618             \}
619          \}
620       \}
621    \}
622 
623    \textcolor{comment}{//Check whether the nonce is valid}
624    \textcolor{keywordflow}{if}(i < HTTP\_SERVER\_NONCE\_CACHE\_SIZE)
625       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
626    \textcolor{keywordflow}{else}
627       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4cca37264afee88cb14cd105f0d59607}{ERROR\_NOT\_FOUND};
628 
629    \textcolor{comment}{//Release exclusive access to the nonce cache}
630    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&context->nonceCacheMutex);
631    \textcolor{comment}{//Return status code}
632    \textcolor{keywordflow}{return} error;
633 
634 \textcolor{preprocessor}{#else}
635    \textcolor{comment}{//Not implemented}
636    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
637 \textcolor{preprocessor}{#endif}
638 \}
\end{DoxyCode}
