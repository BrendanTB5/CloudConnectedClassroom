\hypertarget{mqtt__client__transport_8c}{}\section{cyclone\+\_\+tcp/mqtt/mqtt\+\_\+client\+\_\+transport.c File Reference}
\label{mqtt__client__transport_8c}\index{cyclone\+\_\+tcp/mqtt/mqtt\+\_\+client\+\_\+transport.\+c@{cyclone\+\_\+tcp/mqtt/mqtt\+\_\+client\+\_\+transport.\+c}}


Transport protocol abstraction layer.  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}core/tcp\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mqtt/mqtt\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mqtt/mqtt\+\_\+client\+\_\+packet.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mqtt/mqtt\+\_\+client\+\_\+transport.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mqtt/mqtt\+\_\+client\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{mqtt__client__transport_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_aa3a1432707eaba04c3ba082436b7a767}{M\+Q\+T\+T\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{mqtt__client__transport_8c_a0c7e51133702a8feb82323b5862b12c6}{mqtt\+Client\+Open\+Connection} (\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Open network connection. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{mqtt__client__transport_8c_afa751f287d01633d12ce99f85ec59e73}{mqtt\+Client\+Establish\+Connection} (\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$context, const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$server\+Ip\+Addr, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} server\+Port)
\begin{DoxyCompactList}\small\item\em Establish network connection. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{mqtt__client__transport_8c_a6c5a11cb38130764a213c75d35a41b24}{mqtt\+Client\+Shutdown\+Connection} (\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Shutdown network connection. \end{DoxyCompactList}\item 
void \hyperlink{mqtt__client__transport_8c_a0e9b937110cbf8ca987ff0354ddeae42}{mqtt\+Client\+Close\+Connection} (\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Close network connection. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{mqtt__client__transport_8c_a9a6d5926aa48cea90da4b9451e863a37}{mqtt\+Client\+Send\+Data} (\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$context, const void $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, size\+\_\+t $\ast$written, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} \hyperlink{nbns__common_8h_a1e87af3c18a2fd36c61faf89949bdc3f}{flags})
\begin{DoxyCompactList}\small\item\em Send data using the relevant transport protocol. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{mqtt__client__transport_8c_a37a762b6d95ddaa2c0ad439489b93832}{mqtt\+Client\+Receive\+Data} (\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$context, void $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t size, size\+\_\+t $\ast$received, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} \hyperlink{nbns__common_8h_a1e87af3c18a2fd36c61faf89949bdc3f}{flags})
\begin{DoxyCompactList}\small\item\em Receive data using the relevant transport protocol. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{mqtt__client__transport_8c_aac52321d3f941565861a56f33c95f226}{mqtt\+Client\+Wait\+For\+Data} (\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$context, \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t} timeout)
\begin{DoxyCompactList}\small\item\em Wait for incoming data. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Transport protocol abstraction layer. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{mqtt__client__transport_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{mqtt__client__transport_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_aa3a1432707eaba04c3ba082436b7a767}{M\+Q\+T\+T\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file mqtt\+\_\+client\+\_\+transport.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{mqtt__client__transport_8c_a0e9b937110cbf8ca987ff0354ddeae42}\label{mqtt__client__transport_8c_a0e9b937110cbf8ca987ff0354ddeae42}} 
\index{mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}!mqtt\+Client\+Close\+Connection@{mqtt\+Client\+Close\+Connection}}
\index{mqtt\+Client\+Close\+Connection@{mqtt\+Client\+Close\+Connection}!mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{mqtt\+Client\+Close\+Connection()}{mqttClientCloseConnection()}}
{\footnotesize\ttfamily void mqtt\+Client\+Close\+Connection (\begin{DoxyParamCaption}\item[{\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Close network connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the M\+Q\+TT client context \\
\hline
\end{DoxyParams}


Definition at line 383 of file mqtt\+\_\+client\+\_\+transport.\+c.


\begin{DoxyCode}
384 \{
385    \textcolor{comment}{//TCP transport protocol?}
386    \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa9e793dc8d512e7534fb490e2f98643f4}{MQTT\_TRANSPORT\_PROTOCOL\_TCP})
387    \{
388       \textcolor{comment}{//Close TCP connection}
389       \textcolor{keywordflow}{if}(context->socket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
390       \{
391          \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(context->socket);
392          context->socket = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
393       \}
394    \}
395 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_TLS\_SUPPORT == ENABLED)}
396    \textcolor{comment}{//TLS transport protocol?}
397    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa6775842da4840be5ecb6dc2973668551}{MQTT\_TRANSPORT\_PROTOCOL\_TLS})
398    \{
399       \textcolor{comment}{//Release TLS context}
400       \textcolor{keywordflow}{if}(context->tlsContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
401       \{
402          \hyperlink{tls_8c_aec8c1957ad13f5ad67d07a872d5fe66b}{tlsFree}(context->tlsContext);
403          context->tlsContext = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
404       \}
405 
406       \textcolor{comment}{//Close TCP connection}
407       \textcolor{keywordflow}{if}(context->socket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
408       \{
409          \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(context->socket);
410          context->socket = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
411       \}
412    \}
413 \textcolor{preprocessor}{#endif}
414 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_WS\_SUPPORT == ENABLED)}
415    \textcolor{comment}{//WebSocket transport protocol?}
416    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa91cb729b8b8ee8b77deb57281f3873e8}{MQTT\_TRANSPORT\_PROTOCOL\_WS} ||
417       context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa03f2a698094d6d11c34e2a5c18f5542c}{MQTT\_TRANSPORT\_PROTOCOL\_WSS})
418    \{
419       \textcolor{comment}{//Close WebSocket connection}
420       \textcolor{keywordflow}{if}(context->webSocket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
421       \{
422          \hyperlink{web__socket_8c_a9b9a31944d5466c54f9720d34403c4d6}{webSocketClose}(context->webSocket);
423          context->webSocket = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
424       \}
425    \}
426 \textcolor{preprocessor}{#endif}
427 \}
\end{DoxyCode}
\mbox{\Hypertarget{mqtt__client__transport_8c_afa751f287d01633d12ce99f85ec59e73}\label{mqtt__client__transport_8c_afa751f287d01633d12ce99f85ec59e73}} 
\index{mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}!mqtt\+Client\+Establish\+Connection@{mqtt\+Client\+Establish\+Connection}}
\index{mqtt\+Client\+Establish\+Connection@{mqtt\+Client\+Establish\+Connection}!mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{mqtt\+Client\+Establish\+Connection()}{mqttClientEstablishConnection()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} mqtt\+Client\+Establish\+Connection (\begin{DoxyParamCaption}\item[{\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$}]{context,  }\item[{const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$}]{server\+Ip\+Addr,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{server\+Port }\end{DoxyParamCaption})}



Establish network connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the M\+Q\+TT client context \\
\hline
\mbox{\tt in}  & {\em server\+Ip\+Addr} & IP address of the M\+Q\+TT server to connect to \\
\hline
\mbox{\tt in}  & {\em server\+Port} & T\+CP port number that will be used to establish the connection \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 214 of file mqtt\+\_\+client\+\_\+transport.\+c.


\begin{DoxyCode}
216 \{
217    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
218 
219    \textcolor{comment}{//TCP transport protocol?}
220    \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa9e793dc8d512e7534fb490e2f98643f4}{MQTT\_TRANSPORT\_PROTOCOL\_TCP})
221    \{
222       \textcolor{comment}{//Set timeout}
223       error = \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->socket, context->settings.timeout);
224 
225       \textcolor{comment}{//Check status code}
226       \textcolor{keywordflow}{if}(!error)
227       \{
228          \textcolor{comment}{//Connect to the MQTT server using TCP}
229          error = \hyperlink{socket_8c_aff3e3c0abc332f42189fce8f362fbd63}{socketConnect}(context->socket, serverIpAddr, serverPort);
230       \}
231    \}
232 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_TLS\_SUPPORT == ENABLED)}
233    \textcolor{comment}{//TLS transport protocol?}
234    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa6775842da4840be5ecb6dc2973668551}{MQTT\_TRANSPORT\_PROTOCOL\_TLS})
235    \{
236       \textcolor{comment}{//Set timeout}
237       error = \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->socket, context->settings.timeout);
238 
239       \textcolor{comment}{//Check status code}
240       \textcolor{keywordflow}{if}(!error)
241       \{
242          \textcolor{comment}{//Connect to the MQTT server using TCP}
243          error = \hyperlink{socket_8c_aff3e3c0abc332f42189fce8f362fbd63}{socketConnect}(context->socket, serverIpAddr, serverPort);
244       \}
245 
246       \textcolor{comment}{//Check status code}
247       \textcolor{keywordflow}{if}(!error)
248       \{
249          \textcolor{comment}{//Perform TLS handshake}
250          error = \hyperlink{tls_8c_a09ea66af9332cc10296020164428224e}{tlsConnect}(context->tlsContext);
251       \}
252 
253       \textcolor{comment}{//Successful connection?}
254       \textcolor{keywordflow}{if}(!error)
255       \{
256          \textcolor{comment}{//Save TLS session}
257          error = \hyperlink{tls_8c_a1685cfa2e5cd4b4d9a212201de0336f4}{tlsSaveSessionState}(context->tlsContext, &context->tlsSession);
258       \}
259    \}
260 \textcolor{preprocessor}{#endif}
261 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_WS\_SUPPORT == ENABLED)}
262    \textcolor{comment}{//WebSocket transport protocol?}
263    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa91cb729b8b8ee8b77deb57281f3873e8}{MQTT\_TRANSPORT\_PROTOCOL\_WS} ||
264       context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa03f2a698094d6d11c34e2a5c18f5542c}{MQTT\_TRANSPORT\_PROTOCOL\_WSS})
265    \{
266       \textcolor{comment}{//Set timeout}
267       error = \hyperlink{web__socket_8c_a62484c97e683330b9dc4953fce89f77b}{webSocketSetTimeout}(context->webSocket, context->settings.timeout);
268 
269       \textcolor{comment}{//Check status code}
270       \textcolor{keywordflow}{if}(!error)
271       \{
272          \textcolor{comment}{//Set the hostname of the remote server}
273          error = \hyperlink{web__socket_8c_ac6ca86f78b9553dfbb0b317db10bdcae}{webSocketSetHost}(context->webSocket, context->settings.host);
274       \}
275 
276       \textcolor{comment}{//Check status code}
277       \textcolor{keywordflow}{if}(!error)
278       \{
279          \textcolor{comment}{//The client MUST include "mqtt" in the list of WebSocket}
280          \textcolor{comment}{//sub-protocols it offers}
281          error = \hyperlink{web__socket_8c_a77b4a38124a405d8a8946d7fde8f0068}{webSocketSetSubProtocol}(context->webSocket, \textcolor{stringliteral}{"mqtt"});
282       \}
283 
284       \textcolor{comment}{//Check status code}
285       \textcolor{keywordflow}{if}(!error)
286       \{
287          \textcolor{comment}{//Connect to the MQTT server using WebSocket}
288          error = \hyperlink{web__socket_8c_a2e1c929468b9ca8919e78d7f625aa577}{webSocketConnect}(context->webSocket, serverIpAddr,
289             serverPort, context->settings.uri);
290       \}
291    \}
292 \textcolor{preprocessor}{#endif}
293    \textcolor{comment}{//Unknown transport protocol?}
294    \textcolor{keywordflow}{else}
295    \{
296       \textcolor{comment}{//Report an error}
297       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5a1904e109856f036391fa141fc8b5b3}{ERROR\_INVALID\_PROTOCOL};
298    \}
299 
300    \textcolor{comment}{//Return status code}
301    \textcolor{keywordflow}{return} error;
302 \}
\end{DoxyCode}
\mbox{\Hypertarget{mqtt__client__transport_8c_a0c7e51133702a8feb82323b5862b12c6}\label{mqtt__client__transport_8c_a0c7e51133702a8feb82323b5862b12c6}} 
\index{mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}!mqtt\+Client\+Open\+Connection@{mqtt\+Client\+Open\+Connection}}
\index{mqtt\+Client\+Open\+Connection@{mqtt\+Client\+Open\+Connection}!mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{mqtt\+Client\+Open\+Connection()}{mqttClientOpenConnection()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} mqtt\+Client\+Open\+Connection (\begin{DoxyParamCaption}\item[{\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Open network connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the M\+Q\+TT client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 53 of file mqtt\+\_\+client\+\_\+transport.\+c.


\begin{DoxyCode}
54 \{
55    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
56 
57    \textcolor{comment}{//TCP transport protocol?}
58    \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa9e793dc8d512e7534fb490e2f98643f4}{MQTT\_TRANSPORT\_PROTOCOL\_TCP})
59    \{
60       \textcolor{comment}{//Open a TCP socket}
61       context->socket = \hyperlink{socket_8c_aa139bbf42b326b52eb08cf52771ac337}{socketOpen}(\hyperlink{socket_8h_aa78c7398fa81f7f62aa233159d4d8d97a9dab003c4dc9f7279e806241534d4859}{SOCKET\_TYPE\_STREAM}, 
      \hyperlink{socket_8h_a56eb0e60bda5d1d8a2e702228405d969ae0f38a6f025bce7700b3cf0ddd04bb2a}{SOCKET\_IP\_PROTO\_TCP});
62 
63       \textcolor{comment}{//Valid socket handle?}
64       \textcolor{keywordflow}{if}(context->socket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
65       \{
66          \textcolor{comment}{//Associate the socket with the relevant interface}
67          error = \hyperlink{net__legacy_8h_a80bc49fa99e5654d8c345cd5c70d36d3}{socketBindToInterface}(context->socket, context->interface);
68       \}
69       \textcolor{keywordflow}{else}
70       \{
71          \textcolor{comment}{//Report an error}
72          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab721230e985e398cc0977dd729a12c61}{ERROR\_OPEN\_FAILED};
73       \}
74    \}
75 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_TLS\_SUPPORT == ENABLED)}
76    \textcolor{comment}{//TLS transport protocol?}
77    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa6775842da4840be5ecb6dc2973668551}{MQTT\_TRANSPORT\_PROTOCOL\_TLS})
78    \{
79       \textcolor{comment}{//Open a TCP socket}
80       context->socket = \hyperlink{socket_8c_aa139bbf42b326b52eb08cf52771ac337}{socketOpen}(\hyperlink{socket_8h_aa78c7398fa81f7f62aa233159d4d8d97a9dab003c4dc9f7279e806241534d4859}{SOCKET\_TYPE\_STREAM}, 
      \hyperlink{socket_8h_a56eb0e60bda5d1d8a2e702228405d969ae0f38a6f025bce7700b3cf0ddd04bb2a}{SOCKET\_IP\_PROTO\_TCP});
81 
82       \textcolor{comment}{//Valid socket handle?}
83       \textcolor{keywordflow}{if}(context->socket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
84       \{
85          \textcolor{comment}{//Associate the socket with the relevant interface}
86          error = \hyperlink{net__legacy_8h_a80bc49fa99e5654d8c345cd5c70d36d3}{socketBindToInterface}(context->socket, context->interface);
87 
88          \textcolor{comment}{//Check status code}
89          \textcolor{keywordflow}{if}(!error)
90          \{
91             \textcolor{comment}{//Allocate TLS context}
92             context->tlsContext = \hyperlink{tls_8c_a5d34d9c0613c57d32b35692a86d5b04f}{tlsInit}();
93 
94             \textcolor{comment}{//Valid TLS handle?}
95             \textcolor{keywordflow}{if}(context->tlsContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
96             \{
97                \textcolor{comment}{//Select client operation mode}
98                error = \hyperlink{tls_8c_a8713543db673ee5a36b2fda92e082c6b}{tlsSetConnectionEnd}(context->tlsContext,
99                   \hyperlink{tls_8h_acb21bc158664d823d899d760edd8135ba7f216418b2d898ed01cf9376fd9b3d6d}{TLS\_CONNECTION\_END\_CLIENT});
100 
101                \textcolor{comment}{//Check status code}
102                \textcolor{keywordflow}{if}(!error)
103                \{
104                   \textcolor{comment}{//Bind TLS to the relevant socket}
105                   error = \hyperlink{tls_8h_af918bec8cc034c91ae7cb14a4ab24103}{tlsSetSocket}(context->tlsContext, context->socket);
106                \}
107 
108                \textcolor{comment}{//Check status code}
109                \textcolor{keywordflow}{if}(!error)
110                \{
111                   \textcolor{comment}{//Restore TLS session, if any}
112                   error = \hyperlink{tls_8c_a04094e358f18adc2d7ad8686e3258b93}{tlsRestoreSessionState}(context->tlsContext,
113                      &context->tlsSession);
114                \}
115 
116                \textcolor{comment}{//Check status code}
117                \textcolor{keywordflow}{if}(!error)
118                \{
119                   \textcolor{comment}{//Invoke user-defined callback, if any}
120                   \textcolor{keywordflow}{if}(context->callbacks.tlsInitCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
121                   \{
122                      \textcolor{comment}{//Perform TLS related initialization}
123                      error = context->callbacks.tlsInitCallback(context,
124                         context->tlsContext);
125                   \}
126                \}
127             \}
128             \textcolor{keywordflow}{else}
129             \{
130                \textcolor{comment}{//Report an error}
131                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab721230e985e398cc0977dd729a12c61}{ERROR\_OPEN\_FAILED};
132             \}
133          \}
134       \}
135       \textcolor{keywordflow}{else}
136       \{
137          \textcolor{comment}{//Report an error}
138          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab721230e985e398cc0977dd729a12c61}{ERROR\_OPEN\_FAILED};
139       \}
140    \}
141 \textcolor{preprocessor}{#endif}
142 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_WS\_SUPPORT == ENABLED)}
143    \textcolor{comment}{//WebSocket transport protocol?}
144    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa91cb729b8b8ee8b77deb57281f3873e8}{MQTT\_TRANSPORT\_PROTOCOL\_WS})
145    \{
146       \textcolor{comment}{//Open a WebSocket}
147       context->webSocket = \hyperlink{web__socket_8c_a6134901b088acbcb083e2326600bcd6d}{webSocketOpen}();
148 
149       \textcolor{comment}{//Valid WebSocket handle?}
150       \textcolor{keywordflow}{if}(context->webSocket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
151       \{
152          \textcolor{comment}{//Associate the WebSocket with the relevant interface}
153          error = \hyperlink{web__socket_8c_af463d265c223171a38cef0374ba1eeac}{webSocketBindToInterface}(context->webSocket,
154             context->interface);
155       \}
156       \textcolor{keywordflow}{else}
157       \{
158          \textcolor{comment}{//Report an error}
159          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab721230e985e398cc0977dd729a12c61}{ERROR\_OPEN\_FAILED};
160       \}
161    \}
162 \textcolor{preprocessor}{#endif}
163 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_WS\_SUPPORT == ENABLED && MQTT\_CLIENT\_TLS\_SUPPORT == ENABLED && \(\backslash\)}
164 \textcolor{preprocessor}{   WEB\_SOCKET\_TLS\_SUPPORT == ENABLED)}
165    \textcolor{comment}{//Secure WebSocket transport protocol?}
166    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa03f2a698094d6d11c34e2a5c18f5542c}{MQTT\_TRANSPORT\_PROTOCOL\_WSS})
167    \{
168       \textcolor{comment}{//Open a WebSocket}
169       context->webSocket = \hyperlink{web__socket_8c_a6134901b088acbcb083e2326600bcd6d}{webSocketOpen}();
170 
171       \textcolor{comment}{//Valid WebSocket handle?}
172       \textcolor{keywordflow}{if}(context->webSocket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
173       \{
174          \textcolor{comment}{//Associate the WebSocket with the relevant interface}
175          error = \hyperlink{web__socket_8c_af463d265c223171a38cef0374ba1eeac}{webSocketBindToInterface}(context->webSocket,
176             context->interface);
177 
178          \textcolor{comment}{//Check status code}
179          \textcolor{keywordflow}{if}(!error)
180          \{
181             \textcolor{comment}{//Register TLS initialization callback}
182             error = \hyperlink{web__socket_8c_a1ba9c852f06d5d531676afbacc32ca0f}{webSocketRegisterTlsInitCallback}(context->webSocket,
183                (\hyperlink{web__socket_8h_ac1d28db340b5ef55a4a7e5e276018cf4}{WebSocketTlsInitCallback}) context->callbacks.tlsInitCallback);
184          \}
185       \}
186       \textcolor{keywordflow}{else}
187       \{
188          \textcolor{comment}{//Report an error}
189          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab721230e985e398cc0977dd729a12c61}{ERROR\_OPEN\_FAILED};
190       \}
191    \}
192 \textcolor{preprocessor}{#endif}
193    \textcolor{comment}{//Unknown transport protocol?}
194    \textcolor{keywordflow}{else}
195    \{
196       \textcolor{comment}{//Report an error}
197       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5a1904e109856f036391fa141fc8b5b3}{ERROR\_INVALID\_PROTOCOL};
198    \}
199 
200    \textcolor{comment}{//Return status code}
201    \textcolor{keywordflow}{return} error;
202 \}
\end{DoxyCode}
\mbox{\Hypertarget{mqtt__client__transport_8c_a37a762b6d95ddaa2c0ad439489b93832}\label{mqtt__client__transport_8c_a37a762b6d95ddaa2c0ad439489b93832}} 
\index{mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}!mqtt\+Client\+Receive\+Data@{mqtt\+Client\+Receive\+Data}}
\index{mqtt\+Client\+Receive\+Data@{mqtt\+Client\+Receive\+Data}!mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{mqtt\+Client\+Receive\+Data()}{mqttClientReceiveData()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} mqtt\+Client\+Receive\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$}]{context,  }\item[{void $\ast$}]{data,  }\item[{size\+\_\+t}]{size,  }\item[{size\+\_\+t $\ast$}]{received,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{flags }\end{DoxyParamCaption})}



Receive data using the relevant transport protocol. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the M\+Q\+TT client context \\
\hline
\mbox{\tt out}  & {\em data} & Buffer into which received data will be placed \\
\hline
\mbox{\tt in}  & {\em size} & Maximum number of bytes that can be received \\
\hline
\mbox{\tt out}  & {\em received} & Number of bytes that have been received \\
\hline
\mbox{\tt in}  & {\em flags} & Set of flags that influences the behavior of this function \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 512 of file mqtt\+\_\+client\+\_\+transport.\+c.


\begin{DoxyCode}
514 \{
515    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
516 
517    \textcolor{comment}{//No data has been read yet}
518    *received = 0;
519 
520    \textcolor{comment}{//TCP transport protocol?}
521    \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa9e793dc8d512e7534fb490e2f98643f4}{MQTT\_TRANSPORT\_PROTOCOL\_TCP})
522    \{
523       \textcolor{comment}{//Set timeout}
524       error = \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->socket, context->settings.timeout);
525 
526       \textcolor{comment}{//Check status code}
527       \textcolor{keywordflow}{if}(!error)
528       \{
529          \textcolor{comment}{//Receive data}
530          error = \hyperlink{socket_8c_a894c7bf0bfd4e3886fc584ed7ebbb087}{socketReceive}(context->socket, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size, received, 
      \hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags});
531       \}
532    \}
533 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_TLS\_SUPPORT == ENABLED)}
534    \textcolor{comment}{//TLS transport protocol?}
535    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa6775842da4840be5ecb6dc2973668551}{MQTT\_TRANSPORT\_PROTOCOL\_TLS})
536    \{
537       \textcolor{comment}{//Set timeout}
538       error = \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->socket, context->settings.timeout);
539 
540       \textcolor{comment}{//Check status code}
541       \textcolor{keywordflow}{if}(!error)
542       \{
543          \textcolor{comment}{//Receive data}
544          error = \hyperlink{tls_8c_a6aa09693d0cdc6e93d9b88a6331bc247}{tlsRead}(context->tlsContext, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size, received, 
      \hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags});
545       \}
546    \}
547 \textcolor{preprocessor}{#endif}
548 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_WS\_SUPPORT == ENABLED)}
549    \textcolor{comment}{//WebSocket transport protocol?}
550    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa91cb729b8b8ee8b77deb57281f3873e8}{MQTT\_TRANSPORT\_PROTOCOL\_WS} ||
551       context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa03f2a698094d6d11c34e2a5c18f5542c}{MQTT\_TRANSPORT\_PROTOCOL\_WSS})
552    \{
553       \hyperlink{web__socket_8h_a5cb4405f3460a36460b6ba588b60ea28}{WebSocketFrameType} \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type};
554 
555       \textcolor{comment}{//Set timeout}
556       error = \hyperlink{web__socket_8c_a62484c97e683330b9dc4953fce89f77b}{webSocketSetTimeout}(context->webSocket, context->settings.timeout);
557 
558       \textcolor{comment}{//Check status code}
559       \textcolor{keywordflow}{if}(!error)
560       \{
561          \textcolor{comment}{//Receive data}
562          error = \hyperlink{web__socket_8c_aad0e0be082563aff76a155bf4aae585f}{webSocketReceive}(context->webSocket, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size, &type, received);
563       \}
564 
565       \textcolor{comment}{//Check status code}
566       \textcolor{keywordflow}{if}(!error)
567       \{
568          \textcolor{comment}{//MQTT control packets must be sent in WebSocket binary data frames. If}
569          \textcolor{comment}{//any other type of data frame is received the recipient must close the}
570          \textcolor{comment}{//network connection}
571          \textcolor{keywordflow}{if}(type != \hyperlink{web__socket_8h_a5cb4405f3460a36460b6ba588b60ea28a2fdca4eba8711bd0925febf891d06e58}{WS\_FRAME\_TYPE\_BINARY} && type != 
      \hyperlink{web__socket_8h_a5cb4405f3460a36460b6ba588b60ea28a95a6c87691c4c8b1c52f17806dc612eb}{WS\_FRAME\_TYPE\_CONTINUATION})
572             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca2daa3c161edaa4477d1ae954c2136008}{ERROR\_INVALID\_TYPE};
573       \}
574    \}
575 \textcolor{preprocessor}{#endif}
576    \textcolor{comment}{//Unknown transport protocol?}
577    \textcolor{keywordflow}{else}
578    \{
579       \textcolor{comment}{//Report an error}
580       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5a1904e109856f036391fa141fc8b5b3}{ERROR\_INVALID\_PROTOCOL};
581    \}
582 
583    \textcolor{comment}{//Return status code}
584    \textcolor{keywordflow}{return} error;
585 \}
\end{DoxyCode}
\mbox{\Hypertarget{mqtt__client__transport_8c_a9a6d5926aa48cea90da4b9451e863a37}\label{mqtt__client__transport_8c_a9a6d5926aa48cea90da4b9451e863a37}} 
\index{mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}!mqtt\+Client\+Send\+Data@{mqtt\+Client\+Send\+Data}}
\index{mqtt\+Client\+Send\+Data@{mqtt\+Client\+Send\+Data}!mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{mqtt\+Client\+Send\+Data()}{mqttClientSendData()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} mqtt\+Client\+Send\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$}]{context,  }\item[{const void $\ast$}]{data,  }\item[{size\+\_\+t}]{length,  }\item[{size\+\_\+t $\ast$}]{written,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{flags }\end{DoxyParamCaption})}



Send data using the relevant transport protocol. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the M\+Q\+TT client context \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to a buffer containing the data to be transmitted \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes to be transmitted \\
\hline
\mbox{\tt out}  & {\em written} & Actual number of bytes written (optional parameter) \\
\hline
\mbox{\tt in}  & {\em flags} & Set of flags that influences the behavior of this function \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 440 of file mqtt\+\_\+client\+\_\+transport.\+c.


\begin{DoxyCode}
442 \{
443    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
444 
445    \textcolor{comment}{//TCP transport protocol?}
446    \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa9e793dc8d512e7534fb490e2f98643f4}{MQTT\_TRANSPORT\_PROTOCOL\_TCP})
447    \{
448       \textcolor{comment}{//Set timeout}
449       error = \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->socket, context->settings.timeout);
450 
451       \textcolor{comment}{//Check status code}
452       \textcolor{keywordflow}{if}(!error)
453       \{
454          \textcolor{comment}{//Transmit data}
455          error = \hyperlink{socket_8c_aa4eeb3a3294d14d681675ba9f0d3e568}{socketSend}(context->socket, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, written, 
      \hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags});
456       \}
457    \}
458 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_TLS\_SUPPORT == ENABLED)}
459    \textcolor{comment}{//TLS transport protocol?}
460    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa6775842da4840be5ecb6dc2973668551}{MQTT\_TRANSPORT\_PROTOCOL\_TLS})
461    \{
462       \textcolor{comment}{//Set timeout}
463       error = \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->socket, context->settings.timeout);
464 
465       \textcolor{comment}{//Check status code}
466       \textcolor{keywordflow}{if}(!error)
467       \{
468          \textcolor{comment}{//Transmit data}
469          error = \hyperlink{tls_8c_a1b4b22502217a601f7f094403e700b4b}{tlsWrite}(context->tlsContext, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, written, 
      \hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags});
470       \}
471    \}
472 \textcolor{preprocessor}{#endif}
473 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_WS\_SUPPORT == ENABLED)}
474    \textcolor{comment}{//WebSocket transport protocol?}
475    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa91cb729b8b8ee8b77deb57281f3873e8}{MQTT\_TRANSPORT\_PROTOCOL\_WS} ||
476       context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa03f2a698094d6d11c34e2a5c18f5542c}{MQTT\_TRANSPORT\_PROTOCOL\_WSS})
477    \{
478       \textcolor{comment}{//Set timeout}
479       error = \hyperlink{web__socket_8c_a62484c97e683330b9dc4953fce89f77b}{webSocketSetTimeout}(context->webSocket, context->settings.timeout);
480 
481       \textcolor{comment}{//Check status code}
482       \textcolor{keywordflow}{if}(!error)
483       \{
484          \textcolor{comment}{//MQTT control packets must be sent in WebSocket binary data frames}
485          error = \hyperlink{web__socket_8c_a3a04f02a4825742e1ace559e4c1a1e22}{webSocketSend}(context->webSocket, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length},
486             \hyperlink{web__socket_8h_a5cb4405f3460a36460b6ba588b60ea28a2fdca4eba8711bd0925febf891d06e58}{WS\_FRAME\_TYPE\_BINARY}, written);
487       \}
488    \}
489 \textcolor{preprocessor}{#endif}
490    \textcolor{comment}{//Unknown transport protocol?}
491    \textcolor{keywordflow}{else}
492    \{
493       \textcolor{comment}{//Report an error}
494       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5a1904e109856f036391fa141fc8b5b3}{ERROR\_INVALID\_PROTOCOL};
495    \}
496 
497    \textcolor{comment}{//Return status code}
498    \textcolor{keywordflow}{return} error;
499 \}
\end{DoxyCode}
\mbox{\Hypertarget{mqtt__client__transport_8c_a6c5a11cb38130764a213c75d35a41b24}\label{mqtt__client__transport_8c_a6c5a11cb38130764a213c75d35a41b24}} 
\index{mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}!mqtt\+Client\+Shutdown\+Connection@{mqtt\+Client\+Shutdown\+Connection}}
\index{mqtt\+Client\+Shutdown\+Connection@{mqtt\+Client\+Shutdown\+Connection}!mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{mqtt\+Client\+Shutdown\+Connection()}{mqttClientShutdownConnection()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} mqtt\+Client\+Shutdown\+Connection (\begin{DoxyParamCaption}\item[{\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Shutdown network connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the M\+Q\+TT client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 311 of file mqtt\+\_\+client\+\_\+transport.\+c.


\begin{DoxyCode}
312 \{
313    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
314 
315    \textcolor{comment}{//TCP transport protocol?}
316    \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa9e793dc8d512e7534fb490e2f98643f4}{MQTT\_TRANSPORT\_PROTOCOL\_TCP})
317    \{
318       \textcolor{comment}{//Set timeout}
319       error = \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->socket, context->settings.timeout);
320 
321       \textcolor{comment}{//Check status code}
322       \textcolor{keywordflow}{if}(!error)
323       \{
324          \textcolor{comment}{//Shutdown TCP connection}
325          error = \hyperlink{socket_8c_acc736b53dba4a0d3b11b63f75cdcfffb}{socketShutdown}(context->socket, \hyperlink{socket_8h_a36ee33c18de64f549a6336d1aa7333b7a4c533f4b86ea89dfd6a508bb4262c76d}{SOCKET\_SD\_BOTH});
326       \}
327    \}
328 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_TLS\_SUPPORT == ENABLED)}
329    \textcolor{comment}{//TLS transport protocol?}
330    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa6775842da4840be5ecb6dc2973668551}{MQTT\_TRANSPORT\_PROTOCOL\_TLS})
331    \{
332       \textcolor{comment}{//Set timeout}
333       error = \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->socket, context->settings.timeout);
334 
335       \textcolor{comment}{//Check status code}
336       \textcolor{keywordflow}{if}(!error)
337       \{
338          \textcolor{comment}{//Shutdown TLS session}
339          error = \hyperlink{tls_8c_ae6a631703510008537d2cd97ab3425ef}{tlsShutdown}(context->tlsContext);
340       \}
341 
342       \textcolor{comment}{//Check status code}
343       \textcolor{keywordflow}{if}(!error)
344       \{
345          \textcolor{comment}{//Shutdown TCP connection}
346          error = \hyperlink{socket_8c_acc736b53dba4a0d3b11b63f75cdcfffb}{socketShutdown}(context->socket, \hyperlink{socket_8h_a36ee33c18de64f549a6336d1aa7333b7a4c533f4b86ea89dfd6a508bb4262c76d}{SOCKET\_SD\_BOTH});
347       \}
348    \}
349 \textcolor{preprocessor}{#endif}
350 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_WS\_SUPPORT == ENABLED)}
351    \textcolor{comment}{//WebSocket transport protocol?}
352    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa91cb729b8b8ee8b77deb57281f3873e8}{MQTT\_TRANSPORT\_PROTOCOL\_WS} ||
353       context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa03f2a698094d6d11c34e2a5c18f5542c}{MQTT\_TRANSPORT\_PROTOCOL\_WSS})
354    \{
355       \textcolor{comment}{//Set timeout}
356       error = \hyperlink{web__socket_8c_a62484c97e683330b9dc4953fce89f77b}{webSocketSetTimeout}(context->webSocket, context->settings.timeout);
357 
358       \textcolor{comment}{//Check status code}
359       \textcolor{keywordflow}{if}(!error)
360       \{
361          \textcolor{comment}{//Shutdown WebSocket connection}
362          error = \hyperlink{web__socket_8c_a7e9ab52f176656d3c91c94742b181656}{webSocketShutdown}(context->webSocket);
363       \}
364    \}
365 \textcolor{preprocessor}{#endif}
366    \textcolor{comment}{//Unknown transport protocol?}
367    \textcolor{keywordflow}{else}
368    \{
369       \textcolor{comment}{//Report an error}
370       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5a1904e109856f036391fa141fc8b5b3}{ERROR\_INVALID\_PROTOCOL};
371    \}
372 
373    \textcolor{comment}{//Return status code}
374    \textcolor{keywordflow}{return} error;
375 \}
\end{DoxyCode}
\mbox{\Hypertarget{mqtt__client__transport_8c_aac52321d3f941565861a56f33c95f226}\label{mqtt__client__transport_8c_aac52321d3f941565861a56f33c95f226}} 
\index{mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}!mqtt\+Client\+Wait\+For\+Data@{mqtt\+Client\+Wait\+For\+Data}}
\index{mqtt\+Client\+Wait\+For\+Data@{mqtt\+Client\+Wait\+For\+Data}!mqtt\+\_\+client\+\_\+transport.\+c@{mqtt\+\_\+client\+\_\+transport.\+c}}
\subsubsection{\texorpdfstring{mqtt\+Client\+Wait\+For\+Data()}{mqttClientWaitForData()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} mqtt\+Client\+Wait\+For\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{mqtt__client_8h_ac90ac46c748d19a3d358acc142237f2e}{Mqtt\+Client\+Context} $\ast$}]{context,  }\item[{\hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t}}]{timeout }\end{DoxyParamCaption})}



Wait for incoming data. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the M\+Q\+TT client context \\
\hline
\mbox{\tt in}  & {\em timeout} & Maximum time to wait before returning \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 595 of file mqtt\+\_\+client\+\_\+transport.\+c.


\begin{DoxyCode}
596 \{
597    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} event;
598 
599    \textcolor{comment}{//TCP transport protocol?}
600    \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa9e793dc8d512e7534fb490e2f98643f4}{MQTT\_TRANSPORT\_PROTOCOL\_TCP})
601    \{
602       \textcolor{comment}{//Get exclusive access}
603       \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
604       \textcolor{comment}{//Wait for some data to be available for reading}
605       \textcolor{keyword}{event} = \hyperlink{tcp__misc_8c_a004bf9b96c5217222960bc09c2e48a78}{tcpWaitForEvents}(context->socket, 
      \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY}, timeout);
606       \textcolor{comment}{//Release exclusive access}
607       \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
608    \}
609 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_TLS\_SUPPORT == ENABLED)}
610    \textcolor{comment}{//TLS transport protocol?}
611    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa6775842da4840be5ecb6dc2973668551}{MQTT\_TRANSPORT\_PROTOCOL\_TLS})
612    \{
613       \textcolor{comment}{//Sanity check}
614       \textcolor{keywordflow}{if}(context->tlsContext == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
615          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
616 
617       \textcolor{comment}{//Check whether some data is pending in the receive buffer}
618       \textcolor{keywordflow}{if}(context->tlsContext->rxBufferLen > 0)
619       \{
620          \textcolor{comment}{//No need to poll the underlying socket for incoming traffic...}
621          \textcolor{keyword}{event} = \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY};
622       \}
623       \textcolor{keywordflow}{else}
624       \{
625          \textcolor{comment}{//Get exclusive access}
626          \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
627          \textcolor{comment}{//Wait for some data to be available for reading}
628          \textcolor{keyword}{event} = \hyperlink{tcp__misc_8c_a004bf9b96c5217222960bc09c2e48a78}{tcpWaitForEvents}(context->socket, 
      \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY}, timeout);
629          \textcolor{comment}{//Release exclusive access}
630          \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
631       \}
632    \}
633 \textcolor{preprocessor}{#endif}
634 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_WS\_SUPPORT == ENABLED)}
635    \textcolor{comment}{//WebSocket transport protocol?}
636    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa91cb729b8b8ee8b77deb57281f3873e8}{MQTT\_TRANSPORT\_PROTOCOL\_WS})
637    \{
638       \textcolor{comment}{//Sanity check}
639       \textcolor{keywordflow}{if}(context->webSocket == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
640          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
641 
642       \textcolor{comment}{//Get exclusive access}
643       \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
644       \textcolor{comment}{//Wait for some data to be available for reading}
645       \textcolor{keyword}{event} = \hyperlink{tcp__misc_8c_a004bf9b96c5217222960bc09c2e48a78}{tcpWaitForEvents}(context->webSocket->socket, 
      \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY}, timeout);
646       \textcolor{comment}{//Release exclusive access}
647       \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
648    \}
649 \textcolor{preprocessor}{#endif}
650 \textcolor{preprocessor}{#if (MQTT\_CLIENT\_WS\_SUPPORT == ENABLED && WEB\_SOCKET\_TLS\_SUPPORT)}
651    \textcolor{comment}{//Secure WebSocket transport protocol?}
652    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->settings.transportProtocol == \hyperlink{mqtt__common_8h_ab192b1b856cff3c25110cdadf5debe0fa03f2a698094d6d11c34e2a5c18f5542c}{MQTT\_TRANSPORT\_PROTOCOL\_WSS})
653    \{
654       \textcolor{comment}{//Sanity check}
655       \textcolor{keywordflow}{if}(context->webSocket == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || context->webSocket->tlsContext == 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
656          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
657 
658       \textcolor{comment}{//Check whether some data is pending in the receive buffer}
659       \textcolor{keywordflow}{if}(context->webSocket->tlsContext->rxBufferLen > 0)
660       \{
661          \textcolor{comment}{//No need to poll the underlying socket for incoming traffic...}
662          \textcolor{keyword}{event} = \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY};
663       \}
664       \textcolor{keywordflow}{else}
665       \{
666          \textcolor{comment}{//Get exclusive access}
667          \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
668          \textcolor{comment}{//Wait for some data to be available for reading}
669          \textcolor{keyword}{event} = \hyperlink{tcp__misc_8c_a004bf9b96c5217222960bc09c2e48a78}{tcpWaitForEvents}(context->webSocket->socket, 
      \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY}, timeout);
670          \textcolor{comment}{//Release exclusive access}
671          \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
672       \}
673    \}
674 \textcolor{preprocessor}{#endif}
675    \textcolor{comment}{//Unknown transport protocol?}
676    \textcolor{keywordflow}{else}
677    \{
678       \textcolor{comment}{//Report an error}
679       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5a1904e109856f036391fa141fc8b5b3}{ERROR\_INVALID\_PROTOCOL};
680    \}
681 
682    \textcolor{comment}{//Check whether some data is available for reading}
683    \textcolor{keywordflow}{if}(event == \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY})
684       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
685    \textcolor{keywordflow}{else}
686       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT};
687 \}
\end{DoxyCode}
