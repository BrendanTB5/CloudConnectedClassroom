\hypertarget{dns__cache_8c}{}\section{cyclone\+\_\+tcp/dns/dns\+\_\+cache.c File Reference}
\label{dns__cache_8c}\index{cyclone\+\_\+tcp/dns/dns\+\_\+cache.\+c@{cyclone\+\_\+tcp/dns/dns\+\_\+cache.\+c}}


D\+NS cache management.  


{\ttfamily \#include $<$stdlib.\+h$>$}\newline
{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dns/dns\+\_\+cache.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dns/dns\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mdns/mdns\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}netbios/nbns\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}core/udp.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{dns__cache_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_ac9a922c1d0cd796bab6e76bfa73b5ee7}{D\+N\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dns__cache_8c_a672cf751d2b462aa4ff1c9809dc93f79}{dns\+Init} (void)
\begin{DoxyCompactList}\small\item\em D\+NS cache initialization. \end{DoxyCompactList}\item 
void \hyperlink{dns__cache_8c_a5304462a0585074999dcecb20f8ae912}{dns\+Flush\+Cache} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Flush D\+NS cache. \end{DoxyCompactList}\item 
\hyperlink{structDnsCacheEntry}{Dns\+Cache\+Entry} $\ast$ \hyperlink{dns__cache_8c_ac154126efa899c325ee537727c9f5174}{dns\+Create\+Entry} (void)
\begin{DoxyCompactList}\small\item\em Create a new entry in the D\+NS cache. \end{DoxyCompactList}\item 
void \hyperlink{dns__cache_8c_a8bd5944a21fc50810a1592a028bd1a62}{dns\+Delete\+Entry} (\hyperlink{structDnsCacheEntry}{Dns\+Cache\+Entry} $\ast$entry)
\begin{DoxyCompactList}\small\item\em Delete the specified D\+NS cache entry. \end{DoxyCompactList}\item 
\hyperlink{structDnsCacheEntry}{Dns\+Cache\+Entry} $\ast$ \hyperlink{dns__cache_8c_a079712e25d65a0e902068e6fea3141ae}{dns\+Find\+Entry} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}, \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bd}{Host\+Type} \hyperlink{ppp_8h_a1d127017fb298b889f4ba24752d08b8e}{type}, \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94}{Hostname\+Resolver} \hyperlink{lcp_8h_ab551400c74271f35d0c79f81d29cffbb}{protocol})
\begin{DoxyCompactList}\small\item\em Search the D\+NS cache for a given domain name. \end{DoxyCompactList}\item 
void \hyperlink{dns__cache_8c_afbc1265d7d5cc5ce346f187ff7f6de10}{dns\+Tick} (void)
\begin{DoxyCompactList}\small\item\em D\+NS timer handler. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t} \hyperlink{dns__cache_8c_ab78a95b8097e57c5ea2c75ffa37ade69}{dns\+Tick\+Counter}
\item 
\hyperlink{structDnsCacheEntry}{Dns\+Cache\+Entry} \hyperlink{dns__cache_8c_a459576a3a6c3ed0c90f544dabacc8377}{dns\+Cache} \mbox{[}\hyperlink{dns__cache_8h_a0559240be0228278dd24ac2103aa0c66}{D\+N\+S\+\_\+\+C\+A\+C\+H\+E\+\_\+\+S\+I\+ZE}\mbox{]}
\end{DoxyCompactItemize}


\subsection{Detailed Description}
D\+NS cache management. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{dns__cache_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{dns__cache_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_ac9a922c1d0cd796bab6e76bfa73b5ee7}{D\+N\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file dns\+\_\+cache.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{dns__cache_8c_ac154126efa899c325ee537727c9f5174}\label{dns__cache_8c_ac154126efa899c325ee537727c9f5174}} 
\index{dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}!dns\+Create\+Entry@{dns\+Create\+Entry}}
\index{dns\+Create\+Entry@{dns\+Create\+Entry}!dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}}
\subsubsection{\texorpdfstring{dns\+Create\+Entry()}{dnsCreateEntry()}}
{\footnotesize\ttfamily \hyperlink{structDnsCacheEntry}{Dns\+Cache\+Entry}$\ast$ dns\+Create\+Entry (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Create a new entry in the D\+NS cache. 

\begin{DoxyReturn}{Returns}
Pointer to the newly created entry 
\end{DoxyReturn}


Definition at line 101 of file dns\+\_\+cache.\+c.


\begin{DoxyCode}
102 \{
103    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
104    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
105    \hyperlink{structDnsCacheEntry}{DnsCacheEntry} *entry;
106    \hyperlink{structDnsCacheEntry}{DnsCacheEntry} *oldestEntry;
107 
108    \textcolor{comment}{//Get current time}
109    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
110 
111    \textcolor{comment}{//Keep track of the oldest entry}
112    oldestEntry = &\hyperlink{dns__cache_8c_a459576a3a6c3ed0c90f544dabacc8377}{dnsCache}[0];
113 
114    \textcolor{comment}{//Loop through DNS cache entries}
115    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dns__cache_8h_a0559240be0228278dd24ac2103aa0c66}{DNS\_CACHE\_SIZE}; i++)
116    \{
117       \textcolor{comment}{//Point to the current entry}
118       entry = &\hyperlink{dns__cache_8c_a459576a3a6c3ed0c90f544dabacc8377}{dnsCache}[i];
119 
120       \textcolor{comment}{//Check whether the entry is currently in used or not}
121       \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3adc13bd822dbaeac0b265a5e4d6e09905}{DNS\_STATE\_NONE})
122       \{
123          \textcolor{comment}{//Erase contents}
124          memset(entry, 0, \textcolor{keyword}{sizeof}(\hyperlink{structDnsCacheEntry}{DnsCacheEntry}));
125          \textcolor{comment}{//Return a pointer to the DNS entry}
126          \textcolor{keywordflow}{return} entry;
127       \}
128 
129       \textcolor{comment}{//Keep track of the oldest entry in the table}
130       \textcolor{keywordflow}{if}((time - entry->\hyperlink{structDnsCacheEntry_ae149514d2ade99ae033ecedd03a5daf0}{timestamp}) > (time - oldestEntry->\hyperlink{structDnsCacheEntry_ae149514d2ade99ae033ecedd03a5daf0}{timestamp}))
131       \{
132          oldestEntry = entry;
133       \}
134    \}
135 
136    \textcolor{comment}{//The oldest entry is removed whenever the table runs out of space}
137    \hyperlink{dns__cache_8c_a8bd5944a21fc50810a1592a028bd1a62}{dnsDeleteEntry}(oldestEntry);
138    \textcolor{comment}{//Erase contents}
139    memset(oldestEntry, 0, \textcolor{keyword}{sizeof}(\hyperlink{structDnsCacheEntry}{DnsCacheEntry}));
140    \textcolor{comment}{//Return a pointer to the DNS entry}
141    \textcolor{keywordflow}{return} oldestEntry;
142 \}
\end{DoxyCode}
\mbox{\Hypertarget{dns__cache_8c_a8bd5944a21fc50810a1592a028bd1a62}\label{dns__cache_8c_a8bd5944a21fc50810a1592a028bd1a62}} 
\index{dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}!dns\+Delete\+Entry@{dns\+Delete\+Entry}}
\index{dns\+Delete\+Entry@{dns\+Delete\+Entry}!dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}}
\subsubsection{\texorpdfstring{dns\+Delete\+Entry()}{dnsDeleteEntry()}}
{\footnotesize\ttfamily void dns\+Delete\+Entry (\begin{DoxyParamCaption}\item[{\hyperlink{structDnsCacheEntry}{Dns\+Cache\+Entry} $\ast$}]{entry }\end{DoxyParamCaption})}



Delete the specified D\+NS cache entry. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em entry} & Pointer to the D\+NS cache entry to be deleted \\
\hline
\end{DoxyParams}


Definition at line 150 of file dns\+\_\+cache.\+c.


\begin{DoxyCode}
151 \{
152    \textcolor{comment}{//Make sure the specified entry is valid}
153    \textcolor{keywordflow}{if}(entry != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
154    \{
155 \textcolor{preprocessor}{#if (DNS\_CLIENT\_SUPPORT == ENABLED)}
156       \textcolor{comment}{//DNS resolver?}
157       \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_aeb800b57a9593f4749e3ae8ac03f4a71}{protocol} == \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94a7289eef0101ef470c06bfb1c96d37396}{HOST\_NAME\_RESOLVER\_DNS})
158       \{
159          \textcolor{comment}{//Name resolution in progress?}
160          \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3affcd994aeea92ea47ae5be4f6a2f7511}{DNS\_STATE\_IN\_PROGRESS})
161          \{
162             \textcolor{comment}{//Unregister user callback}
163             \hyperlink{udp_8c_a1d915e0747de1926d096062048111e66}{udpDetachRxCallback}(entry->\hyperlink{structDnsCacheEntry_ad0d0a0228fc29308f59f4b2d402758e6}{interface}, entry->
      \hyperlink{structDnsCacheEntry_a694ec8e23fd08f447e85244478ace829}{port});
164          \}
165       \}
166 \textcolor{preprocessor}{#endif}
167       \textcolor{comment}{//Delete DNS cache entry}
168       entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} = \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3adc13bd822dbaeac0b265a5e4d6e09905}{DNS\_STATE\_NONE};
169    \}
170 \}
\end{DoxyCode}
\mbox{\Hypertarget{dns__cache_8c_a079712e25d65a0e902068e6fea3141ae}\label{dns__cache_8c_a079712e25d65a0e902068e6fea3141ae}} 
\index{dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}!dns\+Find\+Entry@{dns\+Find\+Entry}}
\index{dns\+Find\+Entry@{dns\+Find\+Entry}!dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}}
\subsubsection{\texorpdfstring{dns\+Find\+Entry()}{dnsFindEntry()}}
{\footnotesize\ttfamily \hyperlink{structDnsCacheEntry}{Dns\+Cache\+Entry}$\ast$ dns\+Find\+Entry (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{name,  }\item[{\hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bd}{Host\+Type}}]{type,  }\item[{\hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94}{Hostname\+Resolver}}]{protocol }\end{DoxyParamCaption})}



Search the D\+NS cache for a given domain name. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em name} & Domain name \\
\hline
\mbox{\tt in}  & {\em type} & Host type (I\+Pv4 or I\+Pv6) \\
\hline
\mbox{\tt in}  & {\em protocol} & Host name resolution protocol \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
A pointer to the matching D\+NS entry is returned. N\+U\+LL is returned if the specified domain name could not be found in the D\+NS cache 
\end{DoxyReturn}


Definition at line 183 of file dns\+\_\+cache.\+c.


\begin{DoxyCode}
185 \{
186    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
187    \hyperlink{structDnsCacheEntry}{DnsCacheEntry} *entry;
188 
189    \textcolor{comment}{//Loop through DNS cache entries}
190    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dns__cache_8h_a0559240be0228278dd24ac2103aa0c66}{DNS\_CACHE\_SIZE}; i++)
191    \{
192       \textcolor{comment}{//Point to the current entry}
193       entry = &\hyperlink{dns__cache_8c_a459576a3a6c3ed0c90f544dabacc8377}{dnsCache}[i];
194 
195       \textcolor{comment}{//Make sure that the entry is currently in used}
196       \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3adc13bd822dbaeac0b265a5e4d6e09905}{DNS\_STATE\_NONE})
197          \textcolor{keywordflow}{continue};
198 
199       \textcolor{comment}{//Filter out entries that do not match the specified criteria}
200       \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ad0d0a0228fc29308f59f4b2d402758e6}{interface} != interface)
201          \textcolor{keywordflow}{continue};
202       \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_a5520082c9b81d8244f858641785ac01e}{type} != \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type} && \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type} != \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdae62e4d81f41cef89d1dfb1707c7443d7}{HOST\_TYPE\_ANY})
203          \textcolor{keywordflow}{continue};
204       \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_aeb800b57a9593f4749e3ae8ac03f4a71}{protocol} != \hyperlink{dhcpv6__common_8h_ad124d3d2e02c729afa303c775295278e}{protocol} && \hyperlink{dhcpv6__common_8h_ad124d3d2e02c729afa303c775295278e}{protocol} != 
      \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94acfdd66842c7a2e6697e28165d5510529}{HOST\_NAME\_RESOLVER\_ANY})
205          \textcolor{keywordflow}{continue};
206 
207       \textcolor{comment}{//Does the entry match the specified domain name?}
208       \textcolor{keywordflow}{if}(\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name} == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || !\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(entry->\hyperlink{structDnsCacheEntry_a81b2ed3b8465dd82a249f7141865dae6}{name}, \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}))
209          \textcolor{keywordflow}{return} entry;
210    \}
211 
212    \textcolor{comment}{//No matching entry in the DNS cache...}
213    \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
214 \}
\end{DoxyCode}
\mbox{\Hypertarget{dns__cache_8c_a5304462a0585074999dcecb20f8ae912}\label{dns__cache_8c_a5304462a0585074999dcecb20f8ae912}} 
\index{dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}!dns\+Flush\+Cache@{dns\+Flush\+Cache}}
\index{dns\+Flush\+Cache@{dns\+Flush\+Cache}!dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}}
\subsubsection{\texorpdfstring{dns\+Flush\+Cache()}{dnsFlushCache()}}
{\footnotesize\ttfamily void dns\+Flush\+Cache (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Flush D\+NS cache. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 74 of file dns\+\_\+cache.\+c.


\begin{DoxyCode}
75 \{
76    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
77    \hyperlink{structDnsCacheEntry}{DnsCacheEntry} *entry;
78 
79    \textcolor{comment}{//Go through DNS cache}
80    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dns__cache_8h_a0559240be0228278dd24ac2103aa0c66}{DNS\_CACHE\_SIZE}; i++)
81    \{
82       \textcolor{comment}{//Point to the current entry}
83       entry = &\hyperlink{dns__cache_8c_a459576a3a6c3ed0c90f544dabacc8377}{dnsCache}[i];
84 
85       \textcolor{comment}{//Check whether the entry is currently in used}
86       \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} != \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3adc13bd822dbaeac0b265a5e4d6e09905}{DNS\_STATE\_NONE})
87       \{
88          \textcolor{comment}{//Delete DNS entries only for the given network interface}
89          \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ad0d0a0228fc29308f59f4b2d402758e6}{interface} == interface)
90             \hyperlink{dns__cache_8c_a8bd5944a21fc50810a1592a028bd1a62}{dnsDeleteEntry}(entry);
91       \}
92    \}
93 \}
\end{DoxyCode}
\mbox{\Hypertarget{dns__cache_8c_a672cf751d2b462aa4ff1c9809dc93f79}\label{dns__cache_8c_a672cf751d2b462aa4ff1c9809dc93f79}} 
\index{dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}!dns\+Init@{dns\+Init}}
\index{dns\+Init@{dns\+Init}!dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}}
\subsubsection{\texorpdfstring{dns\+Init()}{dnsInit()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dns\+Init (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



D\+NS cache initialization. 

\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 59 of file dns\+\_\+cache.\+c.


\begin{DoxyCode}
60 \{
61    \textcolor{comment}{//Initialize DNS cache}
62    memset(\hyperlink{dns__cache_8c_a459576a3a6c3ed0c90f544dabacc8377}{dnsCache}, 0, \textcolor{keyword}{sizeof}(\hyperlink{dns__cache_8c_a459576a3a6c3ed0c90f544dabacc8377}{dnsCache}));
63 
64    \textcolor{comment}{//Successful initialization}
65    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
66 \}
\end{DoxyCode}
\mbox{\Hypertarget{dns__cache_8c_afbc1265d7d5cc5ce346f187ff7f6de10}\label{dns__cache_8c_afbc1265d7d5cc5ce346f187ff7f6de10}} 
\index{dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}!dns\+Tick@{dns\+Tick}}
\index{dns\+Tick@{dns\+Tick}!dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}}
\subsubsection{\texorpdfstring{dns\+Tick()}{dnsTick()}}
{\footnotesize\ttfamily void dns\+Tick (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



D\+NS timer handler. 

This routine must be periodically called by the T\+C\+P/\+IP stack to manage D\+NS cache 

Definition at line 225 of file dns\+\_\+cache.\+c.


\begin{DoxyCode}
226 \{
227    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
228    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
229    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
230    \hyperlink{structDnsCacheEntry}{DnsCacheEntry} *entry;
231 
232    \textcolor{comment}{//Get current time}
233    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
234 
235    \textcolor{comment}{//Go through DNS cache}
236    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dns__cache_8h_a0559240be0228278dd24ac2103aa0c66}{DNS\_CACHE\_SIZE}; i++)
237    \{
238       \textcolor{comment}{//Point to the current entry}
239       entry = &\hyperlink{dns__cache_8c_a459576a3a6c3ed0c90f544dabacc8377}{dnsCache}[i];
240 
241       \textcolor{comment}{//Name resolution in progress?}
242       \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3affcd994aeea92ea47ae5be4f6a2f7511}{DNS\_STATE\_IN\_PROGRESS})
243       \{
244          \textcolor{comment}{//The request timed out?}
245          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, entry->\hyperlink{structDnsCacheEntry_ae149514d2ade99ae033ecedd03a5daf0}{timestamp} + entry->
      \hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout}) >= 0)
246          \{
247             \textcolor{comment}{//Check whether the maximum number of retransmissions has been exceeded}
248             \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_aa1813da7ebe162f069a6079aa2365db1}{retransmitCount} > 0)
249             \{
250 \textcolor{preprocessor}{#if (DNS\_CLIENT\_SUPPORT == ENABLED)}
251                \textcolor{comment}{//DNS resolver?}
252                \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_aeb800b57a9593f4749e3ae8ac03f4a71}{protocol} == \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94a7289eef0101ef470c06bfb1c96d37396}{HOST\_NAME\_RESOLVER\_DNS})
253                \{
254                   \textcolor{comment}{//Retransmit DNS query}
255                   error = \hyperlink{dns__client_8c_a71fc5f544d54cd6dbf45c45292de4719}{dnsSendQuery}(entry);
256                \}
257                \textcolor{keywordflow}{else}
258 \textcolor{preprocessor}{#endif}
259 \textcolor{preprocessor}{#if (MDNS\_CLIENT\_SUPPORT == ENABLED)}
260                \textcolor{comment}{//mDNS resolver?}
261                \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_aeb800b57a9593f4749e3ae8ac03f4a71}{protocol} == \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94a9e9dee333128d92abfcdb6d58f2b7cb4}{HOST\_NAME\_RESOLVER\_MDNS})
262                \{
263                   \textcolor{comment}{//Retransmit mDNS query}
264                   error = \hyperlink{mdns__client_8c_a552c202117e19d36b8deaa21b62a9a63}{mdnsClientSendQuery}(entry);
265                \}
266                \textcolor{keywordflow}{else}
267 \textcolor{preprocessor}{#endif}
268 \textcolor{preprocessor}{#if (NBNS\_CLIENT\_SUPPORT == ENABLED && IPV4\_SUPPORT == ENABLED)}
269                \textcolor{comment}{//NetBIOS Name Service resolver?}
270                \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_aeb800b57a9593f4749e3ae8ac03f4a71}{protocol} == \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94a71aefbb76f027115b860aebd98ce74e9}{HOST\_NAME\_RESOLVER\_NBNS})
271                \{
272                   \textcolor{comment}{//Retransmit NBNS query}
273                   error = \hyperlink{nbns__client_8c_a42df9ad6f78e5e2e05d9cfef77482e98}{nbnsSendQuery}(entry);
274                \}
275                \textcolor{keywordflow}{else}
276 \textcolor{preprocessor}{#endif}
277                \textcolor{comment}{//Unknown protocol?}
278                \{
279                   error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
280                \}
281 
282                \textcolor{comment}{//Query message successfully sent?}
283                \textcolor{keywordflow}{if}(!error)
284                \{
285                   \textcolor{comment}{//Save the time at which the query message was sent}
286                   entry->\hyperlink{structDnsCacheEntry_ae149514d2ade99ae033ecedd03a5daf0}{timestamp} = \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
287                   \textcolor{comment}{//The timeout value is doubled for each subsequent retransmission}
288                   entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout} = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout} * 2, entry->
      \hyperlink{structDnsCacheEntry_a4167197fb96cd19e4efdcd25184749c1}{maxTimeout});
289                   \textcolor{comment}{//Decrement retransmission counter}
290                   entry->\hyperlink{structDnsCacheEntry_aa1813da7ebe162f069a6079aa2365db1}{retransmitCount}--;
291                \}
292                \textcolor{keywordflow}{else}
293                \{
294                   \textcolor{comment}{//The entry should be deleted since name resolution has failed}
295                   \hyperlink{dns__cache_8c_a8bd5944a21fc50810a1592a028bd1a62}{dnsDeleteEntry}(entry);
296                \}
297             \}
298 \textcolor{preprocessor}{#if (DNS\_CLIENT\_SUPPORT == ENABLED)}
299             \textcolor{comment}{//DNS resolver?}
300             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_aeb800b57a9593f4749e3ae8ac03f4a71}{protocol} == \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94a7289eef0101ef470c06bfb1c96d37396}{HOST\_NAME\_RESOLVER\_DNS})
301             \{
302                \textcolor{comment}{//Select the next DNS server}
303                entry->\hyperlink{structDnsCacheEntry_a64c746516176b9ecc93492623e951a5c}{dnsServerNum}++;
304                \textcolor{comment}{//Initialize retransmission counter}
305                entry->\hyperlink{structDnsCacheEntry_aa1813da7ebe162f069a6079aa2365db1}{retransmitCount} = \hyperlink{dns__client_8h_acea30f639d3d2500b385045ba776793d}{DNS\_CLIENT\_MAX\_RETRIES};
306                \textcolor{comment}{//Send DNS query}
307                error = \hyperlink{dns__client_8c_a71fc5f544d54cd6dbf45c45292de4719}{dnsSendQuery}(entry);
308 
309                \textcolor{comment}{//DNS message successfully sent?}
310                \textcolor{keywordflow}{if}(!error)
311                \{
312                   \textcolor{comment}{//Save the time at which the query message was sent}
313                   entry->\hyperlink{structDnsCacheEntry_ae149514d2ade99ae033ecedd03a5daf0}{timestamp} = \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
314                   \textcolor{comment}{//Set timeout value}
315                   entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout} = \hyperlink{dns__client_8h_ac3020fc20ede400fa6670fc6f7546ee4}{DNS\_CLIENT\_INIT\_TIMEOUT};
316                   \textcolor{comment}{//Decrement retransmission counter}
317                   entry->\hyperlink{structDnsCacheEntry_aa1813da7ebe162f069a6079aa2365db1}{retransmitCount}--;
318                \}
319                \textcolor{keywordflow}{else}
320                \{
321                   \textcolor{comment}{//The entry should be deleted since name resolution has failed}
322                   \hyperlink{dns__cache_8c_a8bd5944a21fc50810a1592a028bd1a62}{dnsDeleteEntry}(entry);
323                \}
324             \}
325 \textcolor{preprocessor}{#endif}
326             \textcolor{keywordflow}{else}
327             \{
328                \textcolor{comment}{//The maximum number of retransmissions has been exceeded}
329                \hyperlink{dns__cache_8c_a8bd5944a21fc50810a1592a028bd1a62}{dnsDeleteEntry}(entry);
330             \}
331          \}
332       \}
333       \textcolor{comment}{//Name successfully resolved?}
334       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3a29c9441f0fda002de6ba63d19b20f334}{DNS\_STATE\_RESOLVED})
335       \{
336          \textcolor{comment}{//Check the lifetime of the current DNS cache entry}
337          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, entry->\hyperlink{structDnsCacheEntry_ae149514d2ade99ae033ecedd03a5daf0}{timestamp} + entry->
      \hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout}) >= 0)
338          \{
339             \textcolor{comment}{//Periodically time out DNS cache entries}
340             \hyperlink{dns__cache_8c_a8bd5944a21fc50810a1592a028bd1a62}{dnsDeleteEntry}(entry);
341          \}
342       \}
343    \}
344 \}
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{dns__cache_8c_a459576a3a6c3ed0c90f544dabacc8377}\label{dns__cache_8c_a459576a3a6c3ed0c90f544dabacc8377}} 
\index{dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}!dns\+Cache@{dns\+Cache}}
\index{dns\+Cache@{dns\+Cache}!dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}}
\subsubsection{\texorpdfstring{dns\+Cache}{dnsCache}}
{\footnotesize\ttfamily \hyperlink{structDnsCacheEntry}{Dns\+Cache\+Entry} dns\+Cache\mbox{[}\hyperlink{dns__cache_8h_a0559240be0228278dd24ac2103aa0c66}{D\+N\+S\+\_\+\+C\+A\+C\+H\+E\+\_\+\+S\+I\+ZE}\mbox{]}}



Definition at line 51 of file dns\+\_\+cache.\+c.

\mbox{\Hypertarget{dns__cache_8c_ab78a95b8097e57c5ea2c75ffa37ade69}\label{dns__cache_8c_ab78a95b8097e57c5ea2c75ffa37ade69}} 
\index{dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}!dns\+Tick\+Counter@{dns\+Tick\+Counter}}
\index{dns\+Tick\+Counter@{dns\+Tick\+Counter}!dns\+\_\+cache.\+c@{dns\+\_\+cache.\+c}}
\subsubsection{\texorpdfstring{dns\+Tick\+Counter}{dnsTickCounter}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t} dns\+Tick\+Counter}



Definition at line 49 of file dns\+\_\+cache.\+c.

