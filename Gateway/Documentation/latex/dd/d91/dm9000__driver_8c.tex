\hypertarget{dm9000__driver_8c}{}\section{cyclone\+\_\+tcp/drivers/eth/dm9000\+\_\+driver.c File Reference}
\label{dm9000__driver_8c}\index{cyclone\+\_\+tcp/drivers/eth/dm9000\+\_\+driver.\+c@{cyclone\+\_\+tcp/drivers/eth/dm9000\+\_\+driver.\+c}}


D\+M9000\+A/B Ethernet controller.  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}core/ethernet.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}drivers/eth/dm9000\+\_\+driver.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{dm9000__driver_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_a880f48968c7969b328d5061cd3db0f36}{N\+I\+C\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dm9000__driver_8c_afce6a3ba759e89c7f9c70378d16a0128}{dm9000\+Init} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em D\+M9000 controller initialization. \end{DoxyCompactList}\item 
void \hyperlink{dm9000__driver_8c_ac567a1237da77c173ac1e7315340934f}{dm9000\+Tick} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em D\+M9000 timer handler. \end{DoxyCompactList}\item 
void \hyperlink{dm9000__driver_8c_acec7c0a2ca79d63efe45e1145c02d226}{dm9000\+Enable\+Irq} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Enable interrupts. \end{DoxyCompactList}\item 
void \hyperlink{dm9000__driver_8c_a633b06b67505e31c7c7b277f206637e2}{dm9000\+Disable\+Irq} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Disable interrupts. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} \hyperlink{dm9000__driver_8c_ad3c1a4851356a2859b94e9ee7789d84e}{dm9000\+Irq\+Handler} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em D\+M9000 interrupt service routine. \end{DoxyCompactList}\item 
void \hyperlink{dm9000__driver_8c_a9f190c0014dcd57f94af1bbcff5ab49b}{dm9000\+Event\+Handler} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em D\+M9000 event handler. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dm9000__driver_8c_a34d0f7bedd37d3428ea20a4cd85dda8c}{dm9000\+Send\+Packet} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset})
\begin{DoxyCompactList}\small\item\em Send a packet to D\+M9000. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dm9000__driver_8c_a09d01c85eb9e06ec0976c9bc7582abda}{dm9000\+Receive\+Packet} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Receive a packet. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dm9000__driver_8c_ab2a9d5e4db72c0c80a0f0755ece356a3}{dm9000\+Update\+Mac\+Addr\+Filter} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Configure M\+AC address filtering. \end{DoxyCompactList}\item 
void \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000\+Write\+Reg} (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data})
\begin{DoxyCompactList}\small\item\em Write D\+M9000 register. \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000\+Read\+Reg} (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address})
\begin{DoxyCompactList}\small\item\em Read D\+M9000 register. \end{DoxyCompactList}\item 
void \hyperlink{dm9000__driver_8c_aa6d8e85625e330a579bdc3c8169a69f5}{dm9000\+Write\+Phy\+Reg} (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data})
\begin{DoxyCompactList}\small\item\em Write D\+M9000 P\+HY register. \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{dm9000__driver_8c_a4105b062c5337a2cd252acb687dd0ac4}{dm9000\+Read\+Phy\+Reg} (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{ndp_8h_a1b452a6c3ab338d73213b321b6750f2b}{address})
\begin{DoxyCompactList}\small\item\em Read D\+M9000 P\+HY register. \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{dm9000__driver_8c_ac71e6d89c21e8baa7beb0d007bdcf707}{dm9000\+Calc\+Crc} (const void $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em C\+RC calculation. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
const \hyperlink{structNicDriver}{Nic\+Driver} \hyperlink{dm9000__driver_8c_a9fb1e9f0a7999d901d678c17f4a34b26}{dm9000\+Driver}
\begin{DoxyCompactList}\small\item\em D\+M9000 driver. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
D\+M9000\+A/B Ethernet controller. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{dm9000__driver_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{dm9000__driver_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_a880f48968c7969b328d5061cd3db0f36}{N\+I\+C\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file dm9000\+\_\+driver.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{dm9000__driver_8c_ac71e6d89c21e8baa7beb0d007bdcf707}\label{dm9000__driver_8c_ac71e6d89c21e8baa7beb0d007bdcf707}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Calc\+Crc@{dm9000\+Calc\+Crc}}
\index{dm9000\+Calc\+Crc@{dm9000\+Calc\+Crc}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Calc\+Crc()}{dm9000CalcCrc()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} dm9000\+Calc\+Crc (\begin{DoxyParamCaption}\item[{const void $\ast$}]{data,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



C\+RC calculation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em data} & Pointer to the data over which to calculate the C\+RC \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes to process \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Resulting C\+RC value 
\end{DoxyReturn}


Definition at line 672 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
673 \{
674    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
675    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} j;
676 
677    \textcolor{comment}{//Point to the data over which to calculate the CRC}
678    \textcolor{keyword}{const} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
679    \textcolor{comment}{//CRC preset value}
680    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} crc = 0xFFFFFFFF;
681 
682    \textcolor{comment}{//Loop through data}
683    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}; i++)
684    \{
685       \textcolor{comment}{//Update CRC value}
686       crc ^= p[i];
687       \textcolor{comment}{//The message is processed bit by bit}
688       \textcolor{keywordflow}{for}(j = 0; j < 8; j++)
689       \{
690          \textcolor{keywordflow}{if}(crc & 0x00000001)
691             crc = (crc >> 1) ^ 0xEDB88320;
692          \textcolor{keywordflow}{else}
693             crc = crc >> 1;
694       \}
695    \}
696 
697    \textcolor{comment}{//Return CRC value}
698    \textcolor{keywordflow}{return} crc;
699 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_a633b06b67505e31c7c7b277f206637e2}\label{dm9000__driver_8c_a633b06b67505e31c7c7b277f206637e2}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Disable\+Irq@{dm9000\+Disable\+Irq}}
\index{dm9000\+Disable\+Irq@{dm9000\+Disable\+Irq}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Disable\+Irq()}{dm9000DisableIrq()}}
{\footnotesize\ttfamily void dm9000\+Disable\+Irq (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Disable interrupts. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 209 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
210 \{
211    \textcolor{comment}{//Disable interrupts}
212    interface->extIntDriver->disableIrq();
213 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_acec7c0a2ca79d63efe45e1145c02d226}\label{dm9000__driver_8c_acec7c0a2ca79d63efe45e1145c02d226}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Enable\+Irq@{dm9000\+Enable\+Irq}}
\index{dm9000\+Enable\+Irq@{dm9000\+Enable\+Irq}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Enable\+Irq()}{dm9000EnableIrq()}}
{\footnotesize\ttfamily void dm9000\+Enable\+Irq (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Enable interrupts. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 197 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
198 \{
199    \textcolor{comment}{//Enable interrupts}
200    interface->extIntDriver->enableIrq();
201 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_a9f190c0014dcd57f94af1bbcff5ab49b}\label{dm9000__driver_8c_a9f190c0014dcd57f94af1bbcff5ab49b}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Event\+Handler@{dm9000\+Event\+Handler}}
\index{dm9000\+Event\+Handler@{dm9000\+Event\+Handler}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Event\+Handler()}{dm9000EventHandler()}}
{\footnotesize\ttfamily void dm9000\+Event\+Handler (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



D\+M9000 event handler. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 294 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
295 \{
296    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
297    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} status;
298 
299    \textcolor{comment}{//Read interrupt status register}
300    status = \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_ad8a10a580a818297f25da4560a7c1868}{DM9000\_REG\_ISR});
301 
302    \textcolor{comment}{//Check whether the link status has changed?}
303    \textcolor{keywordflow}{if}(status & \hyperlink{dm9000__driver_8h_a1c358f988bb938c4a47b77e874f75e86}{ISR\_LNKCHG})
304    \{
305       \textcolor{comment}{//Clear interrupt flag}
306       \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_ad8a10a580a818297f25da4560a7c1868}{DM9000\_REG\_ISR}, ISR\_LNKCHG);
307       \textcolor{comment}{//Read network status register}
308       status = \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a84cc8295050248ca7d6a42fa3083df87}{DM9000\_REG\_NSR});
309 
310       \textcolor{comment}{//Check link state}
311       \textcolor{keywordflow}{if}(status & \hyperlink{dm9000__driver_8h_ab112316009e123be1560d8d95307dc3b}{NSR\_LINKST})
312       \{
313          \textcolor{comment}{//Get current speed}
314          \textcolor{keywordflow}{if}(status & \hyperlink{dm9000__driver_8h_aec5fbee9b7a6957ced528bb4e171a582}{NSR\_SPEED})
315             interface->linkSpeed = \hyperlink{nic_8h_afef666155a43e0a2a3a1f0df9e50bab4a43656b0244470a43d497c77353f3da84}{NIC\_LINK\_SPEED\_10MBPS};
316          \textcolor{keywordflow}{else}
317             interface->linkSpeed = \hyperlink{nic_8h_afef666155a43e0a2a3a1f0df9e50bab4a3001394d2b59b22c97f6957e07ca28fd}{NIC\_LINK\_SPEED\_100MBPS};
318 
319          \textcolor{comment}{//Read network control register}
320          status = \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a9489998669f34d690bb612f3761c7d56}{DM9000\_REG\_NCR});
321 
322          \textcolor{comment}{//Determine the new duplex mode}
323          \textcolor{keywordflow}{if}(status & \hyperlink{dm9000__driver_8h_a2fa99abba95454c3ba5c4401cb53d373}{NCR\_FDX})
324             interface->duplexMode = \hyperlink{nic_8h_ae96e77ca948a3796e2d1900a73f133daa2c75584234136d8fd79f372116d26340}{NIC\_FULL\_DUPLEX\_MODE};
325          \textcolor{keywordflow}{else}
326             interface->duplexMode = \hyperlink{nic_8h_ae96e77ca948a3796e2d1900a73f133daa60856f1c6ecbcb1227b653fb48205f41}{NIC\_HALF\_DUPLEX\_MODE};
327 
328          \textcolor{comment}{//Link is up}
329          interface->linkState = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
330       \}
331       \textcolor{keywordflow}{else}
332       \{
333          \textcolor{comment}{//Link is down}
334          interface->linkState = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
335       \}
336 
337       \textcolor{comment}{//Process link state change event}
338       \hyperlink{nic_8c_ae9054795c5d49a4db97396bf1d16b413}{nicNotifyLinkChange}(interface);
339    \}
340 
341    \textcolor{comment}{//Check whether a packet has been received?}
342    \textcolor{keywordflow}{if}(status & \hyperlink{dm9000__driver_8h_a044cbce2084965d8d53ca773cc9c2fc8}{ISR\_PR})
343    \{
344       \textcolor{comment}{//Clear interrupt flag}
345       \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_ad8a10a580a818297f25da4560a7c1868}{DM9000\_REG\_ISR}, ISR\_PR);
346 
347       \textcolor{comment}{//Process all pending packets}
348       \textcolor{keywordflow}{do}
349       \{
350          \textcolor{comment}{//Read incoming packet}
351          error = \hyperlink{dm9000__driver_8c_a09d01c85eb9e06ec0976c9bc7582abda}{dm9000ReceivePacket}(interface);
352 
353          \textcolor{comment}{//No more data in the receive buffer?}
354       \} \textcolor{keywordflow}{while}(error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca838a7a87abb42b87d6862e98849fab2d}{ERROR\_BUFFER\_EMPTY});
355    \}
356 
357    \textcolor{comment}{//Re-enable LNKCHGI and PRI interrupts}
358    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a83d8b8372a88bd3a7faa9b985969c098}{DM9000\_REG\_IMR}, \hyperlink{dm9000__driver_8h_af01850ca39a209653de4d3c94332b6df}{IMR\_PAR} | 
      \hyperlink{dm9000__driver_8h_a021719c16181205283bf84b000f53daf}{IMR\_LNKCHGI} | \hyperlink{dm9000__driver_8h_a5737b05b9cf41c8255283ca93b36d1e6}{IMR\_PTI} | \hyperlink{dm9000__driver_8h_a7e829a31e91218385b50e9f512a44304}{IMR\_PRI});
359 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_afce6a3ba759e89c7f9c70378d16a0128}\label{dm9000__driver_8c_afce6a3ba759e89c7f9c70378d16a0128}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Init@{dm9000\+Init}}
\index{dm9000\+Init@{dm9000\+Init}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Init()}{dm9000Init()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dm9000\+Init (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



D\+M9000 controller initialization. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 72 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
73 \{
74    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
75    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} vendorId;
76    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} productId;
77    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} chipRevision;
78    \hyperlink{structDm9000Context}{Dm9000Context} *context;
79 
80    \textcolor{comment}{//Debug message}
81    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Initializing DM9000 Ethernet controller...\(\backslash\)r\(\backslash\)n"});
82 
83    \textcolor{comment}{//Initialize external interrupt line}
84    interface->extIntDriver->init();
85 
86    \textcolor{comment}{//Point to the driver context}
87    context = (\hyperlink{structDm9000Context}{Dm9000Context} *) interface->nicContext;
88 
89    \textcolor{comment}{//Initialize driver specific variables}
90    context->\hyperlink{structDm9000Context_a332bc804390a37a5f2447d9e76c600c8}{queuedPackets} = 0;
91 
92    \textcolor{comment}{//Allocate TX and RX buffers}
93    context->\hyperlink{structDm9000Context_a72e4ef12dece5a9596fbadb0bcc22418}{txBuffer} = \hyperlink{net__mem_8c_abe64a91cd872768817509cc08eed6689}{memPoolAlloc}(\hyperlink{ethernet_8h_aa40569f19ea64ddc1cf273d095e517f4}{ETH\_MAX\_FRAME\_SIZE});
94    context->\hyperlink{structDm9000Context_accdec387715282c04559710494cd0066}{rxBuffer} = \hyperlink{net__mem_8c_abe64a91cd872768817509cc08eed6689}{memPoolAlloc}(\hyperlink{ethernet_8h_aa40569f19ea64ddc1cf273d095e517f4}{ETH\_MAX\_FRAME\_SIZE});
95 
96    \textcolor{comment}{//Failed to allocate memory?}
97    \textcolor{keywordflow}{if}(context->\hyperlink{structDm9000Context_a72e4ef12dece5a9596fbadb0bcc22418}{txBuffer} == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || context->\hyperlink{structDm9000Context_accdec387715282c04559710494cd0066}{rxBuffer} == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
98    \{
99       \textcolor{comment}{//Clean up side effects}
100       \hyperlink{net__mem_8c_a5e8a514f3dfcb35008de9beb39bcdcde}{memPoolFree}(context->\hyperlink{structDm9000Context_a72e4ef12dece5a9596fbadb0bcc22418}{txBuffer});
101       \hyperlink{net__mem_8c_a5e8a514f3dfcb35008de9beb39bcdcde}{memPoolFree}(context->\hyperlink{structDm9000Context_accdec387715282c04559710494cd0066}{rxBuffer});
102 
103       \textcolor{comment}{//Report an error}
104       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
105    \}
106 
107    \textcolor{comment}{//Retrieve vendorID, product ID and chip revision}
108    vendorId = (\hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_aa60e1e40eb7a7a4ce11cba775874be94}{DM9000\_REG\_VIDH}) << 8) | 
      \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_ad6ff092a0803ac81849db78f5ef55923}{DM9000\_REG\_VIDL});
109    productId = (\hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_ae8ef50547e64d22b3781e60182307012}{DM9000\_REG\_PIDH}) << 8) | 
      \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a1fc7a6bff115a1a2b1b2564a3e7271c7}{DM9000\_REG\_PIDL});
110    chipRevision = \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a2074b06bc99c9526d725b6188ea45a1f}{DM9000\_REG\_CHIPR});
111 
112    \textcolor{comment}{//Check vendor ID and product ID}
113    \textcolor{keywordflow}{if}(vendorId != \hyperlink{dm9000__driver_8h_a8029b84d3a41f8f47c90468604f5e1b5}{DM9000\_VID} || productId != \hyperlink{dm9000__driver_8h_aa97ec7f525f4be24548bf120919cc613}{DM9000\_PID})
114       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca2bc2298123e24e3d82592b5c68c20612}{ERROR\_WRONG\_IDENTIFIER};
115    \textcolor{comment}{//Check chip revision}
116    \textcolor{keywordflow}{if}(chipRevision != \hyperlink{dm9000__driver_8h_a6c036f90fda4ab85df5c0f61140f5b2d}{DM9000A\_CHIP\_REV} && chipRevision != 
      \hyperlink{dm9000__driver_8h_ac69341e16658ba1e894d7afbce929faa}{DM9000B\_CHIP\_REV})
117       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca2bc2298123e24e3d82592b5c68c20612}{ERROR\_WRONG\_IDENTIFIER};
118 
119    \textcolor{comment}{//Power up the internal PHY by clearing PHYPD}
120    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_abf41afa911db7ce18bb7c53c4755003f}{DM9000\_REG\_GPR}, 0x00);
121    \textcolor{comment}{//Wait for the PHY to be ready}
122    \hyperlink{os__port_8h_af36a7a9c1ad704d0da2e660dab735b2a}{sleep}(10);
123 
124    \textcolor{comment}{//Software reset}
125    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a9489998669f34d690bb612f3761c7d56}{DM9000\_REG\_NCR}, \hyperlink{dm9000__driver_8h_aef78bffa63b23cf6fc6948d238ab4528}{NCR\_RST});
126    \textcolor{comment}{//Wait for the reset to complete}
127    \textcolor{keywordflow}{while}(\hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a9489998669f34d690bb612f3761c7d56}{DM9000\_REG\_NCR}) & \hyperlink{dm9000__driver_8h_aef78bffa63b23cf6fc6948d238ab4528}{NCR\_RST});
128 
129    \textcolor{comment}{//PHY software reset}
130    \hyperlink{dm9000__driver_8c_aa6d8e85625e330a579bdc3c8169a69f5}{dm9000WritePhyReg}(\hyperlink{dm9000__driver_8h_a167c99b72d2a8de6ae9d94f151b111fe}{DM9000\_PHY\_REG\_BMCR}, 
      \hyperlink{dm9000__driver_8h_a1b0099a72f2e69390ef4a53526b9a0f8}{BMCR\_RST});
131    \textcolor{comment}{//Wait for the PHY reset to complete}
132    \textcolor{keywordflow}{while}(\hyperlink{dm9000__driver_8c_a4105b062c5337a2cd252acb687dd0ac4}{dm9000ReadPhyReg}(\hyperlink{dm9000__driver_8h_a167c99b72d2a8de6ae9d94f151b111fe}{DM9000\_PHY\_REG\_BMCR}) & 
      \hyperlink{dm9000__driver_8h_a1b0099a72f2e69390ef4a53526b9a0f8}{BMCR\_RST});
133 
134    \textcolor{comment}{//Debug message}
135    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"  VID = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, vendorId);
136    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"  PID = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, productId);
137    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"  CHIPR = 0x%02"} PRIX8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, chipRevision);
138    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"  PHYIDR1 = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{dm9000__driver_8c_a4105b062c5337a2cd252acb687dd0ac4}{dm9000ReadPhyReg}(
      \hyperlink{dm9000__driver_8h_a885525704b145eeced52bd9b1f5b899b}{DM9000\_PHY\_REG\_PHYIDR1}));
139    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"  PHYIDR2 = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{dm9000__driver_8c_a4105b062c5337a2cd252acb687dd0ac4}{dm9000ReadPhyReg}(
      \hyperlink{dm9000__driver_8h_abdbf226f37c5c5e3a941fd384156aa34}{DM9000\_PHY\_REG\_PHYIDR2}));
140 
141    \textcolor{comment}{//Enable loopback mode?}
142 \textcolor{preprocessor}{#if (DM9000\_LOOPBACK\_MODE == ENABLED)}
143    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a9489998669f34d690bb612f3761c7d56}{DM9000\_REG\_NCR}, \hyperlink{dm9000__driver_8h_a15be245605a81a87f4dcd97027d5eec7}{DM9000\_LBK\_PHY});
144    \hyperlink{dm9000__driver_8c_aa6d8e85625e330a579bdc3c8169a69f5}{dm9000WritePhyReg}(\hyperlink{dm9000__driver_8h_a167c99b72d2a8de6ae9d94f151b111fe}{DM9000\_PHY\_REG\_BMCR}, 
      \hyperlink{dm9000__driver_8h_ac88fc4d24c8ce1ea42f335a14671cb8c}{BMCR\_LOOPBACK} | \hyperlink{dm9000__driver_8h_ac9d7d8a2283a24870fdb2b38b0d31d3a}{BMCR\_SPEED\_SEL} | \hyperlink{dm9000__driver_8h_a98e2ea4497e7eb5f1ad49db14b281d16}{BMCR\_AN\_EN} | 
      \hyperlink{dm9000__driver_8h_af1aae79e4f88fdc981ff9d6e518f65ff}{BMCR\_DUPLEX\_MODE});
145 \textcolor{preprocessor}{#endif}
146 
147    \textcolor{comment}{//Set host MAC address}
148    \textcolor{keywordflow}{for}(i = 0; i < 6; i++)
149       \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a058c835f0140db15483ef3e5ecaeec12}{DM9000\_REG\_PAR0} + i, interface->macAddr.b[i]);
150 
151    \textcolor{comment}{//Initialize hash table}
152    \textcolor{keywordflow}{for}(i = 0; i < 8; i++)
153       \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a90e652119cd4e933ec9055934b955612}{DM9000\_REG\_MAR0} + i, 0x00);
154 
155    \textcolor{comment}{//Always accept broadcast packets}
156    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a5a05fcce2fa9bf5d022309e68718d4eb}{DM9000\_REG\_MAR7}, 0x80);
157 
158    \textcolor{comment}{//Enable the Pointer Auto Return function}
159    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a83d8b8372a88bd3a7faa9b985969c098}{DM9000\_REG\_IMR}, \hyperlink{dm9000__driver_8h_af01850ca39a209653de4d3c94332b6df}{IMR\_PAR});
160    \textcolor{comment}{//Clear NSR status bits}
161    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a84cc8295050248ca7d6a42fa3083df87}{DM9000\_REG\_NSR}, \hyperlink{dm9000__driver_8h_aea120c151009f4cce043f02108e55f81}{NSR\_WAKEST} | 
      \hyperlink{dm9000__driver_8h_a943d2645bc6826d45487b7e85222ec1c}{NSR\_TX2END} | \hyperlink{dm9000__driver_8h_a156bc2a830a5378edf2a63f216accb8e}{NSR\_TX1END});
162    \textcolor{comment}{//Clear interrupt flags}
163    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_ad8a10a580a818297f25da4560a7c1868}{DM9000\_REG\_ISR}, \hyperlink{dm9000__driver_8h_a1c358f988bb938c4a47b77e874f75e86}{ISR\_LNKCHG} | 
      \hyperlink{dm9000__driver_8h_a7252d08bc86b9274b99cfecb496f28c5}{ISR\_UDRUN} | \hyperlink{dm9000__driver_8h_a70394f25e1bffded9353c234c7b22378}{ISR\_ROO} | \hyperlink{dm9000__driver_8h_a4297ae8631e477136a2eaebaa85cb0f9}{ISR\_ROS} | \hyperlink{dm9000__driver_8h_a67f3d8ecb6a155590f70758b07d622f0}{ISR\_PT} | \hyperlink{dm9000__driver_8h_a044cbce2084965d8d53ca773cc9c2fc8}{ISR\_PR});
164    \textcolor{comment}{//Enable interrupts}
165    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a83d8b8372a88bd3a7faa9b985969c098}{DM9000\_REG\_IMR}, \hyperlink{dm9000__driver_8h_af01850ca39a209653de4d3c94332b6df}{IMR\_PAR} | 
      \hyperlink{dm9000__driver_8h_a021719c16181205283bf84b000f53daf}{IMR\_LNKCHGI} | \hyperlink{dm9000__driver_8h_a5737b05b9cf41c8255283ca93b36d1e6}{IMR\_PTI} | \hyperlink{dm9000__driver_8h_a7e829a31e91218385b50e9f512a44304}{IMR\_PRI});
166    \textcolor{comment}{//Enable the receiver by setting RXEN}
167    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_add06cad05368db929be4f47312a08f98}{DM9000\_REG\_RCR}, \hyperlink{dm9000__driver_8h_a89bed46999680d9731b06c6c152ad835}{RCR\_DIS\_LONG} | 
      \hyperlink{dm9000__driver_8h_a0225fc7f93bc57b91f9e5b0880c41531}{RCR\_DIS\_CRC} | \hyperlink{dm9000__driver_8h_abee844d20800e872c0dfa9711f862584}{RCR\_RXEN});
168 
169    \textcolor{comment}{//Accept any packets from the upper layer}
170    \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&interface->nicTxEvent);
171 
172    \textcolor{comment}{//Force the TCP/IP stack to poll the link state at startup}
173    interface->nicEvent = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
174    \textcolor{comment}{//Notify the TCP/IP stack of the event}
175    \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&\hyperlink{net_8c_a4ad5a175123589d00e402e0c1c842fdc}{netEvent});
176 
177    \textcolor{comment}{//Successful initialization}
178    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
179 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_ad3c1a4851356a2859b94e9ee7789d84e}\label{dm9000__driver_8c_ad3c1a4851356a2859b94e9ee7789d84e}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Irq\+Handler@{dm9000\+Irq\+Handler}}
\index{dm9000\+Irq\+Handler@{dm9000\+Irq\+Handler}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Irq\+Handler()}{dm9000IrqHandler()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} dm9000\+Irq\+Handler (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



D\+M9000 interrupt service routine. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
T\+R\+UE if a higher priority task must be woken. Else F\+A\+L\+SE is returned 
\end{DoxyReturn}


Definition at line 222 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
223 \{
224    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} flag;
225    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} status;
226    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{web__socket_8h_a8a74907784be6c7786c2d060c8d7e10b}{mask};
227    \hyperlink{structDm9000Context}{Dm9000Context} *context;
228 
229    \textcolor{comment}{//This flag will be set if a higher priority task must be woken}
230    flag = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
231 
232    \textcolor{comment}{//Point to the driver context}
233    context = (\hyperlink{structDm9000Context}{Dm9000Context} *) interface->nicContext;
234 
235    \textcolor{comment}{//Read interrupt status register}
236    status = \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_ad8a10a580a818297f25da4560a7c1868}{DM9000\_REG\_ISR});
237 
238    \textcolor{comment}{//Link status change?}
239    \textcolor{keywordflow}{if}(status & \hyperlink{dm9000__driver_8h_a1c358f988bb938c4a47b77e874f75e86}{ISR\_LNKCHG})
240    \{
241       \textcolor{comment}{//Read interrupt mask register}
242       mask = \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a83d8b8372a88bd3a7faa9b985969c098}{DM9000\_REG\_IMR});
243       \textcolor{comment}{//Disable LNKCHGI interrupt}
244       \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a83d8b8372a88bd3a7faa9b985969c098}{DM9000\_REG\_IMR}, mask & ~
      \hyperlink{dm9000__driver_8h_a021719c16181205283bf84b000f53daf}{IMR\_LNKCHGI});
245 
246       \textcolor{comment}{//Set event flag}
247       interface->nicEvent = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
248       \textcolor{comment}{//Notify the TCP/IP stack of the event}
249       flag |= \hyperlink{os__port__chibios_8c_aa30d505571a03dd645af374f40bd7016}{osSetEventFromIsr}(&\hyperlink{net_8c_a4ad5a175123589d00e402e0c1c842fdc}{netEvent});
250    \}
251 
252    \textcolor{comment}{//Packet transmission complete?}
253    \textcolor{keywordflow}{if}(status & \hyperlink{dm9000__driver_8h_a67f3d8ecb6a155590f70758b07d622f0}{ISR\_PT})
254    \{
255       \textcolor{comment}{//Check TX complete status bits}
256       \textcolor{keywordflow}{if}(\hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a84cc8295050248ca7d6a42fa3083df87}{DM9000\_REG\_NSR}) & (\hyperlink{dm9000__driver_8h_a943d2645bc6826d45487b7e85222ec1c}{NSR\_TX2END} | 
      \hyperlink{dm9000__driver_8h_a156bc2a830a5378edf2a63f216accb8e}{NSR\_TX1END}))
257       \{
258          \textcolor{comment}{//The transmission of the current packet is complete}
259          \textcolor{keywordflow}{if}(context->\hyperlink{structDm9000Context_a332bc804390a37a5f2447d9e76c600c8}{queuedPackets} > 0)
260             context->\hyperlink{structDm9000Context_a332bc804390a37a5f2447d9e76c600c8}{queuedPackets}--;
261 
262          \textcolor{comment}{//Notify the TCP/IP stack that the transmitter is ready to send}
263          flag |= \hyperlink{os__port__chibios_8c_aa30d505571a03dd645af374f40bd7016}{osSetEventFromIsr}(&interface->nicTxEvent);
264       \}
265 
266       \textcolor{comment}{//Clear interrupt flag}
267       \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_ad8a10a580a818297f25da4560a7c1868}{DM9000\_REG\_ISR}, ISR\_PT);
268    \}
269 
270    \textcolor{comment}{//Packet received?}
271    \textcolor{keywordflow}{if}(status & \hyperlink{dm9000__driver_8h_a044cbce2084965d8d53ca773cc9c2fc8}{ISR\_PR})
272    \{
273       \textcolor{comment}{//Read interrupt mask register}
274       mask = \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a83d8b8372a88bd3a7faa9b985969c098}{DM9000\_REG\_IMR});
275       \textcolor{comment}{//Disable PRI interrupt}
276       \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a83d8b8372a88bd3a7faa9b985969c098}{DM9000\_REG\_IMR}, mask & ~\hyperlink{dm9000__driver_8h_a7e829a31e91218385b50e9f512a44304}{IMR\_PRI});
277 
278       \textcolor{comment}{//Set event flag}
279       interface->nicEvent = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
280       \textcolor{comment}{//Notify the TCP/IP stack of the event}
281       flag |= \hyperlink{os__port__chibios_8c_aa30d505571a03dd645af374f40bd7016}{osSetEventFromIsr}(&\hyperlink{net_8c_a4ad5a175123589d00e402e0c1c842fdc}{netEvent});
282    \}
283 
284    \textcolor{comment}{//A higher priority task must be woken?}
285    \textcolor{keywordflow}{return} flag;
286 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_a4105b062c5337a2cd252acb687dd0ac4}\label{dm9000__driver_8c_a4105b062c5337a2cd252acb687dd0ac4}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Read\+Phy\+Reg@{dm9000\+Read\+Phy\+Reg}}
\index{dm9000\+Read\+Phy\+Reg@{dm9000\+Read\+Phy\+Reg}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Read\+Phy\+Reg()}{dm9000ReadPhyReg()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} dm9000\+Read\+Phy\+Reg (\begin{DoxyParamCaption}\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{address }\end{DoxyParamCaption})}



Read D\+M9000 P\+HY register. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em address} & P\+HY register address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Register value 
\end{DoxyReturn}


Definition at line 645 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
646 \{
647    \textcolor{comment}{//Write PHY register address}
648    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a90dd602a94eddac171cac0e7dc6af677}{DM9000\_REG\_EPAR}, 0x40 | \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address});
649 
650    \textcolor{comment}{//Start the read operation}
651    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a35013de6383de65e2f315e081936ae89}{DM9000\_REG\_EPCR}, \hyperlink{dm9000__driver_8h_aa7f26efb83d68e99a509d9572d35b345}{EPCR\_EPOS} | 
      \hyperlink{dm9000__driver_8h_a0eb508434152baebce3a4e73b9c8cb60}{EPCR\_ERPRR});
652    \textcolor{comment}{//PHY access is still in progress?}
653    \textcolor{keywordflow}{while}(\hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a35013de6383de65e2f315e081936ae89}{DM9000\_REG\_EPCR}) & \hyperlink{dm9000__driver_8h_ac4f2bc718b05879cecb6c63ed0da724c}{EPCR\_ERRE});
654 
655    \textcolor{comment}{//Clear command register}
656    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a35013de6383de65e2f315e081936ae89}{DM9000\_REG\_EPCR}, \hyperlink{dm9000__driver_8h_aa7f26efb83d68e99a509d9572d35b345}{EPCR\_EPOS});
657    \textcolor{comment}{//Wait 5us minimum}
658    \hyperlink{os__port_8h_ad6cd1305d1073d4c3072f114828f8998}{usleep}(5);
659 
660    \textcolor{comment}{//Return register value}
661    \textcolor{keywordflow}{return} (\hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_ab003d94a9231bdd30efc863ec29b075f}{DM9000\_REG\_EPDRH}) << 8) | 
      \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_afcf9179b25e59bdbe6cc4d1f24af8ec4}{DM9000\_REG\_EPDRL});
662 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}\label{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Read\+Reg@{dm9000\+Read\+Reg}}
\index{dm9000\+Read\+Reg@{dm9000\+Read\+Reg}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Read\+Reg()}{dm9000ReadReg()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} dm9000\+Read\+Reg (\begin{DoxyParamCaption}\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{address }\end{DoxyParamCaption})}



Read D\+M9000 register. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em address} & Register address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Register value 
\end{DoxyReturn}


Definition at line 604 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
605 \{
606    \textcolor{comment}{//Write register address to INDEX register}
607    \hyperlink{dm9000__driver_8h_a3bd0e4c9841ef00bd557bfb93d076dc9}{DM9000\_INDEX\_REG} = \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
608    \textcolor{comment}{//Read register value from DATA register}
609    \textcolor{keywordflow}{return} \hyperlink{dm9000__driver_8h_a481b92238bdbfdd94d79bc6326de6a09}{DM9000\_DATA\_REG};
610 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_a09d01c85eb9e06ec0976c9bc7582abda}\label{dm9000__driver_8c_a09d01c85eb9e06ec0976c9bc7582abda}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Receive\+Packet@{dm9000\+Receive\+Packet}}
\index{dm9000\+Receive\+Packet@{dm9000\+Receive\+Packet}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Receive\+Packet()}{dm9000ReceivePacket()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dm9000\+Receive\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Receive a packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 435 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
436 \{
437    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
438    \textcolor{keywordtype}{size\_t} i;
439    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
440    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
441    \textcolor{keyword}{volatile} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} status;
442    \textcolor{keyword}{volatile} \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
443    \hyperlink{structDm9000Context}{Dm9000Context} *context;
444 
445    \textcolor{comment}{//Point to the driver context}
446    context = (\hyperlink{structDm9000Context}{Dm9000Context} *) interface->nicContext;
447 
448    \textcolor{comment}{//A dummy read is required before accessing the 4-byte header}
449    data = \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_aeb09ee252163ed5d8d91fbb7f1bbf7a0}{DM9000\_REG\_MRCMDX});
450 
451    \textcolor{comment}{//Select MRCMDX1 register}
452    \hyperlink{dm9000__driver_8h_a3bd0e4c9841ef00bd557bfb93d076dc9}{DM9000\_INDEX\_REG} = \hyperlink{dm9000__driver_8h_af36f8212c60fc3c3cf68dd1a9b7ad425}{DM9000\_REG\_MRCMDX1};
453    \textcolor{comment}{//Read the first byte of the header}
454    status = \hyperlink{os__port_8h_a34a3aa6cbadec6a80ab1eae8efd0083d}{LSB}(\hyperlink{dm9000__driver_8h_a481b92238bdbfdd94d79bc6326de6a09}{DM9000\_DATA\_REG});
455 
456    \textcolor{comment}{//The first byte indicates if a packet has been received}
457    \textcolor{keywordflow}{if}(status == 0x01)
458    \{
459       \textcolor{comment}{//Select MRCMD register}
460       \hyperlink{dm9000__driver_8h_a3bd0e4c9841ef00bd557bfb93d076dc9}{DM9000\_INDEX\_REG} = \hyperlink{dm9000__driver_8h_a880fece8ffdc6a2891aee6e01be70633}{DM9000\_REG\_MRCMD};
461       \textcolor{comment}{//The second byte is the RX status byte}
462       status = \hyperlink{os__port_8h_aeb61a4e8fff2f4624a632a3189cbd3a0}{MSB}(\hyperlink{dm9000__driver_8h_a481b92238bdbfdd94d79bc6326de6a09}{DM9000\_DATA\_REG});
463 
464       \textcolor{comment}{//Retrieve packet length}
465       length = \hyperlink{dm9000__driver_8h_a481b92238bdbfdd94d79bc6326de6a09}{DM9000\_DATA\_REG};
466       \textcolor{comment}{//Limit the number of data to read}
467       n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(length, \hyperlink{ethernet_8h_aa40569f19ea64ddc1cf273d095e517f4}{ETH\_MAX\_FRAME\_SIZE});
468 
469       \textcolor{comment}{//Point to the beginning of the buffer}
470       i = 0;
471 
472       \textcolor{comment}{//Make sure no error occurred}
473       \textcolor{keywordflow}{if}(!(status & (\hyperlink{dm9000__driver_8h_aeebf6511bfe6c30e870f3974cff2a825}{RSR\_LCS} | \hyperlink{dm9000__driver_8h_a10f1d294ad83627b5634b4b14957f592}{RSR\_RWTO} | \hyperlink{dm9000__driver_8h_aa9696a44821192a3a0efc5966fc67a19}{RSR\_PLE} | \hyperlink{dm9000__driver_8h_a65fce6e28b89e7fc92decd27337c4593}{RSR\_AE} | 
      \hyperlink{dm9000__driver_8h_af98b9849eef9af5784cd83d92acb5872}{RSR\_CE} | \hyperlink{dm9000__driver_8h_a8922c9a9fd8194a483d0342a189148b3}{RSR\_FOE})))
474       \{
475          \textcolor{comment}{//Read data from FIFO using 16-bit mode}
476          \textcolor{keywordflow}{while}((i + 1) < n)
477          \{
478             data = \hyperlink{dm9000__driver_8h_a481b92238bdbfdd94d79bc6326de6a09}{DM9000\_DATA\_REG};
479             context->\hyperlink{structDm9000Context_accdec387715282c04559710494cd0066}{rxBuffer}[i++] = \hyperlink{os__port_8h_a34a3aa6cbadec6a80ab1eae8efd0083d}{LSB}(data);
480             context->\hyperlink{structDm9000Context_accdec387715282c04559710494cd0066}{rxBuffer}[i++] = \hyperlink{os__port_8h_aeb61a4e8fff2f4624a632a3189cbd3a0}{MSB}(data);
481          \}
482 
483          \textcolor{comment}{//Odd number of bytes to read?}
484          \textcolor{keywordflow}{if}((i + 1) == n)
485          \{
486             data = \hyperlink{dm9000__driver_8h_a481b92238bdbfdd94d79bc6326de6a09}{DM9000\_DATA\_REG};
487             context->\hyperlink{structDm9000Context_accdec387715282c04559710494cd0066}{rxBuffer}[i] = \hyperlink{os__port_8h_a34a3aa6cbadec6a80ab1eae8efd0083d}{LSB}(data);
488             i += 2;
489          \}
490 
491          \textcolor{comment}{//Valid packet received}
492          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
493       \}
494       \textcolor{keywordflow}{else}
495       \{
496          \textcolor{comment}{//The received packet contains an error}
497          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caccf6070ae61f26a48b523757a3168ad2}{ERROR\_INVALID\_PACKET};
498       \}
499 
500       \textcolor{comment}{//Flush remaining bytes}
501       \textcolor{keywordflow}{while}(i < length)
502       \{
503          data = \hyperlink{dm9000__driver_8h_a481b92238bdbfdd94d79bc6326de6a09}{DM9000\_DATA\_REG};
504          i += 2;
505       \}
506    \}
507    \textcolor{keywordflow}{else}
508    \{
509       \textcolor{comment}{//No more data in the receive buffer}
510       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca838a7a87abb42b87d6862e98849fab2d}{ERROR\_BUFFER\_EMPTY};
511    \}
512 
513    \textcolor{comment}{//Check whether a valid packet has been received}
514    \textcolor{keywordflow}{if}(!error)
515    \{
516       \textcolor{comment}{//Pass the packet to the upper layer}
517       \hyperlink{nic_8c_a5e5ef3b84649c36ebfe1e70edb1a0f75}{nicProcessPacket}(interface, context->\hyperlink{structDm9000Context_accdec387715282c04559710494cd0066}{rxBuffer}, n);
518    \}
519 
520    \textcolor{comment}{//Return status code}
521    \textcolor{keywordflow}{return} error;
522 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_a34d0f7bedd37d3428ea20a4cd85dda8c}\label{dm9000__driver_8c_a34d0f7bedd37d3428ea20a4cd85dda8c}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Send\+Packet@{dm9000\+Send\+Packet}}
\index{dm9000\+Send\+Packet@{dm9000\+Send\+Packet}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Send\+Packet()}{dm9000SendPacket()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dm9000\+Send\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset }\end{DoxyParamCaption})}



Send a packet to D\+M9000. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the data to send \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first data byte \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 370 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
372 \{
373    \textcolor{keywordtype}{size\_t} i;
374    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
375    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
376    \hyperlink{structDm9000Context}{Dm9000Context} *context;
377 
378    \textcolor{comment}{//Point to the driver context}
379    context = (\hyperlink{structDm9000Context}{Dm9000Context} *) interface->nicContext;
380 
381    \textcolor{comment}{//Retrieve the length of the packet}
382    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
383 
384    \textcolor{comment}{//Check the frame length}
385    \textcolor{keywordflow}{if}(length > \hyperlink{ethernet_8h_aa40569f19ea64ddc1cf273d095e517f4}{ETH\_MAX\_FRAME\_SIZE})
386    \{
387       \textcolor{comment}{//The transmitter can accept another packet}
388       \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&interface->nicTxEvent);
389       \textcolor{comment}{//Report an error}
390       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
391    \}
392 
393    \textcolor{comment}{//Copy user data}
394    \hyperlink{net__mem_8c_af3ed1bc3f7d55f830cbbe6aa12e61af0}{netBufferRead}(context->\hyperlink{structDm9000Context_a72e4ef12dece5a9596fbadb0bcc22418}{txBuffer}, buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset}, length);
395 
396    \textcolor{comment}{//A dummy write is required before accessing FIFO}
397    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a708d601d5e19498a3872fbb8d93fba84}{DM9000\_REG\_MWCMDX}, 0);
398    \textcolor{comment}{//Select MWCMD register}
399    \hyperlink{dm9000__driver_8h_a3bd0e4c9841ef00bd557bfb93d076dc9}{DM9000\_INDEX\_REG} = \hyperlink{dm9000__driver_8h_a9eb735b13c283ab2e2bd3ee21d84cd89}{DM9000\_REG\_MWCMD};
400 
401    \textcolor{comment}{//Point to the beginning of the buffer}
402    p = (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} *) context->\hyperlink{structDm9000Context_a72e4ef12dece5a9596fbadb0bcc22418}{txBuffer};
403 
404    \textcolor{comment}{//Write data to the FIFO using 16-bit mode}
405    \textcolor{keywordflow}{for}(i = length; i > 1; i -= 2)
406       \hyperlink{dm9000__driver_8h_a481b92238bdbfdd94d79bc6326de6a09}{DM9000\_DATA\_REG} = *(p++);
407 
408    \textcolor{comment}{//Odd number of bytes?}
409    \textcolor{keywordflow}{if}(i > 0)
410       \hyperlink{dm9000__driver_8h_a481b92238bdbfdd94d79bc6326de6a09}{DM9000\_DATA\_REG} = *((\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) p);
411 
412    \textcolor{comment}{//Write the number of bytes to send}
413    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a99148e7cefbfccc1364999c3d6f40318}{DM9000\_REG\_TXPLL}, \hyperlink{os__port_8h_a34a3aa6cbadec6a80ab1eae8efd0083d}{LSB}(length));
414    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a48748fad73ca0cf51815326d1ac17e4c}{DM9000\_REG\_TXPLH}, \hyperlink{os__port_8h_aeb61a4e8fff2f4624a632a3189cbd3a0}{MSB}(length));
415 
416    \textcolor{comment}{//Clear interrupt flag}
417    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_ad8a10a580a818297f25da4560a7c1868}{DM9000\_REG\_ISR}, \hyperlink{dm9000__driver_8h_a67f3d8ecb6a155590f70758b07d622f0}{ISR\_PT});
418    \textcolor{comment}{//Start data transfer}
419    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a0789b99b9e7c1104637a20dade499c49}{DM9000\_REG\_TCR}, \hyperlink{dm9000__driver_8h_a54fd57551469d32648445ac2b4f42cb6}{TCR\_TXREQ});
420 
421    \textcolor{comment}{//The packet was successfully written to FIFO}
422    context->\hyperlink{structDm9000Context_a332bc804390a37a5f2447d9e76c600c8}{queuedPackets}++;
423 
424    \textcolor{comment}{//Successful processing}
425    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
426 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_ac567a1237da77c173ac1e7315340934f}\label{dm9000__driver_8c_ac567a1237da77c173ac1e7315340934f}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Tick@{dm9000\+Tick}}
\index{dm9000\+Tick@{dm9000\+Tick}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Tick()}{dm9000Tick()}}
{\footnotesize\ttfamily void dm9000\+Tick (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



D\+M9000 timer handler. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 187 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
188 \{
189 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_ab2a9d5e4db72c0c80a0f0755ece356a3}\label{dm9000__driver_8c_ab2a9d5e4db72c0c80a0f0755ece356a3}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Update\+Mac\+Addr\+Filter@{dm9000\+Update\+Mac\+Addr\+Filter}}
\index{dm9000\+Update\+Mac\+Addr\+Filter@{dm9000\+Update\+Mac\+Addr\+Filter}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Update\+Mac\+Addr\+Filter()}{dm9000UpdateMacAddrFilter()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dm9000\+Update\+Mac\+Addr\+Filter (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Configure M\+AC address filtering. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 531 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
532 \{
533    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
534    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{md5_8c_af11ea3cdbca7345eb6a4a8ac5ce0434d}{k};
535    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} crc;
536    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} hashTable[8];
537    \hyperlink{structMacFilterEntry}{MacFilterEntry} *entry;
538 
539    \textcolor{comment}{//Debug message}
540    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Updating MAC filter...\(\backslash\)r\(\backslash\)n"});
541 
542    \textcolor{comment}{//Clear hash table}
543    memset(hashTable, 0, \textcolor{keyword}{sizeof}(hashTable));
544    \textcolor{comment}{//Always accept broadcast packets regardless of the MAC filter table}
545    hashTable[7] = 0x80;
546 
547    \textcolor{comment}{//The MAC address filter contains the list of MAC addresses to accept}
548    \textcolor{comment}{//when receiving an Ethernet frame}
549    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{ethernet_8h_ab64acae68b5723774fa272c62efd7c2b}{MAC\_ADDR\_FILTER\_SIZE}; i++)
550    \{
551       \textcolor{comment}{//Point to the current entry}
552       entry = &interface->macAddrFilter[i];
553 
554       \textcolor{comment}{//Valid entry?}
555       \textcolor{keywordflow}{if}(entry->\hyperlink{structMacFilterEntry_a4a1195d4086f58ef57862fa43551e73a}{refCount} > 0)
556       \{
557          \textcolor{comment}{//Compute CRC over the current MAC address}
558          crc = \hyperlink{dm9000__driver_8c_ac71e6d89c21e8baa7beb0d007bdcf707}{dm9000CalcCrc}(&entry->\hyperlink{structMacFilterEntry_a30caa211d6cc1bb2416165526a2ab6cb}{addr}, \textcolor{keyword}{sizeof}(\hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{MacAddr}));
559          \textcolor{comment}{//Calculate the corresponding index in the table}
560          k = crc & 0x3F;
561          \textcolor{comment}{//Update hash table contents}
562          hashTable[k / 8] |= (1 << (k % 8));
563       \}
564    \}
565 
566    \textcolor{comment}{//Write the hash table to the DM9000 controller}
567    \textcolor{keywordflow}{for}(i = 0; i < 8; i++)
568       \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a90e652119cd4e933ec9055934b955612}{DM9000\_REG\_MAR0} + i, hashTable[i]);
569 
570    \textcolor{comment}{//Debug message}
571    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  MAR = %02"} PRIX8 \textcolor{stringliteral}{" %02"} PRIX8 \textcolor{stringliteral}{" %02"} PRIX8 \textcolor{stringliteral}{" %02"} PRIX8 \textcolor{stringliteral}{" "}
572       \textcolor{stringliteral}{"%02"} PRIX8 \textcolor{stringliteral}{" %02"} PRIX8 \textcolor{stringliteral}{" %02"} PRIX8 \textcolor{stringliteral}{" %02"} PRIX8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"},
573       \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a90e652119cd4e933ec9055934b955612}{DM9000\_REG\_MAR0}), \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(
      \hyperlink{dm9000__driver_8h_a60a75db5e61e1aa19fcd6fc07fb9097a}{DM9000\_REG\_MAR1}),
574       \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_aecbf3a6ceca4b9fd7d91e94282b6cea7}{DM9000\_REG\_MAR2}), \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(
      \hyperlink{dm9000__driver_8h_aa6e0060f30e1ea9dde07d9212abe73e2}{DM9000\_REG\_MAR3}),
575       \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a6016341968be4998dffcd8bda5922413}{DM9000\_REG\_MAR4}), \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(
      \hyperlink{dm9000__driver_8h_a46267b15afeca3433602717c98ac4e31}{DM9000\_REG\_MAR5}),
576       \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a04d617a74bdc56f7c019a10b3e8dd81a}{DM9000\_REG\_MAR6}), \hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(
      \hyperlink{dm9000__driver_8h_a5a05fcce2fa9bf5d022309e68718d4eb}{DM9000\_REG\_MAR7}));
577 
578    \textcolor{comment}{//Successful processing}
579    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
580 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_aa6d8e85625e330a579bdc3c8169a69f5}\label{dm9000__driver_8c_aa6d8e85625e330a579bdc3c8169a69f5}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Write\+Phy\+Reg@{dm9000\+Write\+Phy\+Reg}}
\index{dm9000\+Write\+Phy\+Reg@{dm9000\+Write\+Phy\+Reg}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Write\+Phy\+Reg()}{dm9000WritePhyReg()}}
{\footnotesize\ttfamily void dm9000\+Write\+Phy\+Reg (\begin{DoxyParamCaption}\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{address,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{data }\end{DoxyParamCaption})}



Write D\+M9000 P\+HY register. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em address} & P\+HY register address \\
\hline
\mbox{\tt in}  & {\em data} & Register value \\
\hline
\end{DoxyParams}


Definition at line 619 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
620 \{
621    \textcolor{comment}{//Write PHY register address}
622    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a90dd602a94eddac171cac0e7dc6af677}{DM9000\_REG\_EPAR}, 0x40 | \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address});
623    \textcolor{comment}{//Write register value}
624    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_afcf9179b25e59bdbe6cc4d1f24af8ec4}{DM9000\_REG\_EPDRL}, \hyperlink{os__port_8h_a34a3aa6cbadec6a80ab1eae8efd0083d}{LSB}(\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}));
625    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_ab003d94a9231bdd30efc863ec29b075f}{DM9000\_REG\_EPDRH}, \hyperlink{os__port_8h_aeb61a4e8fff2f4624a632a3189cbd3a0}{MSB}(\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}));
626 
627    \textcolor{comment}{//Start the write operation}
628    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a35013de6383de65e2f315e081936ae89}{DM9000\_REG\_EPCR}, \hyperlink{dm9000__driver_8h_aa7f26efb83d68e99a509d9572d35b345}{EPCR\_EPOS} | 
      \hyperlink{dm9000__driver_8h_a774b3c4b1b662da88003343e7b5e0f0e}{EPCR\_ERPRW});
629    \textcolor{comment}{//PHY access is still in progress?}
630    \textcolor{keywordflow}{while}(\hyperlink{dm9000__driver_8c_ad556ddf5b3200170d2790ad0dd18e97f}{dm9000ReadReg}(\hyperlink{dm9000__driver_8h_a35013de6383de65e2f315e081936ae89}{DM9000\_REG\_EPCR}) & \hyperlink{dm9000__driver_8h_ac4f2bc718b05879cecb6c63ed0da724c}{EPCR\_ERRE});
631 
632    \textcolor{comment}{//Wait 5us minimum}
633    \hyperlink{os__port_8h_ad6cd1305d1073d4c3072f114828f8998}{usleep}(5);
634    \textcolor{comment}{//Clear command register}
635    \hyperlink{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}{dm9000WriteReg}(\hyperlink{dm9000__driver_8h_a35013de6383de65e2f315e081936ae89}{DM9000\_REG\_EPCR}, \hyperlink{dm9000__driver_8h_aa7f26efb83d68e99a509d9572d35b345}{EPCR\_EPOS});
636 \}
\end{DoxyCode}
\mbox{\Hypertarget{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}\label{dm9000__driver_8c_a206e333eccd21b9381d6de39bd01a207}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Write\+Reg@{dm9000\+Write\+Reg}}
\index{dm9000\+Write\+Reg@{dm9000\+Write\+Reg}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Write\+Reg()}{dm9000WriteReg()}}
{\footnotesize\ttfamily void dm9000\+Write\+Reg (\begin{DoxyParamCaption}\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{address,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{data }\end{DoxyParamCaption})}



Write D\+M9000 register. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em address} & Register address \\
\hline
\mbox{\tt in}  & {\em data} & Register value \\
\hline
\end{DoxyParams}


Definition at line 589 of file dm9000\+\_\+driver.\+c.


\begin{DoxyCode}
590 \{
591    \textcolor{comment}{//Write register address to INDEX register}
592    \hyperlink{dm9000__driver_8h_a3bd0e4c9841ef00bd557bfb93d076dc9}{DM9000\_INDEX\_REG} = \hyperlink{dhcpv6__common_8h_aaee906fadd211e863c2e29a3690b25c4}{address};
593    \textcolor{comment}{//Write register value to DATA register}
594    \hyperlink{dm9000__driver_8h_a481b92238bdbfdd94d79bc6326de6a09}{DM9000\_DATA\_REG} = \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
595 \}
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{dm9000__driver_8c_a9fb1e9f0a7999d901d678c17f4a34b26}\label{dm9000__driver_8c_a9fb1e9f0a7999d901d678c17f4a34b26}} 
\index{dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}!dm9000\+Driver@{dm9000\+Driver}}
\index{dm9000\+Driver@{dm9000\+Driver}!dm9000\+\_\+driver.\+c@{dm9000\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{dm9000\+Driver}{dm9000Driver}}
{\footnotesize\ttfamily const \hyperlink{structNicDriver}{Nic\+Driver} dm9000\+Driver}

{\bfseries Initial value\+:}
\begin{DoxyCode}
=
\{
   \hyperlink{nic_8h_ac1ce8659a9797513ecd9cc1afedce40ba84802cab6ee937691c3d76122ffaffcd}{NIC\_TYPE\_ETHERNET},
   \hyperlink{ethernet_8h_a6f29d2b24a262d91b7158713728d45f2}{ETH\_MTU},
   \hyperlink{dm9000__driver_8c_afce6a3ba759e89c7f9c70378d16a0128}{dm9000Init},
   \hyperlink{dm9000__driver_8c_ac567a1237da77c173ac1e7315340934f}{dm9000Tick},
   \hyperlink{dm9000__driver_8c_acec7c0a2ca79d63efe45e1145c02d226}{dm9000EnableIrq},
   \hyperlink{dm9000__driver_8c_a633b06b67505e31c7c7b277f206637e2}{dm9000DisableIrq},
   \hyperlink{dm9000__driver_8c_a9f190c0014dcd57f94af1bbcff5ab49b}{dm9000EventHandler},
   \hyperlink{dm9000__driver_8c_a34d0f7bedd37d3428ea20a4cd85dda8c}{dm9000SendPacket},
   \hyperlink{dm9000__driver_8c_ab2a9d5e4db72c0c80a0f0755ece356a3}{dm9000UpdateMacAddrFilter},
   \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL},
   \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL},
   \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL},
   \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE},
   \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE},
   \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE},
   \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
\}
\end{DoxyCode}


D\+M9000 driver. 



Definition at line 45 of file dm9000\+\_\+driver.\+c.

