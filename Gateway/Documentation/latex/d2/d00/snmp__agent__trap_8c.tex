\hypertarget{snmp__agent__trap_8c}{}\section{cyclone\+\_\+tcp/snmp/snmp\+\_\+agent\+\_\+trap.c File Reference}
\label{snmp__agent__trap_8c}\index{cyclone\+\_\+tcp/snmp/snmp\+\_\+agent\+\_\+trap.\+c@{cyclone\+\_\+tcp/snmp/snmp\+\_\+agent\+\_\+trap.\+c}}


S\+N\+MP trap notifications.  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}snmp/snmp\+\_\+agent.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}snmp/snmp\+\_\+agent\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}snmp/snmp\+\_\+agent\+\_\+trap.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mibs/mib2\+\_\+module.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{snmp__agent__trap_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_af5cf34762d7114743a58dd8a05289bd9}{S\+N\+M\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{snmp__agent__trap_8c_a880353e617b91ca7770104332b2d5f3f}{snmp\+Format\+Trap\+Message} (\hyperlink{snmp__agent_8h_a4c68afef83114acf80065b64191bfdac}{Snmp\+Agent\+Context} $\ast$context, \hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95df}{Snmp\+Version} \hyperlink{coap__common_8h_ab22abc2906422da61885ac6c8e6a1a59}{version}, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$user\+Name, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} generic\+Trap\+Type, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} specific\+Trap\+Code, const \hyperlink{structSnmpTrapObject}{Snmp\+Trap\+Object} $\ast$object\+List, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} object\+List\+Size)
\begin{DoxyCompactList}\small\item\em Format S\+N\+MP Trap message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{snmp__agent__trap_8c_ac62569f9358cfb1cb3662950c72a14db}{snmp\+Format\+Trap\+Pdu} (\hyperlink{snmp__agent_8h_a4c68afef83114acf80065b64191bfdac}{Snmp\+Agent\+Context} $\ast$context, \hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95df}{Snmp\+Version} \hyperlink{coap__common_8h_ab22abc2906422da61885ac6c8e6a1a59}{version}, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$user\+Name, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} generic\+Trap\+Type, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} specific\+Trap\+Code, const \hyperlink{structSnmpTrapObject}{Snmp\+Trap\+Object} $\ast$object\+List, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} object\+List\+Size)
\begin{DoxyCompactList}\small\item\em Format Trap-\/\+P\+DU or S\+N\+M\+Pv2-\/\+Trap-\/\+P\+DU. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
S\+N\+MP trap notifications. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{snmp__agent__trap_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{snmp__agent__trap_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{snmp\+\_\+agent\+\_\+trap.\+c@{snmp\+\_\+agent\+\_\+trap.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!snmp\+\_\+agent\+\_\+trap.\+c@{snmp\+\_\+agent\+\_\+trap.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_af5cf34762d7114743a58dd8a05289bd9}{S\+N\+M\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file snmp\+\_\+agent\+\_\+trap.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{snmp__agent__trap_8c_a880353e617b91ca7770104332b2d5f3f}\label{snmp__agent__trap_8c_a880353e617b91ca7770104332b2d5f3f}} 
\index{snmp\+\_\+agent\+\_\+trap.\+c@{snmp\+\_\+agent\+\_\+trap.\+c}!snmp\+Format\+Trap\+Message@{snmp\+Format\+Trap\+Message}}
\index{snmp\+Format\+Trap\+Message@{snmp\+Format\+Trap\+Message}!snmp\+\_\+agent\+\_\+trap.\+c@{snmp\+\_\+agent\+\_\+trap.\+c}}
\subsubsection{\texorpdfstring{snmp\+Format\+Trap\+Message()}{snmpFormatTrapMessage()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} snmp\+Format\+Trap\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{snmp__agent_8h_a4c68afef83114acf80065b64191bfdac}{Snmp\+Agent\+Context} $\ast$}]{context,  }\item[{\hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95df}{Snmp\+Version}}]{version,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{user\+Name,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{generic\+Trap\+Type,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{specific\+Trap\+Code,  }\item[{const \hyperlink{structSnmpTrapObject}{Snmp\+Trap\+Object} $\ast$}]{object\+List,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{object\+List\+Size }\end{DoxyParamCaption})}



Format S\+N\+MP Trap message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+MP agent context \\
\hline
\mbox{\tt in}  & {\em version} & S\+N\+MP version identifier \\
\hline
\mbox{\tt in}  & {\em user\+Name} & User name or community name \\
\hline
\mbox{\tt in}  & {\em generic\+Trap\+Type} & Generic trap type \\
\hline
\mbox{\tt in}  & {\em specific\+Trap\+Code} & Specific code \\
\hline
\mbox{\tt in}  & {\em object\+List} & List of object names \\
\hline
\mbox{\tt in}  & {\em object\+List\+Size} & Number of entries in the list \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 58 of file snmp\+\_\+agent\+\_\+trap.\+c.


\begin{DoxyCode}
61 \{
62    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
63 
64 \textcolor{preprocessor}{#if (SNMP\_V1\_SUPPORT == ENABLED)}
65    \textcolor{comment}{//SNMPv1 version?}
66    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version} == \hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95dfa3dfaf92130ae745ea9945787a64458a7}{SNMP\_VERSION\_1})
67    \{
68       \textcolor{comment}{//Format Trap-PDU}
69       error = \hyperlink{snmp__agent__trap_8c_ac62569f9358cfb1cb3662950c72a14db}{snmpFormatTrapPdu}(context, \hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version}, userName,
70          genericTrapType, specificTrapCode, objectList, objectListSize);
71       \textcolor{comment}{//Any error to report?}
72       \textcolor{keywordflow}{if}(error)
73          \textcolor{keywordflow}{return} error;
74 
75       \textcolor{comment}{//Format SMNP message header}
76       error = \hyperlink{snmp__agent__message_8c_add8b6631f98a66746371b33fabf28c91}{snmpWriteMessageHeader}(&context->response);
77       \textcolor{comment}{//Any error to report?}
78       \textcolor{keywordflow}{if}(error)
79          \textcolor{keywordflow}{return} error;
80    \}
81    \textcolor{keywordflow}{else}
82 \textcolor{preprocessor}{#endif}
83 \textcolor{preprocessor}{#if (SNMP\_V2C\_SUPPORT == ENABLED)}
84    \textcolor{comment}{//SNMPv2c version?}
85    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version} == \hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95dfaa35575472195d72a958b8482d425c2b5}{SNMP\_VERSION\_2C})
86    \{
87       \textcolor{comment}{//Format SNMPv2-Trap-PDU}
88       error = \hyperlink{snmp__agent__trap_8c_ac62569f9358cfb1cb3662950c72a14db}{snmpFormatTrapPdu}(context, \hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version}, userName,
89          genericTrapType, specificTrapCode, objectList, objectListSize);
90       \textcolor{comment}{//Any error to report?}
91       \textcolor{keywordflow}{if}(error)
92          \textcolor{keywordflow}{return} error;
93 
94       \textcolor{comment}{//Format SMNP message header}
95       error = \hyperlink{snmp__agent__message_8c_add8b6631f98a66746371b33fabf28c91}{snmpWriteMessageHeader}(&context->response);
96       \textcolor{comment}{//Any error to report?}
97       \textcolor{keywordflow}{if}(error)
98          \textcolor{keywordflow}{return} error;
99    \}
100    \textcolor{keywordflow}{else}
101 \textcolor{preprocessor}{#endif}
102 \textcolor{preprocessor}{#if (SNMP\_V3\_SUPPORT == ENABLED)}
103    \textcolor{comment}{//SNMPv3 version?}
104    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version} == \hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95dfa92886bc76b0167bf8604e3a266c6be9c}{SNMP\_VERSION\_3})
105    \{
106       \hyperlink{structSnmpUserEntry}{SnmpUserEntry} *user;
107 
108       \textcolor{comment}{//Information about the user name is extracted from the local}
109       \textcolor{comment}{//configuration datastore}
110       user = \hyperlink{snmp__agent__usm_8c_adb4ad71f3b5167a13a2551f075c25110}{snmpFindUserEntry}(context, userName, strlen(userName));
111 
112       \textcolor{comment}{//Invalid user name?}
113       \textcolor{keywordflow}{if}(user == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || user->\hyperlink{structSnmpUserEntry_add2c8c54d828652fa85a0697654e0573}{status} != \hyperlink{mib__common_8h_a40ce1ea958f5c3b04f841d76f5557097a438de565ef13d128f16f420284316088}{MIB\_ROW\_STATUS\_ACTIVE})
114          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cadd2abf704c42af2698ebeccb4dd2bf85}{ERROR\_UNKNOWN\_USER\_NAME};
115 
116       \textcolor{comment}{//Save the security profile associated with the current user}
117       context->user = *user;
118 
119       \textcolor{comment}{//Format SNMPv2-Trap-PDU}
120       error = \hyperlink{snmp__agent__trap_8c_ac62569f9358cfb1cb3662950c72a14db}{snmpFormatTrapPdu}(context, \hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version}, userName,
121          genericTrapType, specificTrapCode, objectList, objectListSize);
122       \textcolor{comment}{//Any error to report?}
123       \textcolor{keywordflow}{if}(error)
124          \textcolor{keywordflow}{return} error;
125 
126       \textcolor{comment}{//Format scopedPDU}
127       error = \hyperlink{snmp__agent__message_8c_a2d4b4ddfcafc940a9d9987ce8b8e91bc}{snmpWriteScopedPdu}(&context->response);
128       \textcolor{comment}{//Any error to report?}
129       \textcolor{keywordflow}{if}(error)
130          \textcolor{keywordflow}{return} error;
131 
132       \textcolor{comment}{//Check whether the privFlag is set}
133       \textcolor{keywordflow}{if}(context->response.msgFlags & \hyperlink{snmp__agent__usm_8h_aee33010d6b1b02fc5ceef6aad55044b0a09a0d3b1da3227488bf9ccc2cc8a48e2}{SNMP\_MSG\_FLAG\_PRIV})
134       \{
135          \textcolor{comment}{//Encrypt data}
136          error = \hyperlink{snmp__agent__usm_8c_a3cb6959af6963c5f5d593a28e7f72ee7}{snmpEncryptData}(&context->user, &context->response,
137             &context->salt);
138          \textcolor{comment}{//Any error to report?}
139          \textcolor{keywordflow}{if}(error)
140             \textcolor{keywordflow}{return} error;
141       \}
142 
143       \textcolor{comment}{//Format SMNP message header}
144       error = \hyperlink{snmp__agent__message_8c_add8b6631f98a66746371b33fabf28c91}{snmpWriteMessageHeader}(&context->response);
145       \textcolor{comment}{//Any error to report?}
146       \textcolor{keywordflow}{if}(error)
147          \textcolor{keywordflow}{return} error;
148 
149       \textcolor{comment}{//Check whether the authFlag is set}
150       \textcolor{keywordflow}{if}(context->response.msgFlags & \hyperlink{snmp__agent__usm_8h_aee33010d6b1b02fc5ceef6aad55044b0a8b9b4731d377864f4e13821af7cd3329}{SNMP\_MSG\_FLAG\_AUTH})
151       \{
152          \textcolor{comment}{//Authenticate outgoing SNMP message}
153          error = \hyperlink{snmp__agent__usm_8c_ac995a1d7cfdf5f25efd29f7e5c1f7c0d}{snmpAuthOutgoingMessage}(&context->user, &context->response);
154          \textcolor{comment}{//Any error to report?}
155          \textcolor{keywordflow}{if}(error)
156             \textcolor{keywordflow}{return} error;
157       \}
158    \}
159    \textcolor{keywordflow}{else}
160 \textcolor{preprocessor}{#endif}
161    \textcolor{comment}{//Invalid SNMP version?}
162    \{
163       \textcolor{comment}{//Debug message}
164       \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"  Invalid SNMP version!\(\backslash\)r\(\backslash\)n"});
165       \textcolor{comment}{//Report an error}
166       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
167    \}
168 
169    \textcolor{comment}{//Successful processing}
170    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
171 \}
\end{DoxyCode}
\mbox{\Hypertarget{snmp__agent__trap_8c_ac62569f9358cfb1cb3662950c72a14db}\label{snmp__agent__trap_8c_ac62569f9358cfb1cb3662950c72a14db}} 
\index{snmp\+\_\+agent\+\_\+trap.\+c@{snmp\+\_\+agent\+\_\+trap.\+c}!snmp\+Format\+Trap\+Pdu@{snmp\+Format\+Trap\+Pdu}}
\index{snmp\+Format\+Trap\+Pdu@{snmp\+Format\+Trap\+Pdu}!snmp\+\_\+agent\+\_\+trap.\+c@{snmp\+\_\+agent\+\_\+trap.\+c}}
\subsubsection{\texorpdfstring{snmp\+Format\+Trap\+Pdu()}{snmpFormatTrapPdu()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} snmp\+Format\+Trap\+Pdu (\begin{DoxyParamCaption}\item[{\hyperlink{snmp__agent_8h_a4c68afef83114acf80065b64191bfdac}{Snmp\+Agent\+Context} $\ast$}]{context,  }\item[{\hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95df}{Snmp\+Version}}]{version,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{user\+Name,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{generic\+Trap\+Type,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{specific\+Trap\+Code,  }\item[{const \hyperlink{structSnmpTrapObject}{Snmp\+Trap\+Object} $\ast$}]{object\+List,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{object\+List\+Size }\end{DoxyParamCaption})}



Format Trap-\/\+P\+DU or S\+N\+M\+Pv2-\/\+Trap-\/\+P\+DU. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+MP agent context \\
\hline
\mbox{\tt in}  & {\em version} & S\+N\+MP version identifier \\
\hline
\mbox{\tt in}  & {\em user\+Name} & User name or community name \\
\hline
\mbox{\tt in}  & {\em generic\+Trap\+Type} & Generic trap type \\
\hline
\mbox{\tt in}  & {\em specific\+Trap\+Code} & Specific code \\
\hline
\mbox{\tt in}  & {\em object\+List} & List of object names \\
\hline
\mbox{\tt in}  & {\em object\+List\+Size} & Number of entries in the list \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 186 of file snmp\+\_\+agent\+\_\+trap.\+c.


\begin{DoxyCode}
189 \{
190    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
191    \hyperlink{structSnmpMessage}{SnmpMessage} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
192 
193    \textcolor{comment}{//Point to the SNMP message}
194    message = &context->response;
195    \textcolor{comment}{//Initialize SNMP message}
196    \hyperlink{snmp__agent__message_8c_a0371fc59a7828dbd4b15565d83078837}{snmpInitMessage}(message);
197 
198    \textcolor{comment}{//SNMP version identifier}
199    message->\hyperlink{structSnmpMessage_a38b300782f7395005708f45f26dae7c1}{version} = \hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version};
200 
201 \textcolor{preprocessor}{#if (SNMP\_V1\_SUPPORT == ENABLED)}
202    \textcolor{comment}{//SNMPv1 version?}
203    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version} == \hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95dfa3dfaf92130ae745ea9945787a64458a7}{SNMP\_VERSION\_1})
204    \{
205 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
206       \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{NetInterface} *interface;
207 
208       \textcolor{comment}{//Point to the underlying network interface}
209       \textcolor{keyword}{interface }= context->settings.interface;
210 \textcolor{preprocessor}{#endif}
211 
212       \textcolor{comment}{//Community name}
213       message->\hyperlink{structSnmpMessage_ac9976028507798166e3f542d5806c811}{community} = userName;
214       message->\hyperlink{structSnmpMessage_a828b7eec855d512efcb5262ed979f8fa}{communityLen} = strlen(userName);
215 
216       \textcolor{comment}{//Prepare to send a Trap-PDU}
217       message->\hyperlink{structSnmpMessage_a48ced2a20c11fcd5c72fa1c47d239343}{pduType} = \hyperlink{snmp__common_8h_a3c16ad3ed681ee8a30c429d490f9299aa51084b3eb61f91ceedeb5e426c15ffe0}{SNMP\_PDU\_TRAP};
218       \textcolor{comment}{//Type of object generating trap}
219       message->\hyperlink{structSnmpMessage_a807a5b8b2aaf91ba7ad7c5130f7de5fe}{enterpriseOid} = context->enterpriseOid;
220       message->\hyperlink{structSnmpMessage_a70d5dc7f03456b144b0d29a6a30b0a21}{enterpriseOidLen} = context->enterpriseOidLen;
221 
222 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
223       \textcolor{comment}{//Address of object generating trap}
224       \textcolor{keywordflow}{if}(interface != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
225          message->\hyperlink{structSnmpMessage_a3c51309a93e0740209c2ee75307c0f04}{agentAddr} = interface->ipv4Context.addrList[0].addr;
226 \textcolor{preprocessor}{#endif}
227 
228       \textcolor{comment}{//Generic trap type}
229       message->\hyperlink{structSnmpMessage_abef516557dd784fbaffa335e9e63353c}{genericTrapType} = genericTrapType;
230       \textcolor{comment}{//Specific trap code}
231       message->\hyperlink{structSnmpMessage_aca9391c4afa530ea6d4a12d48b8b424a}{specificTrapCode} = specificTrapCode;
232       \textcolor{comment}{//Timestamp}
233       message->\hyperlink{structSnmpMessage_afbc78f992a1722fce0dbeb050600d070}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}() / 10;
234    \}
235    \textcolor{keywordflow}{else}
236 \textcolor{preprocessor}{#endif}
237 \textcolor{preprocessor}{#if (SNMP\_V2C\_SUPPORT == ENABLED)}
238    \textcolor{comment}{//SNMPv2c version?}
239    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version} == \hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95dfaa35575472195d72a958b8482d425c2b5}{SNMP\_VERSION\_2C})
240    \{
241       \textcolor{comment}{//Community name}
242       message->\hyperlink{structSnmpMessage_ac9976028507798166e3f542d5806c811}{community} = userName;
243       message->\hyperlink{structSnmpMessage_a828b7eec855d512efcb5262ed979f8fa}{communityLen} = strlen(userName);
244 
245       \textcolor{comment}{//Prepare to send a SNMPv2-Trap-PDU}
246       message->\hyperlink{structSnmpMessage_a48ced2a20c11fcd5c72fa1c47d239343}{pduType} = \hyperlink{snmp__common_8h_a3c16ad3ed681ee8a30c429d490f9299aa194e27ffa1ad6456408b07aff153d6ff}{SNMP\_PDU\_TRAP\_V2};
247    \}
248    \textcolor{keywordflow}{else}
249 \textcolor{preprocessor}{#endif}
250 \textcolor{preprocessor}{#if (SNMP\_V3\_SUPPORT == ENABLED)}
251    \textcolor{comment}{//SNMPv3 version?}
252    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version} == \hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95dfa92886bc76b0167bf8604e3a266c6be9c}{SNMP\_VERSION\_3})
253    \{
254       \textcolor{comment}{//Increment message identifier}
255       message->\hyperlink{structSnmpMessage_ab3f065667ee47978ab059eb754f17150}{msgId} = context->msgId++;
256       \textcolor{comment}{//Wrap around if necessary}
257       \textcolor{keywordflow}{if}(context->msgId < 0)
258          context->msgId = 0;
259 
260       \textcolor{comment}{//Maximum message size supported by the sender}
261       message->\hyperlink{structSnmpMessage_a078984d1faa7cb4eb2e7978261c8cba6}{msgMaxSize} = \hyperlink{snmp__common_8h_af5a22cbaa4973c106e664d5d01316fae}{SNMP\_MAX\_MSG\_SIZE};
262 
263       \textcolor{comment}{//Bit fields which control processing of the message}
264       \textcolor{keywordflow}{if}(context->user.authProtocol != \hyperlink{snmp__agent__usm_8h_a13c46b84c881bd15bad7093a7f3639e3a2c9ec503096d5f8c9f31352c4ad6488b}{SNMP\_AUTH\_PROTOCOL\_NONE})
265          message->\hyperlink{structSnmpMessage_a7cc5ff67bc58cd54bf3cf6f3d18879d4}{msgFlags} |= \hyperlink{snmp__agent__usm_8h_aee33010d6b1b02fc5ceef6aad55044b0a8b9b4731d377864f4e13821af7cd3329}{SNMP\_MSG\_FLAG\_AUTH};
266       \textcolor{keywordflow}{if}(context->user.privProtocol != \hyperlink{snmp__agent__usm_8h_acfd97e4fdb0cd081855bcb3d922dd851a29bcb0f6410e21559159915d4c08dac8}{SNMP\_PRIV\_PROTOCOL\_NONE})
267          message->\hyperlink{structSnmpMessage_a7cc5ff67bc58cd54bf3cf6f3d18879d4}{msgFlags} |= \hyperlink{snmp__agent__usm_8h_aee33010d6b1b02fc5ceef6aad55044b0a09a0d3b1da3227488bf9ccc2cc8a48e2}{SNMP\_MSG\_FLAG\_PRIV};
268 
269       \textcolor{comment}{//Security model used by the sender}
270       message->\hyperlink{structSnmpMessage_a868cf2ac7ba0bdb1f756cfaf419cac3c}{msgSecurityModel} = \hyperlink{snmp__agent__usm_8h_a59354ab45890b9da1b27d44f88193695a21c6309103699e29211c87fd78c79521}{SNMP\_SECURITY\_MODEL\_USM};
271 
272       \textcolor{comment}{//Authoritative engine identifier}
273       message->\hyperlink{structSnmpMessage_a06ca20cfe6a8ffd06e259115fd417efb}{msgAuthEngineId} = context->contextEngine;
274       message->\hyperlink{structSnmpMessage_abe5c72a4c4f8a6c07667b0a8b6eae7ac}{msgAuthEngineIdLen} = context->contextEngineLen;
275       \textcolor{comment}{//Number of times the SNMP engine has rebooted}
276       message->\hyperlink{structSnmpMessage_ac21a9a3e133f918bda8d8a9333609621}{msgAuthEngineBoots} = context->engineBoots;
277       \textcolor{comment}{//Number of seconds since last reboot}
278       message->\hyperlink{structSnmpMessage_a3de807da8245c40a6de5365cf841ada7}{msgAuthEngineTime} = context->engineTime;
279       \textcolor{comment}{//User name}
280       message->\hyperlink{structSnmpMessage_a83e0d7035f301d07352eb2d3b6b1679a}{msgUserName} = userName;
281       message->\hyperlink{structSnmpMessage_ac9a168d33bda6c99336def2b01440b3b}{msgUserNameLen} = strlen(userName);
282       \textcolor{comment}{//Authentication parameters}
283       message->\hyperlink{structSnmpMessage_ac458dda88c1471dabbd9ec5ca3f0f0fc}{msgAuthParameters} = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
284       \textcolor{comment}{//Length of the authentication parameters}
285       message->\hyperlink{structSnmpMessage_a7b01dd73a305c550a38594c273feef27}{msgAuthParametersLen} = \hyperlink{snmp__agent__usm_8c_a4cfaee41833a90ca96cd8c6d2f945a50}{snmpGetMacLength}(context->user.
      authProtocol);
286       \textcolor{comment}{//Privacy parameters}
287       message->\hyperlink{structSnmpMessage_a06518359392967750bc6139130d489ef}{msgPrivParameters} = context->privParameters;
288 
289       \textcolor{comment}{//Length of the privacy parameters}
290       \textcolor{keywordflow}{if}(context->user.privProtocol == \hyperlink{snmp__agent__usm_8h_acfd97e4fdb0cd081855bcb3d922dd851a286d2219f3f41326458583ac8f7ca4af}{SNMP\_PRIV\_PROTOCOL\_DES})
291          message->\hyperlink{structSnmpMessage_afe1bf1cf0a488e38bc8b6017528c35e9}{msgPrivParametersLen} = 8;
292       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->user.privProtocol == \hyperlink{snmp__agent__usm_8h_acfd97e4fdb0cd081855bcb3d922dd851a9afc3ebc5fd421e94a7a5eca75f2520b}{SNMP\_PRIV\_PROTOCOL\_AES})
293          message->\hyperlink{structSnmpMessage_afe1bf1cf0a488e38bc8b6017528c35e9}{msgPrivParametersLen} = 8;
294       \textcolor{keywordflow}{else}
295          message->\hyperlink{structSnmpMessage_afe1bf1cf0a488e38bc8b6017528c35e9}{msgPrivParametersLen} = 0;
296 
297       \textcolor{comment}{//Context engine identifier}
298       message->\hyperlink{structSnmpMessage_a737a67e1857fb23d90d149cfb0d21e1c}{contextEngineId} = context->contextEngine;
299       message->\hyperlink{structSnmpMessage_ad933640b1912b549e6f1a9280a5ce7b7}{contextEngineIdLen} = context->contextEngineLen;
300       \textcolor{comment}{//Context name}
301       message->\hyperlink{structSnmpMessage_ab7b3dc54e8e1538249e1e0e08123f0f9}{contextName} = context->contextName;
302       message->\hyperlink{structSnmpMessage_a64d47bc4ef9cdfaae0494c8b224b26cb}{contextNameLen} = strlen(context->contextName);
303 
304       \textcolor{comment}{//Prepare to send a SNMPv2-Trap-PDU}
305       message->\hyperlink{structSnmpMessage_a48ced2a20c11fcd5c72fa1c47d239343}{pduType} = \hyperlink{snmp__common_8h_a3c16ad3ed681ee8a30c429d490f9299aa194e27ffa1ad6456408b07aff153d6ff}{SNMP\_PDU\_TRAP\_V2};
306    \}
307    \textcolor{keywordflow}{else}
308 \textcolor{preprocessor}{#endif}
309    \textcolor{comment}{//Invalid SNMP version?}
310    \{
311       \textcolor{comment}{//Report an error}
312       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
313    \}
314 
315    \textcolor{comment}{//Increment request identifier}
316    message->\hyperlink{structSnmpMessage_a53c30d2eaaf117a457bfd3211071540b}{requestId} = context->requestId++;
317    \textcolor{comment}{//Wrap around if necessary}
318    \textcolor{keywordflow}{if}(context->requestId < 0)
319       context->requestId = 0;
320 
321    \textcolor{comment}{//Make room for the message header at the beginning of the buffer}
322    error = \hyperlink{snmp__agent__message_8c_a804b9d2437d32dbc6c85f1b7769e727d}{snmpComputeMessageOverhead}(&context->response);
323    \textcolor{comment}{//Any error to report?}
324    \textcolor{keywordflow}{if}(error)
325       \textcolor{keywordflow}{return} error;
326 
327    \textcolor{comment}{//Format the list of variable bindings}
328    error = \hyperlink{snmp__agent__misc_8c_a8f9f560a07162c5953f105db4e276741}{snmpWriteTrapVarBindingList}(context, genericTrapType,
329       specificTrapCode, objectList, objectListSize);
330    \textcolor{comment}{//Any error to report?}
331    \textcolor{keywordflow}{if}(error)
332       \textcolor{keywordflow}{return} error;
333 
334    \textcolor{comment}{//Total number of SNMP Trap PDUs which have been generated by}
335    \textcolor{comment}{//the SNMP protocol entity}
336    \hyperlink{mib2__module_8h_abac73a39224e47d597f3b461620d2119}{MIB2\_INC\_COUNTER32}(snmpGroup.snmpOutTraps, 1);
337 
338    \textcolor{comment}{//Format PDU header}
339    error = \hyperlink{snmp__agent__message_8c_a8b5e6d1e43fef67326204bf6999d9b18}{snmpWritePduHeader}(&context->response);
340    \textcolor{comment}{//Return status code}
341    \textcolor{keywordflow}{return} error;
342 \}
\end{DoxyCode}
