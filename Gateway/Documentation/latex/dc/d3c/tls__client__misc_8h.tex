\hypertarget{tls__client__misc_8h}{}\section{cyclone\+\_\+ssl/tls\+\_\+client\+\_\+misc.h File Reference}
\label{tls__client__misc_8h}\index{cyclone\+\_\+ssl/tls\+\_\+client\+\_\+misc.\+h@{cyclone\+\_\+ssl/tls\+\_\+client\+\_\+misc.\+h}}


Helper functions for T\+LS client.  


{\ttfamily \#include \char`\"{}tls.\+h\char`\"{}}\newline
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__misc_8h_a1f7387a983a7c0ff30a699dd98d7d0a6}{tls\+Format\+Initial\+Client\+Hello} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Format initial Client\+Hello message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__misc_8h_a598623f4746afea96a0f0055ab51a64e}{tls\+Format\+Session\+Id} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, size\+\_\+t $\ast$written)
\begin{DoxyCompactList}\small\item\em Format session ID. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__misc_8h_a1be7b9837110a78faff229f1b0fb0252}{tls\+Format\+Cipher\+Suites} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} $\ast$cipher\+Suite\+Types, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, size\+\_\+t $\ast$written)
\begin{DoxyCompactList}\small\item\em Format the list of cipher suites supported by the client. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__misc_8h_a5902647ae74b659dcb7adb487d2c62dc}{tls\+Format\+Compress\+Methods} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, size\+\_\+t $\ast$written)
\begin{DoxyCompactList}\small\item\em Format the list of compression methods supported by the client. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__misc_8h_a7ef87744393b59616f0f54e7e56fc982}{tls\+Format\+Psk\+Identity} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, size\+\_\+t $\ast$written)
\begin{DoxyCompactList}\small\item\em Format P\+SK identity. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__misc_8h_ab2a3a325ab81d183c2a3f86ef14ccbb2}{tls\+Format\+Client\+Key\+Params} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, size\+\_\+t $\ast$written)
\begin{DoxyCompactList}\small\item\em Format client\textquotesingle{}s key exchange parameters. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__misc_8h_a81f447d46261af07d4664253edaa856b}{tls\+Parse\+Psk\+Identity\+Hint} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, size\+\_\+t $\ast$consumed)
\begin{DoxyCompactList}\small\item\em Parse P\+SK identity hint. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__misc_8h_ae8501704f20b582398ff648ec3ed699e}{tls\+Parse\+Server\+Key\+Params} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, size\+\_\+t $\ast$consumed)
\begin{DoxyCompactList}\small\item\em Parse server\textquotesingle{}s key exchange parameters. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__misc_8h_a90e738caacda11c8946c18248b62ca7b}{tls\+Verify\+Server\+Key\+Signature} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{tls_8h_a8e07cba48fef31563460ba8f90ad5f1d}{Tls\+Digital\+Signature} $\ast$\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$params, size\+\_\+t params\+Len, size\+\_\+t $\ast$consumed)
\begin{DoxyCompactList}\small\item\em Verify server\textquotesingle{}s key exchange parameters signature (S\+SL 3.\+0, T\+LS 1.\+0 and T\+LS 1.\+1) \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__misc_8h_a2014bcc459d7ccebd22dc1157f288940}{tls12\+Verify\+Server\+Key\+Signature} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{tls_8h_ad6758810e829828a20529e27e0f1fb6a}{Tls12\+Digital\+Signature} $\ast$\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$params, size\+\_\+t params\+Len, size\+\_\+t $\ast$consumed)
\begin{DoxyCompactList}\small\item\em Verify server\textquotesingle{}s key exchange parameters signature (T\+LS 1.\+2) \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__misc_8h_af15e95c00232215557032412641a9c96}{tls\+Select\+Client\+Version} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{tls_8h_a3b37d03b4f71ce65b23f369d2040a245}{Tls\+Server\+Hello} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, const \hyperlink{structTlsHelloExtensions}{Tls\+Hello\+Extensions} $\ast$\hyperlink{tls13__misc_8h_a7b8cc84c920376c616d85d575080d28e}{extensions})
\begin{DoxyCompactList}\small\item\em Version selection. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__misc_8h_a551517f0dbb1a1f13bcdb11513bd23ea}{tls\+Resume\+Client\+Session} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tls13__misc_8h_a0ee8ac239b5c0b1c94a323be5dd9fb17}{session\+Id}, size\+\_\+t \hyperlink{tls13__misc_8h_a17e3dc94f3cf9dd7c26a411a9db2608d}{session\+Id\+Len}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{tls13__misc_8h_ac4845d111b268869455afbd35c5f477b}{cipher\+Suite})
\begin{DoxyCompactList}\small\item\em Resume T\+LS session via session ID. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Helper functions for T\+LS client. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+S\+SL Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Function Documentation}
\mbox{\Hypertarget{tls__client__misc_8h_a2014bcc459d7ccebd22dc1157f288940}\label{tls__client__misc_8h_a2014bcc459d7ccebd22dc1157f288940}} 
\index{tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}!tls12\+Verify\+Server\+Key\+Signature@{tls12\+Verify\+Server\+Key\+Signature}}
\index{tls12\+Verify\+Server\+Key\+Signature@{tls12\+Verify\+Server\+Key\+Signature}!tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{tls12\+Verify\+Server\+Key\+Signature()}{tls12VerifyServerKeySignature()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls12\+Verify\+Server\+Key\+Signature (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{tls_8h_ad6758810e829828a20529e27e0f1fb6a}{Tls12\+Digital\+Signature} $\ast$}]{signature,  }\item[{size\+\_\+t}]{length,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{params,  }\item[{size\+\_\+t}]{params\+Len,  }\item[{size\+\_\+t $\ast$}]{consumed }\end{DoxyParamCaption})}



Verify server\textquotesingle{}s key exchange parameters signature (T\+LS 1.\+2) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em signature} & Pointer to the digital signature \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes available in the input stream \\
\hline
\mbox{\tt in}  & {\em params} & Pointer to the server\textquotesingle{}s key exchange parameters \\
\hline
\mbox{\tt in}  & {\em params\+Len} & Length of the server\textquotesingle{}s key exchange parameters \\
\hline
\mbox{\tt out}  & {\em consumed} & Total number of bytes that have been consumed \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1030 of file tls\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
1033 \{
1034    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1035 
1036 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_2 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
1037    \textcolor{comment}{//Initialize status code}
1038    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1039 
1040    \textcolor{comment}{//Check the length of the digitally-signed element}
1041    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_ad6758810e829828a20529e27e0f1fb6a}{Tls12DigitalSignature}))
1042       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1043    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < (\textcolor{keyword}{sizeof}(\hyperlink{tls_8h_ad6758810e829828a20529e27e0f1fb6a}{Tls12DigitalSignature}) + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(
      \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length)))
1044       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1045 
1046 \textcolor{preprocessor}{#if (TLS\_RSA\_SIGN\_SUPPORT == ENABLED || TLS\_RSA\_PSS\_SIGN\_SUPPORT == ENABLED || \(\backslash\)}
1047 \textcolor{preprocessor}{   TLS\_DSA\_SIGN\_SUPPORT == ENABLED || TLS\_ECDSA\_SIGN\_SUPPORT == ENABLED)}
1048    \textcolor{comment}{//RSA, DSA or ECDSA signature scheme?}
1049    \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a84a0f0f40c0affb557a7e5f157b4e1f5}{TLS\_SIGN\_ALGO\_RSA} ||
1050       \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ae82458ac6b05ba0e3851a5804f7d5e57}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA256} ||
1051       \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aef95b8f001c19481fef0409a91b56ce4}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA384} ||
1052       \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a53d5e91921faf4103349e699d188ea5f}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA512} ||
1053       \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ad23a08f2a2e5d3231cc9c2ce2e223a8d}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA256} ||
1054       \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aeb67836989d29de8af7c31ea0ddbe1b7}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA384} ||
1055       \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a1f76baf2d64af86ca98e164c9089a77c}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA512} ||
1056       \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a8d024e93d33282e5cb2a1665fb69153d}{TLS\_SIGN\_ALGO\_DSA} ||
1057       \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a47f4ec2313cd5ce1755fc2485cfdd49a}{TLS\_SIGN\_ALGO\_ECDSA})
1058    \{
1059       \textcolor{keyword}{const} \hyperlink{structHashAlgo}{HashAlgo} *hashAlgo;
1060       \hyperlink{structHashContext}{HashContext} *hashContext;
1061 
1062       \textcolor{comment}{//Retrieve the hash algorithm used for signing}
1063       \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ae82458ac6b05ba0e3851a5804f7d5e57}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA256} ||
1064          \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ad23a08f2a2e5d3231cc9c2ce2e223a8d}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA256})
1065       \{
1066          \textcolor{comment}{//The hashing is intrinsic to the signature algorithm}
1067          \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.hash == \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156dab77721d4496c39c41f5984cfd7515882}{TLS\_HASH\_ALGO\_INTRINSIC})
1068             hashAlgo = \hyperlink{tls__misc_8c_a0540f6f41d033803f8c6b9f5efe391e8}{tlsGetHashAlgo}(\hyperlink{tls_8h_a98b0299cd7e197edc67123642089156da7912aa0ea6b40af839a3d4be331fe182}{TLS\_HASH\_ALGO\_SHA256});
1069          \textcolor{keywordflow}{else}
1070             hashAlgo = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1071       \}
1072       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aef95b8f001c19481fef0409a91b56ce4}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA384} ||
1073          \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aeb67836989d29de8af7c31ea0ddbe1b7}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA384})
1074       \{
1075          \textcolor{comment}{//The hashing is intrinsic to the signature algorithm}
1076          \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.hash == \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156dab77721d4496c39c41f5984cfd7515882}{TLS\_HASH\_ALGO\_INTRINSIC})
1077             hashAlgo = \hyperlink{tls__misc_8c_a0540f6f41d033803f8c6b9f5efe391e8}{tlsGetHashAlgo}(\hyperlink{tls_8h_a98b0299cd7e197edc67123642089156da53b125010bbd797aa333a41bd1264edb}{TLS\_HASH\_ALGO\_SHA384});
1078          \textcolor{keywordflow}{else}
1079             hashAlgo = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1080       \}
1081       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a53d5e91921faf4103349e699d188ea5f}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA512} ||
1082          \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a1f76baf2d64af86ca98e164c9089a77c}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA512})
1083       \{
1084          \textcolor{comment}{//The hashing is intrinsic to the signature algorithm}
1085          \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.hash == \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156dab77721d4496c39c41f5984cfd7515882}{TLS\_HASH\_ALGO\_INTRINSIC})
1086             hashAlgo = \hyperlink{tls__misc_8c_a0540f6f41d033803f8c6b9f5efe391e8}{tlsGetHashAlgo}(\hyperlink{tls_8h_a98b0299cd7e197edc67123642089156da81cc682c95330532471fe9b48fed6acf}{TLS\_HASH\_ALGO\_SHA512});
1087          \textcolor{keywordflow}{else}
1088             hashAlgo = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1089       \}
1090       \textcolor{keywordflow}{else}
1091       \{
1092          \textcolor{comment}{//This field indicates the hash algorithm that is used}
1093          hashAlgo = \hyperlink{tls__misc_8c_a0540f6f41d033803f8c6b9f5efe391e8}{tlsGetHashAlgo}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.hash);
1094       \}
1095 
1096       \textcolor{comment}{//Make sure the hash algorithm is supported}
1097       \textcolor{keywordflow}{if}(hashAlgo != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1098       \{
1099          \textcolor{comment}{//Allocate a memory buffer to hold the hash context}
1100          hashContext = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(hashAlgo->\hyperlink{structHashAlgo_ad087845190aa4163d8339cacd07fec3e}{contextSize});
1101 
1102          \textcolor{comment}{//Successful memory allocation?}
1103          \textcolor{keywordflow}{if}(hashContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1104          \{
1105             \textcolor{comment}{//Compute hash(ClientHello.random + ServerHello.random +}
1106             \textcolor{comment}{//ServerKeyExchange.params)}
1107             hashAlgo->\hyperlink{structHashAlgo_a77dcebcb5fd49cd6672ad6c97b55fdee}{init}(hashContext);
1108             hashAlgo->\hyperlink{structHashAlgo_a83df6297595f1b9de65143df15fafda4}{update}(hashContext, context->clientRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
1109             hashAlgo->\hyperlink{structHashAlgo_a83df6297595f1b9de65143df15fafda4}{update}(hashContext, context->serverRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
1110             hashAlgo->\hyperlink{structHashAlgo_a83df6297595f1b9de65143df15fafda4}{update}(hashContext, params, paramsLen);
1111             hashAlgo->\hyperlink{structHashAlgo_a8a1972d608540bbf31e1932f5403f51d}{final}(hashContext, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
1112 
1113 \textcolor{preprocessor}{#if (TLS\_RSA\_SIGN\_SUPPORT == ENABLED)}
1114             \textcolor{comment}{//RSASSA-PKCS1-v1\_5 signature scheme?}
1115             \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a84a0f0f40c0affb557a7e5f157b4e1f5}{TLS\_SIGN\_ALGO\_RSA} &&
1116                context->peerCertType == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda3a76023fc80c787bffed357a4560351b}{TLS\_CERT\_RSA\_SIGN})
1117             \{
1118                \textcolor{comment}{//Verify RSA signature (RSASSA-PKCS1-v1\_5 signature scheme)}
1119                error = \hyperlink{rsa_8c_ac8bc3701e41ec2201abf77a280dfbc01}{rsassaPkcs1v15Verify}(&context->peerRsaPublicKey,
1120                   hashAlgo, hashContext->\hyperlink{structHashContext_a846e5b08172b00162569c343caa0eae1}{digest}, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value,
1121                   \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length));
1122             \}
1123             \textcolor{keywordflow}{else}
1124 \textcolor{preprocessor}{#endif}
1125 \textcolor{preprocessor}{#if (TLS\_RSA\_PSS\_SIGN\_SUPPORT == ENABLED)}
1126             \textcolor{comment}{//RSASSA-PSS signature scheme (with public key OID rsaEncryption)?}
1127             \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ae82458ac6b05ba0e3851a5804f7d5e57}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA256} ||
1128                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aef95b8f001c19481fef0409a91b56ce4}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA384} ||
1129                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a53d5e91921faf4103349e699d188ea5f}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA512})
1130             \{
1131                \textcolor{comment}{//Enforce the type of the certificate provided by the peer}
1132                \textcolor{keywordflow}{if}(context->peerCertType == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda3a76023fc80c787bffed357a4560351b}{TLS\_CERT\_RSA\_SIGN})
1133                \{
1134                   \textcolor{comment}{//Verify RSA signature (RSASSA-PSS signature scheme)}
1135                   error = \hyperlink{rsa_8c_a353c0daced94ff0a95ec1067f6f9048c}{rsassaPssVerify}(&context->peerRsaPublicKey, hashAlgo,
1136                      hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize}, hashContext->\hyperlink{structHashContext_a846e5b08172b00162569c343caa0eae1}{digest},
1137                      \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length));
1138                \}
1139                \textcolor{keywordflow}{else}
1140                \{
1141                   \textcolor{comment}{//Invalid certificate}
1142                   error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6e8db1d17e3aad53ecc5a4ff62df6f48}{ERROR\_INVALID\_SIGNATURE};
1143                \}
1144             \}
1145             \textcolor{keywordflow}{else}
1146 \textcolor{preprocessor}{#endif}
1147 \textcolor{preprocessor}{#if (TLS\_RSA\_PSS\_SIGN\_SUPPORT == ENABLED)}
1148             \textcolor{comment}{//RSASSA-PSS signature scheme (with public key OID RSASSA-PSS)?}
1149             \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ad23a08f2a2e5d3231cc9c2ce2e223a8d}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA256} ||
1150                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aeb67836989d29de8af7c31ea0ddbe1b7}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA384} ||
1151                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == 
      \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a1f76baf2d64af86ca98e164c9089a77c}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA512})
1152             \{
1153                \textcolor{comment}{//Enforce the type of the certificate provided by the peer}
1154                \textcolor{keywordflow}{if}(context->peerCertType == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda99a10e4ee12c5c331833b13d5a145480}{TLS\_CERT\_RSA\_PSS\_SIGN})
1155                \{
1156                   \textcolor{comment}{//Verify RSA signature (RSASSA-PSS signature scheme)}
1157                   error = \hyperlink{rsa_8c_a353c0daced94ff0a95ec1067f6f9048c}{rsassaPssVerify}(&context->peerRsaPublicKey, hashAlgo,
1158                      hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize}, hashContext->\hyperlink{structHashContext_a846e5b08172b00162569c343caa0eae1}{digest},
1159                      \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length));
1160                \}
1161                \textcolor{keywordflow}{else}
1162                \{
1163                   \textcolor{comment}{//Invalid certificate}
1164                   error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6e8db1d17e3aad53ecc5a4ff62df6f48}{ERROR\_INVALID\_SIGNATURE};
1165                \}
1166             \}
1167             \textcolor{keywordflow}{else}
1168 \textcolor{preprocessor}{#endif}
1169 \textcolor{preprocessor}{#if (TLS\_DSA\_SIGN\_SUPPORT == ENABLED)}
1170             \textcolor{comment}{//DSA signature scheme?}
1171             \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a8d024e93d33282e5cb2a1665fb69153d}{TLS\_SIGN\_ALGO\_DSA} &&
1172                context->peerCertType == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda925aea3c96483609ae2867b10693b4c4}{TLS\_CERT\_DSS\_SIGN})
1173             \{
1174                \textcolor{comment}{//DSA signature verification}
1175                error = \hyperlink{tls__signature_8c_a4ca472906bb02377b837ff2d96c18331}{tlsVerifyDsaSignature}(context, hashContext->
      \hyperlink{structHashContext_a846e5b08172b00162569c343caa0eae1}{digest},
1176                   hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize}, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value,
1177                   \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length));
1178             \}
1179             \textcolor{keywordflow}{else}
1180 \textcolor{preprocessor}{#endif}
1181 \textcolor{preprocessor}{#if (TLS\_ECDSA\_SIGN\_SUPPORT == ENABLED)}
1182             \textcolor{comment}{//ECDSA signature scheme?}
1183             \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a47f4ec2313cd5ce1755fc2485cfdd49a}{TLS\_SIGN\_ALGO\_ECDSA} &&
1184                context->peerCertType == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffdab47f2dd2c4d36761f920f8a1af97f6ec}{TLS\_CERT\_ECDSA\_SIGN})
1185             \{
1186                \textcolor{comment}{//ECDSA signature verification}
1187                error = \hyperlink{tls__signature_8c_a2a3f114dca59434482fce803095be646}{tlsVerifyEcdsaSignature}(context, hashContext->
      \hyperlink{structHashContext_a846e5b08172b00162569c343caa0eae1}{digest},
1188                   hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize}, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value,
1189                   \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length));
1190             \}
1191             \textcolor{keywordflow}{else}
1192 \textcolor{preprocessor}{#endif}
1193             \textcolor{comment}{//Invalid signature scheme?}
1194             \{
1195                \textcolor{comment}{//Report an error}
1196                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6e8db1d17e3aad53ecc5a4ff62df6f48}{ERROR\_INVALID\_SIGNATURE};
1197             \}
1198 
1199             \textcolor{comment}{//Release previously allocated memory}
1200             \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(hashContext);
1201          \}
1202          \textcolor{keywordflow}{else}
1203          \{
1204             \textcolor{comment}{//Failed to allocate memory}
1205             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
1206          \}
1207       \}
1208       \textcolor{keywordflow}{else}
1209       \{
1210          \textcolor{comment}{//Hash algorithm not supported}
1211          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6e8db1d17e3aad53ecc5a4ff62df6f48}{ERROR\_INVALID\_SIGNATURE};
1212       \}
1213    \}
1214    \textcolor{keywordflow}{else}
1215 \textcolor{preprocessor}{#endif}
1216 \textcolor{preprocessor}{#if (TLS\_EDDSA\_SIGN\_SUPPORT == ENABLED)}
1217    \textcolor{comment}{//EdDSA signature scheme?}
1218    \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ae6cdc4f0c6a497d2bd2c5d15412759ef}{TLS\_SIGN\_ALGO\_ED25519} ||
1219       \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a6fbbd4136d21496a9053ccca846ecf3f}{TLS\_SIGN\_ALGO\_ED448})
1220    \{
1221       \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *buffer;
1222 
1223       \textcolor{comment}{//A temporary buffer is needed to concatenate ClientHello.random +}
1224       \textcolor{comment}{//ServerHello.random + ServerKeyExchange.params}
1225       buffer = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(paramsLen + 2 * \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
1226 
1227       \textcolor{comment}{//Successful memory allocation?}
1228       \textcolor{keywordflow}{if}(buffer != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1229       \{
1230          \textcolor{comment}{//Data to be verified is run through the EdDSA algorithm with no}
1231          \textcolor{comment}{//hashing}
1232          memcpy(buffer, context->clientRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
1233          memcpy(buffer + 32, context->serverRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
1234          memcpy(buffer + 64, params, paramsLen);
1235 
1236 \textcolor{preprocessor}{#if (TLS\_ED25519\_SUPPORT == ENABLED)}
1237          \textcolor{comment}{//Ed25519 signature scheme?}
1238          \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ae6cdc4f0c6a497d2bd2c5d15412759ef}{TLS\_SIGN\_ALGO\_ED25519} &&
1239             context->peerCertType == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda949e4ce74babee5ea5e6a01282283512}{TLS\_CERT\_ED25519\_SIGN})
1240          \{
1241             \textcolor{comment}{//EdDSA signature verification}
1242             error = \hyperlink{tls__signature_8c_aec1f4642d666fa3172c729a6d59a9313}{tlsVerifyEddsaSignature}(context, buffer, paramsLen + 64,
1243                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length));
1244          \}
1245          \textcolor{keywordflow}{else}
1246 \textcolor{preprocessor}{#endif}
1247 \textcolor{preprocessor}{#if (TLS\_ED448\_SUPPORT == ENABLED)}
1248          \textcolor{comment}{//Ed448 signature scheme?}
1249          \textcolor{keywordflow}{if}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a6fbbd4136d21496a9053ccca846ecf3f}{TLS\_SIGN\_ALGO\_ED448} &&
1250             context->peerCertType == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda07a1b669a85b822306b5a95aa069ed27}{TLS\_CERT\_ED448\_SIGN})
1251          \{
1252             \textcolor{comment}{//EdDSA signature verification}
1253             error = \hyperlink{tls__signature_8c_aec1f4642d666fa3172c729a6d59a9313}{tlsVerifyEddsaSignature}(context, buffer, paramsLen + 64,
1254                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length));
1255          \}
1256          \textcolor{keywordflow}{else}
1257 \textcolor{preprocessor}{#endif}
1258          \textcolor{comment}{//Invalid signature scheme?}
1259          \{
1260             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6e8db1d17e3aad53ecc5a4ff62df6f48}{ERROR\_INVALID\_SIGNATURE};
1261          \}
1262 
1263          \textcolor{comment}{//Release previously allocated memory}
1264          \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(buffer);
1265       \}
1266       \textcolor{keywordflow}{else}
1267       \{
1268          \textcolor{comment}{//Failed to allocate memory}
1269          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
1270       \}
1271    \}
1272    \textcolor{keywordflow}{else}
1273 \textcolor{preprocessor}{#endif}
1274    \textcolor{comment}{//Invalid signature algorithm?}
1275    \{
1276       \textcolor{comment}{//Report an error}
1277       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6e8db1d17e3aad53ecc5a4ff62df6f48}{ERROR\_INVALID\_SIGNATURE};
1278    \}
1279 
1280    \textcolor{comment}{//Total number of bytes that have been consumed}
1281    *consumed = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_ad6758810e829828a20529e27e0f1fb6a}{Tls12DigitalSignature}) + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(
      \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length);
1282 \textcolor{preprocessor}{#else}
1283    \textcolor{comment}{//Not implemented}
1284    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
1285 \textcolor{preprocessor}{#endif}
1286 
1287    \textcolor{comment}{//Return status code}
1288    \textcolor{keywordflow}{return} error;
1289 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__client__misc_8h_a1be7b9837110a78faff229f1b0fb0252}\label{tls__client__misc_8h_a1be7b9837110a78faff229f1b0fb0252}} 
\index{tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}!tls\+Format\+Cipher\+Suites@{tls\+Format\+Cipher\+Suites}}
\index{tls\+Format\+Cipher\+Suites@{tls\+Format\+Cipher\+Suites}!tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{tls\+Format\+Cipher\+Suites()}{tlsFormatCipherSuites()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Format\+Cipher\+Suites (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} $\ast$}]{cipher\+Suite\+Types,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{p,  }\item[{size\+\_\+t $\ast$}]{written }\end{DoxyParamCaption})}



Format the list of cipher suites supported by the client. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt out}  & {\em cipher\+Suite\+Types} & Types of cipher suites proposed by the client \\
\hline
\mbox{\tt in}  & {\em p} & Output stream where to write the list of cipher suites \\
\hline
\mbox{\tt out}  & {\em written} & Total number of bytes that have been written \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 156 of file tls\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
158 \{
159    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
160    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} j;
161    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{md5_8c_af11ea3cdbca7345eb6a4a8ac5ce0434d}{k};
162    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
163    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dhcpv6__common_8h_a679cc9d376a65e69d88ec3496eea7122}{identifier};
164    \hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{TlsCipherSuites} *cipherSuites;
165 
166    \textcolor{comment}{//Types of cipher suites proposed by the client}
167    *cipherSuiteTypes = \hyperlink{tls__cipher__suites_8h_aa19934da0d53bda533624f13ba98303ba3e9312d18fd3dce336b00a1484775503}{TLS\_CIPHER\_SUITE\_TYPE\_UNKNOWN};
168 
169    \textcolor{comment}{//Point to the list of cryptographic algorithms supported by the client}
170    cipherSuites = (\hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{TlsCipherSuites} *) \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
171    \textcolor{comment}{//Number of cipher suites in the array}
172    n = 0;
173 
174    \textcolor{comment}{//Determine the number of supported cipher suites}
175    k = \hyperlink{tls__cipher__suites_8c_a90cd4f4fa1b90998f05cf0586f8b9bb1}{tlsGetNumSupportedCipherSuites}();
176 
177    \textcolor{comment}{//Debug message}
178    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Cipher suites:\(\backslash\)r\(\backslash\)n"});
179 
180    \textcolor{comment}{//Any preferred cipher suites?}
181    \textcolor{keywordflow}{if}(context->numCipherSuites > 0)
182    \{
183       \textcolor{comment}{//Loop through the list of preferred cipher suites}
184       \textcolor{keywordflow}{for}(i = 0; i < context->numCipherSuites; i++)
185       \{
186          \textcolor{comment}{//Loop through the list of supported cipher suites}
187          \textcolor{keywordflow}{for}(j = 0; j < \hyperlink{md5_8c_af11ea3cdbca7345eb6a4a8ac5ce0434d}{k}; j++)
188          \{
189             \textcolor{comment}{//Retrieve cipher suite identifier}
190             identifier = \hyperlink{tls__cipher__suites_8c_af2867fd066cb5cb528d6d9358fa499d6}{tlsSupportedCipherSuites}[j].
      \hyperlink{structTlsCipherSuiteInfo_a17e954d45a02edb1a6dd25a490f20248}{identifier};
191 
192             \textcolor{comment}{//Supported cipher suite?}
193             \textcolor{keywordflow}{if}(identifier == context->cipherSuites[i])
194             \{
195                \textcolor{comment}{//Check whether the cipher suite can be negotiated with the}
196                \textcolor{comment}{//current protocol version}
197                \textcolor{keywordflow}{if}(\hyperlink{tls__cipher__suites_8c_ac2870fccdebcb69b96b732397206d175}{tlsIsCipherSuiteAcceptable}(&
      \hyperlink{tls__cipher__suites_8c_af2867fd066cb5cb528d6d9358fa499d6}{tlsSupportedCipherSuites}[j],
198                   context->versionMin, context->versionMax,
199                   context->transportProtocol))
200                \{
201                   \textcolor{comment}{//Copy cipher suite identifier}
202                   cipherSuites->value[n++] = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(identifier);
203 
204                   \textcolor{comment}{//Debug message}
205                   \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  0x%04"} PRIX16 \textcolor{stringliteral}{" (%s)\(\backslash\)r\(\backslash\)n"}, identifier,
206                      \hyperlink{tls__cipher__suites_8c_a018dae46ac8e4443b69ed34bf3ea69c8}{tlsGetCipherSuiteName}(identifier));
207 
208                   \textcolor{comment}{//Check whether the identifier matches an ECC or FFDHE cipher}
209                   \textcolor{comment}{//suite}
210                   *cipherSuiteTypes |= \hyperlink{tls__cipher__suites_8c_af98b416f01756024d9e4043cbff1fc6f}{tlsGetCipherSuiteType}(identifier);
211                \}
212             \}
213          \}
214       \}
215    \}
216    \textcolor{keywordflow}{else}
217    \{
218       \textcolor{comment}{//Loop through the list of supported cipher suites}
219       \textcolor{keywordflow}{for}(j = 0; j < \hyperlink{md5_8c_af11ea3cdbca7345eb6a4a8ac5ce0434d}{k}; j++)
220       \{
221          \textcolor{comment}{//Retrieve cipher suite identifier}
222          identifier = \hyperlink{tls__cipher__suites_8c_af2867fd066cb5cb528d6d9358fa499d6}{tlsSupportedCipherSuites}[j].
      \hyperlink{structTlsCipherSuiteInfo_a17e954d45a02edb1a6dd25a490f20248}{identifier};
223 
224          \textcolor{comment}{//Check whether the cipher suite can be negotiated with the}
225          \textcolor{comment}{//current protocol version}
226          \textcolor{keywordflow}{if}(\hyperlink{tls__cipher__suites_8c_ac2870fccdebcb69b96b732397206d175}{tlsIsCipherSuiteAcceptable}(&
      \hyperlink{tls__cipher__suites_8c_af2867fd066cb5cb528d6d9358fa499d6}{tlsSupportedCipherSuites}[j],
227             context->versionMin, context->versionMax,
228             context->transportProtocol))
229          \{
230             \textcolor{comment}{//Copy cipher suite identifier}
231             cipherSuites->value[n++] = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(identifier);
232 
233             \textcolor{comment}{//Debug message}
234             \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  0x%04"} PRIX16 \textcolor{stringliteral}{" (%s)\(\backslash\)r\(\backslash\)n"}, identifier,
235                \hyperlink{tls__cipher__suites_8c_a018dae46ac8e4443b69ed34bf3ea69c8}{tlsGetCipherSuiteName}(identifier));
236 
237             \textcolor{comment}{//Check whether the identifier matches an ECC or FFDHE cipher}
238             \textcolor{comment}{//suite}
239             *cipherSuiteTypes |= \hyperlink{tls__cipher__suites_8c_af98b416f01756024d9e4043cbff1fc6f}{tlsGetCipherSuiteType}(identifier);
240          \}
241       \}
242    \}
243 
244 \textcolor{preprocessor}{#if (TLS\_SECURE\_RENEGOTIATION\_SUPPORT == ENABLED)}
245    \textcolor{comment}{//Check whether secure renegotiation is enabled}
246    \textcolor{keywordflow}{if}(context->secureRenegoEnabled)
247    \{
248       \textcolor{comment}{//Initial handshake?}
249       \textcolor{keywordflow}{if}(context->clientVerifyDataLen == 0)
250       \{
251          \textcolor{comment}{//The client includes the TLS\_EMPTY\_RENEGOTIATION\_INFO\_SCSV signaling}
252          \textcolor{comment}{//cipher suite value in its ClientHello}
253          cipherSuites->value[n++] = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{tls__cipher__suites_8h_af773ba8ae18d635fc9126e7f03290114aaa0adb3a743b6a7809400c6b52d7e694}{TLS\_EMPTY\_RENEGOTIATION\_INFO\_SCSV}
      );
254       \}
255    \}
256 \textcolor{preprocessor}{#endif}
257 
258 \textcolor{preprocessor}{#if (TLS\_FALLBACK\_SCSV\_SUPPORT == ENABLED)}
259    \textcolor{comment}{//Check whether support for FALLBACK\_SCSV is enabled}
260    \textcolor{keywordflow}{if}(context->fallbackScsvEnabled)
261    \{
262       \textcolor{comment}{//The TLS\_FALLBACK\_SCSV cipher suite value is meant for use by clients}
263       \textcolor{comment}{//that repeat a connection attempt with a downgraded protocol}
264       \textcolor{keywordflow}{if}(context->versionMax != \hyperlink{tls_8h_a6c4deefe3b88839c2f519ab6d0e8a80b}{TLS\_MAX\_VERSION})
265       \{
266          \textcolor{comment}{//The client should put TLS\_FALLBACK\_SCSV after all cipher suites}
267          \textcolor{comment}{//that it actually intends to negotiate}
268          cipherSuites->value[n++] = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{tls__cipher__suites_8h_af773ba8ae18d635fc9126e7f03290114a77d1bafacfe09bf4f94d004785db9c13}{TLS\_FALLBACK\_SCSV});
269       \}
270    \}
271 \textcolor{preprocessor}{#endif}
272 
273    \textcolor{comment}{//Length of the array, in bytes}
274    cipherSuites->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(n * 2);
275 
276    \textcolor{comment}{//Total number of bytes that have been written}
277    *written = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{TlsCipherSuites}) + n * 2;
278 
279    \textcolor{comment}{//Successful processing}
280    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
281 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__client__misc_8h_ab2a3a325ab81d183c2a3f86ef14ccbb2}\label{tls__client__misc_8h_ab2a3a325ab81d183c2a3f86ef14ccbb2}} 
\index{tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}!tls\+Format\+Client\+Key\+Params@{tls\+Format\+Client\+Key\+Params}}
\index{tls\+Format\+Client\+Key\+Params@{tls\+Format\+Client\+Key\+Params}!tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{tls\+Format\+Client\+Key\+Params()}{tlsFormatClientKeyParams()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Format\+Client\+Key\+Params (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{p,  }\item[{size\+\_\+t $\ast$}]{written }\end{DoxyParamCaption})}



Format client\textquotesingle{}s key exchange parameters. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em p} & Output stream where to write the client\textquotesingle{}s key exchange parameters \\
\hline
\mbox{\tt out}  & {\em written} & Total number of bytes that have been written \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 366 of file tls\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
368 \{
369 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
370    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
371    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
372 
373 \textcolor{preprocessor}{#if (TLS\_RSA\_KE\_SUPPORT == ENABLED || TLS\_RSA\_PSK\_KE\_SUPPORT == ENABLED)}
374    \textcolor{comment}{//RSA key exchange method?}
375    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01c48fe0c56e76f59032069e7c7da49e}{TLS\_KEY\_EXCH\_RSA} ||
376       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a38a6d0551d2fbd9480b6c233c1242d4c}{TLS\_KEY\_EXCH\_RSA\_PSK})
377    \{
378       \textcolor{comment}{//Sanity check}
379       \textcolor{keywordflow}{if}(\hyperlink{tls_8h_ab57dd89b36996f086e46d778395375c3}{TLS\_PREMASTER\_SECRET\_SIZE} < 48)
380          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf3f6e48b0cfaea7cac34f4223cd8a57}{ERROR\_BUFFER\_OVERFLOW};
381 
382       \textcolor{comment}{//If RSA is being used for key agreement and authentication, the}
383       \textcolor{comment}{//client generates a 48-byte premaster secret}
384       context->premasterSecretLen = 48;
385 
386       \textcolor{comment}{//The first 2 bytes code the latest version supported by the client}
387       \hyperlink{cpu__endian_8h_a8e657bcdf3842380d2d0006859029240}{STORE16BE}(context->clientVersion, context->premasterSecret);
388 
389       \textcolor{comment}{//The last 46 bytes contain securely-generated random bytes}
390       error = context->prngAlgo->read(context->prngContext,
391          context->premasterSecret + 2, 46);
392       \textcolor{comment}{//Any error to report?}
393       \textcolor{keywordflow}{if}(error)
394          \textcolor{keywordflow}{return} error;
395 
396       \textcolor{comment}{//The RSA-encrypted premaster secret in a ClientKeyExchange is preceded by}
397       \textcolor{comment}{//two length bytes. SSL 3.0 implementations do not include these bytes}
398       \textcolor{keywordflow}{if}(context->version > \hyperlink{tls_8h_a8d19a9661e2ca28062ba4a00799e8bdb}{SSL\_VERSION\_3\_0})
399       \{
400          \textcolor{comment}{//Encrypt the premaster secret using the server public key}
401          error = \hyperlink{rsa_8c_a1c7acb4138d300d842d80320df4a0cde}{rsaesPkcs1v15Encrypt}(context->prngAlgo, context->prngContext,
402             &context->peerRsaPublicKey, context->premasterSecret, 48, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} + 2, &n);
403          \textcolor{comment}{//RSA encryption failed?}
404          \textcolor{keywordflow}{if}(error)
405             \textcolor{keywordflow}{return} error;
406 
407          \textcolor{comment}{//Write the length field}
408          \hyperlink{cpu__endian_8h_a8e657bcdf3842380d2d0006859029240}{STORE16BE}(n, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p});
409 
410          \textcolor{comment}{//Length of the resulting octet string}
411          n += 2;
412       \}
413       \textcolor{keywordflow}{else}
414       \{
415          \textcolor{comment}{//Encrypt the premaster secret using the server public key}
416          error = \hyperlink{rsa_8c_a1c7acb4138d300d842d80320df4a0cde}{rsaesPkcs1v15Encrypt}(context->prngAlgo, context->prngContext,
417             &context->peerRsaPublicKey, context->premasterSecret, 48, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, &n);
418          \textcolor{comment}{//RSA encryption failed?}
419          \textcolor{keywordflow}{if}(error)
420             \textcolor{keywordflow}{return} error;
421       \}
422 
423       \textcolor{comment}{//Total number of bytes that have been written}
424       *written = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
425    \}
426    \textcolor{keywordflow}{else}
427 \textcolor{preprocessor}{#endif}
428 \textcolor{preprocessor}{#if (TLS\_DH\_ANON\_KE\_SUPPORT == ENABLED || TLS\_DHE\_RSA\_KE\_SUPPORT == ENABLED || \(\backslash\)}
429 \textcolor{preprocessor}{   TLS\_DHE\_DSS\_KE\_SUPPORT == ENABLED || TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED)}
430    \textcolor{comment}{//Diffie-Hellman key exchange method?}
431    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a33535bd987c46f1ba621d6e28b0b3bfa}{TLS\_KEY\_EXCH\_DH\_ANON} ||
432       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01660ec1808dd6a8b5250b16d81502e4}{TLS\_KEY\_EXCH\_DHE\_RSA} ||
433       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ac256323d1e243a2e7a435abce34dbd39}{TLS\_KEY\_EXCH\_DHE\_DSS} ||
434       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a32a252b7c7befeccaa088290d6a71dfe}{TLS\_KEY\_EXCH\_DHE\_PSK})
435    \{
436       \textcolor{comment}{//Generate an ephemeral key pair}
437       error = \hyperlink{dh_8c_a42364e9c726b1223c227ed4722d02395}{dhGenerateKeyPair}(&context->dhContext,
438          context->prngAlgo, context->prngContext);
439       \textcolor{comment}{//Any error to report?}
440       \textcolor{keywordflow}{if}(error)
441          \textcolor{keywordflow}{return} error;
442 
443       \textcolor{comment}{//Encode the client's public value to an opaque vector}
444       error = \hyperlink{tls__misc_8c_acdc0bb8b49d6c596ba176a5757b0fc7e}{tlsWriteMpi}(&context->dhContext.ya, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, &n);
445       \textcolor{comment}{//Any error to report?}
446       \textcolor{keywordflow}{if}(error)
447          \textcolor{keywordflow}{return} error;
448 
449       \textcolor{comment}{//Total number of bytes that have been written}
450       *written = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
451 
452       \textcolor{comment}{//Calculate the negotiated key Z}
453       error = \hyperlink{dh_8c_a79c2a9c97b46c822ed219314a1ef3231}{dhComputeSharedSecret}(&context->dhContext,
454          context->premasterSecret, \hyperlink{tls_8h_ab57dd89b36996f086e46d778395375c3}{TLS\_PREMASTER\_SECRET\_SIZE},
455          &context->premasterSecretLen);
456       \textcolor{comment}{//Any error to report?}
457       \textcolor{keywordflow}{if}(error)
458          \textcolor{keywordflow}{return} error;
459 
460       \textcolor{comment}{//Leading bytes of Z that contain all zero bits are stripped before}
461       \textcolor{comment}{//it is used as the premaster secret (RFC 4346, section 8.2.1)}
462       \textcolor{keywordflow}{for}(n = 0; n < context->premasterSecretLen; n++)
463       \{
464          \textcolor{keywordflow}{if}(context->premasterSecret[n] != 0x00)
465             \textcolor{keywordflow}{break};
466       \}
467 
468       \textcolor{comment}{//Any leading zero bytes?}
469       \textcolor{keywordflow}{if}(n > 0)
470       \{
471          \textcolor{comment}{//Strip leading zero bytes from the negotiated key}
472          memmove(context->premasterSecret, context->premasterSecret + n,
473             context->premasterSecretLen - n);
474 
475          \textcolor{comment}{//Adjust the length of the premaster secret}
476          context->premasterSecretLen -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
477       \}
478    \}
479    \textcolor{keywordflow}{else}
480 \textcolor{preprocessor}{#endif}
481 \textcolor{preprocessor}{#if (TLS\_ECDH\_ANON\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_RSA\_KE\_SUPPORT == ENABLED || \(\backslash\)}
482 \textcolor{preprocessor}{   TLS\_ECDHE\_ECDSA\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
483    \textcolor{comment}{//ECDH key exchange method?}
484    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a895e0af86b29640264f699235be22953}{TLS\_KEY\_EXCH\_ECDH\_ANON} ||
485       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ad9ebbdd436027753829ea5b6cd4b810b}{TLS\_KEY\_EXCH\_ECDHE\_RSA} ||
486       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a14c521a28278eecd181953c37b784cb7}{TLS\_KEY\_EXCH\_ECDHE\_ECDSA} ||
487       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aebba2060dba7ad92238668218f3a6520}{TLS\_KEY\_EXCH\_ECDHE\_PSK})
488    \{
489 \textcolor{preprocessor}{#if (TLS\_ECC\_CALLBACK\_SUPPORT == ENABLED)}
490       \textcolor{comment}{//Any registered callback?}
491       \textcolor{keywordflow}{if}(context->ecdhCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
492       \{
493          \textcolor{comment}{//Invoke user callback function}
494          error = context->ecdhCallback(context);
495       \}
496       \textcolor{keywordflow}{else}
497 \textcolor{preprocessor}{#endif}
498       \{
499          \textcolor{comment}{//No callback function defined}
500          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caae7cba11578605e61d5137cea3752cb9}{ERROR\_UNSUPPORTED\_ELLIPTIC\_CURVE};
501       \}
502 
503       \textcolor{comment}{//Check status code}
504       \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caae7cba11578605e61d5137cea3752cb9}{ERROR\_UNSUPPORTED\_ELLIPTIC\_CURVE})
505       \{
506          \textcolor{comment}{//Generate an ephemeral key pair}
507          error = \hyperlink{ecdh_8c_a84bbbc2b2072c6e845457f4a58602889}{ecdhGenerateKeyPair}(&context->ecdhContext,
508             context->prngAlgo, context->prngContext);
509          \textcolor{comment}{//Any error to report?}
510          \textcolor{keywordflow}{if}(error)
511             \textcolor{keywordflow}{return} error;
512 
513          \textcolor{comment}{//Calculate the negotiated key Z}
514          error = \hyperlink{ecdh_8c_a53821d9d049c084309e152dbea880db1}{ecdhComputeSharedSecret}(&context->ecdhContext,
515             context->premasterSecret, \hyperlink{tls_8h_ab57dd89b36996f086e46d778395375c3}{TLS\_PREMASTER\_SECRET\_SIZE},
516             &context->premasterSecretLen);
517          \textcolor{comment}{//Any error to report?}
518          \textcolor{keywordflow}{if}(error)
519             \textcolor{keywordflow}{return} error;
520       \}
521       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
522       \{
523          \textcolor{comment}{//Report an error}
524          \textcolor{keywordflow}{return} error;
525       \}
526 
527       \textcolor{comment}{//Encode the client's public key to an opaque vector}
528       error = \hyperlink{tls__misc_8c_ae1d6ad23621c58ee4fe6954521e1cb34}{tlsWriteEcPoint}(&context->ecdhContext.params,
529          &context->ecdhContext.qa, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, &n);
530       \textcolor{comment}{//Any error to report?}
531       \textcolor{keywordflow}{if}(error)
532          \textcolor{keywordflow}{return} error;
533 
534       \textcolor{comment}{//Total number of bytes that have been written}
535       *written = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
536    \}
537    \textcolor{keywordflow}{else}
538 \textcolor{preprocessor}{#endif}
539    \textcolor{comment}{//Invalid key exchange method?}
540    \{
541       \textcolor{comment}{//Just for sanity}
542       (void) error;
543       (void) n;
544 
545       \textcolor{comment}{//The specified key exchange method is not supported}
546       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca893cd3e6a2ef1603a6c30561ed73ec0e}{ERROR\_UNSUPPORTED\_KEY\_EXCH\_METHOD};
547    \}
548 
549    \textcolor{comment}{//Successful processing}
550    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
551 \textcolor{preprocessor}{#else}
552    \textcolor{comment}{//Not implemented}
553    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
554 \textcolor{preprocessor}{#endif}
555 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__client__misc_8h_a5902647ae74b659dcb7adb487d2c62dc}\label{tls__client__misc_8h_a5902647ae74b659dcb7adb487d2c62dc}} 
\index{tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}!tls\+Format\+Compress\+Methods@{tls\+Format\+Compress\+Methods}}
\index{tls\+Format\+Compress\+Methods@{tls\+Format\+Compress\+Methods}!tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{tls\+Format\+Compress\+Methods()}{tlsFormatCompressMethods()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Format\+Compress\+Methods (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{p,  }\item[{size\+\_\+t $\ast$}]{written }\end{DoxyParamCaption})}



Format the list of compression methods supported by the client. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em p} & Output stream where to write the list of compression methods \\
\hline
\mbox{\tt out}  & {\em written} & Total number of bytes that have been written \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 292 of file tls\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
294 \{
295    \hyperlink{tls_8h_a73df667e4fbedd6b3dd66620b4d5d018}{TlsCompressMethods} *compressMethods;
296 
297    \textcolor{comment}{//List of compression algorithms supported by the client}
298    compressMethods = (\hyperlink{tls_8h_a73df667e4fbedd6b3dd66620b4d5d018}{TlsCompressMethods} *) \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
299 
300    \textcolor{comment}{//The CRIME exploit takes advantage of TLS compression, so conservative}
301    \textcolor{comment}{//implementations do not enable compression at the TLS level}
302    compressMethods->length = 1;
303    compressMethods->value[0] = \hyperlink{tls_8h_a27ce2afc296aeccf0726bf834d2df74da9e6d39fe3397b578757793795b18d882}{TLS\_COMPRESSION\_METHOD\_NULL};
304 
305    \textcolor{comment}{//Total number of bytes that have been written}
306    *written = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a73df667e4fbedd6b3dd66620b4d5d018}{TlsCompressMethods}) + compressMethods->length;
307 
308    \textcolor{comment}{//Successful processing}
309    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
310 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__client__misc_8h_a1f7387a983a7c0ff30a699dd98d7d0a6}\label{tls__client__misc_8h_a1f7387a983a7c0ff30a699dd98d7d0a6}} 
\index{tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}!tls\+Format\+Initial\+Client\+Hello@{tls\+Format\+Initial\+Client\+Hello}}
\index{tls\+Format\+Initial\+Client\+Hello@{tls\+Format\+Initial\+Client\+Hello}!tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{tls\+Format\+Initial\+Client\+Hello()}{tlsFormatInitialClientHello()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Format\+Initial\+Client\+Hello (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Format initial Client\+Hello message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 59 of file tls\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
60 \{
61    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
62    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
63    \hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *record;
64    \hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
65 
66    \textcolor{comment}{//Point to the buffer where to format the TLS record}
67    record = (\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *) context->txBuffer;
68    \textcolor{comment}{//Point to the buffer where to format the handshake message}
69    message = (\hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake} *) record->data;
70 
71    \textcolor{comment}{//Format ClientHello message}
72    error = \hyperlink{tls__client_8c_a21420fc52dce13c48cf05dc5beba4905}{tlsFormatClientHello}(context, (\hyperlink{tls_8h_ac78d39e638430eb19c4017e5f9797d16}{TlsClientHello} *) message->data
      ,
73       &length);
74 
75    \textcolor{comment}{//Check status code}
76    \textcolor{keywordflow}{if}(!error)
77    \{
78       \textcolor{comment}{//Set the type of the handshake message}
79       message->msgType = \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba374f2754185de2cef4ffb42530ce16a8}{TLS\_TYPE\_CLIENT\_HELLO};
80       \textcolor{comment}{//Fix the length of the handshake message}
81       \hyperlink{cpu__endian_8h_acba352ed22d98efff17d0374c0790885}{STORE24BE}(length, message->length);
82 
83       \textcolor{comment}{//Total length of the handshake message}
84       length += \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_add338b5a3ca9dad219beec4da8055ed3}{TlsHandshake});
85 
86       \textcolor{comment}{//Fix the length of the TLS record}
87       record->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(length);
88    \}
89 
90    \textcolor{comment}{//Return status code}
91    \textcolor{keywordflow}{return} error;
92 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__client__misc_8h_a7ef87744393b59616f0f54e7e56fc982}\label{tls__client__misc_8h_a7ef87744393b59616f0f54e7e56fc982}} 
\index{tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}!tls\+Format\+Psk\+Identity@{tls\+Format\+Psk\+Identity}}
\index{tls\+Format\+Psk\+Identity@{tls\+Format\+Psk\+Identity}!tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{tls\+Format\+Psk\+Identity()}{tlsFormatPskIdentity()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Format\+Psk\+Identity (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{p,  }\item[{size\+\_\+t $\ast$}]{written }\end{DoxyParamCaption})}



Format P\+SK identity. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em p} & Output stream where to write the P\+SK identity hint \\
\hline
\mbox{\tt out}  & {\em written} & Total number of bytes that have been written \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 321 of file tls\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
323 \{
324    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
325    \hyperlink{tls_8h_af33e2a9d86182364df2ba92d43c4dd0f}{TlsPskIdentity} *pskIdentity;
326 
327    \textcolor{comment}{//Point to the PSK identity}
328    pskIdentity = (\hyperlink{tls_8h_af33e2a9d86182364df2ba92d43c4dd0f}{TlsPskIdentity} *) \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
329 
330 \textcolor{preprocessor}{#if (TLS\_PSK\_KE\_SUPPORT == ENABLED || TLS\_RSA\_PSK\_KE\_SUPPORT == ENABLED || \(\backslash\)}
331 \textcolor{preprocessor}{   TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
332    \textcolor{comment}{//Any PSK identity defined?}
333    \textcolor{keywordflow}{if}(context->pskIdentity != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
334    \{
335       \textcolor{comment}{//Determine the length of the PSK identity}
336       n = strlen(context->pskIdentity);
337       \textcolor{comment}{//Copy PSK identity}
338       memcpy(pskIdentity->value, context->pskIdentity, n);
339    \}
340    \textcolor{keywordflow}{else}
341 \textcolor{preprocessor}{#endif}
342    \{
343       \textcolor{comment}{//No PSK identity is provided}
344       n = 0;
345    \}
346 
347    \textcolor{comment}{//The PSK identity is preceded by a 2-byte length field}
348    pskIdentity->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(n);
349 
350    \textcolor{comment}{//Total number of bytes that have been written}
351    *written = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_af33e2a9d86182364df2ba92d43c4dd0f}{TlsPskIdentity}) + n;
352 
353    \textcolor{comment}{//Successful processing}
354    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
355 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__client__misc_8h_a598623f4746afea96a0f0055ab51a64e}\label{tls__client__misc_8h_a598623f4746afea96a0f0055ab51a64e}} 
\index{tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}!tls\+Format\+Session\+Id@{tls\+Format\+Session\+Id}}
\index{tls\+Format\+Session\+Id@{tls\+Format\+Session\+Id}!tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{tls\+Format\+Session\+Id()}{tlsFormatSessionId()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Format\+Session\+Id (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{p,  }\item[{size\+\_\+t $\ast$}]{written }\end{DoxyParamCaption})}



Format session ID. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em p} & Output stream where to write session ID \\
\hline
\mbox{\tt out}  & {\em written} & Total number of bytes that have been written \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 103 of file tls\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
105 \{
106    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
107 
108    \textcolor{comment}{//TLS 1.3 supported by the client?}
109    \textcolor{keywordflow}{if}(context->versionMax >= \hyperlink{tls_8h_ab44dc642afbfbd72926ab1f94634cd4d}{TLS\_VERSION\_1\_3} &&
110       context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa2fbbbd6c318570d570225144f3c6c244}{TLS\_TRANSPORT\_PROTOCOL\_STREAM})
111    \{
112       \textcolor{comment}{//A client which has a cached session ID set by a pre-TLS 1.3 server}
113       \textcolor{comment}{//should set this field to that value}
114       memcpy(\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, context->sessionId, context->sessionIdLen);
115       n = context->sessionIdLen;
116    \}
117    \textcolor{keywordflow}{else}
118    \{
119 \textcolor{preprocessor}{#if (TLS\_SESSION\_RESUME\_SUPPORT == ENABLED)}
120       \textcolor{comment}{//The session ID value identifies a session the client wishes to reuse}
121       \textcolor{comment}{//for this connection}
122       memcpy(\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, context->sessionId, context->sessionIdLen);
123       n = context->sessionIdLen;
124 \textcolor{preprocessor}{#else}
125       \textcolor{comment}{//Session resumption is not supported}
126       n = 0;
127 \textcolor{preprocessor}{#endif}
128    \}
129 
130 \textcolor{preprocessor}{#if (TLS\_SECURE\_RENEGOTIATION\_SUPPORT == ENABLED)}
131    \textcolor{comment}{//Secure renegotiation?}
132    \textcolor{keywordflow}{if}(context->secureRenegoEnabled && context->secureRenegoFlag)
133    \{
134       \textcolor{comment}{//Do not offer a session ID when renegotiating}
135       n = 0;
136    \}
137 \textcolor{preprocessor}{#endif}
138 
139    \textcolor{comment}{//Total number of bytes that have been written}
140    *written = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
141 
142    \textcolor{comment}{//Successful processing}
143    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
144 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__client__misc_8h_a81f447d46261af07d4664253edaa856b}\label{tls__client__misc_8h_a81f447d46261af07d4664253edaa856b}} 
\index{tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}!tls\+Parse\+Psk\+Identity\+Hint@{tls\+Parse\+Psk\+Identity\+Hint}}
\index{tls\+Parse\+Psk\+Identity\+Hint@{tls\+Parse\+Psk\+Identity\+Hint}!tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{tls\+Parse\+Psk\+Identity\+Hint()}{tlsParsePskIdentityHint()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Parse\+Psk\+Identity\+Hint (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{p,  }\item[{size\+\_\+t}]{length,  }\item[{size\+\_\+t $\ast$}]{consumed }\end{DoxyParamCaption})}



Parse P\+SK identity hint. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em p} & Input stream where to read the P\+SK identity hint \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes available in the input stream \\
\hline
\mbox{\tt out}  & {\em consumed} & Total number of bytes that have been consumed \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 567 of file tls\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
569 \{
570    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
571    \hyperlink{tls_8h_a500029728daf114a406e8dd63647db6f}{TlsPskIdentityHint} *pskIdentityHint;
572 
573    \textcolor{comment}{//Point to the PSK identity hint}
574    pskIdentityHint = (\hyperlink{tls_8h_a500029728daf114a406e8dd63647db6f}{TlsPskIdentityHint} *) \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
575 
576    \textcolor{comment}{//Malformed ServerKeyExchange message?}
577    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a500029728daf114a406e8dd63647db6f}{TlsPskIdentityHint}))
578       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
579    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < (\textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a500029728daf114a406e8dd63647db6f}{TlsPskIdentityHint}) + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(pskIdentityHint->length)))
580       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
581 
582    \textcolor{comment}{//Retrieve the length of the PSK identity hint}
583    n = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(pskIdentityHint->length);
584 
585 \textcolor{preprocessor}{#if (TLS\_PSK\_KE\_SUPPORT == ENABLED || TLS\_RSA\_PSK\_KE\_SUPPORT == ENABLED || \(\backslash\)}
586 \textcolor{preprocessor}{   TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
587    \textcolor{comment}{//Any registered callback?}
588    \textcolor{keywordflow}{if}(context->pskCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
589    \{
590       \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
591 
592       \textcolor{comment}{//The client selects which identity to use depending on the PSK identity}
593       \textcolor{comment}{//hint provided by the server}
594       error = context->pskCallback(context, pskIdentityHint->value, n);
595       \textcolor{comment}{//Any error to report?}
596       \textcolor{keywordflow}{if}(error)
597          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cade0c8860257a961bd14c16418e03f993}{ERROR\_UNKNOWN\_IDENTITY};
598    \}
599 \textcolor{preprocessor}{#endif}
600 
601    \textcolor{comment}{//Total number of bytes that have been consumed}
602    *consumed = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a500029728daf114a406e8dd63647db6f}{TlsPskIdentityHint}) + n;
603 
604    \textcolor{comment}{//Successful processing}
605    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
606 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__client__misc_8h_ae8501704f20b582398ff648ec3ed699e}\label{tls__client__misc_8h_ae8501704f20b582398ff648ec3ed699e}} 
\index{tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}!tls\+Parse\+Server\+Key\+Params@{tls\+Parse\+Server\+Key\+Params}}
\index{tls\+Parse\+Server\+Key\+Params@{tls\+Parse\+Server\+Key\+Params}!tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{tls\+Parse\+Server\+Key\+Params()}{tlsParseServerKeyParams()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Parse\+Server\+Key\+Params (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{p,  }\item[{size\+\_\+t}]{length,  }\item[{size\+\_\+t $\ast$}]{consumed }\end{DoxyParamCaption})}



Parse server\textquotesingle{}s key exchange parameters. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em p} & Input stream where to read the server\textquotesingle{}s key exchange parameters \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes available in the input stream \\
\hline
\mbox{\tt out}  & {\em consumed} & Total number of bytes that have been consumed \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 618 of file tls\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
620 \{
621 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
622    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
623    \textcolor{keyword}{const} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *params;
624 
625    \textcolor{comment}{//Initialize status code}
626    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
627 
628    \textcolor{comment}{//Point to the server's key exchange parameters}
629    params = \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
630 
631 \textcolor{preprocessor}{#if (TLS\_DH\_ANON\_KE\_SUPPORT == ENABLED || TLS\_DHE\_RSA\_KE\_SUPPORT == ENABLED || \(\backslash\)}
632 \textcolor{preprocessor}{   TLS\_DHE\_DSS\_KE\_SUPPORT == ENABLED || TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED)}
633    \textcolor{comment}{//Diffie-Hellman key exchange method?}
634    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a33535bd987c46f1ba621d6e28b0b3bfa}{TLS\_KEY\_EXCH\_DH\_ANON} ||
635       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01660ec1808dd6a8b5250b16d81502e4}{TLS\_KEY\_EXCH\_DHE\_RSA} ||
636       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ac256323d1e243a2e7a435abce34dbd39}{TLS\_KEY\_EXCH\_DHE\_DSS} ||
637       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a32a252b7c7befeccaa088290d6a71dfe}{TLS\_KEY\_EXCH\_DHE\_PSK})
638    \{
639       \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{md5_8c_af11ea3cdbca7345eb6a4a8ac5ce0434d}{k};
640       \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
641 
642       \textcolor{comment}{//Convert the prime modulus to a multiple precision integer}
643       error = \hyperlink{tls__misc_8c_ac339933c6e9abec0ad7758fb4000673e}{tlsReadMpi}(&context->dhContext.params.p, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, &n);
644 
645       \textcolor{comment}{//Check status code}
646       \textcolor{keywordflow}{if}(!error)
647       \{
648          \textcolor{comment}{//Get the length of the prime modulus, in bits}
649          k = \hyperlink{mpi_8c_a2e540eb4b5d15ea9755fb3e138990c1c}{mpiGetBitLength}(&context->dhContext.params.p);
650 
651          \textcolor{comment}{//Make sure the prime modulus is acceptable}
652          \textcolor{keywordflow}{if}(k < TLS\_MIN\_DH\_MODULUS\_SIZE || k > \hyperlink{tls_8h_a8589119c02b2aa3e1f58eacd619b04a2}{TLS\_MAX\_DH\_MODULUS\_SIZE})
653             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
654       \}
655 
656       \textcolor{comment}{//Check status code}
657       \textcolor{keywordflow}{if}(!error)
658       \{
659          \textcolor{comment}{//Advance data pointer}
660          \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
661          \textcolor{comment}{//Remaining bytes to process}
662          \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
663 
664          \textcolor{comment}{//Convert the generator to a multiple precision integer}
665          error = \hyperlink{tls__misc_8c_ac339933c6e9abec0ad7758fb4000673e}{tlsReadMpi}(&context->dhContext.params.g, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, &n);
666       \}
667 
668       \textcolor{comment}{//Check status code}
669       \textcolor{keywordflow}{if}(!error)
670       \{
671          \textcolor{comment}{//Advance data pointer}
672          \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
673          \textcolor{comment}{//Remaining bytes to process}
674          \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
675 
676          \textcolor{comment}{//Convert the server's public value to a multiple precision integer}
677          error = \hyperlink{tls__misc_8c_ac339933c6e9abec0ad7758fb4000673e}{tlsReadMpi}(&context->dhContext.yb, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, &n);
678       \}
679 
680       \textcolor{comment}{//Check status code}
681       \textcolor{keywordflow}{if}(!error)
682       \{
683          \textcolor{comment}{//Advance data pointer}
684          \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
685          \textcolor{comment}{//Remaining bytes to process}
686          \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
687 
688          \textcolor{comment}{//Verify peer's public value}
689          error = \hyperlink{dh_8c_a988fa4ff931f4ee47c2d46f0db080136}{dhCheckPublicKey}(&context->dhContext.params,
690             &context->dhContext.yb);
691       \}
692 
693       \textcolor{comment}{//Check status code}
694       \textcolor{keywordflow}{if}(!error)
695       \{
696          \textcolor{comment}{//Debug message}
697          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Diffie-Hellman parameters:\(\backslash\)r\(\backslash\)n"});
698          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Prime modulus:\(\backslash\)r\(\backslash\)n"});
699          \hyperlink{debug_8h_a9c9f3b28f2daf14d77b401512c189d93}{TRACE\_DEBUG\_MPI}(\textcolor{stringliteral}{"    "}, &context->dhContext.params.p);
700          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Generator:\(\backslash\)r\(\backslash\)n"});
701          \hyperlink{debug_8h_a9c9f3b28f2daf14d77b401512c189d93}{TRACE\_DEBUG\_MPI}(\textcolor{stringliteral}{"    "}, &context->dhContext.params.g);
702          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Server public value:\(\backslash\)r\(\backslash\)n"});
703          \hyperlink{debug_8h_a9c9f3b28f2daf14d77b401512c189d93}{TRACE\_DEBUG\_MPI}(\textcolor{stringliteral}{"    "}, &context->dhContext.yb);
704       \}
705    \}
706    \textcolor{keywordflow}{else}
707 \textcolor{preprocessor}{#endif}
708 \textcolor{preprocessor}{#if (TLS\_ECDH\_ANON\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_RSA\_KE\_SUPPORT == ENABLED || \(\backslash\)}
709 \textcolor{preprocessor}{   TLS\_ECDHE\_ECDSA\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
710    \textcolor{comment}{//ECDH key exchange method?}
711    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a895e0af86b29640264f699235be22953}{TLS\_KEY\_EXCH\_ECDH\_ANON} ||
712       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ad9ebbdd436027753829ea5b6cd4b810b}{TLS\_KEY\_EXCH\_ECDHE\_RSA} ||
713       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a14c521a28278eecd181953c37b784cb7}{TLS\_KEY\_EXCH\_ECDHE\_ECDSA} ||
714       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aebba2060dba7ad92238668218f3a6520}{TLS\_KEY\_EXCH\_ECDHE\_PSK})
715    \{
716       \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
717       \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} curveType;
718       \textcolor{keyword}{const} \hyperlink{structEcCurveInfo}{EcCurveInfo} *curveInfo;
719 
720       \textcolor{comment}{//Initialize curve parameters}
721       curveInfo = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
722 
723       \textcolor{comment}{//Malformed ServerKeyExchange message?}
724       \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(curveType))
725          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
726 
727       \textcolor{comment}{//Check status code}
728       \textcolor{keywordflow}{if}(!error)
729       \{
730          \textcolor{comment}{//Retrieve the type of the elliptic curve domain parameters}
731          curveType = *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
732 
733          \textcolor{comment}{//Advance data pointer}
734          \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} += \textcolor{keyword}{sizeof}(curveType);
735          \textcolor{comment}{//Remaining bytes to process}
736          \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \textcolor{keyword}{sizeof}(curveType);
737 
738          \textcolor{comment}{//Only named curves are supported}
739          \textcolor{keywordflow}{if}(curveType != \hyperlink{tls_8h_af3e9b2155b087b33547c1f5fa5f953b2a715a05524ba4c8c38b3c72d04fc27466}{TLS\_EC\_CURVE\_TYPE\_NAMED\_CURVE})
740             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
741       \}
742 
743       \textcolor{comment}{//Check status code}
744       \textcolor{keywordflow}{if}(!error)
745       \{
746          \textcolor{comment}{//Malformed ServerKeyExchange message?}
747          \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}))
748             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
749       \}
750 
751       \textcolor{comment}{//Check status code}
752       \textcolor{keywordflow}{if}(!error)
753       \{
754          \textcolor{comment}{//Get elliptic curve identifier}
755          context->namedGroup = \hyperlink{cpu__endian_8h_ae21854587c05993c850b537156470088}{LOAD16BE}(\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p});
756 
757          \textcolor{comment}{//Advance data pointer}
758          \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} += \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t});
759          \textcolor{comment}{//Remaining bytes to process}
760          \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t});
761 
762          \textcolor{comment}{//Retrieve the corresponding EC domain parameters}
763          curveInfo = \hyperlink{tls__misc_8c_a1d99ba7208ae993d388e7849fa5dce71}{tlsGetCurveInfo}(context, context->namedGroup);
764 
765          \textcolor{comment}{//Make sure the elliptic curve is supported}
766          \textcolor{keywordflow}{if}(curveInfo == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
767          \{
768             \textcolor{comment}{//The elliptic curve is not supported}
769             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
770          \}
771       \}
772 
773       \textcolor{comment}{//Check status code}
774       \textcolor{keywordflow}{if}(!error)
775       \{
776          \textcolor{comment}{//Load EC domain parameters}
777          error = \hyperlink{ec_8c_ab3d7ebcb8fd2e79990ef25e39a68f4a5}{ecLoadDomainParameters}(&context->ecdhContext.params,
778             curveInfo);
779       \}
780 
781       \textcolor{comment}{//Check status code}
782       \textcolor{keywordflow}{if}(!error)
783       \{
784          \textcolor{comment}{//Read server's public key}
785          error = \hyperlink{tls__misc_8c_ac6d7ad566c151d978f10283c3e6710ff}{tlsReadEcPoint}(&context->ecdhContext.params,
786             &context->ecdhContext.qb, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, &n);
787       \}
788 
789       \textcolor{comment}{//Check status code}
790       \textcolor{keywordflow}{if}(!error)
791       \{
792          \textcolor{comment}{//Advance data pointer}
793          \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
794          \textcolor{comment}{//Remaining bytes to process}
795          \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
796 
797          \textcolor{comment}{//Verify peer's public key}
798          error = \hyperlink{ecdh_8c_a91d3e413ca085581761f40ce6215925b}{ecdhCheckPublicKey}(&context->ecdhContext.params,
799             &context->ecdhContext.qb);
800       \}
801 
802       \textcolor{comment}{//Check status code}
803       \textcolor{keywordflow}{if}(!error)
804       \{
805          \textcolor{comment}{//Debug message}
806          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Server public key X:\(\backslash\)r\(\backslash\)n"});
807          \hyperlink{debug_8h_a9c9f3b28f2daf14d77b401512c189d93}{TRACE\_DEBUG\_MPI}(\textcolor{stringliteral}{"    "}, &context->ecdhContext.qb.x);
808          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Server public key Y:\(\backslash\)r\(\backslash\)n"});
809          \hyperlink{debug_8h_a9c9f3b28f2daf14d77b401512c189d93}{TRACE\_DEBUG\_MPI}(\textcolor{stringliteral}{"    "}, &context->ecdhContext.qb.y);
810       \}
811    \}
812    \textcolor{keywordflow}{else}
813 \textcolor{preprocessor}{#endif}
814    \textcolor{comment}{//Invalid key exchange method?}
815    \{
816       \textcolor{comment}{//It is not legal to send the ServerKeyExchange message when a key}
817       \textcolor{comment}{//exchange method other than DHE\_DSS, DHE\_RSA, DH\_anon, ECDHE\_RSA,}
818       \textcolor{comment}{//ECDHE\_ECDSA or ECDH\_anon is selected}
819       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
820    \}
821 
822    \textcolor{comment}{//Total number of bytes that have been consumed}
823    *consumed = \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} - params;
824 
825    \textcolor{comment}{//Return status code}
826    \textcolor{keywordflow}{return} error;
827 \textcolor{preprocessor}{#else}
828    \textcolor{comment}{//Not implemented}
829    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
830 \textcolor{preprocessor}{#endif}
831 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__client__misc_8h_a551517f0dbb1a1f13bcdb11513bd23ea}\label{tls__client__misc_8h_a551517f0dbb1a1f13bcdb11513bd23ea}} 
\index{tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}!tls\+Resume\+Client\+Session@{tls\+Resume\+Client\+Session}}
\index{tls\+Resume\+Client\+Session@{tls\+Resume\+Client\+Session}!tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{tls\+Resume\+Client\+Session()}{tlsResumeClientSession()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Resume\+Client\+Session (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{session\+Id,  }\item[{size\+\_\+t}]{session\+Id\+Len,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{cipher\+Suite }\end{DoxyParamCaption})}



Resume T\+LS session via session ID. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em session\+Id} & Pointer to the session ID provided by the server \\
\hline
\mbox{\tt in}  & {\em session\+Id\+Len} & Length of the session ID, in bytes \\
\hline
\mbox{\tt in}  & {\em cipher\+Suite} & Cipher suite selected by the server \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1465 of file tls\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
1467 \{
1468    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1469 
1470    \textcolor{comment}{//Initialize status code}
1471    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1472 
1473 \textcolor{preprocessor}{#if (TLS\_SESSION\_RESUME\_SUPPORT == ENABLED)}
1474    \textcolor{comment}{//Check whether the session ID matches the value that was supplied by the}
1475    \textcolor{comment}{//client}
1476    \textcolor{keywordflow}{if}(\hyperlink{tls_8h_a17e3dc94f3cf9dd7c26a411a9db2608d}{sessionIdLen} != 0 && \hyperlink{tls_8h_a17e3dc94f3cf9dd7c26a411a9db2608d}{sessionIdLen} == context->sessionIdLen &&
1477       !memcmp(\hyperlink{tls_8h_a0ee8ac239b5c0b1c94a323be5dd9fb17}{sessionId}, context->sessionId, \hyperlink{tls_8h_a17e3dc94f3cf9dd7c26a411a9db2608d}{sessionIdLen}))
1478    \{
1479       \textcolor{comment}{//For resumed sessions, the selected cipher suite shall be the same as}
1480       \textcolor{comment}{//the session being resumed}
1481       \textcolor{keywordflow}{if}(\hyperlink{tls13__misc_8h_ac4845d111b268869455afbd35c5f477b}{cipherSuite} != 0 && \hyperlink{tls13__misc_8h_ac4845d111b268869455afbd35c5f477b}{cipherSuite} == context->cipherSuite.identifier)
1482       \{
1483          \textcolor{comment}{//Perform abbreviated handshake}
1484          context->resume = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1485       \}
1486       \textcolor{keywordflow}{else}
1487       \{
1488          \textcolor{comment}{//The session ID is no more valid}
1489          context->sessionIdLen = 0;
1490 
1491          \textcolor{comment}{//When renegotiating, if the server tries to use another version or}
1492          \textcolor{comment}{//compression method than previously, abort}
1493          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
1494       \}
1495    \}
1496    \textcolor{keywordflow}{else}
1497 \textcolor{preprocessor}{#endif}
1498    \{
1499       \textcolor{comment}{//Perform a full handshake}
1500       context->resume = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1501    \}
1502 
1503    \textcolor{comment}{//Return status code}
1504    \textcolor{keywordflow}{return} error;
1505 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__client__misc_8h_af15e95c00232215557032412641a9c96}\label{tls__client__misc_8h_af15e95c00232215557032412641a9c96}} 
\index{tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}!tls\+Select\+Client\+Version@{tls\+Select\+Client\+Version}}
\index{tls\+Select\+Client\+Version@{tls\+Select\+Client\+Version}!tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{tls\+Select\+Client\+Version()}{tlsSelectClientVersion()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Select\+Client\+Version (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{tls_8h_a3b37d03b4f71ce65b23f369d2040a245}{Tls\+Server\+Hello} $\ast$}]{message,  }\item[{const \hyperlink{structTlsHelloExtensions}{Tls\+Hello\+Extensions} $\ast$}]{extensions }\end{DoxyParamCaption})}



Version selection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em message} & Pointer to the received Server\+Hello message \\
\hline
\mbox{\tt in}  & {\em extensions} & Server\+Hello extensions offered by the server \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1300 of file tls\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
1302 \{
1303    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1304    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} selectedVersion;
1305 
1306 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
1307    \textcolor{comment}{//Clients must check for the SupportedVersions extension prior to}
1308    \textcolor{comment}{//processing the rest of the ServerHello}
1309    \textcolor{keywordflow}{if}(extensions->\hyperlink{structTlsHelloExtensions_a3fcdd9177ae16d800a0c7de6a6a45786}{selectedVersion} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1310    \{
1311       \textcolor{comment}{//If a client receives an extension type in the ServerHello that it did}
1312       \textcolor{comment}{//not request in the associated ClientHello, it must abort the handshake}
1313       \textcolor{comment}{//with an unsupported\_extension fatal alert}
1314       \textcolor{keywordflow}{if}(context->versionMax <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1315          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca0024b1359f3a168578a6cf9da0ca4564}{ERROR\_UNSUPPORTED\_EXTENSION};
1316 
1317       \textcolor{comment}{//The legacy\_version field must be set to 0x0303, which is the version}
1318       \textcolor{comment}{//number for TLS 1.2}
1319       \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
1320       \{
1321          \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->serverVersion) != \hyperlink{dtls__misc_8h_a18aa230c9e3a222d1566d74f15f13818}{DTLS\_VERSION\_1\_2})
1322             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca20a00b499b03770ffd859e78470c278f}{ERROR\_VERSION\_NOT\_SUPPORTED};
1323       \}
1324       \textcolor{keywordflow}{else}
1325       \{
1326          \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->serverVersion) != \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1327             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca20a00b499b03770ffd859e78470c278f}{ERROR\_VERSION\_NOT\_SUPPORTED};
1328       \}
1329 
1330       \textcolor{comment}{//If this extension is present, clients must ignore the legacy\_version}
1331       \textcolor{comment}{//value and must use only the SupportedVersions extension to determine}
1332       \textcolor{comment}{//the selected version}
1333       selectedVersion = \hyperlink{cpu__endian_8h_ae21854587c05993c850b537156470088}{LOAD16BE}(extensions->\hyperlink{structTlsHelloExtensions_a3fcdd9177ae16d800a0c7de6a6a45786}{selectedVersion});
1334 
1335 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
1336       \textcolor{comment}{//DTLS protocol?}
1337       \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
1338       \{
1339          \textcolor{comment}{//If the SupportedVersions extension contains a version prior to DTLS}
1340          \textcolor{comment}{//1.3, the client must abort the handshake with an illegal\_parameter}
1341          \textcolor{comment}{//alert (refer to RFC 8446, section 4.2.1)}
1342          \textcolor{keywordflow}{if}(selectedVersion >= \hyperlink{dtls__misc_8h_a18aa230c9e3a222d1566d74f15f13818}{DTLS\_VERSION\_1\_2})
1343             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
1344 
1345          \textcolor{comment}{//Check whether the ServerHello message is received in response to an}
1346          \textcolor{comment}{//updated ClientHello?}
1347          \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da22971523377f52c52b251553e373b4c8}{TLS\_STATE\_SERVER\_HELLO\_2})
1348          \{
1349             \textcolor{comment}{//The value of selected\_version in the SupportedVersions extension}
1350             \textcolor{comment}{//of the HelloRetryRequest must be retained in the ServerHello. A}
1351             \textcolor{comment}{//client must abort the handshake with an illegal\_parameter alert if}
1352             \textcolor{comment}{//the value changes (refer to RFC 8446, section 4.1.4)}
1353             \textcolor{keywordflow}{if}(selectedVersion != \hyperlink{dtls__misc_8c_a309abf8d9966cd0d5a28be1d94859970}{dtlsTranslateVersion}(context->version))
1354                \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
1355          \}
1356       \}
1357       \textcolor{keywordflow}{else}
1358 \textcolor{preprocessor}{#endif}
1359       \textcolor{comment}{//TLS protocol?}
1360       \{
1361          \textcolor{comment}{//If the SupportedVersions extension contains a version prior to TLS}
1362          \textcolor{comment}{//1.3, the client must abort the handshake with an illegal\_parameter}
1363          \textcolor{comment}{//alert (refer to RFC 8446, section 4.2.1)}
1364          \textcolor{keywordflow}{if}(selectedVersion <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1365             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
1366 
1367          \textcolor{comment}{//Check whether the ServerHello message is received in response to an}
1368          \textcolor{comment}{//updated ClientHello?}
1369          \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da22971523377f52c52b251553e373b4c8}{TLS\_STATE\_SERVER\_HELLO\_2})
1370          \{
1371             \textcolor{comment}{//The value of selected\_version in the SupportedVersions extension}
1372             \textcolor{comment}{//of the HelloRetryRequest must be retained in the ServerHello. A}
1373             \textcolor{comment}{//client must abort the handshake with an illegal\_parameter alert if}
1374             \textcolor{comment}{//the value changes (refer to RFC 8446, section 4.1.4)}
1375             \textcolor{keywordflow}{if}(selectedVersion != context->version)
1376                \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
1377          \}
1378       \}
1379    \}
1380    \textcolor{keywordflow}{else}
1381 \textcolor{preprocessor}{#endif}
1382    \{
1383       \textcolor{comment}{//In previous versions of TLS, this field was used for version negotiation}
1384       \textcolor{comment}{//and represented the selected version number for the connection}
1385       selectedVersion = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->serverVersion);
1386 
1387 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
1388       \textcolor{comment}{//DTLS protocol?}
1389       \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
1390       \{
1391          \textcolor{comment}{//A server which negotiates DTLS 1.3 must set the legacy\_version field}
1392          \textcolor{comment}{//to 0xFEFD (DTLS 1.2) and use the SupportedVersions extension instead}
1393          \textcolor{keywordflow}{if}(selectedVersion < \hyperlink{dtls__misc_8h_a18aa230c9e3a222d1566d74f15f13818}{DTLS\_VERSION\_1\_2})
1394             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
1395       \}
1396       \textcolor{keywordflow}{else}
1397 \textcolor{preprocessor}{#endif}
1398       \textcolor{comment}{//TLS protocol?}
1399       \{
1400          \textcolor{comment}{//A server which negotiates TLS 1.3 must set the legacy\_version field}
1401          \textcolor{comment}{//to 0x0303 (TLS 1.2) and use the SupportedVersions extension instead}
1402          \textcolor{keywordflow}{if}(selectedVersion > \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1403             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
1404       \}
1405    \}
1406 
1407 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
1408    \textcolor{comment}{//DTLS protocol?}
1409    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
1410    \{
1411       \textcolor{comment}{//Set the DTLS version to be used}
1412       error = \hyperlink{dtls__misc_8c_a2f7252c7efbaf7747badfd0edde48eb9}{dtlsSelectVersion}(context, selectedVersion);
1413    \}
1414    \textcolor{keywordflow}{else}
1415 \textcolor{preprocessor}{#endif}
1416    \textcolor{comment}{//TLS protocol?}
1417    \{
1418       \textcolor{comment}{//Set the TLS version to be used}
1419       error = \hyperlink{tls__misc_8c_a62b0052733220e9ec9fee8ff5e8e5dab}{tlsSelectVersion}(context, selectedVersion);
1420    \}
1421 
1422    \textcolor{comment}{//Specified TLS/DTLS version not supported?}
1423    \textcolor{keywordflow}{if}(error)
1424       \textcolor{keywordflow}{return} error;
1425 
1426 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
1427    \textcolor{comment}{//If the ServerHello indicates TLS 1.1 or below, TLS 1.3 client must and}
1428    \textcolor{comment}{//1.2 clients should check that the last 8 bytes are not equal to the}
1429    \textcolor{comment}{//bytes 44 4F 57 4E 47 52 44 00}
1430    \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_a9e359f668824d16983a41f8deb338979}{TLS\_VERSION\_1\_1} &&
1431       context->versionMax >= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1432    \{
1433       \textcolor{comment}{//If a match is found, the client must abort the handshake with an}
1434       \textcolor{comment}{//illegal\_parameter alert}
1435       \textcolor{keywordflow}{if}(!memcmp(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->random + 24, \hyperlink{tls13__misc_8h_a9b4390bb11b13bb7563bd50c066c25d0}{tls11DowngradeRandom}, 8))
1436          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
1437    \}
1438 
1439    \textcolor{comment}{//If the ServerHello indicates TLS 1.2 or below, TLS 1.3 client must check}
1440    \textcolor{comment}{//that the last 8 bytes are not equal to the bytes 44 4F 57 4E 47 52 44 00}
1441    \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2} &&
1442       context->versionMax >= \hyperlink{tls_8h_ab44dc642afbfbd72926ab1f94634cd4d}{TLS\_VERSION\_1\_3})
1443    \{
1444       \textcolor{comment}{//If a match is found, the client must abort the handshake with an}
1445       \textcolor{comment}{//illegal\_parameter alert}
1446       \textcolor{keywordflow}{if}(!memcmp(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->random + 24, \hyperlink{tls13__misc_8h_a752eea5f23b9d45d5c02db53fff7c27e}{tls12DowngradeRandom}, 8))
1447          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
1448    \}
1449 \textcolor{preprocessor}{#endif}
1450 
1451    \textcolor{comment}{//Successful processing}
1452    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1453 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__client__misc_8h_a90e738caacda11c8946c18248b62ca7b}\label{tls__client__misc_8h_a90e738caacda11c8946c18248b62ca7b}} 
\index{tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}!tls\+Verify\+Server\+Key\+Signature@{tls\+Verify\+Server\+Key\+Signature}}
\index{tls\+Verify\+Server\+Key\+Signature@{tls\+Verify\+Server\+Key\+Signature}!tls\+\_\+client\+\_\+misc.\+h@{tls\+\_\+client\+\_\+misc.\+h}}
\subsubsection{\texorpdfstring{tls\+Verify\+Server\+Key\+Signature()}{tlsVerifyServerKeySignature()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Verify\+Server\+Key\+Signature (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{tls_8h_a8e07cba48fef31563460ba8f90ad5f1d}{Tls\+Digital\+Signature} $\ast$}]{signature,  }\item[{size\+\_\+t}]{length,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{params,  }\item[{size\+\_\+t}]{params\+Len,  }\item[{size\+\_\+t $\ast$}]{consumed }\end{DoxyParamCaption})}



Verify server\textquotesingle{}s key exchange parameters signature (S\+SL 3.\+0, T\+LS 1.\+0 and T\+LS 1.\+1) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em signature} & Pointer to the digital signature \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes available in the input stream \\
\hline
\mbox{\tt in}  & {\em params} & Pointer to the server\textquotesingle{}s key exchange parameters \\
\hline
\mbox{\tt in}  & {\em params\+Len} & Length of the server\textquotesingle{}s key exchange parameters \\
\hline
\mbox{\tt out}  & {\em consumed} & Total number of bytes that have been consumed \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 845 of file tls\+\_\+client\+\_\+misc.\+c.


\begin{DoxyCode}
848 \{
849    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
850 
851 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_1)}
852    \textcolor{comment}{//Initialize status code}
853    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
854 
855    \textcolor{comment}{//Check the length of the digitally-signed element}
856    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a8e07cba48fef31563460ba8f90ad5f1d}{TlsDigitalSignature}))
857       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
858    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < (\textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a8e07cba48fef31563460ba8f90ad5f1d}{TlsDigitalSignature}) + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(
      \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length)))
859       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
860 
861 \textcolor{preprocessor}{#if (TLS\_RSA\_SIGN\_SUPPORT == ENABLED)}
862    \textcolor{comment}{//RSA signature algorithm?}
863    \textcolor{keywordflow}{if}(context->peerCertType == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda3a76023fc80c787bffed357a4560351b}{TLS\_CERT\_RSA\_SIGN})
864    \{
865       \hyperlink{structMd5Context}{Md5Context} *md5Context;
866       \hyperlink{structSha1Context}{Sha1Context} *sha1Context;
867 
868       \textcolor{comment}{//Allocate a memory buffer to hold the MD5 context}
869       md5Context = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structMd5Context}{Md5Context}));
870 
871       \textcolor{comment}{//Successful memory allocation?}
872       \textcolor{keywordflow}{if}(md5Context != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
873       \{
874          \textcolor{comment}{//Compute MD5(ClientHello.random + ServerHello.random +}
875          \textcolor{comment}{//ServerKeyExchange.params)}
876          \hyperlink{md5_8c_acc37d4333236797f144067f5c39f345e}{md5Init}(md5Context);
877          \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, context->clientRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
878          \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, context->serverRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
879          \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, params, paramsLen);
880          \hyperlink{md5_8c_add832f9f73d9df95f48bed551122df55}{md5Final}(md5Context, context->serverVerifyData);
881 
882          \textcolor{comment}{//Release previously allocated memory}
883          \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(md5Context);
884       \}
885       \textcolor{keywordflow}{else}
886       \{
887          \textcolor{comment}{//Failed to allocate memory}
888          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
889       \}
890 
891       \textcolor{comment}{//Check status code}
892       \textcolor{keywordflow}{if}(!error)
893       \{
894          \textcolor{comment}{//Allocate a memory buffer to hold the SHA-1 context}
895          sha1Context = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structSha1Context}{Sha1Context}));
896 
897          \textcolor{comment}{//Successful memory allocation?}
898          \textcolor{keywordflow}{if}(sha1Context != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
899          \{
900             \textcolor{comment}{//Compute SHA(ClientHello.random + ServerHello.random +}
901             \textcolor{comment}{//ServerKeyExchange.params)}
902             \hyperlink{sha1_8c_ab734cb0e0b67798f5cce1f34419982a3}{sha1Init}(sha1Context);
903             \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, context->clientRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
904             \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, context->serverRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
905             \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, params, paramsLen);
906             \hyperlink{sha1_8c_a7b7d2f57b504df6ed98c27d21c1d7a14}{sha1Final}(sha1Context, context->serverVerifyData + 
      \hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE});
907 
908             \textcolor{comment}{//Release previously allocated memory}
909             \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(sha1Context);
910          \}
911          \textcolor{keywordflow}{else}
912          \{
913             \textcolor{comment}{//Failed to allocate memory}
914             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
915          \}
916       \}
917 
918       \textcolor{comment}{//Check status code}
919       \textcolor{keywordflow}{if}(!error)
920       \{
921          \textcolor{comment}{//RSA signature verification}
922          error = \hyperlink{tls__signature_8c_a5271b7427830d34327644c6717e9f03d}{tlsVerifyRsaSignature}(&context->peerRsaPublicKey,
923             context->serverVerifyData, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(
      \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length));
924       \}
925    \}
926    \textcolor{keywordflow}{else}
927 \textcolor{preprocessor}{#endif}
928 \textcolor{preprocessor}{#if (TLS\_DSA\_SIGN\_SUPPORT == ENABLED)}
929    \textcolor{comment}{//DSA signature algorithm?}
930    \textcolor{keywordflow}{if}(context->peerCertType == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda925aea3c96483609ae2867b10693b4c4}{TLS\_CERT\_DSS\_SIGN})
931    \{
932       \hyperlink{structSha1Context}{Sha1Context} *sha1Context;
933 
934       \textcolor{comment}{//Allocate a memory buffer to hold the SHA-1 context}
935       sha1Context = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structSha1Context}{Sha1Context}));
936 
937       \textcolor{comment}{//Successful memory allocation?}
938       \textcolor{keywordflow}{if}(sha1Context != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
939       \{
940          \textcolor{comment}{//Compute SHA(ClientHello.random + ServerHello.random +}
941          \textcolor{comment}{//ServerKeyExchange.params)}
942          \hyperlink{sha1_8c_ab734cb0e0b67798f5cce1f34419982a3}{sha1Init}(sha1Context);
943          \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, context->clientRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
944          \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, context->serverRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
945          \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, params, paramsLen);
946          \hyperlink{sha1_8c_a7b7d2f57b504df6ed98c27d21c1d7a14}{sha1Final}(sha1Context, context->serverVerifyData);
947 
948          \textcolor{comment}{//Release previously allocated memory}
949          \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(sha1Context);
950       \}
951       \textcolor{keywordflow}{else}
952       \{
953          \textcolor{comment}{//Failed to allocate memory}
954          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
955       \}
956 
957       \textcolor{comment}{//Check status code}
958       \textcolor{keywordflow}{if}(!error)
959       \{
960          \textcolor{comment}{//DSA signature verification}
961          error = \hyperlink{tls__signature_8c_a4ca472906bb02377b837ff2d96c18331}{tlsVerifyDsaSignature}(context, context->serverVerifyData,
962             \hyperlink{sha1_8h_a3ba9296b223f1b3c710d6b812fd860e8}{SHA1\_DIGEST\_SIZE}, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(
      \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length));
963       \}
964    \}
965    \textcolor{keywordflow}{else}
966 \textcolor{preprocessor}{#endif}
967 \textcolor{preprocessor}{#if (TLS\_ECDSA\_SIGN\_SUPPORT == ENABLED)}
968    \textcolor{comment}{//ECDSA signature algorithm?}
969    \textcolor{keywordflow}{if}(context->peerCertType == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffdab47f2dd2c4d36761f920f8a1af97f6ec}{TLS\_CERT\_ECDSA\_SIGN})
970    \{
971       \hyperlink{structSha1Context}{Sha1Context} *sha1Context;
972 
973       \textcolor{comment}{//Allocate a memory buffer to hold the SHA-1 context}
974       sha1Context = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structSha1Context}{Sha1Context}));
975 
976       \textcolor{comment}{//Successful memory allocation?}
977       \textcolor{keywordflow}{if}(sha1Context != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
978       \{
979          \textcolor{comment}{//Compute SHA(ClientHello.random + ServerHello.random +}
980          \textcolor{comment}{//ServerKeyExchange.params)}
981          \hyperlink{sha1_8c_ab734cb0e0b67798f5cce1f34419982a3}{sha1Init}(sha1Context);
982          \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, context->clientRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
983          \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, context->serverRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
984          \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, params, paramsLen);
985          \hyperlink{sha1_8c_a7b7d2f57b504df6ed98c27d21c1d7a14}{sha1Final}(sha1Context, context->serverVerifyData);
986 
987          \textcolor{comment}{//Release previously allocated memory}
988          \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(sha1Context);
989       \}
990 
991       \textcolor{comment}{//Check status code}
992       \textcolor{keywordflow}{if}(!error)
993       \{
994          \textcolor{comment}{//ECDSA signature verification}
995          error = \hyperlink{tls__signature_8c_a2a3f114dca59434482fce803095be646}{tlsVerifyEcdsaSignature}(context, context->serverVerifyData,
996             \hyperlink{sha1_8h_a3ba9296b223f1b3c710d6b812fd860e8}{SHA1\_DIGEST\_SIZE}, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(
      \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length));
997       \}
998    \}
999    \textcolor{keywordflow}{else}
1000 \textcolor{preprocessor}{#endif}
1001    \textcolor{comment}{//Invalid signature algorithm?}
1002    \{
1003       \textcolor{comment}{//Report an error}
1004       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6e8db1d17e3aad53ecc5a4ff62df6f48}{ERROR\_INVALID\_SIGNATURE};
1005    \}
1006 
1007    \textcolor{comment}{//Total number of bytes that have been consumed}
1008    *consumed = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a8e07cba48fef31563460ba8f90ad5f1d}{TlsDigitalSignature}) + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(
      \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length);
1009 \textcolor{preprocessor}{#else}
1010    \textcolor{comment}{//Not implemented}
1011    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
1012 \textcolor{preprocessor}{#endif}
1013 
1014    \textcolor{comment}{//Return status code}
1015    \textcolor{keywordflow}{return} error;
1016 \}
\end{DoxyCode}
