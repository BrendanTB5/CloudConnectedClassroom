\hypertarget{snmp__agent__dispatch_8c}{}\section{cyclone\+\_\+tcp/snmp/snmp\+\_\+agent\+\_\+dispatch.c File Reference}
\label{snmp__agent__dispatch_8c}\index{cyclone\+\_\+tcp/snmp/snmp\+\_\+agent\+\_\+dispatch.\+c@{cyclone\+\_\+tcp/snmp/snmp\+\_\+agent\+\_\+dispatch.\+c}}


S\+N\+MP message dispatching.  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}snmp/snmp\+\_\+agent.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}snmp/snmp\+\_\+agent\+\_\+dispatch.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}snmp/snmp\+\_\+agent\+\_\+pdu.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}snmp/snmp\+\_\+agent\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mibs/mib2\+\_\+module.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mibs/snmp\+\_\+mib\+\_\+module.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}core/crypto.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}encoding/asn1.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}encoding/oid.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{snmp__agent__dispatch_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_af5cf34762d7114743a58dd8a05289bd9}{S\+N\+M\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{snmp__agent__dispatch_8c_ab88d8e3596e25e12417dc2418308791a}{snmp\+Process\+Message} (\hyperlink{snmp__agent_8h_a4c68afef83114acf80065b64191bfdac}{Snmp\+Agent\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Process incoming S\+N\+MP message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{snmp__agent__dispatch_8c_a29adb269421d33b891a7d80edb8cd6c7}{snmpv1\+Process\+Message} (\hyperlink{snmp__agent_8h_a4c68afef83114acf80065b64191bfdac}{Snmp\+Agent\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Process incoming S\+N\+M\+Pv1 message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{snmp__agent__dispatch_8c_a3596b6cffcde6f5d3980f335b236125f}{snmpv2c\+Process\+Message} (\hyperlink{snmp__agent_8h_a4c68afef83114acf80065b64191bfdac}{Snmp\+Agent\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Process incoming S\+N\+M\+Pv2c message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{snmp__agent__dispatch_8c_a555e0f8dbcbe76a60f173d6a01e59e81}{snmpv3\+Process\+Message} (\hyperlink{snmp__agent_8h_a4c68afef83114acf80065b64191bfdac}{Snmp\+Agent\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Process incoming S\+N\+M\+Pv3 message. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
S\+N\+MP message dispatching. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{snmp__agent__dispatch_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{snmp__agent__dispatch_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{snmp\+\_\+agent\+\_\+dispatch.\+c@{snmp\+\_\+agent\+\_\+dispatch.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!snmp\+\_\+agent\+\_\+dispatch.\+c@{snmp\+\_\+agent\+\_\+dispatch.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_af5cf34762d7114743a58dd8a05289bd9}{S\+N\+M\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file snmp\+\_\+agent\+\_\+dispatch.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{snmp__agent__dispatch_8c_ab88d8e3596e25e12417dc2418308791a}\label{snmp__agent__dispatch_8c_ab88d8e3596e25e12417dc2418308791a}} 
\index{snmp\+\_\+agent\+\_\+dispatch.\+c@{snmp\+\_\+agent\+\_\+dispatch.\+c}!snmp\+Process\+Message@{snmp\+Process\+Message}}
\index{snmp\+Process\+Message@{snmp\+Process\+Message}!snmp\+\_\+agent\+\_\+dispatch.\+c@{snmp\+\_\+agent\+\_\+dispatch.\+c}}
\subsubsection{\texorpdfstring{snmp\+Process\+Message()}{snmpProcessMessage()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} snmp\+Process\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{snmp__agent_8h_a4c68afef83114acf80065b64191bfdac}{Snmp\+Agent\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Process incoming S\+N\+MP message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+MP agent context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 57 of file snmp\+\_\+agent\+\_\+dispatch.\+c.


\begin{DoxyCode}
58 \{
59    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
60 
61    \textcolor{comment}{//Total number of messages delivered to the SNMP entity from the}
62    \textcolor{comment}{//transport service}
63    \hyperlink{mib2__module_8h_abac73a39224e47d597f3b461620d2119}{MIB2\_INC\_COUNTER32}(snmpGroup.snmpInPkts, 1);
64    \hyperlink{snmp__mib__module_8h_a3cdbaaf290c386162780e68e496151b8}{SNMP\_MIB\_INC\_COUNTER32}(snmpGroup.snmpInPkts, 1);
65 
66 \textcolor{preprocessor}{#if (SNMP\_V3\_SUPPORT == ENABLED)}
67    \textcolor{comment}{//Refresh SNMP engine time}
68    \hyperlink{snmp__agent__usm_8c_a68a80c798e29b1410db2a383af9e8876}{snmpRefreshEngineTime}(context);
69 \textcolor{preprocessor}{#endif}
70 
71    \textcolor{comment}{//Message parsing initialization}
72    \hyperlink{snmp__agent__message_8c_a0371fc59a7828dbd4b15565d83078837}{snmpInitMessage}(&context->request);
73 
74    \textcolor{comment}{//Parse SNMP message header}
75    error = \hyperlink{snmp__agent__message_8c_a0e9ed71e6fdefac5c1cf9b68ce5bebb2}{snmpParseMessageHeader}(&context->request);
76    \textcolor{comment}{//Any error to report?}
77    \textcolor{keywordflow}{if}(error)
78       \textcolor{keywordflow}{return} error;
79 
80    \textcolor{comment}{//The SNMP agent verifies the version number. If there is a mismatch,}
81    \textcolor{comment}{//it discards the datagram and performs no further actions}
82    \textcolor{keywordflow}{if}(context->request.version < context->settings.versionMin ||
83       context->request.version > context->settings.versionMax)
84    \{
85       \textcolor{comment}{//Debug message}
86       \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"  Invalid SNMP version!\(\backslash\)r\(\backslash\)n"});
87       \textcolor{comment}{//Discard incoming SNMP message}
88       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
89    \}
90 
91 \textcolor{preprocessor}{#if (SNMP\_V1\_SUPPORT == ENABLED)}
92    \textcolor{comment}{//SNMPv1 version?}
93    \textcolor{keywordflow}{if}(context->request.version == \hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95dfa3dfaf92130ae745ea9945787a64458a7}{SNMP\_VERSION\_1})
94    \{
95       \textcolor{comment}{//Process incoming SNMPv1 message}
96       error = \hyperlink{snmp__agent__dispatch_8c_a29adb269421d33b891a7d80edb8cd6c7}{snmpv1ProcessMessage}(context);
97    \}
98    \textcolor{keywordflow}{else}
99 \textcolor{preprocessor}{#endif}
100 \textcolor{preprocessor}{#if (SNMP\_V2C\_SUPPORT == ENABLED)}
101    \textcolor{comment}{//SNMPv2c version?}
102    \textcolor{keywordflow}{if}(context->request.version == \hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95dfaa35575472195d72a958b8482d425c2b5}{SNMP\_VERSION\_2C})
103    \{
104       \textcolor{comment}{//Process incoming SNMPv2c message}
105       error = \hyperlink{snmp__agent__dispatch_8c_a3596b6cffcde6f5d3980f335b236125f}{snmpv2cProcessMessage}(context);
106    \}
107    \textcolor{keywordflow}{else}
108 \textcolor{preprocessor}{#endif}
109 \textcolor{preprocessor}{#if (SNMP\_V3\_SUPPORT == ENABLED)}
110    \textcolor{comment}{//SNMPv3 version?}
111    \textcolor{keywordflow}{if}(context->request.version == \hyperlink{snmp__common_8h_a80164b0cc3de6c48aad6917f79ee95dfa92886bc76b0167bf8604e3a266c6be9c}{SNMP\_VERSION\_3})
112    \{
113       \textcolor{comment}{//Process incoming SNMPv3 message}
114       error = \hyperlink{snmp__agent__dispatch_8c_a555e0f8dbcbe76a60f173d6a01e59e81}{snmpv3ProcessMessage}(context);
115    \}
116    \textcolor{keywordflow}{else}
117 \textcolor{preprocessor}{#endif}
118    \textcolor{comment}{//Invalid SNMP version?}
119    \{
120       \textcolor{comment}{//Debug message}
121       \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"  Invalid SNMP version!\(\backslash\)r\(\backslash\)n"});
122 
123       \textcolor{comment}{//Total number of SNMP messages which were delivered to the SNMP}
124       \textcolor{comment}{//protocol entity and were for an unsupported SNMP version}
125       \hyperlink{mib2__module_8h_abac73a39224e47d597f3b461620d2119}{MIB2\_INC\_COUNTER32}(snmpGroup.snmpInBadVersions, 1);
126       \hyperlink{snmp__mib__module_8h_a3cdbaaf290c386162780e68e496151b8}{SNMP\_MIB\_INC\_COUNTER32}(snmpGroup.snmpInBadVersions, 1);
127 
128       \textcolor{comment}{//Discard incoming SNMP message}
129       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
130    \}
131 
132    \textcolor{comment}{//Check status code}
133    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
134    \{
135       \textcolor{comment}{//Total number of messages which were passed from the SNMP protocol}
136       \textcolor{comment}{//entity to the transport service}
137       \hyperlink{mib2__module_8h_abac73a39224e47d597f3b461620d2119}{MIB2\_INC\_COUNTER32}(snmpGroup.snmpOutPkts, 1);
138    \}
139    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caf1442b36897b28194c3faa9d716ff808}{ERROR\_INVALID\_TAG})
140    \{
141       \textcolor{comment}{//Total number of ASN.1 or BER errors encountered by the SNMP protocol}
142       \textcolor{comment}{//entity when decoding received SNMP messages}
143       \hyperlink{mib2__module_8h_abac73a39224e47d597f3b461620d2119}{MIB2\_INC\_COUNTER32}(snmpGroup.snmpInASNParseErrs, 1);
144       \hyperlink{snmp__mib__module_8h_a3cdbaaf290c386162780e68e496151b8}{SNMP\_MIB\_INC\_COUNTER32}(snmpGroup.snmpInASNParseErrs, 1);
145    \}
146    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf3f6e48b0cfaea7cac34f4223cd8a57}{ERROR\_BUFFER\_OVERFLOW})
147    \{
148       \textcolor{comment}{//Total number of PDUs delivered to the SNMP entity which were silently}
149       \textcolor{comment}{//dropped because the size of the reply was greater than the maximum}
150       \textcolor{comment}{//message size}
151       \hyperlink{snmp__mib__module_8h_a3cdbaaf290c386162780e68e496151b8}{SNMP\_MIB\_INC\_COUNTER32}(snmpGroup.snmpSilentDrops, 1);
152    \}
153 
154    \textcolor{comment}{//Return status code}
155    \textcolor{keywordflow}{return} error;
156 \}
\end{DoxyCode}
\mbox{\Hypertarget{snmp__agent__dispatch_8c_a29adb269421d33b891a7d80edb8cd6c7}\label{snmp__agent__dispatch_8c_a29adb269421d33b891a7d80edb8cd6c7}} 
\index{snmp\+\_\+agent\+\_\+dispatch.\+c@{snmp\+\_\+agent\+\_\+dispatch.\+c}!snmpv1\+Process\+Message@{snmpv1\+Process\+Message}}
\index{snmpv1\+Process\+Message@{snmpv1\+Process\+Message}!snmp\+\_\+agent\+\_\+dispatch.\+c@{snmp\+\_\+agent\+\_\+dispatch.\+c}}
\subsubsection{\texorpdfstring{snmpv1\+Process\+Message()}{snmpv1ProcessMessage()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} snmpv1\+Process\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{snmp__agent_8h_a4c68afef83114acf80065b64191bfdac}{Snmp\+Agent\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Process incoming S\+N\+M\+Pv1 message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+MP agent context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 165 of file snmp\+\_\+agent\+\_\+dispatch.\+c.


\begin{DoxyCode}
166 \{
167 \textcolor{preprocessor}{#if (SNMP\_V1\_SUPPORT == ENABLED)}
168    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
169    \hyperlink{structSnmpUserEntry}{SnmpUserEntry} *community;
170 
171    \textcolor{comment}{//Parse community name}
172    error = \hyperlink{snmp__agent__message_8c_a16a9e30e049c906b864fbd7107c823ca}{snmpParseCommunity}(&context->request);
173    \textcolor{comment}{//Any error to report?}
174    \textcolor{keywordflow}{if}(error)
175       \textcolor{keywordflow}{return} error;
176 
177    \textcolor{comment}{//Information about the community name is extracted from the local}
178    \textcolor{comment}{//configuration datastore}
179    community = \hyperlink{snmp__agent__misc_8c_aac1d3ba9a7753dd2afd22d27f199f7a9}{snmpFindCommunityEntry}(context, context->request.community,
180       context->request.communityLen);
181 
182    \textcolor{comment}{//Invalid community name?}
183    \textcolor{keywordflow}{if}(community == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || community->\hyperlink{structSnmpUserEntry_add2c8c54d828652fa85a0697654e0573}{status} != \hyperlink{mib__common_8h_a40ce1ea958f5c3b04f841d76f5557097a438de565ef13d128f16f420284316088}{MIB\_ROW\_STATUS\_ACTIVE})
184    \{
185       \textcolor{comment}{//Debug message}
186       \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"  Invalid community name!\(\backslash\)r\(\backslash\)n"});
187 
188       \textcolor{comment}{//Total number of SNMP messages delivered to the SNMP protocol entity}
189       \textcolor{comment}{//which used a SNMP community name not known to said entity}
190       \hyperlink{mib2__module_8h_abac73a39224e47d597f3b461620d2119}{MIB2\_INC\_COUNTER32}(snmpGroup.snmpInBadCommunityNames, 1);
191       \hyperlink{snmp__mib__module_8h_a3cdbaaf290c386162780e68e496151b8}{SNMP\_MIB\_INC\_COUNTER32}(snmpGroup.snmpInBadCommunityNames, 1);
192 
193       \textcolor{comment}{//Report an error}
194       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cadd2abf704c42af2698ebeccb4dd2bf85}{ERROR\_UNKNOWN\_USER\_NAME};
195    \}
196 
197    \textcolor{comment}{//Save the security profile associated with the current community}
198    context->user = *community;
199 
200    \textcolor{comment}{//Process PDU}
201    error = \hyperlink{snmp__agent__pdu_8c_a06e8ee51730d690fa823f52a33531093}{snmpProcessPdu}(context);
202    \textcolor{comment}{//Any error to report?}
203    \textcolor{keywordflow}{if}(error)
204       \textcolor{keywordflow}{return} error;
205 
206    \textcolor{comment}{//Any response?}
207    \textcolor{keywordflow}{if}(context->response.length > 0)
208    \{
209       \textcolor{comment}{//Format SNMP message header}
210       error = \hyperlink{snmp__agent__message_8c_add8b6631f98a66746371b33fabf28c91}{snmpWriteMessageHeader}(&context->response);
211    \}
212 
213    \textcolor{comment}{//Return status code}
214    \textcolor{keywordflow}{return} error;
215 \textcolor{preprocessor}{#else}
216    \textcolor{comment}{//Report an error}
217    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
218 \textcolor{preprocessor}{#endif}
219 \}
\end{DoxyCode}
\mbox{\Hypertarget{snmp__agent__dispatch_8c_a3596b6cffcde6f5d3980f335b236125f}\label{snmp__agent__dispatch_8c_a3596b6cffcde6f5d3980f335b236125f}} 
\index{snmp\+\_\+agent\+\_\+dispatch.\+c@{snmp\+\_\+agent\+\_\+dispatch.\+c}!snmpv2c\+Process\+Message@{snmpv2c\+Process\+Message}}
\index{snmpv2c\+Process\+Message@{snmpv2c\+Process\+Message}!snmp\+\_\+agent\+\_\+dispatch.\+c@{snmp\+\_\+agent\+\_\+dispatch.\+c}}
\subsubsection{\texorpdfstring{snmpv2c\+Process\+Message()}{snmpv2cProcessMessage()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} snmpv2c\+Process\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{snmp__agent_8h_a4c68afef83114acf80065b64191bfdac}{Snmp\+Agent\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Process incoming S\+N\+M\+Pv2c message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+MP agent context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 228 of file snmp\+\_\+agent\+\_\+dispatch.\+c.


\begin{DoxyCode}
229 \{
230 \textcolor{preprocessor}{#if (SNMP\_V2C\_SUPPORT == ENABLED)}
231    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
232    \hyperlink{structSnmpUserEntry}{SnmpUserEntry} *community;
233 
234    \textcolor{comment}{//Parse community name}
235    error = \hyperlink{snmp__agent__message_8c_a16a9e30e049c906b864fbd7107c823ca}{snmpParseCommunity}(&context->request);
236    \textcolor{comment}{//Any error to report?}
237    \textcolor{keywordflow}{if}(error)
238       \textcolor{keywordflow}{return} error;
239 
240    \textcolor{comment}{//Information about the community name is extracted from the local}
241    \textcolor{comment}{//configuration datastore}
242    community = \hyperlink{snmp__agent__misc_8c_aac1d3ba9a7753dd2afd22d27f199f7a9}{snmpFindCommunityEntry}(context, context->request.community,
243       context->request.communityLen);
244 
245    \textcolor{comment}{//Invalid community name?}
246    \textcolor{keywordflow}{if}(community == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || community->\hyperlink{structSnmpUserEntry_add2c8c54d828652fa85a0697654e0573}{status} != \hyperlink{mib__common_8h_a40ce1ea958f5c3b04f841d76f5557097a438de565ef13d128f16f420284316088}{MIB\_ROW\_STATUS\_ACTIVE})
247    \{
248       \textcolor{comment}{//Debug message}
249       \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"  Invalid community name!\(\backslash\)r\(\backslash\)n"});
250 
251       \textcolor{comment}{//Total number of SNMP messages delivered to the SNMP protocol entity}
252       \textcolor{comment}{//which used a SNMP community name not known to said entity}
253       \hyperlink{mib2__module_8h_abac73a39224e47d597f3b461620d2119}{MIB2\_INC\_COUNTER32}(snmpGroup.snmpInBadCommunityNames, 1);
254       \hyperlink{snmp__mib__module_8h_a3cdbaaf290c386162780e68e496151b8}{SNMP\_MIB\_INC\_COUNTER32}(snmpGroup.snmpInBadCommunityNames, 1);
255 
256       \textcolor{comment}{//Report an error}
257       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cadd2abf704c42af2698ebeccb4dd2bf85}{ERROR\_UNKNOWN\_USER\_NAME};
258    \}
259 
260    \textcolor{comment}{//Save the security profile associated with the current community}
261    context->user = *community;
262 
263    \textcolor{comment}{//Process PDU}
264    error = \hyperlink{snmp__agent__pdu_8c_a06e8ee51730d690fa823f52a33531093}{snmpProcessPdu}(context);
265    \textcolor{comment}{//Any error to report?}
266    \textcolor{keywordflow}{if}(error)
267       \textcolor{keywordflow}{return} error;
268 
269    \textcolor{comment}{//Any response?}
270    \textcolor{keywordflow}{if}(context->response.length > 0)
271    \{
272       \textcolor{comment}{//Format SNMP message header}
273       error = \hyperlink{snmp__agent__message_8c_add8b6631f98a66746371b33fabf28c91}{snmpWriteMessageHeader}(&context->response);
274    \}
275 
276    \textcolor{comment}{//Return status code}
277    \textcolor{keywordflow}{return} error;
278 \textcolor{preprocessor}{#else}
279    \textcolor{comment}{//Report an error}
280    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
281 \textcolor{preprocessor}{#endif}
282 \}
\end{DoxyCode}
\mbox{\Hypertarget{snmp__agent__dispatch_8c_a555e0f8dbcbe76a60f173d6a01e59e81}\label{snmp__agent__dispatch_8c_a555e0f8dbcbe76a60f173d6a01e59e81}} 
\index{snmp\+\_\+agent\+\_\+dispatch.\+c@{snmp\+\_\+agent\+\_\+dispatch.\+c}!snmpv3\+Process\+Message@{snmpv3\+Process\+Message}}
\index{snmpv3\+Process\+Message@{snmpv3\+Process\+Message}!snmp\+\_\+agent\+\_\+dispatch.\+c@{snmp\+\_\+agent\+\_\+dispatch.\+c}}
\subsubsection{\texorpdfstring{snmpv3\+Process\+Message()}{snmpv3ProcessMessage()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} snmpv3\+Process\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{snmp__agent_8h_a4c68afef83114acf80065b64191bfdac}{Snmp\+Agent\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Process incoming S\+N\+M\+Pv3 message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the S\+N\+MP agent context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 291 of file snmp\+\_\+agent\+\_\+dispatch.\+c.


\begin{DoxyCode}
292 \{
293 \textcolor{preprocessor}{#if (SNMP\_V3\_SUPPORT == ENABLED)}
294    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
295    \hyperlink{structSnmpUserEntry}{SnmpUserEntry} *user;
296 
297    \textcolor{comment}{//Parse msgGlobalData field}
298    error = \hyperlink{snmp__agent__message_8c_a9df2434771d530036f055dd55001463f}{snmpParseGlobalData}(&context->request);
299    \textcolor{comment}{//Any error to report?}
300    \textcolor{keywordflow}{if}(error)
301       \textcolor{keywordflow}{return} error;
302 
303    \textcolor{comment}{//Parse msgSecurityParameters field}
304    error = \hyperlink{snmp__agent__message_8c_a1fc1b78ad11740dda041262c137e54f7}{snmpParseSecurityParameters}(&context->request);
305    \textcolor{comment}{//Any error to report?}
306    \textcolor{keywordflow}{if}(error)
307       \textcolor{keywordflow}{return} error;
308 
309    \textcolor{comment}{//Start of exception handling block}
310    \textcolor{keywordflow}{do}
311    \{
312 \textcolor{preprocessor}{#if (SNMP\_AGENT\_INFORM\_SUPPORT == ENABLED)}
313       \textcolor{keywordflow}{if}(context->request.msgUserNameLen == 0 && context->request.msgFlags == 0)
314       \{
315          \textcolor{comment}{//Clear the security profile}
316          memset(&context->user, 0, \textcolor{keyword}{sizeof}(\hyperlink{structSnmpUserEntry}{SnmpUserEntry}));
317       \}
318       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->informContextEngineLen > 0 &&
319          !\hyperlink{oid_8c_a3f24a7995a2a7aa587379ec6e1922e36}{oidComp}(context->request.msgAuthEngineId, context->request.msgAuthEngineIdLen,
320          context->informContextEngine, context->informContextEngineLen))
321       \{
322          \textcolor{comment}{//Information about the value of the msgUserName field is extracted}
323          \textcolor{comment}{//from the local configuration datastore}
324          user = \hyperlink{snmp__agent__usm_8c_adb4ad71f3b5167a13a2551f075c25110}{snmpFindUserEntry}(context, context->request.msgUserName,
325             context->request.msgUserNameLen);
326 
327          \textcolor{comment}{//Check security parameters}
328          error = \hyperlink{snmp__agent__usm_8c_aaa271cb3fa3eb1fd53dbb92b5bd2d7b3}{snmpCheckSecurityParameters}(user, &context->request,
329             context->informContextEngine, context->informContextEngineLen);
330          \textcolor{comment}{//Invalid security parameters?}
331          \textcolor{keywordflow}{if}(error)
332             \textcolor{keywordflow}{break};
333 
334          \textcolor{comment}{//Save the security profile associated with the current user}
335          context->user = *user;
336 
337          \textcolor{comment}{//Localize the authentication key with the engine ID of the}
338          \textcolor{comment}{//remote SNMP device}
339          \textcolor{keywordflow}{if}(context->user.authProtocol != \hyperlink{snmp__agent__usm_8h_a13c46b84c881bd15bad7093a7f3639e3a2c9ec503096d5f8c9f31352c4ad6488b}{SNMP\_AUTH\_PROTOCOL\_NONE})
340          \{
341             \textcolor{comment}{//Key localization algorithm}
342             error = \hyperlink{snmp__agent__usm_8c_a169a3d5db383131661599d6b19d81ee5}{snmpLocalizeKey}(context->user.authProtocol,
343                context->informContextEngine, context->informContextEngineLen,
344                &context->user.rawAuthKey, &context->user.localizedAuthKey);
345             \textcolor{comment}{//Any error to report?}
346             \textcolor{keywordflow}{if}(error)
347                \textcolor{keywordflow}{break};
348          \}
349 
350          \textcolor{comment}{//Localize the privacy key with the engine ID of the remote}
351          \textcolor{comment}{//SNMP device}
352          \textcolor{keywordflow}{if}(context->user.privProtocol != \hyperlink{snmp__agent__usm_8h_a13c46b84c881bd15bad7093a7f3639e3a2c9ec503096d5f8c9f31352c4ad6488b}{SNMP\_AUTH\_PROTOCOL\_NONE})
353          \{
354             \textcolor{comment}{//Key localization algorithm}
355             error = \hyperlink{snmp__agent__usm_8c_a169a3d5db383131661599d6b19d81ee5}{snmpLocalizeKey}(context->user.authProtocol,
356                context->informContextEngine, context->informContextEngineLen,
357                &context->user.rawPrivKey, &context->user.localizedPrivKey);
358             \textcolor{comment}{//Any error to report?}
359             \textcolor{keywordflow}{if}(error)
360                \textcolor{keywordflow}{break};
361          \}
362       \}
363       \textcolor{keywordflow}{else}
364 \textcolor{preprocessor}{#endif}
365       \{
366          \textcolor{comment}{//Information about the value of the msgUserName field is extracted}
367          \textcolor{comment}{//from the local configuration datastore}
368          user = \hyperlink{snmp__agent__usm_8c_adb4ad71f3b5167a13a2551f075c25110}{snmpFindUserEntry}(context, context->request.msgUserName,
369             context->request.msgUserNameLen);
370 
371          \textcolor{comment}{//Check security parameters}
372          error = \hyperlink{snmp__agent__usm_8c_aaa271cb3fa3eb1fd53dbb92b5bd2d7b3}{snmpCheckSecurityParameters}(user, &context->request,
373             context->contextEngine, context->contextEngineLen);
374          \textcolor{comment}{//Invalid security parameters?}
375          \textcolor{keywordflow}{if}(error)
376             \textcolor{keywordflow}{break};
377 
378          \textcolor{comment}{//Save the security profile associated with the current user}
379          context->user = *user;
380       \}
381 
382       \textcolor{comment}{//Check whether the authFlag is set}
383       \textcolor{keywordflow}{if}(context->request.msgFlags & \hyperlink{snmp__agent__usm_8h_aee33010d6b1b02fc5ceef6aad55044b0a8b9b4731d377864f4e13821af7cd3329}{SNMP\_MSG\_FLAG\_AUTH})
384       \{
385          \textcolor{comment}{//Authenticate incoming SNMP message}
386          error = \hyperlink{snmp__agent__usm_8c_a9b21dc4a7bbfee3d20fd1ef593d3b720}{snmpAuthIncomingMessage}(&context->user, &context->request);
387          \textcolor{comment}{//Data authentication failed?}
388          \textcolor{keywordflow}{if}(error)
389             \textcolor{keywordflow}{break};
390 
391          \textcolor{comment}{//Replay protection}
392          error = \hyperlink{snmp__agent__usm_8c_a4b77fa76e0bb98081df95572a83b4a4f}{snmpCheckEngineTime}(context, &context->request);
393          \textcolor{comment}{//Message outside of the time window?}
394          \textcolor{keywordflow}{if}(error)
395             \textcolor{keywordflow}{break};
396       \}
397 
398       \textcolor{comment}{//Check whether the privFlag is set}
399       \textcolor{keywordflow}{if}(context->request.msgFlags & \hyperlink{snmp__agent__usm_8h_aee33010d6b1b02fc5ceef6aad55044b0a09a0d3b1da3227488bf9ccc2cc8a48e2}{SNMP\_MSG\_FLAG\_PRIV})
400       \{
401          \textcolor{comment}{//Decrypt data}
402          error = \hyperlink{snmp__agent__usm_8c_a65bdcc2539a5a0b1d30fb1f33405fc5f}{snmpDecryptData}(&context->user, &context->request);
403          \textcolor{comment}{//Data decryption failed?}
404          \textcolor{keywordflow}{if}(error)
405             \textcolor{keywordflow}{break};
406       \}
407 
408       \textcolor{comment}{//Parse scopedPDU}
409       error = \hyperlink{snmp__agent__message_8c_ab071abb69f6040b7bac407d27551724b}{snmpParseScopedPdu}(&context->request);
410       \textcolor{comment}{//Any error to report?}
411       \textcolor{keywordflow}{if}(error)
412          \textcolor{keywordflow}{break};
413 
414       \textcolor{comment}{//Process PDU}
415       error = \hyperlink{snmp__agent__pdu_8c_a06e8ee51730d690fa823f52a33531093}{snmpProcessPdu}(context);
416       \textcolor{comment}{//Any error to report?}
417       \textcolor{keywordflow}{if}(error)
418         \textcolor{keywordflow}{break};
419 
420       \textcolor{comment}{//End of exception handling block}
421    \} \textcolor{keywordflow}{while}(0);
422 
423    \textcolor{comment}{//Check error indication}
424    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca6c9048c086c34674d0a711081c88c96a}{ERROR\_UNSUPPORTED\_SECURITY\_LEVEL} ||
425       error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5a869df5965a4b8665581bb828471f02}{ERROR\_NOT\_IN\_TIME\_WINDOW} ||
426       error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cadd2abf704c42af2698ebeccb4dd2bf85}{ERROR\_UNKNOWN\_USER\_NAME} ||
427       error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca308d5e2919a0cf0081bfc0e024a1bc4a}{ERROR\_UNKNOWN\_ENGINE\_ID} ||
428       error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca87e6ef81b46229cb03ed0a27e7f45c6e}{ERROR\_AUTHENTICATION\_FAILED} ||
429       error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca42ac4eb97a02112d45b5f0405c0393c1}{ERROR\_DECRYPTION\_FAILED} ||
430       error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca482602f6e1c8673549b5ef13cc5cee61}{ERROR\_UNAVAILABLE\_CONTEXT} ||
431       error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca487819dd3b521f88c597e47c4d6c1255}{ERROR\_UNKNOWN\_CONTEXT})
432    \{
433       \textcolor{comment}{//When the reportable flag is used, if its value is one, a Report-PDU}
434       \textcolor{comment}{//must be returned to the sender}
435       \textcolor{keywordflow}{if}(context->request.msgFlags & \hyperlink{snmp__agent__usm_8h_aee33010d6b1b02fc5ceef6aad55044b0a535d8aaf27fde907de003fadf1189cd7}{SNMP\_MSG\_FLAG\_REPORTABLE})
436          error = \hyperlink{snmp__agent__pdu_8c_aedc6c41f8217dc9f61809e09f4b99d62}{snmpFormatReportPdu}(context, error);
437 
438       \textcolor{comment}{//Any error to report?}
439       \textcolor{keywordflow}{if}(error)
440          \textcolor{keywordflow}{return} error;
441    \}
442    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
443    \{
444       \textcolor{comment}{//Continue processing}
445    \}
446    \textcolor{keywordflow}{else}
447    \{
448       \textcolor{comment}{//Stop processing}
449       \textcolor{keywordflow}{return} error;
450    \}
451 
452    \textcolor{comment}{//Any response?}
453    \textcolor{keywordflow}{if}(context->response.length > 0)
454    \{
455       \textcolor{comment}{//Format scopedPDU}
456       error = \hyperlink{snmp__agent__message_8c_a2d4b4ddfcafc940a9d9987ce8b8e91bc}{snmpWriteScopedPdu}(&context->response);
457       \textcolor{comment}{//Any error to report?}
458       \textcolor{keywordflow}{if}(error)
459          \textcolor{keywordflow}{return} error;
460 
461       \textcolor{comment}{//Check whether the privFlag is set}
462       \textcolor{keywordflow}{if}(context->response.msgFlags & \hyperlink{snmp__agent__usm_8h_aee33010d6b1b02fc5ceef6aad55044b0a09a0d3b1da3227488bf9ccc2cc8a48e2}{SNMP\_MSG\_FLAG\_PRIV})
463       \{
464          \textcolor{comment}{//Encrypt data}
465          error = \hyperlink{snmp__agent__usm_8c_a3cb6959af6963c5f5d593a28e7f72ee7}{snmpEncryptData}(&context->user, &context->response,
466             &context->salt);
467          \textcolor{comment}{//Any error to report?}
468          \textcolor{keywordflow}{if}(error)
469             \textcolor{keywordflow}{return} error;
470       \}
471 
472       \textcolor{comment}{//Format SNMP message header}
473       error = \hyperlink{snmp__agent__message_8c_add8b6631f98a66746371b33fabf28c91}{snmpWriteMessageHeader}(&context->response);
474       \textcolor{comment}{//Any error to report?}
475       \textcolor{keywordflow}{if}(error)
476          \textcolor{keywordflow}{return} error;
477 
478       \textcolor{comment}{//Check whether the authFlag is set}
479       \textcolor{keywordflow}{if}(context->response.msgFlags & \hyperlink{snmp__agent__usm_8h_aee33010d6b1b02fc5ceef6aad55044b0a8b9b4731d377864f4e13821af7cd3329}{SNMP\_MSG\_FLAG\_AUTH})
480       \{
481          \textcolor{comment}{//Authenticate outgoing SNMP message}
482          error = \hyperlink{snmp__agent__usm_8c_ac995a1d7cfdf5f25efd29f7e5c1f7c0d}{snmpAuthOutgoingMessage}(&context->user, &context->response);
483          \textcolor{comment}{//Any error to report?}
484          \textcolor{keywordflow}{if}(error)
485             \textcolor{keywordflow}{return} error;
486       \}
487    \}
488 
489    \textcolor{comment}{//Successful processing}
490    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
491 \textcolor{preprocessor}{#else}
492    \textcolor{comment}{//Report an error}
493    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
494 \textcolor{preprocessor}{#endif}
495 \}
\end{DoxyCode}
