\hypertarget{icecast__client_8c}{}\section{cyclone\+\_\+tcp/icecast/icecast\+\_\+client.c File Reference}
\label{icecast__client_8c}\index{cyclone\+\_\+tcp/icecast/icecast\+\_\+client.\+c@{cyclone\+\_\+tcp/icecast/icecast\+\_\+client.\+c}}


Icecast client.  


{\ttfamily \#include $<$stdlib.\+h$>$}\newline
{\ttfamily \#include \char`\"{}icecast/icecast\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}str.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{icecast__client_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~I\+C\+E\+C\+A\+S\+T\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{icecast__client_8c_a7b071590978b365e81ed49f05ac69782}{icecast\+Client\+Get\+Default\+Settings} (\hyperlink{structIcecastClientSettings}{Icecast\+Client\+Settings} $\ast$settings)
\begin{DoxyCompactList}\small\item\em Initialize settings with default values. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{icecast__client_8c_ac71cc80670422990d9ae0afff235f5f8}{icecast\+Client\+Init} (\hyperlink{structIcecastClientContext}{Icecast\+Client\+Context} $\ast$context, const \hyperlink{structIcecastClientSettings}{Icecast\+Client\+Settings} $\ast$settings)
\begin{DoxyCompactList}\small\item\em Icecast client initialization. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{icecast__client_8c_ac9787d8adf84fa14309651297a11e645}{icecast\+Client\+Start} (\hyperlink{structIcecastClientContext}{Icecast\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Start Icecast client. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{icecast__client_8c_a65cea6e3c1bd1c90600ae0e7efde8911}{icecast\+Client\+Read\+Stream} (\hyperlink{structIcecastClientContext}{Icecast\+Client\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t size, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t} timeout)
\begin{DoxyCompactList}\small\item\em Copy data from input stream. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{icecast__client_8c_a75cbb9f40dc094700e9c860ba0c53381}{icecast\+Client\+Read\+Metadata} (\hyperlink{structIcecastClientContext}{Icecast\+Client\+Context} $\ast$context, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$metadata, size\+\_\+t size, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Copy metadata from input stream. \end{DoxyCompactList}\item 
void \hyperlink{icecast__client_8c_aa294a309404f9d151b98c85f2b934da3}{icecast\+Client\+Task} (void $\ast$param)
\begin{DoxyCompactList}\small\item\em Icecast client task. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{icecast__client_8c_af978bba2e51e296445a6388459fcf939}{icecast\+Client\+Connect} (\hyperlink{structIcecastClientContext}{Icecast\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Connect to the specified Icecast server. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{icecast__client_8c_a5aef3b186aa1665a2059a7e83546a8c7}{icecast\+Client\+Process\+Metadata} (\hyperlink{structIcecastClientContext}{Icecast\+Client\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Decode metadata block. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Icecast client. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{icecast__client_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{icecast__client_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~I\+C\+E\+C\+A\+S\+T\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}



Definition at line 32 of file icecast\+\_\+client.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{icecast__client_8c_af978bba2e51e296445a6388459fcf939}\label{icecast__client_8c_af978bba2e51e296445a6388459fcf939}} 
\index{icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}!icecast\+Client\+Connect@{icecast\+Client\+Connect}}
\index{icecast\+Client\+Connect@{icecast\+Client\+Connect}!icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{icecast\+Client\+Connect()}{icecastClientConnect()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} icecast\+Client\+Connect (\begin{DoxyParamCaption}\item[{\hyperlink{structIcecastClientContext}{Icecast\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Connect to the specified Icecast server. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Icecast client context \\
\hline
\end{DoxyParams}


Definition at line 432 of file icecast\+\_\+client.\+c.


\begin{DoxyCode}
433 \{
434    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
435    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
436    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} serverPort;
437    \hyperlink{structIpAddr}{IpAddr} serverIpAddr;
438    \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{NetInterface} *interface;
439 
440    \textcolor{comment}{//Underlying network interface}
441    \textcolor{keyword}{interface }= context->settings.interface;
442 
443    \textcolor{comment}{//Force traffic to go through a proxy server?}
444    \textcolor{keywordflow}{if}(strcmp(interface->proxyName, \textcolor{stringliteral}{""}))
445    \{
446       \textcolor{comment}{//Icecast request template}
447       \textcolor{keyword}{const} \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} requestTemplate[] =
448          \textcolor{stringliteral}{"GET http://%s:%"} PRIu16 \textcolor{stringliteral}{"%s HTTP/1.1\(\backslash\)r\(\backslash\)n"}
449          \textcolor{stringliteral}{"Host: %s:%"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}
450          \textcolor{stringliteral}{"User-agent: UserAgent\(\backslash\)r\(\backslash\)n"}
451          \textcolor{stringliteral}{"Icy-MetaData: 1\(\backslash\)r\(\backslash\)n"}
452          \textcolor{stringliteral}{"Connection: close\(\backslash\)r\(\backslash\)n"}
453          \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"};
454 
455       \textcolor{comment}{//Format Icecast request}
456       length = sprintf(context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer}, requestTemplate,
457          context->\hyperlink{structIcecastClientContext_a7db51aaf2d8cf4dab51f043a38df29bb}{settings}.\hyperlink{structIcecastClientSettings_a03d74c882d8ab90fe1f1efd160836b34}{serverName}, context->\hyperlink{structIcecastClientContext_a7db51aaf2d8cf4dab51f043a38df29bb}{settings}.
      \hyperlink{structIcecastClientSettings_a882d219c88d29905c69a4cde1796a913}{serverPort},
458          context->\hyperlink{structIcecastClientContext_a7db51aaf2d8cf4dab51f043a38df29bb}{settings}.\hyperlink{structIcecastClientSettings_a81f6aaa6b4b3aacb4a267b058afa632e}{resource}, context->\hyperlink{structIcecastClientContext_a7db51aaf2d8cf4dab51f043a38df29bb}{settings}.
      \hyperlink{structIcecastClientSettings_a03d74c882d8ab90fe1f1efd160836b34}{serverName},
459          context->\hyperlink{structIcecastClientContext_a7db51aaf2d8cf4dab51f043a38df29bb}{settings}.\hyperlink{structIcecastClientSettings_a882d219c88d29905c69a4cde1796a913}{serverPort});
460 
461       \textcolor{comment}{//The specified proxy server can be either an IP or a host name}
462       error = \hyperlink{socket_8c_a9e1dd7c4ae3261bc4bb9e287c21d3c51}{getHostByName}(interface, interface->proxyName, &serverIpAddr, 0);
463       \textcolor{comment}{//Unable to resolve server name?}
464       \textcolor{keywordflow}{if}(error)
465          \textcolor{keywordflow}{return} error;
466 
467       \textcolor{comment}{//Proxy server port}
468       serverPort = interface->proxyPort;
469    \}
470    \textcolor{keywordflow}{else}
471    \{
472       \textcolor{comment}{//Icecast request template}
473       \textcolor{keyword}{const} \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} requestTemplate[] =
474          \textcolor{stringliteral}{"GET %s HTTP/1.1\(\backslash\)r\(\backslash\)n"}
475          \textcolor{stringliteral}{"Host: %s\(\backslash\)r\(\backslash\)n"}
476          \textcolor{stringliteral}{"User-agent: UserAgent\(\backslash\)r\(\backslash\)n"}
477          \textcolor{stringliteral}{"Icy-MetaData: 1\(\backslash\)r\(\backslash\)n"}
478          \textcolor{stringliteral}{"Connection: close\(\backslash\)r\(\backslash\)n"}
479          \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"};
480 
481       \textcolor{comment}{//Format Icecast request}
482       length = sprintf(context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer}, requestTemplate,
483          context->\hyperlink{structIcecastClientContext_a7db51aaf2d8cf4dab51f043a38df29bb}{settings}.\hyperlink{structIcecastClientSettings_a81f6aaa6b4b3aacb4a267b058afa632e}{resource}, context->\hyperlink{structIcecastClientContext_a7db51aaf2d8cf4dab51f043a38df29bb}{settings}.
      \hyperlink{structIcecastClientSettings_a03d74c882d8ab90fe1f1efd160836b34}{serverName});
484 
485       \textcolor{comment}{//The specified Icecast server can be either an IP or a host name}
486       error = \hyperlink{socket_8c_a9e1dd7c4ae3261bc4bb9e287c21d3c51}{getHostByName}(interface, context->\hyperlink{structIcecastClientContext_a7db51aaf2d8cf4dab51f043a38df29bb}{settings}.
      \hyperlink{structIcecastClientSettings_a03d74c882d8ab90fe1f1efd160836b34}{serverName}, &serverIpAddr, 0);
487       \textcolor{comment}{//Unable to resolve server name?}
488       \textcolor{keywordflow}{if}(error)
489          \textcolor{keywordflow}{return} error;
490 
491       \textcolor{comment}{//Icecast server port}
492       serverPort = context->\hyperlink{structIcecastClientContext_a7db51aaf2d8cf4dab51f043a38df29bb}{settings}.\hyperlink{structIcecastClientSettings_a882d219c88d29905c69a4cde1796a913}{serverPort};
493    \}
494 
495    \textcolor{comment}{//Open a TCP socket}
496    context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket} = \hyperlink{socket_8c_aa139bbf42b326b52eb08cf52771ac337}{socketOpen}(\hyperlink{socket_8h_aa78c7398fa81f7f62aa233159d4d8d97a9dab003c4dc9f7279e806241534d4859}{SOCKET\_TYPE\_STREAM}, 
      \hyperlink{socket_8h_a56eb0e60bda5d1d8a2e702228405d969ae0f38a6f025bce7700b3cf0ddd04bb2a}{SOCKET\_IP\_PROTO\_TCP});
497    \textcolor{comment}{//Failed to open socket?}
498    \textcolor{keywordflow}{if}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket} == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
499       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca528efe91b7a7e4bcc9a6de7d4b778c67}{ERROR\_OUT\_OF\_RESOURCES};
500 
501    \textcolor{comment}{//Start of exception handling block}
502    \textcolor{keywordflow}{do}
503    \{
504       \textcolor{comment}{//Associate the socket with the relevant interface}
505       error = \hyperlink{net__legacy_8h_a80bc49fa99e5654d8c345cd5c70d36d3}{socketBindToInterface}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket}, interface);
506       \textcolor{comment}{//Unable to bind the socket to the desired interface?}
507       \textcolor{keywordflow}{if}(error)
508          \textcolor{keywordflow}{break};
509 
510       \textcolor{comment}{//Adjust receive timeout}
511       error = \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket}, 
      \hyperlink{icecast__client_8h_a9ed738fc3ea8c4a243f325f52f07292d}{ICECAST\_CLIENT\_TIMEOUT});
512       \textcolor{comment}{//Any error to report?}
513       \textcolor{keywordflow}{if}(error)
514          \textcolor{keywordflow}{break};
515 
516       \textcolor{comment}{//Connect to the server}
517       error = \hyperlink{socket_8c_aff3e3c0abc332f42189fce8f362fbd63}{socketConnect}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket}, &serverIpAddr, serverPort);
518       \textcolor{comment}{//Connection with server failed?}
519       \textcolor{keywordflow}{if}(error)
520          \textcolor{keywordflow}{break};
521 
522       \textcolor{comment}{//Display Icecast request for debugging purpose}
523       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer});
524 
525       \textcolor{comment}{//Send request to the server}
526       error = \hyperlink{socket_8c_aa4eeb3a3294d14d681675ba9f0d3e568}{socketSend}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket}, context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer},
527          length, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16aa2859eda1a4e62564c15d72c25632b81}{SOCKET\_FLAG\_WAIT\_ACK});
528       \textcolor{comment}{//Failed to send the request?}
529       \textcolor{keywordflow}{if}(error)
530          \textcolor{keywordflow}{break};
531 
532       \textcolor{comment}{//Parse response header}
533       \textcolor{keywordflow}{while}(1)
534       \{
535          \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *separator;
536          \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *property;
537          \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
538 
539          \textcolor{comment}{//Read a line from the response header}
540          error = \hyperlink{socket_8c_a894c7bf0bfd4e3886fc584ed7ebbb087}{socketReceive}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket}, context->
      \hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer},
541             \hyperlink{icecast__client_8h_adeb8d82a71fa7bed56f9a1a2471b2a56}{ICECAST\_CLIENT\_METADATA\_MAX\_SIZE}, &length, 
      \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a8a9906d4aacdf7dd4b7203c86271006b}{SOCKET\_FLAG\_BREAK\_CRLF});
542          \textcolor{comment}{//Failed to read data?}
543          \textcolor{keywordflow}{if}(error)
544             \textcolor{keywordflow}{break};
545 
546          \textcolor{comment}{//Properly terminate the string with a NULL character}
547          context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer}[\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}] = \textcolor{charliteral}{'\(\backslash\)0'};
548 
549          \textcolor{comment}{//The end of the header has been reached?}
550          \textcolor{keywordflow}{if}(!strcmp(context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer}, \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}))
551             \textcolor{keywordflow}{break};
552 
553          \textcolor{comment}{//Check whether a separator is present}
554          separator = strchr(context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer}, \textcolor{charliteral}{':'});
555 
556          \textcolor{comment}{//Separator found?}
557          \textcolor{keywordflow}{if}(separator)
558          \{
559             \textcolor{comment}{//Split the line}
560             *separator = \textcolor{charliteral}{'\(\backslash\)0'};
561 
562             \textcolor{comment}{//Get property name and value}
563             \textcolor{keyword}{property} = \hyperlink{str_8c_ade9441b268416af6b024eb2ba3a5847e}{strTrimWhitespace}(context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer});
564             value = \hyperlink{str_8c_ade9441b268416af6b024eb2ba3a5847e}{strTrimWhitespace}(separator + 1);
565 
566             \textcolor{comment}{//Debug message}
567             \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"<%s>=<%s>\(\backslash\)r\(\backslash\)n"}, property, value);
568 
569             \textcolor{comment}{//Icy-Metaint property found?}
570             \textcolor{keywordflow}{if}(!\hyperlink{os__port__windows_8h_ac99ec3f1036620727a68aa8c25a8963c}{strcasecmp}(property, \textcolor{stringliteral}{"Icy-Metaint"}))
571             \{
572                \textcolor{comment}{//Retrieve the block size used by the Icecast server}
573                context->\hyperlink{structIcecastClientContext_a2efbe1b70c31245ba3305b8371a53fd5}{blockSize} = atoi(value);
574             \}
575          \}
576       \}
577 
578       \textcolor{comment}{//End of exception handling block}
579    \} \textcolor{keywordflow}{while}(0);
580 
581    \textcolor{comment}{//Check whether an error occurred}
582    \textcolor{keywordflow}{if}(error)
583    \{
584       \textcolor{comment}{//Clean up side effects}
585       \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket});
586    \}
587 
588    \textcolor{comment}{//Return status code}
589    \textcolor{keywordflow}{return} error;
590 \}
\end{DoxyCode}
\mbox{\Hypertarget{icecast__client_8c_a7b071590978b365e81ed49f05ac69782}\label{icecast__client_8c_a7b071590978b365e81ed49f05ac69782}} 
\index{icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}!icecast\+Client\+Get\+Default\+Settings@{icecast\+Client\+Get\+Default\+Settings}}
\index{icecast\+Client\+Get\+Default\+Settings@{icecast\+Client\+Get\+Default\+Settings}!icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{icecast\+Client\+Get\+Default\+Settings()}{icecastClientGetDefaultSettings()}}
{\footnotesize\ttfamily void icecast\+Client\+Get\+Default\+Settings (\begin{DoxyParamCaption}\item[{\hyperlink{structIcecastClientSettings}{Icecast\+Client\+Settings} $\ast$}]{settings }\end{DoxyParamCaption})}



Initialize settings with default values. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt out}  & {\em settings} & Structure that contains Icecast client settings \\
\hline
\end{DoxyParams}


Definition at line 49 of file icecast\+\_\+client.\+c.


\begin{DoxyCode}
50 \{
51    \textcolor{comment}{//Use default interface}
52    settings->\hyperlink{structIcecastClientSettings_a52a70857811f6337d011b835916e9fe2}{interface} = \hyperlink{net_8c_a991aba7eae4de79f30c6889d95cc6870}{netGetDefaultInterface}();
53 
54    \textcolor{comment}{//Icecast server name}
55    strcpy(settings->\hyperlink{structIcecastClientSettings_a03d74c882d8ab90fe1f1efd160836b34}{serverName}, \textcolor{stringliteral}{""});
56    \textcolor{comment}{//Icecast server port}
57    settings->\hyperlink{structIcecastClientSettings_a882d219c88d29905c69a4cde1796a913}{serverPort} = 8000;
58    \textcolor{comment}{//Requested resource}
59    strcpy(settings->\hyperlink{structIcecastClientSettings_a81f6aaa6b4b3aacb4a267b058afa632e}{resource}, \textcolor{stringliteral}{"/stream"});
60 
61    \textcolor{comment}{//Streaming buffer size}
62    settings->\hyperlink{structIcecastClientSettings_a6957adef33fd7059c925a5f89cb676fc}{bufferSize} = 80000;
63 \}
\end{DoxyCode}
\mbox{\Hypertarget{icecast__client_8c_ac71cc80670422990d9ae0afff235f5f8}\label{icecast__client_8c_ac71cc80670422990d9ae0afff235f5f8}} 
\index{icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}!icecast\+Client\+Init@{icecast\+Client\+Init}}
\index{icecast\+Client\+Init@{icecast\+Client\+Init}!icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{icecast\+Client\+Init()}{icecastClientInit()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} icecast\+Client\+Init (\begin{DoxyParamCaption}\item[{\hyperlink{structIcecastClientContext}{Icecast\+Client\+Context} $\ast$}]{context,  }\item[{const \hyperlink{structIcecastClientSettings}{Icecast\+Client\+Settings} $\ast$}]{settings }\end{DoxyParamCaption})}



Icecast client initialization. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Icecast client context \\
\hline
\mbox{\tt in}  & {\em settings} & Icecast client specific settings \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 73 of file icecast\+\_\+client.\+c.


\begin{DoxyCode}
75 \{
76    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
77 
78    \textcolor{comment}{//Debug message}
79    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Initializing Icecast client...\(\backslash\)r\(\backslash\)n"});
80 
81    \textcolor{comment}{//Ensure the parameters are valid}
82    \textcolor{keywordflow}{if}(!context || !settings)
83       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
84 
85    \textcolor{comment}{//Clear the Icecast client context}
86    memset(context, 0, \textcolor{keyword}{sizeof}(\hyperlink{structIcecastClientContext}{IcecastClientContext}));
87 
88    \textcolor{comment}{//Save user settings}
89    context->\hyperlink{structIcecastClientContext_a7db51aaf2d8cf4dab51f043a38df29bb}{settings} = *settings;
90    \textcolor{comment}{//Get the size of the circular buffer}
91    context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize} = settings->\hyperlink{structIcecastClientSettings_a6957adef33fd7059c925a5f89cb676fc}{bufferSize};
92 
93    \textcolor{comment}{//Start of exception handling block}
94    \textcolor{keywordflow}{do}
95    \{
96       \textcolor{comment}{//Allocate a memory block to hold the circular buffer}
97       context->\hyperlink{structIcecastClientContext_aa4f023d844d1886ad8e38864c4dba447}{streamBuffer} = \hyperlink{os__port__chibios_8c_ae86758dcd9fc3c98247ae19815987c9a}{osAllocMem}(context->
      \hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize});
98       \textcolor{comment}{//Failed to allocate memory?}
99       \textcolor{keywordflow}{if}(!context->\hyperlink{structIcecastClientContext_aa4f023d844d1886ad8e38864c4dba447}{streamBuffer})
100       \{
101          \textcolor{comment}{//Report an error to the calling function}
102          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
103          \textcolor{keywordflow}{break};
104       \}
105 
106       \textcolor{comment}{//Create mutex object to protect critical sections}
107       \textcolor{keywordflow}{if}(!\hyperlink{os__port__chibios_8c_a16627f901c807c29adf29a38fb1af16a}{osCreateMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex}))
108       \{
109          \textcolor{comment}{//Failed to create mutex}
110          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca528efe91b7a7e4bcc9a6de7d4b778c67}{ERROR\_OUT\_OF\_RESOURCES};
111          \textcolor{keywordflow}{break};
112       \}
113 
114       \textcolor{comment}{//Create event to get notified when the buffer is writable}
115       \textcolor{keywordflow}{if}(!\hyperlink{os__port__chibios_8c_ac1658f3fed1eb64efcd47e4503a9ef2e}{osCreateEvent}(&context->\hyperlink{structIcecastClientContext_a176c1feb7963f60a5dc8044f7d6002c4}{writeEvent}))
116       \{
117          \textcolor{comment}{//Failed to create event object}
118          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca528efe91b7a7e4bcc9a6de7d4b778c67}{ERROR\_OUT\_OF\_RESOURCES};
119          \textcolor{keywordflow}{break};
120       \}
121 
122       \textcolor{comment}{//The buffer is available for writing}
123       \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&context->\hyperlink{structIcecastClientContext_a176c1feb7963f60a5dc8044f7d6002c4}{writeEvent});
124 
125       \textcolor{comment}{//Create event to get notified when the buffer is readable}
126       \textcolor{keywordflow}{if}(!\hyperlink{os__port__chibios_8c_ac1658f3fed1eb64efcd47e4503a9ef2e}{osCreateEvent}(&context->\hyperlink{structIcecastClientContext_aad69417e9a2e8e5cd2b8e9543b2f7f4f}{readEvent}))
127       \{
128          \textcolor{comment}{//Failed to create event object}
129          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca528efe91b7a7e4bcc9a6de7d4b778c67}{ERROR\_OUT\_OF\_RESOURCES};
130          \textcolor{keywordflow}{break};
131       \}
132 
133       \textcolor{comment}{//Successful initialization}
134       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
135 
136       \textcolor{comment}{//End of exception handling block}
137    \} \textcolor{keywordflow}{while}(0);
138 
139    \textcolor{comment}{//Check whether an error occurred}
140    \textcolor{keywordflow}{if}(error)
141    \{
142       \textcolor{comment}{//Clean up side effects...}
143       \hyperlink{os__port__chibios_8c_a68e4fa4326f2031eab28b92a25f2d68d}{osFreeMem}(context->\hyperlink{structIcecastClientContext_aa4f023d844d1886ad8e38864c4dba447}{streamBuffer});
144       \hyperlink{os__port__chibios_8c_a2b0ba1e39227e4a4d52ee46bbee15c11}{osDeleteMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
145       \hyperlink{os__port__chibios_8c_a25827a49278bad6150b04b47165fda3d}{osDeleteEvent}(&context->\hyperlink{structIcecastClientContext_a176c1feb7963f60a5dc8044f7d6002c4}{writeEvent});
146       \hyperlink{os__port__chibios_8c_a25827a49278bad6150b04b47165fda3d}{osDeleteEvent}(&context->\hyperlink{structIcecastClientContext_aad69417e9a2e8e5cd2b8e9543b2f7f4f}{readEvent});
147    \}
148 
149    \textcolor{comment}{//Return status code}
150    \textcolor{keywordflow}{return} error;
151 \}
\end{DoxyCode}
\mbox{\Hypertarget{icecast__client_8c_a5aef3b186aa1665a2059a7e83546a8c7}\label{icecast__client_8c_a5aef3b186aa1665a2059a7e83546a8c7}} 
\index{icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}!icecast\+Client\+Process\+Metadata@{icecast\+Client\+Process\+Metadata}}
\index{icecast\+Client\+Process\+Metadata@{icecast\+Client\+Process\+Metadata}!icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{icecast\+Client\+Process\+Metadata()}{icecastClientProcessMetadata()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} icecast\+Client\+Process\+Metadata (\begin{DoxyParamCaption}\item[{\hyperlink{structIcecastClientContext}{Icecast\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Decode metadata block. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Icecast client context \\
\hline
\end{DoxyParams}


Definition at line 598 of file icecast\+\_\+client.\+c.


\begin{DoxyCode}
599 \{
600    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
601    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
602    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
603    \textcolor{keywordtype}{size\_t} metadataLength;
604 
605    \textcolor{comment}{//The metadata block begins with a single byte which indicates}
606    \textcolor{comment}{//how many 16-byte segments need to be read}
607    error = \hyperlink{socket_8c_a894c7bf0bfd4e3886fc584ed7ebbb087}{socketReceive}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket}, context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer},
608       \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}), &length, \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a39d0c7263a468e53133cbad1f6010df2}{SOCKET\_FLAG\_WAIT\_ALL});
609 
610    \textcolor{comment}{//Any error to report?}
611    \textcolor{keywordflow}{if}(error)
612       \textcolor{keywordflow}{return} error;
613    \textcolor{comment}{//Make sure the expected number of bytes have been received}
614    \textcolor{keywordflow}{if}(length != \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}))
615       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca45b6423571de90afab4931510e20123f}{ERROR\_INVALID\_METADATA};
616 
617    \textcolor{comment}{//Compute the length of the following metadata block}
618    metadataLength = context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer}[0] * 16;
619    \textcolor{comment}{//Limit the number of bytes to read}
620    n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(metadataLength, \hyperlink{icecast__client_8h_adeb8d82a71fa7bed56f9a1a2471b2a56}{ICECAST\_CLIENT\_METADATA\_MAX\_SIZE} - 1);
621 
622    \textcolor{comment}{//Read the metadata information}
623    error = \hyperlink{socket_8c_a894c7bf0bfd4e3886fc584ed7ebbb087}{socketReceive}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket}, context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer},
624       n, &length, \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a39d0c7263a468e53133cbad1f6010df2}{SOCKET\_FLAG\_WAIT\_ALL});
625 
626    \textcolor{comment}{//Any error to report?}
627    \textcolor{keywordflow}{if}(error)
628       \textcolor{keywordflow}{return} error;
629    \textcolor{comment}{//Make sure the expected number of bytes have been received}
630    \textcolor{keywordflow}{if}(length != n)
631       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca45b6423571de90afab4931510e20123f}{ERROR\_INVALID\_METADATA};
632 
633    \textcolor{comment}{//Enter critical section}
634    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
635 
636    \textcolor{comment}{//Save metadata information}
637    memcpy(context->\hyperlink{structIcecastClientContext_a746986eafa63d50323d7d4602b295867}{metadata}, context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer}, n);
638    \textcolor{comment}{//Terminate the string properly}
639    context->\hyperlink{structIcecastClientContext_a746986eafa63d50323d7d4602b295867}{metadata}[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}] = \textcolor{charliteral}{'\(\backslash\)0'};
640    \textcolor{comment}{//Record the length of the metadata}
641    context->\hyperlink{structIcecastClientContext_a425bb275c42c40b5ea5b62831c867937}{metadataLength} = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
642 
643    \textcolor{comment}{//Leave critical section}
644    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
645 
646    \textcolor{comment}{//Any metadata information received?}
647    \textcolor{keywordflow}{if}(n > 0)
648    \{
649       \textcolor{comment}{//Debug message}
650       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Icecast client: Metadata = <%s>\(\backslash\)r\(\backslash\)n"}, context->
      \hyperlink{structIcecastClientContext_a746986eafa63d50323d7d4602b295867}{metadata});
651    \}
652 
653    \textcolor{comment}{//Compute the number of bytes that have not been processed}
654    metadataLength -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
655 
656    \textcolor{comment}{//Read the complete metadata}
657    \textcolor{keywordflow}{while}(metadataLength > 0)
658    \{
659       \textcolor{comment}{//Compute the number of data to read at a time}
660       n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(metadataLength, \hyperlink{icecast__client_8h_adeb8d82a71fa7bed56f9a1a2471b2a56}{ICECAST\_CLIENT\_METADATA\_MAX\_SIZE});
661 
662       \textcolor{comment}{//Drop incoming data...}
663       error = \hyperlink{socket_8c_a894c7bf0bfd4e3886fc584ed7ebbb087}{socketReceive}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket}, context->\hyperlink{structIcecastClientContext_acc09df634fb4b61df4cd759e2f62a68a}{buffer},
664          n, &length, \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a39d0c7263a468e53133cbad1f6010df2}{SOCKET\_FLAG\_WAIT\_ALL});
665 
666       \textcolor{comment}{//Any error to report?}
667       \textcolor{keywordflow}{if}(error)
668          \textcolor{keywordflow}{return} error;
669       \textcolor{comment}{//Make sure the expected number of bytes have been received}
670       \textcolor{keywordflow}{if}(length != n)
671          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca45b6423571de90afab4931510e20123f}{ERROR\_INVALID\_METADATA};
672 
673       \textcolor{comment}{//Update byte counter}
674       metadataLength -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
675    \}
676 
677    \textcolor{comment}{//Successful processing}
678    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
679 \}
\end{DoxyCode}
\mbox{\Hypertarget{icecast__client_8c_a75cbb9f40dc094700e9c860ba0c53381}\label{icecast__client_8c_a75cbb9f40dc094700e9c860ba0c53381}} 
\index{icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}!icecast\+Client\+Read\+Metadata@{icecast\+Client\+Read\+Metadata}}
\index{icecast\+Client\+Read\+Metadata@{icecast\+Client\+Read\+Metadata}!icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{icecast\+Client\+Read\+Metadata()}{icecastClientReadMetadata()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} icecast\+Client\+Read\+Metadata (\begin{DoxyParamCaption}\item[{\hyperlink{structIcecastClientContext}{Icecast\+Client\+Context} $\ast$}]{context,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{metadata,  }\item[{size\+\_\+t}]{size,  }\item[{size\+\_\+t $\ast$}]{length }\end{DoxyParamCaption})}



Copy metadata from input stream. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Icecast client context \\
\hline
\mbox{\tt out}  & {\em metadata} & Pointer to the user buffer \\
\hline
\mbox{\tt in}  & {\em size} & Maximum number of bytes that can be read \\
\hline
\mbox{\tt out}  & {\em length} & Number of bytes that have been read \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 263 of file icecast\+\_\+client.\+c.


\begin{DoxyCode}
265 \{
266    \textcolor{comment}{//Ensure the parameters are valid}
267    \textcolor{keywordflow}{if}(!context || !metadata)
268       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
269 
270    \textcolor{comment}{//Enter critical section}
271    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
272 
273    \textcolor{comment}{//Limit the number of data to read}
274    *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(size, context->\hyperlink{structIcecastClientContext_a425bb275c42c40b5ea5b62831c867937}{metadataLength});
275    \textcolor{comment}{//Save metadata information}
276    memcpy(metadata, context->\hyperlink{structIcecastClientContext_a746986eafa63d50323d7d4602b295867}{metadata}, *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
277 
278    \textcolor{comment}{//Leave critical section}
279    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
280 
281    \textcolor{comment}{//Successful read operation}
282    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
283 \}
\end{DoxyCode}
\mbox{\Hypertarget{icecast__client_8c_a65cea6e3c1bd1c90600ae0e7efde8911}\label{icecast__client_8c_a65cea6e3c1bd1c90600ae0e7efde8911}} 
\index{icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}!icecast\+Client\+Read\+Stream@{icecast\+Client\+Read\+Stream}}
\index{icecast\+Client\+Read\+Stream@{icecast\+Client\+Read\+Stream}!icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{icecast\+Client\+Read\+Stream()}{icecastClientReadStream()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} icecast\+Client\+Read\+Stream (\begin{DoxyParamCaption}\item[{\hyperlink{structIcecastClientContext}{Icecast\+Client\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{size,  }\item[{size\+\_\+t $\ast$}]{length,  }\item[{\hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t}}]{timeout }\end{DoxyParamCaption})}



Copy data from input stream. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Icecast client context \\
\hline
\mbox{\tt out}  & {\em data} & Pointer to the user buffer \\
\hline
\mbox{\tt in}  & {\em size} & Maximum number of bytes that can be read \\
\hline
\mbox{\tt out}  & {\em length} & Number of bytes that have been read \\
\hline
\mbox{\tt in}  & {\em timeout} & Maximum time to wait before returning \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 190 of file icecast\+\_\+client.\+c.


\begin{DoxyCode}
192 \{
193    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} status;
194 
195    \textcolor{comment}{//Ensure the parameters are valid}
196    \textcolor{keywordflow}{if}(!context || !\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data})
197       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
198 
199    \textcolor{comment}{//Wait for the buffer to be available for reading}
200    status = \hyperlink{os__port__chibios_8c_a1dc707247e44dfefae5bec4a322fc78a}{osWaitForEvent}(&context->\hyperlink{structIcecastClientContext_aad69417e9a2e8e5cd2b8e9543b2f7f4f}{readEvent}, timeout);
201    \textcolor{comment}{//Timeout error?}
202    \textcolor{keywordflow}{if}(!status)
203       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT};
204 
205    \textcolor{comment}{//Enter critical section}
206    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
207    \textcolor{comment}{//Compute the number of bytes to read at a time}
208    *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(size, context->\hyperlink{structIcecastClientContext_a4afdc5c305afb3f928fa7e6932832949}{bufferLength});
209    \textcolor{comment}{//Leave critical section}
210    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
211 
212    \textcolor{comment}{//Check whether the specified data crosses buffer boundaries}
213    \textcolor{keywordflow}{if}((context->\hyperlink{structIcecastClientContext_a491b0ef46c2747c4ef269603df92b208}{readIndex} + *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}) <= context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize})
214    \{
215       \textcolor{comment}{//Copy the data}
216       memcpy(\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, context->\hyperlink{structIcecastClientContext_aa4f023d844d1886ad8e38864c4dba447}{streamBuffer} + context->\hyperlink{structIcecastClientContext_a491b0ef46c2747c4ef269603df92b208}{readIndex}, *
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
217    \}
218    \textcolor{keywordflow}{else}
219    \{
220       \textcolor{comment}{//Copy the first part of the data}
221       memcpy(\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, context->\hyperlink{structIcecastClientContext_aa4f023d844d1886ad8e38864c4dba447}{streamBuffer} + context->\hyperlink{structIcecastClientContext_a491b0ef46c2747c4ef269603df92b208}{readIndex},
222          context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize} - context->\hyperlink{structIcecastClientContext_a491b0ef46c2747c4ef269603df92b208}{readIndex});
223       \textcolor{comment}{//Wrap around to the beginning of the circular buffer}
224       memcpy(\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} + context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize} - context->\hyperlink{structIcecastClientContext_a491b0ef46c2747c4ef269603df92b208}{readIndex}, context->
      \hyperlink{structIcecastClientContext_aa4f023d844d1886ad8e38864c4dba447}{streamBuffer},
225          *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize} + context->\hyperlink{structIcecastClientContext_a491b0ef46c2747c4ef269603df92b208}{readIndex});
226    \}
227 
228    \textcolor{comment}{//Enter critical section}
229    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
230 
231    \textcolor{comment}{//Increment read index}
232    context->\hyperlink{structIcecastClientContext_a491b0ef46c2747c4ef269603df92b208}{readIndex} += *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
233    \textcolor{comment}{//Wrap around if necessary}
234    \textcolor{keywordflow}{if}(context->\hyperlink{structIcecastClientContext_a491b0ef46c2747c4ef269603df92b208}{readIndex} >= context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize})
235       context->\hyperlink{structIcecastClientContext_a491b0ef46c2747c4ef269603df92b208}{readIndex} -= context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize};
236 
237    \textcolor{comment}{//Update buffer length}
238    context->\hyperlink{structIcecastClientContext_a4afdc5c305afb3f928fa7e6932832949}{bufferLength} -= *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
239    \textcolor{comment}{//Check whether the buffer is available for writing}
240    \textcolor{keywordflow}{if}(context->\hyperlink{structIcecastClientContext_a4afdc5c305afb3f928fa7e6932832949}{bufferLength} < context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize})
241       \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&context->\hyperlink{structIcecastClientContext_a176c1feb7963f60a5dc8044f7d6002c4}{writeEvent});
242    \textcolor{comment}{//Check whether the buffer is available for reading}
243    \textcolor{keywordflow}{if}(context->\hyperlink{structIcecastClientContext_a4afdc5c305afb3f928fa7e6932832949}{bufferLength} > 0)
244       \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&context->\hyperlink{structIcecastClientContext_aad69417e9a2e8e5cd2b8e9543b2f7f4f}{readEvent});
245 
246    \textcolor{comment}{//Leave critical section}
247    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
248 
249    \textcolor{comment}{//Successful read operation}
250    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
251 \}
\end{DoxyCode}
\mbox{\Hypertarget{icecast__client_8c_ac9787d8adf84fa14309651297a11e645}\label{icecast__client_8c_ac9787d8adf84fa14309651297a11e645}} 
\index{icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}!icecast\+Client\+Start@{icecast\+Client\+Start}}
\index{icecast\+Client\+Start@{icecast\+Client\+Start}!icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{icecast\+Client\+Start()}{icecastClientStart()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} icecast\+Client\+Start (\begin{DoxyParamCaption}\item[{\hyperlink{structIcecastClientContext}{Icecast\+Client\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Start Icecast client. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Icecast client context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 160 of file icecast\+\_\+client.\+c.


\begin{DoxyCode}
161 \{
162    \hyperlink{structOsTask}{OsTask} *task;
163 
164    \textcolor{comment}{//Debug message}
165    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Starting Icecast client...\(\backslash\)r\(\backslash\)n"});
166 
167    \textcolor{comment}{//Create the Icecast client task}
168    task = \hyperlink{os__port__chibios_8c_aef8c6fe13a0df9e5cfaeb0501ecbac3e}{osCreateTask}(\textcolor{stringliteral}{"Icecast client"}, \hyperlink{icecast__client_8c_aa294a309404f9d151b98c85f2b934da3}{icecastClientTask},
169       context, \hyperlink{icecast__client_8h_a62076193137c3cd4622b41eacb2e8ab0}{ICECAST\_CLIENT\_STACK\_SIZE}, 
      \hyperlink{icecast__client_8h_a2d8aad0f38961832fcf84893b292d6fc}{ICECAST\_CLIENT\_PRIORITY});
170 
171    \textcolor{comment}{//Unable to create the task?}
172    \textcolor{keywordflow}{if}(task == \hyperlink{os__port_8h_aa673e52d8b286c3b613ad127aa85d536}{OS\_INVALID\_HANDLE})
173       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca528efe91b7a7e4bcc9a6de7d4b778c67}{ERROR\_OUT\_OF\_RESOURCES};
174 
175    \textcolor{comment}{//Successful processing}
176    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
177 \}
\end{DoxyCode}
\mbox{\Hypertarget{icecast__client_8c_aa294a309404f9d151b98c85f2b934da3}\label{icecast__client_8c_aa294a309404f9d151b98c85f2b934da3}} 
\index{icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}!icecast\+Client\+Task@{icecast\+Client\+Task}}
\index{icecast\+Client\+Task@{icecast\+Client\+Task}!icecast\+\_\+client.\+c@{icecast\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{icecast\+Client\+Task()}{icecastClientTask()}}
{\footnotesize\ttfamily void icecast\+Client\+Task (\begin{DoxyParamCaption}\item[{void $\ast$}]{param }\end{DoxyParamCaption})}



Icecast client task. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em param} & Pointer to the Icecast client context \\
\hline
\end{DoxyParams}


Definition at line 291 of file icecast\+\_\+client.\+c.


\begin{DoxyCode}
292 \{
293    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
294    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} end;
295    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
296    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
297    \textcolor{keywordtype}{size\_t} received;
298    \hyperlink{structIcecastClientContext}{IcecastClientContext} *context;
299 
300    \textcolor{comment}{//Task prologue}
301    \hyperlink{os__port__chibios_8h_abd3485ee30ab6a2de1208b0498a449cf}{osEnterTask}();
302 
303    \textcolor{comment}{//Retrieve the Icecast client context}
304    context = (\hyperlink{structIcecastClientContext}{IcecastClientContext} *) param;
305 
306    \textcolor{comment}{//Main loop}
307    \textcolor{keywordflow}{while}(1)
308    \{
309       \textcolor{comment}{//Debug message}
310       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Icecast client: Connecting to server %s port %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"},
311          context->\hyperlink{structIcecastClientContext_a7db51aaf2d8cf4dab51f043a38df29bb}{settings}.\hyperlink{structIcecastClientSettings_a03d74c882d8ab90fe1f1efd160836b34}{serverName}, context->\hyperlink{structIcecastClientContext_a7db51aaf2d8cf4dab51f043a38df29bb}{settings}.
      \hyperlink{structIcecastClientSettings_a882d219c88d29905c69a4cde1796a913}{serverPort});
312 
313       \textcolor{comment}{//Initiate a connection to the Icecast server}
314       error = \hyperlink{icecast__client_8c_af978bba2e51e296445a6388459fcf939}{icecastClientConnect}(context);
315 
316       \textcolor{comment}{//Connection to server failed?}
317       \textcolor{keywordflow}{if}(error)
318       \{
319          \textcolor{comment}{//Debug message}
320          \hyperlink{debug_8h_aaf9a5c67ad0ffd97cfca6d77c6af536f}{TRACE\_ERROR}(\textcolor{stringliteral}{"Icecast client: Connection to server failed!\(\backslash\)r\(\backslash\)n"});
321          \textcolor{comment}{//Recovery delay}
322          \hyperlink{os__port__chibios_8c_a69608590db97c707277aebf15be010e5}{osDelayTask}(\hyperlink{icecast__client_8h_ab1322c175d6073e5d6a1c48e8940edc7}{ICECAST\_RECOVERY\_DELAY});
323          \textcolor{comment}{//Try to reconnect...}
324          \textcolor{keywordflow}{continue};
325       \}
326 
327       \textcolor{comment}{//Debug message}
328       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Block size = %"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, context->
      \hyperlink{structIcecastClientContext_a2efbe1b70c31245ba3305b8371a53fd5}{blockSize});
329 
330       \textcolor{comment}{//Check block size}
331       \textcolor{keywordflow}{if}(!context->\hyperlink{structIcecastClientContext_a2efbe1b70c31245ba3305b8371a53fd5}{blockSize})
332       \{
333          \textcolor{comment}{//Close socket}
334          \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket});
335          \textcolor{comment}{//Recovery delay}
336          \hyperlink{os__port__chibios_8c_a69608590db97c707277aebf15be010e5}{osDelayTask}(\hyperlink{icecast__client_8h_ab1322c175d6073e5d6a1c48e8940edc7}{ICECAST\_RECOVERY\_DELAY});
337          \textcolor{comment}{//Try to reconnect...}
338          \textcolor{keywordflow}{continue};
339       \}
340 
341       \textcolor{comment}{//Initialize loop condition variable}
342       end = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
343 
344       \textcolor{comment}{//Read as much data as possible...}
345       \textcolor{keywordflow}{while}(!end)
346       \{
347          \textcolor{comment}{//Process the stream block by block}
348          length = context->\hyperlink{structIcecastClientContext_a2efbe1b70c31245ba3305b8371a53fd5}{blockSize};
349 
350          \textcolor{comment}{//Read current block}
351          \textcolor{keywordflow}{while}(!end && length > 0)
352          \{
353             \textcolor{comment}{//Wait for the buffer to be available for writing}
354             \hyperlink{os__port__chibios_8c_a1dc707247e44dfefae5bec4a322fc78a}{osWaitForEvent}(&context->\hyperlink{structIcecastClientContext_a176c1feb7963f60a5dc8044f7d6002c4}{writeEvent}, 
      \hyperlink{os__port_8h_ab893de6f8a0ec8b0e6dd8097ff398019}{INFINITE\_DELAY});
355 
356             \textcolor{comment}{//Enter critical section}
357             \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
358             \textcolor{comment}{//Compute the number of bytes to read at a time}
359             n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(length, context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize} - context->
      \hyperlink{structIcecastClientContext_a4afdc5c305afb3f928fa7e6932832949}{bufferLength});
360             \textcolor{comment}{//Leave critical section}
361             \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
362 
363             \textcolor{comment}{//Check whether the specified data crosses buffer boundaries}
364             \textcolor{keywordflow}{if}((context->\hyperlink{structIcecastClientContext_aa437385bcf8e7e12307da9d69ef2765a}{writeIndex} + n) > context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize})
365                n = context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize} - context->\hyperlink{structIcecastClientContext_aa437385bcf8e7e12307da9d69ef2765a}{writeIndex};
366 
367             \textcolor{comment}{//Receive data}
368             error = \hyperlink{socket_8c_a894c7bf0bfd4e3886fc584ed7ebbb087}{socketReceive}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket}, context->
      \hyperlink{structIcecastClientContext_aa4f023d844d1886ad8e38864c4dba447}{streamBuffer} +
369                context->\hyperlink{structIcecastClientContext_aa437385bcf8e7e12307da9d69ef2765a}{writeIndex}, n, &received, \hyperlink{socket_8h_a36c1d45d435e2f0ebe609c31d0c2da16a39d0c7263a468e53133cbad1f6010df2}{SOCKET\_FLAG\_WAIT\_ALL});
370 
371             \textcolor{comment}{//Any error to report?}
372             \textcolor{keywordflow}{if}(error)
373             \{
374                \textcolor{comment}{//Stop streaming data}
375                end = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
376             \}
377             \textcolor{keywordflow}{else}
378             \{
379                \textcolor{comment}{//Enter critical section}
380                \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
381 
382                \textcolor{comment}{//Increment write index}
383                context->\hyperlink{structIcecastClientContext_aa437385bcf8e7e12307da9d69ef2765a}{writeIndex} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
384                \textcolor{comment}{//Wrap around if necessary}
385                \textcolor{keywordflow}{if}(context->\hyperlink{structIcecastClientContext_aa437385bcf8e7e12307da9d69ef2765a}{writeIndex} >= context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize})
386                   context->\hyperlink{structIcecastClientContext_aa437385bcf8e7e12307da9d69ef2765a}{writeIndex} -= context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize};
387 
388                \textcolor{comment}{//Update buffer length}
389                context->\hyperlink{structIcecastClientContext_a4afdc5c305afb3f928fa7e6932832949}{bufferLength} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
390                \textcolor{comment}{//Check whether the buffer is available for writing}
391                \textcolor{keywordflow}{if}(context->\hyperlink{structIcecastClientContext_a4afdc5c305afb3f928fa7e6932832949}{bufferLength} < context->\hyperlink{structIcecastClientContext_aa5397800dc648f784e4b120e962d6632}{bufferSize})
392                   \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&context->\hyperlink{structIcecastClientContext_a176c1feb7963f60a5dc8044f7d6002c4}{writeEvent});
393                \textcolor{comment}{//Check whether the buffer is available for reading}
394                \textcolor{keywordflow}{if}(context->\hyperlink{structIcecastClientContext_a4afdc5c305afb3f928fa7e6932832949}{bufferLength} > 0)
395                   \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&context->\hyperlink{structIcecastClientContext_aad69417e9a2e8e5cd2b8e9543b2f7f4f}{readEvent});
396 
397                \textcolor{comment}{//Leave critical section}
398                \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&context->\hyperlink{structIcecastClientContext_a6010fc4c4397ce78077161827ca96e13}{mutex});
399 
400                \textcolor{comment}{//Update the total number of bytes that have been received}
401                context->\hyperlink{structIcecastClientContext_a743e7a8432fedd8a4e301276708d7420}{totalLength} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
402                \textcolor{comment}{//Number of remaining data to read}
403                length -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
404             \}
405          \}
406 
407          \textcolor{comment}{//Debug message}
408          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Icecast client: Total bytes received = %"} 
      \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, context->\hyperlink{structIcecastClientContext_a743e7a8432fedd8a4e301276708d7420}{totalLength});
409 
410          \textcolor{comment}{//Check whether the metadata block should be read}
411          \textcolor{keywordflow}{if}(!end)
412          \{
413             \textcolor{comment}{//Process the metadata block}
414             error = \hyperlink{icecast__client_8c_a5aef3b186aa1665a2059a7e83546a8c7}{icecastClientProcessMetadata}(context);
415             \textcolor{comment}{//Any error to report?}
416             \textcolor{keywordflow}{if}(error)
417                end = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
418          \}
419       \}
420 
421       \textcolor{comment}{//Close connection}
422       \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(context->\hyperlink{structIcecastClientContext_a2369e7cffe879fc3b2111beedcae5ce0}{socket});
423    \}
424 \}
\end{DoxyCode}
