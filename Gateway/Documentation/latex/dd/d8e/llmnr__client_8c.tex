\hypertarget{llmnr__client_8c}{}\section{cyclone\+\_\+tcp/llmnr/llmnr\+\_\+client.c File Reference}
\label{llmnr__client_8c}\index{cyclone\+\_\+tcp/llmnr/llmnr\+\_\+client.\+c@{cyclone\+\_\+tcp/llmnr/llmnr\+\_\+client.\+c}}


L\+L\+M\+NR client (Link-\/\+Local Multicast Name Resolution)  


{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv4/ipv4\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}llmnr/llmnr\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}llmnr/llmnr\+\_\+common.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dns/dns\+\_\+debug.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{llmnr__client_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_a8a2973772bec962af07b862acac259c0}{L\+L\+M\+N\+R\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{llmnr__client_8c_a2245c343cbb4b733364c5eee0e50376f}{llmnr\+Resolve} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}, \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bd}{Host\+Type} \hyperlink{ppp_8h_a1d127017fb298b889f4ba24752d08b8e}{type}, \hyperlink{structIpAddr}{Ip\+Addr} $\ast$\hyperlink{ipcp_8h_a11542dd5a4de5976a89188df3d53b42d}{ip\+Addr})
\begin{DoxyCompactList}\small\item\em Resolve a host name using L\+L\+M\+NR. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{llmnr__client_8c_ace620d24b0e68692a8eaf62850bb76b5}{llmnr\+Send\+Query} (\hyperlink{structDnsCacheEntry}{Dns\+Cache\+Entry} $\ast$entry)
\begin{DoxyCompactList}\small\item\em Send a L\+L\+M\+NR query message. \end{DoxyCompactList}\item 
void \hyperlink{llmnr__client_8c_a43549f7b310b2b49705df2eab78fdc75}{llmnr\+Process\+Response} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{structIpPseudoHeader}{Ip\+Pseudo\+Header} $\ast$pseudo\+Header, const \hyperlink{udp_8h_a6877bae1da8326482f5e311875e52bce}{Udp\+Header} $\ast$udp\+Header, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset}, void $\ast$param)
\begin{DoxyCompactList}\small\item\em Process L\+L\+M\+NR response message. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
L\+L\+M\+NR client (Link-\/\+Local Multicast Name Resolution) 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{llmnr__client_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{llmnr__client_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{llmnr\+\_\+client.\+c@{llmnr\+\_\+client.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!llmnr\+\_\+client.\+c@{llmnr\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_a8a2973772bec962af07b862acac259c0}{L\+L\+M\+N\+R\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file llmnr\+\_\+client.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{llmnr__client_8c_a43549f7b310b2b49705df2eab78fdc75}\label{llmnr__client_8c_a43549f7b310b2b49705df2eab78fdc75}} 
\index{llmnr\+\_\+client.\+c@{llmnr\+\_\+client.\+c}!llmnr\+Process\+Response@{llmnr\+Process\+Response}}
\index{llmnr\+Process\+Response@{llmnr\+Process\+Response}!llmnr\+\_\+client.\+c@{llmnr\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{llmnr\+Process\+Response()}{llmnrProcessResponse()}}
{\footnotesize\ttfamily void llmnr\+Process\+Response (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{structIpPseudoHeader}{Ip\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{const \hyperlink{udp_8h_a6877bae1da8326482f5e311875e52bce}{Udp\+Header} $\ast$}]{udp\+Header,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset,  }\item[{void $\ast$}]{param }\end{DoxyParamCaption})}



Process L\+L\+M\+NR response message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & U\+DP pseudo header \\
\hline
\mbox{\tt in}  & {\em udp\+Header} & U\+DP header \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the incoming L\+L\+M\+NR message \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first byte of the L\+L\+M\+NR message \\
\hline
\mbox{\tt in}  & {\em param} & Callback function parameter (not used) \\
\hline
\end{DoxyParams}


Definition at line 339 of file llmnr\+\_\+client.\+c.


\begin{DoxyCode}
341 \{
342    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
343    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} j;
344    \textcolor{keywordtype}{size\_t} pos;
345    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
346    \hyperlink{llmnr__common_8h_a53524a15a990495f2db298659ee4044f}{LlmnrHeader} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
347    \hyperlink{dns__common_8h_ac1ef063cc8bc932118463092c282f188}{DnsQuestion} *question;
348    \hyperlink{dns__common_8h_a801d4a933cd802d56c5450013b4c0969}{DnsResourceRecord} *record;
349    \hyperlink{structDnsCacheEntry}{DnsCacheEntry} *entry;
350 
351    \textcolor{comment}{//Retrieve the length of the LLMNR message}
352    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
353 
354    \textcolor{comment}{//Ensure the LLMNR message is valid}
355    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{llmnr__common_8h_a53524a15a990495f2db298659ee4044f}{LlmnrHeader}))
356       \textcolor{keywordflow}{return};
357    \textcolor{keywordflow}{if}(length > \hyperlink{dns__common_8h_a8578d0d73531c18ef02299543f9b232e}{DNS\_MESSAGE\_MAX\_SIZE})
358       \textcolor{keywordflow}{return};
359 
360    \textcolor{comment}{//Point to the LLMNR message header}
361    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
362    \textcolor{comment}{//Sanity check}
363    \textcolor{keywordflow}{if}(message == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
364       \textcolor{keywordflow}{return};
365 
366    \textcolor{comment}{//Debug message}
367    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"LLMNR message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
368    \textcolor{comment}{//Dump message}
369    \hyperlink{dns__debug_8c_aa6a38c4e74d8b059c64c30456d5c26ad}{dnsDumpMessage}((\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader} *) message, length);
370 
371    \textcolor{comment}{//Discard LLMNR queries}
372    \textcolor{keywordflow}{if}(!message->qr)
373       \textcolor{keywordflow}{return};
374 
375    \textcolor{comment}{//LLMNR messages received with an opcode other than zero must be silently}
376    \textcolor{comment}{//ignored}
377    \textcolor{keywordflow}{if}(message->opcode != \hyperlink{dns__common_8h_a9f7c2277e233fdeda3757e48282d3314af37862c9f8865288e6df0392930ec0a3}{DNS\_OPCODE\_QUERY})
378       \textcolor{keywordflow}{return};
379 
380    \textcolor{comment}{//LLMNR messages received with non-zero response codes must be silently}
381    \textcolor{comment}{//ignored}
382    \textcolor{keywordflow}{if}(message->rcode != \hyperlink{dns__common_8h_a4e14ab5567efbae42f570bc5bbd1d209a3673e53909ca3bf211abc3f0600158e0}{DNS\_RCODE\_NO\_ERROR})
383       \textcolor{keywordflow}{return};
384 
385    \textcolor{comment}{//LLMNR senders must silently discard LLMNR responses with QDCOUNT not}
386    \textcolor{comment}{//equal to one (refer to RFC 4795, section 2.1.1)}
387    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->qdcount) != 1)
388       \textcolor{keywordflow}{return};
389 
390    \textcolor{comment}{//Loop through DNS cache entries}
391    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dns__cache_8h_a0559240be0228278dd24ac2103aa0c66}{DNS\_CACHE\_SIZE}; i++)
392    \{
393       \textcolor{comment}{//Point to the current entry}
394       entry = &\hyperlink{dns__cache_8c_a459576a3a6c3ed0c90f544dabacc8377}{dnsCache}[i];
395 
396       \textcolor{comment}{//LLMNR name resolution in progress?}
397       \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3affcd994aeea92ea47ae5be4f6a2f7511}{DNS\_STATE\_IN\_PROGRESS} &&
398          entry->\hyperlink{structDnsCacheEntry_aeb800b57a9593f4749e3ae8ac03f4a71}{protocol} == \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94ae1dd21be774a259aa36f930440754000}{HOST\_NAME\_RESOLVER\_LLMNR})
399       \{
400          \textcolor{comment}{//Check destination port number}
401          \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_a694ec8e23fd08f447e85244478ace829}{port} == \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(udpHeader->destPort))
402          \{
403             \textcolor{comment}{//Compare identifier against the expected one}
404             \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->id) != entry->\hyperlink{structDnsCacheEntry_ab32547b4942b2db0f0c0bcb41458856d}{id})
405                \textcolor{keywordflow}{break};
406 
407             \textcolor{comment}{//Point to the first question}
408             pos = \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader});
409             \textcolor{comment}{//Parse domain name}
410             pos = \hyperlink{dns__common_8c_a6a5df1aead8f61467e9bf5e739ea5de0}{dnsParseName}((\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader} *) message, length, pos, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 0);
411 
412             \textcolor{comment}{//Invalid name?}
413             \textcolor{keywordflow}{if}(!pos)
414                \textcolor{keywordflow}{break};
415             \textcolor{comment}{//Malformed DNS message?}
416             \textcolor{keywordflow}{if}((pos + \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_ac1ef063cc8bc932118463092c282f188}{DnsQuestion})) > length)
417                \textcolor{keywordflow}{break};
418 
419             \textcolor{comment}{//Compare domain name}
420             \textcolor{keywordflow}{if}(\hyperlink{dns__common_8c_a09647d0528e53280cc0a35866cb2b224}{dnsCompareName}((\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader} *) message, length, \textcolor{keyword}{sizeof}(
      \hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader}),
421                entry->\hyperlink{structDnsCacheEntry_a81b2ed3b8465dd82a249f7141865dae6}{name}, 0))
422             \{
423                \textcolor{keywordflow}{break};
424             \}
425 
426             \textcolor{comment}{//Point to the corresponding entry}
427             question = \hyperlink{dns__common_8h_a66ca704f3f850dcbb2f3ceefe90afcc5}{DNS\_GET\_QUESTION}(message, pos);
428 
429             \textcolor{comment}{//Check the class of the query}
430             \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(question->qclass) != \hyperlink{dns__common_8h_aa541e7289dae8934f7f37e74c15cc5a5ae4d96c0329f035328ba190627f2782e9}{DNS\_RR\_CLASS\_IN})
431                \textcolor{keywordflow}{break};
432 
433             \textcolor{comment}{//Check the type of the query}
434             \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_a5520082c9b81d8244f858641785ac01e}{type} == \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdaebe58bd51c617e7f9024189e369dc8e9}{HOST\_TYPE\_IPV4} && \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(question->qtype) != 
      \hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a420fd47ef427589e0f1961e35b46756b}{DNS\_RR\_TYPE\_A})
435                \textcolor{keywordflow}{break};
436             \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_a5520082c9b81d8244f858641785ac01e}{type} == \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdaa1f89753ef33b5e8efcc253208e11c61}{HOST\_TYPE\_IPV6} && \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(question->qtype) != 
      \hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a4d0fc3b547030a6a0f32b3ca455927fe}{DNS\_RR\_TYPE\_AAAA})
437                \textcolor{keywordflow}{break};
438 
439             \textcolor{comment}{//Point to the first answer}
440             pos += \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_ac1ef063cc8bc932118463092c282f188}{DnsQuestion});
441 
442             \textcolor{comment}{//Parse answer resource records}
443             \textcolor{keywordflow}{for}(j = 0; j < \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->ancount); j++)
444             \{
445                \textcolor{comment}{//Parse domain name}
446                pos = \hyperlink{dns__common_8c_a6a5df1aead8f61467e9bf5e739ea5de0}{dnsParseName}((\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader} *) message, length, pos, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 0);
447                \textcolor{comment}{//Invalid name?}
448                \textcolor{keywordflow}{if}(!pos)
449                   \textcolor{keywordflow}{break};
450 
451                \textcolor{comment}{//Point to the associated resource record}
452                record = \hyperlink{dns__common_8h_a4f1a2722ba292be26060ec5693e1f280}{DNS\_GET\_RESOURCE\_RECORD}(message, pos);
453                \textcolor{comment}{//Point to the resource data}
454                pos += \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_a801d4a933cd802d56c5450013b4c0969}{DnsResourceRecord});
455 
456                \textcolor{comment}{//Make sure the resource record is valid}
457                \textcolor{keywordflow}{if}(pos > length)
458                   \textcolor{keywordflow}{break};
459                \textcolor{keywordflow}{if}((pos + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->rdlength)) > \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length})
460                   \textcolor{keywordflow}{break};
461 
462 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
463                \textcolor{comment}{//IPv4 address expected?}
464                \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_a5520082c9b81d8244f858641785ac01e}{type} == \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdaebe58bd51c617e7f9024189e369dc8e9}{HOST\_TYPE\_IPV4})
465                \{
466                   \textcolor{comment}{//A resource record found?}
467                   \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->rtype) == \hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a420fd47ef427589e0f1961e35b46756b}{DNS\_RR\_TYPE\_A} &&
468                      \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->rdlength) == \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr}))
469                   \{
470                      \textcolor{comment}{//Copy the IPv4 address}
471                      entry->\hyperlink{structDnsCacheEntry_aad3958e8dcdeb2eea1a99089b2a8f5b1}{ipAddr}.\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} = \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr});
472                      \hyperlink{ipv4_8h_a36a3af47ec7eec9b1781964eb0494b6f}{ipv4CopyAddr}(&entry->\hyperlink{structDnsCacheEntry_aad3958e8dcdeb2eea1a99089b2a8f5b1}{ipAddr}.\hyperlink{structIpAddr_a8de6f49cb0461f57c1eda49bb1088916}{ipv4Addr}, record->rdata);
473 
474                      \textcolor{comment}{//Save current time}
475                      entry->\hyperlink{structDnsCacheEntry_ae149514d2ade99ae033ecedd03a5daf0}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
476                      \textcolor{comment}{//Save TTL value}
477                      entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout} = \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(record->ttl) * 1000;
478                      \textcolor{comment}{//Limit the lifetime of the NBNS cache entries}
479                      entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout} = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout}, 
      \hyperlink{llmnr__client_8h_ac2a67f6741bf92838e0e40e6bab74d33}{LLMNR\_MAX\_LIFETIME});
480 
481                      \textcolor{comment}{//Unregister UDP callback function}
482                      \hyperlink{udp_8c_a1d915e0747de1926d096062048111e66}{udpDetachRxCallback}(interface, entry->
      \hyperlink{structDnsCacheEntry_a694ec8e23fd08f447e85244478ace829}{port});
483                      \textcolor{comment}{//Host name successfully resolved}
484                      entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} = \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3a29c9441f0fda002de6ba63d19b20f334}{DNS\_STATE\_RESOLVED};
485                      \textcolor{comment}{//Exit immediately}
486                      \textcolor{keywordflow}{break};
487                   \}
488                \}
489 \textcolor{preprocessor}{#endif}
490 \textcolor{preprocessor}{#if (IPV6\_SUPPORT == ENABLED)}
491                \textcolor{comment}{//IPv6 address expected?}
492                \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_a5520082c9b81d8244f858641785ac01e}{type} == \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdaa1f89753ef33b5e8efcc253208e11c61}{HOST\_TYPE\_IPV6})
493                \{
494                   \textcolor{comment}{//AAAA resource record found?}
495                   \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->rtype) == \hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a4d0fc3b547030a6a0f32b3ca455927fe}{DNS\_RR\_TYPE\_AAAA} &&
496                      \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->rdlength) == \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6Addr}))
497                   \{
498                      \textcolor{comment}{//Copy the IPv6 address}
499                      entry->\hyperlink{structDnsCacheEntry_aad3958e8dcdeb2eea1a99089b2a8f5b1}{ipAddr}.\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} = \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6Addr});
500                      \hyperlink{ipv6_8h_ac22b1fcd381d1c288e269cb8d164bfec}{ipv6CopyAddr}(&entry->\hyperlink{structDnsCacheEntry_aad3958e8dcdeb2eea1a99089b2a8f5b1}{ipAddr}.\hyperlink{structIpAddr_a9bc2340a9c0bc5a0b8aa9695b74e2ee6}{ipv6Addr}, record->rdata);
501 
502                      \textcolor{comment}{//Save current time}
503                      entry->\hyperlink{structDnsCacheEntry_ae149514d2ade99ae033ecedd03a5daf0}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
504                      \textcolor{comment}{//Save TTL value}
505                      entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout} = \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(record->ttl) * 1000;
506                      \textcolor{comment}{//Limit the lifetime of the NBNS cache entries}
507                      entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout} = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout}, 
      \hyperlink{llmnr__client_8h_ac2a67f6741bf92838e0e40e6bab74d33}{LLMNR\_MAX\_LIFETIME});
508 
509                      \textcolor{comment}{//Unregister UDP callback function}
510                      \hyperlink{udp_8c_a1d915e0747de1926d096062048111e66}{udpDetachRxCallback}(interface, entry->
      \hyperlink{structDnsCacheEntry_a694ec8e23fd08f447e85244478ace829}{port});
511                      \textcolor{comment}{//Host name successfully resolved}
512                      entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} = \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3a29c9441f0fda002de6ba63d19b20f334}{DNS\_STATE\_RESOLVED};
513                      \textcolor{comment}{//Exit immediately}
514                      \textcolor{keywordflow}{break};
515                   \}
516                \}
517 \textcolor{preprocessor}{#endif}
518                \textcolor{comment}{//Point to the next resource record}
519                pos += \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->rdlength);
520             \}
521 
522             \textcolor{comment}{//We are done}
523             \textcolor{keywordflow}{break};
524          \}
525       \}
526    \}
527 \}
\end{DoxyCode}
\mbox{\Hypertarget{llmnr__client_8c_a2245c343cbb4b733364c5eee0e50376f}\label{llmnr__client_8c_a2245c343cbb4b733364c5eee0e50376f}} 
\index{llmnr\+\_\+client.\+c@{llmnr\+\_\+client.\+c}!llmnr\+Resolve@{llmnr\+Resolve}}
\index{llmnr\+Resolve@{llmnr\+Resolve}!llmnr\+\_\+client.\+c@{llmnr\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{llmnr\+Resolve()}{llmnrResolve()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} llmnr\+Resolve (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{name,  }\item[{\hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bd}{Host\+Type}}]{type,  }\item[{\hyperlink{structIpAddr}{Ip\+Addr} $\ast$}]{ip\+Addr }\end{DoxyParamCaption})}



Resolve a host name using L\+L\+M\+NR. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em name} & Name of the host to be resolved \\
\hline
\mbox{\tt in}  & {\em type} & Host type (I\+Pv4 or I\+Pv6) \\
\hline
\mbox{\tt out}  & {\em ip\+Addr} & IP address corresponding to the specified host name \\
\hline
\end{DoxyParams}


Definition at line 54 of file llmnr\+\_\+client.\+c.


\begin{DoxyCode}
56 \{
57    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
58    \hyperlink{structDnsCacheEntry}{DnsCacheEntry} *entry;
59 
60 \textcolor{preprocessor}{#if (NET\_RTOS\_SUPPORT == ENABLED)}
61    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} delay;
62 
63    \textcolor{comment}{//Debug message}
64    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Resolving host name %s (LLMNR resolver)...\(\backslash\)r\(\backslash\)n"}, \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name});
65 \textcolor{preprocessor}{#endif}
66 
67    \textcolor{comment}{//Get exclusive access}
68    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
69 
70    \textcolor{comment}{//Search the DNS cache for the specified host name}
71    entry = \hyperlink{dns__cache_8c_a079712e25d65a0e902068e6fea3141ae}{dnsFindEntry}(interface, \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}, \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type}, 
      \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94ae1dd21be774a259aa36f930440754000}{HOST\_NAME\_RESOLVER\_LLMNR});
72 
73    \textcolor{comment}{//Check whether a matching entry has been found}
74    \textcolor{keywordflow}{if}(entry)
75    \{
76       \textcolor{comment}{//Host name already resolved?}
77       \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3a29c9441f0fda002de6ba63d19b20f334}{DNS\_STATE\_RESOLVED} ||
78          entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3ada34e46aacf8dc68d5c86add93157ea2}{DNS\_STATE\_PERMANENT})
79       \{
80          \textcolor{comment}{//Return the corresponding IP address}
81          *ipAddr = entry->\hyperlink{structDnsCacheEntry_aad3958e8dcdeb2eea1a99089b2a8f5b1}{ipAddr};
82          \textcolor{comment}{//Successful host name resolution}
83          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
84       \}
85       \textcolor{keywordflow}{else}
86       \{
87          \textcolor{comment}{//Host name resolution is in progress...}
88          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca14596397b69ee6fd1d74ca77fb55e186}{ERROR\_IN\_PROGRESS};
89       \}
90    \}
91    \textcolor{keywordflow}{else}
92    \{
93       \textcolor{comment}{//If no entry exists, then create a new one}
94       entry = \hyperlink{dns__cache_8c_ac154126efa899c325ee537727c9f5174}{dnsCreateEntry}();
95 
96       \textcolor{comment}{//Record the host name whose IP address is unknown}
97       strcpy(entry->\hyperlink{structDnsCacheEntry_a81b2ed3b8465dd82a249f7141865dae6}{name}, \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name});
98 
99       \textcolor{comment}{//Initialize DNS cache entry}
100       entry->\hyperlink{structDnsCacheEntry_a5520082c9b81d8244f858641785ac01e}{type} = \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type};
101       entry->\hyperlink{structDnsCacheEntry_aeb800b57a9593f4749e3ae8ac03f4a71}{protocol} = \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94ae1dd21be774a259aa36f930440754000}{HOST\_NAME\_RESOLVER\_LLMNR};
102       entry->\hyperlink{structDnsCacheEntry_ad0d0a0228fc29308f59f4b2d402758e6}{interface} = interface;
103 
104       \textcolor{comment}{//Get an ephemeral port number}
105       entry->\hyperlink{structDnsCacheEntry_a694ec8e23fd08f447e85244478ace829}{port} = \hyperlink{udp_8c_a9c0d754bee24d4408903597b0fd57fea}{udpGetDynamicPort}();
106 
107       \textcolor{comment}{//An identifier is used by the LLMNR client to match replies}
108       \textcolor{comment}{//with corresponding requests}
109       entry->\hyperlink{structDnsCacheEntry_ab32547b4942b2db0f0c0bcb41458856d}{id} = (\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}) \hyperlink{net_8c_a7bb00b31d641749ac8ce742261eb1f6d}{netGetRand}();
110 
111       \textcolor{comment}{//Callback function to be called when a LLMNR response is received}
112       error = \hyperlink{udp_8c_a38370e246c2908c710db4773a6423cee}{udpAttachRxCallback}(interface, entry->\hyperlink{structDnsCacheEntry_a694ec8e23fd08f447e85244478ace829}{port}, 
      \hyperlink{llmnr__client_8c_a43549f7b310b2b49705df2eab78fdc75}{llmnrProcessResponse},
113          \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
114 
115       \textcolor{comment}{//Check status code}
116       \textcolor{keywordflow}{if}(!error)
117       \{
118          \textcolor{comment}{//Initialize retransmission counter}
119          entry->\hyperlink{structDnsCacheEntry_aa1813da7ebe162f069a6079aa2365db1}{retransmitCount} = \hyperlink{llmnr__client_8h_a09c29df52f1e07698851a5cf8bf2c303}{LLMNR\_CLIENT\_MAX\_RETRIES};
120          \textcolor{comment}{//Send LLMNR query}
121          error = \hyperlink{llmnr__client_8c_ace620d24b0e68692a8eaf62850bb76b5}{llmnrSendQuery}(entry);
122 
123          \textcolor{comment}{//LLMNR message successfully sent?}
124          \textcolor{keywordflow}{if}(!error)
125          \{
126             \textcolor{comment}{//Save the time at which the query message was sent}
127             entry->\hyperlink{structDnsCacheEntry_ae149514d2ade99ae033ecedd03a5daf0}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
128             \textcolor{comment}{//Set timeout value}
129             entry->\hyperlink{structDnsCacheEntry_a5bf3981653624c3e313f7f364b526cdb}{timeout} = \hyperlink{llmnr__client_8h_a9e08e0d469e8edeb3e43f5b7b5d4de89}{LLMNR\_CLIENT\_INIT\_TIMEOUT};
130             entry->\hyperlink{structDnsCacheEntry_a4167197fb96cd19e4efdcd25184749c1}{maxTimeout} = \hyperlink{llmnr__client_8h_aea584faf1c6de0e93ffae2ff9be21567}{LLMNR\_CLIENT\_MAX\_TIMEOUT};
131             \textcolor{comment}{//Decrement retransmission counter}
132             entry->\hyperlink{structDnsCacheEntry_aa1813da7ebe162f069a6079aa2365db1}{retransmitCount}--;
133 
134             \textcolor{comment}{//Switch state}
135             entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} = \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3affcd994aeea92ea47ae5be4f6a2f7511}{DNS\_STATE\_IN\_PROGRESS};
136             \textcolor{comment}{//Host name resolution is in progress}
137             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca14596397b69ee6fd1d74ca77fb55e186}{ERROR\_IN\_PROGRESS};
138          \}
139          \textcolor{keywordflow}{else}
140          \{
141             \textcolor{comment}{//Unregister callback function}
142             \hyperlink{udp_8c_a1d915e0747de1926d096062048111e66}{udpDetachRxCallback}(interface, entry->\hyperlink{structDnsCacheEntry_a694ec8e23fd08f447e85244478ace829}{port});
143          \}
144       \}
145    \}
146 
147    \textcolor{comment}{//Release exclusive access}
148    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
149 
150 \textcolor{preprocessor}{#if (NET\_RTOS\_SUPPORT == ENABLED)}
151    \textcolor{comment}{//Set default polling interval}
152    delay = \hyperlink{dns__cache_8h_a437dbba366682cad097edc5d6e463d06}{DNS\_CACHE\_INIT\_POLLING\_INTERVAL};
153 
154    \textcolor{comment}{//Wait the host name resolution to complete}
155    \textcolor{keywordflow}{while}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca14596397b69ee6fd1d74ca77fb55e186}{ERROR\_IN\_PROGRESS})
156    \{
157       \textcolor{comment}{//Wait until the next polling period}
158       \hyperlink{os__port__chibios_8c_a69608590db97c707277aebf15be010e5}{osDelayTask}(delay);
159 
160       \textcolor{comment}{//Get exclusive access}
161       \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
162 
163       \textcolor{comment}{//Search the DNS cache for the specified host name}
164       entry = \hyperlink{dns__cache_8c_a079712e25d65a0e902068e6fea3141ae}{dnsFindEntry}(interface, \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}, \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type}, 
      \hyperlink{socket_8h_adb58068eb0cfd0e54798ac480eb19f94ae1dd21be774a259aa36f930440754000}{HOST\_NAME\_RESOLVER\_LLMNR});
165 
166       \textcolor{comment}{//Check whether a matching entry has been found}
167       \textcolor{keywordflow}{if}(entry)
168       \{
169          \textcolor{comment}{//Host name successfully resolved?}
170          \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_ac0f0a02b2f1fece9d83ec3345bb618c0}{state} == \hyperlink{dns__cache_8h_a57ef307e25adab4205cf584115875ef3a29c9441f0fda002de6ba63d19b20f334}{DNS\_STATE\_RESOLVED})
171          \{
172             \textcolor{comment}{//Return the corresponding IP address}
173             *ipAddr = entry->\hyperlink{structDnsCacheEntry_aad3958e8dcdeb2eea1a99089b2a8f5b1}{ipAddr};
174             \textcolor{comment}{//Successful host name resolution}
175             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
176          \}
177       \}
178       \textcolor{keywordflow}{else}
179       \{
180          \textcolor{comment}{//Host name resolution failed}
181          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
182       \}
183 
184       \textcolor{comment}{//Release exclusive access}
185       \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
186 
187       \textcolor{comment}{//Backoff support for less aggressive polling}
188       delay = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(delay * 2, \hyperlink{dns__cache_8h_aec92c7ec467dd08af86f9b5c77473b0e}{DNS\_CACHE\_MAX\_POLLING\_INTERVAL});
189    \}
190 
191    \textcolor{comment}{//Check status code}
192    \textcolor{keywordflow}{if}(error)
193    \{
194       \textcolor{comment}{//Failed to resolve host name}
195       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Host name resolution failed!\(\backslash\)r\(\backslash\)n"});
196    \}
197    \textcolor{keywordflow}{else}
198    \{
199       \textcolor{comment}{//Successful host name resolution}
200       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Host name resolved to %s...\(\backslash\)r\(\backslash\)n"}, \hyperlink{ip_8c_aecdb577de79f65f8c814d5f101c7c6ae}{ipAddrToString}(ipAddr, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
201    \}
202 \textcolor{preprocessor}{#endif}
203 
204    \textcolor{comment}{//Return status code}
205    \textcolor{keywordflow}{return} error;
206 \}
\end{DoxyCode}
\mbox{\Hypertarget{llmnr__client_8c_ace620d24b0e68692a8eaf62850bb76b5}\label{llmnr__client_8c_ace620d24b0e68692a8eaf62850bb76b5}} 
\index{llmnr\+\_\+client.\+c@{llmnr\+\_\+client.\+c}!llmnr\+Send\+Query@{llmnr\+Send\+Query}}
\index{llmnr\+Send\+Query@{llmnr\+Send\+Query}!llmnr\+\_\+client.\+c@{llmnr\+\_\+client.\+c}}
\subsubsection{\texorpdfstring{llmnr\+Send\+Query()}{llmnrSendQuery()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} llmnr\+Send\+Query (\begin{DoxyParamCaption}\item[{\hyperlink{structDnsCacheEntry}{Dns\+Cache\+Entry} $\ast$}]{entry }\end{DoxyParamCaption})}



Send a L\+L\+M\+NR query message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em entry} & Pointer to a valid D\+NS cache entry \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 215 of file llmnr\+\_\+client.\+c.


\begin{DoxyCode}
216 \{
217    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
218    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
219    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
220    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
221    \hyperlink{llmnr__common_8h_a53524a15a990495f2db298659ee4044f}{LlmnrHeader} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
222    \hyperlink{dns__common_8h_ac1ef063cc8bc932118463092c282f188}{DnsQuestion} *dnsQuestion;
223    \hyperlink{structIpAddr}{IpAddr} \hyperlink{ipcp_8h_a752e1719cf65f78dfec6274352cb56df}{destIpAddr};
224 
225 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
226    \textcolor{comment}{//An IPv4 address is expected?}
227    \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_a5520082c9b81d8244f858641785ac01e}{type} == \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdaebe58bd51c617e7f9024189e369dc8e9}{HOST\_TYPE\_IPV4})
228    \{
229       \textcolor{comment}{//The IPv4 link-scope multicast address to which a sender sends queries}
230       \textcolor{comment}{//is 224.0.0.252}
231       destIpAddr.\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} = \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr});
232       destIpAddr.\hyperlink{structIpAddr_a8de6f49cb0461f57c1eda49bb1088916}{ipv4Addr} = \hyperlink{llmnr__common_8h_a83c2092c6d0395e9a57a380db44ab9a6}{LLMNR\_IPV4\_MULTICAST\_ADDR};
233    \}
234    \textcolor{keywordflow}{else}
235 \textcolor{preprocessor}{#endif}
236 \textcolor{preprocessor}{#if (IPV6\_SUPPORT == ENABLED)}
237    \textcolor{comment}{//An IPv6 address is expected?}
238    \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_a5520082c9b81d8244f858641785ac01e}{type} == \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdaa1f89753ef33b5e8efcc253208e11c61}{HOST\_TYPE\_IPV6})
239    \{
240       \textcolor{comment}{//The IPv6 link-scope multicast address to which a sender sends queries}
241       \textcolor{comment}{//is ff02:0:0:0:0:0:1:3}
242       destIpAddr.\hyperlink{structIpAddr_ae61478bd1e79361fca7dd04a21aeb2f8}{length} = \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6Addr});
243       destIpAddr.\hyperlink{structIpAddr_a9bc2340a9c0bc5a0b8aa9695b74e2ee6}{ipv6Addr} = \hyperlink{llmnr__common_8c_a8c3efde1a1d0b22ebf1f766060a5bd31}{LLMNR\_IPV6\_MULTICAST\_ADDR};
244    \}
245    \textcolor{keywordflow}{else}
246 \textcolor{preprocessor}{#endif}
247    \textcolor{comment}{//Invalid host type?}
248    \{
249       \textcolor{comment}{//Report an error}
250       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
251    \}
252 
253    \textcolor{comment}{//Allocate a memory buffer to hold the LLMNR query message}
254    buffer = \hyperlink{udp_8c_a2c65cad7c5665fe03f94364e7e52b2be}{udpAllocBuffer}(\hyperlink{dns__common_8h_a8578d0d73531c18ef02299543f9b232e}{DNS\_MESSAGE\_MAX\_SIZE}, &offset);
255    \textcolor{comment}{//Failed to allocate buffer?}
256    \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
257       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
258 
259    \textcolor{comment}{//Point to the LLMNR header}
260    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, offset);
261 
262    \textcolor{comment}{//Format LLMNR query message}
263    message->id = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(entry->\hyperlink{structDnsCacheEntry_ab32547b4942b2db0f0c0bcb41458856d}{id});
264    message->qr = 0;
265    message->opcode = \hyperlink{dns__common_8h_a9f7c2277e233fdeda3757e48282d3314af37862c9f8865288e6df0392930ec0a3}{DNS\_OPCODE\_QUERY};
266    message->c = 0;
267    message->tc = 0;
268    message->t = 0;
269    message->z = 0;
270    message->rcode = \hyperlink{dns__common_8h_a4e14ab5567efbae42f570bc5bbd1d209a3673e53909ca3bf211abc3f0600158e0}{DNS\_RCODE\_NO\_ERROR};
271 
272    \textcolor{comment}{//The LLMNR query contains one question}
273    message->qdcount = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(1);
274    message->ancount = 0;
275    message->nscount = 0;
276    message->arcount = 0;
277 
278    \textcolor{comment}{//Length of the LLMNR query message}
279    length = \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader});
280 
281    \textcolor{comment}{//Encode the host name using the DNS name notation}
282    length += \hyperlink{dns__common_8c_aa375505b90ab1f2473b3084c97ace370}{dnsEncodeName}(entry->\hyperlink{structDnsCacheEntry_a81b2ed3b8465dd82a249f7141865dae6}{name}, message->questions);
283 
284    \textcolor{comment}{//Point to the corresponding question structure}
285    dnsQuestion = \hyperlink{dns__common_8h_a66ca704f3f850dcbb2f3ceefe90afcc5}{DNS\_GET\_QUESTION}(message, length);
286 
287 \textcolor{preprocessor}{#if (IPV4\_SUPPORT == ENABLED)}
288    \textcolor{comment}{//An IPv4 address is expected?}
289    \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_a5520082c9b81d8244f858641785ac01e}{type} == \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdaebe58bd51c617e7f9024189e369dc8e9}{HOST\_TYPE\_IPV4})
290    \{
291       \textcolor{comment}{//Fill in question structure}
292       dnsQuestion->qtype = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a420fd47ef427589e0f1961e35b46756b}{DNS\_RR\_TYPE\_A});
293       dnsQuestion->qclass = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{dns__common_8h_aa541e7289dae8934f7f37e74c15cc5a5ae4d96c0329f035328ba190627f2782e9}{DNS\_RR\_CLASS\_IN});
294    \}
295 \textcolor{preprocessor}{#endif}
296 \textcolor{preprocessor}{#if (IPV6\_SUPPORT == ENABLED)}
297    \textcolor{comment}{//An IPv6 address is expected?}
298    \textcolor{keywordflow}{if}(entry->\hyperlink{structDnsCacheEntry_a5520082c9b81d8244f858641785ac01e}{type} == \hyperlink{socket_8h_ab5e32e6fb9dfb43706584ab98de9a7bdaa1f89753ef33b5e8efcc253208e11c61}{HOST\_TYPE\_IPV6})
299    \{
300       \textcolor{comment}{//Fill in question structure}
301       dnsQuestion->qtype = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{dns__common_8h_aa24a9fb31b6fb3858a24a8d8682e23d1a4d0fc3b547030a6a0f32b3ca455927fe}{DNS\_RR\_TYPE\_AAAA});
302       dnsQuestion->qclass = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{dns__common_8h_aa541e7289dae8934f7f37e74c15cc5a5ae4d96c0329f035328ba190627f2782e9}{DNS\_RR\_CLASS\_IN});
303    \}
304 \textcolor{preprocessor}{#endif}
305 
306    \textcolor{comment}{//Update the length of the LLMNR query message}
307    length += \textcolor{keyword}{sizeof}(\hyperlink{dns__common_8h_ac1ef063cc8bc932118463092c282f188}{DnsQuestion});
308 
309    \textcolor{comment}{//Adjust the length of the multi-part buffer}
310    \hyperlink{net__mem_8c_ac0a46f396754e069dd1ee65cdc559b28}{netBufferSetLength}(buffer, offset + length);
311 
312    \textcolor{comment}{//Debug message}
313    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending LLMNR message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
314    \textcolor{comment}{//Dump message}
315    \hyperlink{dns__debug_8c_aa6a38c4e74d8b059c64c30456d5c26ad}{dnsDumpMessage}((\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader} *) message, length);
316 
317    \textcolor{comment}{//LLMNR queries are sent to and received on port 5355}
318    error = \hyperlink{udp_8c_a72a529f723ed1b75bfe98d0708f28eb1}{udpSendDatagramEx}(entry->\hyperlink{structDnsCacheEntry_ad0d0a0228fc29308f59f4b2d402758e6}{interface}, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, entry->
      \hyperlink{structDnsCacheEntry_a694ec8e23fd08f447e85244478ace829}{port},
319       &destIpAddr, \hyperlink{llmnr__common_8h_a2ee6754dce5ef0d2cd0a1adf230f436c}{LLMNR\_PORT}, buffer, offset, \hyperlink{ipv4_8h_a23220cfb7e593785a73a64a092829228}{IPV4\_DEFAULT\_TTL});
320 
321    \textcolor{comment}{//Free previously allocated memory}
322    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
323 
324    \textcolor{comment}{//Return status code}
325    \textcolor{keywordflow}{return} error;
326 \}
\end{DoxyCode}
