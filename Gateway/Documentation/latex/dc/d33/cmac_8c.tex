\hypertarget{cmac_8c}{}\section{cyclone\+\_\+crypto/mac/cmac.c File Reference}
\label{cmac_8c}\index{cyclone\+\_\+crypto/mac/cmac.\+c@{cyclone\+\_\+crypto/mac/cmac.\+c}}


C\+M\+AC (Cipher-\/based Message Authentication Code)  


{\ttfamily \#include \char`\"{}core/crypto.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mac/cmac.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{cmac_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{crypto__config_8h_a6afae3a9b63f9b55d979e667ee0e881d}{C\+R\+Y\+P\+T\+O\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{cmac_8c_a5e88ae804592f3f966f34a2feb4867ec}{cmac\+Compute} (const \hyperlink{structCipherAlgo}{Cipher\+Algo} $\ast$cipher, const void $\ast$key, size\+\_\+t key\+Len, const void $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t data\+Len, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$mac, size\+\_\+t mac\+Len)
\begin{DoxyCompactList}\small\item\em Compute C\+M\+AC using the specified cipher algorithm. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{cmac_8c_af8c3008b7a1591a933e550d09fcd239e}{cmac\+Init} (\hyperlink{structCmacContext}{Cmac\+Context} $\ast$context, const \hyperlink{structCipherAlgo}{Cipher\+Algo} $\ast$cipher, const void $\ast$key, size\+\_\+t key\+Len)
\begin{DoxyCompactList}\small\item\em Initialize C\+M\+AC calculation. \end{DoxyCompactList}\item 
void \hyperlink{cmac_8c_aa23960fbd781020dbc21d7d259d140d1}{cmac\+Reset} (\hyperlink{structCmacContext}{Cmac\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Reset C\+M\+AC context. \end{DoxyCompactList}\item 
void \hyperlink{cmac_8c_a7338ff0ac91c58e29b7b5cdc2d15f77f}{cmac\+Update} (\hyperlink{structCmacContext}{Cmac\+Context} $\ast$context, const void $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t data\+Len)
\begin{DoxyCompactList}\small\item\em Update the C\+M\+AC context with a portion of the message being hashed. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{cmac_8c_a67b03a5a585655580b3f8f2b256ee58a}{cmac\+Final} (\hyperlink{structCmacContext}{Cmac\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$mac, size\+\_\+t mac\+Len)
\begin{DoxyCompactList}\small\item\em Finish the C\+M\+AC calculation. \end{DoxyCompactList}\item 
void \hyperlink{cmac_8c_a018b32066500ac742fea131b26edcb54}{cmac\+Mul} (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$x, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a}, size\+\_\+t \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} rb)
\begin{DoxyCompactList}\small\item\em Multiplication by x in G\+F(2$^\wedge$128) \end{DoxyCompactList}\item 
void \hyperlink{cmac_8c_aea541f40e8dfac16b450f218e2f39a65}{cmac\+Xor\+Block} (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$x, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a}, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{nbns__common_8h_a4313c9563516f94387762ab05763456b}{b}, size\+\_\+t \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n})
\begin{DoxyCompactList}\small\item\em X\+OR operation. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
C\+M\+AC (Cipher-\/based Message Authentication Code) 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+Crypto Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.\hypertarget{tftp__server_8c_Description}{}\subsection{Description}\label{tftp__server_8c_Description}
C\+M\+AC is a block cipher-\/based M\+AC algorithm specified in N\+I\+ST SP 800-\/38B

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{cmac_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{cmac_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{cmac.\+c@{cmac.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!cmac.\+c@{cmac.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{crypto__config_8h_a6afae3a9b63f9b55d979e667ee0e881d}{C\+R\+Y\+P\+T\+O\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 36 of file cmac.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{cmac_8c_a5e88ae804592f3f966f34a2feb4867ec}\label{cmac_8c_a5e88ae804592f3f966f34a2feb4867ec}} 
\index{cmac.\+c@{cmac.\+c}!cmac\+Compute@{cmac\+Compute}}
\index{cmac\+Compute@{cmac\+Compute}!cmac.\+c@{cmac.\+c}}
\subsubsection{\texorpdfstring{cmac\+Compute()}{cmacCompute()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} cmac\+Compute (\begin{DoxyParamCaption}\item[{const \hyperlink{structCipherAlgo}{Cipher\+Algo} $\ast$}]{cipher,  }\item[{const void $\ast$}]{key,  }\item[{size\+\_\+t}]{key\+Len,  }\item[{const void $\ast$}]{data,  }\item[{size\+\_\+t}]{data\+Len,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{mac,  }\item[{size\+\_\+t}]{mac\+Len }\end{DoxyParamCaption})}



Compute C\+M\+AC using the specified cipher algorithm. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em cipher} & Cipher algorithm used to compute C\+M\+AC \\
\hline
\mbox{\tt in}  & {\em key} & Pointer to the secret key \\
\hline
\mbox{\tt in}  & {\em key\+Len} & Length of the secret key \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to the input message \\
\hline
\mbox{\tt in}  & {\em data\+Len} & Length of the input data \\
\hline
\mbox{\tt out}  & {\em mac} & Calculated M\+AC value \\
\hline
\mbox{\tt in}  & {\em mac\+Len} & Expected length of the M\+AC \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 58 of file cmac.\+c.


\begin{DoxyCode}
60 \{
61    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
62    \hyperlink{structCmacContext}{CmacContext} *context;
63 
64    \textcolor{comment}{//Allocate a memory buffer to hold the CMAC context}
65    context = \hyperlink{cyclone__crypto_2core_2crypto_8h_a48b53d16f66d31e5dcf82db3c1b882ba}{cryptoAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structCmacContext}{CmacContext}));
66 
67    \textcolor{comment}{//Successful memory allocation?}
68    \textcolor{keywordflow}{if}(context != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
69    \{
70       \textcolor{comment}{//Initialize the CMAC context}
71       error = \hyperlink{cmac_8c_af8c3008b7a1591a933e550d09fcd239e}{cmacInit}(context, cipher, key, keyLen);
72 
73       \textcolor{comment}{//Check status code}
74       \textcolor{keywordflow}{if}(!error)
75       \{
76          \textcolor{comment}{//Digest the message}
77          \hyperlink{cmac_8c_a7338ff0ac91c58e29b7b5cdc2d15f77f}{cmacUpdate}(context, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, dataLen);
78          \textcolor{comment}{//Finalize the CMAC computation}
79          error = \hyperlink{cmac_8c_a67b03a5a585655580b3f8f2b256ee58a}{cmacFinal}(context, mac, macLen);
80       \}
81 
82       \textcolor{comment}{//Free previously allocated memory}
83       \hyperlink{cyclone__crypto_2core_2crypto_8h_ac8a223b176683db4e9eed4162774f870}{cryptoFreeMem}(context);
84    \}
85    \textcolor{keywordflow}{else}
86    \{
87       \textcolor{comment}{//Failed to allocate memory}
88       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
89    \}
90 
91    \textcolor{comment}{//Return status code}
92    \textcolor{keywordflow}{return} error;
93 \}
\end{DoxyCode}
\mbox{\Hypertarget{cmac_8c_a67b03a5a585655580b3f8f2b256ee58a}\label{cmac_8c_a67b03a5a585655580b3f8f2b256ee58a}} 
\index{cmac.\+c@{cmac.\+c}!cmac\+Final@{cmac\+Final}}
\index{cmac\+Final@{cmac\+Final}!cmac.\+c@{cmac.\+c}}
\subsubsection{\texorpdfstring{cmac\+Final()}{cmacFinal()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} cmac\+Final (\begin{DoxyParamCaption}\item[{\hyperlink{structCmacContext}{Cmac\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{mac,  }\item[{size\+\_\+t}]{mac\+Len }\end{DoxyParamCaption})}



Finish the C\+M\+AC calculation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the C\+M\+AC context \\
\hline
\mbox{\tt out}  & {\em mac} & Calculated M\+AC value \\
\hline
\mbox{\tt in}  & {\em mac\+Len} & Expected length of the M\+AC \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 229 of file cmac.\+c.


\begin{DoxyCode}
230 \{
231    \textcolor{comment}{//Check the length of the MAC}
232    \textcolor{keywordflow}{if}(macLen < 1 || macLen > context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize})
233       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
234 
235    \textcolor{comment}{//Check whether the last block Mn is complete}
236    \textcolor{keywordflow}{if}(context->\hyperlink{structCmacContext_a0606cddcb5373f144b550578a441af42}{bufferLength} >= context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize})
237    \{
238       \textcolor{comment}{//The final block M(n) is XOR-ed with the first subkey K1}
239       \hyperlink{cmac_8c_aea541f40e8dfac16b450f218e2f39a65}{cmacXorBlock}(context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}, context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}, context->
      \hyperlink{structCmacContext_a5a42e4c3d8057ef628192ac02df4f14e}{k1},
240          context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize});
241    \}
242    \textcolor{keywordflow}{else}
243    \{
244       \textcolor{comment}{//Append padding string}
245       context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}[context->\hyperlink{structCmacContext_a0606cddcb5373f144b550578a441af42}{bufferLength}++] = 0x80;
246 
247       \textcolor{comment}{//Append the minimum number of zeroes to form a complete block}
248       \textcolor{keywordflow}{while}(context->\hyperlink{structCmacContext_a0606cddcb5373f144b550578a441af42}{bufferLength} < context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize})
249          context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}[context->\hyperlink{structCmacContext_a0606cddcb5373f144b550578a441af42}{bufferLength}++] = 0x00;
250 
251       \textcolor{comment}{//The final block M(n) is XOR-ed with the second subkey K2}
252       \hyperlink{cmac_8c_aea541f40e8dfac16b450f218e2f39a65}{cmacXorBlock}(context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}, context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}, context->
      \hyperlink{structCmacContext_a2ba78c0c3c708c399afba99350f07aea}{k2},
253          context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize});
254    \}
255 
256    \textcolor{comment}{//XOR M(n) with C(n-1)}
257    \hyperlink{cmac_8c_aea541f40e8dfac16b450f218e2f39a65}{cmacXorBlock}(context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}, context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}, context->
      \hyperlink{structCmacContext_a333c4734c4c2f959167d24c5d7f17f73}{mac},
258       context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize});
259 
260    \textcolor{comment}{//Compute T = CIPH(M(n) ^ C(n-1))}
261    context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->\hyperlink{structCipherAlgo_a61360848127c17c27fe5304588f7f211}{encryptBlock}(context->\hyperlink{structCmacContext_a30e362e52be60ba1407fffeb5d6957ec}{cipherContext}, context->
      \hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer},
262       context->\hyperlink{structCmacContext_a333c4734c4c2f959167d24c5d7f17f73}{mac});
263 
264    \textcolor{comment}{//Copy the resulting MAC value}
265    \textcolor{keywordflow}{if}(mac != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
266    \{
267       \textcolor{comment}{//It is possible to truncate the MAC. The result of the truncation}
268       \textcolor{comment}{//should be taken in most significant bits first order}
269       \hyperlink{cyclone__crypto_2core_2crypto_8h_a6724616c4014bb7e21f2660bd7b88be8}{cryptoMemcpy}(mac, context->\hyperlink{structCmacContext_a333c4734c4c2f959167d24c5d7f17f73}{mac}, macLen);
270    \}
271 
272    \textcolor{comment}{//Successful processing}
273    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
274 \}
\end{DoxyCode}
\mbox{\Hypertarget{cmac_8c_af8c3008b7a1591a933e550d09fcd239e}\label{cmac_8c_af8c3008b7a1591a933e550d09fcd239e}} 
\index{cmac.\+c@{cmac.\+c}!cmac\+Init@{cmac\+Init}}
\index{cmac\+Init@{cmac\+Init}!cmac.\+c@{cmac.\+c}}
\subsubsection{\texorpdfstring{cmac\+Init()}{cmacInit()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} cmac\+Init (\begin{DoxyParamCaption}\item[{\hyperlink{structCmacContext}{Cmac\+Context} $\ast$}]{context,  }\item[{const \hyperlink{structCipherAlgo}{Cipher\+Algo} $\ast$}]{cipher,  }\item[{const void $\ast$}]{key,  }\item[{size\+\_\+t}]{key\+Len }\end{DoxyParamCaption})}



Initialize C\+M\+AC calculation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the C\+M\+AC context to initialize \\
\hline
\mbox{\tt in}  & {\em cipher} & Cipher algorithm used to compute C\+M\+AC \\
\hline
\mbox{\tt in}  & {\em key} & Pointer to the secret key \\
\hline
\mbox{\tt in}  & {\em key\+Len} & Length of the secret key \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 105 of file cmac.\+c.


\begin{DoxyCode}
107 \{
108    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
109    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} rb;
110 
111    \textcolor{comment}{//CMAC supports only block ciphers whose block size is 64 or 128 bits}
112    \textcolor{keywordflow}{if}(cipher->\hyperlink{structCipherAlgo_a840c614fa1ae0f98a9350bc4f040dc7a}{type} != \hyperlink{cyclone__crypto_2core_2crypto_8h_ae03a6c8f32ed798857924d908aacc49bac347f6aa82618d4d57fe85cba6520ce9}{CIPHER\_ALGO\_TYPE\_BLOCK})
113       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
114 
115    \textcolor{comment}{//Rb is completely determined by the number of bits in a block}
116    \textcolor{keywordflow}{if}(cipher->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize} == 8)
117    \{
118       \textcolor{comment}{//If b = 64, then Rb = 11011}
119       rb = 0x1B;
120    \}
121    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(cipher->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize} == 16)
122    \{
123       \textcolor{comment}{//If b = 128, then Rb = 10000111}
124       rb = 0x87;
125    \}
126    \textcolor{keywordflow}{else}
127    \{
128       \textcolor{comment}{//Invalid block size}
129       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
130    \}
131 
132    \textcolor{comment}{//Cipher algorithm used to compute CMAC}
133    context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher} = cipher;
134 
135    \textcolor{comment}{//Initialize cipher context}
136    error = cipher->\hyperlink{structCipherAlgo_a5c1fa3eb89f3d31f01c2c501b94fdd79}{init}(context->\hyperlink{structCmacContext_a30e362e52be60ba1407fffeb5d6957ec}{cipherContext}, key, keyLen);
137    \textcolor{comment}{//Any error to report?}
138    \textcolor{keywordflow}{if}(error)
139       \textcolor{keywordflow}{return} error;
140 
141    \textcolor{comment}{//Let L = 0}
142    \hyperlink{cyclone__crypto_2core_2crypto_8h_ad4465436e4ff353300fba4896012e18b}{cryptoMemset}(context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}, 0, cipher->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize});
143    \textcolor{comment}{//Compute L = CIPH(L)}
144    cipher->\hyperlink{structCipherAlgo_a61360848127c17c27fe5304588f7f211}{encryptBlock}(context->\hyperlink{structCmacContext_a30e362e52be60ba1407fffeb5d6957ec}{cipherContext}, context->
      \hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}, context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer});
145 
146    \textcolor{comment}{//The subkey K1 is obtained by multiplying L by x in GF(2^b)}
147    \hyperlink{cmac_8c_a018b32066500ac742fea131b26edcb54}{cmacMul}(context->\hyperlink{structCmacContext_a5a42e4c3d8057ef628192ac02df4f14e}{k1}, context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}, cipher->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize}, rb);
148    \textcolor{comment}{//The subkey K2 is obtained by multiplying L by x^2 in GF(2^b)}
149    \hyperlink{cmac_8c_a018b32066500ac742fea131b26edcb54}{cmacMul}(context->\hyperlink{structCmacContext_a2ba78c0c3c708c399afba99350f07aea}{k2}, context->\hyperlink{structCmacContext_a5a42e4c3d8057ef628192ac02df4f14e}{k1}, cipher->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize}, rb);
150 
151    \textcolor{comment}{//Reset CMAC context}
152    \hyperlink{cmac_8c_aa23960fbd781020dbc21d7d259d140d1}{cmacReset}(context);
153 
154    \textcolor{comment}{//Successful initialization}
155    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
156 \}
\end{DoxyCode}
\mbox{\Hypertarget{cmac_8c_a018b32066500ac742fea131b26edcb54}\label{cmac_8c_a018b32066500ac742fea131b26edcb54}} 
\index{cmac.\+c@{cmac.\+c}!cmac\+Mul@{cmac\+Mul}}
\index{cmac\+Mul@{cmac\+Mul}!cmac.\+c@{cmac.\+c}}
\subsubsection{\texorpdfstring{cmac\+Mul()}{cmacMul()}}
{\footnotesize\ttfamily void cmac\+Mul (\begin{DoxyParamCaption}\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{x,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{a,  }\item[{size\+\_\+t}]{n,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{rb }\end{DoxyParamCaption})}



Multiplication by x in G\+F(2$^\wedge$128) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt out}  & {\em x} & Pointer to the output block \\
\hline
\mbox{\tt out}  & {\em a} & Pointer to the input block \\
\hline
\mbox{\tt in}  & {\em n} & Size of the block, in bytes \\
\hline
\mbox{\tt in}  & {\em rb} & Representation of the irreducible binary polynomial \\
\hline
\end{DoxyParams}


Definition at line 285 of file cmac.\+c.


\begin{DoxyCode}
286 \{
287    \textcolor{keywordtype}{size\_t} i;
288    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{aria_8c_a5dadc28804036d1b82e1dc027e95c9a6}{c};
289 
290    \textcolor{comment}{//Save the value of the most significant bit}
291    c = \hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a}[0] >> 7;
292 
293    \textcolor{comment}{//The multiplication of a polynomial by x in GF(2^128) corresponds to a}
294    \textcolor{comment}{//shift of indices}
295    \textcolor{keywordflow}{for}(i = 0; i < (\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n} - 1); i++)
296    \{
297       x[i] = (\hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a}[i] << 1) | (\hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a}[i + 1] >> 7);
298    \}
299 
300    \textcolor{comment}{//Shift the last byte of the block to the left}
301    x[i] = \hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a}[i] << 1;
302 
303    \textcolor{comment}{//If the highest term of the result is equal to one, then perform reduction}
304    x[i] ^= rb & ~(c - 1);
305 \}
\end{DoxyCode}
\mbox{\Hypertarget{cmac_8c_aa23960fbd781020dbc21d7d259d140d1}\label{cmac_8c_aa23960fbd781020dbc21d7d259d140d1}} 
\index{cmac.\+c@{cmac.\+c}!cmac\+Reset@{cmac\+Reset}}
\index{cmac\+Reset@{cmac\+Reset}!cmac.\+c@{cmac.\+c}}
\subsubsection{\texorpdfstring{cmac\+Reset()}{cmacReset()}}
{\footnotesize\ttfamily void cmac\+Reset (\begin{DoxyParamCaption}\item[{\hyperlink{structCmacContext}{Cmac\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Reset C\+M\+AC context. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the C\+M\+AC context \\
\hline
\end{DoxyParams}


Definition at line 164 of file cmac.\+c.


\begin{DoxyCode}
165 \{
166    \textcolor{comment}{//Clear input buffer}
167    \hyperlink{cyclone__crypto_2core_2crypto_8h_ad4465436e4ff353300fba4896012e18b}{cryptoMemset}(context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}, 0, context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->
      \hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize});
168    \textcolor{comment}{//Number of bytes in the buffer}
169    context->\hyperlink{structCmacContext_a0606cddcb5373f144b550578a441af42}{bufferLength} = 0;
170 
171    \textcolor{comment}{//Initialize MAC value}
172    \hyperlink{cyclone__crypto_2core_2crypto_8h_ad4465436e4ff353300fba4896012e18b}{cryptoMemset}(context->\hyperlink{structCmacContext_a333c4734c4c2f959167d24c5d7f17f73}{mac}, 0, context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize});
173 \}
\end{DoxyCode}
\mbox{\Hypertarget{cmac_8c_a7338ff0ac91c58e29b7b5cdc2d15f77f}\label{cmac_8c_a7338ff0ac91c58e29b7b5cdc2d15f77f}} 
\index{cmac.\+c@{cmac.\+c}!cmac\+Update@{cmac\+Update}}
\index{cmac\+Update@{cmac\+Update}!cmac.\+c@{cmac.\+c}}
\subsubsection{\texorpdfstring{cmac\+Update()}{cmacUpdate()}}
{\footnotesize\ttfamily void cmac\+Update (\begin{DoxyParamCaption}\item[{\hyperlink{structCmacContext}{Cmac\+Context} $\ast$}]{context,  }\item[{const void $\ast$}]{data,  }\item[{size\+\_\+t}]{data\+Len }\end{DoxyParamCaption})}



Update the C\+M\+AC context with a portion of the message being hashed. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the C\+M\+AC context \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to the input data \\
\hline
\mbox{\tt in}  & {\em data\+Len} & Length of the buffer \\
\hline
\end{DoxyParams}


Definition at line 183 of file cmac.\+c.


\begin{DoxyCode}
184 \{
185    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
186 
187    \textcolor{comment}{//Process the incoming data}
188    \textcolor{keywordflow}{while}(dataLen > 0)
189    \{
190       \textcolor{comment}{//Process message block by block}
191       \textcolor{keywordflow}{if}(context->\hyperlink{structCmacContext_a0606cddcb5373f144b550578a441af42}{bufferLength} == context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize})
192       \{
193          \textcolor{comment}{//XOR M(i) with C(i-1)}
194          \hyperlink{cmac_8c_aea541f40e8dfac16b450f218e2f39a65}{cmacXorBlock}(context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}, context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer}, context->
      \hyperlink{structCmacContext_a333c4734c4c2f959167d24c5d7f17f73}{mac},
195             context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize});
196 
197          \textcolor{comment}{//Compute C(i) = CIPH(M(i) ^ C(i-1))}
198          context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->\hyperlink{structCipherAlgo_a61360848127c17c27fe5304588f7f211}{encryptBlock}(context->\hyperlink{structCmacContext_a30e362e52be60ba1407fffeb5d6957ec}{cipherContext}, context->
      \hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer},
199             context->\hyperlink{structCmacContext_a333c4734c4c2f959167d24c5d7f17f73}{mac});
200 
201          \textcolor{comment}{//Empty the buffer}
202          context->\hyperlink{structCmacContext_a0606cddcb5373f144b550578a441af42}{bufferLength} = 0;
203       \}
204 
205       \textcolor{comment}{//The message is partitioned into complete blocks}
206       n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(dataLen, context->\hyperlink{structCmacContext_aaec26a5f11f59e011e72b94c18ca8b81}{cipher}->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize} - context->
      \hyperlink{structCmacContext_a0606cddcb5373f144b550578a441af42}{bufferLength});
207 
208       \textcolor{comment}{//Copy the data to the buffer}
209       \hyperlink{cyclone__crypto_2core_2crypto_8h_a6724616c4014bb7e21f2660bd7b88be8}{cryptoMemcpy}(context->\hyperlink{structCmacContext_ab4ba44f829299a64e9cccfc88ee1ee78}{buffer} + context->\hyperlink{structCmacContext_a0606cddcb5373f144b550578a441af42}{bufferLength}, 
      \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, n);
210       \textcolor{comment}{//Update the length of the buffer}
211       context->\hyperlink{structCmacContext_a0606cddcb5373f144b550578a441af42}{bufferLength} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
212 
213       \textcolor{comment}{//Advance the data pointer}
214       \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} + n;
215       \textcolor{comment}{//Remaining bytes to process}
216       dataLen -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
217    \}
218 \}
\end{DoxyCode}
\mbox{\Hypertarget{cmac_8c_aea541f40e8dfac16b450f218e2f39a65}\label{cmac_8c_aea541f40e8dfac16b450f218e2f39a65}} 
\index{cmac.\+c@{cmac.\+c}!cmac\+Xor\+Block@{cmac\+Xor\+Block}}
\index{cmac\+Xor\+Block@{cmac\+Xor\+Block}!cmac.\+c@{cmac.\+c}}
\subsubsection{\texorpdfstring{cmac\+Xor\+Block()}{cmacXorBlock()}}
{\footnotesize\ttfamily void cmac\+Xor\+Block (\begin{DoxyParamCaption}\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{x,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{a,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{b,  }\item[{size\+\_\+t}]{n }\end{DoxyParamCaption})}



X\+OR operation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt out}  & {\em x} & Block resulting from the X\+OR operation \\
\hline
\mbox{\tt in}  & {\em a} & First input block \\
\hline
\mbox{\tt in}  & {\em b} & Second input block \\
\hline
\mbox{\tt in}  & {\em n} & Size of the block, in bytes \\
\hline
\end{DoxyParams}


Definition at line 316 of file cmac.\+c.


\begin{DoxyCode}
317 \{
318    \textcolor{keywordtype}{size\_t} i;
319 
320    \textcolor{comment}{//Perform XOR operation}
321    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}; i++)
322    \{
323       x[i] = \hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a}[i] ^ \hyperlink{dtls__misc_8h_ab590318ac859d0e57e15c3dd6c62a605}{b}[i];
324    \}
325 \}
\end{DoxyCode}
