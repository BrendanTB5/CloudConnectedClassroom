\hypertarget{nbns__common_8c}{}\section{cyclone\+\_\+tcp/netbios/nbns\+\_\+common.c File Reference}
\label{nbns__common_8c}\index{cyclone\+\_\+tcp/netbios/nbns\+\_\+common.\+c@{cyclone\+\_\+tcp/netbios/nbns\+\_\+common.\+c}}


Definitions common to N\+B\+NS client and N\+B\+NS responder.  


{\ttfamily \#include $<$stdlib.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include $<$ctype.\+h$>$}\newline
{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}netbios/nbns\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}netbios/nbns\+\_\+responder.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}netbios/nbns\+\_\+common.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dns/dns\+\_\+debug.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{nbns__common_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_aaa0682b805a8d862dce0a66bfec167f0}{N\+B\+N\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{nbns__common_8c_ad9e000b477fa3dc3c5022422fbd870a2}{nbns\+Init} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em N\+B\+NS related initialization. \end{DoxyCompactList}\item 
void \hyperlink{nbns__common_8c_a2e6bb155e1564f9b4af864f8ea870b01}{nbns\+Process\+Message} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{structIpPseudoHeader}{Ip\+Pseudo\+Header} $\ast$pseudo\+Header, const \hyperlink{udp_8h_a6877bae1da8326482f5e311875e52bce}{Udp\+Header} $\ast$udp\+Header, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset}, void $\ast$param)
\begin{DoxyCompactList}\small\item\em Process incoming N\+B\+NS message. \end{DoxyCompactList}\item 
size\+\_\+t \hyperlink{nbns__common_8c_a2ffccdee63ab330c3b5720619c241fa8}{nbns\+Encode\+Name} (const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$src, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$dest)
\begin{DoxyCompactList}\small\item\em Encode a Net\+B\+I\+OS name. \end{DoxyCompactList}\item 
size\+\_\+t \hyperlink{nbns__common_8c_a883186d42b150c72047c02e9ee490770}{nbns\+Parse\+Name} (const \hyperlink{nbns__common_8h_a31dec1106c9cf3a1e242d985ac447238}{Nbns\+Header} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, size\+\_\+t pos, \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$dest)
\begin{DoxyCompactList}\small\item\em Decode a Net\+B\+I\+OS name. \end{DoxyCompactList}\item 
\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} \hyperlink{nbns__common_8c_af63e6277864b3b60286e2d72e977bf7a}{nbns\+Compare\+Name} (const \hyperlink{nbns__common_8h_a31dec1106c9cf3a1e242d985ac447238}{Nbns\+Header} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, size\+\_\+t pos, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name})
\begin{DoxyCompactList}\small\item\em Compare Net\+B\+I\+OS names. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Definitions common to N\+B\+NS client and N\+B\+NS responder. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{nbns__common_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{nbns__common_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{nbns\+\_\+common.\+c@{nbns\+\_\+common.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!nbns\+\_\+common.\+c@{nbns\+\_\+common.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_aaa0682b805a8d862dce0a66bfec167f0}{N\+B\+N\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file nbns\+\_\+common.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{nbns__common_8c_af63e6277864b3b60286e2d72e977bf7a}\label{nbns__common_8c_af63e6277864b3b60286e2d72e977bf7a}} 
\index{nbns\+\_\+common.\+c@{nbns\+\_\+common.\+c}!nbns\+Compare\+Name@{nbns\+Compare\+Name}}
\index{nbns\+Compare\+Name@{nbns\+Compare\+Name}!nbns\+\_\+common.\+c@{nbns\+\_\+common.\+c}}
\subsubsection{\texorpdfstring{nbns\+Compare\+Name()}{nbnsCompareName()}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} nbns\+Compare\+Name (\begin{DoxyParamCaption}\item[{const \hyperlink{nbns__common_8h_a31dec1106c9cf3a1e242d985ac447238}{Nbns\+Header} $\ast$}]{message,  }\item[{size\+\_\+t}]{length,  }\item[{size\+\_\+t}]{pos,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{name }\end{DoxyParamCaption})}



Compare Net\+B\+I\+OS names. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Pointer to the N\+B\+NS message \\
\hline
\mbox{\tt in}  & {\em length} & Length of the N\+B\+NS message \\
\hline
\mbox{\tt in}  & {\em pos} & Offset of the encoded domain name \\
\hline
\mbox{\tt in}  & {\em name} & N\+U\+L\+L-\/terminated string that holds a domain name \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
T\+R\+UE if the Net\+B\+I\+OS names match, else F\+A\+L\+SE 
\end{DoxyReturn}


Definition at line 285 of file nbns\+\_\+common.\+c.


\begin{DoxyCode}
287 \{
288    \textcolor{keywordtype}{size\_t} i;
289    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
290    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} \hyperlink{aria_8c_a5dadc28804036d1b82e1dc027e95c9a6}{c};
291 
292    \textcolor{comment}{//Cast the input NBNS message to byte array}
293    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *src = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
294 
295    \textcolor{comment}{//Malformed NBNS message?}
296    \textcolor{keywordflow}{if}((pos + 34) >= \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length})
297       \textcolor{keywordflow}{return} \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
298 
299    \textcolor{comment}{//Retrieve the length of the first label}
300    n = src[pos++];
301 
302    \textcolor{comment}{//NetBIOS names must be 32-byte long}
303    \textcolor{keywordflow}{if}(n != 32)
304       \textcolor{keywordflow}{return} \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
305 
306    \textcolor{comment}{//Parse the NetBIOS name}
307    \textcolor{keywordflow}{for}(i = 0; i < 15; i++)
308    \{
309       \textcolor{comment}{//Make sure the characters of the sequence are valid}
310       \textcolor{keywordflow}{if}(src[pos] < \textcolor{charliteral}{'A'} || src[pos] > \textcolor{charliteral}{'P'})
311          \textcolor{keywordflow}{return} \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
312       \textcolor{keywordflow}{if}(src[pos + 1] < \textcolor{charliteral}{'A'} || src[pos + 1] > \textcolor{charliteral}{'P'})
313          \textcolor{keywordflow}{return} \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
314 
315       \textcolor{comment}{//Combine nibbles to restore the original ASCII character}
316       c = ((src[pos] - \textcolor{charliteral}{'A'}) << 4) | (src[pos + 1] - \textcolor{charliteral}{'A'});
317 
318       \textcolor{comment}{//Padding character found?}
319       \textcolor{keywordflow}{if}(c == \textcolor{charliteral}{' '} && *\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name} == \textcolor{charliteral}{'\(\backslash\)0'})
320          \textcolor{keywordflow}{break};
321 
322       \textcolor{comment}{//Perform case insensitive comparison}
323       \textcolor{keywordflow}{if}(toupper((\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) \hyperlink{aria_8c_a5dadc28804036d1b82e1dc027e95c9a6}{c}) != toupper((\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) *\hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}))
324          \textcolor{keywordflow}{return} \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
325 
326       \textcolor{comment}{//Advance data pointer}
327       pos += 2;
328       \hyperlink{resource__manager_8h_a26532d7194d592ae8da35222073f36d6}{name}++;
329    \}
330 
331    \textcolor{comment}{//Skip padding characters}
332    \textcolor{keywordflow}{for}(; i < 16; i++)
333    \{
334       \textcolor{comment}{//Make sure the nibbles are valid}
335       \textcolor{keywordflow}{if}(src[pos] < \textcolor{charliteral}{'A'} || src[pos] > \textcolor{charliteral}{'P'})
336          \textcolor{keywordflow}{return} \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
337       \textcolor{keywordflow}{if}(src[pos + 1] < \textcolor{charliteral}{'A'} || src[pos + 1] > \textcolor{charliteral}{'P'})
338          \textcolor{keywordflow}{return} \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
339 
340       \textcolor{comment}{//Advance data pointer}
341       pos += 2;
342    \}
343 
344    \textcolor{comment}{//Retrieve the length of the next label}
345    n = src[pos];
346 
347    \textcolor{comment}{//NetBIOS names are terminated with a zero length count}
348    \textcolor{keywordflow}{if}(n != 0)
349       \textcolor{keywordflow}{return} \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
350 
351    \textcolor{comment}{//The NetBIOS names match}
352    \textcolor{keywordflow}{return} \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
353 \}
\end{DoxyCode}
\mbox{\Hypertarget{nbns__common_8c_a2ffccdee63ab330c3b5720619c241fa8}\label{nbns__common_8c_a2ffccdee63ab330c3b5720619c241fa8}} 
\index{nbns\+\_\+common.\+c@{nbns\+\_\+common.\+c}!nbns\+Encode\+Name@{nbns\+Encode\+Name}}
\index{nbns\+Encode\+Name@{nbns\+Encode\+Name}!nbns\+\_\+common.\+c@{nbns\+\_\+common.\+c}}
\subsubsection{\texorpdfstring{nbns\+Encode\+Name()}{nbnsEncodeName()}}
{\footnotesize\ttfamily size\+\_\+t nbns\+Encode\+Name (\begin{DoxyParamCaption}\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{src,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{dest }\end{DoxyParamCaption})}



Encode a Net\+B\+I\+OS name. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em src} & Pointer to the name to encode \\
\hline
\mbox{\tt out}  & {\em dest} & Pointer to the encoded Net\+B\+I\+OS name \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Length of the encoded Net\+B\+I\+OS name 
\end{DoxyReturn}


Definition at line 149 of file nbns\+\_\+common.\+c.


\begin{DoxyCode}
150 \{
151    \textcolor{keywordtype}{size\_t} i;
152    \textcolor{keywordtype}{size\_t} j;
153    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} \hyperlink{aria_8c_a5dadc28804036d1b82e1dc027e95c9a6}{c};
154 
155    \textcolor{comment}{//Point to first byte of the output buffer}
156    j = 0;
157 
158    \textcolor{comment}{//NetBIOS names are 32-byte long}
159    dest[j++] = 32;
160 
161    \textcolor{comment}{//Parse input name}
162    \textcolor{keywordflow}{for}(i = 0; i < 15 && src[i] != \textcolor{charliteral}{'\(\backslash\)0'}; i++)
163    \{
164       \textcolor{comment}{//Convert current character to uppercase}
165       c = toupper((\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) src[i]);
166 
167       \textcolor{comment}{//Encode character}
168       dest[j++] = \hyperlink{nbns__common_8h_ad1308214a45279d3f48cc59e8441aa69}{NBNS\_ENCODE\_H}(c);
169       dest[j++] = \hyperlink{nbns__common_8h_a606386a02d4ad5322acb2201fe5dc99b}{NBNS\_ENCODE\_L}(c);
170    \}
171 
172    \textcolor{comment}{//Pad NetBIOS name with space characters}
173    \textcolor{keywordflow}{for}(; i < 15; i++)
174    \{
175       \textcolor{comment}{//Encoded space character}
176       dest[j++] = \hyperlink{nbns__common_8h_ad1308214a45279d3f48cc59e8441aa69}{NBNS\_ENCODE\_H}(\textcolor{charliteral}{' '});
177       dest[j++] = \hyperlink{nbns__common_8h_a606386a02d4ad5322acb2201fe5dc99b}{NBNS\_ENCODE\_L}(\textcolor{charliteral}{' '});
178    \}
179 
180    \textcolor{comment}{//The 16th character is the NetBIOS suffix}
181    dest[j++] = \hyperlink{nbns__common_8h_ad1308214a45279d3f48cc59e8441aa69}{NBNS\_ENCODE\_H}(0);
182    dest[j++] = \hyperlink{nbns__common_8h_a606386a02d4ad5322acb2201fe5dc99b}{NBNS\_ENCODE\_L}(0);
183 
184    \textcolor{comment}{//Terminate the NetBIOS name with a zero length count}
185    dest[j++] = 0;
186 
187    \textcolor{comment}{//Return the length of the encoded NetBIOS name}
188    \textcolor{keywordflow}{return} j;
189 \}
\end{DoxyCode}
\mbox{\Hypertarget{nbns__common_8c_ad9e000b477fa3dc3c5022422fbd870a2}\label{nbns__common_8c_ad9e000b477fa3dc3c5022422fbd870a2}} 
\index{nbns\+\_\+common.\+c@{nbns\+\_\+common.\+c}!nbns\+Init@{nbns\+Init}}
\index{nbns\+Init@{nbns\+Init}!nbns\+\_\+common.\+c@{nbns\+\_\+common.\+c}}
\subsubsection{\texorpdfstring{nbns\+Init()}{nbnsInit()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} nbns\+Init (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



N\+B\+NS related initialization. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 56 of file nbns\+\_\+common.\+c.


\begin{DoxyCode}
57 \{
58    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
59 
60    \textcolor{comment}{//Callback function to be called when a NBNS message is received}
61    error = \hyperlink{udp_8c_a38370e246c2908c710db4773a6423cee}{udpAttachRxCallback}(interface, \hyperlink{nbns__common_8h_ab90f2670e8b34ee01fe3052166b7a279}{NBNS\_PORT}, 
      \hyperlink{nbns__common_8c_a2e6bb155e1564f9b4af864f8ea870b01}{nbnsProcessMessage}, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
62    \textcolor{comment}{//Any error to report?}
63    \textcolor{keywordflow}{if}(error)
64       \textcolor{keywordflow}{return} error;
65 
66    \textcolor{comment}{//Successful initialization}
67    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
68 \}
\end{DoxyCode}
\mbox{\Hypertarget{nbns__common_8c_a883186d42b150c72047c02e9ee490770}\label{nbns__common_8c_a883186d42b150c72047c02e9ee490770}} 
\index{nbns\+\_\+common.\+c@{nbns\+\_\+common.\+c}!nbns\+Parse\+Name@{nbns\+Parse\+Name}}
\index{nbns\+Parse\+Name@{nbns\+Parse\+Name}!nbns\+\_\+common.\+c@{nbns\+\_\+common.\+c}}
\subsubsection{\texorpdfstring{nbns\+Parse\+Name()}{nbnsParseName()}}
{\footnotesize\ttfamily size\+\_\+t nbns\+Parse\+Name (\begin{DoxyParamCaption}\item[{const \hyperlink{nbns__common_8h_a31dec1106c9cf3a1e242d985ac447238}{Nbns\+Header} $\ast$}]{message,  }\item[{size\+\_\+t}]{length,  }\item[{size\+\_\+t}]{pos,  }\item[{\hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{dest }\end{DoxyParamCaption})}



Decode a Net\+B\+I\+OS name. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Pointer to the N\+B\+NS message \\
\hline
\mbox{\tt in}  & {\em length} & Length of the N\+B\+NS message \\
\hline
\mbox{\tt in}  & {\em pos} & Offset of the name to decode \\
\hline
\mbox{\tt out}  & {\em dest} & Pointer to the decoded name (optional) \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The position of the resource record that immediately follows the Net\+B\+I\+OS name 
\end{DoxyReturn}


Definition at line 201 of file nbns\+\_\+common.\+c.


\begin{DoxyCode}
203 \{
204    \textcolor{keywordtype}{size\_t} i;
205    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
206    \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} \hyperlink{aria_8c_a5dadc28804036d1b82e1dc027e95c9a6}{c};
207 
208    \textcolor{comment}{//Cast the input NBNS message to byte array}
209    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *src = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
210 
211    \textcolor{comment}{//Malformed NBNS message?}
212    \textcolor{keywordflow}{if}((pos + 34) >= \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length})
213       \textcolor{keywordflow}{return} 0;
214 
215    \textcolor{comment}{//Retrieve the length of the first label}
216    n = src[pos++];
217 
218    \textcolor{comment}{//NetBIOS names must be 32-byte long}
219    \textcolor{keywordflow}{if}(n != 32)
220       \textcolor{keywordflow}{return} 0;
221 
222    \textcolor{comment}{//Parse the NetBIOS name}
223    \textcolor{keywordflow}{for}(i = 0; i < 15; i++)
224    \{
225       \textcolor{comment}{//Make sure the characters of the sequence are valid}
226       \textcolor{keywordflow}{if}(src[pos] < \textcolor{charliteral}{'A'} || src[pos] > \textcolor{charliteral}{'P'})
227          \textcolor{keywordflow}{return} 0;
228       \textcolor{keywordflow}{if}(src[pos + 1] < \textcolor{charliteral}{'A'} || src[pos + 1] > \textcolor{charliteral}{'P'})
229          \textcolor{keywordflow}{return} 0;
230 
231       \textcolor{comment}{//Combine nibbles to restore the original ASCII character}
232       c = ((src[pos] - \textcolor{charliteral}{'A'}) << 4) | (src[pos + 1] - \textcolor{charliteral}{'A'});
233 
234       \textcolor{comment}{//Padding character found?}
235       \textcolor{keywordflow}{if}(c == \textcolor{charliteral}{' '})
236          \textcolor{keywordflow}{break};
237 
238       \textcolor{comment}{//Save current ASCII character}
239       \textcolor{keywordflow}{if}(dest != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
240          *(dest++) = c;
241 
242       \textcolor{comment}{//Advance data pointer}
243       pos += 2;
244    \}
245 
246    \textcolor{comment}{//Skip padding characters}
247    \textcolor{keywordflow}{for}(; i < 16; i++)
248    \{
249       \textcolor{comment}{//Make sure the nibbles are valid}
250       \textcolor{keywordflow}{if}(src[pos] < \textcolor{charliteral}{'A'} || src[pos] > \textcolor{charliteral}{'P'})
251          \textcolor{keywordflow}{return} 0;
252       \textcolor{keywordflow}{if}(src[pos + 1] < \textcolor{charliteral}{'A'} || src[pos + 1] > \textcolor{charliteral}{'P'})
253          \textcolor{keywordflow}{return} 0;
254 
255       \textcolor{comment}{//Advance data pointer}
256       pos += 2;
257    \}
258 
259    \textcolor{comment}{//Retrieve the length of the next label}
260    n = src[pos++];
261 
262    \textcolor{comment}{//NetBIOS names are terminated with a zero length count}
263    \textcolor{keywordflow}{if}(n != 0)
264       \textcolor{keywordflow}{return} 0;
265 
266    \textcolor{comment}{//Properly terminate the string}
267    \textcolor{keywordflow}{if}(dest != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
268       *(dest++) = \textcolor{charliteral}{'\(\backslash\)0'};
269 
270    \textcolor{comment}{//Return the position of the resource record that}
271    \textcolor{comment}{//is immediately following the NetBIOS name}
272    \textcolor{keywordflow}{return} pos;
273 \}
\end{DoxyCode}
\mbox{\Hypertarget{nbns__common_8c_a2e6bb155e1564f9b4af864f8ea870b01}\label{nbns__common_8c_a2e6bb155e1564f9b4af864f8ea870b01}} 
\index{nbns\+\_\+common.\+c@{nbns\+\_\+common.\+c}!nbns\+Process\+Message@{nbns\+Process\+Message}}
\index{nbns\+Process\+Message@{nbns\+Process\+Message}!nbns\+\_\+common.\+c@{nbns\+\_\+common.\+c}}
\subsubsection{\texorpdfstring{nbns\+Process\+Message()}{nbnsProcessMessage()}}
{\footnotesize\ttfamily void nbns\+Process\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{structIpPseudoHeader}{Ip\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{const \hyperlink{udp_8h_a6877bae1da8326482f5e311875e52bce}{Udp\+Header} $\ast$}]{udp\+Header,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset,  }\item[{void $\ast$}]{param }\end{DoxyParamCaption})}



Process incoming N\+B\+NS message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & U\+DP pseudo header \\
\hline
\mbox{\tt in}  & {\em udp\+Header} & U\+DP header \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the incoming N\+B\+NS message \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first byte of the N\+B\+NS message \\
\hline
\mbox{\tt in}  & {\em param} & Callback function parameter (not used) \\
\hline
\end{DoxyParams}


Definition at line 81 of file nbns\+\_\+common.\+c.


\begin{DoxyCode}
83 \{
84    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
85    \hyperlink{nbns__common_8h_a31dec1106c9cf3a1e242d985ac447238}{NbnsHeader} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
86 
87    \textcolor{comment}{//Make sure the NBNS message was received from an IPv4 peer}
88    \textcolor{keywordflow}{if}(pseudoHeader->\hyperlink{structIpPseudoHeader_aeff06b8d9c3e7e2ef3cdb8a3a14e8ad2}{length} != \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a0e92b64e038199f1bb6383f2a76f30b6}{Ipv4PseudoHeader}))
89       \textcolor{keywordflow}{return};
90 
91    \textcolor{comment}{//Retrieve the length of the NBNS message}
92    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
93 
94    \textcolor{comment}{//Ensure the NBNS message is valid}
95    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{nbns__common_8h_a31dec1106c9cf3a1e242d985ac447238}{NbnsHeader}))
96       \textcolor{keywordflow}{return};
97    \textcolor{keywordflow}{if}(length > \hyperlink{dns__common_8h_a8578d0d73531c18ef02299543f9b232e}{DNS\_MESSAGE\_MAX\_SIZE})
98       \textcolor{keywordflow}{return};
99 
100    \textcolor{comment}{//Point to the NBNS message header}
101    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
102    \textcolor{comment}{//Sanity check}
103    \textcolor{keywordflow}{if}(message == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
104       \textcolor{keywordflow}{return};
105 
106    \textcolor{comment}{//Debug message}
107    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"NBNS message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
108    \textcolor{comment}{//Dump message}
109    \hyperlink{dns__debug_8c_aa6a38c4e74d8b059c64c30456d5c26ad}{dnsDumpMessage}((\hyperlink{dns__common_8h_a5caa7816ce531b3920054e974a0679f3}{DnsHeader} *) message, length);
110 
111    \textcolor{comment}{//NBNS messages received with an opcode other than zero must be silently}
112    \textcolor{comment}{//ignored}
113    \textcolor{keywordflow}{if}(message->opcode != \hyperlink{dns__common_8h_a9f7c2277e233fdeda3757e48282d3314af37862c9f8865288e6df0392930ec0a3}{DNS\_OPCODE\_QUERY})
114       \textcolor{keywordflow}{return};
115 
116    \textcolor{comment}{//NBNS messages received with non-zero response codes must be silently}
117    \textcolor{comment}{//ignored}
118    \textcolor{keywordflow}{if}(message->rcode != \hyperlink{dns__common_8h_a4e14ab5567efbae42f570bc5bbd1d209a3673e53909ca3bf211abc3f0600158e0}{DNS\_RCODE\_NO\_ERROR})
119       \textcolor{keywordflow}{return};
120 
121    \textcolor{comment}{//NBNS query received?}
122    \textcolor{keywordflow}{if}(!message->qr)
123    \{
124 \textcolor{preprocessor}{#if (NBNS\_RESPONDER\_SUPPORT == ENABLED)}
125       \textcolor{comment}{//Process incoming NBNS query message}
126       \hyperlink{nbns__responder_8c_a9a34493b2ffcd754326e8e9aed89eb92}{nbnsProcessQuery}(interface, &pseudoHeader->\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data},
127          udpHeader, message, length);
128 \textcolor{preprocessor}{#endif}
129    \}
130    \textcolor{comment}{//NBNS response received?}
131    \textcolor{keywordflow}{else}
132    \{
133 \textcolor{preprocessor}{#if (NBNS\_CLIENT\_SUPPORT == ENABLED)}
134       \textcolor{comment}{//Process incoming NBNS response message}
135       \hyperlink{nbns__client_8c_a183d1e4024a0f85d858a193cf5b02ddf}{nbnsProcessResponse}(interface, &pseudoHeader->\hyperlink{structIpPseudoHeader_a4dd0d91580f30918dc7b5d5a430dba6a}{ipv4Data},
136          udpHeader, message, length);
137 \textcolor{preprocessor}{#endif}
138    \}
139 \}
\end{DoxyCode}
