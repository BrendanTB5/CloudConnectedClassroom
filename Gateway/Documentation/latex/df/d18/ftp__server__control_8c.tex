\hypertarget{ftp__server__control_8c}{}\section{cyclone\+\_\+tcp/ftp/ftp\+\_\+server\+\_\+control.c File Reference}
\label{ftp__server__control_8c}\index{cyclone\+\_\+tcp/ftp/ftp\+\_\+server\+\_\+control.\+c@{cyclone\+\_\+tcp/ftp/ftp\+\_\+server\+\_\+control.\+c}}


F\+TP control connection.  


{\ttfamily \#include \char`\"{}ftp/ftp\+\_\+server.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ftp/ftp\+\_\+server\+\_\+commands.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ftp/ftp\+\_\+server\+\_\+control.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ftp/ftp\+\_\+server\+\_\+transport.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ftp/ftp\+\_\+server\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{ftp__server__control_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_ae398facab6ce5126fa3b23996aafefa5}{F\+T\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{ftp__server__control_8c_a0efabb0e0da0fbe9db7130a36319c36a}{ftp\+Server\+Register\+Control\+Channel\+Events} (\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$connection, \hyperlink{structSocketEventDesc}{Socket\+Event\+Desc} $\ast$event\+Desc)
\begin{DoxyCompactList}\small\item\em Register control connection events. \end{DoxyCompactList}\item 
void \hyperlink{ftp__server__control_8c_a4f1b63e4bea6acf0904237bf35449bb0}{ftp\+Server\+Process\+Control\+Channel\+Events} (\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$connection, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} event\+Flags)
\begin{DoxyCompactList}\small\item\em Control connection event handler. \end{DoxyCompactList}\item 
void \hyperlink{ftp__server__control_8c_ad16acd986947873a6317237e6c3f18aa}{ftp\+Server\+Accept\+Control\+Channel} (\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Accept control connection. \end{DoxyCompactList}\item 
void \hyperlink{ftp__server__control_8c_a555fc92281a4153d74f9617edea59df6}{ftp\+Server\+Close\+Control\+Channel} (\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Close control connection. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
F\+TP control connection. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{ftp__server__control_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{ftp__server__control_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{ftp\+\_\+server\+\_\+control.\+c@{ftp\+\_\+server\+\_\+control.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!ftp\+\_\+server\+\_\+control.\+c@{ftp\+\_\+server\+\_\+control.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_ae398facab6ce5126fa3b23996aafefa5}{F\+T\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file ftp\+\_\+server\+\_\+control.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{ftp__server__control_8c_ad16acd986947873a6317237e6c3f18aa}\label{ftp__server__control_8c_ad16acd986947873a6317237e6c3f18aa}} 
\index{ftp\+\_\+server\+\_\+control.\+c@{ftp\+\_\+server\+\_\+control.\+c}!ftp\+Server\+Accept\+Control\+Channel@{ftp\+Server\+Accept\+Control\+Channel}}
\index{ftp\+Server\+Accept\+Control\+Channel@{ftp\+Server\+Accept\+Control\+Channel}!ftp\+\_\+server\+\_\+control.\+c@{ftp\+\_\+server\+\_\+control.\+c}}
\subsubsection{\texorpdfstring{ftp\+Server\+Accept\+Control\+Channel()}{ftpServerAcceptControlChannel()}}
{\footnotesize\ttfamily void ftp\+Server\+Accept\+Control\+Channel (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Accept control connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP server context \\
\hline
\end{DoxyParams}


Definition at line 277 of file ftp\+\_\+server\+\_\+control.\+c.


\begin{DoxyCode}
278 \{
279    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
280    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
281    \hyperlink{socket_8h_aa85acfb0fa336ef495e6ba87fb88fc48}{Socket} *\hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket};
282    \hyperlink{structIpAddr}{IpAddr} clientIpAddr;
283    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} clientPort;
284    \hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{FtpClientConnection} *connection;
285 
286    \textcolor{comment}{//Accept incoming connection}
287    socket = \hyperlink{socket_8c_a00ec8a49fe1ee3597a0f7a2afbe46f00}{socketAccept}(context->socket, &clientIpAddr, &clientPort);
288 
289    \textcolor{comment}{//Make sure the socket handle is valid}
290    \textcolor{keywordflow}{if}(socket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
291    \{
292       \textcolor{comment}{//Force the socket to operate in non-blocking mode}
293       \hyperlink{socket_8c_abdd29ac0ba4a644c726f5b1280680099}{socketSetTimeout}(socket, 0);
294 
295       \textcolor{comment}{//Initialize pointer}
296       connection = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
297 
298       \textcolor{comment}{//Loop through the connection table}
299       \textcolor{keywordflow}{for}(i = 0; i < context->settings.maxConnections; i++)
300       \{
301          \textcolor{comment}{//Check the state of the current connection}
302          \textcolor{keywordflow}{if}(context->connections[i].controlChannel.state == 
      \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156bab3165039e718584ac932b07402ac08f2}{FTP\_CHANNEL\_STATE\_CLOSED} &&
303             context->connections[i].dataChannel.state == 
      \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156bab3165039e718584ac932b07402ac08f2}{FTP\_CHANNEL\_STATE\_CLOSED})
304          \{
305             \textcolor{comment}{//The current entry is free}
306             connection = &context->connections[i];
307             \textcolor{keywordflow}{break};
308          \}
309       \}
310 
311       \textcolor{comment}{//If the connection table runs out of space, then the client's connection}
312       \textcolor{comment}{//request is rejected}
313       \textcolor{keywordflow}{if}(connection != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
314       \{
315          \textcolor{comment}{//Clear the structure describing the connection}
316          memset(connection, 0, \textcolor{keyword}{sizeof}(\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{FtpClientConnection}));
317 
318          \textcolor{comment}{//Attach FTP server context}
319          connection->context = context;
320          \textcolor{comment}{//Underlying network interface}
321          connection->interface = \hyperlink{socket_8c_a5f7f436ed06e8781888517f29eba7610}{socketGetInterface}(socket);
322          \textcolor{comment}{//Save socket handle}
323          connection->controlChannel.socket = \hyperlink{bsd__socket_8c_a3f8f3a2707fbc87fc30aa70f31f53218}{socket};
324          \textcolor{comment}{//Initialize time stamp}
325          connection->timestamp = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
326          \textcolor{comment}{//Set home directory}
327          strcpy(connection->homeDir, context->settings.rootDir);
328          \textcolor{comment}{//Set current directory}
329          strcpy(connection->currentDir, context->settings.rootDir);
330          \textcolor{comment}{//Format greeting message}
331          strcpy(connection->response, \textcolor{stringliteral}{"220 Service ready for new user\(\backslash\)r\(\backslash\)n"});
332 
333          \textcolor{comment}{//Any registered callback?}
334          \textcolor{keywordflow}{if}(context->settings.connectCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
335          \{
336             \textcolor{comment}{//Invoke user callback function}
337             error = context->settings.connectCallback(connection, &clientIpAddr,
338                clientPort);
339          \}
340          \textcolor{keywordflow}{else}
341          \{
342             \textcolor{comment}{//No callback function defined}
343             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
344          \}
345 
346          \textcolor{comment}{//Check status code}
347          \textcolor{keywordflow}{if}(!error)
348          \{
349             \textcolor{comment}{//Debug message}
350             \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"FTP Server: Control connection established with client %s port %"}
351                PRIu16 \textcolor{stringliteral}{"...\(\backslash\)r\(\backslash\)n"}, \hyperlink{ip_8c_aecdb577de79f65f8c814d5f101c7c6ae}{ipAddrToString}(&clientIpAddr, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}), clientPort);
352 
353             \textcolor{comment}{//Debug message}
354             \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"FTP server: %s"}, connection->response);
355 
356             \textcolor{comment}{//Number of bytes in the response buffer}
357             connection->responseLen = strlen(connection->response);
358             connection->responsePos = 0;
359 
360             \textcolor{comment}{//Implicit TLS mode supported by the server?}
361             \textcolor{keywordflow}{if}((context->settings.mode & \hyperlink{ftp__server_8h_a8ae7b1433220e89fb8719e2a0117150aa0bc8c34044e4a31f671148f1870902e2}{FTP\_SERVER\_MODE\_IMPLICIT\_TLS}) != 0)
362             \{
363                \textcolor{comment}{//TLS initialization}
364                error = \hyperlink{ftp__server__transport_8c_a5cfa9b56f98d969fcc0ac892122a691c}{ftpServerOpenSecureChannel}(context,
365                   &connection->controlChannel, \hyperlink{ftp__server_8h_aee515d8a6cde76b93c7979bbda3bd1d3}{FTP\_SERVER\_TLS\_TX\_BUFFER\_SIZE},
366                   \hyperlink{ftp__server_8h_a15d40ad09228662bbc4ccecf14618709}{FTP\_SERVER\_MIN\_TLS\_RX\_BUFFER\_SIZE});
367 
368                \textcolor{comment}{//Check status code}
369                \textcolor{keywordflow}{if}(!error)
370                \{
371                   \textcolor{comment}{//Perform TLS handshake}
372                   connection->controlChannel.state = 
      \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156ba21aad3902f20c8ec868f94257a15f12c}{FTP\_CHANNEL\_STATE\_CONNECT\_TLS};
373                \}
374                \textcolor{keywordflow}{else}
375                \{
376                   \textcolor{comment}{//Close connection with the client}
377                   \hyperlink{ftp__server__misc_8c_a131bc4ee0544ae32eee4cf829f006a11}{ftpServerCloseConnection}(connection);
378                \}
379             \}
380             \textcolor{keywordflow}{else}
381             \{
382                \textcolor{comment}{//Enter default state}
383                connection->controlChannel.state = \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156bae764f1c2df0975ec9cd81a77639e8e9a}{FTP\_CHANNEL\_STATE\_IDLE};
384             \}
385          \}
386          \textcolor{keywordflow}{else}
387          \{
388             \textcolor{comment}{//The connection attempt has been refused}
389             memset(connection, 0, \textcolor{keyword}{sizeof}(\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{FtpClientConnection}));
390          \}
391       \}
392       \textcolor{keywordflow}{else}
393       \{
394          \textcolor{comment}{//The connection table runs out of space}
395          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca528efe91b7a7e4bcc9a6de7d4b778c67}{ERROR\_OUT\_OF\_RESOURCES};
396       \}
397 
398       \textcolor{comment}{//Check status code}
399       \textcolor{keywordflow}{if}(error)
400       \{
401          \textcolor{comment}{//Debug message}
402          \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"FTP Server: Connection refused with client %s port %"}
403             PRIu16 \textcolor{stringliteral}{"...\(\backslash\)r\(\backslash\)n"}, \hyperlink{ip_8c_aecdb577de79f65f8c814d5f101c7c6ae}{ipAddrToString}(&clientIpAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}), clientPort);
404 
405          \textcolor{comment}{//The FTP server cannot accept the incoming connection request}
406          \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(socket);
407       \}
408    \}
409 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__control_8c_a555fc92281a4153d74f9617edea59df6}\label{ftp__server__control_8c_a555fc92281a4153d74f9617edea59df6}} 
\index{ftp\+\_\+server\+\_\+control.\+c@{ftp\+\_\+server\+\_\+control.\+c}!ftp\+Server\+Close\+Control\+Channel@{ftp\+Server\+Close\+Control\+Channel}}
\index{ftp\+Server\+Close\+Control\+Channel@{ftp\+Server\+Close\+Control\+Channel}!ftp\+\_\+server\+\_\+control.\+c@{ftp\+\_\+server\+\_\+control.\+c}}
\subsubsection{\texorpdfstring{ftp\+Server\+Close\+Control\+Channel()}{ftpServerCloseControlChannel()}}
{\footnotesize\ttfamily void ftp\+Server\+Close\+Control\+Channel (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Close control connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}


Definition at line 417 of file ftp\+\_\+server\+\_\+control.\+c.


\begin{DoxyCode}
418 \{
419    \hyperlink{structIpAddr}{IpAddr} clientIpAddr;
420    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} clientPort;
421    \hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{FtpServerContext} *context;
422 
423    \textcolor{comment}{//Point to the FTP server context}
424    context = connection->context;
425 
426    \textcolor{comment}{//Check whether the control connection is active}
427    \textcolor{keywordflow}{if}(connection->controlChannel.socket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
428    \{
429       \textcolor{comment}{//Retrieve the address of the peer to which a socket is connected}
430       \hyperlink{socket_8c_aeb04e3b375708898d2330e9c67c4e1a9}{socketGetRemoteAddr}(connection->controlChannel.socket, &clientIpAddr,
431          &clientPort);
432 
433       \textcolor{comment}{//Debug message}
434       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"FTP server: Closing control connection with client %s port %"}
435          PRIu16 \textcolor{stringliteral}{"...\(\backslash\)r\(\backslash\)n"}, \hyperlink{ip_8c_aecdb577de79f65f8c814d5f101c7c6ae}{ipAddrToString}(&clientIpAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}), clientPort);
436 
437       \textcolor{comment}{//Any registered callback?}
438       \textcolor{keywordflow}{if}(context->settings.disconnectCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
439       \{
440          \textcolor{comment}{//Invoke user callback function}
441          context->settings.disconnectCallback(connection, &clientIpAddr,
442             clientPort);
443       \}
444 
445 \textcolor{preprocessor}{#if (FTP\_SERVER\_TLS\_SUPPORT == ENABLED)}
446       \textcolor{comment}{//Valid TLS context?}
447       \textcolor{keywordflow}{if}(connection->controlChannel.tlsContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
448       \{
449          \textcolor{comment}{//Release TLS context}
450          \hyperlink{tls_8c_aec8c1957ad13f5ad67d07a872d5fe66b}{tlsFree}(connection->controlChannel.tlsContext);
451          connection->controlChannel.tlsContext = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
452       \}
453 \textcolor{preprocessor}{#endif}
454 
455       \textcolor{comment}{//Valid socket?}
456       \textcolor{keywordflow}{if}(connection->controlChannel.socket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
457       \{
458          \textcolor{comment}{//Close control connection}
459          \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(connection->controlChannel.socket);
460          connection->controlChannel.socket = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
461       \}
462 
463       \textcolor{comment}{//Mark the connection as closed}
464       connection->controlChannel.state = \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156bab3165039e718584ac932b07402ac08f2}{FTP\_CHANNEL\_STATE\_CLOSED};
465    \}
466 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__control_8c_a4f1b63e4bea6acf0904237bf35449bb0}\label{ftp__server__control_8c_a4f1b63e4bea6acf0904237bf35449bb0}} 
\index{ftp\+\_\+server\+\_\+control.\+c@{ftp\+\_\+server\+\_\+control.\+c}!ftp\+Server\+Process\+Control\+Channel\+Events@{ftp\+Server\+Process\+Control\+Channel\+Events}}
\index{ftp\+Server\+Process\+Control\+Channel\+Events@{ftp\+Server\+Process\+Control\+Channel\+Events}!ftp\+\_\+server\+\_\+control.\+c@{ftp\+\_\+server\+\_\+control.\+c}}
\subsubsection{\texorpdfstring{ftp\+Server\+Process\+Control\+Channel\+Events()}{ftpServerProcessControlChannelEvents()}}
{\footnotesize\ttfamily void ftp\+Server\+Process\+Control\+Channel\+Events (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{event\+Flags }\end{DoxyParamCaption})}



Control connection event handler. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em event\+Flags} & Event to be processed \\
\hline
\end{DoxyParams}


Definition at line 143 of file ftp\+\_\+server\+\_\+control.\+c.


\begin{DoxyCode}
145 \{
146    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
147    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
148    \hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{FtpServerContext} *context;
149 
150    \textcolor{comment}{//Point to the FTP server context}
151    context = connection->context;
152 
153 \textcolor{preprocessor}{#if (FTP\_SERVER\_TLS\_SUPPORT == ENABLED)}
154    \textcolor{comment}{//TLS session establishment in progress?}
155    \textcolor{keywordflow}{if}(connection->controlChannel.state == \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156ba21aad3902f20c8ec868f94257a15f12c}{FTP\_CHANNEL\_STATE\_CONNECT\_TLS} ||
156       connection->controlChannel.state == \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156bae54e69cceab082569caf0623c9360ae6}{FTP\_CHANNEL\_STATE\_AUTH\_TLS\_2})
157    \{
158       \textcolor{comment}{//Perform TLS handshake}
159       error = \hyperlink{ftp__server__transport_8c_a4114584444ad6a12b534f163f350c4aa}{ftpServerEstablishSecureChannel}(&connection->controlChannel);
160 
161       \textcolor{comment}{//Check status code}
162       \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
163       \{
164          \textcolor{comment}{//Update the state of the control connection}
165          connection->controlChannel.state = \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156bae764f1c2df0975ec9cd81a77639e8e9a}{FTP\_CHANNEL\_STATE\_IDLE};
166       \}
167       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == 
      \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
168       \{
169       \}
170       \textcolor{keywordflow}{else}
171       \{
172          \textcolor{comment}{//Close connection with the client}
173          \hyperlink{ftp__server__misc_8c_a131bc4ee0544ae32eee4cf829f006a11}{ftpServerCloseConnection}(connection);
174       \}
175    \}
176    \textcolor{keywordflow}{else}
177 \textcolor{preprocessor}{#endif}
178    \{
179       \textcolor{comment}{//Check event flags}
180       \textcolor{keywordflow}{if}(eventFlags == \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea078fc309f8e29689ee08e584f00a73b6}{SOCKET\_EVENT\_TX\_READY})
181       \{
182          \textcolor{comment}{//Transmit data}
183          error = \hyperlink{ftp__server__transport_8c_abce43a97874ed1e25273269c30b05b90}{ftpServerWriteChannel}(&connection->controlChannel,
184             connection->response + connection->responsePos,
185             connection->responseLen, &n, 0);
186 
187          \textcolor{comment}{//Check status code}
188          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == 
      \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
189          \{
190             \textcolor{comment}{//Advance data pointer}
191             connection->responsePos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
192             \textcolor{comment}{//Number of bytes still available in the response buffer}
193             connection->responseLen -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
194 
195             \textcolor{comment}{//Check whether the AUTH response has been transmitted}
196             \textcolor{keywordflow}{if}(connection->responseLen == 0 &&
197                connection->controlChannel.state == \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156bafa58da332449ebb0a0f04e4e6ed0dc1a}{FTP\_CHANNEL\_STATE\_AUTH\_TLS\_1}
      )
198             \{
199                \textcolor{comment}{//TLS initialization}
200                error = \hyperlink{ftp__server__transport_8c_a5cfa9b56f98d969fcc0ac892122a691c}{ftpServerOpenSecureChannel}(context,
201                   &connection->controlChannel, \hyperlink{ftp__server_8h_aee515d8a6cde76b93c7979bbda3bd1d3}{FTP\_SERVER\_TLS\_TX\_BUFFER\_SIZE},
202                   \hyperlink{ftp__server_8h_a15d40ad09228662bbc4ccecf14618709}{FTP\_SERVER\_MIN\_TLS\_RX\_BUFFER\_SIZE});
203 
204                \textcolor{comment}{//Check status code}
205                \textcolor{keywordflow}{if}(!error)
206                \{
207                   \textcolor{comment}{//Perform TLS handshake}
208                   connection->controlChannel.state = 
      \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156bae54e69cceab082569caf0623c9360ae6}{FTP\_CHANNEL\_STATE\_AUTH\_TLS\_2};
209                \}
210                \textcolor{keywordflow}{else}
211                \{
212                   \textcolor{comment}{//Close connection with the client}
213                   \hyperlink{ftp__server__misc_8c_a131bc4ee0544ae32eee4cf829f006a11}{ftpServerCloseConnection}(connection);
214                \}
215             \}
216          \}
217          \textcolor{keywordflow}{else}
218          \{
219             \textcolor{comment}{//Close connection with the client}
220             \hyperlink{ftp__server__misc_8c_a131bc4ee0544ae32eee4cf829f006a11}{ftpServerCloseConnection}(connection);
221          \}
222       \}
223       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(eventFlags == \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY})
224       \{
225          \textcolor{comment}{//Receive data}
226          error = \hyperlink{ftp__server__transport_8c_a8daedd68f4993a0c999aca53bce4697d}{ftpServerReadChannel}(&connection->controlChannel,
227             connection->command + connection->commandLen,
228             \hyperlink{ftp__server_8h_a311e12601252dc2319ee256bb6e714ba}{FTP\_SERVER\_MAX\_LINE\_LEN} - connection->commandLen, &n, 0);
229 
230          \textcolor{comment}{//Check status code}
231          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} || error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK} || error == 
      \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
232          \{
233             \textcolor{comment}{//Number of bytes available in the command buffer}
234             connection->commandLen += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
235             \textcolor{comment}{//Process incoming command}
236             \hyperlink{ftp__server__commands_8c_a97fa2c87e8d0c233cfd6b38885449b77}{ftpServerProcessCommand}(connection);
237          \}
238          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca8b7223773301a4f3dd811f1d35e13ce4}{ERROR\_END\_OF\_STREAM})
239          \{
240             \textcolor{comment}{//Gracefully disconnect from the remote host}
241             connection->controlChannel.state = \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156ba8c20866e8b647211dfdcf92b8549a603}{FTP\_CHANNEL\_STATE\_WAIT\_ACK};
242          \}
243          \textcolor{keywordflow}{else}
244          \{
245             \textcolor{comment}{//Close connection with the client}
246             \hyperlink{ftp__server__misc_8c_a131bc4ee0544ae32eee4cf829f006a11}{ftpServerCloseConnection}(connection);
247          \}
248       \}
249       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(eventFlags == \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea9303c52298e0adf175b7064fbe7ce077}{SOCKET\_EVENT\_TX\_ACKED})
250       \{
251          \textcolor{comment}{//Disable transmission}
252          \hyperlink{socket_8c_acc736b53dba4a0d3b11b63f75cdcfffb}{socketShutdown}(connection->controlChannel.socket, 
      \hyperlink{socket_8h_a36ee33c18de64f549a6336d1aa7333b7a535dc5f70a642b86e56e6e83ce2a3378}{SOCKET\_SD\_SEND});
253          \textcolor{comment}{//Next state}
254          connection->controlChannel.state = \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156baa6e21182a0e61b8b06cc836d1f7b54c8}{FTP\_CHANNEL\_STATE\_SHUTDOWN\_TX};
255       \}
256       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(eventFlags == \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea7c192744b90c583effbac921fe00c4a0}{SOCKET\_EVENT\_TX\_SHUTDOWN})
257       \{
258          \textcolor{comment}{//Disable reception}
259          \hyperlink{socket_8c_acc736b53dba4a0d3b11b63f75cdcfffb}{socketShutdown}(connection->controlChannel.socket, 
      \hyperlink{socket_8h_a36ee33c18de64f549a6336d1aa7333b7a88cccdaadbcce09cccd7561d10af6a39}{SOCKET\_SD\_RECEIVE});
260          \textcolor{comment}{//Next state}
261          connection->controlChannel.state = \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156bae05572df1e35ac30e869b91783590ced}{FTP\_CHANNEL\_STATE\_SHUTDOWN\_RX};
262       \}
263       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(eventFlags == \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea0578189399787b74acb9636b9eef30fc}{SOCKET\_EVENT\_RX\_SHUTDOWN})
264       \{
265          \textcolor{comment}{//Properly close connection}
266          \hyperlink{ftp__server__misc_8c_a131bc4ee0544ae32eee4cf829f006a11}{ftpServerCloseConnection}(connection);
267       \}
268    \}
269 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__control_8c_a0efabb0e0da0fbe9db7130a36319c36a}\label{ftp__server__control_8c_a0efabb0e0da0fbe9db7130a36319c36a}} 
\index{ftp\+\_\+server\+\_\+control.\+c@{ftp\+\_\+server\+\_\+control.\+c}!ftp\+Server\+Register\+Control\+Channel\+Events@{ftp\+Server\+Register\+Control\+Channel\+Events}}
\index{ftp\+Server\+Register\+Control\+Channel\+Events@{ftp\+Server\+Register\+Control\+Channel\+Events}!ftp\+\_\+server\+\_\+control.\+c@{ftp\+\_\+server\+\_\+control.\+c}}
\subsubsection{\texorpdfstring{ftp\+Server\+Register\+Control\+Channel\+Events()}{ftpServerRegisterControlChannelEvents()}}
{\footnotesize\ttfamily void ftp\+Server\+Register\+Control\+Channel\+Events (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{structSocketEventDesc}{Socket\+Event\+Desc} $\ast$}]{event\+Desc }\end{DoxyParamCaption})}



Register control connection events. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em event\+Desc} & Event to be registered \\
\hline
\end{DoxyParams}


Definition at line 52 of file ftp\+\_\+server\+\_\+control.\+c.


\begin{DoxyCode}
54 \{
55    \textcolor{comment}{//Check the state of the control connection}
56    \textcolor{keywordflow}{if}(connection->controlChannel.state == \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156ba21aad3902f20c8ec868f94257a15f12c}{FTP\_CHANNEL\_STATE\_CONNECT\_TLS})
57    \{
58 \textcolor{preprocessor}{#if (FTP\_SERVER\_TLS\_SUPPORT == ENABLED)}
59       \textcolor{comment}{//Any data pending in the send buffer?}
60       \textcolor{keywordflow}{if}(\hyperlink{tls_8c_a54064670848f38f025bc40d612179890}{tlsIsTxReady}(connection->controlChannel.tlsContext))
61       \{
62          \textcolor{comment}{//Wait until there is more room in the send buffer}
63          eventDesc->\hyperlink{structSocketEventDesc_a31fbff5c4d515c81ff43934e8aeba08c}{socket} = connection->controlChannel.socket;
64          eventDesc->\hyperlink{structSocketEventDesc_ac979f02c9bb6b9517ed9c2d1b17e6201}{eventMask} = \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea078fc309f8e29689ee08e584f00a73b6}{SOCKET\_EVENT\_TX\_READY};
65       \}
66       \textcolor{keywordflow}{else}
67       \{
68          \textcolor{comment}{//Wait for data to be available for reading}
69          eventDesc->\hyperlink{structSocketEventDesc_a31fbff5c4d515c81ff43934e8aeba08c}{socket} = connection->controlChannel.socket;
70          eventDesc->\hyperlink{structSocketEventDesc_ac979f02c9bb6b9517ed9c2d1b17e6201}{eventMask} = \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY};
71       \}
72 \textcolor{preprocessor}{#endif}
73    \}
74    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->responseLen > 0)
75    \{
76       \textcolor{comment}{//Wait until there is more room in the send buffer}
77       eventDesc->\hyperlink{structSocketEventDesc_a31fbff5c4d515c81ff43934e8aeba08c}{socket} = connection->controlChannel.socket;
78       eventDesc->\hyperlink{structSocketEventDesc_ac979f02c9bb6b9517ed9c2d1b17e6201}{eventMask} = \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea078fc309f8e29689ee08e584f00a73b6}{SOCKET\_EVENT\_TX\_READY};
79    \}
80    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->controlChannel.state == \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156bae54e69cceab082569caf0623c9360ae6}{FTP\_CHANNEL\_STATE\_AUTH\_TLS\_2})
81    \{
82 \textcolor{preprocessor}{#if (FTP\_SERVER\_TLS\_SUPPORT == ENABLED)}
83       \textcolor{comment}{//Any data pending in the send buffer?}
84       \textcolor{keywordflow}{if}(\hyperlink{tls_8c_a54064670848f38f025bc40d612179890}{tlsIsTxReady}(connection->controlChannel.tlsContext))
85       \{
86          \textcolor{comment}{//Wait until there is more room in the send buffer}
87          eventDesc->\hyperlink{structSocketEventDesc_a31fbff5c4d515c81ff43934e8aeba08c}{socket} = connection->controlChannel.socket;
88          eventDesc->\hyperlink{structSocketEventDesc_ac979f02c9bb6b9517ed9c2d1b17e6201}{eventMask} = \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea078fc309f8e29689ee08e584f00a73b6}{SOCKET\_EVENT\_TX\_READY};
89       \}
90       \textcolor{keywordflow}{else}
91       \{
92          \textcolor{comment}{//Wait for data to be available for reading}
93          eventDesc->\hyperlink{structSocketEventDesc_a31fbff5c4d515c81ff43934e8aeba08c}{socket} = connection->controlChannel.socket;
94          eventDesc->\hyperlink{structSocketEventDesc_ac979f02c9bb6b9517ed9c2d1b17e6201}{eventMask} = \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY};
95       \}
96 \textcolor{preprocessor}{#endif}
97    \}
98    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->controlChannel.state == \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156ba8c20866e8b647211dfdcf92b8549a603}{FTP\_CHANNEL\_STATE\_WAIT\_ACK})
99    \{
100       \textcolor{comment}{//Wait for all the data to be transmitted and acknowledged}
101       eventDesc->\hyperlink{structSocketEventDesc_a31fbff5c4d515c81ff43934e8aeba08c}{socket} = connection->controlChannel.socket;
102       eventDesc->\hyperlink{structSocketEventDesc_ac979f02c9bb6b9517ed9c2d1b17e6201}{eventMask} = \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea9303c52298e0adf175b7064fbe7ce077}{SOCKET\_EVENT\_TX\_ACKED};
103    \}
104    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->controlChannel.state == \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156baa6e21182a0e61b8b06cc836d1f7b54c8}{FTP\_CHANNEL\_STATE\_SHUTDOWN\_TX})
105    \{
106       \textcolor{comment}{//Wait for the FIN to be acknowledged}
107       eventDesc->\hyperlink{structSocketEventDesc_a31fbff5c4d515c81ff43934e8aeba08c}{socket} = connection->controlChannel.socket;
108       eventDesc->\hyperlink{structSocketEventDesc_ac979f02c9bb6b9517ed9c2d1b17e6201}{eventMask} = \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea7c192744b90c583effbac921fe00c4a0}{SOCKET\_EVENT\_TX\_SHUTDOWN};
109    \}
110    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->controlChannel.state == \hyperlink{ftp__server_8h_a925bb5abc66ff43f81be2420bd31156bae05572df1e35ac30e869b91783590ced}{FTP\_CHANNEL\_STATE\_SHUTDOWN\_RX})
111    \{
112       \textcolor{comment}{//Wait for a FIN to be received}
113       eventDesc->\hyperlink{structSocketEventDesc_a31fbff5c4d515c81ff43934e8aeba08c}{socket} = connection->controlChannel.socket;
114       eventDesc->\hyperlink{structSocketEventDesc_ac979f02c9bb6b9517ed9c2d1b17e6201}{eventMask} = \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea0578189399787b74acb9636b9eef30fc}{SOCKET\_EVENT\_RX\_SHUTDOWN};
115    \}
116    \textcolor{keywordflow}{else}
117    \{
118 \textcolor{preprocessor}{#if (FTP\_SERVER\_TLS\_SUPPORT == ENABLED)}
119       \textcolor{comment}{//Any data pending in the receive buffer?}
120       \textcolor{keywordflow}{if}(connection->controlChannel.tlsContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} &&
121          \hyperlink{tls_8c_ae3de9c47e92455f6dd4739d54bc6981c}{tlsIsRxReady}(connection->controlChannel.tlsContext))
122       \{
123          \textcolor{comment}{//No need to poll the underlying socket for incoming traffic}
124          eventDesc->\hyperlink{structSocketEventDesc_aca8e460cfc75c58870239584437a3c1d}{eventFlags} = \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY};
125       \}
126       \textcolor{keywordflow}{else}
127 \textcolor{preprocessor}{#endif}
128       \{
129          \textcolor{comment}{//Wait for data to be available for reading}
130          eventDesc->\hyperlink{structSocketEventDesc_a31fbff5c4d515c81ff43934e8aeba08c}{socket} = connection->controlChannel.socket;
131          eventDesc->\hyperlink{structSocketEventDesc_ac979f02c9bb6b9517ed9c2d1b17e6201}{eventMask} = \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY};
132       \}
133    \}
134 \}
\end{DoxyCode}
