\hypertarget{pic32mz__eth__driver_8c}{}\section{cyclone\+\_\+tcp/drivers/mac/pic32mz\+\_\+eth\+\_\+driver.c File Reference}
\label{pic32mz__eth__driver_8c}\index{cyclone\+\_\+tcp/drivers/mac/pic32mz\+\_\+eth\+\_\+driver.\+c@{cyclone\+\_\+tcp/drivers/mac/pic32mz\+\_\+eth\+\_\+driver.\+c}}


P\+I\+C32\+MZ Ethernet M\+AC controller.  


{\ttfamily \#include $<$p32xxxx.\+h$>$}\newline
{\ttfamily \#include $<$sys/kmem.\+h$>$}\newline
{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}drivers/mac/pic32mz\+\_\+eth\+\_\+driver.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{pic32mz__eth__driver_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_a880f48968c7969b328d5061cd3db0f36}{N\+I\+C\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
static \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{nm__bus__wrapper__stm32l4xx_8c_a38e2250244d3f7799048819b9aed0b1e}{tx\+Buffer} \mbox{[}\hyperlink{pic32mz__eth__driver_8h_a4548bfe7d5909014ea861ab3a44a98b1}{P\+I\+C32\+M\+Z\+\_\+\+E\+T\+H\+\_\+\+T\+X\+\_\+\+B\+U\+F\+F\+E\+R\+\_\+\+C\+O\+U\+NT}\mbox{]}\mbox{[}\hyperlink{pic32mz__eth__driver_8h_aa2a486a97ff13f64ca59eb137e75121d}{P\+I\+C32\+M\+Z\+\_\+\+E\+T\+H\+\_\+\+T\+X\+\_\+\+B\+U\+F\+F\+E\+R\+\_\+\+S\+I\+ZE}\mbox{]} \hyperlink{pic32mz__eth__driver_8c_a9089eba6d0886ba3e71f3460e526024a}{\+\_\+\+\_\+attribute\+\_\+\+\_\+} ((coherent, aligned(4)))
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{pic32mz__eth__driver_8c_a3a4531c0f7cae82a0bbeb0eafa4c7cb6}{pic32mz\+Eth\+Init} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em P\+I\+C32\+MZ Ethernet M\+AC initialization. \end{DoxyCompactList}\item 
void \hyperlink{pic32mz__eth__driver_8c_ac117792482ebe67d6300e1e83f6fcdc9}{pic32mz\+Eth\+Init\+Buffer\+Desc} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Initialize D\+MA descriptor lists. \end{DoxyCompactList}\item 
void \hyperlink{pic32mz__eth__driver_8c_a21514d0cd0cd5d576bcfacd01ced3891}{pic32mz\+Eth\+Tick} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em P\+I\+C32\+MZ Ethernet M\+AC timer handler. \end{DoxyCompactList}\item 
void \hyperlink{pic32mz__eth__driver_8c_a8091de5de960e9b76e3d2a8595195e24}{pic32mz\+Eth\+Enable\+Irq} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Enable interrupts. \end{DoxyCompactList}\item 
void \hyperlink{pic32mz__eth__driver_8c_ae6f53411b89fbd0a9f9788533867229e}{pic32mz\+Eth\+Disable\+Irq} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Disable interrupts. \end{DoxyCompactList}\item 
void \hyperlink{pic32mz__eth__driver_8c_a0b19188d9363e6ab6578429682d7dd43}{pic32mz\+Eth\+Irq\+Handler} (void)
\begin{DoxyCompactList}\small\item\em P\+I\+C32\+MZ Ethernet M\+AC interrupt service routine. \end{DoxyCompactList}\item 
void \hyperlink{pic32mz__eth__driver_8c_a5533c975decf0e50d121a73394a43c33}{pic32mz\+Eth\+Event\+Handler} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em P\+I\+C32\+MZ Ethernet M\+AC event handler. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{pic32mz__eth__driver_8c_a7b47986b0a980a2fddb6d53638d081af}{pic32mz\+Eth\+Send\+Packet} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset})
\begin{DoxyCompactList}\small\item\em Send a packet. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{pic32mz__eth__driver_8c_a7615a0d619c1a88f348d2ec1a4a61914}{pic32mz\+Eth\+Receive\+Packet} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Receive a packet. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{pic32mz__eth__driver_8c_ac2f4ebcdf657e2a281189a3d318266e6}{pic32mz\+Eth\+Update\+Mac\+Addr\+Filter} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Configure M\+AC address filtering. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{pic32mz__eth__driver_8c_a09f28d9f779b70c51bdea495153ea326}{pic32mz\+Eth\+Update\+Mac\+Config} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Adjust M\+AC configuration parameters for proper operation. \end{DoxyCompactList}\item 
void \hyperlink{pic32mz__eth__driver_8c_acd392fde7b41b39ff83d64361f40d1c6}{pic32mz\+Eth\+Write\+Phy\+Reg} (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{web__socket_8h_a5c1b56e6bccc2a95dbddf1a08e56e87d}{opcode}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} phy\+Addr, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{modbus__common_8h_a184543cc09c0f45a36f7cd93a99aeae3}{reg\+Addr}, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data})
\begin{DoxyCompactList}\small\item\em Write P\+HY register. \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{pic32mz__eth__driver_8c_a4c81d4c18a7fd5b30801b66398d29fe2}{pic32mz\+Eth\+Read\+Phy\+Reg} (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{web__socket_8h_a5c1b56e6bccc2a95dbddf1a08e56e87d}{opcode}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} phy\+Addr, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{modbus__common_8h_a184543cc09c0f45a36f7cd93a99aeae3}{reg\+Addr})
\begin{DoxyCompactList}\small\item\em Read P\+HY register. \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{pic32mz__eth__driver_8c_a5e126e8bbce50d63c10dca9665b18c0b}{pic32mz\+Eth\+Calc\+Crc} (const void $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em C\+RC calculation. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
static \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$ \hyperlink{pic32mz__eth__driver_8c_ab4d353d5e0183f1695694408a26ce9d6}{nic\+Driver\+Interface}
\item 
static \hyperlink{structPic32mzTxBufferDesc}{Pic32mz\+Tx\+Buffer\+Desc} $\ast$ \hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{tx\+Cur\+Buffer\+Desc}
\item 
static \hyperlink{structPic32mzRxBufferDesc}{Pic32mz\+Rx\+Buffer\+Desc} $\ast$ \hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rx\+Cur\+Buffer\+Desc}
\item 
const \hyperlink{structNicDriver}{Nic\+Driver} \hyperlink{pic32mz__eth__driver_8c_a17454238968d3e488fe5985355566129}{pic32mz\+Eth\+Driver}
\begin{DoxyCompactList}\small\item\em P\+I\+C32\+MZ Ethernet M\+AC driver. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
P\+I\+C32\+MZ Ethernet M\+AC controller. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{pic32mz__eth__driver_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_a880f48968c7969b328d5061cd3db0f36}{N\+I\+C\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file pic32mz\+\_\+eth\+\_\+driver.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_a9089eba6d0886ba3e71f3460e526024a}\label{pic32mz__eth__driver_8c_a9089eba6d0886ba3e71f3460e526024a}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!\+\_\+\+\_\+attribute\+\_\+\+\_\+@{\+\_\+\+\_\+attribute\+\_\+\+\_\+}}
\index{\+\_\+\+\_\+attribute\+\_\+\+\_\+@{\+\_\+\+\_\+attribute\+\_\+\+\_\+}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{\+\_\+\+\_\+attribute\+\_\+\+\_\+()}{\_\_attribute\_\_()}}
{\footnotesize\ttfamily static \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{nm__bus__wrapper__stm32l4xx_8c_a38e2250244d3f7799048819b9aed0b1e}{tx\+Buffer} \mbox{[}\hyperlink{pic32mz__eth__driver_8h_a4548bfe7d5909014ea861ab3a44a98b1}{P\+I\+C32\+M\+Z\+\_\+\+E\+T\+H\+\_\+\+T\+X\+\_\+\+B\+U\+F\+F\+E\+R\+\_\+\+C\+O\+U\+NT}\mbox{]}\mbox{[}\hyperlink{pic32mz__eth__driver_8h_aa2a486a97ff13f64ca59eb137e75121d}{P\+I\+C32\+M\+Z\+\_\+\+E\+T\+H\+\_\+\+T\+X\+\_\+\+B\+U\+F\+F\+E\+R\+\_\+\+S\+I\+ZE}\mbox{]} \+\_\+\+\_\+attribute\+\_\+\+\_\+ (\begin{DoxyParamCaption}\item[{(coherent, aligned(4))}]{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}

\mbox{\Hypertarget{pic32mz__eth__driver_8c_a5e126e8bbce50d63c10dca9665b18c0b}\label{pic32mz__eth__driver_8c_a5e126e8bbce50d63c10dca9665b18c0b}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Calc\+Crc@{pic32mz\+Eth\+Calc\+Crc}}
\index{pic32mz\+Eth\+Calc\+Crc@{pic32mz\+Eth\+Calc\+Crc}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Calc\+Crc()}{pic32mzEthCalcCrc()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} pic32mz\+Eth\+Calc\+Crc (\begin{DoxyParamCaption}\item[{const void $\ast$}]{data,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



C\+RC calculation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em data} & Pointer to the data over which to calculate the C\+RC \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes to process \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Resulting C\+RC value 
\end{DoxyReturn}


Definition at line 776 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
777 \{
778    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
779    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} j;
780 
781    \textcolor{comment}{//Point to the data over which to calculate the CRC}
782    \textcolor{keyword}{const} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
783    \textcolor{comment}{//CRC preset value}
784    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} crc = 0xFFFFFFFF;
785 
786    \textcolor{comment}{//Loop through data}
787    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}; i++)
788    \{
789       \textcolor{comment}{//The message is processed bit by bit}
790       \textcolor{keywordflow}{for}(j = 0; j < 8; j++)
791       \{
792          \textcolor{comment}{//Update CRC value}
793          \textcolor{keywordflow}{if}(((crc >> 31) ^ (p[i] >> j)) & 0x01)
794             crc = (crc << 1) ^ 0x04C11DB7;
795          \textcolor{keywordflow}{else}
796             crc = crc << 1;
797       \}
798    \}
799 
800    \textcolor{comment}{//Return CRC value}
801    \textcolor{keywordflow}{return} crc;
802 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_ae6f53411b89fbd0a9f9788533867229e}\label{pic32mz__eth__driver_8c_ae6f53411b89fbd0a9f9788533867229e}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Disable\+Irq@{pic32mz\+Eth\+Disable\+Irq}}
\index{pic32mz\+Eth\+Disable\+Irq@{pic32mz\+Eth\+Disable\+Irq}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Disable\+Irq()}{pic32mzEthDisableIrq()}}
{\footnotesize\ttfamily void pic32mz\+Eth\+Disable\+Irq (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Disable interrupts. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 373 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
374 \{
375    \textcolor{comment}{//Disable Ethernet MAC interrupts}
376    IEC4CLR = \_IEC4\_ETHIE\_MASK;
377    \textcolor{comment}{//Disable Ethernet PHY interrupts}
378    interface->phyDriver->disableIrq(interface);
379 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_a8091de5de960e9b76e3d2a8595195e24}\label{pic32mz__eth__driver_8c_a8091de5de960e9b76e3d2a8595195e24}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Enable\+Irq@{pic32mz\+Eth\+Enable\+Irq}}
\index{pic32mz\+Eth\+Enable\+Irq@{pic32mz\+Eth\+Enable\+Irq}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Enable\+Irq()}{pic32mzEthEnableIrq()}}
{\footnotesize\ttfamily void pic32mz\+Eth\+Enable\+Irq (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Enable interrupts. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 359 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
360 \{
361    \textcolor{comment}{//Enable Ethernet MAC interrupts}
362    IEC4SET = \_IEC4\_ETHIE\_MASK;
363    \textcolor{comment}{//Enable Ethernet PHY interrupts}
364    interface->phyDriver->enableIrq(interface);
365 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_a5533c975decf0e50d121a73394a43c33}\label{pic32mz__eth__driver_8c_a5533c975decf0e50d121a73394a43c33}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Event\+Handler@{pic32mz\+Eth\+Event\+Handler}}
\index{pic32mz\+Eth\+Event\+Handler@{pic32mz\+Eth\+Event\+Handler}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Event\+Handler()}{pic32mzEthEventHandler()}}
{\footnotesize\ttfamily void pic32mz\+Eth\+Event\+Handler (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



P\+I\+C32\+MZ Ethernet M\+AC event handler. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 439 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
440 \{
441    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
442 
443    \textcolor{comment}{//Packet received?}
444    \textcolor{keywordflow}{if}(ETHIRQ & \_ETHIRQ\_PKTPEND\_MASK)
445    \{
446       \textcolor{comment}{//Process all pending packets}
447       \textcolor{keywordflow}{do}
448       \{
449          \textcolor{comment}{//Read incoming packet}
450          error = \hyperlink{pic32mz__eth__driver_8c_a7615a0d619c1a88f348d2ec1a4a61914}{pic32mzEthReceivePacket}(interface);
451 
452          \textcolor{comment}{//No more data in the receive buffer?}
453       \} \textcolor{keywordflow}{while}(error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca838a7a87abb42b87d6862e98849fab2d}{ERROR\_BUFFER\_EMPTY});
454    \}
455 
456    \textcolor{comment}{//Re-enable PKTPEND interrupt}
457    ETHIENSET = \_ETHIEN\_PKTPENDIE\_MASK;
458 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_a3a4531c0f7cae82a0bbeb0eafa4c7cb6}\label{pic32mz__eth__driver_8c_a3a4531c0f7cae82a0bbeb0eafa4c7cb6}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Init@{pic32mz\+Eth\+Init}}
\index{pic32mz\+Eth\+Init@{pic32mz\+Eth\+Init}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Init()}{pic32mzEthInit()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} pic32mz\+Eth\+Init (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



P\+I\+C32\+MZ Ethernet M\+AC initialization. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 94 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
95 \{
96    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
97 
98    \textcolor{comment}{//Debug message}
99    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Initializing PIC32MZ Ethernet MAC...\(\backslash\)r\(\backslash\)n"});
100 
101    \textcolor{comment}{//Save underlying network interface}
102    \hyperlink{pic32mz__eth__driver_8c_ab4d353d5e0183f1695694408a26ce9d6}{nicDriverInterface} = interface;
103 
104    \textcolor{comment}{//GPIO configuration}
105    \hyperlink{pic32mz__eth__driver_8h_aa35561b0c576792542da5e7f6d00b0d6}{pic32mzEthInitGpio}(interface);
106 
107    \textcolor{comment}{//Disable Ethernet interrupts}
108    IEC4CLR = \_IEC4\_ETHIE\_MASK;
109    \textcolor{comment}{//Turn the Ethernet controller off}
110    ETHCON1CLR = \_ETHCON1\_ON\_MASK | \_ETHCON1\_TXRTS\_POSITION | \_ETHCON1\_RXEN\_MASK;
111 
112    \textcolor{comment}{//Wait activity abort by polling the ETHBUSY bit}
113    \textcolor{keywordflow}{while}(ETHSTAT & \_ETHSTAT\_ETHBUSY\_MASK)
114    \{
115    \}
116 
117    \textcolor{comment}{//Enable the Ethernet controller by setting the ON bit}
118    ETHCON1SET = \_ETHCON1\_ON\_MASK;
119 
120    \textcolor{comment}{//Clear Ethernet interrupt flag}
121    IFS4CLR = \_IFS4\_ETHIF\_MASK;
122    \textcolor{comment}{//Disable any Ethernet controller interrupt generation}
123    ETHIEN = 0;
124    ETHIRQ = 0;
125    \textcolor{comment}{//Clear the TX and RX start addresses}
126    ETHTXST = 0;
127    ETHRXST = 0;
128 
129    \textcolor{comment}{//Reset the MAC using SOFTRESET}
130    EMAC1CFG1SET = \_EMAC1CFG1\_SOFTRESET\_MASK;
131    EMAC1CFG1CLR = \_EMAC1CFG1\_SOFTRESET\_MASK;
132 
133    \textcolor{comment}{//Reset the RMII module}
134    EMAC1SUPPSET = \_EMAC1SUPP\_RESETRMII\_MASK;
135    EMAC1SUPPCLR = \_EMAC1SUPP\_RESETRMII\_MASK;
136 
137    \textcolor{comment}{//Issue an MIIM block reset by setting the RESETMGMT bit}
138    EMAC1MCFGSET = \_EMAC1MCFG\_RESETMGMT\_MASK;
139    EMAC1MCFGCLR = \_EMAC1MCFG\_RESETMGMT\_MASK;
140 
141    \textcolor{comment}{//Select the proper divider for the MDC clock}
142    EMAC1MCFG = \hyperlink{pic32mz__eth__driver_8h_a607b754ad729909219d287c191a15043}{\_EMAC1MCFG\_CLKSEL\_DIV50};
143 
144    \textcolor{comment}{//PHY transceiver initialization}
145    error = interface->phyDriver->init(interface);
146    \textcolor{comment}{//Failed to initialize PHY transceiver?}
147    \textcolor{keywordflow}{if}(error)
148       \textcolor{keywordflow}{return} error;
149 
150    \textcolor{comment}{//Optionally set the station MAC address}
151    \textcolor{keywordflow}{if}(\hyperlink{ethernet_8h_a800d9f928930baf027e925976c44b9b2}{macCompAddr}(&interface->macAddr, &\hyperlink{ethernet_8c_a24b2ce78dd643fe028d2e18c3b503f1f}{MAC\_UNSPECIFIED\_ADDR}))
152    \{
153       \textcolor{comment}{//Use the factory preprogrammed station address}
154       interface->macAddr.w[0] = EMAC1SA2;
155       interface->macAddr.w[1] = EMAC1SA1;
156       interface->macAddr.w[2] = EMAC1SA0;
157 
158       \textcolor{comment}{//Generate the 64-bit interface identifier}
159       \hyperlink{ethernet_8c_abbe0cae70748acbaa8c4d840ee764424}{macAddrToEui64}(&interface->macAddr, &interface->eui64);
160    \}
161    \textcolor{keywordflow}{else}
162    \{
163       \textcolor{comment}{//Override the factory preprogrammed address}
164       EMAC1SA0 = interface->macAddr.w[2];
165       EMAC1SA1 = interface->macAddr.w[1];
166       EMAC1SA2 = interface->macAddr.w[0];
167    \}
168 
169    \textcolor{comment}{//Initialize hash table}
170    ETHHT0 = 0;
171    ETHHT1 = 0;
172 
173    \textcolor{comment}{//Configure the receive filter}
174    ETHRXFC = \_ETHRXFC\_HTEN\_MASK | \_ETHRXFC\_CRCOKEN\_MASK |
175       \_ETHRXFC\_RUNTEN\_MASK | \_ETHRXFC\_UCEN\_MASK | \_ETHRXFC\_BCEN\_MASK;
176 
177    \textcolor{comment}{//Disable flow control}
178    EMAC1CFG1 = \_EMAC1CFG1\_RXENABLE\_MASK;
179    \textcolor{comment}{//Automatic padding and CRC generation}
180    EMAC1CFG2 = \_EMAC1CFG2\_PADENABLE\_MASK | \_EMAC1CFG2\_CRCENABLE\_MASK;
181    \textcolor{comment}{//Set the maximum frame length}
182    EMAC1MAXF = \hyperlink{pic32mz__eth__driver_8h_aa0f4ef3b8cf373893896a7ce33b0898d}{PIC32MZ\_ETH\_RX\_BUFFER\_SIZE};
183 
184    \textcolor{comment}{//Initialize DMA descriptor lists}
185    \hyperlink{pic32mz__eth__driver_8c_ac117792482ebe67d6300e1e83f6fcdc9}{pic32mzEthInitBufferDesc}(interface);
186 
187    \textcolor{comment}{//Enable desired interrupts}
188    ETHIENSET = \_ETHIEN\_PKTPENDIE\_MASK | \_ETHIEN\_TXDONEIE\_MASK;
189 
190    \textcolor{comment}{//Set interrupt priority}
191    IPC38CLR = \_IPC38\_ETHIP\_MASK;
192    IPC38SET = (\hyperlink{pic32mz__eth__driver_8h_a6e69fa9e08081b2619a52a32e8d80ba9}{PIC32MZ\_ETH\_IRQ\_PRIORITY} << \_IPC38\_ETHIP\_POSITION);
193    \textcolor{comment}{//Set interrupt subpriority}
194    IPC38CLR = \_IPC38\_ETHIS\_MASK;
195    IPC38SET = (\hyperlink{pic32mz__eth__driver_8h_adc3c5d8462558aeb51f8ea7ae737a8d6}{PIC32MZ\_ETH\_IRQ\_SUB\_PRIORITY} << \_IPC38\_ETHIS\_POSITION);
196 
197    \textcolor{comment}{//Enable the reception by setting the RXEN bit}
198    ETHCON1SET = \_ETHCON1\_RXEN\_MASK;
199 
200    \textcolor{comment}{//Accept any packets from the upper layer}
201    \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&interface->nicTxEvent);
202 
203    \textcolor{comment}{//Successful initialization}
204    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
205 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_ac117792482ebe67d6300e1e83f6fcdc9}\label{pic32mz__eth__driver_8c_ac117792482ebe67d6300e1e83f6fcdc9}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Init\+Buffer\+Desc@{pic32mz\+Eth\+Init\+Buffer\+Desc}}
\index{pic32mz\+Eth\+Init\+Buffer\+Desc@{pic32mz\+Eth\+Init\+Buffer\+Desc}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Init\+Buffer\+Desc()}{pic32mzEthInitBufferDesc()}}
{\footnotesize\ttfamily void pic32mz\+Eth\+Init\+Buffer\+Desc (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Initialize D\+MA descriptor lists. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 281 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
282 \{
283    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
284 
285    \textcolor{comment}{//Initialize TX descriptor list}
286    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{pic32mz__eth__driver_8h_a4548bfe7d5909014ea861ab3a44a98b1}{PIC32MZ\_ETH\_TX\_BUFFER\_COUNT}; i++)
287    \{
288       \textcolor{comment}{//Point to the current descriptor}
289       \hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc} = &txBufferDesc[i];
290 
291       \textcolor{comment}{//Use linked list rather than linear list}
292       \hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc}->\hyperlink{structPic32mzTxBufferDesc_abcb8135aadb503621ad36e2caf44739d}{control} = \hyperlink{pic32mz__eth__driver_8h_a3f8530c8d55d474c7a22219e9755c52a}{ETH\_TX\_CTRL\_NPV};
293       \textcolor{comment}{//Transmit buffer address}
294       \hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc}->\hyperlink{structPic32mzTxBufferDesc_a871be0effc55fb3015607af662aec31d}{address} = KVA\_TO\_PA(\hyperlink{wilc1000__driver_8c_aba92300075ca68e5227458fd23a1bb34}{txBuffer}[i]);
295       \textcolor{comment}{//Transmit status vector}
296       \hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc}->\hyperlink{structPic32mzTxBufferDesc_a8e5fb7f2100ac5107e55b6658136f2c5}{status1} = 0;
297       \hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc}->\hyperlink{structPic32mzTxBufferDesc_a7f506326e97225e3c6a3d58a34fe12e2}{status2} = 0;
298       \textcolor{comment}{//Next descriptor address}
299       \hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc}->\hyperlink{structPic32mzTxBufferDesc_a599f7ed90daa9438a6e9156951d444ef}{next} = KVA\_TO\_PA(&txBufferDesc[i + 1]);
300    \}
301 
302    \textcolor{comment}{//The last descriptor is chained to the first entry}
303    \hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc}->\hyperlink{structPic32mzTxBufferDesc_a599f7ed90daa9438a6e9156951d444ef}{next} = KVA\_TO\_PA(&txBufferDesc[0]);
304    \textcolor{comment}{//Point to the very first descriptor}
305    \hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc} = &txBufferDesc[0];
306 
307    \textcolor{comment}{//Initialize RX descriptor list}
308    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{pic32mz__eth__driver_8h_aeef8ce510ec5576647f1d58878212e2c}{PIC32MZ\_ETH\_RX\_BUFFER\_COUNT}; i++)
309    \{
310       \textcolor{comment}{//Point to the current descriptor}
311       \hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc} = &rxBufferDesc[i];
312 
313       \textcolor{comment}{//The descriptor is initially owned by the DMA}
314       \hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a6c5d412967f5321269566980ba585303}{control} = \hyperlink{pic32mz__eth__driver_8h_a947d117c018c08ae7a6d9dbdbdeff9b7}{ETH\_RX\_CTRL\_NPV} | 
      \hyperlink{pic32mz__eth__driver_8h_a61a84e04ffd0a8b12a6aba4b0df6dee2}{ETH\_RX\_CTRL\_EOWN};
315       \textcolor{comment}{//Receive buffer address}
316       \hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a834826db2f21266e8e4b18ffa428b8cc}{address} = KVA\_TO\_PA(\hyperlink{wilc1000__driver_8c_a33225839969f0578aae348a4fd62f0f3}{rxBuffer}[i]);
317       \textcolor{comment}{//Receive status vector}
318       \hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a2f6dacf436998ffbd815f2cb4366457e}{status1} = 0;
319       \hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a86067cf8e17a8a2d204b251022cd55ce}{status2} = 0;
320       \textcolor{comment}{//Next descriptor address}
321       \hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a985d45d76d242c516732f87206bac3d3}{next} = KVA\_TO\_PA(&rxBufferDesc[i + 1]);
322    \}
323 
324    \textcolor{comment}{//The last descriptor is chained to the first entry}
325    \hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a985d45d76d242c516732f87206bac3d3}{next} = KVA\_TO\_PA(&rxBufferDesc[0]);
326    \textcolor{comment}{//Point to the very first descriptor}
327    \hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc} = &rxBufferDesc[0];
328 
329    \textcolor{comment}{//Starting address of TX descriptor table}
330    ETHTXST = KVA\_TO\_PA(&txBufferDesc[0]);
331    \textcolor{comment}{//Starting address of RX descriptor table}
332    ETHRXST = KVA\_TO\_PA(&rxBufferDesc[0]);
333    \textcolor{comment}{//Set receive buffer size}
334    ETHCON2 = \hyperlink{pic32mz__eth__driver_8h_aa0f4ef3b8cf373893896a7ce33b0898d}{PIC32MZ\_ETH\_RX\_BUFFER\_SIZE};
335 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_a0b19188d9363e6ab6578429682d7dd43}\label{pic32mz__eth__driver_8c_a0b19188d9363e6ab6578429682d7dd43}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Irq\+Handler@{pic32mz\+Eth\+Irq\+Handler}}
\index{pic32mz\+Eth\+Irq\+Handler@{pic32mz\+Eth\+Irq\+Handler}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Irq\+Handler()}{pic32mzEthIrqHandler()}}
{\footnotesize\ttfamily void pic32mz\+Eth\+Irq\+Handler (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



P\+I\+C32\+MZ Ethernet M\+AC interrupt service routine. 



Definition at line 386 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
387 \{
388    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} flag;
389    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} status;
390 
391    \textcolor{comment}{//Interrupt service routine prologue}
392    \hyperlink{os__port__chibios_8h_a34b7be462185f422f4212661248fc23f}{osEnterIsr}();
393 
394    \textcolor{comment}{//This flag will be set if a higher priority task must be woken}
395    flag = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
396 
397    \textcolor{comment}{//Read interrupt status register}
398    status = ETHIRQ;
399 
400    \textcolor{comment}{//A packet has been transmitted?}
401    \textcolor{keywordflow}{if}(status & \_ETHIRQ\_TXDONE\_MASK)
402    \{
403       \textcolor{comment}{//Clear TXDONE interrupt flag}
404       ETHIRQCLR = \_ETHIRQ\_TXDONE\_MASK;
405 
406       \textcolor{comment}{//Check whether the TX buffer is available for writing}
407       \textcolor{keywordflow}{if}(!(\hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc}->\hyperlink{structPic32mzTxBufferDesc_abcb8135aadb503621ad36e2caf44739d}{control} & \hyperlink{pic32mz__eth__driver_8h_a06e68519afebf75a256c2e812640b0ad}{ETH\_TX\_CTRL\_EOWN}))
408       \{
409          \textcolor{comment}{//Notify the TCP/IP stack that the transmitter is ready to send}
410          flag |= \hyperlink{os__port__chibios_8c_aa30d505571a03dd645af374f40bd7016}{osSetEventFromIsr}(&\hyperlink{pic32mz__eth__driver_8c_ab4d353d5e0183f1695694408a26ce9d6}{nicDriverInterface}->nicTxEvent);
411       \}
412    \}
413 
414    \textcolor{comment}{//A packet has been received?}
415    \textcolor{keywordflow}{if}(status & \_ETHIRQ\_PKTPEND\_MASK)
416    \{
417       \textcolor{comment}{//Disable PKTPEND interrupt}
418       ETHIENCLR = \_ETHIEN\_PKTPENDIE\_MASK;
419 
420       \textcolor{comment}{//Set event flag}
421       \hyperlink{pic32mz__eth__driver_8c_ab4d353d5e0183f1695694408a26ce9d6}{nicDriverInterface}->nicEvent = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
422       \textcolor{comment}{//Notify the TCP/IP stack of the event}
423       flag |= \hyperlink{os__port__chibios_8c_aa30d505571a03dd645af374f40bd7016}{osSetEventFromIsr}(&\hyperlink{net_8c_a4ad5a175123589d00e402e0c1c842fdc}{netEvent});
424    \}
425 
426    \textcolor{comment}{//Clear ETHIF interrupt flag before exiting the service routine}
427    IFS4CLR = \_IFS4\_ETHIF\_MASK;
428 
429    \textcolor{comment}{//Interrupt service routine epilogue}
430    \hyperlink{os__port__chibios_8h_ab01a088ed8a5d0a466772d825ef05cec}{osExitIsr}(flag);
431 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_a4c81d4c18a7fd5b30801b66398d29fe2}\label{pic32mz__eth__driver_8c_a4c81d4c18a7fd5b30801b66398d29fe2}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Read\+Phy\+Reg@{pic32mz\+Eth\+Read\+Phy\+Reg}}
\index{pic32mz\+Eth\+Read\+Phy\+Reg@{pic32mz\+Eth\+Read\+Phy\+Reg}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Read\+Phy\+Reg()}{pic32mzEthReadPhyReg()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} pic32mz\+Eth\+Read\+Phy\+Reg (\begin{DoxyParamCaption}\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{opcode,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{phy\+Addr,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{reg\+Addr }\end{DoxyParamCaption})}



Read P\+HY register. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em opcode} & Access type (2 bits) \\
\hline
\mbox{\tt in}  & {\em phy\+Addr} & P\+HY address (5 bits) \\
\hline
\mbox{\tt in}  & {\em reg\+Addr} & Register address (5 bits) \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Register value 
\end{DoxyReturn}


Definition at line 728 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
730 \{
731    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
732    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
733 
734    \textcolor{comment}{//Valid opcode?}
735    \textcolor{keywordflow}{if}(\hyperlink{dns__common_8h_a5c1b56e6bccc2a95dbddf1a08e56e87d}{opcode} == \hyperlink{nic_8h_acceb418bf1cbc9cf0483446cd1cb1e78}{SMI\_OPCODE\_READ})
736    \{
737       \textcolor{comment}{//Set PHY address and register address}
738       EMAC1MADR = (phyAddr << \_EMAC1MADR\_PHYADDR\_POSITION) | \hyperlink{modbus__common_8h_a184543cc09c0f45a36f7cd93a99aeae3}{regAddr};
739       \textcolor{comment}{//Start a read operation}
740       EMAC1MCMD = \_EMAC1MCMD\_READ\_MASK;
741 
742       \textcolor{comment}{//Wait for busy bit to be set}
743       \textcolor{keywordflow}{for}(i = 0; i < 16; i++)
744       \{
745          \_\_asm\_\_ \_\_volatile\_\_ (\textcolor{stringliteral}{"nop;"});
746       \}
747 
748       \textcolor{comment}{//Wait for the read to complete}
749       \textcolor{keywordflow}{while}(EMAC1MIND & \_EMAC1MIND\_MIIMBUSY\_MASK)
750       \{
751       \}
752 
753       \textcolor{comment}{//Clear command register}
754       EMAC1MCMD = 0;
755       \textcolor{comment}{//Get register value}
756       data = EMAC1MRDD & \_EMAC1MRDD\_MRDD\_MASK;
757    \}
758    \textcolor{keywordflow}{else}
759    \{
760       \textcolor{comment}{//The MAC peripheral only supports standard Clause 22 opcodes}
761       data = 0;
762    \}
763 
764    \textcolor{comment}{//Return the value of the PHY register}
765    \textcolor{keywordflow}{return} \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
766 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_a7615a0d619c1a88f348d2ec1a4a61914}\label{pic32mz__eth__driver_8c_a7615a0d619c1a88f348d2ec1a4a61914}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Receive\+Packet@{pic32mz\+Eth\+Receive\+Packet}}
\index{pic32mz\+Eth\+Receive\+Packet@{pic32mz\+Eth\+Receive\+Packet}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Receive\+Packet()}{pic32mzEthReceivePacket()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} pic32mz\+Eth\+Receive\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Receive a packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 525 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
526 \{
527    \textcolor{keyword}{static} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} temp[\hyperlink{pic32mz__eth__driver_8h_aa0f4ef3b8cf373893896a7ce33b0898d}{PIC32MZ\_ETH\_RX\_BUFFER\_SIZE}];
528    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
529    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
530 
531    \textcolor{comment}{//The current buffer is available for reading?}
532    \textcolor{keywordflow}{if}(!(\hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a6c5d412967f5321269566980ba585303}{control} & \hyperlink{pic32mz__eth__driver_8h_a61a84e04ffd0a8b12a6aba4b0df6dee2}{ETH\_RX\_CTRL\_EOWN}))
533    \{
534       \textcolor{comment}{//SOP and EOP flags should be set}
535       \textcolor{keywordflow}{if}((\hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a6c5d412967f5321269566980ba585303}{control} & \hyperlink{pic32mz__eth__driver_8h_a2f735e0b8c549908be1fbb8f2cea4a6b}{ETH\_RX\_CTRL\_SOP}) &&
536          (\hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a6c5d412967f5321269566980ba585303}{control} & \hyperlink{pic32mz__eth__driver_8h_af3493ce7ef349ae91edfdac75ca8c2d2}{ETH\_RX\_CTRL\_EOP}))
537       \{
538          \textcolor{comment}{//Make sure no error occurred}
539          \textcolor{keywordflow}{if}(\hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a86067cf8e17a8a2d204b251022cd55ce}{status2} & \hyperlink{pic32mz__eth__driver_8h_a6f0017a325902568a57ea8e16ade5c6f}{ETH\_RX\_STATUS2\_OK})
540          \{
541             \textcolor{comment}{//Retrieve the length of the frame}
542             n = (\hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a6c5d412967f5321269566980ba585303}{control} & 
      \hyperlink{pic32mz__eth__driver_8h_a16510aab57cf2ce2c3644751b25fc7d1}{ETH\_RX\_CTRL\_BYTE\_COUNT}) >> 16;
543             \textcolor{comment}{//Limit the number of data to read}
544             n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(n, \hyperlink{pic32mz__eth__driver_8h_aa0f4ef3b8cf373893896a7ce33b0898d}{PIC32MZ\_ETH\_RX\_BUFFER\_SIZE});
545 
546             \textcolor{comment}{//Copy data from the receive buffer}
547             memcpy(temp, PA\_TO\_KVA1(\hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a834826db2f21266e8e4b18ffa428b8cc}{address}), n);
548 
549             \textcolor{comment}{//Pass the packet to the upper layer}
550             \hyperlink{nic_8c_a5e5ef3b84649c36ebfe1e70edb1a0f75}{nicProcessPacket}(interface, temp, n);
551 
552             \textcolor{comment}{//Valid packet received}
553             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
554          \}
555          \textcolor{keywordflow}{else}
556          \{
557             \textcolor{comment}{//The received packet contains an error}
558             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caccf6070ae61f26a48b523757a3168ad2}{ERROR\_INVALID\_PACKET};
559          \}
560       \}
561       \textcolor{keywordflow}{else}
562       \{
563          \textcolor{comment}{//The packet is not valid}
564          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caccf6070ae61f26a48b523757a3168ad2}{ERROR\_INVALID\_PACKET};
565       \}
566 
567       \textcolor{comment}{//Give the ownership of the descriptor back to the DMA}
568       \hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->\hyperlink{structPic32mzRxBufferDesc_a6c5d412967f5321269566980ba585303}{control} = \hyperlink{pic32mz__eth__driver_8h_a947d117c018c08ae7a6d9dbdbdeff9b7}{ETH\_RX\_CTRL\_NPV} | 
      \hyperlink{pic32mz__eth__driver_8h_a61a84e04ffd0a8b12a6aba4b0df6dee2}{ETH\_RX\_CTRL\_EOWN};
569 
570       \textcolor{comment}{//Point to the next descriptor in the list}
571       \hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc} = PA\_TO\_KVA1(\hyperlink{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}{rxCurBufferDesc}->
      \hyperlink{structPic32mzRxBufferDesc_a985d45d76d242c516732f87206bac3d3}{next});
572 
573       \textcolor{comment}{//Decrement BUFCNT counter}
574       ETHCON1SET = \_ETHCON1\_BUFCDEC\_MASK;
575    \}
576    \textcolor{keywordflow}{else}
577    \{
578       \textcolor{comment}{//No more data in the receive buffer}
579       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca838a7a87abb42b87d6862e98849fab2d}{ERROR\_BUFFER\_EMPTY};
580    \}
581 
582    \textcolor{comment}{//Return status code}
583    \textcolor{keywordflow}{return} error;
584 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_a7b47986b0a980a2fddb6d53638d081af}\label{pic32mz__eth__driver_8c_a7b47986b0a980a2fddb6d53638d081af}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Send\+Packet@{pic32mz\+Eth\+Send\+Packet}}
\index{pic32mz\+Eth\+Send\+Packet@{pic32mz\+Eth\+Send\+Packet}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Send\+Packet()}{pic32mzEthSendPacket()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} pic32mz\+Eth\+Send\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset }\end{DoxyParamCaption})}



Send a packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the data to send \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first data byte \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 469 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
471 \{
472    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
473    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} \hyperlink{dtls__misc_8h_a74bce8e92ccabd0c885447114a48b80e}{value};
474 
475    \textcolor{comment}{//Retrieve the length of the packet}
476    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
477 
478    \textcolor{comment}{//Check the frame length}
479    \textcolor{keywordflow}{if}(length > \hyperlink{pic32mz__eth__driver_8h_aa2a486a97ff13f64ca59eb137e75121d}{PIC32MZ\_ETH\_TX\_BUFFER\_SIZE})
480    \{
481       \textcolor{comment}{//The transmitter can accept another packet}
482       \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&interface->nicTxEvent);
483       \textcolor{comment}{//Report an error}
484       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
485    \}
486 
487    \textcolor{comment}{//Make sure the current buffer is available for writing}
488    \textcolor{keywordflow}{if}(\hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc}->\hyperlink{structPic32mzTxBufferDesc_abcb8135aadb503621ad36e2caf44739d}{control} & \hyperlink{pic32mz__eth__driver_8h_a06e68519afebf75a256c2e812640b0ad}{ETH\_TX\_CTRL\_EOWN})
489       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
490 
491    \textcolor{comment}{//Copy user data to the transmit buffer}
492    \hyperlink{net__mem_8c_af3ed1bc3f7d55f830cbbe6aa12e61af0}{netBufferRead}(PA\_TO\_KVA1(\hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc}->\hyperlink{structPic32mzTxBufferDesc_a871be0effc55fb3015607af662aec31d}{address}), buffer, 
      \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset}, length);
493 
494    \textcolor{comment}{//Write the number of bytes to send}
495    value = (length << 16) & \hyperlink{pic32mz__eth__driver_8h_af15c84df61ec5baa434241626a151f4a}{ETH\_TX\_CTRL\_BYTE\_COUNT};
496    \textcolor{comment}{//Set SOP and EOP flags since the data fits in a single buffer}
497    value |= \hyperlink{pic32mz__eth__driver_8h_a6cba77d10c41fd9b05de88da52997908}{ETH\_TX\_CTRL\_SOP} | \hyperlink{pic32mz__eth__driver_8h_a712aeee5066886cca9ea64716b6f902a}{ETH\_TX\_CTRL\_EOP} | 
      \hyperlink{pic32mz__eth__driver_8h_a3f8530c8d55d474c7a22219e9755c52a}{ETH\_TX\_CTRL\_NPV};
498    \textcolor{comment}{//Give the ownership of the descriptor to the DMA}
499    \hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc}->\hyperlink{structPic32mzTxBufferDesc_abcb8135aadb503621ad36e2caf44739d}{control} = value | \hyperlink{pic32mz__eth__driver_8h_a06e68519afebf75a256c2e812640b0ad}{ETH\_TX\_CTRL\_EOWN};
500 
501    \textcolor{comment}{//Set TXRTS bit to start the transmission}
502    ETHCON1SET = \_ETHCON1\_TXRTS\_MASK;
503 
504    \textcolor{comment}{//Point to the next descriptor in the list}
505    \hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc} = PA\_TO\_KVA1(\hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc}->
      \hyperlink{structPic32mzTxBufferDesc_a599f7ed90daa9438a6e9156951d444ef}{next});
506 
507    \textcolor{comment}{//Check whether the next buffer is available for writing}
508    \textcolor{keywordflow}{if}(!(\hyperlink{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}{txCurBufferDesc}->\hyperlink{structPic32mzTxBufferDesc_abcb8135aadb503621ad36e2caf44739d}{control} & \hyperlink{pic32mz__eth__driver_8h_a06e68519afebf75a256c2e812640b0ad}{ETH\_TX\_CTRL\_EOWN}))
509    \{
510       \textcolor{comment}{//The transmitter can accept another packet}
511       \hyperlink{os__port__chibios_8c_afc1d64fc90afbf03baecfa636bb99ff7}{osSetEvent}(&interface->nicTxEvent);
512    \}
513 
514    \textcolor{comment}{//Data successfully written}
515    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
516 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_a21514d0cd0cd5d576bcfacd01ced3891}\label{pic32mz__eth__driver_8c_a21514d0cd0cd5d576bcfacd01ced3891}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Tick@{pic32mz\+Eth\+Tick}}
\index{pic32mz\+Eth\+Tick@{pic32mz\+Eth\+Tick}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Tick()}{pic32mzEthTick()}}
{\footnotesize\ttfamily void pic32mz\+Eth\+Tick (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



P\+I\+C32\+MZ Ethernet M\+AC timer handler. 

This routine is periodically called by the T\+C\+P/\+IP stack to handle periodic operations such as polling the link state


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 347 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
348 \{
349    \textcolor{comment}{//Handle periodic operations}
350    interface->phyDriver->tick(interface);
351 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_ac2f4ebcdf657e2a281189a3d318266e6}\label{pic32mz__eth__driver_8c_ac2f4ebcdf657e2a281189a3d318266e6}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Update\+Mac\+Addr\+Filter@{pic32mz\+Eth\+Update\+Mac\+Addr\+Filter}}
\index{pic32mz\+Eth\+Update\+Mac\+Addr\+Filter@{pic32mz\+Eth\+Update\+Mac\+Addr\+Filter}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Update\+Mac\+Addr\+Filter()}{pic32mzEthUpdateMacAddrFilter()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} pic32mz\+Eth\+Update\+Mac\+Addr\+Filter (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Configure M\+AC address filtering. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 593 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
594 \{
595    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
596    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{md5_8c_af11ea3cdbca7345eb6a4a8ac5ce0434d}{k};
597    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} crc;
598    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} hashTable[2];
599    \hyperlink{structMacFilterEntry}{MacFilterEntry} *entry;
600 
601    \textcolor{comment}{//Debug message}
602    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Updating MAC filter...\(\backslash\)r\(\backslash\)n"});
603 
604    \textcolor{comment}{//Clear hash table}
605    hashTable[0] = 0;
606    hashTable[1] = 0;
607 
608    \textcolor{comment}{//The MAC address filter contains the list of MAC addresses to accept}
609    \textcolor{comment}{//when receiving an Ethernet frame}
610    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{ethernet_8h_ab64acae68b5723774fa272c62efd7c2b}{MAC\_ADDR\_FILTER\_SIZE}; i++)
611    \{
612       \textcolor{comment}{//Point to the current entry}
613       entry = &interface->macAddrFilter[i];
614 
615       \textcolor{comment}{//Valid entry?}
616       \textcolor{keywordflow}{if}(entry->\hyperlink{structMacFilterEntry_a4a1195d4086f58ef57862fa43551e73a}{refCount} > 0)
617       \{
618          \textcolor{comment}{//Compute CRC over the current MAC address}
619          crc = \hyperlink{pic32mz__eth__driver_8c_a5e126e8bbce50d63c10dca9665b18c0b}{pic32mzEthCalcCrc}(&entry->\hyperlink{structMacFilterEntry_a30caa211d6cc1bb2416165526a2ab6cb}{addr}, \textcolor{keyword}{sizeof}(
      \hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{MacAddr}));
620          \textcolor{comment}{//Calculate the corresponding index in the table}
621          k = (crc >> 23) & 0x3F;
622          \textcolor{comment}{//Update hash table contents}
623          hashTable[k / 32] |= (1 << (k % 32));
624       \}
625    \}
626 
627    \textcolor{comment}{//Write the hash table}
628    ETHHT0 = hashTable[0];
629    ETHHT1 = hashTable[1];
630 
631    \textcolor{comment}{//Debug message}
632    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  ETHHT0 = %08"} PRIX32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, ETHHT0);
633    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  ETHHT1 = %08"} PRIX32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, ETHHT1);
634 
635    \textcolor{comment}{//Successful processing}
636    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
637 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_a09f28d9f779b70c51bdea495153ea326}\label{pic32mz__eth__driver_8c_a09f28d9f779b70c51bdea495153ea326}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Update\+Mac\+Config@{pic32mz\+Eth\+Update\+Mac\+Config}}
\index{pic32mz\+Eth\+Update\+Mac\+Config@{pic32mz\+Eth\+Update\+Mac\+Config}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Update\+Mac\+Config()}{pic32mzEthUpdateMacConfig()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} pic32mz\+Eth\+Update\+Mac\+Config (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Adjust M\+AC configuration parameters for proper operation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 646 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
647 \{
648    \textcolor{comment}{//Check current operating speed}
649    \textcolor{keywordflow}{if}(interface->linkSpeed == \hyperlink{nic_8h_afef666155a43e0a2a3a1f0df9e50bab4a3001394d2b59b22c97f6957e07ca28fd}{NIC\_LINK\_SPEED\_100MBPS})
650    \{
651       \textcolor{comment}{//100BASE-TX operation mode}
652       EMAC1SUPPSET = \_EMAC1SUPP\_SPEEDRMII\_MASK;
653    \}
654    \textcolor{keywordflow}{else}
655    \{
656       \textcolor{comment}{//10BASE-T operation mode}
657       EMAC1SUPPCLR = \_EMAC1SUPP\_SPEEDRMII\_MASK;
658    \}
659 
660    \textcolor{comment}{//Half-duplex or full-duplex mode?}
661    \textcolor{keywordflow}{if}(interface->duplexMode == \hyperlink{nic_8h_ae96e77ca948a3796e2d1900a73f133daa2c75584234136d8fd79f372116d26340}{NIC\_FULL\_DUPLEX\_MODE})
662    \{
663       \textcolor{comment}{//Configure FULLDPLX bit to match the current duplex mode}
664       EMAC1CFG2SET = \_EMAC1CFG2\_FULLDPLX\_MASK;
665       \textcolor{comment}{//Configure the Back-to-Back Inter-Packet Gap register}
666       EMAC1IPGT = 0x15;
667    \}
668    \textcolor{keywordflow}{else}
669    \{
670       \textcolor{comment}{//Configure FULLDPLX bit to match the current duplex mode}
671       EMAC1CFG2CLR = \_EMAC1CFG2\_FULLDPLX\_MASK;
672       \textcolor{comment}{//Configure the Back-to-Back Inter-Packet Gap register}
673       EMAC1IPGT = 0x12;
674    \}
675 
676    \textcolor{comment}{//Successful processing}
677    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
678 \}
\end{DoxyCode}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_acd392fde7b41b39ff83d64361f40d1c6}\label{pic32mz__eth__driver_8c_acd392fde7b41b39ff83d64361f40d1c6}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Write\+Phy\+Reg@{pic32mz\+Eth\+Write\+Phy\+Reg}}
\index{pic32mz\+Eth\+Write\+Phy\+Reg@{pic32mz\+Eth\+Write\+Phy\+Reg}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Write\+Phy\+Reg()}{pic32mzEthWritePhyReg()}}
{\footnotesize\ttfamily void pic32mz\+Eth\+Write\+Phy\+Reg (\begin{DoxyParamCaption}\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{opcode,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{phy\+Addr,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{reg\+Addr,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{data }\end{DoxyParamCaption})}



Write P\+HY register. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em opcode} & Access type (2 bits) \\
\hline
\mbox{\tt in}  & {\em phy\+Addr} & P\+HY address (5 bits) \\
\hline
\mbox{\tt in}  & {\em reg\+Addr} & Register address (5 bits) \\
\hline
\mbox{\tt in}  & {\em data} & Register value \\
\hline
\end{DoxyParams}


Definition at line 689 of file pic32mz\+\_\+eth\+\_\+driver.\+c.


\begin{DoxyCode}
691 \{
692    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
693 
694    \textcolor{comment}{//Valid opcode?}
695    \textcolor{keywordflow}{if}(\hyperlink{dns__common_8h_a5c1b56e6bccc2a95dbddf1a08e56e87d}{opcode} == \hyperlink{nic_8h_a1fa0e7586e487646372c0f169c9ea786}{SMI\_OPCODE\_WRITE})
696    \{
697       \textcolor{comment}{//Set PHY address and register address}
698       EMAC1MADR = (phyAddr << \_EMAC1MADR\_PHYADDR\_POSITION) | \hyperlink{modbus__common_8h_a184543cc09c0f45a36f7cd93a99aeae3}{regAddr};
699       \textcolor{comment}{//Start a write operation}
700       EMAC1MWTD = \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} & \_EMAC1MWTD\_MWTD\_MASK;
701 
702       \textcolor{comment}{//Wait for busy bit to be set}
703       \textcolor{keywordflow}{for}(i = 0; i < 16; i++)
704       \{
705          \_\_asm\_\_ \_\_volatile\_\_ (\textcolor{stringliteral}{"nop;"});
706       \}
707 
708       \textcolor{comment}{//Wait for the write to complete}
709       \textcolor{keywordflow}{while}(EMAC1MIND & \_EMAC1MIND\_MIIMBUSY\_MASK)
710       \{
711       \}
712    \}
713    \textcolor{keywordflow}{else}
714    \{
715       \textcolor{comment}{//The MAC peripheral only supports standard Clause 22 opcodes}
716    \}
717 \}
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{pic32mz__eth__driver_8c_ab4d353d5e0183f1695694408a26ce9d6}\label{pic32mz__eth__driver_8c_ab4d353d5e0183f1695694408a26ce9d6}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!nic\+Driver\+Interface@{nic\+Driver\+Interface}}
\index{nic\+Driver\+Interface@{nic\+Driver\+Interface}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{nic\+Driver\+Interface}{nicDriverInterface}}
{\footnotesize\ttfamily \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface}$\ast$ nic\+Driver\+Interface\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 42 of file pic32mz\+\_\+eth\+\_\+driver.\+c.

\mbox{\Hypertarget{pic32mz__eth__driver_8c_a17454238968d3e488fe5985355566129}\label{pic32mz__eth__driver_8c_a17454238968d3e488fe5985355566129}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!pic32mz\+Eth\+Driver@{pic32mz\+Eth\+Driver}}
\index{pic32mz\+Eth\+Driver@{pic32mz\+Eth\+Driver}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{pic32mz\+Eth\+Driver}{pic32mzEthDriver}}
{\footnotesize\ttfamily const \hyperlink{structNicDriver}{Nic\+Driver} pic32mz\+Eth\+Driver}

{\bfseries Initial value\+:}
\begin{DoxyCode}
=
\{
   \hyperlink{nic_8h_ac1ce8659a9797513ecd9cc1afedce40ba84802cab6ee937691c3d76122ffaffcd}{NIC\_TYPE\_ETHERNET},
   \hyperlink{ethernet_8h_a6f29d2b24a262d91b7158713728d45f2}{ETH\_MTU},
   \hyperlink{pic32mz__eth__driver_8c_a3a4531c0f7cae82a0bbeb0eafa4c7cb6}{pic32mzEthInit},
   \hyperlink{pic32mz__eth__driver_8c_a21514d0cd0cd5d576bcfacd01ced3891}{pic32mzEthTick},
   \hyperlink{pic32mz__eth__driver_8c_a8091de5de960e9b76e3d2a8595195e24}{pic32mzEthEnableIrq},
   \hyperlink{pic32mz__eth__driver_8c_ae6f53411b89fbd0a9f9788533867229e}{pic32mzEthDisableIrq},
   \hyperlink{pic32mz__eth__driver_8c_a5533c975decf0e50d121a73394a43c33}{pic32mzEthEventHandler},
   \hyperlink{pic32mz__eth__driver_8c_a7b47986b0a980a2fddb6d53638d081af}{pic32mzEthSendPacket},
   \hyperlink{pic32mz__eth__driver_8c_ac2f4ebcdf657e2a281189a3d318266e6}{pic32mzEthUpdateMacAddrFilter},
   \hyperlink{pic32mz__eth__driver_8c_a09f28d9f779b70c51bdea495153ea326}{pic32mzEthUpdateMacConfig},
   \hyperlink{pic32mz__eth__driver_8c_acd392fde7b41b39ff83d64361f40d1c6}{pic32mzEthWritePhyReg},
   \hyperlink{pic32mz__eth__driver_8c_a4c81d4c18a7fd5b30801b66398d29fe2}{pic32mzEthReadPhyReg},
   \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE},
   \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE},
   \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE},
   \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE}
\}
\end{DoxyCode}


P\+I\+C32\+MZ Ethernet M\+AC driver. 



Definition at line 67 of file pic32mz\+\_\+eth\+\_\+driver.\+c.

\mbox{\Hypertarget{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}\label{pic32mz__eth__driver_8c_af3c9f5b6a5c424f9c9b1a86e9c1737a5}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!rx\+Cur\+Buffer\+Desc@{rx\+Cur\+Buffer\+Desc}}
\index{rx\+Cur\+Buffer\+Desc@{rx\+Cur\+Buffer\+Desc}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{rx\+Cur\+Buffer\+Desc}{rxCurBufferDesc}}
{\footnotesize\ttfamily \hyperlink{structPic32mzRxBufferDesc}{Pic32mz\+Rx\+Buffer\+Desc}$\ast$ rx\+Cur\+Buffer\+Desc\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 60 of file pic32mz\+\_\+eth\+\_\+driver.\+c.

\mbox{\Hypertarget{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}\label{pic32mz__eth__driver_8c_a5aa8d178a1f6473b121c3c7695bf07aa}} 
\index{pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}!tx\+Cur\+Buffer\+Desc@{tx\+Cur\+Buffer\+Desc}}
\index{tx\+Cur\+Buffer\+Desc@{tx\+Cur\+Buffer\+Desc}!pic32mz\+\_\+eth\+\_\+driver.\+c@{pic32mz\+\_\+eth\+\_\+driver.\+c}}
\subsubsection{\texorpdfstring{tx\+Cur\+Buffer\+Desc}{txCurBufferDesc}}
{\footnotesize\ttfamily \hyperlink{structPic32mzTxBufferDesc}{Pic32mz\+Tx\+Buffer\+Desc}$\ast$ tx\+Cur\+Buffer\+Desc\hspace{0.3cm}{\ttfamily [static]}}



Definition at line 58 of file pic32mz\+\_\+eth\+\_\+driver.\+c.

