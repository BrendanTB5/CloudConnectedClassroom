\hypertarget{tftp__server__misc_8c}{}\section{cyclone\+\_\+tcp/tftp/tftp\+\_\+server\+\_\+misc.c File Reference}
\label{tftp__server__misc_8c}\index{cyclone\+\_\+tcp/tftp/tftp\+\_\+server\+\_\+misc.\+c@{cyclone\+\_\+tcp/tftp/tftp\+\_\+server\+\_\+misc.\+c}}


Helper functions for T\+F\+TP server.  


{\ttfamily \#include \char`\"{}tftp/tftp\+\_\+server.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tftp/tftp\+\_\+server\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{tftp__server__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_ade296bfed5309e0f497d85905610d9a9}{T\+F\+T\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{tftp__server__misc_8c_aa9bf9834436dbd5df47d52ff62da36a6}{tftp\+Server\+Tick} (\hyperlink{tftp__server_8h_a74392166fd32409398d53d11de1d62fa}{Tftp\+Server\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Handle periodic operations. \end{DoxyCompactList}\item 
\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$ \hyperlink{tftp__server__misc_8c_af981044307a69122bdcb6966304235ce}{tftp\+Server\+Open\+Connection} (\hyperlink{tftp__server_8h_a74392166fd32409398d53d11de1d62fa}{Tftp\+Server\+Context} $\ast$context, const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$client\+Ip\+Addr, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} client\+Port)
\begin{DoxyCompactList}\small\item\em Create client connection. \end{DoxyCompactList}\item 
void \hyperlink{tftp__server__misc_8c_a7ceeff8d585baec20a22863e22104721}{tftp\+Server\+Close\+Connection} (\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Close client connection. \end{DoxyCompactList}\item 
void \hyperlink{tftp__server__misc_8c_a6fe187acd7a366cae91106d096b215ad}{tftp\+Server\+Accept\+Request} (\hyperlink{tftp__server_8h_a74392166fd32409398d53d11de1d62fa}{Tftp\+Server\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Accept connection request. \end{DoxyCompactList}\item 
void \hyperlink{tftp__server__misc_8c_a26e3bf5cc0cc5e8a0c415cdfd400770d}{tftp\+Server\+Process\+Packet} (\hyperlink{tftp__server_8h_a74392166fd32409398d53d11de1d62fa}{Tftp\+Server\+Context} $\ast$context, \hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Process incoming packet. \end{DoxyCompactList}\item 
void \hyperlink{tftp__server__misc_8c_ab14d8e8d0a99daf673a0a434d3f3b8d9}{tftp\+Server\+Process\+Rrq\+Packet} (\hyperlink{tftp__server_8h_a74392166fd32409398d53d11de1d62fa}{Tftp\+Server\+Context} $\ast$context, const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$client\+Ip\+Addr, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} client\+Port, const \hyperlink{tftp__common_8h_a4b1e4ca412d8e3cd22c695e2d201a69a}{Tftp\+Rrq\+Packet} $\ast$rrq\+Packet, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process incoming R\+RQ packet. \end{DoxyCompactList}\item 
void \hyperlink{tftp__server__misc_8c_a00e653a535af8257ba5ee7e44fb5671a}{tftp\+Server\+Process\+Wrq\+Packet} (\hyperlink{tftp__server_8h_a74392166fd32409398d53d11de1d62fa}{Tftp\+Server\+Context} $\ast$context, const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$client\+Ip\+Addr, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} client\+Port, const \hyperlink{tftp__common_8h_aa49f0fa1700f5991479cb7e3b1afcf52}{Tftp\+Wrq\+Packet} $\ast$wrq\+Packet, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process incoming W\+RQ packet. \end{DoxyCompactList}\item 
void \hyperlink{tftp__server__misc_8c_a877c3ef5a9cbc4f13cba5da04d682715}{tftp\+Server\+Process\+Data\+Packet} (\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$connection, const \hyperlink{tftp__common_8h_a72db11cb5bc2afb6305fb3cb0f409eb5}{Tftp\+Data\+Packet} $\ast$data\+Packet, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process incoming D\+A\+TA packet. \end{DoxyCompactList}\item 
void \hyperlink{tftp__server__misc_8c_a536e84ec6aa8d21283dbc1d20860e82f}{tftp\+Server\+Process\+Ack\+Packet} (\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$connection, const \hyperlink{tftp__common_8h_a8b1a2e8ac454913655b3c5dc0bf08c56}{Tftp\+Ack\+Packet} $\ast$ack\+Packet, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process incoming A\+CK packet. \end{DoxyCompactList}\item 
void \hyperlink{tftp__server__misc_8c_adeeccb39487c5d4550d46a36cc7c2581}{tftp\+Server\+Process\+Error\+Packet} (\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$connection, const \hyperlink{tftp__common_8h_a8e737a9f3fbc1bf6983de7c443de0d83}{Tftp\+Error\+Packet} $\ast$error\+Packet, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Process incoming E\+R\+R\+OR packet. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tftp__server__misc_8c_abf2de292f5e01c75fb52fe3f83bb5930}{tftp\+Server\+Send\+Data\+Packet} (\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Send D\+A\+TA packet. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tftp__server__misc_8c_a166930efd8de2b206596bc73c31b793a}{tftp\+Server\+Send\+Ack\+Packet} (\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Send A\+CK packet. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tftp__server__misc_8c_a9df33e290cecbea5dbda3d25c5a0e27a}{tftp\+Server\+Send\+Error\+Packet} (\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$connection, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{tftp__common_8h_a78abca92c8fa2790c1d32470831537e8}{error\+Code}, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a949a7e29724e2db6f2bd70df72c74960}{error\+Msg})
\begin{DoxyCompactList}\small\item\em Send E\+R\+R\+OR packet. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tftp__server__misc_8c_a5ad74ef8c60ee9c56a16193e13ca130d}{tftp\+Server\+Retransmit\+Packet} (\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Retransmit the last packet. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Helper functions for T\+F\+TP server. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{tftp__server__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{tftp__server__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_ade296bfed5309e0f497d85905610d9a9}{T\+F\+T\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file tftp\+\_\+server\+\_\+misc.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{tftp__server__misc_8c_a6fe187acd7a366cae91106d096b215ad}\label{tftp__server__misc_8c_a6fe187acd7a366cae91106d096b215ad}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Accept\+Request@{tftp\+Server\+Accept\+Request}}
\index{tftp\+Server\+Accept\+Request@{tftp\+Server\+Accept\+Request}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Accept\+Request()}{tftpServerAcceptRequest()}}
{\footnotesize\ttfamily void tftp\+Server\+Accept\+Request (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a74392166fd32409398d53d11de1d62fa}{Tftp\+Server\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Accept connection request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+F\+TP server context \\
\hline
\end{DoxyParams}


Definition at line 260 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
261 \{
262    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
263    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
264    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dns__common_8h_a5c1b56e6bccc2a95dbddf1a08e56e87d}{opcode};
265    \hyperlink{structIpAddr}{IpAddr} clientIpAddr;
266    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} clientPort;
267 
268    \textcolor{comment}{//Read incoming TFTP packet}
269    error = \hyperlink{socket_8c_a26af4b642b71708e1408fc94483f90bb}{socketReceiveFrom}(context->socket, &clientIpAddr, &clientPort,
270       context->packet, \hyperlink{tftp__server_8h_a691c548eb2ec25b559ea9029f36a5276}{TFTP\_SERVER\_MAX\_PACKET\_SIZE}, &length, 0);
271 
272    \textcolor{comment}{//Failed to read packet?}
273    \textcolor{keywordflow}{if}(error)
274       \textcolor{keywordflow}{return};
275 
276    \textcolor{comment}{//Debug message}
277    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"TFTP Server: Accepting connection from %s port %"} PRIu16 \textcolor{stringliteral}{"...\(\backslash\)r\(\backslash\)n"},
278       \hyperlink{ip_8c_aecdb577de79f65f8c814d5f101c7c6ae}{ipAddrToString}(&clientIpAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}), clientPort);
279 
280    \textcolor{comment}{//Sanity check}
281    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}))
282       \textcolor{keywordflow}{return};
283 
284    \textcolor{comment}{//Retrieve TFTP packet type}
285    opcode = \hyperlink{cpu__endian_8h_ae21854587c05993c850b537156470088}{LOAD16BE}(context->packet);
286 
287    \textcolor{comment}{//Read request received?}
288    \textcolor{keywordflow}{if}(opcode == \hyperlink{tftp__common_8h_a833ab123c017ad4062778a372d0dc92ea384b091233466a21aed4b36a93bf1d50}{TFTP\_OPCODE\_RRQ})
289    \{
290       \textcolor{comment}{//Process RRQ packet}
291       \hyperlink{tftp__server__misc_8c_ab14d8e8d0a99daf673a0a434d3f3b8d9}{tftpServerProcessRrqPacket}(context, &clientIpAddr,
292          clientPort, (\hyperlink{tftp__common_8h_a4b1e4ca412d8e3cd22c695e2d201a69a}{TftpRrqPacket} *) context->packet, length);
293    \}
294    \textcolor{comment}{//Write request received?}
295    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(opcode == \hyperlink{tftp__common_8h_a833ab123c017ad4062778a372d0dc92ea615e060a29a1a318043e718cb3f65564}{TFTP\_OPCODE\_WRQ})
296    \{
297       \textcolor{comment}{//Process WRQ packet}
298       \hyperlink{tftp__server__misc_8c_a00e653a535af8257ba5ee7e44fb5671a}{tftpServerProcessWrqPacket}(context, &clientIpAddr,
299          clientPort, (\hyperlink{tftp__common_8h_aa49f0fa1700f5991479cb7e3b1afcf52}{TftpWrqPacket} *) context->packet, length);
300    \}
301    \textcolor{comment}{//Invalid request received?}
302    \textcolor{keywordflow}{else}
303    \{
304       \textcolor{comment}{//Discard incoming packet}
305    \}
306 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_a7ceeff8d585baec20a22863e22104721}\label{tftp__server__misc_8c_a7ceeff8d585baec20a22863e22104721}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Close\+Connection@{tftp\+Server\+Close\+Connection}}
\index{tftp\+Server\+Close\+Connection@{tftp\+Server\+Close\+Connection}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Close\+Connection()}{tftpServerCloseConnection()}}
{\footnotesize\ttfamily void tftp\+Server\+Close\+Connection (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Close client connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}


Definition at line 219 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
220 \{
221    \textcolor{comment}{//Valid connection?}
222    \textcolor{keywordflow}{if}(connection != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
223    \{
224       \textcolor{comment}{//Debug message}
225       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"TFTP Server: Closing connection...\(\backslash\)r\(\backslash\)n"});
226 
227       \textcolor{comment}{//Any active connection?}
228       \textcolor{keywordflow}{if}(connection->socket != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
229       \{
230          \textcolor{comment}{//Close UDP socket}
231          \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(connection->socket);
232          connection->socket = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
233       \}
234 
235       \textcolor{comment}{//Check whether a read or write operation is in progress...}
236       \textcolor{keywordflow}{if}(connection->file != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
237       \{
238          \textcolor{comment}{//Properly close the file before closing the connection}
239          \textcolor{keywordflow}{if}(connection->settings->closeFileCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
240          \{
241             \textcolor{comment}{//Invoke user callback function}
242             connection->settings->closeFileCallback(connection->file);
243          \}
244 
245          \textcolor{comment}{//Mark the file as closed}
246          connection->file = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
247       \}
248 
249       \textcolor{comment}{//Mark the connection as closed}
250       connection->state = \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aaa4e48853d260c8e956ae519c1f2deba2}{TFTP\_STATE\_CLOSED};
251    \}
252 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_af981044307a69122bdcb6966304235ce}\label{tftp__server__misc_8c_af981044307a69122bdcb6966304235ce}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Open\+Connection@{tftp\+Server\+Open\+Connection}}
\index{tftp\+Server\+Open\+Connection@{tftp\+Server\+Open\+Connection}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Open\+Connection()}{tftpServerOpenConnection()}}
{\footnotesize\ttfamily \hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection}$\ast$ tftp\+Server\+Open\+Connection (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a74392166fd32409398d53d11de1d62fa}{Tftp\+Server\+Context} $\ast$}]{context,  }\item[{const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$}]{client\+Ip\+Addr,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{client\+Port }\end{DoxyParamCaption})}



Create client connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+F\+TP server context \\
\hline
\mbox{\tt in}  & {\em client\+Ip\+Addr} & IP address of the client \\
\hline
\mbox{\tt in}  & {\em client\+Port} & Port number used by the client \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Pointer to the structure describing the connection 
\end{DoxyReturn}


Definition at line 111 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
113 \{
114    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
115    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
116    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
117    \hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{TftpClientConnection} *connection;
118    \hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{TftpClientConnection} *oldestConnection;
119 
120    \textcolor{comment}{//Get current time}
121    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
122 
123    \textcolor{comment}{//Keep track of the oldest connection that is waiting to retransmit}
124    \textcolor{comment}{//the final ACK}
125    oldestConnection = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
126 
127    \textcolor{comment}{//Loop through the connection table}
128    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{tftp__server_8h_a0acdd308af5bdb354e7a80dc8ff4388d}{TFTP\_SERVER\_MAX\_CONNECTIONS}; i++)
129    \{
130       \textcolor{comment}{//Point to the current entry}
131       connection = &context->connection[i];
132 
133       \textcolor{comment}{//Check the state of the current connection}
134       \textcolor{keywordflow}{if}(connection->state == \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aaa4e48853d260c8e956ae519c1f2deba2}{TFTP\_STATE\_CLOSED})
135       \{
136          \textcolor{comment}{//The current entry is available}
137          \textcolor{keywordflow}{break};
138       \}
139       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->state == \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa073b5d08094584527ccf5504f50cb630}{TFTP\_STATE\_WRITE\_COMPLETE})
140       \{
141          \textcolor{comment}{//Keep track of the oldest connection that is waiting to retransmit}
142          \textcolor{comment}{//the final ACK}
143          \textcolor{keywordflow}{if}(oldestConnection == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
144          \{
145             oldestConnection = connection;
146          \}
147          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}((time - connection->timestamp) > (time - oldestConnection->timestamp))
148          \{
149             oldestConnection = connection;
150          \}
151       \}
152    \}
153 
154    \textcolor{comment}{//The oldest connection that is waiting to retransmit the final ACK can be}
155    \textcolor{comment}{//reused when the connection table runs out of space}
156    \textcolor{keywordflow}{if}(i >= TFTP\_SERVER\_MAX\_CONNECTIONS)
157    \{
158       \textcolor{comment}{//Close the oldest connection}
159       \hyperlink{tftp__server__misc_8c_a7ceeff8d585baec20a22863e22104721}{tftpServerCloseConnection}(oldestConnection);
160       \textcolor{comment}{//Reuse the connection}
161       connection = oldestConnection;
162    \}
163 
164    \textcolor{comment}{//Failed to create a new connection?}
165    \textcolor{keywordflow}{if}(connection == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
166       \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
167 
168    \textcolor{comment}{//Clear the structure describing the connection}
169    memset(connection, 0, \textcolor{keyword}{sizeof}(\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{TftpClientConnection}));
170 
171    \textcolor{comment}{//Open a UDP socket}
172    connection->socket = \hyperlink{socket_8c_aa139bbf42b326b52eb08cf52771ac337}{socketOpen}(\hyperlink{socket_8h_aa78c7398fa81f7f62aa233159d4d8d97a26963b01dac3a99a930779035d3796a7}{SOCKET\_TYPE\_DGRAM}, 
      \hyperlink{socket_8h_a56eb0e60bda5d1d8a2e702228405d969a53c45ffdb9dee4a8f885b816386a99b8}{SOCKET\_IP\_PROTO\_UDP});
173 
174    \textcolor{comment}{//Failed to open socket?}
175    \textcolor{keywordflow}{if}(connection->socket == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
176       \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
177 
178    \textcolor{comment}{//Associate the socket with the relevant interface}
179    error = \hyperlink{net__legacy_8h_a80bc49fa99e5654d8c345cd5c70d36d3}{socketBindToInterface}(connection->socket, context->settings.interface);
180 
181    \textcolor{comment}{//Any error to report?}
182    \textcolor{keywordflow}{if}(error)
183    \{
184       \textcolor{comment}{//Clean up side effects}
185       \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(connection->socket);
186       connection->socket = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
187       \textcolor{comment}{//Exit immediately}
188       \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
189    \}
190 
191    \textcolor{comment}{//Connect the socket to the remote TFTP client}
192    error = \hyperlink{socket_8c_aff3e3c0abc332f42189fce8f362fbd63}{socketConnect}(connection->socket, clientIpAddr, clientPort);
193 
194    \textcolor{comment}{//Any error to report?}
195    \textcolor{keywordflow}{if}(error)
196    \{
197       \textcolor{comment}{//Clean up side effects}
198       \hyperlink{socket_8c_ac5012e9f71c97e2ea0410f2c5baccb0e}{socketClose}(connection->socket);
199       connection->socket = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
200       \textcolor{comment}{//Exit immediately}
201       \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
202    \}
203 
204    \textcolor{comment}{//Reference to the TFTP server settings}
205    connection->settings = &context->settings;
206    \textcolor{comment}{//Update connection state}
207    connection->state = \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa0b08c70235daa345ca86c605923a4675}{TFTP\_STATE\_OPEN};
208 
209    \textcolor{comment}{//Pointer to the structure describing the connection}
210    \textcolor{keywordflow}{return} connection;
211 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_a536e84ec6aa8d21283dbc1d20860e82f}\label{tftp__server__misc_8c_a536e84ec6aa8d21283dbc1d20860e82f}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Process\+Ack\+Packet@{tftp\+Server\+Process\+Ack\+Packet}}
\index{tftp\+Server\+Process\+Ack\+Packet@{tftp\+Server\+Process\+Ack\+Packet}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Process\+Ack\+Packet()}{tftpServerProcessAckPacket()}}
{\footnotesize\ttfamily void tftp\+Server\+Process\+Ack\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{tftp__common_8h_a8b1a2e8ac454913655b3c5dc0bf08c56}{Tftp\+Ack\+Packet} $\ast$}]{ack\+Packet,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process incoming A\+CK packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em ack\+Packet} & Pointer to the A\+CK packet \\
\hline
\mbox{\tt in}  & {\em length} & Length of the packet, in bytes \\
\hline
\end{DoxyParams}


Definition at line 666 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
668 \{
669    \textcolor{comment}{//Debug message}
670    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"TFTP Server: ACK packet received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
671       \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
672 
673    \textcolor{comment}{//Make sure the length of the ACK packet is acceptable}
674    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{tftp__common_8h_a8b1a2e8ac454913655b3c5dc0bf08c56}{TftpAckPacket}))
675       \textcolor{keywordflow}{return};
676 
677    \textcolor{comment}{//Debug message}
678    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Opcode = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(ackPacket->opcode));
679    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Block = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(ackPacket->block));
680 
681    \textcolor{comment}{//Check current state}
682    \textcolor{keywordflow}{if}(connection->state == \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa11314de8d9c41409d4afc8cfb3f674d0}{TFTP\_STATE\_READING})
683    \{
684       \textcolor{comment}{//Make sure the ACK is not a duplicate}
685       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(ackPacket->block) == connection->block)
686       \{
687          \textcolor{comment}{//The block number increases by one for each new block of data}
688          connection->block++;
689 
690          \textcolor{comment}{//Send DATA packet}
691          \hyperlink{tftp__server__misc_8c_abf2de292f5e01c75fb52fe3f83bb5930}{tftpServerSendDataPacket}(connection);
692       \}
693       \textcolor{keywordflow}{else}
694       \{
695          \textcolor{comment}{//Implementations must never resend the current DATA packet on}
696          \textcolor{comment}{//receipt of a duplicate ACK (refer to RFC 1123, section 4.2.3.1)}
697       \}
698    \}
699    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->state == \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa439bae37fc5816f3796a6b920b6e5809}{TFTP\_STATE\_READ\_COMPLETE})
700    \{
701       \textcolor{comment}{//Make sure the ACK is not a duplicate}
702       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(ackPacket->block) == connection->block)
703       \{
704          \textcolor{comment}{//The host sending the last DATA must retransmit it until the packet is}
705          \textcolor{comment}{//acknowledged or the sending host times out. If the response is an ACK,}
706          \textcolor{comment}{//the transmission was completed successfully}
707          \hyperlink{tftp__server__misc_8c_a7ceeff8d585baec20a22863e22104721}{tftpServerCloseConnection}(connection);
708       \}
709    \}
710 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_a877c3ef5a9cbc4f13cba5da04d682715}\label{tftp__server__misc_8c_a877c3ef5a9cbc4f13cba5da04d682715}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Process\+Data\+Packet@{tftp\+Server\+Process\+Data\+Packet}}
\index{tftp\+Server\+Process\+Data\+Packet@{tftp\+Server\+Process\+Data\+Packet}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Process\+Data\+Packet()}{tftpServerProcessDataPacket()}}
{\footnotesize\ttfamily void tftp\+Server\+Process\+Data\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{tftp__common_8h_a72db11cb5bc2afb6305fb3cb0f409eb5}{Tftp\+Data\+Packet} $\ast$}]{data\+Packet,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process incoming D\+A\+TA packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em data\+Packet} & Pointer to the D\+A\+TA packet \\
\hline
\mbox{\tt in}  & {\em length} & Length of the packet, in bytes \\
\hline
\end{DoxyParams}


Definition at line 561 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
563 \{
564    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
565    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
566 
567    \textcolor{comment}{//Debug message}
568    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"TFTP Server: DATA packet received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
569       \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
570 
571    \textcolor{comment}{//Make sure the length of the DATA packet is acceptable}
572    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{tftp__common_8h_a72db11cb5bc2afb6305fb3cb0f409eb5}{TftpDataPacket}))
573       \textcolor{keywordflow}{return};
574 
575    \textcolor{comment}{//Calculate the length of the data}
576    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \textcolor{keyword}{sizeof}(\hyperlink{tftp__common_8h_a72db11cb5bc2afb6305fb3cb0f409eb5}{TftpDataPacket});
577 
578    \textcolor{comment}{//Debug message}
579    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Opcode = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(dataPacket->opcode));
580    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Block = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(dataPacket->block));
581 
582    \textcolor{comment}{//Check current state}
583    \textcolor{keywordflow}{if}(connection->state == \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa326240f96906edcdd12338d4fe20b61f}{TFTP\_STATE\_WRITING})
584    \{
585       \textcolor{comment}{//Check block number}
586       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(dataPacket->block) == connection->block)
587       \{
588          \textcolor{comment}{//Write data to the output file}
589          \textcolor{keywordflow}{if}(connection->settings->writeFileCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
590          \{
591             \textcolor{comment}{//Calculate the offset relative to the beginning of the file}
592             offset = (connection->block - 1) * \hyperlink{tftp__server_8h_a3576af3363d6b7da73ca241bb583f139}{TFTP\_SERVER\_BLOCK\_SIZE};
593 
594             \textcolor{comment}{//Invoke user callback function}
595             error = connection->settings->writeFileCallback(connection->file,
596                offset, dataPacket->data, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
597          \}
598          \textcolor{keywordflow}{else}
599          \{
600             \textcolor{comment}{//No callback function defined}
601             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca7446f962c635e715f75bc4aff05feb77}{ERROR\_WRITE\_FAILED};
602          \}
603 
604          \textcolor{comment}{//Check status code}
605          \textcolor{keywordflow}{if}(!error)
606          \{
607             \textcolor{comment}{//Acknowledge the DATA packet}
608             \hyperlink{tftp__server__misc_8c_a166930efd8de2b206596bc73c31b793a}{tftpServerSendAckPacket}(connection);
609 
610             \textcolor{comment}{//Increment block number}
611             connection->block++;
612 
613             \textcolor{comment}{//A data packet of less than 512 bytes signals termination of the transfer}
614             \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \hyperlink{tftp__server_8h_a3576af3363d6b7da73ca241bb583f139}{TFTP\_SERVER\_BLOCK\_SIZE})
615             \{
616                \textcolor{comment}{//Properly close the file}
617                \textcolor{keywordflow}{if}(connection->settings->closeFileCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
618                \{
619                   \textcolor{comment}{//Invoke user callback function}
620                   connection->settings->closeFileCallback(connection->file);
621                \}
622 
623                \textcolor{comment}{//Mark the file as closed}
624                connection->file = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
625 
626                \textcolor{comment}{//The host sending the final ACK will wait for a while before terminating}
627                \textcolor{comment}{//in order to retransmit the final ACK if it has been lost}
628                connection->state = \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa073b5d08094584527ccf5504f50cb630}{TFTP\_STATE\_WRITE\_COMPLETE};
629 
630                \textcolor{comment}{//Save current time}
631                connection->timestamp = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
632             \}
633          \}
634          \textcolor{keywordflow}{else}
635          \{
636             \textcolor{comment}{//An error occurs during the transfer}
637             \hyperlink{tftp__server__misc_8c_a9df33e290cecbea5dbda3d25c5a0e27a}{tftpServerSendErrorPacket}(connection, 
      \hyperlink{tftp__common_8h_a33d9a682b7ba530c2097797fa678a05fa12653bd3ffdde974ed742b99ab46b82c}{TFTP\_ERROR\_NOT\_DEFINED},
638                \textcolor{stringliteral}{"Failed to write file"});
639 
640             \textcolor{comment}{//A TFTP server may terminate after sending an error message}
641             \hyperlink{tftp__server__misc_8c_a7ceeff8d585baec20a22863e22104721}{tftpServerCloseConnection}(connection);
642          \}
643       \}
644       \textcolor{keywordflow}{else}
645       \{
646          \textcolor{comment}{//Retransmit ACK packet}
647          \hyperlink{tftp__server__misc_8c_a5ad74ef8c60ee9c56a16193e13ca130d}{tftpServerRetransmitPacket}(connection);
648       \}
649    \}
650    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->state == \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa073b5d08094584527ccf5504f50cb630}{TFTP\_STATE\_WRITE\_COMPLETE})
651    \{
652       \textcolor{comment}{//The acknowledger will know that the ACK has been lost if it}
653       \textcolor{comment}{//receives the final DATA packet again}
654       \hyperlink{tftp__server__misc_8c_a5ad74ef8c60ee9c56a16193e13ca130d}{tftpServerRetransmitPacket}(connection);
655    \}
656 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_adeeccb39487c5d4550d46a36cc7c2581}\label{tftp__server__misc_8c_adeeccb39487c5d4550d46a36cc7c2581}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Process\+Error\+Packet@{tftp\+Server\+Process\+Error\+Packet}}
\index{tftp\+Server\+Process\+Error\+Packet@{tftp\+Server\+Process\+Error\+Packet}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Process\+Error\+Packet()}{tftpServerProcessErrorPacket()}}
{\footnotesize\ttfamily void tftp\+Server\+Process\+Error\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$}]{connection,  }\item[{const \hyperlink{tftp__common_8h_a8e737a9f3fbc1bf6983de7c443de0d83}{Tftp\+Error\+Packet} $\ast$}]{error\+Packet,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process incoming E\+R\+R\+OR packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em error\+Packet} & Pointer to the E\+R\+R\+OR packet \\
\hline
\mbox{\tt in}  & {\em length} & Length of the packet, in bytes \\
\hline
\end{DoxyParams}


Definition at line 720 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
722 \{
723    \textcolor{comment}{//Debug message}
724    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"TFTP Server: ERROR packet received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
725       \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
726 
727    \textcolor{comment}{//Make sure the length of the ERROR packet is acceptable}
728    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{tftp__common_8h_a8e737a9f3fbc1bf6983de7c443de0d83}{TftpErrorPacket}))
729       \textcolor{keywordflow}{return};
730 
731    \textcolor{comment}{//Debug message}
732    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Opcode = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(errorPacket->opcode));
733    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Error Code = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(errorPacket->errorCode));
734 
735    \textcolor{comment}{//Compute the length of the error message}
736    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \textcolor{keyword}{sizeof}(\hyperlink{tftp__common_8h_a8e737a9f3fbc1bf6983de7c443de0d83}{TftpErrorPacket});
737 
738    \textcolor{comment}{//Make sure the error message is terminated with a zero byte}
739    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} > 1 && errorPacket->errorMsg[\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - 1] == \textcolor{charliteral}{'\(\backslash\)0'})
740    \{
741       \textcolor{comment}{//Debug message}
742       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Error Msg = %s\(\backslash\)r\(\backslash\)n"}, errorPacket->errorMsg);
743    \}
744 
745    \textcolor{comment}{//Close connection}
746    \hyperlink{tftp__server__misc_8c_a7ceeff8d585baec20a22863e22104721}{tftpServerCloseConnection}(connection);
747 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_a26e3bf5cc0cc5e8a0c415cdfd400770d}\label{tftp__server__misc_8c_a26e3bf5cc0cc5e8a0c415cdfd400770d}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Process\+Packet@{tftp\+Server\+Process\+Packet}}
\index{tftp\+Server\+Process\+Packet@{tftp\+Server\+Process\+Packet}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Process\+Packet()}{tftpServerProcessPacket()}}
{\footnotesize\ttfamily void tftp\+Server\+Process\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a74392166fd32409398d53d11de1d62fa}{Tftp\+Server\+Context} $\ast$}]{context,  }\item[{\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Process incoming packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+F\+TP server context \\
\hline
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}


Definition at line 315 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
317 \{
318    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
319    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
320    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dns__common_8h_a5c1b56e6bccc2a95dbddf1a08e56e87d}{opcode};
321    \hyperlink{structIpAddr}{IpAddr} clientIpAddr;
322    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} clientPort;
323 
324    \textcolor{comment}{//Read incoming TFTP packet}
325    error = \hyperlink{socket_8c_a26af4b642b71708e1408fc94483f90bb}{socketReceiveFrom}(connection->socket, &clientIpAddr, &clientPort,
326       context->packet, \hyperlink{tftp__server_8h_a691c548eb2ec25b559ea9029f36a5276}{TFTP\_SERVER\_MAX\_PACKET\_SIZE}, &length, 0);
327 
328    \textcolor{comment}{//Failed to read packet?}
329    \textcolor{keywordflow}{if}(error)
330       \textcolor{keywordflow}{return};
331 
332    \textcolor{comment}{//Sanity check}
333    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t}))
334       \textcolor{keywordflow}{return};
335 
336    \textcolor{comment}{//Retrieve TFTP packet type}
337    opcode = \hyperlink{cpu__endian_8h_ae21854587c05993c850b537156470088}{LOAD16BE}(context->packet);
338 
339    \textcolor{comment}{//Data packet received?}
340    \textcolor{keywordflow}{if}(opcode == \hyperlink{tftp__common_8h_a833ab123c017ad4062778a372d0dc92eacc8676e38f10ee4663ec5068328784c1}{TFTP\_OPCODE\_DATA})
341    \{
342       \textcolor{comment}{//Process DATA packet}
343       \hyperlink{tftp__server__misc_8c_a877c3ef5a9cbc4f13cba5da04d682715}{tftpServerProcessDataPacket}(connection,
344          (\hyperlink{tftp__common_8h_a72db11cb5bc2afb6305fb3cb0f409eb5}{TftpDataPacket} *) context->packet, length);
345    \}
346    \textcolor{comment}{//Acknowledgment packet received?}
347    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(opcode == \hyperlink{tftp__common_8h_a833ab123c017ad4062778a372d0dc92eaa0ce42ae7c3db3296276f484a9ea084a}{TFTP\_OPCODE\_ACK})
348    \{
349       \textcolor{comment}{//Process ACK packet}
350       \hyperlink{tftp__server__misc_8c_a536e84ec6aa8d21283dbc1d20860e82f}{tftpServerProcessAckPacket}(connection,
351          (\hyperlink{tftp__common_8h_a8b1a2e8ac454913655b3c5dc0bf08c56}{TftpAckPacket} *) context->packet, length);
352    \}
353    \textcolor{comment}{//Error packet received?}
354    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(opcode == \hyperlink{tftp__common_8h_a833ab123c017ad4062778a372d0dc92ead285a1bbae4f74fafc9e2595dc291d45}{TFTP\_OPCODE\_ERROR})
355    \{
356       \textcolor{comment}{//Process ERROR packet}
357       \hyperlink{tftp__server__misc_8c_adeeccb39487c5d4550d46a36cc7c2581}{tftpServerProcessErrorPacket}(connection,
358          (\hyperlink{tftp__common_8h_a8e737a9f3fbc1bf6983de7c443de0d83}{TftpErrorPacket} *) context->packet, length);
359    \}
360    \textcolor{comment}{//Invalid packet received?}
361    \textcolor{keywordflow}{else}
362    \{
363       \textcolor{comment}{//Discard incoming packet}
364    \}
365 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_ab14d8e8d0a99daf673a0a434d3f3b8d9}\label{tftp__server__misc_8c_ab14d8e8d0a99daf673a0a434d3f3b8d9}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Process\+Rrq\+Packet@{tftp\+Server\+Process\+Rrq\+Packet}}
\index{tftp\+Server\+Process\+Rrq\+Packet@{tftp\+Server\+Process\+Rrq\+Packet}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Process\+Rrq\+Packet()}{tftpServerProcessRrqPacket()}}
{\footnotesize\ttfamily void tftp\+Server\+Process\+Rrq\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a74392166fd32409398d53d11de1d62fa}{Tftp\+Server\+Context} $\ast$}]{context,  }\item[{const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$}]{client\+Ip\+Addr,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{client\+Port,  }\item[{const \hyperlink{tftp__common_8h_a4b1e4ca412d8e3cd22c695e2d201a69a}{Tftp\+Rrq\+Packet} $\ast$}]{rrq\+Packet,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process incoming R\+RQ packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+F\+TP server context \\
\hline
\mbox{\tt in}  & {\em client\+Ip\+Addr} & IP address of the client \\
\hline
\mbox{\tt in}  & {\em client\+Port} & Port number used by the client \\
\hline
\mbox{\tt in}  & {\em rrq\+Packet} & Pointer to the R\+RQ packet \\
\hline
\mbox{\tt in}  & {\em length} & Length of the packet, in bytes \\
\hline
\end{DoxyParams}


Definition at line 377 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
379 \{
380    \textcolor{keyword}{const} \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ntp__common_8h_a37e90f5e3bd99fac2021fb3a326607d4}{mode};
381    \hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{TftpClientConnection} *connection;
382 
383    \textcolor{comment}{//Debug message}
384    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"TFTP Server: RRQ packet received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
385       \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
386 
387    \textcolor{comment}{//Make sure the length of the RRQ packet is acceptable}
388    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} <= \textcolor{keyword}{sizeof}(\hyperlink{tftp__common_8h_a4b1e4ca412d8e3cd22c695e2d201a69a}{TftpRrqPacket}))
389       \textcolor{keywordflow}{return};
390 
391    \textcolor{comment}{//Compute the number of bytes that follows the 2-byte opcode}
392    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \textcolor{keyword}{sizeof}(\hyperlink{tftp__common_8h_a4b1e4ca412d8e3cd22c695e2d201a69a}{TftpRrqPacket});
393 
394    \textcolor{comment}{//Point to the incoming RRQ packet}
395    rrqPacket = (\hyperlink{tftp__common_8h_a4b1e4ca412d8e3cd22c695e2d201a69a}{TftpRrqPacket} *) context->packet;
396 
397    \textcolor{comment}{//Malformed RRQ packet?}
398    \textcolor{keywordflow}{if}(rrqPacket->filename[\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - 1] != \textcolor{charliteral}{'\(\backslash\)0'})
399       \textcolor{keywordflow}{return};
400 
401    \textcolor{comment}{//Compute the length of the mode string}
402    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= strlen(rrqPacket->filename) + 1;
403 
404    \textcolor{comment}{//Malformed RRQ packet?}
405    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} == 0)
406       \textcolor{keywordflow}{return};
407 
408    \textcolor{comment}{//Point to the mode string}
409    mode = rrqPacket->filename + strlen(rrqPacket->filename) + 1;
410 
411    \textcolor{comment}{//Debug message}
412    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Opcode = %u\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(rrqPacket->opcode));
413    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Filename = %s\(\backslash\)r\(\backslash\)n"}, rrqPacket->filename);
414    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Mode = %s\(\backslash\)r\(\backslash\)n"}, mode);
415 
416    \textcolor{comment}{//Create a new connection}
417    connection = \hyperlink{tftp__server__misc_8c_af981044307a69122bdcb6966304235ce}{tftpServerOpenConnection}(context, clientIpAddr, clientPort);
418 
419    \textcolor{comment}{//Any error to report?}
420    \textcolor{keywordflow}{if}(connection == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
421       \textcolor{keywordflow}{return};
422 
423    \textcolor{comment}{//Open the specified file for reading}
424    \textcolor{keywordflow}{if}(context->settings.openFileCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
425    \{
426       \textcolor{comment}{//Invoke user callback function}
427       connection->file = context->settings.openFileCallback(rrqPacket->filename,
428          mode, \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE});
429    \}
430    \textcolor{keywordflow}{else}
431    \{
432       \textcolor{comment}{//No callback function defined}
433       connection->file = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
434    \}
435 
436    \textcolor{comment}{//Check if the file was successfully opened}
437    \textcolor{keywordflow}{if}(connection->file != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
438    \{
439       \textcolor{comment}{//The read operation is in progress...}
440       connection->state = \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa11314de8d9c41409d4afc8cfb3f674d0}{TFTP\_STATE\_READING};
441       \textcolor{comment}{//Initialize block number}
442       connection->block = 1;
443 
444       \textcolor{comment}{//Send the first DATA packet}
445       \hyperlink{tftp__server__misc_8c_abf2de292f5e01c75fb52fe3f83bb5930}{tftpServerSendDataPacket}(connection);
446    \}
447    \textcolor{keywordflow}{else}
448    \{
449       \textcolor{comment}{//If the reply is an error packet, then the request has been denied}
450       \hyperlink{tftp__server__misc_8c_a9df33e290cecbea5dbda3d25c5a0e27a}{tftpServerSendErrorPacket}(connection, 
      \hyperlink{tftp__common_8h_a33d9a682b7ba530c2097797fa678a05fa12653bd3ffdde974ed742b99ab46b82c}{TFTP\_ERROR\_NOT\_DEFINED},
451          \textcolor{stringliteral}{"Failed to open file"});
452 
453       \textcolor{comment}{//Close the connection}
454       \hyperlink{tftp__server__misc_8c_a7ceeff8d585baec20a22863e22104721}{tftpServerCloseConnection}(connection);
455    \}
456 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_a00e653a535af8257ba5ee7e44fb5671a}\label{tftp__server__misc_8c_a00e653a535af8257ba5ee7e44fb5671a}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Process\+Wrq\+Packet@{tftp\+Server\+Process\+Wrq\+Packet}}
\index{tftp\+Server\+Process\+Wrq\+Packet@{tftp\+Server\+Process\+Wrq\+Packet}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Process\+Wrq\+Packet()}{tftpServerProcessWrqPacket()}}
{\footnotesize\ttfamily void tftp\+Server\+Process\+Wrq\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a74392166fd32409398d53d11de1d62fa}{Tftp\+Server\+Context} $\ast$}]{context,  }\item[{const \hyperlink{structIpAddr}{Ip\+Addr} $\ast$}]{client\+Ip\+Addr,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{client\+Port,  }\item[{const \hyperlink{tftp__common_8h_aa49f0fa1700f5991479cb7e3b1afcf52}{Tftp\+Wrq\+Packet} $\ast$}]{wrq\+Packet,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Process incoming W\+RQ packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+F\+TP server context \\
\hline
\mbox{\tt in}  & {\em client\+Ip\+Addr} & IP address of the client \\
\hline
\mbox{\tt in}  & {\em client\+Port} & Port number used by the client \\
\hline
\mbox{\tt in}  & {\em wrq\+Packet} & Pointer to the W\+RQ packet \\
\hline
\mbox{\tt in}  & {\em length} & Length of the packet, in bytes \\
\hline
\end{DoxyParams}


Definition at line 468 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
470 \{
471    \textcolor{keyword}{const} \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *\hyperlink{ntp__common_8h_a37e90f5e3bd99fac2021fb3a326607d4}{mode};
472    \hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{TftpClientConnection} *connection;
473 
474    \textcolor{comment}{//Debug message}
475    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"TFTP Server: WRQ packet received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
476       \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
477 
478    \textcolor{comment}{//Make sure the length of the WRQ packet is acceptable}
479    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} <= \textcolor{keyword}{sizeof}(\hyperlink{tftp__common_8h_aa49f0fa1700f5991479cb7e3b1afcf52}{TftpWrqPacket}))
480       \textcolor{keywordflow}{return};
481 
482    \textcolor{comment}{//Compute the number of bytes that follows the 2-byte opcode}
483    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \textcolor{keyword}{sizeof}(\hyperlink{tftp__common_8h_aa49f0fa1700f5991479cb7e3b1afcf52}{TftpWrqPacket});
484 
485    \textcolor{comment}{//Point to the incoming WRQ packet}
486    wrqPacket = (\hyperlink{tftp__common_8h_aa49f0fa1700f5991479cb7e3b1afcf52}{TftpWrqPacket} *) context->packet;
487 
488    \textcolor{comment}{//Malformed WRQ packet?}
489    \textcolor{keywordflow}{if}(wrqPacket->filename[\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - 1] != \textcolor{charliteral}{'\(\backslash\)0'})
490       \textcolor{keywordflow}{return};
491 
492    \textcolor{comment}{//Compute the length of the mode string}
493    \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= strlen(wrqPacket->filename) + 1;
494 
495    \textcolor{comment}{//Malformed WRQ packet?}
496    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} == 0)
497       \textcolor{keywordflow}{return};
498 
499    \textcolor{comment}{//Point to the mode string}
500    mode = wrqPacket->filename + strlen(wrqPacket->filename) + 1;
501 
502    \textcolor{comment}{//Debug message}
503    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Opcode = %u\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(wrqPacket->opcode));
504    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Filename = %s\(\backslash\)r\(\backslash\)n"}, wrqPacket->filename);
505    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Mode = %s\(\backslash\)r\(\backslash\)n"}, mode);
506 
507    \textcolor{comment}{//Create a new connection}
508    connection = \hyperlink{tftp__server__misc_8c_af981044307a69122bdcb6966304235ce}{tftpServerOpenConnection}(context, clientIpAddr, clientPort);
509 
510    \textcolor{comment}{//Any error to report?}
511    \textcolor{keywordflow}{if}(connection == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
512       \textcolor{keywordflow}{return};
513 
514    \textcolor{comment}{//Open the specified file for writing}
515    \textcolor{keywordflow}{if}(context->settings.openFileCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
516    \{
517       \textcolor{comment}{//Invoke user callback function}
518       connection->file = context->settings.openFileCallback(wrqPacket->filename,
519          mode, \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
520    \}
521    \textcolor{keywordflow}{else}
522    \{
523       \textcolor{comment}{//No callback function defined}
524       connection->file = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
525    \}
526 
527    \textcolor{comment}{//Check if the file was successfully opened}
528    \textcolor{keywordflow}{if}(connection->file != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
529    \{
530       \textcolor{comment}{//The write operation is in progress...}
531       connection->state = \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa326240f96906edcdd12338d4fe20b61f}{TFTP\_STATE\_WRITING};
532       \textcolor{comment}{//Initialize block number}
533       connection->block = 0;
534 
535       \textcolor{comment}{//The positive response to a write request is an acknowledgment}
536       \textcolor{comment}{//packet with block number zero}
537       \hyperlink{tftp__server__misc_8c_a166930efd8de2b206596bc73c31b793a}{tftpServerSendAckPacket}(connection);
538 
539       \textcolor{comment}{//Increment block number}
540       connection->block++;
541    \}
542    \textcolor{keywordflow}{else}
543    \{
544       \textcolor{comment}{//If the reply is an error packet, then the request has been denied}
545       \hyperlink{tftp__server__misc_8c_a9df33e290cecbea5dbda3d25c5a0e27a}{tftpServerSendErrorPacket}(connection, 
      \hyperlink{tftp__common_8h_a33d9a682b7ba530c2097797fa678a05fa12653bd3ffdde974ed742b99ab46b82c}{TFTP\_ERROR\_NOT\_DEFINED},
546          \textcolor{stringliteral}{"Failed to open file"});
547 
548       \textcolor{comment}{//Close the connection}
549       \hyperlink{tftp__server__misc_8c_a7ceeff8d585baec20a22863e22104721}{tftpServerCloseConnection}(connection);
550    \}
551 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_a5ad74ef8c60ee9c56a16193e13ca130d}\label{tftp__server__misc_8c_a5ad74ef8c60ee9c56a16193e13ca130d}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Retransmit\+Packet@{tftp\+Server\+Retransmit\+Packet}}
\index{tftp\+Server\+Retransmit\+Packet@{tftp\+Server\+Retransmit\+Packet}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Retransmit\+Packet()}{tftpServerRetransmitPacket()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tftp\+Server\+Retransmit\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Retransmit the last packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 944 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
945 \{
946    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
947 
948    \textcolor{comment}{//Debug message}
949    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"TFTP Server: Retransmitting packet (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
950       connection->packetLen);
951 
952    \textcolor{comment}{//Retransmit the last packet}
953    error = \hyperlink{socket_8c_aa4eeb3a3294d14d681675ba9f0d3e568}{socketSend}(connection->socket, connection->packet,
954       connection->packetLen, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 0);
955 
956    \textcolor{comment}{//Return status code}
957    \textcolor{keywordflow}{return} error;
958 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_a166930efd8de2b206596bc73c31b793a}\label{tftp__server__misc_8c_a166930efd8de2b206596bc73c31b793a}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Send\+Ack\+Packet@{tftp\+Server\+Send\+Ack\+Packet}}
\index{tftp\+Server\+Send\+Ack\+Packet@{tftp\+Server\+Send\+Ack\+Packet}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Send\+Ack\+Packet()}{tftpServerSendAckPacket()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tftp\+Server\+Send\+Ack\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Send A\+CK packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 853 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
854 \{
855    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
856    \hyperlink{tftp__common_8h_a8b1a2e8ac454913655b3c5dc0bf08c56}{TftpAckPacket} *ackPacket;
857 
858    \textcolor{comment}{//Point to the buffer where to format the packet}
859    ackPacket = (\hyperlink{tftp__common_8h_a8b1a2e8ac454913655b3c5dc0bf08c56}{TftpAckPacket} *) connection->packet;
860 
861    \textcolor{comment}{//Format ACK packet}
862    ackPacket->opcode = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{tftp__common_8h_a833ab123c017ad4062778a372d0dc92eaa0ce42ae7c3db3296276f484a9ea084a}{TFTP\_OPCODE\_ACK});
863    ackPacket->block = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(connection->block);
864 
865    \textcolor{comment}{//Length of the ACK packet}
866    connection->packetLen = \textcolor{keyword}{sizeof}(\hyperlink{tftp__common_8h_a8b1a2e8ac454913655b3c5dc0bf08c56}{TftpAckPacket});
867 
868    \textcolor{comment}{//Debug message}
869    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"TFTP Server: Sending ACK packet (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      connection->packetLen);
870    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Opcode = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(ackPacket->opcode));
871    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Block = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(ackPacket->block));
872 
873    \textcolor{comment}{//Send ACK packet}
874    error = \hyperlink{socket_8c_aa4eeb3a3294d14d681675ba9f0d3e568}{socketSend}(connection->socket, connection->packet,
875       connection->packetLen, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 0);
876 
877    \textcolor{comment}{//Save the time at which the packet was sent}
878    connection->timestamp = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
879    \textcolor{comment}{//Reset retransmission counter}
880    connection->retransmitCount = 0;
881 
882    \textcolor{comment}{//Return status code}
883    \textcolor{keywordflow}{return} error;
884 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_abf2de292f5e01c75fb52fe3f83bb5930}\label{tftp__server__misc_8c_abf2de292f5e01c75fb52fe3f83bb5930}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Send\+Data\+Packet@{tftp\+Server\+Send\+Data\+Packet}}
\index{tftp\+Server\+Send\+Data\+Packet@{tftp\+Server\+Send\+Data\+Packet}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Send\+Data\+Packet()}{tftpServerSendDataPacket()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tftp\+Server\+Send\+Data\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Send D\+A\+TA packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 756 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
757 \{
758    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
759    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
760    \hyperlink{tftp__common_8h_a72db11cb5bc2afb6305fb3cb0f409eb5}{TftpDataPacket} *dataPacket;
761 
762    \textcolor{comment}{//Point to the buffer where to format the packet}
763    dataPacket = (\hyperlink{tftp__common_8h_a72db11cb5bc2afb6305fb3cb0f409eb5}{TftpDataPacket} *) connection->packet;
764 
765    \textcolor{comment}{//Format DATA packet}
766    dataPacket->opcode = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{tftp__common_8h_a833ab123c017ad4062778a372d0dc92eacc8676e38f10ee4663ec5068328784c1}{TFTP\_OPCODE\_DATA});
767    dataPacket->block = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(connection->block);
768 
769    \textcolor{comment}{//Read more data from the input file}
770    \textcolor{keywordflow}{if}(connection->settings->readFileCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
771    \{
772       \textcolor{comment}{//Calculate the offset relative to the beginning of the file}
773       offset = (connection->block - 1) * \hyperlink{tftp__server_8h_a3576af3363d6b7da73ca241bb583f139}{TFTP\_SERVER\_BLOCK\_SIZE};
774 
775       \textcolor{comment}{//Invoke user callback function}
776       error = connection->settings->readFileCallback(connection->file, offset,
777          dataPacket->data, \hyperlink{tftp__server_8h_a3576af3363d6b7da73ca241bb583f139}{TFTP\_SERVER\_BLOCK\_SIZE}, &connection->packetLen);
778    \}
779    \textcolor{keywordflow}{else}
780    \{
781       \textcolor{comment}{//No callback function defined}
782       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cacf545b4d693b270f9d01d54d86efedc2}{ERROR\_READ\_FAILED};
783    \}
784 
785    \textcolor{comment}{//End of file?}
786    \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca488b657f8cc2e6c29df47f282e8ff3ad}{ERROR\_END\_OF\_FILE} || error == 
      \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca8b7223773301a4f3dd811f1d35e13ce4}{ERROR\_END\_OF\_STREAM})
787    \{
788       \textcolor{comment}{//Catch exception}
789       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
790       \textcolor{comment}{//This is the the last block of data}
791       connection->packetLen = 0;
792    \}
793 
794    \textcolor{comment}{//Check status code}
795    \textcolor{keywordflow}{if}(!error)
796    \{
797       \textcolor{comment}{//A data packet of less than 512 bytes signals termination of the transfer}
798       \textcolor{keywordflow}{if}(connection->packetLen < \hyperlink{tftp__server_8h_a3576af3363d6b7da73ca241bb583f139}{TFTP\_SERVER\_BLOCK\_SIZE})
799       \{
800          \textcolor{comment}{//Properly close the file}
801          \textcolor{keywordflow}{if}(connection->settings->closeFileCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
802          \{
803             \textcolor{comment}{//Invoke user callback function}
804             connection->settings->closeFileCallback(connection->file);
805          \}
806 
807          \textcolor{comment}{//Mark the file as closed}
808          connection->file = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
809 
810          \textcolor{comment}{//The host sending the last DATA must retransmit it until the packet}
811          \textcolor{comment}{//is acknowledged or the sending host times out}
812          connection->state = \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa439bae37fc5816f3796a6b920b6e5809}{TFTP\_STATE\_READ\_COMPLETE};
813       \}
814 
815       \textcolor{comment}{//Length of the DATA packet}
816       connection->packetLen += \textcolor{keyword}{sizeof}(\hyperlink{tftp__common_8h_a8b1a2e8ac454913655b3c5dc0bf08c56}{TftpAckPacket});
817 
818       \textcolor{comment}{//Debug message}
819       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"TFTP Server: Sending DATA packet (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      connection->packetLen);
820       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Opcode = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(dataPacket->opcode));
821       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Block = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(dataPacket->block));
822 
823       \textcolor{comment}{//Send DATA packet}
824       error = \hyperlink{socket_8c_aa4eeb3a3294d14d681675ba9f0d3e568}{socketSend}(connection->socket, connection->packet,
825          connection->packetLen, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 0);
826 
827       \textcolor{comment}{//Save the time at which the packet was sent}
828       connection->timestamp = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
829       \textcolor{comment}{//Reset retransmission counter}
830       connection->retransmitCount = 0;
831    \}
832    \textcolor{keywordflow}{else}
833    \{
834       \textcolor{comment}{//An error occurs during the transfer}
835       \hyperlink{tftp__server__misc_8c_a9df33e290cecbea5dbda3d25c5a0e27a}{tftpServerSendErrorPacket}(connection, 
      \hyperlink{tftp__common_8h_a33d9a682b7ba530c2097797fa678a05fa12653bd3ffdde974ed742b99ab46b82c}{TFTP\_ERROR\_NOT\_DEFINED},
836          \textcolor{stringliteral}{"Failed to read file"});
837 
838       \textcolor{comment}{//A TFTP server may terminate after sending an error message}
839       \hyperlink{tftp__server__misc_8c_a7ceeff8d585baec20a22863e22104721}{tftpServerCloseConnection}(connection);
840    \}
841 
842    \textcolor{comment}{//Return status code}
843    \textcolor{keywordflow}{return} error;
844 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_a9df33e290cecbea5dbda3d25c5a0e27a}\label{tftp__server__misc_8c_a9df33e290cecbea5dbda3d25c5a0e27a}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Send\+Error\+Packet@{tftp\+Server\+Send\+Error\+Packet}}
\index{tftp\+Server\+Send\+Error\+Packet@{tftp\+Server\+Send\+Error\+Packet}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Send\+Error\+Packet()}{tftpServerSendErrorPacket()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tftp\+Server\+Send\+Error\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{Tftp\+Client\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{error\+Code,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{error\+Msg }\end{DoxyParamCaption})}



Send E\+R\+R\+OR packet. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em error\+Code} & Integer indicating the nature of the error \\
\hline
\mbox{\tt in}  & {\em error\+Msg} & Error message intended for human consumption \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 895 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
897 \{
898    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
899    \hyperlink{tftp__common_8h_a8e737a9f3fbc1bf6983de7c443de0d83}{TftpErrorPacket} *errorPacket;
900 
901    \textcolor{comment}{//Check the length of the error message}
902    \textcolor{keywordflow}{if}(strlen(\hyperlink{tftp__common_8h_a949a7e29724e2db6f2bd70df72c74960}{errorMsg}) >= \hyperlink{tftp__server_8h_a3576af3363d6b7da73ca241bb583f139}{TFTP\_SERVER\_BLOCK\_SIZE})
903       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
904 
905    \textcolor{comment}{//Point to the buffer where to format the packet}
906    errorPacket = (\hyperlink{tftp__common_8h_a8e737a9f3fbc1bf6983de7c443de0d83}{TftpErrorPacket} *) connection->packet;
907 
908    \textcolor{comment}{//Format ERROR packet}
909    errorPacket->opcode = \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{tftp__common_8h_a833ab123c017ad4062778a372d0dc92ead285a1bbae4f74fafc9e2595dc291d45}{TFTP\_OPCODE\_ERROR});
910    errorPacket->errorCode = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{tftp__common_8h_a78abca92c8fa2790c1d32470831537e8}{errorCode});
911 
912    \textcolor{comment}{//Copy error message}
913    strcpy(errorPacket->errorMsg, \hyperlink{tftp__common_8h_a949a7e29724e2db6f2bd70df72c74960}{errorMsg});
914 
915    \textcolor{comment}{//Length of the ERROR packet}
916    connection->packetLen = \textcolor{keyword}{sizeof}(\hyperlink{tftp__common_8h_a8e737a9f3fbc1bf6983de7c443de0d83}{TftpErrorPacket}) + strlen(
      \hyperlink{tftp__common_8h_a949a7e29724e2db6f2bd70df72c74960}{errorMsg}) + 1;
917 
918    \textcolor{comment}{//Debug message}
919    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"TFTP Server: Sending ERROR packet (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      connection->packetLen);
920    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Opcode = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(errorPacket->opcode));
921    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Error Code = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(errorPacket->errorCode));
922    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Error Msg = %s\(\backslash\)r\(\backslash\)n"}, errorPacket->errorMsg);
923 
924    \textcolor{comment}{//Send ERROR packet}
925    error = \hyperlink{socket_8c_aa4eeb3a3294d14d681675ba9f0d3e568}{socketSend}(connection->socket, connection->packet,
926       connection->packetLen, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 0);
927 
928    \textcolor{comment}{//Save the time at which the packet was sent}
929    connection->timestamp = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
930    \textcolor{comment}{//Reset retransmission counter}
931    connection->retransmitCount = 0;
932 
933    \textcolor{comment}{//Return status code}
934    \textcolor{keywordflow}{return} error;
935 \}
\end{DoxyCode}
\mbox{\Hypertarget{tftp__server__misc_8c_aa9bf9834436dbd5df47d52ff62da36a6}\label{tftp__server__misc_8c_aa9bf9834436dbd5df47d52ff62da36a6}} 
\index{tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}!tftp\+Server\+Tick@{tftp\+Server\+Tick}}
\index{tftp\+Server\+Tick@{tftp\+Server\+Tick}!tftp\+\_\+server\+\_\+misc.\+c@{tftp\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tftp\+Server\+Tick()}{tftpServerTick()}}
{\footnotesize\ttfamily void tftp\+Server\+Tick (\begin{DoxyParamCaption}\item[{\hyperlink{tftp__server_8h_a74392166fd32409398d53d11de1d62fa}{Tftp\+Server\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Handle periodic operations. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+F\+TP server context \\
\hline
\end{DoxyParams}


Definition at line 48 of file tftp\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
49 \{
50    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
51    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
52    \hyperlink{tftp__server_8h_a0f645438c1de49e8bfc6960ef861e5c9}{TftpClientConnection} *connection;
53 
54    \textcolor{comment}{//Get current time}
55    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
56 
57    \textcolor{comment}{//Handle periodic operations}
58    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{tftp__server_8h_a0acdd308af5bdb354e7a80dc8ff4388d}{TFTP\_SERVER\_MAX\_CONNECTIONS}; i++)
59    \{
60       \textcolor{comment}{//Point to the structure describing the current connection}
61       connection = &context->connection[i];
62 
63       \textcolor{comment}{//Check current state}
64       \textcolor{keywordflow}{if}(connection->state == \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa11314de8d9c41409d4afc8cfb3f674d0}{TFTP\_STATE\_READING} ||
65          connection->state == \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa326240f96906edcdd12338d4fe20b61f}{TFTP\_STATE\_WRITING} ||
66          connection->state == \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa439bae37fc5816f3796a6b920b6e5809}{TFTP\_STATE\_READ\_COMPLETE})
67       \{
68          \textcolor{comment}{//Check current time}
69          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, connection->timestamp + 
      \hyperlink{tftp__server_8h_a703a579afa5b42a884cc87fc3aaa5397}{TFTP\_SERVER\_TIMEOUT}) >= 0)
70          \{
71             \textcolor{comment}{//Handle retransmissions}
72             \textcolor{keywordflow}{if}(connection->retransmitCount < \hyperlink{tftp__server_8h_a3edd444bc62a1ed94510e7a35dbb21ea}{TFTP\_SERVER\_MAX\_RETRIES})
73             \{
74                \textcolor{comment}{//Retransmit last packet}
75                \hyperlink{tftp__server__misc_8c_a5ad74ef8c60ee9c56a16193e13ca130d}{tftpServerRetransmitPacket}(connection);
76 
77                \textcolor{comment}{//Save the time at which the packet was sent}
78                connection->timestamp = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
79                \textcolor{comment}{//Increment retransmission counter}
80                connection->retransmitCount++;
81             \}
82             \textcolor{keywordflow}{else}
83             \{
84                \textcolor{comment}{//Close connection}
85                \hyperlink{tftp__server__misc_8c_a7ceeff8d585baec20a22863e22104721}{tftpServerCloseConnection}(connection);
86             \}
87          \}
88       \}
89       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->state == \hyperlink{tftp__server_8h_ab2a2374014f9d5d77c65b15bb32f3a4aa073b5d08094584527ccf5504f50cb630}{TFTP\_STATE\_WRITE\_COMPLETE})
90       \{
91          \textcolor{comment}{//The host sending the final ACK will wait for a while before terminating}
92          \textcolor{comment}{//in order to retransmit the final ACK if it has been lost}
93          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, connection->timestamp + 
      \hyperlink{tftp__server_8h_a7982052d56d31c8660e4c58929857f8e}{TFTP\_SERVER\_FINAL\_DELAY}) >= 0)
94          \{
95             \textcolor{comment}{//Close connection}
96             \hyperlink{tftp__server__misc_8c_a7ceeff8d585baec20a22863e22104721}{tftpServerCloseConnection}(connection);
97          \}
98       \}
99    \}
100 \}
\end{DoxyCode}
