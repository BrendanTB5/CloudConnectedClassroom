\hypertarget{chacha_8c}{}\section{cyclone\+\_\+crypto/cipher/chacha.c File Reference}
\label{chacha_8c}\index{cyclone\+\_\+crypto/cipher/chacha.\+c@{cyclone\+\_\+crypto/cipher/chacha.\+c}}


Cha\+Cha encryption algorithm.  


{\ttfamily \#include \char`\"{}core/crypto.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}cipher/chacha.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{chacha_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{crypto__config_8h_a6afae3a9b63f9b55d979e667ee0e881d}{C\+R\+Y\+P\+T\+O\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\item 
\#define \hyperlink{chacha_8c_aaf0be5780fb18d5327a72c286673eedb}{C\+H\+A\+C\+H\+A\+\_\+\+Q\+U\+A\+R\+T\+E\+R\+\_\+\+R\+O\+U\+ND}(\hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a},  \hyperlink{nbns__common_8h_a4313c9563516f94387762ab05763456b}{b},  \hyperlink{llmnr__common_8h_a2e5a04327b5658199f0f7bda2acceee1}{c},  d)
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{chacha_8c_ac2ce3da3f79c749e9d26dc9c802874ae}{chacha\+Init} (\hyperlink{structChachaContext}{Chacha\+Context} $\ast$context, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} nr, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$key, size\+\_\+t key\+Len, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$nonce, size\+\_\+t nonce\+Len)
\begin{DoxyCompactList}\small\item\em Initialize Cha\+Cha context using the supplied key and nonce. \end{DoxyCompactList}\item 
void \hyperlink{chacha_8c_a3f6166161f02b55e8eeb2546bf819853}{chacha\+Cipher} (\hyperlink{structChachaContext}{Chacha\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$input, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$output, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Encrypt/decrypt data with the Cha\+Cha algorithm. \end{DoxyCompactList}\item 
void \hyperlink{chacha_8c_a3e9f1bf6ed355ac5fd85e99dd403194a}{chacha\+Process\+Block} (\hyperlink{structChachaContext}{Chacha\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Generate a keystream block. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Cha\+Cha encryption algorithm. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+Crypto Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{chacha_8c_aaf0be5780fb18d5327a72c286673eedb}\label{chacha_8c_aaf0be5780fb18d5327a72c286673eedb}} 
\index{chacha.\+c@{chacha.\+c}!C\+H\+A\+C\+H\+A\+\_\+\+Q\+U\+A\+R\+T\+E\+R\+\_\+\+R\+O\+U\+ND@{C\+H\+A\+C\+H\+A\+\_\+\+Q\+U\+A\+R\+T\+E\+R\+\_\+\+R\+O\+U\+ND}}
\index{C\+H\+A\+C\+H\+A\+\_\+\+Q\+U\+A\+R\+T\+E\+R\+\_\+\+R\+O\+U\+ND@{C\+H\+A\+C\+H\+A\+\_\+\+Q\+U\+A\+R\+T\+E\+R\+\_\+\+R\+O\+U\+ND}!chacha.\+c@{chacha.\+c}}
\subsubsection{\texorpdfstring{C\+H\+A\+C\+H\+A\+\_\+\+Q\+U\+A\+R\+T\+E\+R\+\_\+\+R\+O\+U\+ND}{CHACHA\_QUARTER\_ROUND}}
{\footnotesize\ttfamily \#define C\+H\+A\+C\+H\+A\+\_\+\+Q\+U\+A\+R\+T\+E\+R\+\_\+\+R\+O\+U\+ND(\begin{DoxyParamCaption}\item[{}]{\hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a},  }\item[{}]{\hyperlink{nbns__common_8h_a4313c9563516f94387762ab05763456b}{b},  }\item[{}]{\hyperlink{llmnr__common_8h_a2e5a04327b5658199f0f7bda2acceee1}{c},  }\item[{}]{d }\end{DoxyParamCaption})}

{\bfseries Value\+:}
\begin{DoxyCode}
\{ \(\backslash\)
   a += \hyperlink{dtls__misc_8h_ab590318ac859d0e57e15c3dd6c62a605}{b}; \(\backslash\)
   d ^= \hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a}; \(\backslash\)
   d = \hyperlink{cyclone__crypto_2core_2crypto_8h_ad5e52b5ea688101f11d0bf34dc3a8b4b}{ROL32}(d, 16); \(\backslash\)
   c += d; \(\backslash\)
   b ^= \hyperlink{aria_8c_a5dadc28804036d1b82e1dc027e95c9a6}{c}; \(\backslash\)
   b = \hyperlink{cyclone__crypto_2core_2crypto_8h_ad5e52b5ea688101f11d0bf34dc3a8b4b}{ROL32}(\hyperlink{dtls__misc_8h_ab590318ac859d0e57e15c3dd6c62a605}{b}, 12); \(\backslash\)
   a += \hyperlink{dtls__misc_8h_ab590318ac859d0e57e15c3dd6c62a605}{b}; \(\backslash\)
   d ^= \hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a}; \(\backslash\)
   d = \hyperlink{cyclone__crypto_2core_2crypto_8h_ad5e52b5ea688101f11d0bf34dc3a8b4b}{ROL32}(d, 8); \(\backslash\)
   c += d; \(\backslash\)
   b ^= \hyperlink{aria_8c_a5dadc28804036d1b82e1dc027e95c9a6}{c}; \(\backslash\)
   b = \hyperlink{cyclone__crypto_2core_2crypto_8h_ad5e52b5ea688101f11d0bf34dc3a8b4b}{ROL32}(\hyperlink{dtls__misc_8h_ab590318ac859d0e57e15c3dd6c62a605}{b}, 7); \(\backslash\)
\}
\end{DoxyCode}


Definition at line 42 of file chacha.\+c.

\mbox{\Hypertarget{chacha_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{chacha_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{chacha.\+c@{chacha.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!chacha.\+c@{chacha.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{crypto__config_8h_a6afae3a9b63f9b55d979e667ee0e881d}{C\+R\+Y\+P\+T\+O\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file chacha.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{chacha_8c_a3f6166161f02b55e8eeb2546bf819853}\label{chacha_8c_a3f6166161f02b55e8eeb2546bf819853}} 
\index{chacha.\+c@{chacha.\+c}!chacha\+Cipher@{chacha\+Cipher}}
\index{chacha\+Cipher@{chacha\+Cipher}!chacha.\+c@{chacha.\+c}}
\subsubsection{\texorpdfstring{chacha\+Cipher()}{chachaCipher()}}
{\footnotesize\ttfamily void chacha\+Cipher (\begin{DoxyParamCaption}\item[{\hyperlink{structChachaContext}{Chacha\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{input,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{output,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Encrypt/decrypt data with the Cha\+Cha algorithm. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Cha\+Cha context \\
\hline
\mbox{\tt in}  & {\em input} & Pointer to the data to encrypt/decrypt (optional) \\
\hline
\mbox{\tt in}  & {\em output} & Pointer to the resulting data (optional) \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes to be processed \\
\hline
\end{DoxyParams}


Definition at line 183 of file chacha.\+c.


\begin{DoxyCode}
185 \{
186    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
187    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
188    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{md5_8c_af11ea3cdbca7345eb6a4a8ac5ce0434d}{k};
189 
190    \textcolor{comment}{//Encryption loop}
191    \textcolor{keywordflow}{while}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} > 0)
192    \{
193       \textcolor{comment}{//Check whether a new keystream block must be generated}
194       \textcolor{keywordflow}{if}(context->\hyperlink{structChachaContext_aa5c55f8bef7d138c7403440d421ef98a}{pos} == 0 || context->\hyperlink{structChachaContext_aa5c55f8bef7d138c7403440d421ef98a}{pos} >= 64)
195       \{
196          \textcolor{comment}{//ChaCha successively calls the ChaCha block function, with the same key}
197          \textcolor{comment}{//and nonce, and with successively increasing block counter parameters}
198          \hyperlink{chacha_8c_a3e9f1bf6ed355ac5fd85e99dd403194a}{chachaProcessBlock}(context);
199 
200          \textcolor{comment}{//Increment block counter}
201          context->\hyperlink{structChachaContext_a0930b5fb8738edf5d43a5c21a8d4bc33}{state}[12]++;
202 
203          \textcolor{comment}{//Propagate the carry if necessary}
204          \textcolor{keywordflow}{if}(context->\hyperlink{structChachaContext_a0930b5fb8738edf5d43a5c21a8d4bc33}{state}[12] == 0)
205          \{
206             context->\hyperlink{structChachaContext_a0930b5fb8738edf5d43a5c21a8d4bc33}{state}[13]++;
207          \}
208 
209          \textcolor{comment}{//Rewind to the beginning of the keystream block}
210          context->\hyperlink{structChachaContext_aa5c55f8bef7d138c7403440d421ef98a}{pos} = 0;
211       \}
212 
213       \textcolor{comment}{//Compute the number of bytes to encrypt/decrypt at a time}
214       n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, 64 - context->\hyperlink{structChachaContext_aa5c55f8bef7d138c7403440d421ef98a}{pos});
215 
216       \textcolor{comment}{//Valid output pointer?}
217       \textcolor{keywordflow}{if}(output != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
218       \{
219          \textcolor{comment}{//Point to the keystream}
220          k = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) context->\hyperlink{structChachaContext_a67570a5ca55f05634715e5da02be2f0e}{block} + context->\hyperlink{structChachaContext_aa5c55f8bef7d138c7403440d421ef98a}{pos};
221 
222          \textcolor{comment}{//Valid input pointer?}
223          \textcolor{keywordflow}{if}(input != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
224          \{
225             \textcolor{comment}{//XOR the input data with the keystream}
226             \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}; i++)
227             \{
228                output[i] = input[i] ^ k[i];
229             \}
230 
231             \textcolor{comment}{//Advance input pointer}
232             input += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
233          \}
234          \textcolor{keywordflow}{else}
235          \{
236             \textcolor{comment}{//Output the keystream}
237             \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}; i++)
238             \{
239                output[i] = k[i];
240             \}
241          \}
242 
243          \textcolor{comment}{//Advance output pointer}
244          output += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
245       \}
246 
247       \textcolor{comment}{//Current position in the keystream block}
248       context->\hyperlink{structChachaContext_aa5c55f8bef7d138c7403440d421ef98a}{pos} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
249       \textcolor{comment}{//Remaining bytes to process}
250       \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
251    \}
252 \}
\end{DoxyCode}
\mbox{\Hypertarget{chacha_8c_ac2ce3da3f79c749e9d26dc9c802874ae}\label{chacha_8c_ac2ce3da3f79c749e9d26dc9c802874ae}} 
\index{chacha.\+c@{chacha.\+c}!chacha\+Init@{chacha\+Init}}
\index{chacha\+Init@{chacha\+Init}!chacha.\+c@{chacha.\+c}}
\subsubsection{\texorpdfstring{chacha\+Init()}{chachaInit()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} chacha\+Init (\begin{DoxyParamCaption}\item[{\hyperlink{structChachaContext}{Chacha\+Context} $\ast$}]{context,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{nr,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{key,  }\item[{size\+\_\+t}]{key\+Len,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{nonce,  }\item[{size\+\_\+t}]{nonce\+Len }\end{DoxyParamCaption})}



Initialize Cha\+Cha context using the supplied key and nonce. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Cha\+Cha context to initialize \\
\hline
\mbox{\tt in}  & {\em nr} & Number of rounds to be applied (8, 12 or 20) \\
\hline
\mbox{\tt in}  & {\em key} & Pointer to the key \\
\hline
\mbox{\tt in}  & {\em key\+Len} & Length of the key, in bytes (16 or 32) \\
\hline
\mbox{\tt in}  & {\em nonce} & Pointer to the nonce \\
\hline
\mbox{\tt in}  & {\em nonce\+Len} & Length of the nonce, in bytes (8 or 12) \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 70 of file chacha.\+c.


\begin{DoxyCode}
72 \{
73    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} *\hyperlink{ethernet_8h_aaa9bda35d7b2e3d98ecec180d3f628c0}{w};
74 
75    \textcolor{comment}{//Check parameters}
76    \textcolor{keywordflow}{if}(context == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || key == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || nonce == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
77       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
78 
79    \textcolor{comment}{//The number of rounds must be 8, 12 or 20}
80    \textcolor{keywordflow}{if}(nr != 8 && nr != 12 && nr != 20)
81       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
82 
83    \textcolor{comment}{//Save the number of rounds to be applied}
84    context->\hyperlink{structChachaContext_a090120c0379bab4a191d22b52d1cc679}{nr} = nr;
85 
86    \textcolor{comment}{//Point to the state}
87    w = context->\hyperlink{structChachaContext_a0930b5fb8738edf5d43a5c21a8d4bc33}{state};
88 
89    \textcolor{comment}{//Check the length of the key}
90    \textcolor{keywordflow}{if}(keyLen == 16)
91    \{
92       \textcolor{comment}{//The first four input words are constants}
93       w[0] = 0x61707865;
94       w[1] = 0x3120646E;
95       w[2] = 0x79622D36;
96       w[3] = 0x6B206574;
97 
98       \textcolor{comment}{//Input words 4 through 7 are taken from the 128-bit key, by reading}
99       \textcolor{comment}{//the bytes in little-endian order, in 4-byte chunks}
100       w[4] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key);
101       w[5] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 4);
102       w[6] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 8);
103       w[7] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 12);
104 
105       \textcolor{comment}{//Input words 8 through 11 are taken from the 128-bit key, again by}
106       \textcolor{comment}{//reading the bytes in little-endian order, in 4-byte chunks}
107       w[8] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key);
108       w[9] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 4);
109       w[10] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 8);
110       w[11] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 12);
111    \}
112    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(keyLen == 32)
113    \{
114       \textcolor{comment}{//The first four input words are constants}
115       w[0] = 0x61707865;
116       w[1] = 0x3320646E;
117       w[2] = 0x79622D32;
118       w[3] = 0x6B206574;
119 
120       \textcolor{comment}{//Input words 4 through 11 are taken from the 256-bit key, by reading}
121       \textcolor{comment}{//the bytes in little-endian order, in 4-byte chunks}
122       w[4] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key);
123       w[5] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 4);
124       w[6] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 8);
125       w[7] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 12);
126       w[8] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 16);
127       w[9] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 20);
128       w[10] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 24);
129       w[11] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(key + 28);
130    \}
131    \textcolor{keywordflow}{else}
132    \{
133       \textcolor{comment}{//Invalid key length}
134       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
135    \}
136 
137    \textcolor{comment}{//Check the length of the nonce}
138    \textcolor{keywordflow}{if}(nonceLen == 8)
139    \{
140       \textcolor{comment}{//Input words 12 and 13 are a block counter, with word 12}
141       \textcolor{comment}{//overflowing into word 13}
142       w[12] = 0;
143       w[13] = 0;
144 
145       \textcolor{comment}{//Input words 14 and 15 are taken from an 64-bit nonce, by reading}
146       \textcolor{comment}{//the bytes in little-endian order, in 4-byte chunks}
147       w[14] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(nonce);
148       w[15] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(nonce + 4);
149    \}
150    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(nonceLen == 12)
151    \{
152       \textcolor{comment}{//Input word 12 is a block counter}
153       w[12] = 0;
154 
155       \textcolor{comment}{//Input words 13 to 15 are taken from an 96-bit nonce, by reading}
156       \textcolor{comment}{//the bytes in little-endian order, in 4-byte chunks}
157       w[13] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(nonce);
158       w[14] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(nonce + 4);
159       w[15] = \hyperlink{cpu__endian_8h_a7a6ecaee0bc600cae5a7dead20594920}{LOAD32LE}(nonce + 8);
160    \}
161    \textcolor{keywordflow}{else}
162    \{
163       \textcolor{comment}{//Invalid nonce length}
164       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
165    \}
166 
167    \textcolor{comment}{//The keystream block is empty}
168    context->\hyperlink{structChachaContext_aa5c55f8bef7d138c7403440d421ef98a}{pos} = 0;
169 
170    \textcolor{comment}{//No error to report}
171    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
172 \}
\end{DoxyCode}
\mbox{\Hypertarget{chacha_8c_a3e9f1bf6ed355ac5fd85e99dd403194a}\label{chacha_8c_a3e9f1bf6ed355ac5fd85e99dd403194a}} 
\index{chacha.\+c@{chacha.\+c}!chacha\+Process\+Block@{chacha\+Process\+Block}}
\index{chacha\+Process\+Block@{chacha\+Process\+Block}!chacha.\+c@{chacha.\+c}}
\subsubsection{\texorpdfstring{chacha\+Process\+Block()}{chachaProcessBlock()}}
{\footnotesize\ttfamily void chacha\+Process\+Block (\begin{DoxyParamCaption}\item[{\hyperlink{structChachaContext}{Chacha\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Generate a keystream block. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the Cha\+Cha context \\
\hline
\end{DoxyParams}


Definition at line 260 of file chacha.\+c.


\begin{DoxyCode}
261 \{
262    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
263    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} *\hyperlink{ethernet_8h_aaa9bda35d7b2e3d98ecec180d3f628c0}{w};
264 
265    \textcolor{comment}{//Point to the working state}
266    w = (\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} *) context->\hyperlink{structChachaContext_a67570a5ca55f05634715e5da02be2f0e}{block};
267 
268    \textcolor{comment}{//Copy the state to the working state}
269    \textcolor{keywordflow}{for}(i = 0; i < 16; i++)
270    \{
271       w[i] = context->\hyperlink{structChachaContext_a0930b5fb8738edf5d43a5c21a8d4bc33}{state}[i];
272    \}
273 
274    \textcolor{comment}{//ChaCha runs 8, 12 or 20 rounds, alternating between column rounds and}
275    \textcolor{comment}{//diagonal rounds}
276    \textcolor{keywordflow}{for}(i = 0; i < context->\hyperlink{structChachaContext_a090120c0379bab4a191d22b52d1cc679}{nr}; i += 2)
277    \{
278       \textcolor{comment}{//The column rounds apply the quarter-round function to the four}
279       \textcolor{comment}{//columns, from left to right}
280       \hyperlink{chacha_8c_aaf0be5780fb18d5327a72c286673eedb}{CHACHA\_QUARTER\_ROUND}(w[0], w[4], w[8], w[12]);
281       \hyperlink{chacha_8c_aaf0be5780fb18d5327a72c286673eedb}{CHACHA\_QUARTER\_ROUND}(w[1], w[5], w[9], w[13]);
282       \hyperlink{chacha_8c_aaf0be5780fb18d5327a72c286673eedb}{CHACHA\_QUARTER\_ROUND}(w[2], w[6], w[10], w[14]);
283       \hyperlink{chacha_8c_aaf0be5780fb18d5327a72c286673eedb}{CHACHA\_QUARTER\_ROUND}(w[3], w[7], w[11], w[15]);
284 
285       \textcolor{comment}{//The diagonal rounds apply the quarter-round function to the top-left,}
286       \textcolor{comment}{//bottom-right diagonal, followed by the pattern shifted one place to}
287       \textcolor{comment}{//the right, for three more quarter-rounds}
288       \hyperlink{chacha_8c_aaf0be5780fb18d5327a72c286673eedb}{CHACHA\_QUARTER\_ROUND}(w[0], w[5], w[10], w[15]);
289       \hyperlink{chacha_8c_aaf0be5780fb18d5327a72c286673eedb}{CHACHA\_QUARTER\_ROUND}(w[1], w[6], w[11], w[12]);
290       \hyperlink{chacha_8c_aaf0be5780fb18d5327a72c286673eedb}{CHACHA\_QUARTER\_ROUND}(w[2], w[7], w[8], w[13]);
291       \hyperlink{chacha_8c_aaf0be5780fb18d5327a72c286673eedb}{CHACHA\_QUARTER\_ROUND}(w[3], w[4], w[9], w[14]);
292    \}
293 
294    \textcolor{comment}{//Add the original input words to the output words}
295    \textcolor{keywordflow}{for}(i = 0; i < 16; i++)
296    \{
297       w[i] += context->\hyperlink{structChachaContext_a0930b5fb8738edf5d43a5c21a8d4bc33}{state}[i];
298    \}
299 
300    \textcolor{comment}{//Serialize the result by sequencing the words one-by-one in little-endian}
301    \textcolor{comment}{//order}
302    \textcolor{keywordflow}{for}(i = 0; i < 16; i++)
303    \{
304       w[i] = \hyperlink{cpu__endian_8h_a336f132f175f47bfab3fa57f6a00276d}{htole32}(w[i]);
305    \}
306 \}
\end{DoxyCode}
