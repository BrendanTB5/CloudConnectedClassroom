\hypertarget{icmpv6_8c}{}\section{cyclone\+\_\+tcp/ipv6/icmpv6.c File Reference}
\label{icmpv6_8c}\index{cyclone\+\_\+tcp/ipv6/icmpv6.\+c@{cyclone\+\_\+tcp/ipv6/icmpv6.\+c}}


I\+C\+M\+Pv6 (Internet Control Message Protocol Version 6)  


{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}core/ip.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/ipv6.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/ipv6\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/ipv6\+\_\+pmtu.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/icmpv6.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/mld.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/ndp.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/ndp\+\_\+router\+\_\+adv.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mibs/ip\+\_\+mib\+\_\+module.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{icmpv6_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_a702e7ade7f02f5649b37e78c32fb72e6}{I\+C\+M\+P\+V6\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{icmpv6_8c_acca14a2ed8ba33e1aab15468baface92}{icmpv6\+Enable\+Multicast\+Echo\+Request} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} enable)
\begin{DoxyCompactList}\small\item\em Enable support for multicast Echo Request messages. \end{DoxyCompactList}\item 
void \hyperlink{icmpv6_8c_a471720d54024c2cca86df785a33ddf30}{icmpv6\+Process\+Message} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$pseudo\+Header, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} hop\+Limit)
\begin{DoxyCompactList}\small\item\em Incoming I\+C\+M\+Pv6 message processing. \end{DoxyCompactList}\item 
void \hyperlink{icmpv6_8c_ac82d710c8deb810b59d184ae3485cb5d}{icmpv6\+Process\+Dest\+Unreachable} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$pseudo\+Header, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset})
\begin{DoxyCompactList}\small\item\em Destination Unreachable message processing. \end{DoxyCompactList}\item 
void \hyperlink{icmpv6_8c_a536a5d75a50eeaa0ae70e5e0f7b8076c}{icmpv6\+Process\+Packet\+Too\+Big} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$pseudo\+Header, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset})
\begin{DoxyCompactList}\small\item\em Packet Too Big message processing. \end{DoxyCompactList}\item 
void \hyperlink{icmpv6_8c_a06dc5af4dcbb44486341a4f0a1cdcce8}{icmpv6\+Process\+Echo\+Request} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$request\+Pseudo\+Header, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$request, size\+\_\+t request\+Offset)
\begin{DoxyCompactList}\small\item\em Echo Request message processing. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{icmpv6_8c_a8243f4f8b640432620ed384e865a32cd}{icmpv6\+Send\+Error\+Message} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{ppp_8h_a1d127017fb298b889f4ba24752d08b8e}{type}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{ppp_8h_a966576744a473fafb7687f8e5649941f}{code}, \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{icmpv6_8h_aa9b2b1016c7bcb4d12166681dcc74ced}{parameter}, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$\hyperlink{ndp_8h_a6c97f605f59d957e1720030e1b1058e5}{ip\+Packet}, size\+\_\+t ip\+Packet\+Offset)
\begin{DoxyCompactList}\small\item\em Send an I\+C\+M\+Pv6 Error message. \end{DoxyCompactList}\item 
void \hyperlink{icmpv6_8c_a10c3f327b450c588b5a803749ebaf720}{icmpv6\+Dump\+Message} (const \hyperlink{icmpv6_8h_a0af0a1de09fe69d36242f3e3ae9941ef}{Icmpv6\+Header} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Dump I\+C\+M\+Pv6 message for debugging purpose. \end{DoxyCompactList}\item 
void \hyperlink{icmpv6_8c_ab3abf11ff4398fa5456439e68acbb367}{icmpv6\+Dump\+Dest\+Unreachable\+Message} (const \hyperlink{icmpv6_8h_a33af6ac73c0c147643838ce2873f9788}{Icmpv6\+Dest\+Unreachable\+Message} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Dump I\+C\+M\+Pv6 Destination Unreachable message. \end{DoxyCompactList}\item 
void \hyperlink{icmpv6_8c_af49449b142e603de0a2dfa0a38ab3b66}{icmpv6\+Dump\+Packet\+Too\+Big\+Message} (const \hyperlink{icmpv6_8h_a32412b792fe5d155b9e11399a06bd627}{Icmpv6\+Packet\+Too\+Big\+Message} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Dump I\+C\+M\+Pv6 Packet Too Big message. \end{DoxyCompactList}\item 
void \hyperlink{icmpv6_8c_ac7538672edb598eb0afcaa079b138935}{icmpv6\+Dump\+Echo\+Message} (const \hyperlink{icmpv6_8h_a79bbfb454299cd2e84947749f02d4e4b}{Icmpv6\+Echo\+Message} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Dump I\+C\+M\+Pv6 Echo Request or Echo Reply message. \end{DoxyCompactList}\item 
void \hyperlink{icmpv6_8c_a6755ce5b8d09fca85aab53911d6d7a42}{icmpv6\+Dump\+Error\+Message} (const \hyperlink{icmpv6_8h_a54b4a4016c2d57ad58e3b1562d2c3e85}{Icmpv6\+Error\+Message} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Dump generic I\+C\+M\+Pv6 Error message. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
I\+C\+M\+Pv6 (Internet Control Message Protocol Version 6) 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.\hypertarget{tftp__server_8c_Description}{}\subsection{Description}\label{tftp__server_8c_Description}
I\+C\+M\+Pv6 is used by I\+Pv6 nodes to report errors encountered in processing packets, and to perform other Internet-\/layer functions. I\+C\+M\+Pv6 is an integral part of I\+Pv6 and must be fully implemented by every I\+Pv6 node. Refer to the R\+FC 2463 for more details

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{icmpv6_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{icmpv6_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{icmpv6.\+c@{icmpv6.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!icmpv6.\+c@{icmpv6.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_a702e7ade7f02f5649b37e78c32fb72e6}{I\+C\+M\+P\+V6\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 39 of file icmpv6.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{icmpv6_8c_ab3abf11ff4398fa5456439e68acbb367}\label{icmpv6_8c_ab3abf11ff4398fa5456439e68acbb367}} 
\index{icmpv6.\+c@{icmpv6.\+c}!icmpv6\+Dump\+Dest\+Unreachable\+Message@{icmpv6\+Dump\+Dest\+Unreachable\+Message}}
\index{icmpv6\+Dump\+Dest\+Unreachable\+Message@{icmpv6\+Dump\+Dest\+Unreachable\+Message}!icmpv6.\+c@{icmpv6.\+c}}
\subsubsection{\texorpdfstring{icmpv6\+Dump\+Dest\+Unreachable\+Message()}{icmpv6DumpDestUnreachableMessage()}}
{\footnotesize\ttfamily void icmpv6\+Dump\+Dest\+Unreachable\+Message (\begin{DoxyParamCaption}\item[{const \hyperlink{icmpv6_8h_a33af6ac73c0c147643838ce2873f9788}{Icmpv6\+Dest\+Unreachable\+Message} $\ast$}]{message }\end{DoxyParamCaption})}



Dump I\+C\+M\+Pv6 Destination Unreachable message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Pointer to the I\+C\+M\+Pv6 message \\
\hline
\end{DoxyParams}


Definition at line 633 of file icmpv6.\+c.


\begin{DoxyCode}
634 \{
635    \textcolor{comment}{//Dump ICMPv6 message}
636    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Type = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->type);
637    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Code = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->code);
638    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Checksum = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->checksum));
639 \}
\end{DoxyCode}
\mbox{\Hypertarget{icmpv6_8c_ac7538672edb598eb0afcaa079b138935}\label{icmpv6_8c_ac7538672edb598eb0afcaa079b138935}} 
\index{icmpv6.\+c@{icmpv6.\+c}!icmpv6\+Dump\+Echo\+Message@{icmpv6\+Dump\+Echo\+Message}}
\index{icmpv6\+Dump\+Echo\+Message@{icmpv6\+Dump\+Echo\+Message}!icmpv6.\+c@{icmpv6.\+c}}
\subsubsection{\texorpdfstring{icmpv6\+Dump\+Echo\+Message()}{icmpv6DumpEchoMessage()}}
{\footnotesize\ttfamily void icmpv6\+Dump\+Echo\+Message (\begin{DoxyParamCaption}\item[{const \hyperlink{icmpv6_8h_a79bbfb454299cd2e84947749f02d4e4b}{Icmpv6\+Echo\+Message} $\ast$}]{message }\end{DoxyParamCaption})}



Dump I\+C\+M\+Pv6 Echo Request or Echo Reply message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Pointer to the I\+C\+M\+Pv6 message \\
\hline
\end{DoxyParams}


Definition at line 662 of file icmpv6.\+c.


\begin{DoxyCode}
663 \{
664    \textcolor{comment}{//Dump ICMPv6 message}
665    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Type = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->type);
666    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Code = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->code);
667    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Checksum = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->checksum));
668    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Identifier = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->identifier));
669    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Sequence Number = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->sequenceNumber));
670 \}
\end{DoxyCode}
\mbox{\Hypertarget{icmpv6_8c_a6755ce5b8d09fca85aab53911d6d7a42}\label{icmpv6_8c_a6755ce5b8d09fca85aab53911d6d7a42}} 
\index{icmpv6.\+c@{icmpv6.\+c}!icmpv6\+Dump\+Error\+Message@{icmpv6\+Dump\+Error\+Message}}
\index{icmpv6\+Dump\+Error\+Message@{icmpv6\+Dump\+Error\+Message}!icmpv6.\+c@{icmpv6.\+c}}
\subsubsection{\texorpdfstring{icmpv6\+Dump\+Error\+Message()}{icmpv6DumpErrorMessage()}}
{\footnotesize\ttfamily void icmpv6\+Dump\+Error\+Message (\begin{DoxyParamCaption}\item[{const \hyperlink{icmpv6_8h_a54b4a4016c2d57ad58e3b1562d2c3e85}{Icmpv6\+Error\+Message} $\ast$}]{message }\end{DoxyParamCaption})}



Dump generic I\+C\+M\+Pv6 Error message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Pointer to the I\+C\+M\+Pv6 message \\
\hline
\end{DoxyParams}


Definition at line 678 of file icmpv6.\+c.


\begin{DoxyCode}
679 \{
680    \textcolor{comment}{//Dump ICMP message}
681    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Type = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->type);
682    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Code = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->code);
683    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Checksum = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->checksum));
684    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Parameter = %"} PRIu32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->parameter));
685 \}
\end{DoxyCode}
\mbox{\Hypertarget{icmpv6_8c_a10c3f327b450c588b5a803749ebaf720}\label{icmpv6_8c_a10c3f327b450c588b5a803749ebaf720}} 
\index{icmpv6.\+c@{icmpv6.\+c}!icmpv6\+Dump\+Message@{icmpv6\+Dump\+Message}}
\index{icmpv6\+Dump\+Message@{icmpv6\+Dump\+Message}!icmpv6.\+c@{icmpv6.\+c}}
\subsubsection{\texorpdfstring{icmpv6\+Dump\+Message()}{icmpv6DumpMessage()}}
{\footnotesize\ttfamily void icmpv6\+Dump\+Message (\begin{DoxyParamCaption}\item[{const \hyperlink{icmpv6_8h_a0af0a1de09fe69d36242f3e3ae9941ef}{Icmpv6\+Header} $\ast$}]{message }\end{DoxyParamCaption})}



Dump I\+C\+M\+Pv6 message for debugging purpose. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Pointer to the I\+C\+MP message \\
\hline
\end{DoxyParams}


Definition at line 619 of file icmpv6.\+c.


\begin{DoxyCode}
620 \{
621    \textcolor{comment}{//Dump ICMPv6 message}
622    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Type = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->type);
623    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Code = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->code);
624    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Checksum = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->checksum));
625 \}
\end{DoxyCode}
\mbox{\Hypertarget{icmpv6_8c_af49449b142e603de0a2dfa0a38ab3b66}\label{icmpv6_8c_af49449b142e603de0a2dfa0a38ab3b66}} 
\index{icmpv6.\+c@{icmpv6.\+c}!icmpv6\+Dump\+Packet\+Too\+Big\+Message@{icmpv6\+Dump\+Packet\+Too\+Big\+Message}}
\index{icmpv6\+Dump\+Packet\+Too\+Big\+Message@{icmpv6\+Dump\+Packet\+Too\+Big\+Message}!icmpv6.\+c@{icmpv6.\+c}}
\subsubsection{\texorpdfstring{icmpv6\+Dump\+Packet\+Too\+Big\+Message()}{icmpv6DumpPacketTooBigMessage()}}
{\footnotesize\ttfamily void icmpv6\+Dump\+Packet\+Too\+Big\+Message (\begin{DoxyParamCaption}\item[{const \hyperlink{icmpv6_8h_a32412b792fe5d155b9e11399a06bd627}{Icmpv6\+Packet\+Too\+Big\+Message} $\ast$}]{message }\end{DoxyParamCaption})}



Dump I\+C\+M\+Pv6 Packet Too Big message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Pointer to the I\+C\+M\+Pv6 message \\
\hline
\end{DoxyParams}


Definition at line 647 of file icmpv6.\+c.


\begin{DoxyCode}
648 \{
649    \textcolor{comment}{//Dump ICMPv6 message}
650    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Type = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->type);
651    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Code = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->code);
652    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Checksum = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->checksum));
653    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  MTU = %"} PRIu32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->mtu));
654 \}
\end{DoxyCode}
\mbox{\Hypertarget{icmpv6_8c_acca14a2ed8ba33e1aab15468baface92}\label{icmpv6_8c_acca14a2ed8ba33e1aab15468baface92}} 
\index{icmpv6.\+c@{icmpv6.\+c}!icmpv6\+Enable\+Multicast\+Echo\+Request@{icmpv6\+Enable\+Multicast\+Echo\+Request}}
\index{icmpv6\+Enable\+Multicast\+Echo\+Request@{icmpv6\+Enable\+Multicast\+Echo\+Request}!icmpv6.\+c@{icmpv6.\+c}}
\subsubsection{\texorpdfstring{icmpv6\+Enable\+Multicast\+Echo\+Request()}{icmpv6EnableMulticastEchoRequest()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} icmpv6\+Enable\+Multicast\+Echo\+Request (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t}}]{enable }\end{DoxyParamCaption})}



Enable support for multicast Echo Request messages. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em enable} & When the flag is set to T\+R\+UE, the host will respond to multicast Echo Requests. When the flag is set to F\+A\+L\+SE, incoming Echo Request messages destined to a multicast address will be dropped \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 68 of file icmpv6.\+c.


\begin{DoxyCode}
69 \{
70    \textcolor{comment}{//Check parameters}
71    \textcolor{keywordflow}{if}(interface == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
72       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
73 
74    \textcolor{comment}{//Get exclusive access}
75    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
76    \textcolor{comment}{//Enable or disable support for multicast Echo Request messages}
77    interface->ipv6Context.enableMulticastEchoReq = enable;
78    \textcolor{comment}{//Release exclusive access}
79    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&\hyperlink{net_8c_afe31551ad26115fae8e575654346d441}{netMutex});
80 
81    \textcolor{comment}{//Successful processing}
82    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
83 \}
\end{DoxyCode}
\mbox{\Hypertarget{icmpv6_8c_ac82d710c8deb810b59d184ae3485cb5d}\label{icmpv6_8c_ac82d710c8deb810b59d184ae3485cb5d}} 
\index{icmpv6.\+c@{icmpv6.\+c}!icmpv6\+Process\+Dest\+Unreachable@{icmpv6\+Process\+Dest\+Unreachable}}
\index{icmpv6\+Process\+Dest\+Unreachable@{icmpv6\+Process\+Dest\+Unreachable}!icmpv6.\+c@{icmpv6.\+c}}
\subsubsection{\texorpdfstring{icmpv6\+Process\+Dest\+Unreachable()}{icmpv6ProcessDestUnreachable()}}
{\footnotesize\ttfamily void icmpv6\+Process\+Dest\+Unreachable (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset }\end{DoxyParamCaption})}



Destination Unreachable message processing. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & I\+Pv6 pseudo header \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the incoming I\+C\+M\+Pv6 message \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first byte of the I\+C\+M\+Pv6 message \\
\hline
\end{DoxyParams}


Definition at line 239 of file icmpv6.\+c.


\begin{DoxyCode}
241 \{
242    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
243    \hyperlink{icmpv6_8h_a33af6ac73c0c147643838ce2873f9788}{Icmpv6DestUnreachableMessage} *icmpHeader;
244 
245    \textcolor{comment}{//Retrieve the length of the Destination Unreachable message}
246    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
247 
248    \textcolor{comment}{//Ensure the packet length is correct}
249    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{icmpv6_8h_a33af6ac73c0c147643838ce2873f9788}{Icmpv6DestUnreachableMessage}))
250       \textcolor{keywordflow}{return};
251 
252    \textcolor{comment}{//Point to the ICMPv6 header}
253    icmpHeader = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
254 
255    \textcolor{comment}{//Sanity check}
256    \textcolor{keywordflow}{if}(icmpHeader == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
257       \textcolor{keywordflow}{return};
258 
259    \textcolor{comment}{//Debug message}
260    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"ICMPv6 Destination Unreachable message received (%"} 
      \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
261    \textcolor{comment}{//Dump message contents for debugging purpose}
262    \hyperlink{icmpv6_8c_ab3abf11ff4398fa5456439e68acbb367}{icmpv6DumpDestUnreachableMessage}(icmpHeader);
263 \}
\end{DoxyCode}
\mbox{\Hypertarget{icmpv6_8c_a06dc5af4dcbb44486341a4f0a1cdcce8}\label{icmpv6_8c_a06dc5af4dcbb44486341a4f0a1cdcce8}} 
\index{icmpv6.\+c@{icmpv6.\+c}!icmpv6\+Process\+Echo\+Request@{icmpv6\+Process\+Echo\+Request}}
\index{icmpv6\+Process\+Echo\+Request@{icmpv6\+Process\+Echo\+Request}!icmpv6.\+c@{icmpv6.\+c}}
\subsubsection{\texorpdfstring{icmpv6\+Process\+Echo\+Request()}{icmpv6ProcessEchoRequest()}}
{\footnotesize\ttfamily void icmpv6\+Process\+Echo\+Request (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$}]{request\+Pseudo\+Header,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{request,  }\item[{size\+\_\+t}]{request\+Offset }\end{DoxyParamCaption})}



Echo Request message processing. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em request\+Pseudo\+Header} & I\+Pv6 pseudo header \\
\hline
\mbox{\tt in}  & {\em request} & Multi-\/part buffer containing the incoming I\+C\+M\+Pv6 message \\
\hline
\mbox{\tt in}  & {\em request\+Offset} & Offset to the first byte of the I\+C\+M\+Pv6 message \\
\hline
\end{DoxyParams}


Definition at line 338 of file icmpv6.\+c.


\begin{DoxyCode}
340 \{
341    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
342    \textcolor{keywordtype}{size\_t} requestLength;
343    \textcolor{keywordtype}{size\_t} replyOffset;
344    \textcolor{keywordtype}{size\_t} replyLength;
345    \hyperlink{structNetBuffer}{NetBuffer} *reply;
346    \hyperlink{icmpv6_8h_a79bbfb454299cd2e84947749f02d4e4b}{Icmpv6EchoMessage} *requestHeader;
347    \hyperlink{icmpv6_8h_a79bbfb454299cd2e84947749f02d4e4b}{Icmpv6EchoMessage} *replyHeader;
348    \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader} replyPseudoHeader;
349 
350    \textcolor{comment}{//Retrieve the length of the Echo Request message}
351    requestLength = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(request) - requestOffset;
352 
353    \textcolor{comment}{//Ensure the packet length is correct}
354    \textcolor{keywordflow}{if}(requestLength < \textcolor{keyword}{sizeof}(\hyperlink{icmpv6_8h_a79bbfb454299cd2e84947749f02d4e4b}{Icmpv6EchoMessage}))
355       \textcolor{keywordflow}{return};
356 
357    \textcolor{comment}{//Point to the Echo Request header}
358    requestHeader = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(request, requestOffset);
359 
360    \textcolor{comment}{//Sanity check}
361    \textcolor{keywordflow}{if}(requestHeader == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
362       \textcolor{keywordflow}{return};
363 
364    \textcolor{comment}{//Debug message}
365    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"ICMPv6 Echo Request message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      requestLength);
366    \textcolor{comment}{//Dump message contents for debugging purpose}
367    \hyperlink{icmpv6_8c_ac7538672edb598eb0afcaa079b138935}{icmpv6DumpEchoMessage}(requestHeader);
368 
369    \textcolor{comment}{//Check whether the destination address of the Echo Request message is}
370    \textcolor{comment}{//a multicast address}
371    \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_a68fbc1145d242384c90a670196a38495}{ipv6IsMulticastAddr}(&requestPseudoHeader->destAddr))
372    \{
373       \textcolor{comment}{//If support for multicast Echo Request messages has been explicitly}
374       \textcolor{comment}{//disabled, then the host shall not respond to the incoming request}
375       \textcolor{keywordflow}{if}(!interface->ipv6Context.enableMulticastEchoReq)
376          \textcolor{keywordflow}{return};
377 
378       \textcolor{comment}{//The source address of the reply must be a unicast address belonging to}
379       \textcolor{comment}{//the interface on which the multicast Echo Request message was received}
380       error = \hyperlink{ipv6__misc_8c_a1d69e11a455ee8895ec67061f554a174}{ipv6SelectSourceAddr}(&interface, &requestPseudoHeader->srcAddr,
381          &replyPseudoHeader.srcAddr);
382       \textcolor{comment}{//Any error to report?}
383       \textcolor{keywordflow}{if}(error)
384          \textcolor{keywordflow}{return};
385    \}
386    \textcolor{keywordflow}{else}
387    \{
388       \textcolor{comment}{//The destination address of the Echo Request message is a unicast address}
389       replyPseudoHeader.srcAddr = requestPseudoHeader->destAddr;
390    \}
391 
392    \textcolor{comment}{//Allocate memory to hold the Echo Reply message}
393    reply = \hyperlink{ip_8c_a2222fb64b1b18140283119eea309c1b3}{ipAllocBuffer}(\textcolor{keyword}{sizeof}(\hyperlink{icmpv6_8h_a79bbfb454299cd2e84947749f02d4e4b}{Icmpv6EchoMessage}), &replyOffset);
394    \textcolor{comment}{//Failed to allocate memory?}
395    \textcolor{keywordflow}{if}(reply == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
396       \textcolor{keywordflow}{return};
397 
398    \textcolor{comment}{//Point to the Echo Reply header}
399    replyHeader = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(reply, replyOffset);
400 
401    \textcolor{comment}{//Format Echo Reply header}
402    replyHeader->type = \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609afbf550cb8772e3f9066f803abbeef4c9}{ICMPV6\_TYPE\_ECHO\_REPLY};
403    replyHeader->code = 0;
404    replyHeader->checksum = 0;
405    replyHeader->identifier = requestHeader->identifier;
406    replyHeader->sequenceNumber = requestHeader->sequenceNumber;
407 
408    \textcolor{comment}{//Point to the first data byte}
409    requestOffset += \textcolor{keyword}{sizeof}(\hyperlink{icmpv6_8h_a79bbfb454299cd2e84947749f02d4e4b}{Icmpv6EchoMessage});
410    requestLength -= \textcolor{keyword}{sizeof}(\hyperlink{icmpv6_8h_a79bbfb454299cd2e84947749f02d4e4b}{Icmpv6EchoMessage});
411 
412    \textcolor{comment}{//The data received in the ICMPv6 Echo Request message must be returned}
413    \textcolor{comment}{//entirely and unmodified in the ICMPv6 Echo Reply message}
414    error = \hyperlink{net__mem_8c_aba4fe2d850142e40a9a668afeb2a0c8a}{netBufferConcat}(reply, request, requestOffset, requestLength);
415 
416    \textcolor{comment}{//Check status code}
417    \textcolor{keywordflow}{if}(!error)
418    \{
419       \textcolor{comment}{//Get the length of the resulting message}
420       replyLength = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(reply) - replyOffset;
421 
422       \textcolor{comment}{//Format IPv6 pseudo header}
423       replyPseudoHeader.destAddr = requestPseudoHeader->srcAddr;
424       replyPseudoHeader.length = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(replyLength);
425       replyPseudoHeader.reserved = 0;
426       replyPseudoHeader.nextHeader = \hyperlink{ipv6_8h_a551bec2628dfcc3b67c0fff52e486fa5a1abdcf5760ff2904781383db26717c83}{IPV6\_ICMPV6\_HEADER};
427 
428       \textcolor{comment}{//Message checksum calculation}
429       replyHeader->checksum = \hyperlink{ip_8c_a9ec0593d9dbb2adf3e67894c0349cef3}{ipCalcUpperLayerChecksumEx}(&replyPseudoHeader,
430          \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader}), reply, replyOffset, replyLength);
431 
432       \textcolor{comment}{//Total number of ICMP messages which this entity attempted to send}
433       \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6Stats.icmpStatsOutMsgs, 1);
434       \textcolor{comment}{//Increment per-message type ICMP counter}
435       \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6MsgStatsTable.icmpMsgStatsOutPkts[
      \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609afbf550cb8772e3f9066f803abbeef4c9}{ICMPV6\_TYPE\_ECHO\_REPLY}], 1);
436 
437       \textcolor{comment}{//Debug message}
438       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending ICMPv6 Echo Reply message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      replyLength);
439       \textcolor{comment}{//Dump message contents for debugging purpose}
440       \hyperlink{icmpv6_8c_ac7538672edb598eb0afcaa079b138935}{icmpv6DumpEchoMessage}(replyHeader);
441 
442       \textcolor{comment}{//Send Echo Reply message}
443       \hyperlink{ipv6_8c_ae9edf1ac407897f91eb5caed37df7c3c}{ipv6SendDatagram}(interface, &replyPseudoHeader, reply, replyOffset, 0);
444    \}
445 
446    \textcolor{comment}{//Free previously allocated memory block}
447    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(reply);
448 \}
\end{DoxyCode}
\mbox{\Hypertarget{icmpv6_8c_a471720d54024c2cca86df785a33ddf30}\label{icmpv6_8c_a471720d54024c2cca86df785a33ddf30}} 
\index{icmpv6.\+c@{icmpv6.\+c}!icmpv6\+Process\+Message@{icmpv6\+Process\+Message}}
\index{icmpv6\+Process\+Message@{icmpv6\+Process\+Message}!icmpv6.\+c@{icmpv6.\+c}}
\subsubsection{\texorpdfstring{icmpv6\+Process\+Message()}{icmpv6ProcessMessage()}}
{\footnotesize\ttfamily void icmpv6\+Process\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{hop\+Limit }\end{DoxyParamCaption})}



Incoming I\+C\+M\+Pv6 message processing. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & I\+Pv6 pseudo header \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the incoming I\+C\+M\+Pv6 message \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first byte of the I\+C\+M\+Pv6 message \\
\hline
\mbox{\tt in}  & {\em hop\+Limit} & Hop Limit field from I\+Pv6 header \\
\hline
\end{DoxyParams}


Definition at line 95 of file icmpv6.\+c.


\begin{DoxyCode}
97 \{
98    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
99    \hyperlink{icmpv6_8h_a0af0a1de09fe69d36242f3e3ae9941ef}{Icmpv6Header} *header;
100 
101    \textcolor{comment}{//Total number of ICMP messages which the entity received}
102    \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6Stats.icmpStatsInMsgs, 1);
103 
104    \textcolor{comment}{//Retrieve the length of the ICMPv6 message}
105    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
106 
107    \textcolor{comment}{//Ensure the message length is correct}
108    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{icmpv6_8h_a0af0a1de09fe69d36242f3e3ae9941ef}{Icmpv6Header}))
109    \{
110       \textcolor{comment}{//Number of ICMP messages which the entity received but determined}
111       \textcolor{comment}{//as having ICMP-specific errors}
112       \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6Stats.icmpStatsInErrors, 1);
113 
114       \textcolor{comment}{//Silently discard incoming message}
115       \textcolor{keywordflow}{return};
116    \}
117 
118    \textcolor{comment}{//Point to the ICMPv6 message header}
119    header = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
120 
121    \textcolor{comment}{//Sanity check}
122    \textcolor{keywordflow}{if}(header == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
123       \textcolor{keywordflow}{return};
124 
125    \textcolor{comment}{//Debug message}
126    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"ICMPv6 message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
127    \textcolor{comment}{//Dump message contents for debugging purpose}
128    \hyperlink{icmpv6_8c_a10c3f327b450c588b5a803749ebaf720}{icmpv6DumpMessage}(header);
129 
130    \textcolor{comment}{//Verify checksum value}
131    \textcolor{keywordflow}{if}(\hyperlink{ip_8c_a9ec0593d9dbb2adf3e67894c0349cef3}{ipCalcUpperLayerChecksumEx}(pseudoHeader,
132       \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader}), buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset}, length) != 0x0000)
133    \{
134       \textcolor{comment}{//Debug message}
135       \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"Wrong ICMPv6 header checksum!\(\backslash\)r\(\backslash\)n"});
136 
137       \textcolor{comment}{//Number of ICMP messages which the entity received but determined}
138       \textcolor{comment}{//as having ICMP-specific errors}
139       \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6Stats.icmpStatsInErrors, 1);
140 
141       \textcolor{comment}{//Exit immediately}
142       \textcolor{keywordflow}{return};
143    \}
144 
145    \textcolor{comment}{//Check whether the destination address is the tentative address}
146    \textcolor{keywordflow}{if}(\hyperlink{ipv6__misc_8c_af26691bb490df211ba351340016cd53c}{ipv6IsTentativeAddr}(interface, &pseudoHeader->destAddr))
147    \{
148       \textcolor{comment}{//The interface must accept Neighbor Solicitation and}
149       \textcolor{comment}{//Neighbor Advertisement messages}
150       \textcolor{keywordflow}{if}(header->type != \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a15fcec525be2799e51a85119d592fa0e}{ICMPV6\_TYPE\_NEIGHBOR\_SOL} &&
151          header->type != \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a8cf8b81569e86589eb5b71c7fd2f8ac5}{ICMPV6\_TYPE\_NEIGHBOR\_ADV})
152       \{
153          \textcolor{comment}{//Other packets addressed to the tentative address}
154          \textcolor{comment}{//should be silently discarded}
155          \textcolor{keywordflow}{return};
156       \}
157    \}
158 
159    \textcolor{comment}{//Increment per-message type ICMP counter}
160    \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6MsgStatsTable.icmpMsgStatsInPkts[header->type], 1);
161 
162    \textcolor{comment}{//Check the type of message}
163    \textcolor{keywordflow}{switch}(header->type)
164    \{
165    \textcolor{comment}{//Destination Unreachable message?}
166    \textcolor{keywordflow}{case} \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a1a1c28c95ecd1db9a0f41e4ab6a2bae4}{ICMPV6\_TYPE\_DEST\_UNREACHABLE}:
167       \textcolor{comment}{//Process Destination Unreachable message}
168       \hyperlink{icmpv6_8c_ac82d710c8deb810b59d184ae3485cb5d}{icmpv6ProcessDestUnreachable}(interface, pseudoHeader, buffer, 
      \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
169       \textcolor{keywordflow}{break};
170    \textcolor{comment}{//Packet Too Big message?}
171    \textcolor{keywordflow}{case} \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a397a58621d6c1c750502b5dd772d5985}{ICMPV6\_TYPE\_PACKET\_TOO\_BIG}:
172       \textcolor{comment}{//Process Packet Too Big message}
173       \hyperlink{icmpv6_8c_a536a5d75a50eeaa0ae70e5e0f7b8076c}{icmpv6ProcessPacketTooBig}(interface, pseudoHeader, buffer, 
      \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
174       \textcolor{keywordflow}{break};
175    \textcolor{comment}{//Echo Request message?}
176    \textcolor{keywordflow}{case} \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609aedbd1b97f6d8cfbcca7337b08228c50c}{ICMPV6\_TYPE\_ECHO\_REQUEST}:
177       \textcolor{comment}{//Process Echo Request message}
178       \hyperlink{icmpv6_8c_a06dc5af4dcbb44486341a4f0a1cdcce8}{icmpv6ProcessEchoRequest}(interface, pseudoHeader, buffer, 
      \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
179       \textcolor{keywordflow}{break};
180 \textcolor{preprocessor}{#if (MLD\_SUPPORT == ENABLED)}
181    \textcolor{comment}{//Multicast Listener Query message?}
182    \textcolor{keywordflow}{case} \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609ab754cdda0e92e75ec5cba430b4c12d6e}{ICMPV6\_TYPE\_MULTICAST\_LISTENER\_QUERY}:
183       \textcolor{comment}{//Process Multicast Listener Query message}
184       \hyperlink{mld_8c_a07676ea80350d8532e0180d8568a9a8c}{mldProcessListenerQuery}(interface, pseudoHeader, buffer, 
      \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset}, hopLimit);
185       \textcolor{keywordflow}{break};
186    \textcolor{comment}{//Version 1 Multicast Listener Report message?}
187    \textcolor{keywordflow}{case} \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609aba94aea4fe42cd48467e0b61eec810f3}{ICMPV6\_TYPE\_MULTICAST\_LISTENER\_REPORT\_V1}:
188       \textcolor{comment}{//Process Version 1 Multicast Listener Report message}
189       \hyperlink{mld_8c_a5420a201328802ec076b68b2d590824b}{mldProcessListenerReport}(interface, pseudoHeader, buffer, 
      \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset}, hopLimit);
190       \textcolor{keywordflow}{break};
191 \textcolor{preprocessor}{#endif}
192 \textcolor{preprocessor}{#if (NDP\_ROUTER\_ADV\_SUPPORT == ENABLED)}
193    \textcolor{comment}{//Router Solicitation message?}
194    \textcolor{keywordflow}{case} \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609ae9bf5c9cb1c8160705268ee86cfb4f4e}{ICMPV6\_TYPE\_ROUTER\_SOL}:
195       \textcolor{comment}{//Process Router Solicitation message}
196       \hyperlink{ndp__router__adv_8c_a2fdab36d5dc04664ba00cbe16014af23}{ndpProcessRouterSol}(interface, pseudoHeader, buffer, 
      \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset}, hopLimit);
197       \textcolor{keywordflow}{break};
198 \textcolor{preprocessor}{#endif}
199 \textcolor{preprocessor}{#if (NDP\_SUPPORT == ENABLED)}
200    \textcolor{comment}{//Router Advertisement message?}
201    \textcolor{keywordflow}{case} \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a366725c56a608a9a910a6cff642ee8ad}{ICMPV6\_TYPE\_ROUTER\_ADV}:
202       \textcolor{comment}{//Process Router Advertisement message}
203       \hyperlink{ndp_8c_aa7051fe044957e8df3367770d7431581}{ndpProcessRouterAdv}(interface, pseudoHeader, buffer, 
      \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset}, hopLimit);
204       \textcolor{keywordflow}{break};
205    \textcolor{comment}{//Neighbor Solicitation message?}
206    \textcolor{keywordflow}{case} \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a15fcec525be2799e51a85119d592fa0e}{ICMPV6\_TYPE\_NEIGHBOR\_SOL}:
207       \textcolor{comment}{//Process Neighbor Solicitation message}
208       \hyperlink{ndp_8c_a48be39b562002b5c5d7e8eb49dedbd4d}{ndpProcessNeighborSol}(interface, pseudoHeader, buffer, 
      \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset}, hopLimit);
209       \textcolor{keywordflow}{break};
210    \textcolor{comment}{//Neighbor Advertisement message?}
211    \textcolor{keywordflow}{case} \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a8cf8b81569e86589eb5b71c7fd2f8ac5}{ICMPV6\_TYPE\_NEIGHBOR\_ADV}:
212       \textcolor{comment}{//Process Neighbor Advertisement message}
213       \hyperlink{ndp_8c_abad0ce0562414e464a6509338000e462}{ndpProcessNeighborAdv}(interface, pseudoHeader, buffer, 
      \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset}, hopLimit);
214       \textcolor{keywordflow}{break};
215    \textcolor{comment}{//Redirect message?}
216    \textcolor{keywordflow}{case} \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a7ae52a8f3a16cdfbb750f2a0431ad196}{ICMPV6\_TYPE\_REDIRECT}:
217       \textcolor{comment}{//Process Redirect message}
218       \hyperlink{ndp_8c_a9a209b57eb8f84ac34d0eeea736a2aff}{ndpProcessRedirect}(interface, pseudoHeader, buffer, 
      \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset}, hopLimit);
219       \textcolor{keywordflow}{break};
220 \textcolor{preprocessor}{#endif}
221    \textcolor{comment}{//Unknown type?}
222    \textcolor{keywordflow}{default}:
223       \textcolor{comment}{//Debug message}
224       \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"Unknown ICMPv6 message type!\(\backslash\)r\(\backslash\)n"});
225       \textcolor{comment}{//Discard incoming ICMPv6 message}
226       \textcolor{keywordflow}{break};
227    \}
228 \}
\end{DoxyCode}
\mbox{\Hypertarget{icmpv6_8c_a536a5d75a50eeaa0ae70e5e0f7b8076c}\label{icmpv6_8c_a536a5d75a50eeaa0ae70e5e0f7b8076c}} 
\index{icmpv6.\+c@{icmpv6.\+c}!icmpv6\+Process\+Packet\+Too\+Big@{icmpv6\+Process\+Packet\+Too\+Big}}
\index{icmpv6\+Process\+Packet\+Too\+Big@{icmpv6\+Process\+Packet\+Too\+Big}!icmpv6.\+c@{icmpv6.\+c}}
\subsubsection{\texorpdfstring{icmpv6\+Process\+Packet\+Too\+Big()}{icmpv6ProcessPacketTooBig()}}
{\footnotesize\ttfamily void icmpv6\+Process\+Packet\+Too\+Big (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset }\end{DoxyParamCaption})}



Packet Too Big message processing. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & I\+Pv6 pseudo header \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the incoming I\+C\+M\+Pv6 message \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first byte of the I\+C\+M\+Pv6 message \\
\hline
\end{DoxyParams}


Definition at line 274 of file icmpv6.\+c.


\begin{DoxyCode}
276 \{
277    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
278    \hyperlink{icmpv6_8h_a32412b792fe5d155b9e11399a06bd627}{Icmpv6PacketTooBigMessage} *icmpHeader;
279 
280 \textcolor{preprocessor}{#if (IPV6\_PMTU\_SUPPORT == ENABLED)}
281    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} tentativePathMtu;
282    \hyperlink{ipv6_8h_ad553284c12e3a0d96dc8a4da1c5f6ea0}{Ipv6Header} *ipHeader;
283 \textcolor{preprocessor}{#endif}
284 
285    \textcolor{comment}{//Retrieve the length of the Packet Too Big message}
286    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
287 
288    \textcolor{comment}{//Ensure the packet length is correct}
289    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{icmpv6_8h_a32412b792fe5d155b9e11399a06bd627}{Icmpv6PacketTooBigMessage}))
290       \textcolor{keywordflow}{return};
291 
292    \textcolor{comment}{//Point to the ICMPv6 header}
293    icmpHeader = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
294 
295    \textcolor{comment}{//Sanity check}
296    \textcolor{keywordflow}{if}(icmpHeader == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
297       \textcolor{keywordflow}{return};
298 
299    \textcolor{comment}{//Debug message}
300    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"ICMPv6 Packet Too Big message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      length);
301    \textcolor{comment}{//Dump message contents for debugging purpose}
302    \hyperlink{icmpv6_8c_af49449b142e603de0a2dfa0a38ab3b66}{icmpv6DumpPacketTooBigMessage}(icmpHeader);
303 
304 \textcolor{preprocessor}{#if (IPV6\_PMTU\_SUPPORT == ENABLED)}
305    \textcolor{comment}{//Move to the beginning of the original IPv6 packet}
306    \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset} += \textcolor{keyword}{sizeof}(\hyperlink{icmpv6_8h_a32412b792fe5d155b9e11399a06bd627}{Icmpv6PacketTooBigMessage});
307    length -= \textcolor{keyword}{sizeof}(\hyperlink{icmpv6_8h_a32412b792fe5d155b9e11399a06bd627}{Icmpv6PacketTooBigMessage});
308 
309    \textcolor{comment}{//Ensure the packet length is correct}
310    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_ad553284c12e3a0d96dc8a4da1c5f6ea0}{Ipv6Header}))
311       \textcolor{keywordflow}{return};
312 
313    \textcolor{comment}{//Point to the original IPv6 header}
314    ipHeader = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
315 
316    \textcolor{comment}{//Sanity check}
317    \textcolor{keywordflow}{if}(ipHeader == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
318       \textcolor{keywordflow}{return};
319 
320    \textcolor{comment}{//The node uses the value in the MTU field in the Packet Too Big}
321    \textcolor{comment}{//message as a tentative PMTU value}
322    tentativePathMtu = \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(icmpHeader->mtu);
323 
324    \textcolor{comment}{//Update the PMTU for the specified destination address}
325    \hyperlink{ipv6__pmtu_8c_a97ab6cebe947b05986a40fa8e20d159c}{ipv6UpdatePathMtu}(interface, &ipHeader->destAddr, tentativePathMtu);
326 \textcolor{preprocessor}{#endif}
327 \}
\end{DoxyCode}
\mbox{\Hypertarget{icmpv6_8c_a8243f4f8b640432620ed384e865a32cd}\label{icmpv6_8c_a8243f4f8b640432620ed384e865a32cd}} 
\index{icmpv6.\+c@{icmpv6.\+c}!icmpv6\+Send\+Error\+Message@{icmpv6\+Send\+Error\+Message}}
\index{icmpv6\+Send\+Error\+Message@{icmpv6\+Send\+Error\+Message}!icmpv6.\+c@{icmpv6.\+c}}
\subsubsection{\texorpdfstring{icmpv6\+Send\+Error\+Message()}{icmpv6SendErrorMessage()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} icmpv6\+Send\+Error\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{type,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{code,  }\item[{\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t}}]{parameter,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{ip\+Packet,  }\item[{size\+\_\+t}]{ip\+Packet\+Offset }\end{DoxyParamCaption})}



Send an I\+C\+M\+Pv6 Error message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em type} & Message type \\
\hline
\mbox{\tt in}  & {\em code} & Specific message code \\
\hline
\mbox{\tt in}  & {\em parameter} & Specific message parameter \\
\hline
\mbox{\tt in}  & {\em ip\+Packet} & Multi-\/part buffer that holds the invoking I\+Pv6 packet \\
\hline
\mbox{\tt in}  & {\em ip\+Packet\+Offset} & Offset to the first byte of the I\+Pv6 packet \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 462 of file icmpv6.\+c.


\begin{DoxyCode}
464 \{
465    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
466    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
467    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
468    \hyperlink{structNetBuffer}{NetBuffer} *icmpMessage;
469    \hyperlink{icmpv6_8h_a54b4a4016c2d57ad58e3b1562d2c3e85}{Icmpv6ErrorMessage} *icmpHeader;
470    \hyperlink{ipv6_8h_ad553284c12e3a0d96dc8a4da1c5f6ea0}{Ipv6Header} *ipHeader;
471    \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader} pseudoHeader;
472 
473    \textcolor{comment}{//Retrieve the length of the invoking IPv6 packet}
474    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(ipPacket) - ipPacketOffset;
475 
476    \textcolor{comment}{//Check the length of the IPv6 packet}
477    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_ad553284c12e3a0d96dc8a4da1c5f6ea0}{Ipv6Header}))
478       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
479 
480    \textcolor{comment}{//Point to the header of the invoking packet}
481    ipHeader = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(ipPacket, ipPacketOffset);
482 
483    \textcolor{comment}{//Sanity check}
484    \textcolor{keywordflow}{if}(ipHeader == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
485       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
486 
487    \textcolor{comment}{//Check the type of the invoking packet}
488    \textcolor{keywordflow}{if}(ipHeader->nextHeader == \hyperlink{ipv6_8h_a551bec2628dfcc3b67c0fff52e486fa5a1abdcf5760ff2904781383db26717c83}{IPV6\_ICMPV6\_HEADER})
489    \{
490       \textcolor{comment}{//Make sure the ICMPv6 message is valid}
491       \textcolor{keywordflow}{if}(length >= (\textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_ad553284c12e3a0d96dc8a4da1c5f6ea0}{Ipv6Header}) + \textcolor{keyword}{sizeof}(\hyperlink{icmpv6_8h_a0af0a1de09fe69d36242f3e3ae9941ef}{Icmpv6Header})))
492       \{
493          \textcolor{comment}{//Point to the ICMPv6 header}
494          icmpHeader = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(ipPacket, ipPacketOffset + \textcolor{keyword}{sizeof}(
      \hyperlink{ipv6_8h_ad553284c12e3a0d96dc8a4da1c5f6ea0}{Ipv6Header}));
495 
496          \textcolor{comment}{//Sanity check}
497          \textcolor{keywordflow}{if}(icmpHeader != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
498          \{
499             \textcolor{comment}{//An ICMPv6 error message must not be originated as a result}
500             \textcolor{comment}{//of receiving an ICMPv6 error or redirect message}
501             \textcolor{keywordflow}{if}(icmpHeader->type == \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a1a1c28c95ecd1db9a0f41e4ab6a2bae4}{ICMPV6\_TYPE\_DEST\_UNREACHABLE} ||
502                icmpHeader->type == \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a397a58621d6c1c750502b5dd772d5985}{ICMPV6\_TYPE\_PACKET\_TOO\_BIG} ||
503                icmpHeader->type == \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609aa5b348b9c2abd7c47211e3e877583868}{ICMPV6\_TYPE\_TIME\_EXCEEDED} ||
504                icmpHeader->type == \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609afa30d783d8dc3461acab3c04ca741fe6}{ICMPV6\_TYPE\_PARAM\_PROBLEM} ||
505                icmpHeader->type == \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a7ae52a8f3a16cdfbb750f2a0431ad196}{ICMPV6\_TYPE\_REDIRECT})
506             \{
507                \textcolor{comment}{//Do not send the ICMPv6 error message...}
508                \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca2daa3c161edaa4477d1ae954c2136008}{ERROR\_INVALID\_TYPE};
509             \}
510          \}
511       \}
512    \}
513 
514    \textcolor{comment}{//An ICMPv6 error message must not be originated as a result of}
515    \textcolor{comment}{//receiving a packet destined to an IPv6 multicast address}
516    \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_a68fbc1145d242384c90a670196a38495}{ipv6IsMulticastAddr}(&ipHeader->destAddr))
517    \{
518       \textcolor{comment}{//There are two exceptions to this rule}
519       \textcolor{keywordflow}{if}(\hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type} == \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a397a58621d6c1c750502b5dd772d5985}{ICMPV6\_TYPE\_PACKET\_TOO\_BIG})
520       \{
521          \textcolor{comment}{//The Packet Too Big Message to allow Path MTU discovery to}
522          \textcolor{comment}{//work for IPv6 multicast}
523       \}
524       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type} == \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609afa30d783d8dc3461acab3c04ca741fe6}{ICMPV6\_TYPE\_PARAM\_PROBLEM} &&
525          \hyperlink{coap__common_8h_a966576744a473fafb7687f8e5649941f}{code} == \hyperlink{icmpv6_8h_abcea0b4fd39f4856a89fb89bce0c022ea0edd5e89447df4714348a87e196f8cd6}{ICMPV6\_CODE\_UNKNOWN\_IPV6\_OPTION})
526       \{
527          \textcolor{comment}{//The Parameter Problem Message, reporting an unrecognized IPv6}
528          \textcolor{comment}{//option that has the Option Type highest-order two bits set to 10}
529       \}
530       \textcolor{keywordflow}{else}
531       \{
532          \textcolor{comment}{//Do not send the ICMPv6 error message...}
533          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
534       \}
535    \}
536 
537    \textcolor{comment}{//An ICMPv6 error message must not be originated as a result of receiving a}
538    \textcolor{comment}{//packet whose source address does not uniquely identify a single node (e.g.}
539    \textcolor{comment}{//the IPv6 unspecified address, an IPv6 multicast address, or an address}
540    \textcolor{comment}{//known by the ICMPv6 message originator to be an IPv6 anycast address)}
541    \textcolor{keywordflow}{if}(\hyperlink{ipv6__misc_8c_a7448bedb5edff0df8029ca8b5c6d994d}{ipv6IsAnycastAddr}(interface, &ipHeader->srcAddr))
542       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca21cbabf2c791471c05a9bc2710638aec}{ERROR\_INVALID\_ADDRESS};
543 
544    \textcolor{comment}{//Return as much of invoking IPv6 packet as possible without}
545    \textcolor{comment}{//the ICMPv6 packet exceeding the minimum IPv6 MTU}
546    length = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(length, \hyperlink{ipv6_8h_a34a355847abfca977d0ca4ed43dd05ae}{IPV6\_DEFAULT\_MTU} -
547       \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_ad553284c12e3a0d96dc8a4da1c5f6ea0}{Ipv6Header}) - \textcolor{keyword}{sizeof}(\hyperlink{icmpv6_8h_a54b4a4016c2d57ad58e3b1562d2c3e85}{Icmpv6ErrorMessage}));
548 
549    \textcolor{comment}{//Allocate a memory buffer to hold the ICMPv6 message}
550    icmpMessage = \hyperlink{ip_8c_a2222fb64b1b18140283119eea309c1b3}{ipAllocBuffer}(\textcolor{keyword}{sizeof}(\hyperlink{icmpv6_8h_a54b4a4016c2d57ad58e3b1562d2c3e85}{Icmpv6ErrorMessage}), &offset);
551 
552    \textcolor{comment}{//Failed to allocate memory?}
553    \textcolor{keywordflow}{if}(icmpMessage == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
554       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
555 
556    \textcolor{comment}{//Point to the ICMPv6 header}
557    icmpHeader = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(icmpMessage, offset);
558 
559    \textcolor{comment}{//Format ICMPv6 Error message}
560    icmpHeader->type = \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type};
561    icmpHeader->code = \hyperlink{coap__common_8h_a966576744a473fafb7687f8e5649941f}{code};
562    icmpHeader->checksum = 0;
563    icmpHeader->parameter = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(\hyperlink{icmp_8h_aa9b2b1016c7bcb4d12166681dcc74ced}{parameter});
564 
565    \textcolor{comment}{//Copy incoming IPv6 packet contents}
566    error = \hyperlink{net__mem_8c_aba4fe2d850142e40a9a668afeb2a0c8a}{netBufferConcat}(icmpMessage, ipPacket, ipPacketOffset, length);
567 
568    \textcolor{comment}{//Check status code}
569    \textcolor{keywordflow}{if}(!error)
570    \{
571       \textcolor{comment}{//Get the length of the resulting message}
572       length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(icmpMessage) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
573 
574       \textcolor{comment}{//Format IPv6 pseudo header}
575       pseudoHeader.destAddr = ipHeader->srcAddr;
576       pseudoHeader.length = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(length);
577       pseudoHeader.reserved = 0;
578       pseudoHeader.nextHeader = \hyperlink{ipv6_8h_a551bec2628dfcc3b67c0fff52e486fa5a1abdcf5760ff2904781383db26717c83}{IPV6\_ICMPV6\_HEADER};
579 
580       \textcolor{comment}{//Select the relevant source address}
581       error = \hyperlink{ipv6__misc_8c_a1d69e11a455ee8895ec67061f554a174}{ipv6SelectSourceAddr}(&interface, &pseudoHeader.destAddr,
582          &pseudoHeader.srcAddr);
583 
584       \textcolor{comment}{//Check status code}
585       \textcolor{keywordflow}{if}(!error)
586       \{
587          \textcolor{comment}{//Message checksum calculation}
588          icmpHeader->checksum = \hyperlink{ip_8c_a9ec0593d9dbb2adf3e67894c0349cef3}{ipCalcUpperLayerChecksumEx}(&pseudoHeader,
589             \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader}), icmpMessage, offset, length);
590 
591          \textcolor{comment}{//Total number of ICMP messages which this entity attempted to send}
592          \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6Stats.icmpStatsOutMsgs, 1);
593          \textcolor{comment}{//Increment per-message type ICMP counter}
594          \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6MsgStatsTable.icmpMsgStatsOutPkts[
      \hyperlink{resource__manager_8h_a12e46a33bfe90638e58ef067c6fd4a6e}{type}], 1);
595 
596          \textcolor{comment}{//Debug message}
597          \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending ICMPv6 Error message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
598          \textcolor{comment}{//Dump message contents for debugging purpose}
599          \hyperlink{icmpv6_8c_a6755ce5b8d09fca85aab53911d6d7a42}{icmpv6DumpErrorMessage}(icmpHeader);
600 
601          \textcolor{comment}{//Send ICMPv6 Error message}
602          error = \hyperlink{ipv6_8c_ae9edf1ac407897f91eb5caed37df7c3c}{ipv6SendDatagram}(interface, &pseudoHeader, icmpMessage, offset, 0);
603       \}
604    \}
605 
606    \textcolor{comment}{//Free previously allocated memory}
607    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(icmpMessage);
608 
609    \textcolor{comment}{//Return status code}
610    \textcolor{keywordflow}{return} error;
611 \}
\end{DoxyCode}
