\hypertarget{dtls__record_8c}{}\section{cyclone\+\_\+ssl/dtls\+\_\+record.c File Reference}
\label{dtls__record_8c}\index{cyclone\+\_\+ssl/dtls\+\_\+record.\+c@{cyclone\+\_\+ssl/dtls\+\_\+record.\+c}}


D\+T\+LS record protocol.  


{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include \char`\"{}tls.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+common.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+record.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+record\+\_\+encryption.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+record\+\_\+decryption.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ssl\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dtls\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dtls\+\_\+record.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{dtls__record_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{tls__config_8h_afee42a623033dac888291d1993985206}{T\+L\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dtls__record_8c_ab15a3a01b2765ebf23f0fc72f1405f92}{dtls\+Write\+Protocol\+Data} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type} content\+Type)
\begin{DoxyCompactList}\small\item\em Write protocol data. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dtls__record_8c_acdb1074243776f124182a136435bab6c}{dtls\+Read\+Protocol\+Data} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$$\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type} $\ast$content\+Type)
\begin{DoxyCompactList}\small\item\em Read protocol data. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dtls__record_8c_ac8b6ad3223382da3ea249848b37a982f}{dtls\+Write\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type} content\+Type)
\begin{DoxyCompactList}\small\item\em Send a D\+T\+LS record. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dtls__record_8c_af9ed026cb4dd54b900765f1864966a1c}{dtls\+Read\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Receive a D\+T\+LS record. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dtls__record_8c_a4298f0c2cf42865e5b1a26e61c011877}{dtls\+Process\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Process incoming D\+T\+LS record. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dtls__record_8c_ad01829993964da0b26d9d207988b0adb}{dtls\+Send\+Flight} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Send the buffered flight of messages. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dtls__record_8c_aae695d249d55ba6250d18b574cec5831}{dtls\+Fragment\+Handshake\+Message} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{coap__common_8h_ab22abc2906422da61885ac6c8e6a1a59}{version}, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$encryption\+Engine, const \hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{Dtls\+Handshake} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Handshake message fragmentation. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dtls__record_8c_a8cd394d2351d20589f986df81a3cac83}{dtls\+Reassemble\+Handshake\+Message} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{Dtls\+Handshake} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Handshake message reassembly algorithm. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dtls__record_8c_aa8893d9558760708fbb034982ee94f6f}{dtls\+Read\+Datagram} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t size, size\+\_\+t $\ast$\hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Receive a datagram. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{dtls__record_8c_a66a0edf929db08a94f5d56be70bd01d1}{dtls\+Tick} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Manage retransmission timer. \end{DoxyCompactList}\item 
void \hyperlink{dtls__record_8c_adf6fb21ad421813548bc57d792daeb36}{dtls\+Inc\+Sequence\+Number} (\hyperlink{dtls__misc_8h_a900105a81f878731b46d80a2cde979aa}{Dtls\+Sequence\+Number} $\ast$\hyperlink{tcp_8h_a5c6ae6c0d8819f5ef0fd57e7f9ee6a08}{seq\+Num})
\begin{DoxyCompactList}\small\item\em Increment sequence number. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
D\+T\+LS record protocol. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+S\+SL Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{dtls__record_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{dtls__record_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{tls__config_8h_afee42a623033dac888291d1993985206}{T\+L\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file dtls\+\_\+record.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{dtls__record_8c_aae695d249d55ba6250d18b574cec5831}\label{dtls__record_8c_aae695d249d55ba6250d18b574cec5831}} 
\index{dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}!dtls\+Fragment\+Handshake\+Message@{dtls\+Fragment\+Handshake\+Message}}
\index{dtls\+Fragment\+Handshake\+Message@{dtls\+Fragment\+Handshake\+Message}!dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}}
\subsubsection{\texorpdfstring{dtls\+Fragment\+Handshake\+Message()}{dtlsFragmentHandshakeMessage()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dtls\+Fragment\+Handshake\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{version,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{encryption\+Engine,  }\item[{const \hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{Dtls\+Handshake} $\ast$}]{message }\end{DoxyParamCaption})}



Handshake message fragmentation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em version} & D\+T\+LS version to be used \\
\hline
\mbox{\tt in}  & {\em encryption\+Engine} & Pointer to the encryption engine \\
\hline
\mbox{\tt in}  & {\em message} & Pointer the handshake message to be fragmented \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 874 of file dtls\+\_\+record.\+c.


\begin{DoxyCode}
876 \{
877    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
878    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
879    \textcolor{keywordtype}{size\_t} pmtu;
880    \textcolor{keywordtype}{size\_t} totalLength;
881    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_aa43bdf93317fae5b644f41ff0bb490ce}{fragOffset};
882    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_a195eba2189f481b3268b40aeca4f4269}{fragLength};
883    \textcolor{keywordtype}{size\_t} maxFragSize;
884    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *datagram;
885    \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *record;
886    \hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *fragment;
887 
888    \textcolor{comment}{//Determine the value of the PMTU}
889    pmtu = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(context->pmtu, context->txBufferSize - context->txBufferLen);
890 
891    \textcolor{comment}{//DTLS has 25 bytes overhead per packet}
892    n = \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord}) + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
893    \textcolor{comment}{//Take into account the overhead caused by encryption}
894    n += \hyperlink{tls__misc_8c_ab7117ba59f59a625f7509f61e4ce7352}{tlsComputeEncryptionOverhead}(encryptionEngine, 0);
895 
896    \textcolor{comment}{//Make sure the PMTU value is acceptable}
897    \textcolor{keywordflow}{if}(pmtu <= n || pmtu < \hyperlink{dtls__misc_8h_a6e7d2c344c14c4cdfc0cab99f5f19bb1}{DTLS\_MIN\_PMTU})
898       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf3f6e48b0cfaea7cac34f4223cd8a57}{ERROR\_BUFFER\_OVERFLOW};
899 
900    \textcolor{comment}{//Determine the maximum payload size for fragmented messages}
901    maxFragSize = pmtu - \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
902 
903    \textcolor{comment}{//Point to the buffer where to format the datagram}
904    datagram = context->txBuffer + context->txBufferLen;
905    \textcolor{comment}{//Get the length of the handshake message}
906    totalLength = \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->length);
907    \textcolor{comment}{//Prepare to send the first fragment}
908    fragOffset = 0;
909 
910    \textcolor{comment}{//Fragmentation process}
911    \textcolor{keywordflow}{do}
912    \{
913       \textcolor{comment}{//Calculate the length of the current fragment}
914       fragLength = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(totalLength - fragOffset, maxFragSize);
915 
916       \textcolor{comment}{//Any datagram pending to be sent?}
917       \textcolor{keywordflow}{if}(context->txDatagramLen > 0)
918       \{
919          \textcolor{comment}{//Estimate the length of the DTLS record}
920          n = fragLength + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord}) + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
921          \textcolor{comment}{//Take into account the overhead caused by encryption}
922          n += \hyperlink{tls__misc_8c_ab7117ba59f59a625f7509f61e4ce7352}{tlsComputeEncryptionOverhead}(encryptionEngine, n);
923 
924          \textcolor{comment}{//Records may not span datagrams}
925          \textcolor{keywordflow}{if}((context->txDatagramLen + n) > pmtu)
926          \{
927             \textcolor{comment}{//Debug message}
928             \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending UDP datagram (%u bytes)...\(\backslash\)r\(\backslash\)n"}, context->txDatagramLen);
929 
930             \textcolor{comment}{//Send datagram}
931             error = context->socketSendCallback(context->socketHandle,
932                datagram, context->txDatagramLen, &n, 0);
933             \textcolor{comment}{//Any error to report?}
934             \textcolor{keywordflow}{if}(error)
935                \textcolor{keywordflow}{return} error;
936 
937             \textcolor{comment}{//The datagram has been successfully transmitted}
938             context->txDatagramLen = 0;
939          \}
940       \}
941 
942       \textcolor{comment}{//Multiple DTLS records may be placed in a single datagram. They are}
943       \textcolor{comment}{//simply encoded consecutively}
944       record = (\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) (datagram + context->txDatagramLen);
945 
946       \textcolor{comment}{//Format DTLS record}
947       record->type = \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca72077515f40a300c29899b5a3ba48682}{TLS\_TYPE\_HANDSHAKE};
948       record->version = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version});
949       record->epoch = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_a7c88a932eb88fccdae6829f18709b1b6}{epoch});
950       record->seqNum = encryptionEngine->\hyperlink{structTlsEncryptionEngine_a5b11eabf56e10b96ec3c1879a422b1fe}{dtlsSeqNum};
951       record->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(fragLength + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake}));
952 
953       \textcolor{comment}{//Point to the handshake message header}
954       fragment = (\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *) record->data;
955 
956       \textcolor{comment}{//Handshake message type}
957       fragment->msgType = \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->msgType;
958       \textcolor{comment}{//Number of bytes in the message}
959       \hyperlink{cpu__endian_8h_acba352ed22d98efff17d0374c0790885}{STORE24BE}(totalLength, fragment->length);
960       \textcolor{comment}{//Message sequence number}
961       fragment->msgSeq = \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->msgSeq;
962       \textcolor{comment}{//Fragment offset}
963       \hyperlink{cpu__endian_8h_acba352ed22d98efff17d0374c0790885}{STORE24BE}(fragOffset, fragment->fragOffset);
964       \textcolor{comment}{//Fragment length}
965       \hyperlink{cpu__endian_8h_acba352ed22d98efff17d0374c0790885}{STORE24BE}(fragLength, fragment->fragLength);
966 
967       \textcolor{comment}{//Copy data}
968       memcpy(fragment->data, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->data + fragOffset, fragLength);
969 
970       \textcolor{comment}{//Debug message}
971       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Sending handshake message fragment (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
972          \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(fragment->fragLength));
973       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  msgType = %u\(\backslash\)r\(\backslash\)n"}, fragment->msgType);
974       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  msgSeq = %u\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(fragment->msgSeq));
975       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  fragOffset = %u\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(fragment->fragOffset));
976       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  fragLength = %u\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(fragment->fragLength));
977       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  length = %u\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(fragment->length));
978 
979       \textcolor{comment}{//Protect record payload?}
980       \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} != \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af2b260457a3fa53d37ac1701c7b6502e}{CIPHER\_MODE\_NULL} ||
981          encryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
982       \{
983          \textcolor{comment}{//Encrypt DTLS record}
984          error = \hyperlink{tls__record__encryption_8c_a570ea69586ebaeac3279b864b4630a02}{tlsEncryptRecord}(context, encryptionEngine, record);
985          \textcolor{comment}{//Any error to report?}
986          \textcolor{keywordflow}{if}(error)
987             \textcolor{keywordflow}{return} error;
988       \}
989 
990       \textcolor{comment}{//Debug message}
991       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Encrypted DTLS record (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length));
992       \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) + \textcolor{keyword}{sizeof}(
      \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord}));
993 
994       \textcolor{comment}{//Increment sequence number}
995       \hyperlink{dtls__record_8c_adf6fb21ad421813548bc57d792daeb36}{dtlsIncSequenceNumber}(&encryptionEngine->\hyperlink{structTlsEncryptionEngine_a5b11eabf56e10b96ec3c1879a422b1fe}{dtlsSeqNum});
996 
997       \textcolor{comment}{//Adjust the length of the datagram}
998       context->txDatagramLen += \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord});
999 
1000       \textcolor{comment}{//Next fragment}
1001       fragOffset += \hyperlink{dtls__misc_8h_a195eba2189f481b3268b40aeca4f4269}{fragLength};
1002 
1003       \textcolor{comment}{//Check whether fragmentation process is complete}
1004    \} \textcolor{keywordflow}{while}(fragOffset < totalLength);
1005 
1006    \textcolor{comment}{//Successful processing}
1007    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1008 \}
\end{DoxyCode}
\mbox{\Hypertarget{dtls__record_8c_adf6fb21ad421813548bc57d792daeb36}\label{dtls__record_8c_adf6fb21ad421813548bc57d792daeb36}} 
\index{dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}!dtls\+Inc\+Sequence\+Number@{dtls\+Inc\+Sequence\+Number}}
\index{dtls\+Inc\+Sequence\+Number@{dtls\+Inc\+Sequence\+Number}!dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}}
\subsubsection{\texorpdfstring{dtls\+Inc\+Sequence\+Number()}{dtlsIncSequenceNumber()}}
{\footnotesize\ttfamily void dtls\+Inc\+Sequence\+Number (\begin{DoxyParamCaption}\item[{\hyperlink{dtls__misc_8h_a900105a81f878731b46d80a2cde979aa}{Dtls\+Sequence\+Number} $\ast$}]{seq\+Num }\end{DoxyParamCaption})}



Increment sequence number. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in,out}  & {\em seq\+Num} & Sequence number to increment \\
\hline
\end{DoxyParams}


Definition at line 1290 of file dtls\+\_\+record.\+c.


\begin{DoxyCode}
1291 \{
1292    \hyperlink{compiler__port_8h_a022c65af7f6c8d3947e8a37d64db6ad6}{int\_t} i;
1293 
1294    \textcolor{comment}{//Sequence numbers are stored MSB first}
1295    \textcolor{keywordflow}{for}(i = 5; i >= 0; i--)
1296    \{
1297       \textcolor{comment}{//Increment the current byte}
1298       \hyperlink{dtls__misc_8h_a334ea08fc328b399d92541b8795beed5}{seqNum}->b[i]++;
1299 
1300       \textcolor{comment}{//Propagate the carry if necessary}
1301       \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_a334ea08fc328b399d92541b8795beed5}{seqNum}->b[i] != 0)
1302          \textcolor{keywordflow}{break};
1303    \}
1304 \}
\end{DoxyCode}
\mbox{\Hypertarget{dtls__record_8c_a4298f0c2cf42865e5b1a26e61c011877}\label{dtls__record_8c_a4298f0c2cf42865e5b1a26e61c011877}} 
\index{dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}!dtls\+Process\+Record@{dtls\+Process\+Record}}
\index{dtls\+Process\+Record@{dtls\+Process\+Record}!dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}}
\subsubsection{\texorpdfstring{dtls\+Process\+Record()}{dtlsProcessRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dtls\+Process\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Process incoming D\+T\+LS record. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 425 of file dtls\+\_\+record.\+c.


\begin{DoxyCode}
426 \{
427    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
428    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
429 
430    \textcolor{comment}{//Handshake message received?}
431    \textcolor{keywordflow}{if}(context->rxBufferType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca72077515f40a300c29899b5a3ba48682}{TLS\_TYPE\_HANDSHAKE})
432    \{
433       \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_a195eba2189f481b3268b40aeca4f4269}{fragLength};
434       \hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
435 
436       \textcolor{comment}{//Make sure the DTLS record is large enough to hold a handshake message}
437       \textcolor{keywordflow}{if}(context->rxRecordLen < \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake}))
438       \{
439          \textcolor{comment}{//Drop the received DTLS record}
440          context->rxRecordLen = 0;
441          \textcolor{comment}{//Report an error}
442          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
443       \}
444 
445       \textcolor{comment}{//Point to the handshake message}
446       message = (\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *) (context->rxBuffer + context->rxRecordPos);
447 
448       \textcolor{comment}{//Debug message}
449       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Handshake message fragment received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"},
450          \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->fragLength));
451       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  msgType = %u\(\backslash\)r\(\backslash\)n"}, message->msgType);
452       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  msgSeq = %u\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->msgSeq));
453       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  fragOffset = %u\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->fragOffset));
454       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  fragLength = %u\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->fragLength));
455       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  length = %u\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->length));
456 
457       \textcolor{comment}{//Retrieve fragment length}
458       fragLength = \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->fragLength) + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
459 
460       \textcolor{comment}{//Sanity check}
461       \textcolor{keywordflow}{if}(fragLength > context->rxRecordLen)
462       \{
463          \textcolor{comment}{//Drop the received DTLS record}
464          context->rxRecordLen = 0;
465          \textcolor{comment}{//Report an error}
466          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
467       \}
468 
469       \textcolor{comment}{//It is acceptable to pack multiple handshake messages in the same record}
470       context->rxRecordPos += \hyperlink{dtls__misc_8h_a195eba2189f481b3268b40aeca4f4269}{fragLength};
471       context->rxRecordLen -= \hyperlink{dtls__misc_8h_a195eba2189f481b3268b40aeca4f4269}{fragLength};
472 
473       \textcolor{comment}{//Invalid fragment length?}
474       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->fragLength) > \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->length))
475          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
476 
477       \textcolor{comment}{//Empty fragment?}
478       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->fragLength) == 0 && \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->length) != 0)
479          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
480 
481       \textcolor{comment}{//ClientHello message received?}
482       \textcolor{keywordflow}{if}(message->msgType == \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba374f2754185de2cef4ffb42530ce16a8}{TLS\_TYPE\_CLIENT\_HELLO} &&
483          context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dade201db86ae38480c06696f3a48e0170}{TLS\_STATE\_CLIENT\_HELLO} &&
484          context->entity == \hyperlink{tls_8h_acb21bc158664d823d899d760edd8135ba3ddde9cb0be1b78b5b7e1e2ba1704a44}{TLS\_CONNECTION\_END\_SERVER})
485       \{
486          \textcolor{comment}{//Initial handshake?}
487          \textcolor{keywordflow}{if}(context->decryptionEngine.epoch == 0)
488          \{
489             \textcolor{comment}{//The server must use the record sequence number in the ClientHello}
490             \textcolor{comment}{//as the record sequence number in its response (HelloVerifyRequest}
491             \textcolor{comment}{//or ServerHello)}
492             context->encryptionEngine.dtlsSeqNum = context->decryptionEngine.dtlsSeqNum;
493 
494             \textcolor{comment}{//Initialize message sequence numbers}
495             context->rxMsgSeq = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->msgSeq);
496             context->txMsgSeq = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->msgSeq);
497          \}
498       \}
499 
500       \textcolor{comment}{//When a peer receives a handshake message, it can quickly determine}
501       \textcolor{comment}{//whether that message is the next message it expects}
502       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->msgSeq) < context->rxMsgSeq)
503       \{
504          \textcolor{comment}{//Retransmitted flight from the peer?}
505          \textcolor{keywordflow}{if}(message->msgType == \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba374f2754185de2cef4ffb42530ce16a8}{TLS\_TYPE\_CLIENT\_HELLO} ||
506             message->msgType == \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba979c5881efc687024fa12190b925ac1f}{TLS\_TYPE\_SERVER\_HELLO\_DONE} ||
507             message->msgType == \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9baa70dd3c1f4f49e708201d020a2125b9f}{TLS\_TYPE\_FINISHED})
508          \{
509             \textcolor{comment}{//First fragment of the handshake message?}
510             \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->fragOffset) == 0)
511             \{
512                \textcolor{comment}{//Check whether a flight of messages is buffered}
513                \textcolor{keywordflow}{if}(context->txBufferLen > 0)
514                \{
515                   \textcolor{comment}{//Get current time}
516                   time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
517 
518                   \textcolor{comment}{//Send only one response in the case multiple retransmitted}
519                   \textcolor{comment}{//flights are received from the peer}
520                   \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, context->retransmitTimestamp +
521                      \hyperlink{dtls__misc_8h_a917031100bb812ccc64c97035a50d200}{DTLS\_MIN\_TIMEOUT}) >= 0)
522                   \{
523                      \textcolor{comment}{//The implementation transitions to the SENDING state,}
524                      \textcolor{comment}{//where it retransmits the flight, resets the retransmit}
525                      \textcolor{comment}{//timer, and returns to the WAITING state}
526                      \textcolor{keywordflow}{if}(context->retransmitCount < \hyperlink{dtls__misc_8h_a62c2f23476bdda7921ac1043051c9e49}{DTLS\_MAX\_RETRIES})
527                      \{
528                         \hyperlink{dtls__record_8c_ad01829993964da0b26d9d207988b0adb}{dtlsSendFlight}(context);
529                      \}
530                   \}
531                \}
532             \}
533          \}
534 
535          \textcolor{comment}{//If the sequence number of the received message is less than}
536          \textcolor{comment}{//the expected value, the message must be discarded}
537          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca123febd9ffeb844914692b2569da5204}{ERROR\_INVALID\_SEQUENCE\_NUMBER};
538       \}
539       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->msgSeq) > context->rxMsgSeq)
540       \{
541          \textcolor{comment}{//If the sequence number of the received message is greater than}
542          \textcolor{comment}{//the expected value, the implementation may discard it}
543          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca123febd9ffeb844914692b2569da5204}{ERROR\_INVALID\_SEQUENCE\_NUMBER};
544       \}
545       \textcolor{keywordflow}{else}
546       \{
547          \textcolor{comment}{//If the sequence number of the received message matches the}
548          \textcolor{comment}{//expected value, the message is processed}
549       \}
550 
551       \textcolor{comment}{//Check current state}
552       \textcolor{keywordflow}{if}(context->state > \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da69787ce8e1f218e8e47defe7af1c601a}{TLS\_STATE\_SERVER\_HELLO})
553       \{
554          \textcolor{comment}{//Once the server has sent the ServerHello message, enforce the version}
555          \textcolor{comment}{//of incoming records}
556          \textcolor{keywordflow}{if}(context->rxRecordVersion != \hyperlink{dtls__misc_8c_a309abf8d9966cd0d5a28be1d94859970}{dtlsTranslateVersion}(context->version))
557             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca20a00b499b03770ffd859e78470c278f}{ERROR\_VERSION\_NOT\_SUPPORTED};
558       \}
559 
560       \textcolor{comment}{//When a DTLS implementation receives a handshake message fragment,}
561       \textcolor{comment}{//it must buffer it until it has the entire handshake message. DTLS}
562       \textcolor{comment}{//implementations must be able to handle overlapping fragment ranges}
563       error = \hyperlink{dtls__record_8c_a8cd394d2351d20589f986df81a3cac83}{dtlsReassembleHandshakeMessage}(context, message);
564       \textcolor{comment}{//Unacceptable message received?}
565       \textcolor{keywordflow}{if}(error)
566       \{
567          \textcolor{comment}{//Flush the reassembly queue}
568          context->rxFragQueueLen = 0;
569          \textcolor{comment}{//Report an error}
570          \textcolor{keywordflow}{return} error;
571       \}
572 
573       \textcolor{comment}{//Point to the first fragment of the reassembly queue}
574       message = (\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *) context->rxBuffer;
575 
576       \textcolor{comment}{//An unfragmented message is a degenerate case with fragment\_offset = 0}
577       \textcolor{comment}{//and fragment\_length = length}
578       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->fragOffset) == 0 &&
579          \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->fragLength) == \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->length))
580       \{
581          \textcolor{comment}{//The reassembly process is now complete}
582          context->rxFragQueueLen = 0;
583 
584          \textcolor{comment}{//Number of bytes available for reading}
585          context->rxBufferLen = \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(message->length) + \textcolor{keyword}{sizeof}(
      \hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
586          \textcolor{comment}{//Rewind to the beginning of the buffer}
587          context->rxBufferPos = 0;
588 
589          \textcolor{comment}{//The message sequence number is incremented by one}
590          context->rxMsgSeq++;
591 
592          \textcolor{comment}{//Check whether a complete flight of messages has been received}
593          \textcolor{keywordflow}{if}(message->msgType == \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba374f2754185de2cef4ffb42530ce16a8}{TLS\_TYPE\_CLIENT\_HELLO} ||
594             message->msgType == \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9bada2322e839eb9462ae7b291fdae02110}{TLS\_TYPE\_HELLO\_VERIFY\_REQUEST} ||
595             message->msgType == \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba979c5881efc687024fa12190b925ac1f}{TLS\_TYPE\_SERVER\_HELLO\_DONE} ||
596             message->msgType == \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9baa70dd3c1f4f49e708201d020a2125b9f}{TLS\_TYPE\_FINISHED})
597          \{
598             \textcolor{comment}{//Exit from the WAITING state}
599             context->txBufferLen = 0;
600          \}
601       \}
602    \}
603    \textcolor{keywordflow}{else}
604    \{
605       \textcolor{comment}{//ChangeCipherSpec message received?}
606       \textcolor{keywordflow}{if}(context->rxBufferType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca4a02e9d014afd5e75b90deefd3e5428c}{TLS\_TYPE\_CHANGE\_CIPHER\_SPEC})
607       \{
608          \textcolor{comment}{//Sanity check}
609          \textcolor{keywordflow}{if}(context->rxRecordLen < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a589c515096324e0d72dbaf58631c0501}{TlsChangeCipherSpec}))
610          \{
611             \textcolor{comment}{//Drop the received DTLS record}
612             context->rxRecordLen = 0;
613             \textcolor{comment}{//Report an error}
614             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
615          \}
616 
617          \textcolor{comment}{//DTLS operates as a client or a server?}
618          \textcolor{keywordflow}{if}(context->entity == \hyperlink{tls_8h_acb21bc158664d823d899d760edd8135ba7f216418b2d898ed01cf9376fd9b3d6d}{TLS\_CONNECTION\_END\_CLIENT})
619          \{
620             \textcolor{comment}{//Check current state}
621             \textcolor{keywordflow}{if}(context->state != \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da0023cfdc8ed0f0062637380bee3683a0}{TLS\_STATE\_SERVER\_CHANGE\_CIPHER\_SPEC})
622             \{
623                \textcolor{comment}{//Drop the received DTLS record}
624                context->rxRecordLen = 0;
625                \textcolor{comment}{//Report an error}
626                \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
627             \}
628          \}
629          \textcolor{keywordflow}{else}
630          \{
631             \textcolor{comment}{//Check current state}
632             \textcolor{keywordflow}{if}(context->state != \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daf4ad5e0b1c92eb5991962aa9f3a6932b}{TLS\_STATE\_CLIENT\_CHANGE\_CIPHER\_SPEC})
633             \{
634                \textcolor{comment}{//Drop the received DTLS record}
635                context->rxRecordLen = 0;
636                \textcolor{comment}{//Report an error}
637                \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
638             \}
639          \}
640 
641          \textcolor{comment}{//Enforce the version the received DTLS record}
642          \textcolor{keywordflow}{if}(context->rxRecordVersion != \hyperlink{dtls__misc_8c_a309abf8d9966cd0d5a28be1d94859970}{dtlsTranslateVersion}(context->version))
643             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca20a00b499b03770ffd859e78470c278f}{ERROR\_VERSION\_NOT\_SUPPORTED};
644       \}
645       \textcolor{comment}{//Alert message received?}
646       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->rxBufferType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896cac576c866dc3772236d51f16226adfbd9}{TLS\_TYPE\_ALERT})
647       \{
648          \textcolor{comment}{//Sanity check}
649          \textcolor{keywordflow}{if}(context->rxRecordLen < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_aae4f7171708af263a31b184f9747b17a}{TlsAlert}))
650          \{
651             \textcolor{comment}{//Drop the received DTLS record}
652             context->rxRecordLen = 0;
653             \textcolor{comment}{//Report an error}
654             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
655          \}
656       \}
657       \textcolor{comment}{//Application data received?}
658       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->rxBufferType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896caa8233b89b5c8f35ce7fcd1f644cbc0fc}{TLS\_TYPE\_APPLICATION\_DATA})
659       \{
660          \textcolor{comment}{//Check current state}
661          \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da7ff3a76e0b1787b6d0026e533a89649b}{TLS\_STATE\_APPLICATION\_DATA})
662          \{
663             \textcolor{comment}{//The last flight of messages has been received by the peer}
664             context->txBufferLen = 0;
665          \}
666          \textcolor{keywordflow}{else}
667          \{
668             \textcolor{comment}{//Drop the received DTLS record}
669             context->rxRecordLen = 0;
670             \textcolor{comment}{//Report an error}
671             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
672          \}
673 
674          \textcolor{comment}{//Enforce the version the received DTLS record}
675          \textcolor{keywordflow}{if}(context->rxRecordVersion != \hyperlink{dtls__misc_8c_a309abf8d9966cd0d5a28be1d94859970}{dtlsTranslateVersion}(context->version))
676             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca20a00b499b03770ffd859e78470c278f}{ERROR\_VERSION\_NOT\_SUPPORTED};
677       \}
678       \textcolor{comment}{//Unknown content type?}
679       \textcolor{keywordflow}{else}
680       \{
681          \textcolor{comment}{//Drop the received DTLS record}
682          context->rxRecordLen = 0;
683          \textcolor{comment}{//Report an error}
684          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
685       \}
686 
687       \textcolor{comment}{//Number of bytes available for reading}
688       context->rxBufferLen = context->rxRecordLen;
689       \textcolor{comment}{//Rewind to the beginning of the buffer}
690       context->rxBufferPos = 0;
691 
692       \textcolor{comment}{//Copy application data}
693       memcpy(context->rxBuffer, context->rxBuffer + context->rxRecordPos,
694          context->rxRecordLen);
695 
696       \textcolor{comment}{//The DTLS record has been entirely processed}
697       context->rxRecordLen = 0;
698       \textcolor{comment}{//Flush the reassembly queue}
699       context->rxFragQueueLen = 0;
700    \}
701 
702    \textcolor{comment}{//Successful processing}
703    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
704 \}
\end{DoxyCode}
\mbox{\Hypertarget{dtls__record_8c_aa8893d9558760708fbb034982ee94f6f}\label{dtls__record_8c_aa8893d9558760708fbb034982ee94f6f}} 
\index{dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}!dtls\+Read\+Datagram@{dtls\+Read\+Datagram}}
\index{dtls\+Read\+Datagram@{dtls\+Read\+Datagram}!dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}}
\subsubsection{\texorpdfstring{dtls\+Read\+Datagram()}{dtlsReadDatagram()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dtls\+Read\+Datagram (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{size,  }\item[{size\+\_\+t $\ast$}]{length }\end{DoxyParamCaption})}



Receive a datagram. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt out}  & {\em data} & Buffer where to store the incoming datagram \\
\hline
\mbox{\tt in}  & {\em size} & Maximum number of bytes that can be received \\
\hline
\mbox{\tt out}  & {\em length} & Number of bytes that have been received \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1158 of file dtls\+\_\+record.\+c.


\begin{DoxyCode}
1160 \{
1161    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1162    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
1163 
1164    \textcolor{comment}{//Initialize status code}
1165    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1166 
1167    \textcolor{comment}{//Wait for an incoming datagram}
1168    \textcolor{keywordflow}{while}(!error)
1169    \{
1170       \textcolor{comment}{//Receive datagram}
1171       error = context->socketReceiveCallback(context->socketHandle, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data},
1172          size, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, 0);
1173 
1174       \textcolor{comment}{//Check status code}
1175       \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
1176       \{
1177          \textcolor{comment}{//Debug message}
1178          \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"UDP datagram received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, *
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
1179          \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
1180 
1181          \textcolor{comment}{//A datagram has been successfully received}
1182          \textcolor{keywordflow}{break};
1183       \}
1184       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK})
1185       \{
1186          \textcolor{comment}{//Manage retransmission timer}
1187          error = \hyperlink{dtls__record_8c_a66a0edf929db08a94f5d56be70bd01d1}{dtlsTick}(context);
1188 
1189          \textcolor{comment}{//Check status code}
1190          \textcolor{keywordflow}{if}(!error)
1191          \{
1192             \textcolor{comment}{//Exit immediately}
1193             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca16f356a669fbb42deb27f59e9054f6d6}{ERROR\_WOULD\_BLOCK};
1194          \}
1195       \}
1196       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
1197       \{
1198          \textcolor{comment}{//Manage retransmission timer}
1199          error = \hyperlink{dtls__record_8c_a66a0edf929db08a94f5d56be70bd01d1}{dtlsTick}(context);
1200 
1201          \textcolor{comment}{//Check status code}
1202          \textcolor{keywordflow}{if}(!error)
1203          \{
1204             \textcolor{comment}{//Check whether a timeout has been specified}
1205             \textcolor{keywordflow}{if}(context->timeout != \hyperlink{os__port_8h_ab893de6f8a0ec8b0e6dd8097ff398019}{INFINITE\_DELAY})
1206             \{
1207                \textcolor{comment}{//Get current time}
1208                time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
1209 
1210                \textcolor{comment}{//Check whether the timeout has elapsed}
1211                \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, context->startTime + context->timeout) >= 0)
1212                \{
1213                   \textcolor{comment}{//Exit immediately}
1214                   error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT};
1215                \}
1216             \}
1217          \}
1218       \}
1219       \textcolor{keywordflow}{else}
1220       \{
1221          \textcolor{comment}{//The read operation has failed}
1222          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cacf545b4d693b270f9d01d54d86efedc2}{ERROR\_READ\_FAILED};
1223       \}
1224    \}
1225 
1226    \textcolor{comment}{//Return status code}
1227    \textcolor{keywordflow}{return} error;
1228 \}
\end{DoxyCode}
\mbox{\Hypertarget{dtls__record_8c_acdb1074243776f124182a136435bab6c}\label{dtls__record_8c_acdb1074243776f124182a136435bab6c}} 
\index{dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}!dtls\+Read\+Protocol\+Data@{dtls\+Read\+Protocol\+Data}}
\index{dtls\+Read\+Protocol\+Data@{dtls\+Read\+Protocol\+Data}!dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}}
\subsubsection{\texorpdfstring{dtls\+Read\+Protocol\+Data()}{dtlsReadProtocolData()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dtls\+Read\+Protocol\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$$\ast$}]{data,  }\item[{size\+\_\+t $\ast$}]{length,  }\item[{\hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type} $\ast$}]{content\+Type }\end{DoxyParamCaption})}



Read protocol data. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt out}  & {\em data} & Pointer to the received data \\
\hline
\mbox{\tt out}  & {\em length} & Number of data bytes that were received \\
\hline
\mbox{\tt out}  & {\em content\+Type} & Higher level protocol \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 132 of file dtls\+\_\+record.\+c.


\begin{DoxyCode}
134 \{
135    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
136 
137    \textcolor{comment}{//Initialize status code}
138    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
139 
140    \textcolor{comment}{//Receive process}
141    \textcolor{keywordflow}{while}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR})
142    \{
143       \textcolor{keywordflow}{if}(context->rxBufferLen > 0)
144       \{
145          \textcolor{comment}{//Pass the received data to the higher layer}
146          \textcolor{keywordflow}{break};
147       \}
148       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->rxRecordLen > 0)
149       \{
150          \textcolor{comment}{//Process the incoming DTLS record}
151          error = \hyperlink{dtls__record_8c_a4298f0c2cf42865e5b1a26e61c011877}{dtlsProcessRecord}(context);
152 
153          \textcolor{comment}{//Invalid record?}
154          \textcolor{keywordflow}{if}(error)
155          \{
156             \textcolor{comment}{//Debug message}
157             \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"Discarding DTLS record!\(\backslash\)r\(\backslash\)n"});
158 
159             \textcolor{comment}{//DTLS implementations should silently discard records with}
160             \textcolor{comment}{//bad MACs and continue with the connection}
161             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
162          \}
163       \}
164       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->rxDatagramLen > 0)
165       \{
166          \textcolor{comment}{//Read a new DTLS record from the datagram}
167          error = \hyperlink{dtls__record_8c_af9ed026cb4dd54b900765f1864966a1c}{dtlsReadRecord}(context);
168 
169          \textcolor{comment}{//Malformed record?}
170          \textcolor{keywordflow}{if}(error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} && error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cacb4ee8addfac0a3444278066663c368a}{ERROR\_RECORD\_OVERFLOW})
171          \{
172             \textcolor{comment}{//Debug message}
173             \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"Discarding DTLS record!\(\backslash\)r\(\backslash\)n"});
174 
175             \textcolor{comment}{//The receiving implementation should discard the offending record}
176             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
177          \}
178       \}
179       \textcolor{keywordflow}{else}
180       \{
181          \textcolor{comment}{//Read a new datagram}
182          error = \hyperlink{dtls__record_8c_aa8893d9558760708fbb034982ee94f6f}{dtlsReadDatagram}(context, context->rxBuffer + context->rxFragQueueLen,
183             context->rxBufferSize - context->rxFragQueueLen, &context->rxDatagramLen);
184 
185          \textcolor{comment}{//Check whether a valid datagram has been received}
186          \textcolor{keywordflow}{if}(!error)
187          \{
188             \textcolor{comment}{//Make room for the fragment reassembly process}
189             context->rxDatagramPos = context->rxBufferSize - context->rxDatagramLen;
190 
191             \textcolor{comment}{//Copy the received datagram}
192             memmove(context->rxBuffer + context->rxDatagramPos,
193                context->rxBuffer + context->rxFragQueueLen, context->rxDatagramLen);
194          \}
195       \}
196    \}
197 
198    \textcolor{comment}{//Successful processing?}
199    \textcolor{keywordflow}{if}(!error)
200    \{
201 \textcolor{preprocessor}{#if (TLS\_MAX\_WARNING\_ALERTS > 0)}
202       \textcolor{comment}{//Reset the count of consecutive warning alerts}
203       \textcolor{keywordflow}{if}(context->rxBufferType != \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896cac576c866dc3772236d51f16226adfbd9}{TLS\_TYPE\_ALERT})
204          context->alertCount = 0;
205 \textcolor{preprocessor}{#endif}
206 
207       \textcolor{comment}{//Pointer to the received data}
208       *\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data} = context->rxBuffer + context->rxBufferPos;
209       \textcolor{comment}{//Length, in byte, of the data}
210       *\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = context->rxBufferLen;
211       \textcolor{comment}{//Protocol type}
212       *contentType = context->rxBufferType;
213    \}
214 
215    \textcolor{comment}{//Return status code}
216    \textcolor{keywordflow}{return} error;
217 \}
\end{DoxyCode}
\mbox{\Hypertarget{dtls__record_8c_af9ed026cb4dd54b900765f1864966a1c}\label{dtls__record_8c_af9ed026cb4dd54b900765f1864966a1c}} 
\index{dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}!dtls\+Read\+Record@{dtls\+Read\+Record}}
\index{dtls\+Read\+Record@{dtls\+Read\+Record}!dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}}
\subsubsection{\texorpdfstring{dtls\+Read\+Record()}{dtlsReadRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dtls\+Read\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Receive a D\+T\+LS record. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 323 of file dtls\+\_\+record.\+c.


\begin{DoxyCode}
324 \{
325    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
326    \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *record;
327    \textcolor{keywordtype}{size\_t} recordLen;
328    \hyperlink{structTlsEncryptionEngine}{TlsEncryptionEngine} *decryptionEngine;
329 
330    \textcolor{comment}{//Point to the decryption engine}
331    decryptionEngine = &context->decryptionEngine;
332 
333    \textcolor{comment}{//Make sure the datagram is large enough to hold a DTLS record}
334    \textcolor{keywordflow}{if}(context->rxDatagramLen < \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord}))
335    \{
336       \textcolor{comment}{//Drop received datagram}
337       context->rxDatagramLen = 0;
338       \textcolor{comment}{//Report an error}
339       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
340    \}
341 
342    \textcolor{comment}{//Point to the DTLS record}
343    record = (\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) (context->rxBuffer + context->rxDatagramPos);
344    \textcolor{comment}{//Retrieve the length of the record}
345    recordLen = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length);
346 
347    \textcolor{comment}{//Sanity check}
348    \textcolor{keywordflow}{if}((recordLen + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord})) > context->rxDatagramLen)
349    \{
350       \textcolor{comment}{//Drop received datagram}
351       context->rxDatagramLen = 0;
352       \textcolor{comment}{//Report an error}
353       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
354    \}
355 
356    \textcolor{comment}{//Debug message}
357    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"DTLS encrypted record received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, recordLen)
      ;
358    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, recordLen + \textcolor{keyword}{sizeof}(
      \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord}));
359 
360    \textcolor{comment}{//Point to the payload data}
361    context->rxRecordPos = context->rxDatagramPos + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord});
362 
363    \textcolor{comment}{//It is acceptable to pack multiple DTLS records in the same datagram}
364    context->rxDatagramPos += recordLen + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord});
365    context->rxDatagramLen -= recordLen + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord});
366 
367    \textcolor{comment}{//Compliant servers must accept any value \{254,XX\} as the record layer}
368    \textcolor{comment}{//version number for ClientHello}
369    \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a34a3aa6cbadec6a80ab1eae8efd0083d}{LSB}(record->version) != \hyperlink{os__port_8h_aeb61a4e8fff2f4624a632a3189cbd3a0}{MSB}(\hyperlink{dtls__misc_8h_afcf6494322cd28c6fc73db506ad03ba9}{DTLS\_VERSION\_1\_0}))
370       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca20a00b499b03770ffd859e78470c278f}{ERROR\_VERSION\_NOT\_SUPPORTED};
371 
372    \textcolor{comment}{//Discard packets from earlier epochs}
373    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->epoch) != context->decryptionEngine.epoch)
374       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca79b07f7abbe79777182858027cefc98d}{ERROR\_INVALID\_EPOCH};
375 
376    \textcolor{comment}{//Perform replay detection}
377    error = \hyperlink{dtls__misc_8c_adb9b8390ac33f0a051cef8dc16a5a6d5}{dtlsCheckReplayWindow}(context, &record->seqNum);
378    \textcolor{comment}{//Any error to report?}
379    \textcolor{keywordflow}{if}(error)
380       \textcolor{keywordflow}{return} error;
381 
382    \textcolor{comment}{//Check whether the record payload is protected}
383    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} != \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af2b260457a3fa53d37ac1701c7b6502e}{CIPHER\_MODE\_NULL} ||
384       decryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
385    \{
386       \textcolor{comment}{//Decrypt DTLS record}
387       error = \hyperlink{tls__record__decryption_8c_a12df36547985f2fbe84fee13de092476}{tlsDecryptRecord}(context, decryptionEngine, record);
388       \textcolor{comment}{//If the MAC validation fails, the receiver must discard the record}
389       \textcolor{keywordflow}{if}(error)
390          \textcolor{keywordflow}{return} error;
391 
392       \textcolor{comment}{//The length of the plaintext record must not exceed 2^14 bytes}
393       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) > \hyperlink{tls_8h_a87485283e0c2c0a9b1b3e5ef9df52975}{TLS\_MAX\_RECORD\_LENGTH})
394          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cacb4ee8addfac0a3444278066663c368a}{ERROR\_RECORD\_OVERFLOW};
395    \}
396 
397    \textcolor{comment}{//The receive window is updated only if the MAC verification succeeds}
398    \hyperlink{dtls__misc_8c_a0842d49fcb57ad07c4fbd6702d148125}{dtlsUpdateReplayWindow}(context, &record->seqNum);
399 
400    \textcolor{comment}{//Retrieve the length of the record}
401    recordLen = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length);
402 
403    \textcolor{comment}{//Debug message}
404    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"DTLS decrypted record received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, recordLen)
      ;
405    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, recordLen + \textcolor{keyword}{sizeof}(
      \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord}));
406 
407    \textcolor{comment}{//Save record version}
408    context->rxRecordVersion = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->version);
409    \textcolor{comment}{//Save record type}
410    context->rxBufferType = (\hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{TlsContentType}) record->type;
411    \textcolor{comment}{//Save record length}
412    context->rxRecordLen = recordLen;
413 
414    \textcolor{comment}{//Successful processing}
415    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
416 \}
\end{DoxyCode}
\mbox{\Hypertarget{dtls__record_8c_a8cd394d2351d20589f986df81a3cac83}\label{dtls__record_8c_a8cd394d2351d20589f986df81a3cac83}} 
\index{dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}!dtls\+Reassemble\+Handshake\+Message@{dtls\+Reassemble\+Handshake\+Message}}
\index{dtls\+Reassemble\+Handshake\+Message@{dtls\+Reassemble\+Handshake\+Message}!dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}}
\subsubsection{\texorpdfstring{dtls\+Reassemble\+Handshake\+Message()}{dtlsReassembleHandshakeMessage()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dtls\+Reassemble\+Handshake\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{Dtls\+Handshake} $\ast$}]{message }\end{DoxyParamCaption})}



Handshake message reassembly algorithm. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em message} & Pointer the newly arrived fragment \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1018 of file dtls\+\_\+record.\+c.


\begin{DoxyCode}
1020 \{
1021    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1022    \textcolor{keywordtype}{size\_t} pos;
1023    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_aa43bdf93317fae5b644f41ff0bb490ce}{fragOffset};
1024    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_a195eba2189f481b3268b40aeca4f4269}{fragLength};
1025    \textcolor{keywordtype}{size\_t} prevFragOffset;
1026    \textcolor{keywordtype}{size\_t} prevFragLength;
1027    \hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *fragment;
1028    \hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *prevFragment;
1029 
1030    \textcolor{comment}{//Retrieve fragment offset}
1031    fragOffset = \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->fragOffset);
1032    \textcolor{comment}{//Retrieve fragment length}
1033    fragLength = \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->fragLength) + \textcolor{keyword}{sizeof}(
      \hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
1034 
1035    \textcolor{comment}{//Point to the beginning of the reassembly queue}
1036    pos = 0;
1037 
1038    \textcolor{comment}{//Loop through the reassembly queue}
1039    \textcolor{keywordflow}{while}(pos < context->rxFragQueueLen)
1040    \{
1041       \textcolor{comment}{//Point to the current fragment}
1042       fragment = (\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *) (context->rxBuffer + pos);
1043 
1044       \textcolor{comment}{//Message type mismatch?}
1045       \textcolor{keywordflow}{if}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->msgType != fragment->msgType)
1046          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
1047 
1048       \textcolor{comment}{//Message length mismatch?}
1049       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->length) != \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(fragment->length))
1050          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
1051 
1052       \textcolor{comment}{//Sort fragments in ascending order}
1053       \textcolor{keywordflow}{if}(fragOffset < \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(fragment->fragOffset))
1054          \textcolor{keywordflow}{break};
1055 
1056       \textcolor{comment}{//Next fragment}
1057       pos += \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(fragment->fragLength) + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
1058    \}
1059 
1060    \textcolor{comment}{//Sanity check}
1061    \textcolor{keywordflow}{if}((context->rxFragQueueLen + fragLength) > (context->rxBufferSize - context->rxDatagramLen))
1062       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf3f6e48b0cfaea7cac34f4223cd8a57}{ERROR\_BUFFER\_OVERFLOW};
1063 
1064    \textcolor{comment}{//Position where to insert the new fragment}
1065    fragment = (\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *) (context->rxBuffer + pos);
1066 
1067    \textcolor{comment}{//Make room for the new fragment}
1068    memmove(context->rxBuffer + pos + fragLength, fragment,
1069       context->rxFragQueueLen - pos);
1070 
1071    \textcolor{comment}{//Insert the new fragment in the reassembly queue}
1072    memcpy(fragment, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, fragLength);
1073    \textcolor{comment}{//Update the length of the reassembly queue}
1074    context->rxFragQueueLen += \hyperlink{dtls__misc_8h_a195eba2189f481b3268b40aeca4f4269}{fragLength};
1075 
1076    \textcolor{comment}{//Point to the first fragment of the reassembly queue}
1077    prevFragment = (\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *) context->rxBuffer;
1078    \textcolor{comment}{//Retrieve fragment offset}
1079    prevFragOffset = \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(prevFragment->fragOffset);
1080    \textcolor{comment}{//Retrieve fragment length}
1081    prevFragLength = \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(prevFragment->fragLength);
1082 
1083    \textcolor{comment}{//Position of the next fragment}
1084    pos = prevFragLength + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
1085 
1086    \textcolor{comment}{//Loop through the reassembly queue}
1087    \textcolor{keywordflow}{while}(pos < context->rxFragQueueLen)
1088    \{
1089       \textcolor{comment}{//Point to the current fragment}
1090       fragment = (\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *) (context->rxBuffer + pos);
1091       \textcolor{comment}{//Retrieve fragment offset}
1092       fragOffset = \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(fragment->fragOffset);
1093       \textcolor{comment}{//Retrieve fragment length}
1094       fragLength = \hyperlink{cpu__endian_8h_ae0950d84d4cadc7bef52fc340c49c720}{LOAD24BE}(fragment->fragLength);
1095 
1096       \textcolor{comment}{//Check whether the current fragment interacts in some way with the}
1097       \textcolor{comment}{//previous fragment}
1098       \textcolor{keywordflow}{if}(fragOffset <= (prevFragOffset + prevFragLength))
1099       \{
1100          \textcolor{comment}{//DTLS implementations must be able to handle overlapping fragment}
1101          \textcolor{comment}{//ranges}
1102          \textcolor{keywordflow}{if}((fragOffset + fragLength) > (prevFragOffset + prevFragLength))
1103          \{
1104             \textcolor{comment}{//Coalesce overlapping fragments}
1105             memmove(prevFragment->data + fragOffset - prevFragOffset, fragment->data,
1106                context->rxFragQueueLen - pos - \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake}));
1107 
1108             \textcolor{comment}{//Number of bytes that do not overlap with the previous fragment}
1109             n = fragOffset + fragLength - prevFragOffset - prevFragLength;
1110 
1111             \textcolor{comment}{//Update the length of the reassembly queue}
1112             context->rxFragQueueLen -= fragLength - n + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
1113 
1114             \textcolor{comment}{//Adjust the length of the previous fragment}
1115             prevFragLength += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1116             \textcolor{comment}{//Fix fragment length field}
1117             \hyperlink{cpu__endian_8h_acba352ed22d98efff17d0374c0790885}{STORE24BE}(prevFragLength, prevFragment->fragLength);
1118 
1119             \textcolor{comment}{//Jump to the next fragment}
1120             pos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1121          \}
1122          \textcolor{keywordflow}{else}
1123          \{
1124             \textcolor{comment}{//Drop current fragment}
1125             memmove(fragment, fragment->data + fragLength,
1126                context->rxFragQueueLen - fragLength - \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake}));
1127 
1128             \textcolor{comment}{//Update the length of the reassembly queue}
1129             context->rxFragQueueLen -= fragLength + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
1130          \}
1131       \}
1132       \textcolor{keywordflow}{else}
1133       \{
1134          \textcolor{comment}{//Jump to the next fragment}
1135          pos += fragLength + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake});
1136 
1137          \textcolor{comment}{//Keep track of the previous fragment}
1138          prevFragment = fragment;
1139          prevFragOffset = \hyperlink{dtls__misc_8h_aa43bdf93317fae5b644f41ff0bb490ce}{fragOffset};
1140          prevFragLength = \hyperlink{dtls__misc_8h_a195eba2189f481b3268b40aeca4f4269}{fragLength};
1141       \}
1142    \}
1143 
1144    \textcolor{comment}{//Successful processing}
1145    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1146 \}
\end{DoxyCode}
\mbox{\Hypertarget{dtls__record_8c_ad01829993964da0b26d9d207988b0adb}\label{dtls__record_8c_ad01829993964da0b26d9d207988b0adb}} 
\index{dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}!dtls\+Send\+Flight@{dtls\+Send\+Flight}}
\index{dtls\+Send\+Flight@{dtls\+Send\+Flight}!dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}}
\subsubsection{\texorpdfstring{dtls\+Send\+Flight()}{dtlsSendFlight()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dtls\+Send\+Flight (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Send the buffered flight of messages. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 713 of file dtls\+\_\+record.\+c.


\begin{DoxyCode}
714 \{
715    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
716    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
717    \textcolor{keywordtype}{size\_t} pmtu;
718    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *datagram;
719    \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *record;
720    \hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
721    \hyperlink{structTlsEncryptionEngine}{TlsEncryptionEngine} *encryptionEngine;
722 
723    \textcolor{comment}{//Determine the value of the PMTU}
724    pmtu = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(context->pmtu, context->txBufferSize - context->txBufferLen);
725 
726    \textcolor{comment}{//Make sure the PMTU value is acceptable}
727    \textcolor{keywordflow}{if}(pmtu < \hyperlink{dtls__misc_8h_a6e7d2c344c14c4cdfc0cab99f5f19bb1}{DTLS\_MIN\_PMTU})
728       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf3f6e48b0cfaea7cac34f4223cd8a57}{ERROR\_BUFFER\_OVERFLOW};
729 
730    \textcolor{comment}{//Point to the buffer where to format the datagram}
731    datagram = context->txBuffer + context->txBufferLen;
732    \textcolor{comment}{//Length of the datagram, in bytes}
733    context->txDatagramLen = 0;
734    \textcolor{comment}{//Point to the first message of the flight}
735    context->txBufferPos = 0;
736 
737    \textcolor{comment}{//In the SENDING state, the implementation transmits the buffered}
738    \textcolor{comment}{//flight of messages}
739    \textcolor{keywordflow}{while}(context->txBufferPos < context->txBufferLen)
740    \{
741       \textcolor{comment}{//Point to the current DTLS record}
742       record = (\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) (context->txBuffer + context->txBufferPos);
743 
744       \textcolor{comment}{//Select the relevant encryption engine}
745       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->epoch) == context->encryptionEngine.epoch)
746          encryptionEngine = &context->encryptionEngine;
747       \textcolor{keywordflow}{else}
748          encryptionEngine = &context->prevEncryptionEngine;
749 
750       \textcolor{comment}{//Handshake message?}
751       \textcolor{keywordflow}{if}(record->type == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca72077515f40a300c29899b5a3ba48682}{TLS\_TYPE\_HANDSHAKE})
752       \{
753          \textcolor{comment}{//Point to the handshake message header to be fragmented}
754          message = (\hyperlink{dtls__misc_8h_ac7c3eafeddae59e8c27cbab7c56ab5cb}{DtlsHandshake} *) record->data;
755 
756          \textcolor{comment}{//Fragment handshake message into smaller fragments}
757          error = \hyperlink{dtls__record_8c_aae695d249d55ba6250d18b574cec5831}{dtlsFragmentHandshakeMessage}(context,
758             \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->version), encryptionEngine, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message});
759          \textcolor{comment}{//Any error to report?}
760          \textcolor{keywordflow}{if}(error)
761             \textcolor{keywordflow}{return} error;
762       \}
763       \textcolor{keywordflow}{else}
764       \{
765          \textcolor{comment}{//Any datagram pending to be sent?}
766          \textcolor{keywordflow}{if}(context->txDatagramLen > 0)
767          \{
768             \textcolor{comment}{//Estimate the length of the DTLS record}
769             n = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord});
770             \textcolor{comment}{//Take into account the overhead caused by encryption}
771             n += \hyperlink{tls__misc_8c_ab7117ba59f59a625f7509f61e4ce7352}{tlsComputeEncryptionOverhead}(encryptionEngine, n);
772 
773             \textcolor{comment}{//Records may not span datagrams}
774             \textcolor{keywordflow}{if}((context->txDatagramLen + n) > pmtu)
775             \{
776                \textcolor{comment}{//Debug message}
777                \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending UDP datagram (%u bytes)...\(\backslash\)r\(\backslash\)n"}, context->txDatagramLen);
778 
779                \textcolor{comment}{//Send datagram}
780                error = context->socketSendCallback(context->socketHandle,
781                   datagram, context->txDatagramLen, &n, 0);
782                \textcolor{comment}{//Any error to report?}
783                \textcolor{keywordflow}{if}(error)
784                   \textcolor{keywordflow}{return} error;
785 
786                \textcolor{comment}{//The datagram has been successfully transmitted}
787                context->txDatagramLen = 0;
788             \}
789          \}
790 
791          \textcolor{comment}{//Estimate the length of the DTLS record}
792          n = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord});
793          \textcolor{comment}{//Take into account the overhead caused by encryption}
794          n += \hyperlink{tls__misc_8c_ab7117ba59f59a625f7509f61e4ce7352}{tlsComputeEncryptionOverhead}(encryptionEngine, n);
795 
796          \textcolor{comment}{//Make sure the buffer is large enough to hold the DTLS record}
797          \textcolor{keywordflow}{if}((context->txBufferLen + context->txDatagramLen + n) > context->txBufferSize)
798             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf3f6e48b0cfaea7cac34f4223cd8a57}{ERROR\_BUFFER\_OVERFLOW};
799 
800          \textcolor{comment}{//Multiple DTLS records may be placed in a single datagram. They are}
801          \textcolor{comment}{//simply encoded consecutively}
802          memcpy(datagram + context->txDatagramLen, record,
803             \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord}));
804 
805          \textcolor{comment}{//Point to the DTLS record header}
806          record = (\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) (datagram + context->txDatagramLen);
807 
808          \textcolor{comment}{//From the perspective of the DTLS record layer, the retransmission is}
809          \textcolor{comment}{//a new record. This record will have a new sequence number}
810          record->seqNum = encryptionEngine->\hyperlink{structTlsEncryptionEngine_a5b11eabf56e10b96ec3c1879a422b1fe}{dtlsSeqNum};
811 
812          \textcolor{comment}{//Protect record payload?}
813          \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} != \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af2b260457a3fa53d37ac1701c7b6502e}{CIPHER\_MODE\_NULL} ||
814             encryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
815          \{
816             \textcolor{comment}{//Encrypt DTLS record}
817             error = \hyperlink{tls__record__encryption_8c_a570ea69586ebaeac3279b864b4630a02}{tlsEncryptRecord}(context, encryptionEngine, record);
818             \textcolor{comment}{//Any error to report?}
819             \textcolor{keywordflow}{if}(error)
820                \textcolor{keywordflow}{return} error;
821          \}
822 
823          \textcolor{comment}{//Debug message}
824          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Encrypted DTLS record (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length));
825          \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) + \textcolor{keyword}{sizeof}(
      \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord}));
826 
827          \textcolor{comment}{//Increment sequence number}
828          \hyperlink{dtls__record_8c_adf6fb21ad421813548bc57d792daeb36}{dtlsIncSequenceNumber}(&encryptionEngine->
      \hyperlink{structTlsEncryptionEngine_a5b11eabf56e10b96ec3c1879a422b1fe}{dtlsSeqNum});
829 
830          \textcolor{comment}{//Adjust the length of the datagram}
831          context->txDatagramLen += \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) + \textcolor{keyword}{sizeof}(
      \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord});
832       \}
833 
834       \textcolor{comment}{//Loop through the flight of messages}
835       context->txBufferPos += \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord});
836    \}
837 
838    \textcolor{comment}{//Any datagram pending to be sent?}
839    \textcolor{keywordflow}{if}(context->txDatagramLen > 0)
840    \{
841       \textcolor{comment}{//Debug message}
842       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending UDP datagram (%u bytes)...\(\backslash\)r\(\backslash\)n"}, context->txDatagramLen);
843 
844       \textcolor{comment}{//Send datagram}
845       error = context->socketSendCallback(context->socketHandle, datagram,
846          context->txDatagramLen, &n, 0);
847       \textcolor{comment}{//Any error to report?}
848       \textcolor{keywordflow}{if}(error)
849          \textcolor{keywordflow}{return} error;
850 
851       \textcolor{comment}{//The datagram has been successfully transmitted}
852       context->txDatagramLen = 0;
853    \}
854 
855    \textcolor{comment}{//Save the time at which the flight of messages was sent}
856    context->retransmitTimestamp = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
857    \textcolor{comment}{//Increment retransmission counter}
858    context->retransmitCount++;
859 
860    \textcolor{comment}{//Successful processing}
861    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
862 \}
\end{DoxyCode}
\mbox{\Hypertarget{dtls__record_8c_a66a0edf929db08a94f5d56be70bd01d1}\label{dtls__record_8c_a66a0edf929db08a94f5d56be70bd01d1}} 
\index{dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}!dtls\+Tick@{dtls\+Tick}}
\index{dtls\+Tick@{dtls\+Tick}!dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}}
\subsubsection{\texorpdfstring{dtls\+Tick()}{dtlsTick()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dtls\+Tick (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Manage retransmission timer. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1237 of file dtls\+\_\+record.\+c.


\begin{DoxyCode}
1238 \{
1239    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1240    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
1241 
1242    \textcolor{comment}{//Initialize status code}
1243    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1244 
1245    \textcolor{comment}{//Check current state}
1246    \textcolor{keywordflow}{if}(context->state != \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da7ff3a76e0b1787b6d0026e533a89649b}{TLS\_STATE\_APPLICATION\_DATA})
1247    \{
1248       \textcolor{comment}{//Any flight of messages buffered?}
1249       \textcolor{keywordflow}{if}(context->txBufferLen > 0)
1250       \{
1251          \textcolor{comment}{//Get current time}
1252          time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
1253 
1254          \textcolor{comment}{//Check whether the retransmission timer has expired}
1255          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, context->retransmitTimestamp +
1256             context->retransmitTimeout) >= 0)
1257          \{
1258             \textcolor{comment}{//Check retransmission counter}
1259             \textcolor{keywordflow}{if}(context->retransmitCount < \hyperlink{dtls__misc_8h_a62c2f23476bdda7921ac1043051c9e49}{DTLS\_MAX\_RETRIES})
1260             \{
1261                \textcolor{comment}{//The implementation transitions to the SENDING state, where}
1262                \textcolor{comment}{//it retransmits the flight, resets the retransmit timer, and}
1263                \textcolor{comment}{//returns to the WAITING state}
1264                error = \hyperlink{dtls__record_8c_ad01829993964da0b26d9d207988b0adb}{dtlsSendFlight}(context);
1265 
1266                \textcolor{comment}{//Double the value at each retransmission, up to no less than}
1267                \textcolor{comment}{//the RFC 6298 maximum of 60 seconds}
1268                context->retransmitTimeout = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(context->retransmitTimeout * 2,
1269                   \hyperlink{dtls__misc_8h_a773a4a36207efb2100f7779c529d1bd7}{DTLS\_MAX\_TIMEOUT});
1270             \}
1271             \textcolor{keywordflow}{else}
1272             \{
1273                \textcolor{comment}{//The maximum number of retransmissions has been exceeded}
1274                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT};
1275             \}
1276          \}
1277       \}
1278    \}
1279 
1280    \textcolor{comment}{//Return status code}
1281    \textcolor{keywordflow}{return} error;
1282 \}
\end{DoxyCode}
\mbox{\Hypertarget{dtls__record_8c_ab15a3a01b2765ebf23f0fc72f1405f92}\label{dtls__record_8c_ab15a3a01b2765ebf23f0fc72f1405f92}} 
\index{dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}!dtls\+Write\+Protocol\+Data@{dtls\+Write\+Protocol\+Data}}
\index{dtls\+Write\+Protocol\+Data@{dtls\+Write\+Protocol\+Data}!dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}}
\subsubsection{\texorpdfstring{dtls\+Write\+Protocol\+Data()}{dtlsWriteProtocolData()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dtls\+Write\+Protocol\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{length,  }\item[{\hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type}}]{content\+Type }\end{DoxyParamCaption})}



Write protocol data. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to the data buffer \\
\hline
\mbox{\tt in}  & {\em length} & Number of data bytes to be written \\
\hline
\mbox{\tt in}  & {\em content\+Type} & Higher level protocol \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 60 of file dtls\+\_\+record.\+c.


\begin{DoxyCode}
62 \{
63    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
64 
65    \textcolor{comment}{//Prepare DTLS record}
66    error = \hyperlink{dtls__record_8c_ac8b6ad3223382da3ea249848b37a982f}{dtlsWriteRecord}(context, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, contentType);
67 
68    \textcolor{comment}{//Check status code}
69    \textcolor{keywordflow}{if}(!error)
70    \{
71       \textcolor{comment}{//DTLS operates as a client or a server?}
72       \textcolor{keywordflow}{if}(context->entity == \hyperlink{tls_8h_acb21bc158664d823d899d760edd8135ba7f216418b2d898ed01cf9376fd9b3d6d}{TLS\_CONNECTION\_END\_CLIENT})
73       \{
74          \textcolor{comment}{//Client messages are grouped into a series of message flights}
75          \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dade201db86ae38480c06696f3a48e0170}{TLS\_STATE\_CLIENT\_HELLO} ||
76             context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da3cb415075672864bb35731a372a18fbd}{TLS\_STATE\_CLIENT\_FINISHED})
77          \{
78             \textcolor{comment}{//Reset retransmission counter}
79             context->retransmitCount = 0;
80             \textcolor{comment}{//Implementations should use an initial timer value of 1 second}
81             context->retransmitTimeout = \hyperlink{dtls__misc_8h_aca31dd4b36761154d2d5a39afe0c1b91}{DTLS\_INIT\_TIMEOUT};
82 
83             \textcolor{comment}{//Transmit the buffered flight of messages}
84             error = \hyperlink{dtls__record_8c_ad01829993964da0b26d9d207988b0adb}{dtlsSendFlight}(context);
85          \}
86       \}
87       \textcolor{keywordflow}{else}
88       \{
89          \textcolor{comment}{//Server messages are grouped into a series of message flights}
90          \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dacfeeaa75eec1aecc4c975236b2af1f9c}{TLS\_STATE\_SERVER\_HELLO\_DONE} ||
91             context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da4638034a43094f0a8409cc8f0163d23b}{TLS\_STATE\_SERVER\_FINISHED})
92          \{
93             \textcolor{comment}{//Reset retransmission counter}
94             context->retransmitCount = 0;
95             \textcolor{comment}{//Implementations should use an initial timer value of 1 second}
96             context->retransmitTimeout = \hyperlink{dtls__misc_8h_aca31dd4b36761154d2d5a39afe0c1b91}{DTLS\_INIT\_TIMEOUT};
97 
98             \textcolor{comment}{//Transmit the buffered flight of messages}
99             error = \hyperlink{dtls__record_8c_ad01829993964da0b26d9d207988b0adb}{dtlsSendFlight}(context);
100          \}
101          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da28df1d3e7276c71ab9e2f8c75cdeef2e}{TLS\_STATE\_HELLO\_VERIFY\_REQUEST} ||
102             context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daa874b96bf23b3215942a719bbad609b5}{TLS\_STATE\_HELLO\_RETRY\_REQUEST})
103          \{
104             \textcolor{comment}{//Reset retransmission counter}
105             context->retransmitCount = 0;
106 
107             \textcolor{comment}{//Transmit the HelloVerifyRequest or HelloRetryRequest message}
108             error = \hyperlink{dtls__record_8c_ad01829993964da0b26d9d207988b0adb}{dtlsSendFlight}(context);
109 
110             \textcolor{comment}{//Timeout and retransmission do not apply to HelloVerifyRequest and}
111             \textcolor{comment}{//HelloRetryRequest messages, because this would require creating}
112             \textcolor{comment}{//state on the server}
113             context->txBufferLen = 0;
114          \}
115       \}
116    \}
117 
118    \textcolor{comment}{//Return status code}
119    \textcolor{keywordflow}{return} error;
120 \}
\end{DoxyCode}
\mbox{\Hypertarget{dtls__record_8c_ac8b6ad3223382da3ea249848b37a982f}\label{dtls__record_8c_ac8b6ad3223382da3ea249848b37a982f}} 
\index{dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}!dtls\+Write\+Record@{dtls\+Write\+Record}}
\index{dtls\+Write\+Record@{dtls\+Write\+Record}!dtls\+\_\+record.\+c@{dtls\+\_\+record.\+c}}
\subsubsection{\texorpdfstring{dtls\+Write\+Record()}{dtlsWriteRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} dtls\+Write\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{length,  }\item[{\hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896c}{Tls\+Content\+Type}}]{content\+Type }\end{DoxyParamCaption})}



Send a D\+T\+LS record. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to the record data \\
\hline
\mbox{\tt in}  & {\em length} & Length of the record data \\
\hline
\mbox{\tt in}  & {\em content\+Type} & Record type \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 229 of file dtls\+\_\+record.\+c.


\begin{DoxyCode}
231 \{
232    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
233    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
234    \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *record;
235    \hyperlink{structTlsEncryptionEngine}{TlsEncryptionEngine} *encryptionEngine;
236 
237    \textcolor{comment}{//Calculate the length of the DTLS record}
238    n = \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord});
239 
240    \textcolor{comment}{//Make sure the buffer is large enough to hold the DTLS record}
241    \textcolor{keywordflow}{if}((context->txBufferLen + n) > context->txBufferSize)
242       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf3f6e48b0cfaea7cac34f4223cd8a57}{ERROR\_BUFFER\_OVERFLOW};
243 
244    \textcolor{comment}{//Point to the encryption engine}
245    encryptionEngine = &context->encryptionEngine;
246 
247    \textcolor{comment}{//Point to the DTLS record header}
248    record = (\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) (context->txBuffer + context->txBufferLen);
249 
250    \textcolor{comment}{//Copy record data}
251    memmove(record->data, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
252 
253    \textcolor{comment}{//Format DTLS record}
254    record->type = contentType;
255    record->version = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{dtls__misc_8c_a309abf8d9966cd0d5a28be1d94859970}{dtlsTranslateVersion}(encryptionEngine->
      \hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version}));
256    record->epoch = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_a7c88a932eb88fccdae6829f18709b1b6}{epoch});
257    record->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
258 
259    \textcolor{comment}{//Check record type}
260    \textcolor{keywordflow}{if}(contentType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca72077515f40a300c29899b5a3ba48682}{TLS\_TYPE\_HANDSHAKE} ||
261       contentType == \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca4a02e9d014afd5e75b90deefd3e5428c}{TLS\_TYPE\_CHANGE\_CIPHER\_SPEC})
262    \{
263       \textcolor{comment}{//Sequence numbers are handled at record layer}
264       memset(&record->seqNum, 0, \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_a900105a81f878731b46d80a2cde979aa}{DtlsSequenceNumber}));
265 
266       \textcolor{comment}{//Adjust the length of the buffered flight of messages}
267       context->txBufferLen += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
268    \}
269    \textcolor{keywordflow}{else}
270    \{
271       \textcolor{comment}{//This record will have a new sequence number}
272       record->seqNum = encryptionEngine->\hyperlink{structTlsEncryptionEngine_a5b11eabf56e10b96ec3c1879a422b1fe}{dtlsSeqNum};
273 
274       \textcolor{comment}{//Take into account the overhead caused by encryption}
275       n += \hyperlink{tls__misc_8c_ab7117ba59f59a625f7509f61e4ce7352}{tlsComputeEncryptionOverhead}(encryptionEngine, n);
276 
277       \textcolor{comment}{//Make sure the buffer is large enough to hold the encrypted record}
278       \textcolor{keywordflow}{if}((context->txBufferLen + n) > context->txBufferSize)
279          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf3f6e48b0cfaea7cac34f4223cd8a57}{ERROR\_BUFFER\_OVERFLOW};
280 
281       \textcolor{comment}{//Protect record payload?}
282       \textcolor{keywordflow}{if}(encryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} != \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af2b260457a3fa53d37ac1701c7b6502e}{CIPHER\_MODE\_NULL} ||
283          encryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
284       \{
285          \textcolor{comment}{//Encrypt DTLS record}
286          error = \hyperlink{tls__record__encryption_8c_a570ea69586ebaeac3279b864b4630a02}{tlsEncryptRecord}(context, encryptionEngine, record);
287          \textcolor{comment}{//Any error to report?}
288          \textcolor{keywordflow}{if}(error)
289             \textcolor{keywordflow}{return} error;
290       \}
291 
292       \textcolor{comment}{//Debug message}
293       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Encrypted DTLS record (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length));
294       \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) + \textcolor{keyword}{sizeof}(
      \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord}));
295 
296       \textcolor{comment}{//Increment sequence number}
297       \hyperlink{dtls__record_8c_adf6fb21ad421813548bc57d792daeb36}{dtlsIncSequenceNumber}(&encryptionEngine->\hyperlink{structTlsEncryptionEngine_a5b11eabf56e10b96ec3c1879a422b1fe}{dtlsSeqNum});
298 
299       \textcolor{comment}{//Length of the resulting datagram, in bytes}
300       n = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(record->length) + \textcolor{keyword}{sizeof}(\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord});
301 
302       \textcolor{comment}{//Debug message}
303       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending UDP datagram (%u bytes)...\(\backslash\)r\(\backslash\)n"}, n);
304 
305       \textcolor{comment}{//Send datagram}
306       error = context->socketSendCallback(context->socketHandle, record, n, &n, 0);
307       \textcolor{comment}{//Any error to report?}
308       \textcolor{keywordflow}{if}(error)
309          \textcolor{keywordflow}{return} error;
310    \}
311 
312    \textcolor{comment}{//Successful processing}
313    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
314 \}
\end{DoxyCode}
