\hypertarget{tls__record__decryption_8h}{}\section{cyclone\+\_\+ssl/tls\+\_\+record\+\_\+decryption.h File Reference}
\label{tls__record__decryption_8h}\index{cyclone\+\_\+ssl/tls\+\_\+record\+\_\+decryption.\+h@{cyclone\+\_\+ssl/tls\+\_\+record\+\_\+decryption.\+h}}


T\+LS record decryption.  


{\ttfamily \#include \char`\"{}tls.\+h\char`\"{}}\newline
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record__decryption_8h_a12df36547985f2fbe84fee13de092476}{tls\+Decrypt\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$decryption\+Engine, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Decrypt an incoming T\+LS record. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record__decryption_8h_a2f1f5f5b5fbec8ac07d5428bc5a52b84}{tls\+Decrypt\+Aead\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$decryption\+Engine, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Record decryption (A\+E\+AD cipher) \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record__decryption_8h_ae89410bffa4430d9cb99a56182dd3e24}{tls\+Decrypt\+Cbc\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$decryption\+Engine, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Record decryption (C\+BC block cipher) \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record__decryption_8h_a677dcd33887a6cee61ca9c8a9b24ea5d}{tls\+Decrypt\+Stream\+Record} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$decryption\+Engine, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Record decryption (stream cipher) \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__record__decryption_8h_a154acc1052f72c2ff40b8e2b236296ce}{tls\+Verify\+Message\+Auth\+Code} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$decryption\+Engine, void $\ast$record)
\begin{DoxyCompactList}\small\item\em Check message authentication code. \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{tls__record__decryption_8h_aa3b821a6e3b8854cbbf32c4ab4c932d7}{tls\+Verify\+Padding} (const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t data\+Len, size\+\_\+t $\ast$padding\+Len)
\begin{DoxyCompactList}\small\item\em C\+BC padding verification (constant time) \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{tls__record__decryption_8h_a9f3cd183b5b8af3dab23fce8f3dc7f34}{tls\+Verify\+Mac} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$decryption\+Engine, const void $\ast$record, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t data\+Len, size\+\_\+t max\+Data\+Len, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$mac)
\begin{DoxyCompactList}\small\item\em M\+AC verification (constant time) \end{DoxyCompactList}\item 
\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} \hyperlink{tls__record__decryption_8h_a42bd3012acd73edd2d8e7910521b03f1}{tls\+Extract\+Mac} (\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$decryption\+Engine, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tftp__common_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, size\+\_\+t data\+Len, size\+\_\+t max\+Data\+Len, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$mac)
\begin{DoxyCompactList}\small\item\em Extract the M\+AC from the T\+LS record (constant time) \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
T\+LS record decryption. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+S\+SL Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Function Documentation}
\mbox{\Hypertarget{tls__record__decryption_8h_a2f1f5f5b5fbec8ac07d5428bc5a52b84}\label{tls__record__decryption_8h_a2f1f5f5b5fbec8ac07d5428bc5a52b84}} 
\index{tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}!tls\+Decrypt\+Aead\+Record@{tls\+Decrypt\+Aead\+Record}}
\index{tls\+Decrypt\+Aead\+Record@{tls\+Decrypt\+Aead\+Record}!tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}}
\subsubsection{\texorpdfstring{tls\+Decrypt\+Aead\+Record()}{tlsDecryptAeadRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Decrypt\+Aead\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{decryption\+Engine,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Record decryption (A\+E\+AD cipher) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em decryption\+Engine} & Pointer to the decryption engine \\
\hline
\mbox{\tt in,out}  & {\em record} & T\+LS record to be decrypted \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 130 of file tls\+\_\+record\+\_\+decryption.\+c.


\begin{DoxyCode}
132 \{
133 \textcolor{preprocessor}{#if (TLS\_CCM\_CIPHER\_SUPPORT == ENABLED || TLS\_CCM\_8\_CIPHER\_SUPPORT == ENABLED || \(\backslash\)}
134 \textcolor{preprocessor}{   TLS\_GCM\_CIPHER\_SUPPORT == ENABLED || TLS\_CHACHA20\_POLY1305\_SUPPORT == ENABLED)}
135    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
136    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
137    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
138    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *ciphertext;
139    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *tag;
140    \textcolor{keywordtype}{size\_t} aadLen;
141    \textcolor{keywordtype}{size\_t} nonceLen;
142    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} aad[13];
143    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} nonce[12];
144 
145    \textcolor{comment}{//Get the length of the TLS record}
146    length = \hyperlink{tls__record_8c_ab259ff6b1964745a6f4646139c69bfec}{tlsGetRecordLength}(context, record);
147    \textcolor{comment}{//Point to the payload}
148    data = \hyperlink{tls__record_8c_a937201285f16b034ffc504f6151b9f37}{tlsGetRecordData}(context, record);
149 
150    \textcolor{comment}{//Debug message}
151    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Record to be decrypted (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
152    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
153 
154    \textcolor{comment}{//Make sure the message length is acceptable}
155    \textcolor{keywordflow}{if}(length < (decryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen} + decryptionEngine->
      \hyperlink{structTlsEncryptionEngine_aef28b3fa8d6ac0147cdc47db9a642fc7}{authTagLen}))\{
156        \hyperlink{debug_8h_aaf9a5c67ad0ffd97cfca6d77c6af536f}{TRACE\_ERROR}(\textcolor{stringliteral}{"MESSAGE LENGTH IS NOT GOOD TLS DECRYPT\(\backslash\)r\(\backslash\)n  We have a length of the IV of:
       %d and a auth of: %d"},decryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen},decryptionEngine->
      \hyperlink{structTlsEncryptionEngine_aef28b3fa8d6ac0147cdc47db9a642fc7}{authTagLen});
157       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5e1d50ad3e2e1310d0414656ca3e7bde}{ERROR\_BAD\_RECORD\_MAC};
158    \}
159    \textcolor{comment}{//Calculate the length of the ciphertext}
160    length -= decryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen} + decryptionEngine->
      \hyperlink{structTlsEncryptionEngine_aef28b3fa8d6ac0147cdc47db9a642fc7}{authTagLen};
161 
162    \textcolor{comment}{//Version of TLS prior to TLS 1.3?}
163    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
164    \{
165       \textcolor{comment}{//Fix the length field of the TLS record}
166       \hyperlink{tls__record_8c_a956295a326cb475d6e9ad935a91690af}{tlsSetRecordLength}(context, record, length);
167    \}
168    \textcolor{keywordflow}{else}
169    \{
170       \textcolor{comment}{//The length must not exceed 2^14 octets + 1 octet for ContentType +}
171       \textcolor{comment}{//the maximum AEAD expansion. An endpoint that receives a record}
172       \textcolor{comment}{//that exceeds this length must terminate the connection with a}
173       \textcolor{comment}{//record\_overflow alert}
174       \textcolor{keywordflow}{if}(length > (\hyperlink{tls_8h_a87485283e0c2c0a9b1b3e5ef9df52975}{TLS\_MAX\_RECORD\_LENGTH} + 1))
175          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cacb4ee8addfac0a3444278066663c368a}{ERROR\_RECORD\_OVERFLOW};
176 
177       \textcolor{comment}{//In TLS 1.3, the outer opaque\_type field of a TLS record is always}
178       \textcolor{comment}{//set to the value 23 (application data)}
179       \textcolor{keywordflow}{if}(\hyperlink{tls__record_8c_a6541692151f64ebb3797032c4390d371}{tlsGetRecordType}(context, record) != 
      \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896caa8233b89b5c8f35ce7fcd1f644cbc0fc}{TLS\_TYPE\_APPLICATION\_DATA})
180          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
181    \}
182 
183    \textcolor{comment}{//Additional data to be authenticated}
184    \hyperlink{tls__record_8c_ada6e5a7f5801af080907024ae7a9eeb4}{tlsFormatAad}(context, decryptionEngine, record, aad, &aadLen);
185 
186    \textcolor{comment}{//Generate the nonce}
187    \hyperlink{tls__record_8c_aa0aafa9e75cfd27fde215575a44899d8}{tlsFormatNonce}(context, decryptionEngine, record, data, nonce,
188       &nonceLen);
189 
190    \textcolor{comment}{//Point to the ciphertext}
191    ciphertext = data + decryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen};
192    \textcolor{comment}{//Point to the authentication tag}
193    tag = ciphertext + \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
194 
195 \textcolor{preprocessor}{#if (TLS\_CCM\_CIPHER\_SUPPORT == ENABLED || TLS\_CCM\_8\_CIPHER\_SUPPORT == ENABLED)}
196    \textcolor{comment}{//CCM AEAD cipher?}
197    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5a42db5b52a68da8ba71735ac7248f7401}{CIPHER\_MODE\_CCM})
198    \{
199       \textcolor{comment}{//Authenticated decryption using CCM}
200       error = \hyperlink{ccm_8c_a1d322c27772da125eb188ffce04fc6ff}{ccmDecrypt}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ba455619112e97e419c3c51de90b0ca}{cipherAlgo},
201          decryptionEngine->\hyperlink{structTlsEncryptionEngine_a6fb752231a2f6d7d6789c35481af0559}{cipherContext}, nonce, nonceLen, aad, aadLen,
202          ciphertext, ciphertext, length, tag, decryptionEngine->\hyperlink{structTlsEncryptionEngine_aef28b3fa8d6ac0147cdc47db9a642fc7}{authTagLen});
203    \}
204    \textcolor{keywordflow}{else}
205 \textcolor{preprocessor}{#endif}
206 \textcolor{preprocessor}{#if (TLS\_GCM\_CIPHER\_SUPPORT == ENABLED)}
207    \textcolor{comment}{//GCM AEAD cipher?}
208    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af09ab2345f2ff996cf47696f7540fe7a}{CIPHER\_MODE\_GCM})
209    \{
210       \textcolor{comment}{//Authenticated decryption using GCM}
211       error = \hyperlink{gcm_8c_aa540a4a01d648db3457f3ab0d5c15601}{gcmDecrypt}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_aef9d3f24e20174d9493d919ec8964b7c}{gcmContext}, nonce, nonceLen,
212          aad, aadLen, ciphertext, ciphertext, length, tag,
213          decryptionEngine->\hyperlink{structTlsEncryptionEngine_aef28b3fa8d6ac0147cdc47db9a642fc7}{authTagLen});
214    \}
215    \textcolor{keywordflow}{else}
216 \textcolor{preprocessor}{#endif}
217 \textcolor{preprocessor}{#if (TLS\_CHACHA20\_POLY1305\_SUPPORT == ENABLED)}
218    \textcolor{comment}{//ChaCha20Poly1305 AEAD cipher?}
219    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5a0a78e04fbee5d777bfd542b085003855}{CIPHER\_MODE\_CHACHA20\_POLY1305})
220    \{
221       \textcolor{comment}{//Authenticated decryption using ChaCha20Poly1305}
222       error = \hyperlink{chacha20__poly1305_8c_a245e54ef105d815882bc64ac713e834f}{chacha20Poly1305Decrypt}(decryptionEngine->
      \hyperlink{structTlsEncryptionEngine_ac52797db6bbb0e89321c969292dfddd6}{encKey},
223          decryptionEngine->\hyperlink{structTlsEncryptionEngine_ad657d271cd7780efcb7d2005737256dd}{encKeyLen}, nonce, 12, aad, aadLen, data,
224          data, length, tag, decryptionEngine->\hyperlink{structTlsEncryptionEngine_aef28b3fa8d6ac0147cdc47db9a642fc7}{authTagLen});
225    \}
226    \textcolor{keywordflow}{else}
227 \textcolor{preprocessor}{#endif}
228    \textcolor{comment}{//Invalid cipher mode?}
229    \{
230       \textcolor{comment}{//The specified cipher mode is not supported}
231       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb876ae52f4c1d437e8688214c55c331}{ERROR\_UNSUPPORTED\_CIPHER\_MODE};
232    \}
233 
234    \textcolor{comment}{//Wrong authentication tag?}
235    \textcolor{keywordflow}{if}(error)\{
236        \hyperlink{debug_8h_aaf9a5c67ad0ffd97cfca6d77c6af536f}{TRACE\_ERROR}(\textcolor{stringliteral}{"WRONG TAG TLS RECORD\(\backslash\)r\(\backslash\)n"});
237       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5e1d50ad3e2e1310d0414656ca3e7bde}{ERROR\_BAD\_RECORD\_MAC};
238    \}
239 
240    \textcolor{comment}{//Discard the explicit part of the nonce}
241    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen} != 0)
242    \{
243       memmove(data, data + decryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen}, length);
244    \}
245 
246    \textcolor{comment}{//TLS 1.3 currently selected?}
247    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} == \hyperlink{tls_8h_ab44dc642afbfbd72926ab1f94634cd4d}{TLS\_VERSION\_1\_3})
248    \{
249       \textcolor{comment}{//Upon successful decryption of an encrypted record, the receiving}
250       \textcolor{comment}{//implementation scans the field from the end toward the beginning}
251       \textcolor{comment}{//until it finds a non-zero octet}
252       \textcolor{keywordflow}{while}(length > 0 && data[length - 1] == 0)
253       \{
254          length--;
255       \}
256 
257       \textcolor{comment}{//If a receiving implementation does not find a non-zero octet}
258       \textcolor{comment}{//in the cleartext, it must terminate the connection with an}
259       \textcolor{comment}{//unexpected\_message alert}
260       \textcolor{keywordflow}{if}(length == 0)
261          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
262 
263       \textcolor{comment}{//Retrieve the length of the plaintext}
264       length--;
265 
266       \textcolor{comment}{//The actual content type of the record is found in the type field}
267       \hyperlink{tls__record_8c_a2ca833f61cd4672cd6dc3cf323e33a06}{tlsSetRecordType}(context, record, data[length]);
268       \textcolor{comment}{//Fix the length field of the TLS record}
269       \hyperlink{tls__record_8c_a956295a326cb475d6e9ad935a91690af}{tlsSetRecordLength}(context, record, length);
270    \}
271 
272    \textcolor{comment}{//Increment sequence number}
273    \hyperlink{tls__record_8c_a7033a23b01aeb6f99b9876392eeb4ca4}{tlsIncSequenceNumber}(&decryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ab9706be268c77258f4c7238721793c}{seqNum});
274 
275    \textcolor{comment}{//Debug message}
276    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Decrypted record (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
277    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
278 
279    \textcolor{comment}{//Successful processing}
280    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
281 \textcolor{preprocessor}{#else}
282    \textcolor{comment}{//AEAD ciphers are not supported}
283    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb876ae52f4c1d437e8688214c55c331}{ERROR\_UNSUPPORTED\_CIPHER\_MODE};
284 \textcolor{preprocessor}{#endif}
285 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record__decryption_8h_ae89410bffa4430d9cb99a56182dd3e24}\label{tls__record__decryption_8h_ae89410bffa4430d9cb99a56182dd3e24}} 
\index{tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}!tls\+Decrypt\+Cbc\+Record@{tls\+Decrypt\+Cbc\+Record}}
\index{tls\+Decrypt\+Cbc\+Record@{tls\+Decrypt\+Cbc\+Record}!tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}}
\subsubsection{\texorpdfstring{tls\+Decrypt\+Cbc\+Record()}{tlsDecryptCbcRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Decrypt\+Cbc\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{decryption\+Engine,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Record decryption (C\+BC block cipher) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em decryption\+Engine} & Pointer to the decryption engine \\
\hline
\mbox{\tt in,out}  & {\em record} & T\+LS record to be decrypted \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 296 of file tls\+\_\+record\+\_\+decryption.\+c.


\begin{DoxyCode}
298 \{
299 \textcolor{preprocessor}{#if (TLS\_CBC\_CIPHER\_SUPPORT == ENABLED)}
300    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
301    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} bad;
302    \textcolor{keywordtype}{size\_t} \hyperlink{ndp_8h_a6b3284d8492267a77ca46948daf5545e}{m};
303    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
304    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
305    \textcolor{keywordtype}{size\_t} paddingLen;
306    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
307    \textcolor{keyword}{const} \hyperlink{structCipherAlgo}{CipherAlgo} *cipherAlgo;
308    \textcolor{keyword}{const} \hyperlink{structHashAlgo}{HashAlgo} *hashAlgo;
309    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} mac[\hyperlink{cyclone__crypto_2core_2crypto_8h_ac6e85336237dcdf8efb9280b84e4ffd6}{MAX\_HASH\_DIGEST\_SIZE}];
310 
311    \textcolor{comment}{//Point to the cipher algorithm}
312    cipherAlgo = decryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ba455619112e97e419c3c51de90b0ca}{cipherAlgo};
313    \textcolor{comment}{//Point to the hash algorithm}
314    hashAlgo = decryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo};
315 
316    \textcolor{comment}{//Get the length of the ciphertext}
317    length = \hyperlink{tls__record_8c_ab259ff6b1964745a6f4646139c69bfec}{tlsGetRecordLength}(context, record);
318    \textcolor{comment}{//Point to the payload}
319    data = \hyperlink{tls__record_8c_a937201285f16b034ffc504f6151b9f37}{tlsGetRecordData}(context, record);
320 
321    \textcolor{comment}{//Debug message}
322    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Record to be decrypted (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
323    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
324 
325    \textcolor{comment}{//Calculate the minimum acceptable length of the ciphertext}
326    n = \hyperlink{os__port_8h_afa99ec4acc4ecb2dc3c2d05da15d0e3f}{MAX}(cipherAlgo->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize}, hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize} + 1);
327 
328    \textcolor{comment}{//TLS 1.1 and 1.2 use an explicit IV}
329    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} >= \hyperlink{tls_8h_a9e359f668824d16983a41f8deb338979}{TLS\_VERSION\_1\_1})
330       n += decryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen};
331 
332    \textcolor{comment}{//Malformed TLS record?}
333    \textcolor{keywordflow}{if}(length < n)\{
334        \hyperlink{debug_8h_aaf9a5c67ad0ffd97cfca6d77c6af536f}{TRACE\_ERROR}(\textcolor{stringliteral}{"WAY TO SHORT RECORD DECRYPT \(\backslash\)r\(\backslash\)n"});
335       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5e1d50ad3e2e1310d0414656ca3e7bde}{ERROR\_BAD\_RECORD\_MAC};
336    \}
337 
338    \textcolor{comment}{//The length of the ciphertext must be a multiple of the block size}
339    \textcolor{keywordflow}{if}((length % cipherAlgo->\hyperlink{structCipherAlgo_a1f318963e641736f3c5836274ef758f1}{blockSize}) != 0)\{
340        \hyperlink{debug_8h_aaf9a5c67ad0ffd97cfca6d77c6af536f}{TRACE\_ERROR}(\textcolor{stringliteral}{"NOT A MULTIPLE RECORD DECRYPT\(\backslash\)r\(\backslash\)n"});
341       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5e1d50ad3e2e1310d0414656ca3e7bde}{ERROR\_BAD\_RECORD\_MAC};
342    \}
343    \textcolor{comment}{//Perform CBC decryption}
344    error = \hyperlink{cbc_8c_a840b0b9b34ed3e5d7a3ccb85487896de}{cbcDecrypt}(cipherAlgo, decryptionEngine->\hyperlink{structTlsEncryptionEngine_a6fb752231a2f6d7d6789c35481af0559}{cipherContext},
345       decryptionEngine->\hyperlink{structTlsEncryptionEngine_af7dda7e3510e4e13458a16c5357143f7}{iv}, data, data, length);
346    \textcolor{comment}{//Any error to report?}
347    \textcolor{keywordflow}{if}(error)
348       \textcolor{keywordflow}{return} error;
349 
350    \textcolor{comment}{//TLS 1.1 and 1.2 use an explicit IV}
351    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} >= \hyperlink{tls_8h_a9e359f668824d16983a41f8deb338979}{TLS\_VERSION\_1\_1})
352    \{
353       \textcolor{comment}{//Adjust the length of the message}
354       length -= decryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen};
355       \textcolor{comment}{//Discard the first cipher block (corresponding to the explicit IV)}
356       memmove(data, data + decryptionEngine->\hyperlink{structTlsEncryptionEngine_a9b9d6c4c5f58c7dd0e040818fe6a2681}{recordIvLen}, length);
357    \}
358 
359    \textcolor{comment}{//Debug message}
360    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Record with padding (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
361    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
362 
363 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= SSL\_VERSION\_3\_0)}
364    \textcolor{comment}{//SSL 3.0 currently selected?}
365    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} == \hyperlink{tls_8h_a8d19a9661e2ca28062ba4a00799e8bdb}{SSL\_VERSION\_3\_0})
366    \{
367       \textcolor{comment}{//The receiver must check the padding}
368       bad = \hyperlink{ssl__misc_8h_a439ad312818062351e318db6217e4bcb}{sslVerifyPadding}(decryptionEngine, data, length, &paddingLen);
369    \}
370    \textcolor{keywordflow}{else}
371 \textcolor{preprocessor}{#endif}
372    \{
373       \textcolor{comment}{//The receiver must check the padding}
374       bad = \hyperlink{tls__record__decryption_8c_aa3b821a6e3b8854cbbf32c4ab4c932d7}{tlsVerifyPadding}(data, length, &paddingLen);
375    \}
376 
377    \textcolor{comment}{//Actual length of the payload}
378    n = length - paddingLen - 1;
379    \textcolor{comment}{//Maximum possible length of the payload}
380    m = length - 1;
381 
382    \textcolor{comment}{//Extract the MAC from the TLS record}
383    bad |= \hyperlink{tls__record__decryption_8c_a42bd3012acd73edd2d8e7910521b03f1}{tlsExtractMac}(decryptionEngine, data, n, m, mac);
384 
385    \textcolor{comment}{//Fix the length of the padding string if the format of the plaintext}
386    \textcolor{comment}{//is not valid}
387    paddingLen = \hyperlink{cyclone__crypto_2core_2crypto_8h_a0c5339f6a93ab2d30e4ac5d222195d47}{CRYPTO\_SELECT\_32}(paddingLen, 0, bad);
388 
389    \textcolor{comment}{//Actual length of the plaintext data}
390    n = length - hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize} - paddingLen - 1;
391    \textcolor{comment}{//Maximum possible length of the plaintext data}
392    m = length - hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize} - 1;
393 
394    \textcolor{comment}{//Fix the length field of the TLS record}
395    \hyperlink{tls__record_8c_a956295a326cb475d6e9ad935a91690af}{tlsSetRecordLength}(context, record, n);
396 
397 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= SSL\_VERSION\_3\_0)}
398    \textcolor{comment}{//SSL 3.0 currently selected?}
399    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} == \hyperlink{tls_8h_a8d19a9661e2ca28062ba4a00799e8bdb}{SSL\_VERSION\_3\_0})
400    \{
401       \textcolor{comment}{//SSL 3.0 uses an older obsolete version of the HMAC construction}
402       bad |= \hyperlink{ssl__misc_8h_a16da63350e2dbc1bc471ac45cfcce6f5}{sslVerifyMac}(decryptionEngine, record, data, n, m, mac);
403    \}
404    \textcolor{keywordflow}{else}
405 \textcolor{preprocessor}{#endif}
406 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
407    \textcolor{comment}{//TLS 1.0, TLS 1.1 or TLS 1.2 currently selected?}
408    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} >= \hyperlink{tls_8h_adcc8f4321c8f3b847fbea16ca0ff337e}{TLS\_VERSION\_1\_0})
409    \{
410       \textcolor{comment}{//TLS uses a HMAC construction}
411       bad |= \hyperlink{tls__record__decryption_8c_a9f3cd183b5b8af3dab23fce8f3dc7f34}{tlsVerifyMac}(context, decryptionEngine, record, data, n, m, mac);
412    \}
413    \textcolor{keywordflow}{else}
414 \textcolor{preprocessor}{#endif}
415    \textcolor{comment}{//Invalid TLS version?}
416    \{
417       \textcolor{comment}{//Just for sanity}
418       bad = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
419    \}
420 
421    \textcolor{comment}{//Increment sequence number}
422    \hyperlink{tls__record_8c_a7033a23b01aeb6f99b9876392eeb4ca4}{tlsIncSequenceNumber}(&decryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ab9706be268c77258f4c7238721793c}{seqNum});
423 
424    \textcolor{comment}{//Return status code}
425    \textcolor{keywordflow}{if}(bad)\{
426        \hyperlink{debug_8h_aaf9a5c67ad0ffd97cfca6d77c6af536f}{TRACE\_ERROR}(\textcolor{stringliteral}{"BAD CBC TLS RECORD\(\backslash\)r\(\backslash\)n"});
427       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5e1d50ad3e2e1310d0414656ca3e7bde}{ERROR\_BAD\_RECORD\_MAC};
428    \}
429    \textcolor{keywordflow}{else}
430       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
431 \textcolor{preprocessor}{#else}
432    \textcolor{comment}{//CBC cipher mode is not supported}
433    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb876ae52f4c1d437e8688214c55c331}{ERROR\_UNSUPPORTED\_CIPHER\_MODE};
434 \textcolor{preprocessor}{#endif}
435 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record__decryption_8h_a12df36547985f2fbe84fee13de092476}\label{tls__record__decryption_8h_a12df36547985f2fbe84fee13de092476}} 
\index{tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}!tls\+Decrypt\+Record@{tls\+Decrypt\+Record}}
\index{tls\+Decrypt\+Record@{tls\+Decrypt\+Record}!tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}}
\subsubsection{\texorpdfstring{tls\+Decrypt\+Record()}{tlsDecryptRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Decrypt\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{decryption\+Engine,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Decrypt an incoming T\+LS record. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em decryption\+Engine} & Pointer to the decryption engine \\
\hline
\mbox{\tt in,out}  & {\em record} & T\+LS record to be decrypted \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 60 of file tls\+\_\+record\+\_\+decryption.\+c.


\begin{DoxyCode}
62 \{
63    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
64 
65 \textcolor{preprocessor}{#if (TLS\_CCM\_CIPHER\_SUPPORT == ENABLED || TLS\_CCM\_8\_CIPHER\_SUPPORT == ENABLED || \(\backslash\)}
66 \textcolor{preprocessor}{   TLS\_GCM\_CIPHER\_SUPPORT == ENABLED || TLS\_CHACHA20\_POLY1305\_SUPPORT == ENABLED)}
67    \textcolor{comment}{//AEAD cipher?}
68    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5a42db5b52a68da8ba71735ac7248f7401}{CIPHER\_MODE\_CCM} ||
69       decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af09ab2345f2ff996cf47696f7540fe7a}{CIPHER\_MODE\_GCM} ||
70       decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5a0a78e04fbee5d777bfd542b085003855}{CIPHER\_MODE\_CHACHA20\_POLY1305})
71    \{
72       \textcolor{comment}{//Perform authenticated decryption}
73       error = \hyperlink{tls__record__decryption_8c_a2f1f5f5b5fbec8ac07d5428bc5a52b84}{tlsDecryptAeadRecord}(context, decryptionEngine, record);
74    \}
75    \textcolor{keywordflow}{else}
76 \textcolor{preprocessor}{#endif}
77 \textcolor{preprocessor}{#if (TLS\_CBC\_CIPHER\_SUPPORT == ENABLED)}
78    \textcolor{comment}{//CBC block cipher?}
79    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5a7c82e8aeb1e9badb0c083823b5b14eaa}{CIPHER\_MODE\_CBC})
80    \{
81       \textcolor{comment}{//Decrypt record and check message authentication code (constant time)}
82       error = \hyperlink{tls__record__decryption_8c_ae89410bffa4430d9cb99a56182dd3e24}{tlsDecryptCbcRecord}(context, decryptionEngine, record);
83    \}
84    \textcolor{keywordflow}{else}
85 \textcolor{preprocessor}{#endif}
86 \textcolor{preprocessor}{#if (TLS\_STREAM\_CIPHER\_SUPPORT == ENABLED)}
87    \textcolor{comment}{//Stream cipher?}
88    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5a97fe9f5ed79394865625397eb96140ee}{CIPHER\_MODE\_STREAM})
89    \{
90       \textcolor{comment}{//Decrypt the contents of the record}
91       error = \hyperlink{tls__record__decryption_8c_a677dcd33887a6cee61ca9c8a9b24ea5d}{tlsDecryptStreamRecord}(context, decryptionEngine, record);
92 
93       \textcolor{comment}{//Check status code}
94       \textcolor{keywordflow}{if}(!error)
95       \{
96          \textcolor{comment}{//Verify message authentication code}
97          error = \hyperlink{tls__record__decryption_8c_a154acc1052f72c2ff40b8e2b236296ce}{tlsVerifyMessageAuthCode}(context, decryptionEngine, record);
98       \}
99    \}
100    \textcolor{keywordflow}{else}
101 \textcolor{preprocessor}{#endif}
102 \textcolor{preprocessor}{#if (TLS\_NULL\_CIPHER\_SUPPORT == ENABLED)}
103    \textcolor{comment}{//NULL cipher?}
104    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_ac7326a9b894b4447ed52df0baa65b294}{cipherMode} == \hyperlink{cyclone__crypto_2core_2crypto_8h_ac3adaabf9bad553901589ddf3de6daf5af2b260457a3fa53d37ac1701c7b6502e}{CIPHER\_MODE\_NULL})
105    \{
106       \textcolor{comment}{//Verify message authentication code}
107       error = \hyperlink{tls__record__decryption_8c_a154acc1052f72c2ff40b8e2b236296ce}{tlsVerifyMessageAuthCode}(context, decryptionEngine, record);
108    \}
109    \textcolor{keywordflow}{else}
110 \textcolor{preprocessor}{#endif}
111    \textcolor{comment}{//Invalid cipher mode?}
112    \{
113       \textcolor{comment}{//The specified cipher mode is not supported}
114       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb876ae52f4c1d437e8688214c55c331}{ERROR\_UNSUPPORTED\_CIPHER\_MODE};
115    \}
116 
117    \textcolor{comment}{//Return status code}
118    \textcolor{keywordflow}{return} error;
119 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record__decryption_8h_a677dcd33887a6cee61ca9c8a9b24ea5d}\label{tls__record__decryption_8h_a677dcd33887a6cee61ca9c8a9b24ea5d}} 
\index{tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}!tls\+Decrypt\+Stream\+Record@{tls\+Decrypt\+Stream\+Record}}
\index{tls\+Decrypt\+Stream\+Record@{tls\+Decrypt\+Stream\+Record}!tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}}
\subsubsection{\texorpdfstring{tls\+Decrypt\+Stream\+Record()}{tlsDecryptStreamRecord()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Decrypt\+Stream\+Record (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{decryption\+Engine,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Record decryption (stream cipher) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em decryption\+Engine} & Pointer to the decryption engine \\
\hline
\mbox{\tt in,out}  & {\em record} & T\+LS record to be decrypted \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 446 of file tls\+\_\+record\+\_\+decryption.\+c.


\begin{DoxyCode}
448 \{
449 \textcolor{preprocessor}{#if (TLS\_STREAM\_CIPHER\_SUPPORT == ENABLED)}
450    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
451    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
452 
453    \textcolor{comment}{//Get the length of the TLS record}
454    length = \hyperlink{tls__record_8c_ab259ff6b1964745a6f4646139c69bfec}{tlsGetRecordLength}(context, record);
455    \textcolor{comment}{//Point to the payload}
456    data = \hyperlink{tls__record_8c_a937201285f16b034ffc504f6151b9f37}{tlsGetRecordData}(context, record);
457 
458    \textcolor{comment}{//Debug message}
459    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Record to be decrypted (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
460    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
461 
462    \textcolor{comment}{//Decrypt record contents}
463    decryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ba455619112e97e419c3c51de90b0ca}{cipherAlgo}->\hyperlink{structCipherAlgo_a20a406bd117ecab1e3b5a9d23f5deee2}{decryptStream}(decryptionEngine->
      \hyperlink{structTlsEncryptionEngine_a6fb752231a2f6d7d6789c35481af0559}{cipherContext},
464       data, data, length);
465 
466    \textcolor{comment}{//Debug message}
467    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Decrypted record (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
468    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
469 
470    \textcolor{comment}{//Successful processing}
471    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
472 \textcolor{preprocessor}{#else}
473    \textcolor{comment}{//Stream ciphers are not supported}
474    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb876ae52f4c1d437e8688214c55c331}{ERROR\_UNSUPPORTED\_CIPHER\_MODE};
475 \textcolor{preprocessor}{#endif}
476 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record__decryption_8h_a42bd3012acd73edd2d8e7910521b03f1}\label{tls__record__decryption_8h_a42bd3012acd73edd2d8e7910521b03f1}} 
\index{tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}!tls\+Extract\+Mac@{tls\+Extract\+Mac}}
\index{tls\+Extract\+Mac@{tls\+Extract\+Mac}!tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}}
\subsubsection{\texorpdfstring{tls\+Extract\+Mac()}{tlsExtractMac()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} tls\+Extract\+Mac (\begin{DoxyParamCaption}\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{decryption\+Engine,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{data\+Len,  }\item[{size\+\_\+t}]{max\+Data\+Len,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{mac }\end{DoxyParamCaption})}



Extract the M\+AC from the T\+LS record (constant time) 

Extract the M\+AC from the record in constant time without leaking information about what the make-\/up of the plaintext blocks is in terms of message, M\+AC field and padding, and whether the format is valid (Emilia Kasper and Bodo Moller\textquotesingle{}s method)


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em decryption\+Engine} & Pointer to the decryption engine \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to the record payload \\
\hline
\mbox{\tt in}  & {\em data\+Len} & Actual length of the payload (secret information) \\
\hline
\mbox{\tt in}  & {\em max\+Data\+Len} & Maximum possible length of the payload \\
\hline
\mbox{\tt out}  & {\em mac} & Message authentication code \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The function returns 0 if the M\+AC has been successfully extracted, else 1 
\end{DoxyReturn}


Definition at line 829 of file tls\+\_\+record\+\_\+decryption.\+c.


\begin{DoxyCode}
831 \{
832    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} bad;
833    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} \hyperlink{aria_8c_a5dadc28804036d1b82e1dc027e95c9a6}{c};
834    \textcolor{keywordtype}{size\_t} i;
835    \textcolor{keywordtype}{size\_t} j;
836    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
837    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
838    \textcolor{keywordtype}{size\_t} macSize;
839    \textcolor{keywordtype}{size\_t} minDataLen;
840    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} temp[\hyperlink{cyclone__crypto_2core_2crypto_8h_ac6e85336237dcdf8efb9280b84e4ffd6}{MAX\_HASH\_DIGEST\_SIZE}];
841 
842    \textcolor{comment}{//Retrieve the length of the message authentication code}
843    macSize = decryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo}->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize};
844 
845    \textcolor{comment}{//Calculate the minimum possible length of the plaintext data}
846    \textcolor{keywordflow}{if}(maxDataLen > (macSize + 255))
847       minDataLen = maxDataLen - macSize - 255;
848    \textcolor{keywordflow}{else}
849       minDataLen = 0;
850 
851    \textcolor{comment}{//Check whether the length of the payload is correct}
852    bad = \hyperlink{cyclone__crypto_2core_2crypto_8h_a61a9ec36a7ba935b9aa5bd44fbd386a3}{CRYPTO\_TEST\_LT\_32}(dataLen, macSize);
853    \textcolor{comment}{//Retrieve the length of the plaintext data}
854    dataLen = \hyperlink{cyclone__crypto_2core_2crypto_8h_a0c5339f6a93ab2d30e4ac5d222195d47}{CRYPTO\_SELECT\_32}(dataLen - macSize, 0, bad);
855 
856    \textcolor{comment}{//Clear MAC value}
857    memset(mac, 0, macSize);
858    offset = 0;
859 
860    \textcolor{comment}{//Read every location where the MAC might be found}
861    \textcolor{keywordflow}{for}(i = minDataLen, j = 0; i < maxDataLen; i++)
862    \{
863       \textcolor{comment}{//Save the start offset of the MAC in the output buffer}
864       c = \hyperlink{cyclone__crypto_2core_2crypto_8h_a0714729000f7a99b1c125e96d084161f}{CRYPTO\_TEST\_EQ\_32}(i, dataLen);
865       offset = \hyperlink{cyclone__crypto_2core_2crypto_8h_a0c5339f6a93ab2d30e4ac5d222195d47}{CRYPTO\_SELECT\_32}(offset, j, c);
866 
867       \textcolor{comment}{//The MAC may be byte-wise rotated by this copy}
868       c = \hyperlink{cyclone__crypto_2core_2crypto_8h_ab8f195d2cc8e339e69126c8cd0262cac}{CRYPTO\_TEST\_GTE\_32}(i, dataLen);
869       c &= \hyperlink{cyclone__crypto_2core_2crypto_8h_a61a9ec36a7ba935b9aa5bd44fbd386a3}{CRYPTO\_TEST\_LT\_32}(i, dataLen + macSize);
870       mac[j] = \hyperlink{cyclone__crypto_2core_2crypto_8h_aa9f5e6d0d42a84bae01ec5e4e6f5c45b}{CRYPTO\_SELECT\_8}(mac[j], \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i], c);
871 
872       \textcolor{comment}{//Increment index and wrap around if necessary}
873       \textcolor{keywordflow}{if}(++j >= macSize)
874          j = 0;
875    \}
876 
877    \textcolor{comment}{//Debug message}
878    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"MAC before rotation (offset = %"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{"):\(\backslash\)r\(\backslash\)n"}, offset);
879    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, mac, macSize);
880 
881    \textcolor{comment}{//Rotate the MAC in constant-time (since the start offset is also secret)}
882    \textcolor{keywordflow}{for}(n = 1; n < macSize; n <<= 1)
883    \{
884       \textcolor{comment}{//Check whether the current step should be performed}
885       c = \hyperlink{cyclone__crypto_2core_2crypto_8h_a8929cd320cf311a479ec9f94a764ac92}{CRYPTO\_TEST\_NEQ\_32}(offset & n, 0);
886 
887       \textcolor{comment}{//Rotate the MAC value by n bytes to the left}
888       \textcolor{keywordflow}{for}(i = 0, j = n; i < macSize; i++)
889       \{
890          \textcolor{comment}{//Process current byte}
891          temp[i] = \hyperlink{cyclone__crypto_2core_2crypto_8h_aa9f5e6d0d42a84bae01ec5e4e6f5c45b}{CRYPTO\_SELECT\_8}(mac[i], mac[j], c);
892 
893          \textcolor{comment}{//Increment index and wrap around if necessary}
894          \textcolor{keywordflow}{if}(++j >= macSize)
895             j = 0;
896       \}
897 
898       \textcolor{comment}{//Copy the value of the rotated MAC}
899       memcpy(mac, temp, macSize);
900    \}
901 
902    \textcolor{comment}{//Debug message}
903    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"MAC after rotation:\(\backslash\)r\(\backslash\)n"});
904    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, mac, macSize);
905 
906    \textcolor{comment}{//Return 0 if the MAC has been successfully extracted, else 1}
907    \textcolor{keywordflow}{return} bad;
908 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record__decryption_8h_a9f3cd183b5b8af3dab23fce8f3dc7f34}\label{tls__record__decryption_8h_a9f3cd183b5b8af3dab23fce8f3dc7f34}} 
\index{tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}!tls\+Verify\+Mac@{tls\+Verify\+Mac}}
\index{tls\+Verify\+Mac@{tls\+Verify\+Mac}!tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}}
\subsubsection{\texorpdfstring{tls\+Verify\+Mac()}{tlsVerifyMac()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} tls\+Verify\+Mac (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{decryption\+Engine,  }\item[{const void $\ast$}]{record,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{data\+Len,  }\item[{size\+\_\+t}]{max\+Data\+Len,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{mac }\end{DoxyParamCaption})}



M\+AC verification (constant time) 

Calculate and verify the M\+AC in constant time without leaking information about what the make-\/up of the plaintext blocks is in terms of message, M\+AC field and padding, and whether the format is valid (Adam Langley\textquotesingle{}s method)


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em decryption\+Engine} & Pointer to the decryption engine \\
\hline
\mbox{\tt in}  & {\em record} & Pointer to the T\+LS record \\
\hline
\mbox{\tt in}  & {\em data} & Pointer to the record payload \\
\hline
\mbox{\tt in}  & {\em data\+Len} & Actual length of the plaintext data (secret information) \\
\hline
\mbox{\tt in}  & {\em max\+Data\+Len} & Maximum possible length of the plaintext data \\
\hline
\mbox{\tt in}  & {\em mac} & Message authentication code \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The function returns 0 if the M\+AC verification is successful, else 1 
\end{DoxyReturn}


Definition at line 640 of file tls\+\_\+record\+\_\+decryption.\+c.


\begin{DoxyCode}
643 \{
644    \textcolor{keywordtype}{size\_t} i;
645    \textcolor{keywordtype}{size\_t} j;
646    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
647    \textcolor{keywordtype}{size\_t} headerLen;
648    \textcolor{keywordtype}{size\_t} paddingLen;
649    \textcolor{keywordtype}{size\_t} blockSizeMask;
650    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{dtls__misc_8h_ab590318ac859d0e57e15c3dd6c62a605}{b};
651    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} \hyperlink{aria_8c_a5dadc28804036d1b82e1dc027e95c9a6}{c};
652    \hyperlink{stdint_8h_aec6fcb673ff035718c238c8c9d544c47}{uint64\_t} bitLen;
653    \textcolor{keyword}{const} \hyperlink{structHashAlgo}{HashAlgo} *hashAlgo;
654    \hyperlink{structHmacContext}{HmacContext} *hmacContext;
655    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} temp[\hyperlink{cyclone__crypto_2core_2crypto_8h_ac6e85336237dcdf8efb9280b84e4ffd6}{MAX\_HASH\_DIGEST\_SIZE}];
656 
657    \textcolor{comment}{//Point to the hash algorithm to be used}
658    hashAlgo = decryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo};
659    \textcolor{comment}{//Point to the HMAC context}
660    hmacContext = decryptionEngine->\hyperlink{structTlsEncryptionEngine_a6e659b6a95474feec4ee46f40c7b92e4}{hmacContext};
661 
662    \textcolor{comment}{//The size of the block depends on the hash algorithm}
663    blockSizeMask = hashAlgo->\hyperlink{structHashAlgo_a4157d353a7950634666f9abdc2e35a66}{blockSize} - 1;
664 
665    \textcolor{comment}{//Calculate the length of the additional data that will be hashed in}
666    \textcolor{comment}{//prior to the application data}
667    headerLen = hashAlgo->\hyperlink{structHashAlgo_a4157d353a7950634666f9abdc2e35a66}{blockSize} + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_aadbcbb634b990da0c6d0d07fe08e9f89}{TlsSequenceNumber}) +
668       \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord});
669 
670    \textcolor{comment}{//Calculate the length of the padding string}
671    paddingLen = (headerLen + dataLen + hashAlgo->\hyperlink{structHashAlgo_ac9d6aa5a36049d667037f67b2fdb4c15}{minPadSize} - 1) & blockSizeMask;
672    paddingLen = hashAlgo->\hyperlink{structHashAlgo_a4157d353a7950634666f9abdc2e35a66}{blockSize} - paddingLen;
673 
674    \textcolor{comment}{//Check whether the length field is larger than 64 bits}
675    \textcolor{keywordflow}{if}(hashAlgo->\hyperlink{structHashAlgo_ac9d6aa5a36049d667037f67b2fdb4c15}{minPadSize} > 9)
676    \{
677       \textcolor{comment}{//The most significant bytes will be padded with zeroes}
678       paddingLen += hashAlgo->\hyperlink{structHashAlgo_ac9d6aa5a36049d667037f67b2fdb4c15}{minPadSize} - 9;
679    \}
680 
681    \textcolor{comment}{//Length of the message, in bits}
682    bitLen = (headerLen + dataLen) << 3;
683 
684    \textcolor{comment}{//Check endianness}
685    \textcolor{keywordflow}{if}(hashAlgo->\hyperlink{structHashAlgo_ad3de1766a80c361da014a824c9b06d14}{bigEndian})
686    \{
687       \textcolor{comment}{//Encode the length field as a big-endian integer}
688       bitLen = \hyperlink{cpu__endian_8c_a85e0a090b6d6a94330e8bd1fcbe42983}{swapInt64}(bitLen);
689    \}
690 
691    \textcolor{comment}{//Total number of bytes to process}
692    n = headerLen + maxDataLen + hashAlgo->\hyperlink{structHashAlgo_ac9d6aa5a36049d667037f67b2fdb4c15}{minPadSize};
693    n = (n + hashAlgo->\hyperlink{structHashAlgo_a4157d353a7950634666f9abdc2e35a66}{blockSize} - 1) & ~blockSizeMask;
694    n -= headerLen;
695 
696    \textcolor{comment}{//Initialize HMAC calculation}
697    \hyperlink{hmac_8c_ac4ecc520cae02c1b9bbb3651758a703e}{hmacInit}(hmacContext, hashAlgo, decryptionEngine->\hyperlink{structTlsEncryptionEngine_addc5682b60f0e934f1b838909b8aea7c}{macKey},
698       decryptionEngine->\hyperlink{structTlsEncryptionEngine_a26e44e1dbfb86e7a0f118dc4d859d7ab}{macKeyLen});
699 
700 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
701    \textcolor{comment}{//DTLS protocol?}
702    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
703    \{
704       \textcolor{keyword}{const} \hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *dtlsRecord;
705 
706       \textcolor{comment}{//Point to the DTLS record}
707       dtlsRecord = (\hyperlink{dtls__misc_8h_aa040fe65c76996b53784c307b96cf95e}{DtlsRecord} *) record;
708 
709       \textcolor{comment}{//Compute the MAC over the 64-bit value formed by concatenating the}
710       \textcolor{comment}{//epoch and the sequence number in the order they appear on the wire}
711       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, (\textcolor{keywordtype}{void} *) &dtlsRecord->epoch, 2);
712       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, &dtlsRecord->seqNum, 6);
713 
714       \textcolor{comment}{//Compute MAC over the record contents}
715       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, &dtlsRecord->type, 3);
716       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, (\textcolor{keywordtype}{void} *) &dtlsRecord->length, 2);
717    \}
718    \textcolor{keywordflow}{else}
719 \textcolor{preprocessor}{#endif}
720    \textcolor{comment}{//TLS protocol?}
721    \{
722       \textcolor{keyword}{const} \hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *tlsRecord;
723 
724       \textcolor{comment}{//Point to the TLS record}
725       tlsRecord = (\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord} *) record;
726 
727       \textcolor{comment}{//Compute MAC over the implicit sequence number}
728       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, &decryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ab9706be268c77258f4c7238721793c}{seqNum},
729          \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_aadbcbb634b990da0c6d0d07fe08e9f89}{TlsSequenceNumber}));
730 
731       \textcolor{comment}{//Compute MAC over the record contents}
732       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, tlsRecord, \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
733    \}
734 
735    \textcolor{comment}{//Point to the first byte of the plaintext data}
736    i = 0;
737 
738    \textcolor{comment}{//We can process the first blocks normally because the (secret) padding}
739    \textcolor{comment}{//length cannot affect them}
740    \textcolor{keywordflow}{if}(maxDataLen > 255)
741    \{
742       \textcolor{comment}{//Digest the first part of the plaintext data}
743       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}, maxDataLen - 255);
744       i += maxDataLen - 255;
745    \}
746 
747    \textcolor{comment}{//The last blocks need to be handled carefully}
748    \textcolor{keywordflow}{while}(i < n)
749    \{
750       \textcolor{comment}{//Initialize the value of the current byte}
751       b = 0;
752 
753       \textcolor{comment}{//Generate the contents of each block in constant time}
754       c = \hyperlink{cyclone__crypto_2core_2crypto_8h_a61a9ec36a7ba935b9aa5bd44fbd386a3}{CRYPTO\_TEST\_LT\_32}(i, dataLen);
755       b = \hyperlink{cyclone__crypto_2core_2crypto_8h_aa9f5e6d0d42a84bae01ec5e4e6f5c45b}{CRYPTO\_SELECT\_8}(b, \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[i], c);
756 
757       c = \hyperlink{cyclone__crypto_2core_2crypto_8h_a0714729000f7a99b1c125e96d084161f}{CRYPTO\_TEST\_EQ\_32}(i, dataLen);
758       b = \hyperlink{cyclone__crypto_2core_2crypto_8h_aa9f5e6d0d42a84bae01ec5e4e6f5c45b}{CRYPTO\_SELECT\_8}(b, 0x80, c);
759 
760       j = dataLen + paddingLen;
761       c = \hyperlink{cyclone__crypto_2core_2crypto_8h_ab8f195d2cc8e339e69126c8cd0262cac}{CRYPTO\_TEST\_GTE\_32}(i, j);
762       j += 8;
763       c &= \hyperlink{cyclone__crypto_2core_2crypto_8h_a61a9ec36a7ba935b9aa5bd44fbd386a3}{CRYPTO\_TEST\_LT\_32}(i, j);
764       b = \hyperlink{cyclone__crypto_2core_2crypto_8h_aa9f5e6d0d42a84bae01ec5e4e6f5c45b}{CRYPTO\_SELECT\_8}(b, bitLen & 0xFF, c);
765       bitLen = \hyperlink{cyclone__crypto_2core_2crypto_8h_a5d38a41809cfca5c423d31c827c3a0dd}{CRYPTO\_SELECT\_64}(bitLen, bitLen >> 8, c);
766 
767       \textcolor{comment}{//Digest the current byte}
768       hashAlgo->\hyperlink{structHashAlgo_a83df6297595f1b9de65143df15fafda4}{update}(hmacContext->\hyperlink{structHmacContext_a42051eba96f3c98ad95efba44e54032a}{hashContext}, &b, \textcolor{keyword}{sizeof}(
      \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}));
769 
770       \textcolor{comment}{//Increment byte counter}
771       i++;
772 
773       \textcolor{comment}{//End of block detected?}
774       \textcolor{keywordflow}{if}(((i + headerLen) & blockSizeMask) == 0)
775       \{
776          \textcolor{comment}{//For each block we serialize the hash}
777          hashAlgo->\hyperlink{structHashAlgo_a6f92d7332b3309e74c45ac10080ed2ed}{finalRaw}(hmacContext->\hyperlink{structHmacContext_a42051eba96f3c98ad95efba44e54032a}{hashContext}, temp);
778 
779          \textcolor{comment}{//Check whether the current block of data is the final block}
780          c = \hyperlink{cyclone__crypto_2core_2crypto_8h_a0714729000f7a99b1c125e96d084161f}{CRYPTO\_TEST\_EQ\_32}(i, dataLen + paddingLen + 8);
781 
782          \textcolor{comment}{//The hash is copied with a mask so that only the correct hash value}
783          \textcolor{comment}{//is copied out, but the amount of computation remains constant}
784          \textcolor{keywordflow}{for}(j = 0; j < hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize}; j++)
785          \{
786             hmacContext->\hyperlink{structHmacContext_a8d7c8cb8814b1cfe2dee045d26077c72}{digest}[j] = \hyperlink{cyclone__crypto_2core_2crypto_8h_aa9f5e6d0d42a84bae01ec5e4e6f5c45b}{CRYPTO\_SELECT\_8}(hmacContext->
      \hyperlink{structHmacContext_a8d7c8cb8814b1cfe2dee045d26077c72}{digest}[j],
787                temp[j], c);
788          \}
789       \}
790    \}
791 
792    \textcolor{comment}{//Finalize HMAC computation}
793    \hyperlink{hmac_8c_a200fd8b24ad013703b914c1ac08e543e}{hmacFinalRaw}(hmacContext, temp);
794 
795    \textcolor{comment}{//Debug message}
796    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Read sequence number:\(\backslash\)r\(\backslash\)n"});
797    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, &decryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ab9706be268c77258f4c7238721793c}{seqNum}, \textcolor{keyword}{sizeof}(
      \hyperlink{tls_8h_aadbcbb634b990da0c6d0d07fe08e9f89}{TlsSequenceNumber}));
798    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Computed MAC:\(\backslash\)r\(\backslash\)n"});
799    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, temp, hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize});
800 
801    \textcolor{comment}{//The calculated MAC is bitwise compared to the received message}
802    \textcolor{comment}{//authentication code}
803    \textcolor{keywordflow}{for}(b = 0, i = 0; i < hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize}; i++)
804    \{
805       b |= mac[i] ^ temp[i];
806    \}
807 
808    \textcolor{comment}{//Return 0 if the message authentication code is correct, else 1}
809    \textcolor{keywordflow}{return} \hyperlink{cyclone__crypto_2core_2crypto_8h_a12c7de83247edc168d74071447fd7793}{CRYPTO\_TEST\_NEQ\_8}(b, 0);
810 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record__decryption_8h_a154acc1052f72c2ff40b8e2b236296ce}\label{tls__record__decryption_8h_a154acc1052f72c2ff40b8e2b236296ce}} 
\index{tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}!tls\+Verify\+Message\+Auth\+Code@{tls\+Verify\+Message\+Auth\+Code}}
\index{tls\+Verify\+Message\+Auth\+Code@{tls\+Verify\+Message\+Auth\+Code}!tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}}
\subsubsection{\texorpdfstring{tls\+Verify\+Message\+Auth\+Code()}{tlsVerifyMessageAuthCode()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Verify\+Message\+Auth\+Code (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{structTlsEncryptionEngine}{Tls\+Encryption\+Engine} $\ast$}]{decryption\+Engine,  }\item[{void $\ast$}]{record }\end{DoxyParamCaption})}



Check message authentication code. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em decryption\+Engine} & Pointer to the decryption engine \\
\hline
\mbox{\tt in,out}  & {\em record} & T\+LS record to be authenticated \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 487 of file tls\+\_\+record\+\_\+decryption.\+c.


\begin{DoxyCode}
489 \{
490    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
491    \textcolor{keywordtype}{size\_t} i;
492    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
493    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{web__socket_8h_a8a74907784be6c7786c2d060c8d7e10b}{mask};
494    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data};
495    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *digest;
496    \textcolor{keyword}{const} \hyperlink{structHashAlgo}{HashAlgo} *hashAlgo;
497 
498    \textcolor{comment}{//Point to the hash algorithm}
499    hashAlgo = decryptionEngine->\hyperlink{structTlsEncryptionEngine_a879e3f9933f7d2bf140e1eb8696d4abd}{hashAlgo};
500    \textcolor{comment}{//Point to the buffer where to store the calculated HMAC value}
501    digest = decryptionEngine->\hyperlink{structTlsEncryptionEngine_a6e659b6a95474feec4ee46f40c7b92e4}{hmacContext}->\hyperlink{structHmacContext_a8d7c8cb8814b1cfe2dee045d26077c72}{digest};
502 
503    \textcolor{comment}{//Get the length of the TLS record}
504    length = \hyperlink{tls__record_8c_ab259ff6b1964745a6f4646139c69bfec}{tlsGetRecordLength}(context, record);
505    \textcolor{comment}{//Point to the payload}
506    data = \hyperlink{tls__record_8c_a937201285f16b034ffc504f6151b9f37}{tlsGetRecordData}(context, record);
507 
508    \textcolor{comment}{//Debug message}
509    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Record to be authenticated (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes):\(\backslash\)r\(\backslash\)n"}, length);
510    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, record, length + \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a788513974142abbff8a56fe1cd783afb}{TlsRecord}));
511 
512    \textcolor{comment}{//Make sure the message length is acceptable}
513    \textcolor{keywordflow}{if}(length < hashAlgo->digestSize)\{
514        \hyperlink{debug_8h_aaf9a5c67ad0ffd97cfca6d77c6af536f}{TRACE\_ERROR}(\textcolor{stringliteral}{"BAD LENGTH TLS RECORD\(\backslash\)r\(\backslash\)n"});
515       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5e1d50ad3e2e1310d0414656ca3e7bde}{ERROR\_BAD\_RECORD\_MAC};
516    \}
517 
518    \textcolor{comment}{//Adjust the length of the message}
519    length -= hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize};
520    \textcolor{comment}{//Fix the length field of the TLS record}
521    \hyperlink{tls__record_8c_a956295a326cb475d6e9ad935a91690af}{tlsSetRecordLength}(context, record, length);
522 
523 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= SSL\_VERSION\_3\_0)}
524    \textcolor{comment}{//SSL 3.0 currently selected?}
525    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} == \hyperlink{tls_8h_a8d19a9661e2ca28062ba4a00799e8bdb}{SSL\_VERSION\_3\_0})
526    \{
527       \textcolor{comment}{//SSL 3.0 uses an older obsolete version of the HMAC construction}
528       error = \hyperlink{ssl__misc_8h_aedba18076ae541c67eff5f69f21a14a8}{sslComputeMac}(decryptionEngine, record, data, length, digest);
529    \}
530    \textcolor{keywordflow}{else}
531 \textcolor{preprocessor}{#endif}
532 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
533    \textcolor{comment}{//TLS 1.0, TLS 1.1 or TLS 1.2 currently selected?}
534    \textcolor{keywordflow}{if}(decryptionEngine->\hyperlink{structTlsEncryptionEngine_aa340a0b969c2b0f795556e66a68fae27}{version} >= \hyperlink{tls_8h_adcc8f4321c8f3b847fbea16ca0ff337e}{TLS\_VERSION\_1\_0})
535    \{
536       \textcolor{comment}{//TLS uses a HMAC construction}
537       error = \hyperlink{tls__record__encryption_8c_aa9b63a57f10ba6ac0d1abce783ff1457}{tlsComputeMac}(context, decryptionEngine, record, data, length,
538          digest);
539    \}
540    \textcolor{keywordflow}{else}
541 \textcolor{preprocessor}{#endif}
542    \textcolor{comment}{//Invalid TLS version?}
543    \{
544       \textcolor{comment}{//Report an error}
545       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
546    \}
547 
548    \textcolor{comment}{//Any error to report?}
549    \textcolor{keywordflow}{if}(error)
550       \textcolor{keywordflow}{return} error;
551 
552    \textcolor{comment}{//Debug message}
553    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Read sequence number:\(\backslash\)r\(\backslash\)n"});
554    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, &decryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ab9706be268c77258f4c7238721793c}{seqNum}, \textcolor{keyword}{sizeof}(
      \hyperlink{tls_8h_aadbcbb634b990da0c6d0d07fe08e9f89}{TlsSequenceNumber}));
555    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Computed MAC:\(\backslash\)r\(\backslash\)n"});
556    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"  "}, digest, hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize});
557 
558    \textcolor{comment}{//The calculated MAC is bitwise compared to the received message}
559    \textcolor{comment}{//authentication code}
560    \textcolor{keywordflow}{for}(mask = 0, i = 0; i < hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize}; i++)
561    \{
562       mask |= data[length + i] ^ digest[i];
563    \}
564 
565    \textcolor{comment}{//Increment sequence number}
566    \hyperlink{tls__record_8c_a7033a23b01aeb6f99b9876392eeb4ca4}{tlsIncSequenceNumber}(&decryptionEngine->\hyperlink{structTlsEncryptionEngine_a2ab9706be268c77258f4c7238721793c}{seqNum});
567 
568    \textcolor{comment}{//Invalid message authentication code?}
569    \textcolor{keywordflow}{if}(mask != 0)\{
570       \hyperlink{debug_8h_aaf9a5c67ad0ffd97cfca6d77c6af536f}{TRACE\_ERROR}(\textcolor{stringliteral}{"iNVALID CODE TLS DECRIPTION\(\backslash\)r\(\backslash\)n"});
571       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca5e1d50ad3e2e1310d0414656ca3e7bde}{ERROR\_BAD\_RECORD\_MAC};
572    \}
573    \textcolor{keywordflow}{else}
574       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
575 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__record__decryption_8h_aa3b821a6e3b8854cbbf32c4ab4c932d7}\label{tls__record__decryption_8h_aa3b821a6e3b8854cbbf32c4ab4c932d7}} 
\index{tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}!tls\+Verify\+Padding@{tls\+Verify\+Padding}}
\index{tls\+Verify\+Padding@{tls\+Verify\+Padding}!tls\+\_\+record\+\_\+decryption.\+h@{tls\+\_\+record\+\_\+decryption.\+h}}
\subsubsection{\texorpdfstring{tls\+Verify\+Padding()}{tlsVerifyPadding()}}
{\footnotesize\ttfamily \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\+\_\+t} tls\+Verify\+Padding (\begin{DoxyParamCaption}\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{data,  }\item[{size\+\_\+t}]{data\+Len,  }\item[{size\+\_\+t $\ast$}]{padding\+Len }\end{DoxyParamCaption})}



C\+BC padding verification (constant time) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em data} & Pointer to the record payload \\
\hline
\mbox{\tt in}  & {\em data\+Len} & Length of the payload \\
\hline
\mbox{\tt out}  & {\em padding\+Len} & Length of the padding string \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The function returns 0 if the padding is correct, 1 on failure 
\end{DoxyReturn}


Definition at line 586 of file tls\+\_\+record\+\_\+decryption.\+c.


\begin{DoxyCode}
588 \{
589    \textcolor{keywordtype}{size\_t} i;
590    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
591    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{dtls__misc_8h_ab590318ac859d0e57e15c3dd6c62a605}{b};
592    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{web__socket_8h_a8a74907784be6c7786c2d060c8d7e10b}{mask};
593    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} \hyperlink{aria_8c_a5dadc28804036d1b82e1dc027e95c9a6}{c};
594    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} bad;
595 
596    \textcolor{comment}{//Retrieve the length of the padding string}
597    n = \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[dataLen - 1];
598 
599    \textcolor{comment}{//Make sure the padding length is valid}
600    bad = \hyperlink{cyclone__crypto_2core_2crypto_8h_ab8f195d2cc8e339e69126c8cd0262cac}{CRYPTO\_TEST\_GTE\_32}(n, dataLen);
601 
602    \textcolor{comment}{//Each byte in the padding data must be filled with the padding}
603    \textcolor{comment}{//length value}
604    \textcolor{keywordflow}{for}(i = 1; i < dataLen && i < 256; i++)
605    \{
606       \textcolor{comment}{//Read current byte}
607       b = \hyperlink{dtls__misc_8h_a5c239a1bb87b52b0f1d6d68c4749cd2a}{data}[dataLen - 1 - i];
608 
609       \textcolor{comment}{//Verify that the padding string is correct}
610       c = \hyperlink{cyclone__crypto_2core_2crypto_8h_afe361e0ea839d30521f2682343b12d07}{CRYPTO\_TEST\_LTE\_32}(i, n);
611       mask = \hyperlink{cyclone__crypto_2core_2crypto_8h_aa9f5e6d0d42a84bae01ec5e4e6f5c45b}{CRYPTO\_SELECT\_8}(b, n, c);
612       bad |= \hyperlink{cyclone__crypto_2core_2crypto_8h_a12c7de83247edc168d74071447fd7793}{CRYPTO\_TEST\_NEQ\_8}(b, mask);
613    \}
614 
615    \textcolor{comment}{//Save the length of the padding string}
616    *paddingLen = \hyperlink{cyclone__crypto_2core_2crypto_8h_a0c5339f6a93ab2d30e4ac5d222195d47}{CRYPTO\_SELECT\_32}(n, 0, bad);
617 
618    \textcolor{comment}{//Return status code}
619    \textcolor{keywordflow}{return} bad;
620 \}
\end{DoxyCode}
