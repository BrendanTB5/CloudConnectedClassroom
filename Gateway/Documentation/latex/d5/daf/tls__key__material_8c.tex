\hypertarget{tls__key__material_8c}{}\section{cyclone\+\_\+ssl/tls\+\_\+key\+\_\+material.c File Reference}
\label{tls__key__material_8c}\index{cyclone\+\_\+ssl/tls\+\_\+key\+\_\+material.\+c@{cyclone\+\_\+ssl/tls\+\_\+key\+\_\+material.\+c}}


Key material generation.  


{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include \char`\"{}tls.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+key\+\_\+material.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+transcript\+\_\+hash.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls13\+\_\+key\+\_\+material.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ssl\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{tls__key__material_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{tls__config_8h_afee42a623033dac888291d1993985206}{T\+L\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__key__material_8c_a48b57409ac1d3429ddc2e236ba8beeb3}{tls\+Generate\+Session\+Keys} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Generate session keys. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__key__material_8c_a33afb9fe51464cf27cb9647faca39fad}{tls\+Generate\+Master\+Secret} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Master secret computation. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__key__material_8c_a0131769bf001edccf8207d7045d48ebd}{tls\+Generate\+Extended\+Master\+Secret} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Extended master secret computation. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__key__material_8c_ac5650a18e65eed6e74b8d5ebec573a0d}{tls\+Generate\+Psk\+Premaster\+Secret} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Premaster secret generation (for P\+SK cipher suites) \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__key__material_8c_a497b28753301ebf0ed54d695b0278372}{tls\+Generate\+Key\+Block} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, size\+\_\+t key\+Block\+Len)
\begin{DoxyCompactList}\small\item\em Key expansion function. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__key__material_8c_ac6537a21ad174313fb219f95a1a594ed}{tls\+Export\+Keying\+Material} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$label, \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} use\+Context\+Value, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$context\+Value, size\+\_\+t context\+Value\+Len, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$output, size\+\_\+t output\+Len)
\begin{DoxyCompactList}\small\item\em Export keying material per R\+FC 5705 standard. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__key__material_8c_a8c9381141cf271397b82f7bf53afdcb8}{tls\+Prf} (const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$secret, size\+\_\+t secret\+Len, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$label, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{demo_2microchip_2pic32mz__ef__curiosity_2wifi__http__server__demo_2src_2main_8c_ae5b6f47ec5afdb614046a54e45a39c69}{seed}, size\+\_\+t seed\+Len, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$output, size\+\_\+t output\+Len)
\begin{DoxyCompactList}\small\item\em Pseudorandom function (T\+LS 1.\+0 and 1.\+1) \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__key__material_8c_a3db35a37ab7a36a93b4f33df4600178b}{tls12\+Prf} (const \hyperlink{structHashAlgo}{Hash\+Algo} $\ast$\hyperlink{tls_8h_a17d89840e7296c323504b31fc6359606}{hash}, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$secret, size\+\_\+t secret\+Len, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$label, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{demo_2microchip_2pic32mz__ef__curiosity_2wifi__http__server__demo_2src_2main_8c_ae5b6f47ec5afdb614046a54e45a39c69}{seed}, size\+\_\+t seed\+Len, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$output, size\+\_\+t output\+Len)
\begin{DoxyCompactList}\small\item\em Pseudorandom function (T\+LS 1.\+2) \end{DoxyCompactList}\item 
void \hyperlink{tls__key__material_8c_a47b4144b4b09d1f5e6cdac0a64fb0a93}{tls\+Dump\+Secret} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$label, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$secret, size\+\_\+t secret\+Len)
\begin{DoxyCompactList}\small\item\em Dump secret key (for debugging purpose only) \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Key material generation. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+S\+SL Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{tls__key__material_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{tls__key__material_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{tls__config_8h_afee42a623033dac888291d1993985206}{T\+L\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file tls\+\_\+key\+\_\+material.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{tls__key__material_8c_a3db35a37ab7a36a93b4f33df4600178b}\label{tls__key__material_8c_a3db35a37ab7a36a93b4f33df4600178b}} 
\index{tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}!tls12\+Prf@{tls12\+Prf}}
\index{tls12\+Prf@{tls12\+Prf}!tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}}
\subsubsection{\texorpdfstring{tls12\+Prf()}{tls12Prf()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls12\+Prf (\begin{DoxyParamCaption}\item[{const \hyperlink{structHashAlgo}{Hash\+Algo} $\ast$}]{hash,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{secret,  }\item[{size\+\_\+t}]{secret\+Len,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{label,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{seed,  }\item[{size\+\_\+t}]{seed\+Len,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{output,  }\item[{size\+\_\+t}]{output\+Len }\end{DoxyParamCaption})}



Pseudorandom function (T\+LS 1.\+2) 

The pseudorandom function (P\+RF) takes as input a secret, a seed, and an identifying label and produces an output of arbitrary length. This function is used to expand secrets into blocks of data for the purpose of key generation


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em hash} & Hash function used to compute P\+RF \\
\hline
\mbox{\tt in}  & {\em secret} & Pointer to the secret \\
\hline
\mbox{\tt in}  & {\em secret\+Len} & Length of the secret \\
\hline
\mbox{\tt in}  & {\em label} & Identifying label (N\+U\+L\+L-\/terminated string) \\
\hline
\mbox{\tt in}  & {\em seed} & Pointer to the seed \\
\hline
\mbox{\tt in}  & {\em seed\+Len} & Length of the seed \\
\hline
\mbox{\tt out}  & {\em output} & Pointer to the output \\
\hline
\mbox{\tt in}  & {\em output\+Len} & Desired output length \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 749 of file tls\+\_\+key\+\_\+material.\+c.


\begin{DoxyCode}
752 \{
753 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_2 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
754    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
755    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
756    \textcolor{keywordtype}{size\_t} labelLen;
757    \hyperlink{structHmacContext}{HmacContext} *hmacContext;
758    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a}[\hyperlink{cyclone__crypto_2core_2crypto_8h_ac6e85336237dcdf8efb9280b84e4ffd6}{MAX\_HASH\_DIGEST\_SIZE}];
759 
760    \textcolor{comment}{//Allocate a memory buffer to hold the HMAC context}
761    hmacContext = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structHmacContext}{HmacContext}));
762 
763    \textcolor{comment}{//Successful memory allocation?}
764    \textcolor{keywordflow}{if}(hmacContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
765    \{
766       \textcolor{comment}{//Retrieve the length of the label}
767       labelLen = strlen(label);
768 
769       \textcolor{comment}{//First compute A(1) = HMAC\_hash(secret, label + seed)}
770       \hyperlink{hmac_8c_ac4ecc520cae02c1b9bbb3651758a703e}{hmacInit}(hmacContext, hash, secret, secretLen);
771       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, label, labelLen);
772       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, \hyperlink{demo_2microchip_2pic32mz__ef__curiosity_2wifi__http__server__demo_2src_2main_8c_ae5b6f47ec5afdb614046a54e45a39c69}{seed}, seedLen);
773       \hyperlink{hmac_8c_a387906ffc55755df380361c43ce0bd6a}{hmacFinal}(hmacContext, a);
774 
775       \textcolor{comment}{//Apply the data expansion function P\_hash}
776       \textcolor{keywordflow}{while}(outputLen > 0)
777       \{
778          \textcolor{comment}{//Compute HMAC\_hash(secret, A(i) + label + seed)}
779          \hyperlink{hmac_8c_ac4ecc520cae02c1b9bbb3651758a703e}{hmacInit}(hmacContext, hash, secret, secretLen);
780          \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, a, hash->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize});
781          \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, label, labelLen);
782          \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, \hyperlink{demo_2microchip_2pic32mz__ef__curiosity_2wifi__http__server__demo_2src_2main_8c_ae5b6f47ec5afdb614046a54e45a39c69}{seed}, seedLen);
783          \hyperlink{hmac_8c_a387906ffc55755df380361c43ce0bd6a}{hmacFinal}(hmacContext, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
784 
785          \textcolor{comment}{//Calculate the number of bytes to copy}
786          n = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(outputLen, hash->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize});
787          \textcolor{comment}{//Copy the resulting digest}
788          memcpy(output, hmacContext->\hyperlink{structHmacContext_a8d7c8cb8814b1cfe2dee045d26077c72}{digest}, n);
789 
790          \textcolor{comment}{//Compute A(i + 1) = HMAC\_hash(secret, A(i))}
791          \hyperlink{hmac_8c_ac4ecc520cae02c1b9bbb3651758a703e}{hmacInit}(hmacContext, hash, secret, secretLen);
792          \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, a, hash->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize});
793          \hyperlink{hmac_8c_a387906ffc55755df380361c43ce0bd6a}{hmacFinal}(hmacContext, a);
794 
795          \textcolor{comment}{//Advance data pointer}
796          output += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
797          \textcolor{comment}{//Decrement byte counter}
798          outputLen -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
799       \}
800 
801       \textcolor{comment}{//Free previously allocated memory}
802       \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(hmacContext);
803 
804       \textcolor{comment}{//Successful processing}
805       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
806    \}
807    \textcolor{keywordflow}{else}
808    \{
809       \textcolor{comment}{//Failed to allocate memory}
810       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
811    \}
812 
813    \textcolor{comment}{//Return status code}
814    \textcolor{keywordflow}{return} error;
815 \textcolor{preprocessor}{#else}
816    \textcolor{comment}{//Not implemented}
817    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
818 \textcolor{preprocessor}{#endif}
819 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__key__material_8c_a47b4144b4b09d1f5e6cdac0a64fb0a93}\label{tls__key__material_8c_a47b4144b4b09d1f5e6cdac0a64fb0a93}} 
\index{tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}!tls\+Dump\+Secret@{tls\+Dump\+Secret}}
\index{tls\+Dump\+Secret@{tls\+Dump\+Secret}!tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}}
\subsubsection{\texorpdfstring{tls\+Dump\+Secret()}{tlsDumpSecret()}}
{\footnotesize\ttfamily void tls\+Dump\+Secret (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{label,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{secret,  }\item[{size\+\_\+t}]{secret\+Len }\end{DoxyParamCaption})}



Dump secret key (for debugging purpose only) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em label} & Identifying label (N\+U\+L\+L-\/terminated string) \\
\hline
\mbox{\tt in}  & {\em secret} & Pointer to the secret key \\
\hline
\mbox{\tt in}  & {\em secret\+Len} & Length of the secret key, in bytes \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 831 of file tls\+\_\+key\+\_\+material.\+c.


\begin{DoxyCode}
833 \{
834 \textcolor{preprocessor}{#if (TLS\_KEY\_LOG\_SUPPORT == ENABLED)}
835    \textcolor{comment}{//Any registered callback?}
836    \textcolor{keywordflow}{if}(context->keyLogCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
837    \{
838       \textcolor{keywordtype}{size\_t} i;
839       \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
840       \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} buffer[194];
841 
842       \textcolor{comment}{//Retrieve the length of the label}
843       n = strlen(label);
844 
845       \textcolor{comment}{//Sanity check}
846       \textcolor{keywordflow}{if}((n + 2 * secretLen + 67) <= \textcolor{keyword}{sizeof}(buffer))
847       \{
848          \textcolor{comment}{//Copy the identifying label}
849          strncpy(buffer, label, n);
850 
851          \textcolor{comment}{//Append a space character}
852          buffer[n++] = \textcolor{charliteral}{' '};
853 
854          \textcolor{comment}{//Convert the client random value to a hex string}
855          \textcolor{keywordflow}{for}(i = 0; i < 32; i++)
856          \{
857             \textcolor{comment}{//Format current byte}
858             n += sprintf(buffer + n, \textcolor{stringliteral}{"%02"} PRIX8, context->clientRandom[i]);
859          \}
860 
861          \textcolor{comment}{//Append a space character}
862          buffer[n++] = \textcolor{charliteral}{' '};
863 
864          \textcolor{comment}{//Convert the secret key to a hex string}
865          \textcolor{keywordflow}{for}(i = 0; i < secretLen; i++)
866          \{
867             \textcolor{comment}{//Format current byte}
868             n += sprintf(buffer + n, \textcolor{stringliteral}{"%02"} PRIX8, secret[i]);
869          \}
870 
871          \textcolor{comment}{//Properly terminate the string with a NULL character}
872          buffer[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}] = \textcolor{charliteral}{'\(\backslash\)0'};
873 
874          \textcolor{comment}{//Invoke user callback function}
875          context->keyLogCallback(context, buffer);
876       \}
877    \}
878 \textcolor{preprocessor}{#endif}
879 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__key__material_8c_ac6537a21ad174313fb219f95a1a594ed}\label{tls__key__material_8c_ac6537a21ad174313fb219f95a1a594ed}} 
\index{tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}!tls\+Export\+Keying\+Material@{tls\+Export\+Keying\+Material}}
\index{tls\+Export\+Keying\+Material@{tls\+Export\+Keying\+Material}!tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}}
\subsubsection{\texorpdfstring{tls\+Export\+Keying\+Material()}{tlsExportKeyingMaterial()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Export\+Keying\+Material (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{label,  }\item[{\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t}}]{use\+Context\+Value,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{context\+Value,  }\item[{size\+\_\+t}]{context\+Value\+Len,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{output,  }\item[{size\+\_\+t}]{output\+Len }\end{DoxyParamCaption})}



Export keying material per R\+FC 5705 standard. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em label} & Identifying label (N\+U\+L\+L-\/terminated string) \\
\hline
\mbox{\tt in}  & {\em use\+Context\+Value} & Specifies whether upper-\/layer context should be used when exporting keying material \\
\hline
\mbox{\tt in}  & {\em context\+Value} & Pointer to the upper-\/layer context \\
\hline
\mbox{\tt in}  & {\em context\+Value\+Len} & Length of the upper-\/layer context \\
\hline
\mbox{\tt out}  & {\em output} & Pointer to the output \\
\hline
\mbox{\tt in}  & {\em output\+Len} & Desired output length \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 471 of file tls\+\_\+key\+\_\+material.\+c.


\begin{DoxyCode}
474 \{
475    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
476    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
477    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *\hyperlink{demo_2microchip_2pic32mz__ef__curiosity_2wifi__http__server__demo_2src_2main_8c_ae5b6f47ec5afdb614046a54e45a39c69}{seed};
478 
479    \textcolor{comment}{//Invalid TLS context?}
480    \textcolor{keywordflow}{if}(context == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
481       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
482 
483    \textcolor{comment}{//Check parameters}
484    \textcolor{keywordflow}{if}(label == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || output == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
485       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
486 
487    \textcolor{comment}{//Make sure the upper-layer context is valid}
488    \textcolor{keywordflow}{if}(contextValue == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && contextValueLen != 0)
489       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
490 
491    \textcolor{comment}{//Calculate the length of the seed}
492    n = 2 * \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE};
493 
494    \textcolor{comment}{//Check whether a context is provided}
495    \textcolor{keywordflow}{if}(useContextValue)
496       n += contextValueLen + 2;
497 
498    \textcolor{comment}{//Allocate a memory buffer to hold the seed}
499    seed = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(n);
500    \textcolor{comment}{//Failed to allocate memory?}
501    \textcolor{keywordflow}{if}(seed == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
502       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca528efe91b7a7e4bcc9a6de7d4b778c67}{ERROR\_OUT\_OF\_RESOURCES};
503 
504    \textcolor{comment}{//Concatenate client\_random and server\_random values}
505    memcpy(seed, context->clientRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
506    memcpy(seed + 32, context->serverRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
507 
508    \textcolor{comment}{//Check whether a context is provided}
509    \textcolor{keywordflow}{if}(useContextValue)
510    \{
511       \textcolor{comment}{//The context\_value\_length is encoded as an unsigned, 16-bit quantity}
512       \textcolor{comment}{//representing the length of the context value}
513       \hyperlink{cpu__endian_8h_a8e657bcdf3842380d2d0006859029240}{STORE16BE}(contextValueLen, seed + 64);
514 
515       \textcolor{comment}{//Copy the context value provided by the application using the exporter}
516       memcpy(seed + 66, contextValue, contextValueLen);
517    \}
518 
519 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_1)}
520    \textcolor{comment}{//TLS 1.0 or TLS 1.1 currently selected?}
521    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_adcc8f4321c8f3b847fbea16ca0ff337e}{TLS\_VERSION\_1\_0} || context->version == 
      \hyperlink{tls_8h_a9e359f668824d16983a41f8deb338979}{TLS\_VERSION\_1\_1})
522    \{
523       \textcolor{comment}{//TLS 1.0 and 1.1 use a PRF that combines MD5 and SHA-1}
524       error = \hyperlink{tls__key__material_8c_a8c9381141cf271397b82f7bf53afdcb8}{tlsPrf}(context->masterSecret, \hyperlink{tls_8h_ae3ac5e6ccd1e8295f15951175e3b7e2b}{TLS\_MASTER\_SECRET\_SIZE},
525          label, seed, n, output, outputLen);
526    \}
527    \textcolor{keywordflow}{else}
528 \textcolor{preprocessor}{#endif}
529 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_2 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
530    \textcolor{comment}{//TLS 1.2 currently selected?}
531    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
532    \{
533       \textcolor{comment}{//Make sure the PRF hash algorithm is valid}
534       \textcolor{keywordflow}{if}(context->cipherSuite.prfHashAlgo != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
535       \{
536          \textcolor{comment}{//TLS 1.2 PRF uses SHA-256 or a stronger hash algorithm as the core}
537          \textcolor{comment}{//function in its construction}
538          error = \hyperlink{tls__key__material_8c_a3db35a37ab7a36a93b4f33df4600178b}{tls12Prf}(context->cipherSuite.prfHashAlgo, context->masterSecret,
539             \hyperlink{tls_8h_ae3ac5e6ccd1e8295f15951175e3b7e2b}{TLS\_MASTER\_SECRET\_SIZE}, label, seed, n, output, outputLen);
540       \}
541       \textcolor{keywordflow}{else}
542       \{
543          \textcolor{comment}{//Invalid PRF hash algorithm}
544          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
545       \}
546    \}
547    \textcolor{keywordflow}{else}
548 \textcolor{preprocessor}{#endif}
549 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
550    \textcolor{comment}{//TLS 1.3 currently selected?}
551    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_ab44dc642afbfbd72926ab1f94634cd4d}{TLS\_VERSION\_1\_3})
552    \{
553       \textcolor{keyword}{const} \hyperlink{structHashAlgo}{HashAlgo} *\hyperlink{tls_8h_a17d89840e7296c323504b31fc6359606}{hash};
554       \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} secret[\hyperlink{tls_8h_a968ff3e9076117070c5003c2e950c74c}{TLS\_MAX\_HKDF\_DIGEST\_SIZE}];
555       \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} digest[\hyperlink{tls_8h_a968ff3e9076117070c5003c2e950c74c}{TLS\_MAX\_HKDF\_DIGEST\_SIZE}];
556 
557       \textcolor{comment}{//The hash function used by HKDF is the cipher suite hash algorithm}
558       hash = context->cipherSuite.prfHashAlgo;
559 
560       \textcolor{comment}{//Make sure the HKDF hash algorithm is valid}
561       \textcolor{keywordflow}{if}(hash != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
562       \{
563          \textcolor{comment}{//Derive exporter master secret}
564          error = \hyperlink{tls13__key__material_8h_a53bed5e95ee4a908225fd4c35e88e4bb}{tls13DeriveSecret}(context, context->exporterMasterSecret,
565             hash->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize}, label, \textcolor{stringliteral}{""}, 0, secret, hash->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize});
566 
567          \textcolor{comment}{//Check status code}
568          \textcolor{keywordflow}{if}(!error)
569          \{
570             \textcolor{comment}{//Hash context\_value input}
571             error = hash->\hyperlink{structHashAlgo_af06e5499992d76f215cc8329a2d6cbb3}{compute}(contextValue, contextValueLen, digest);
572          \}
573 
574          \textcolor{comment}{//Check status code}
575          \textcolor{keywordflow}{if}(!error)
576          \{
577             \textcolor{comment}{//Export keying material}
578             error = \hyperlink{tls13__key__material_8h_ae6c9a07034fb5ca2dcaaef6ac2aa88e9}{tls13HkdfExpandLabel}(hash, secret, hash->
      \hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize},
579                \textcolor{stringliteral}{"exporter"}, digest, hash->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize}, output, outputLen);
580          \}
581       \}
582       \textcolor{keywordflow}{else}
583       \{
584          \textcolor{comment}{//Invalid HKDF hash algorithm}
585          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
586       \}
587    \}
588    \textcolor{keywordflow}{else}
589 \textcolor{preprocessor}{#endif}
590    \textcolor{comment}{//Invalid TLS version?}
591    \{
592       \textcolor{comment}{//Report an error}
593       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
594    \}
595 
596    \textcolor{comment}{//Release previously allocated memory}
597    \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(seed);
598 
599    \textcolor{comment}{//Return status code}
600    \textcolor{keywordflow}{return} error;
601 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__key__material_8c_a0131769bf001edccf8207d7045d48ebd}\label{tls__key__material_8c_a0131769bf001edccf8207d7045d48ebd}} 
\index{tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}!tls\+Generate\+Extended\+Master\+Secret@{tls\+Generate\+Extended\+Master\+Secret}}
\index{tls\+Generate\+Extended\+Master\+Secret@{tls\+Generate\+Extended\+Master\+Secret}!tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}}
\subsubsection{\texorpdfstring{tls\+Generate\+Extended\+Master\+Secret()}{tlsGenerateExtendedMasterSecret()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Generate\+Extended\+Master\+Secret (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Extended master secret computation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 206 of file tls\+\_\+key\+\_\+material.\+c.


\begin{DoxyCode}
207 \{
208 \textcolor{preprocessor}{#if (TLS\_EXT\_MASTER\_SECRET\_SUPPORT == ENABLED)}
209    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
210 
211 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_1)}
212    \textcolor{comment}{//TLS 1.0 or TLS 1.1 currently selected?}
213    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_adcc8f4321c8f3b847fbea16ca0ff337e}{TLS\_VERSION\_1\_0} || context->version == 
      \hyperlink{tls_8h_a9e359f668824d16983a41f8deb338979}{TLS\_VERSION\_1\_1})
214    \{
215       \textcolor{comment}{//A temporary buffer is needed to concatenate MD5 and SHA-1 hash}
216       \textcolor{comment}{//values before computing the extended master secret}
217       \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} sessionHash[\hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE} + 
      \hyperlink{sha1_8h_a3ba9296b223f1b3c710d6b812fd860e8}{SHA1\_DIGEST\_SIZE}];
218 
219       \textcolor{comment}{//Finalize MD5 hash computation}
220       error = \hyperlink{tls__transcript__hash_8c_a177688a47fa85bb7fbe3f3ef755f493b}{tlsFinalizeTranscriptHash}(context, 
      \hyperlink{md5_8h_adcb5ecbd7a360856b056f053b0d8343d}{MD5\_HASH\_ALGO},
221          context->transcriptMd5Context, \textcolor{stringliteral}{""}, sessionHash);
222 
223       \textcolor{comment}{//Check status code}
224       \textcolor{keywordflow}{if}(!error)
225       \{
226          \textcolor{comment}{//Finalize SHA-1 hash computation}
227          error = \hyperlink{tls__transcript__hash_8c_a177688a47fa85bb7fbe3f3ef755f493b}{tlsFinalizeTranscriptHash}(context, 
      \hyperlink{sha1_8h_a2529d805a2d0a0ca32114c810cc6cb1b}{SHA1\_HASH\_ALGO},
228             context->transcriptSha1Context, \textcolor{stringliteral}{""}, sessionHash + \hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE});
229       \}
230 
231       \textcolor{comment}{//Check status code}
232       \textcolor{keywordflow}{if}(!error)
233       \{
234          \textcolor{comment}{//Compute the extended master secret (refer to RFC 7627, section 4)}
235          error = \hyperlink{tls__key__material_8c_a8c9381141cf271397b82f7bf53afdcb8}{tlsPrf}(context->premasterSecret, context->premasterSecretLen,
236             \textcolor{stringliteral}{"extended master secret"}, sessionHash, \textcolor{keyword}{sizeof}(sessionHash),
237             context->masterSecret, \hyperlink{tls_8h_ae3ac5e6ccd1e8295f15951175e3b7e2b}{TLS\_MASTER\_SECRET\_SIZE});
238       \}
239    \}
240    \textcolor{keywordflow}{else}
241 \textcolor{preprocessor}{#endif}
242 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_2 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
243    \textcolor{comment}{//TLS 1.2 currently selected?}
244    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
245    \{
246       \textcolor{keyword}{const} \hyperlink{structHashAlgo}{HashAlgo} *hashAlgo;
247       \hyperlink{structHashContext}{HashContext} *hashContext;
248 
249       \textcolor{comment}{//Point to the hash algorithm to be used}
250       hashAlgo = context->cipherSuite.prfHashAlgo;
251 
252       \textcolor{comment}{//Allocate hash algorithm context}
253       hashContext = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(hashAlgo->\hyperlink{structHashAlgo_ad087845190aa4163d8339cacd07fec3e}{contextSize});
254 
255       \textcolor{comment}{//Successful memory allocation?}
256       \textcolor{keywordflow}{if}(hashContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
257       \{
258          \textcolor{comment}{//The original hash context must be preserved}
259          memcpy(hashContext, context->transcriptHashContext,
260             hashAlgo->\hyperlink{structHashAlgo_ad087845190aa4163d8339cacd07fec3e}{contextSize});
261 
262          \textcolor{comment}{//Finalize hash computation}
263          hashAlgo->\hyperlink{structHashAlgo_a8a1972d608540bbf31e1932f5403f51d}{final}(hashContext, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
264 
265          \textcolor{comment}{//Compute the extended master secret (refer to RFC 7627, section 4)}
266          error = \hyperlink{tls__key__material_8c_a3db35a37ab7a36a93b4f33df4600178b}{tls12Prf}(hashAlgo, context->premasterSecret,
267             context->premasterSecretLen, \textcolor{stringliteral}{"extended master secret"},
268             hashContext->\hyperlink{structHashContext_a846e5b08172b00162569c343caa0eae1}{digest}, hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize},
269             context->masterSecret, \hyperlink{tls_8h_ae3ac5e6ccd1e8295f15951175e3b7e2b}{TLS\_MASTER\_SECRET\_SIZE});
270 
271          \textcolor{comment}{//Release previously allocated memory}
272          \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(hashContext);
273       \}
274       \textcolor{keywordflow}{else}
275       \{
276          \textcolor{comment}{//Failed to allocate memory}
277          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
278       \}
279    \}
280    \textcolor{keywordflow}{else}
281 \textcolor{preprocessor}{#endif}
282    \textcolor{comment}{//Invalid TLS version?}
283    \{
284       \textcolor{comment}{//Report an error}
285       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
286    \}
287 
288    \textcolor{comment}{//Return status code}
289    \textcolor{keywordflow}{return} error;
290 \textcolor{preprocessor}{#else}
291    \textcolor{comment}{//Extended master secret computation is not implemented}
292    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
293 \textcolor{preprocessor}{#endif}
294 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__key__material_8c_a497b28753301ebf0ed54d695b0278372}\label{tls__key__material_8c_a497b28753301ebf0ed54d695b0278372}} 
\index{tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}!tls\+Generate\+Key\+Block@{tls\+Generate\+Key\+Block}}
\index{tls\+Generate\+Key\+Block@{tls\+Generate\+Key\+Block}!tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}}
\subsubsection{\texorpdfstring{tls\+Generate\+Key\+Block()}{tlsGenerateKeyBlock()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Generate\+Key\+Block (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{size\+\_\+t}]{key\+Block\+Len }\end{DoxyParamCaption})}



Key expansion function. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em key\+Block\+Len} & Desired length for the resulting key block \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 405 of file tls\+\_\+key\+\_\+material.\+c.


\begin{DoxyCode}
406 \{
407    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
408    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{tls_8h_a6120afe912430104573286fe328768c9}{random}[2 * \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE}];
409 
410    \textcolor{comment}{//Concatenate server\_random and client\_random values}
411    memcpy(random, context->serverRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
412    memcpy(random + 32, context->clientRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
413 
414 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= SSL\_VERSION\_3\_0)}
415    \textcolor{comment}{//SSL 3.0 currently selected?}
416    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_a8d19a9661e2ca28062ba4a00799e8bdb}{SSL\_VERSION\_3\_0})
417    \{
418       \textcolor{comment}{//SSL 3.0 does not use a PRF, instead makes use abundantly of MD5}
419       error = \hyperlink{ssl__misc_8h_a4a9050ea1d342adf4c2d788cee08eb81}{sslExpandKey}(context->masterSecret, 
      \hyperlink{tls_8h_ae3ac5e6ccd1e8295f15951175e3b7e2b}{TLS\_MASTER\_SECRET\_SIZE},
420          random, \textcolor{keyword}{sizeof}(random), context->keyBlock, keyBlockLen);
421    \}
422    \textcolor{keywordflow}{else}
423 \textcolor{preprocessor}{#endif}
424 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_1)}
425    \textcolor{comment}{//TLS 1.0 or TLS 1.1 currently selected?}
426    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_adcc8f4321c8f3b847fbea16ca0ff337e}{TLS\_VERSION\_1\_0} || context->version == 
      \hyperlink{tls_8h_a9e359f668824d16983a41f8deb338979}{TLS\_VERSION\_1\_1})
427    \{
428       \textcolor{comment}{//TLS 1.0 and 1.1 use a PRF that combines MD5 and SHA-1}
429       error = \hyperlink{tls__key__material_8c_a8c9381141cf271397b82f7bf53afdcb8}{tlsPrf}(context->masterSecret, \hyperlink{tls_8h_ae3ac5e6ccd1e8295f15951175e3b7e2b}{TLS\_MASTER\_SECRET\_SIZE},
430          \textcolor{stringliteral}{"key expansion"}, random, \textcolor{keyword}{sizeof}(random), context->keyBlock,
431          keyBlockLen);
432    \}
433    \textcolor{keywordflow}{else}
434 \textcolor{preprocessor}{#endif}
435 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_2 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
436    \textcolor{comment}{//TLS 1.2 currently selected?}
437    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
438    \{
439       \textcolor{comment}{//TLS 1.2 PRF uses SHA-256 or a stronger hash algorithm}
440       \textcolor{comment}{//as the core function in its construction}
441       error = \hyperlink{tls__key__material_8c_a3db35a37ab7a36a93b4f33df4600178b}{tls12Prf}(context->cipherSuite.prfHashAlgo,
442          context->masterSecret, \hyperlink{tls_8h_ae3ac5e6ccd1e8295f15951175e3b7e2b}{TLS\_MASTER\_SECRET\_SIZE}, \textcolor{stringliteral}{"key expansion"},
443          random, \textcolor{keyword}{sizeof}(random), context->keyBlock, keyBlockLen);
444    \}
445    \textcolor{keywordflow}{else}
446 \textcolor{preprocessor}{#endif}
447    \textcolor{comment}{//Invalid TLS version?}
448    \{
449       \textcolor{comment}{//Report an error}
450       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
451    \}
452 
453    \textcolor{comment}{//Return status code}
454    \textcolor{keywordflow}{return} error;
455 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__key__material_8c_a33afb9fe51464cf27cb9647faca39fad}\label{tls__key__material_8c_a33afb9fe51464cf27cb9647faca39fad}} 
\index{tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}!tls\+Generate\+Master\+Secret@{tls\+Generate\+Master\+Secret}}
\index{tls\+Generate\+Master\+Secret@{tls\+Generate\+Master\+Secret}!tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}}
\subsubsection{\texorpdfstring{tls\+Generate\+Master\+Secret()}{tlsGenerateMasterSecret()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Generate\+Master\+Secret (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Master secret computation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 145 of file tls\+\_\+key\+\_\+material.\+c.


\begin{DoxyCode}
146 \{
147    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
148    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{tls_8h_a6120afe912430104573286fe328768c9}{random}[2 * \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE}];
149 
150    \textcolor{comment}{//Concatenate client\_random and server\_random values}
151    memcpy(random, context->clientRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
152    memcpy(random + 32, context->serverRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
153 
154 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= SSL\_VERSION\_3\_0)}
155    \textcolor{comment}{//SSL 3.0 currently selected?}
156    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_a8d19a9661e2ca28062ba4a00799e8bdb}{SSL\_VERSION\_3\_0})
157    \{
158       \textcolor{comment}{//SSL 3.0 does not use a PRF, instead makes use abundantly of MD5}
159       error = \hyperlink{ssl__misc_8h_a4a9050ea1d342adf4c2d788cee08eb81}{sslExpandKey}(context->premasterSecret,
160          context->premasterSecretLen, random, \textcolor{keyword}{sizeof}(random),
161          context->masterSecret, \hyperlink{tls_8h_ae3ac5e6ccd1e8295f15951175e3b7e2b}{TLS\_MASTER\_SECRET\_SIZE});
162    \}
163    \textcolor{keywordflow}{else}
164 \textcolor{preprocessor}{#endif}
165 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_1)}
166    \textcolor{comment}{//TLS 1.0 or TLS 1.1 currently selected?}
167    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_adcc8f4321c8f3b847fbea16ca0ff337e}{TLS\_VERSION\_1\_0} || context->version == 
      \hyperlink{tls_8h_a9e359f668824d16983a41f8deb338979}{TLS\_VERSION\_1\_1})
168    \{
169       \textcolor{comment}{//TLS 1.0 and 1.1 use a PRF that combines MD5 and SHA-1}
170       error = \hyperlink{tls__key__material_8c_a8c9381141cf271397b82f7bf53afdcb8}{tlsPrf}(context->premasterSecret, context->premasterSecretLen,
171          \textcolor{stringliteral}{"master secret"}, random, \textcolor{keyword}{sizeof}(random), context->masterSecret,
172          \hyperlink{tls_8h_ae3ac5e6ccd1e8295f15951175e3b7e2b}{TLS\_MASTER\_SECRET\_SIZE});
173    \}
174    \textcolor{keywordflow}{else}
175 \textcolor{preprocessor}{#endif}
176 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_2 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
177    \textcolor{comment}{//TLS 1.2 currently selected?}
178    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
179    \{
180       \textcolor{comment}{//TLS 1.2 PRF uses SHA-256 or a stronger hash algorithm as the core}
181       \textcolor{comment}{//function in its construction}
182       error = \hyperlink{tls__key__material_8c_a3db35a37ab7a36a93b4f33df4600178b}{tls12Prf}(context->cipherSuite.prfHashAlgo,
183          context->premasterSecret, context->premasterSecretLen,
184          \textcolor{stringliteral}{"master secret"}, random, \textcolor{keyword}{sizeof}(random), context->masterSecret,
185          \hyperlink{tls_8h_ae3ac5e6ccd1e8295f15951175e3b7e2b}{TLS\_MASTER\_SECRET\_SIZE});
186    \}
187    \textcolor{keywordflow}{else}
188 \textcolor{preprocessor}{#endif}
189    \textcolor{comment}{//Invalid TLS version?}
190    \{
191       \textcolor{comment}{//Report an error}
192       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
193    \}
194 
195    \textcolor{comment}{//Return status code}
196    \textcolor{keywordflow}{return} error;
197 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__key__material_8c_ac5650a18e65eed6e74b8d5ebec573a0d}\label{tls__key__material_8c_ac5650a18e65eed6e74b8d5ebec573a0d}} 
\index{tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}!tls\+Generate\+Psk\+Premaster\+Secret@{tls\+Generate\+Psk\+Premaster\+Secret}}
\index{tls\+Generate\+Psk\+Premaster\+Secret@{tls\+Generate\+Psk\+Premaster\+Secret}!tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}}
\subsubsection{\texorpdfstring{tls\+Generate\+Psk\+Premaster\+Secret()}{tlsGeneratePskPremasterSecret()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Generate\+Psk\+Premaster\+Secret (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Premaster secret generation (for P\+SK cipher suites) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 303 of file tls\+\_\+key\+\_\+material.\+c.


\begin{DoxyCode}
304 \{
305    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
306 
307 \textcolor{preprocessor}{#if (TLS\_PSK\_KE\_SUPPORT == ENABLED)}
308    \textcolor{comment}{//PSK key exchange method?}
309    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aed949c3b521aa45b6685846fa9a3b8f0}{TLS\_KEY\_EXCH\_PSK})
310    \{
311       \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
312 
313       \textcolor{comment}{//Let N be the length of pre-shared key}
314       n = context->pskLen;
315 
316       \textcolor{comment}{//Check whether the output buffer is large enough to hold the premaster}
317       \textcolor{comment}{//secret}
318       \textcolor{keywordflow}{if}((n * 2 + 4) <= \hyperlink{tls_8h_ab57dd89b36996f086e46d778395375c3}{TLS\_PREMASTER\_SECRET\_SIZE})
319       \{
320          \textcolor{comment}{//The premaster secret is formed as follows: if the PSK is N octets}
321          \textcolor{comment}{//long, concatenate a uint16 with the value N, N zero octets, a second}
322          \textcolor{comment}{//uint16 with the value N, and the PSK itself}
323          \hyperlink{cpu__endian_8h_a8e657bcdf3842380d2d0006859029240}{STORE16BE}(n, context->premasterSecret);
324          memset(context->premasterSecret + 2, 0, n);
325          \hyperlink{cpu__endian_8h_a8e657bcdf3842380d2d0006859029240}{STORE16BE}(n, context->premasterSecret + n + 2);
326          memcpy(context->premasterSecret + n + 4, context->psk, n);
327 
328          \textcolor{comment}{//Save the length of the premaster secret}
329          context->premasterSecretLen = n * 2 + 4;
330 
331          \textcolor{comment}{//Premaster secret successfully generated}
332          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
333       \}
334       \textcolor{keywordflow}{else}
335       \{
336          \textcolor{comment}{//Report an error}
337          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf3f6e48b0cfaea7cac34f4223cd8a57}{ERROR\_BUFFER\_OVERFLOW};
338       \}
339    \}
340    \textcolor{keywordflow}{else}
341 \textcolor{preprocessor}{#endif}
342 \textcolor{preprocessor}{#if (TLS\_RSA\_PSK\_KE\_SUPPORT == ENABLED || TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED || \(\backslash\)}
343 \textcolor{preprocessor}{   TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
344    \textcolor{comment}{//RSA\_PSK, DHE\_PSK or ECDHE\_PSK key exchange method?}
345    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a38a6d0551d2fbd9480b6c233c1242d4c}{TLS\_KEY\_EXCH\_RSA\_PSK} ||
346       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a32a252b7c7befeccaa088290d6a71dfe}{TLS\_KEY\_EXCH\_DHE\_PSK} ||
347       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aebba2060dba7ad92238668218f3a6520}{TLS\_KEY\_EXCH\_ECDHE\_PSK})
348    \{
349       \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
350 
351       \textcolor{comment}{//Let N be the length of pre-shared key}
352       n = context->pskLen;
353 
354       \textcolor{comment}{//Check whether the output buffer is large enough to hold the premaster}
355       \textcolor{comment}{//secret}
356       \textcolor{keywordflow}{if}((context->premasterSecretLen + n + 4) <= \hyperlink{tls_8h_ab57dd89b36996f086e46d778395375c3}{TLS\_PREMASTER\_SECRET\_SIZE})
357       \{
358          \textcolor{comment}{//The "other\_secret" field comes from the Diffie-Hellman, ECDH or}
359          \textcolor{comment}{//RSA exchange (DHE\_PSK, ECDH\_PSK and RSA\_PSK, respectively)}
360          memmove(context->premasterSecret + 2, context->premasterSecret,
361             context->premasterSecretLen);
362 
363          \textcolor{comment}{//The "other\_secret" field is preceded by a 2-byte length field}
364          \hyperlink{cpu__endian_8h_a8e657bcdf3842380d2d0006859029240}{STORE16BE}(context->premasterSecretLen, context->premasterSecret);
365 
366          \textcolor{comment}{//if the PSK is N octets long, concatenate a uint16 with the value N}
367          \hyperlink{cpu__endian_8h_a8e657bcdf3842380d2d0006859029240}{STORE16BE}(n, context->premasterSecret + context->premasterSecretLen + 2);
368 
369          \textcolor{comment}{//Concatenate the PSK itself}
370          memcpy(context->premasterSecret + context->premasterSecretLen + 4,
371             context->psk, n);
372 
373          \textcolor{comment}{//Adjust the length of the premaster secret}
374          context->premasterSecretLen += n + 4;
375 
376          \textcolor{comment}{//Premaster secret successfully generated}
377          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
378       \}
379       \textcolor{keywordflow}{else}
380       \{
381          \textcolor{comment}{//Report an error}
382          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf3f6e48b0cfaea7cac34f4223cd8a57}{ERROR\_BUFFER\_OVERFLOW};
383       \}
384    \}
385    \textcolor{keywordflow}{else}
386 \textcolor{preprocessor}{#endif}
387    \textcolor{comment}{//Invalid key exchange method?}
388    \{
389       \textcolor{comment}{//The specified key exchange method is not supported}
390       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca893cd3e6a2ef1603a6c30561ed73ec0e}{ERROR\_UNSUPPORTED\_KEY\_EXCH\_METHOD};
391    \}
392 
393    \textcolor{comment}{//Return status code}
394    \textcolor{keywordflow}{return} error;
395 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__key__material_8c_a48b57409ac1d3429ddc2e236ba8beeb3}\label{tls__key__material_8c_a48b57409ac1d3429ddc2e236ba8beeb3}} 
\index{tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}!tls\+Generate\+Session\+Keys@{tls\+Generate\+Session\+Keys}}
\index{tls\+Generate\+Session\+Keys@{tls\+Generate\+Session\+Keys}!tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}}
\subsubsection{\texorpdfstring{tls\+Generate\+Session\+Keys()}{tlsGenerateSessionKeys()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Generate\+Session\+Keys (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Generate session keys. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 53 of file tls\+\_\+key\+\_\+material.\+c.


\begin{DoxyCode}
54 \{
55 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
56    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
57    \textcolor{keywordtype}{size\_t} keyBlockLen;
58    \hyperlink{structTlsCipherSuiteInfo}{TlsCipherSuiteInfo} *\hyperlink{tls13__misc_8h_ac4845d111b268869455afbd35c5f477b}{cipherSuite};
59 
60    \textcolor{comment}{//Point to the negotiated cipher suite}
61    cipherSuite = &context->cipherSuite;
62 
63    \textcolor{comment}{//Length of necessary key material}
64    keyBlockLen = 2 * (cipherSuite->\hyperlink{structTlsCipherSuiteInfo_af6b9870391d1a8e12094db880597d48a}{macKeyLen} + cipherSuite->\hyperlink{structTlsCipherSuiteInfo_a2cd8770a9ef763ba4e67d2b128007cd8}{encKeyLen} +
65       cipherSuite->\hyperlink{structTlsCipherSuiteInfo_a2c6a2507984b67e38c6550630a20faef}{fixedIvLen});
66 
67    \textcolor{comment}{//Make sure that the key block is large enough}
68    \textcolor{keywordflow}{if}(keyBlockLen > \textcolor{keyword}{sizeof}(context->keyBlock))
69       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
70 
71    \textcolor{comment}{//Debug message}
72    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Generating session keys...\(\backslash\)r\(\backslash\)n"});
73    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Client random bytes:\(\backslash\)r\(\backslash\)n"});
74    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"    "}, context->clientRandom, 32);
75    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Server random bytes:\(\backslash\)r\(\backslash\)n"});
76    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"    "}, context->serverRandom, 32);
77 
78    \textcolor{comment}{//If a full handshake is being performed, the premaster secret shall be}
79    \textcolor{comment}{//first converted to the master secret}
80    \textcolor{keywordflow}{if}(!context->resume)
81    \{
82       \textcolor{comment}{//Debug message}
83       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Premaster secret:\(\backslash\)r\(\backslash\)n"});
84       \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"    "}, context->premasterSecret, context->premasterSecretLen);
85 
86 \textcolor{preprocessor}{#if (TLS\_EXT\_MASTER\_SECRET\_SUPPORT == ENABLED)}
87       \textcolor{comment}{//If both the ClientHello and ServerHello contain the ExtendedMasterSecret}
88       \textcolor{comment}{//extension, the new session uses the extended master secret computation}
89       \textcolor{keywordflow}{if}(context->extendedMasterSecretExtReceived)
90       \{
91          \textcolor{comment}{//Extended master secret computation}
92          error = \hyperlink{tls__key__material_8c_a0131769bf001edccf8207d7045d48ebd}{tlsGenerateExtendedMasterSecret}(context);
93       \}
94       \textcolor{keywordflow}{else}
95 \textcolor{preprocessor}{#endif}
96       \{
97          \textcolor{comment}{//Legacy master secret computation}
98          error = \hyperlink{tls__key__material_8c_a33afb9fe51464cf27cb9647faca39fad}{tlsGenerateMasterSecret}(context);
99       \}
100 
101       \textcolor{comment}{//Failed to generate master secret?}
102       \textcolor{keywordflow}{if}(error)
103          \textcolor{keywordflow}{return} error;
104 
105       \textcolor{comment}{//The premaster secret should be deleted from memory once the master}
106       \textcolor{comment}{//secret has been computed}
107       memset(context->premasterSecret, 0, \hyperlink{tls_8h_ab57dd89b36996f086e46d778395375c3}{TLS\_PREMASTER\_SECRET\_SIZE});
108    \}
109 
110    \textcolor{comment}{//Debug message}
111    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Master secret:\(\backslash\)r\(\backslash\)n"});
112    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"    "}, context->masterSecret, 
      \hyperlink{tls_8h_ae3ac5e6ccd1e8295f15951175e3b7e2b}{TLS\_MASTER\_SECRET\_SIZE});
113 
114 \textcolor{preprocessor}{#if (TLS\_KEY\_LOG\_SUPPORT == ENABLED)}
115    \textcolor{comment}{//Log master secret}
116    \hyperlink{tls__key__material_8c_a47b4144b4b09d1f5e6cdac0a64fb0a93}{tlsDumpSecret}(context, \textcolor{stringliteral}{"CLIENT\_RANDOM"}, context->masterSecret,
117       \hyperlink{tls_8h_ae3ac5e6ccd1e8295f15951175e3b7e2b}{TLS\_MASTER\_SECRET\_SIZE});
118 \textcolor{preprocessor}{#endif}
119 
120    \textcolor{comment}{//The master secret is used as an entropy source to generate the key material}
121    error = \hyperlink{tls__key__material_8c_a497b28753301ebf0ed54d695b0278372}{tlsGenerateKeyBlock}(context, keyBlockLen);
122    \textcolor{comment}{//Any error to report?}
123    \textcolor{keywordflow}{if}(error)
124       \textcolor{keywordflow}{return} error;
125 
126    \textcolor{comment}{//Debug message}
127    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Key block:\(\backslash\)r\(\backslash\)n"});
128    \hyperlink{debug_8h_a1f71019169d85407d8827300ed43bdf0}{TRACE\_DEBUG\_ARRAY}(\textcolor{stringliteral}{"    "}, context->keyBlock, keyBlockLen);
129 
130    \textcolor{comment}{//Successful processing}
131    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
132 \textcolor{preprocessor}{#else}
133    \textcolor{comment}{//Not implemented}
134    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
135 \textcolor{preprocessor}{#endif}
136 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__key__material_8c_a8c9381141cf271397b82f7bf53afdcb8}\label{tls__key__material_8c_a8c9381141cf271397b82f7bf53afdcb8}} 
\index{tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}!tls\+Prf@{tls\+Prf}}
\index{tls\+Prf@{tls\+Prf}!tls\+\_\+key\+\_\+material.\+c@{tls\+\_\+key\+\_\+material.\+c}}
\subsubsection{\texorpdfstring{tls\+Prf()}{tlsPrf()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Prf (\begin{DoxyParamCaption}\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{secret,  }\item[{size\+\_\+t}]{secret\+Len,  }\item[{const \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\+\_\+t} $\ast$}]{label,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{seed,  }\item[{size\+\_\+t}]{seed\+Len,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{output,  }\item[{size\+\_\+t}]{output\+Len }\end{DoxyParamCaption})}



Pseudorandom function (T\+LS 1.\+0 and 1.\+1) 

The pseudorandom function (P\+RF) takes as input a secret, a seed, and an identifying label and produces an output of arbitrary length. This function is used to expand secrets into blocks of data for the purpose of key generation


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em secret} & Pointer to the secret \\
\hline
\mbox{\tt in}  & {\em secret\+Len} & Length of the secret \\
\hline
\mbox{\tt in}  & {\em label} & Identifying label (N\+U\+L\+L-\/terminated string) \\
\hline
\mbox{\tt in}  & {\em seed} & Pointer to the seed \\
\hline
\mbox{\tt in}  & {\em seed\+Len} & Length of the seed \\
\hline
\mbox{\tt out}  & {\em output} & Pointer to the output \\
\hline
\mbox{\tt in}  & {\em output\+Len} & Desired output length \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 622 of file tls\+\_\+key\+\_\+material.\+c.


\begin{DoxyCode}
624 \{
625 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_1)}
626    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
627    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
628    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} j;
629    \textcolor{keywordtype}{size\_t} labelLen;
630    \textcolor{keywordtype}{size\_t} sLen;
631    \textcolor{keyword}{const} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *s1;
632    \textcolor{keyword}{const} \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *s2;
633    \hyperlink{structHmacContext}{HmacContext} *hmacContext;
634    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{ndp_8h_af4007aacd75b22aee32dba9ea96082c0}{a}[\hyperlink{sha1_8h_a3ba9296b223f1b3c710d6b812fd860e8}{SHA1\_DIGEST\_SIZE}];
635 
636    \textcolor{comment}{//Allocate a memory buffer to hold the HMAC context}
637    hmacContext = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structHmacContext}{HmacContext}));
638 
639    \textcolor{comment}{//Successful memory allocation?}
640    \textcolor{keywordflow}{if}(hmacContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
641    \{
642       \textcolor{comment}{//Retrieve the length of the label}
643       labelLen = strlen(label);
644 
645       \textcolor{comment}{//The secret is partitioned into two halves S1 and S2}
646       \textcolor{comment}{//with the possibility of one shared byte}
647       sLen = (secretLen + 1) / 2;
648       \textcolor{comment}{//S1 is taken from the first half of the secret}
649       s1 = secret;
650       \textcolor{comment}{//S2 is taken from the second half}
651       s2 = secret + secretLen - sLen;
652 
653       \textcolor{comment}{//First compute A(1) = HMAC\_MD5(S1, label + seed)}
654       \hyperlink{hmac_8c_ac4ecc520cae02c1b9bbb3651758a703e}{hmacInit}(hmacContext, \hyperlink{md5_8h_adcb5ecbd7a360856b056f053b0d8343d}{MD5\_HASH\_ALGO}, s1, sLen);
655       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, label, labelLen);
656       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, \hyperlink{demo_2microchip_2pic32mz__ef__curiosity_2wifi__http__server__demo_2src_2main_8c_ae5b6f47ec5afdb614046a54e45a39c69}{seed}, seedLen);
657       \hyperlink{hmac_8c_a387906ffc55755df380361c43ce0bd6a}{hmacFinal}(hmacContext, a);
658 
659       \textcolor{comment}{//Apply the data expansion function P\_MD5}
660       \textcolor{keywordflow}{for}(i = 0; i < outputLen; )
661       \{
662          \textcolor{comment}{//Compute HMAC\_MD5(S1, A(i) + label + seed)}
663          \hyperlink{hmac_8c_ac4ecc520cae02c1b9bbb3651758a703e}{hmacInit}(hmacContext, \hyperlink{md5_8h_adcb5ecbd7a360856b056f053b0d8343d}{MD5\_HASH\_ALGO}, s1, sLen);
664          \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, a, \hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE});
665          \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, label, labelLen);
666          \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, \hyperlink{demo_2microchip_2pic32mz__ef__curiosity_2wifi__http__server__demo_2src_2main_8c_ae5b6f47ec5afdb614046a54e45a39c69}{seed}, seedLen);
667          \hyperlink{hmac_8c_a387906ffc55755df380361c43ce0bd6a}{hmacFinal}(hmacContext, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
668 
669          \textcolor{comment}{//Copy the resulting digest}
670          \textcolor{keywordflow}{for}(j = 0; i < outputLen && j < \hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE}; i++, j++)
671          \{
672             output[i] = hmacContext->\hyperlink{structHmacContext_a8d7c8cb8814b1cfe2dee045d26077c72}{digest}[j];
673          \}
674 
675          \textcolor{comment}{//Compute A(i + 1) = HMAC\_MD5(S1, A(i))}
676          \hyperlink{hmac_8c_ac4ecc520cae02c1b9bbb3651758a703e}{hmacInit}(hmacContext, \hyperlink{md5_8h_adcb5ecbd7a360856b056f053b0d8343d}{MD5\_HASH\_ALGO}, s1, sLen);
677          \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, a, MD5\_DIGEST\_SIZE);
678          \hyperlink{hmac_8c_a387906ffc55755df380361c43ce0bd6a}{hmacFinal}(hmacContext, a);
679       \}
680 
681       \textcolor{comment}{//First compute A(1) = HMAC\_SHA1(S2, label + seed)}
682       \hyperlink{hmac_8c_ac4ecc520cae02c1b9bbb3651758a703e}{hmacInit}(hmacContext, \hyperlink{sha1_8h_a2529d805a2d0a0ca32114c810cc6cb1b}{SHA1\_HASH\_ALGO}, s2, sLen);
683       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, label, labelLen);
684       \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, \hyperlink{demo_2microchip_2pic32mz__ef__curiosity_2wifi__http__server__demo_2src_2main_8c_ae5b6f47ec5afdb614046a54e45a39c69}{seed}, seedLen);
685       \hyperlink{hmac_8c_a387906ffc55755df380361c43ce0bd6a}{hmacFinal}(hmacContext, a);
686 
687       \textcolor{comment}{//Apply the data expansion function P\_SHA1}
688       \textcolor{keywordflow}{for}(i = 0; i < outputLen; )
689       \{
690          \textcolor{comment}{//Compute HMAC\_SHA1(S2, A(i) + label + seed)}
691          \hyperlink{hmac_8c_ac4ecc520cae02c1b9bbb3651758a703e}{hmacInit}(hmacContext, \hyperlink{sha1_8h_a2529d805a2d0a0ca32114c810cc6cb1b}{SHA1\_HASH\_ALGO}, s2, sLen);
692          \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, a, \hyperlink{sha1_8h_a3ba9296b223f1b3c710d6b812fd860e8}{SHA1\_DIGEST\_SIZE});
693          \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, label, labelLen);
694          \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, \hyperlink{demo_2microchip_2pic32mz__ef__curiosity_2wifi__http__server__demo_2src_2main_8c_ae5b6f47ec5afdb614046a54e45a39c69}{seed}, seedLen);
695          \hyperlink{hmac_8c_a387906ffc55755df380361c43ce0bd6a}{hmacFinal}(hmacContext, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
696 
697          \textcolor{comment}{//Copy the resulting digest}
698          \textcolor{keywordflow}{for}(j = 0; i < outputLen && j < \hyperlink{sha1_8h_a3ba9296b223f1b3c710d6b812fd860e8}{SHA1\_DIGEST\_SIZE}; i++, j++)
699          \{
700             output[i] ^= hmacContext->\hyperlink{structHmacContext_a8d7c8cb8814b1cfe2dee045d26077c72}{digest}[j];
701          \}
702 
703          \textcolor{comment}{//Compute A(i + 1) = HMAC\_SHA1(S2, A(i))}
704          \hyperlink{hmac_8c_ac4ecc520cae02c1b9bbb3651758a703e}{hmacInit}(hmacContext, \hyperlink{sha1_8h_a2529d805a2d0a0ca32114c810cc6cb1b}{SHA1\_HASH\_ALGO}, s2, sLen);
705          \hyperlink{hmac_8c_a4c34324b10bcf1b4372f272369773501}{hmacUpdate}(hmacContext, a, SHA1\_DIGEST\_SIZE);
706          \hyperlink{hmac_8c_a387906ffc55755df380361c43ce0bd6a}{hmacFinal}(hmacContext, a);
707       \}
708 
709       \textcolor{comment}{//Free previously allocated memory}
710       \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(hmacContext);
711 
712       \textcolor{comment}{//Successful processing}
713       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
714    \}
715    \textcolor{keywordflow}{else}
716    \{
717       \textcolor{comment}{//Failed to allocate memory}
718       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
719    \}
720 
721    \textcolor{comment}{//Return status code}
722    \textcolor{keywordflow}{return} error;
723 \textcolor{preprocessor}{#else}
724    \textcolor{comment}{//Not implemented}
725    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
726 \textcolor{preprocessor}{#endif}
727 \}
\end{DoxyCode}
