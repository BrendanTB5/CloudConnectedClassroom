\hypertarget{ndp_8c}{}\section{cyclone\+\_\+tcp/ipv6/ndp.c File Reference}
\label{ndp_8c}\index{cyclone\+\_\+tcp/ipv6/ndp.\+c@{cyclone\+\_\+tcp/ipv6/ndp.\+c}}


N\+DP (Neighbor Discovery Protocol)  


{\ttfamily \#include $<$limits.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/ipv6.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/ipv6\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/icmpv6.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/ndp.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/ndp\+\_\+cache.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/ndp\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv6/slaac.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mibs/ip\+\_\+mib\+\_\+module.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{ndp_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_a9b043f871643938bfb7bb24a351c144c}{N\+D\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ndp_8c_a4b0bf0cdfad666e147a1a29941127e67}{ndp\+Init} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Neighbor cache initialization. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ndp_8c_af4c9241c9bdc3e1ef99481060de5cc02}{ndp\+Resolve} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6\+Addr} $\ast$\hyperlink{ipcp_8h_a11542dd5a4de5976a89188df3d53b42d}{ip\+Addr}, \hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{Mac\+Addr} $\ast$mac\+Addr)
\begin{DoxyCompactList}\small\item\em Address resolution using Neighbor Discovery protocol. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ndp_8c_a25dabd46635fe898b551abf46cf83599}{ndp\+Enqueue\+Packet} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$src\+Interface, \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$dest\+Interface, const \hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6\+Addr} $\ast$\hyperlink{ipcp_8h_a11542dd5a4de5976a89188df3d53b42d}{ip\+Addr}, \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset})
\begin{DoxyCompactList}\small\item\em Enqueue an I\+Pv6 packet waiting for address resolution. \end{DoxyCompactList}\item 
void \hyperlink{ndp_8c_ae1a7cfa93be8d2ff1c062d278796ddc1}{ndp\+Tick} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em N\+DP timer handler. \end{DoxyCompactList}\item 
void \hyperlink{ndp_8c_ab0cb4376c4dcf43a46691afab3909c97}{ndp\+Link\+Change\+Event} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Callback function for link change event. \end{DoxyCompactList}\item 
void \hyperlink{ndp_8c_aa7051fe044957e8df3367770d7431581}{ndp\+Process\+Router\+Adv} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$pseudo\+Header, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} hop\+Limit)
\begin{DoxyCompactList}\small\item\em Router Advertisement message processing. \end{DoxyCompactList}\item 
void \hyperlink{ndp_8c_a48be39b562002b5c5d7e8eb49dedbd4d}{ndp\+Process\+Neighbor\+Sol} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$pseudo\+Header, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} hop\+Limit)
\begin{DoxyCompactList}\small\item\em Neighbor Solicitation message processing. \end{DoxyCompactList}\item 
void \hyperlink{ndp_8c_abad0ce0562414e464a6509338000e462}{ndp\+Process\+Neighbor\+Adv} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$pseudo\+Header, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} hop\+Limit)
\begin{DoxyCompactList}\small\item\em Neighbor Advertisement message processing. \end{DoxyCompactList}\item 
void \hyperlink{ndp_8c_a9a209b57eb8f84ac34d0eeea736a2aff}{ndp\+Process\+Redirect} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$pseudo\+Header, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset}, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} hop\+Limit)
\begin{DoxyCompactList}\small\item\em Redirect message processing. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ndp_8c_a7553aa29f5212b7e5be1faad1af42925}{ndp\+Send\+Router\+Sol} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Send a Router Solicitation message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ndp_8c_aa2d7bb550603db3b3e48a150c4e30d49}{ndp\+Send\+Neighbor\+Sol} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6\+Addr} $\ast$target\+Ip\+Addr, \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t} multicast)
\begin{DoxyCompactList}\small\item\em Send a Neighbor Solicitation message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ndp_8c_a469e0954e29d4f66705088abcbbdd28a}{ndp\+Send\+Neighbor\+Adv} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6\+Addr} $\ast$target\+Ip\+Addr, const \hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6\+Addr} $\ast$\hyperlink{ipcp_8h_a752e1719cf65f78dfec6274352cb56df}{dest\+Ip\+Addr})
\begin{DoxyCompactList}\small\item\em Send a Neighbor Advertisement message. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{ndp_8c_a1f5f38f7a18c49e25a1d81821a813491}{ndp\+Send\+Redirect} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, const \hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6\+Addr} $\ast$\hyperlink{ndp_8h_a2bad05a029241e5009f65fe5480187a0}{target\+Addr}, const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$\hyperlink{ndp_8h_a6c97f605f59d957e1720030e1b1058e5}{ip\+Packet}, size\+\_\+t ip\+Packet\+Offset)
\begin{DoxyCompactList}\small\item\em Send a Redirect message. \end{DoxyCompactList}\item 
void \hyperlink{ndp_8c_a7d9e788153f14c99e9d5b76bb5f3dc5e}{ndp\+Dump\+Router\+Sol\+Message} (const \hyperlink{ndp_8h_a0d342407a414edc2cf6ea2fefbd24621}{Ndp\+Router\+Sol\+Message} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Dump Router Solicitation message for debugging purpose. \end{DoxyCompactList}\item 
void \hyperlink{ndp_8c_a20c2cb4ecad744ec1fb6db91f6f2787e}{ndp\+Dump\+Router\+Adv\+Message} (const \hyperlink{ndp_8h_ad4e8bce6eb079bfe6e7681a6f6488c1e}{Ndp\+Router\+Adv\+Message} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Dump Router Advertisement message for debugging purpose. \end{DoxyCompactList}\item 
void \hyperlink{ndp_8c_a0918093e5ba4f5738f552a2deb1395d6}{ndp\+Dump\+Neighbor\+Sol\+Message} (const \hyperlink{ndp_8h_a0cc069b424bfd84ee062d7d0793b174b}{Ndp\+Neighbor\+Sol\+Message} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Dump Neighbor Solicitation message for debugging purpose. \end{DoxyCompactList}\item 
void \hyperlink{ndp_8c_a0fb3e8d27d1f9658296efe05c705d05d}{ndp\+Dump\+Neighbor\+Adv\+Message} (const \hyperlink{ndp_8h_a2727c6d34f93db5133b4a7bf327a63a9}{Ndp\+Neighbor\+Adv\+Message} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Dump Neighbor Advertisement message for debugging purpose. \end{DoxyCompactList}\item 
void \hyperlink{ndp_8c_a0c9cf9bc419ac9ebd3bdcd13ccae9060}{ndp\+Dump\+Redirect\+Message} (const \hyperlink{ndp_8h_ad7f7873e6eed24c49155b65903f51801}{Ndp\+Redirect\+Message} $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message})
\begin{DoxyCompactList}\small\item\em Dump Redirect message for debugging purpose. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t} \hyperlink{ndp_8c_ac0dbbb540cd7f7eb6e8f42b820ef5407}{ndp\+Tick\+Counter}
\end{DoxyCompactItemize}


\subsection{Detailed Description}
N\+DP (Neighbor Discovery Protocol) 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.\hypertarget{tftp__server_8c_Description}{}\subsection{Description}\label{tftp__server_8c_Description}
The Neighbor Discovery Protocol is responsible for address autoconfiguration of nodes, discovery of the link-\/layer addresses of other nodes, duplicate address detection, finding available routers and address prefix discovery. Refer to R\+FC 4861 for more details

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{ndp_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{ndp_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{ndp.\+c@{ndp.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_a9b043f871643938bfb7bb24a351c144c}{N\+D\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 39 of file ndp.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{ndp_8c_a0fb3e8d27d1f9658296efe05c705d05d}\label{ndp_8c_a0fb3e8d27d1f9658296efe05c705d05d}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Dump\+Neighbor\+Adv\+Message@{ndp\+Dump\+Neighbor\+Adv\+Message}}
\index{ndp\+Dump\+Neighbor\+Adv\+Message@{ndp\+Dump\+Neighbor\+Adv\+Message}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Dump\+Neighbor\+Adv\+Message()}{ndpDumpNeighborAdvMessage()}}
{\footnotesize\ttfamily void ndp\+Dump\+Neighbor\+Adv\+Message (\begin{DoxyParamCaption}\item[{const \hyperlink{ndp_8h_a2727c6d34f93db5133b4a7bf327a63a9}{Ndp\+Neighbor\+Adv\+Message} $\ast$}]{message }\end{DoxyParamCaption})}



Dump Neighbor Advertisement message for debugging purpose. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Neighbor Advertisement message \\
\hline
\end{DoxyParams}


Definition at line 1943 of file ndp.\+c.


\begin{DoxyCode}
1944 \{
1945    \textcolor{comment}{//Dump Neighbor Advertisement message}
1946    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Type = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->type);
1947    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Code = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->code);
1948    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Checksum = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->checksum));
1949    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  R = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->r);
1950    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  S = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->s);
1951    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  O = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->o);
1952    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Target Address = %s\(\backslash\)r\(\backslash\)n"}, \hyperlink{ipv6_8c_a96e27d88ffdf1b2ca6fca448dc6b4e7e}{ipv6AddrToString}(&
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->targetAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
1953 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_a0918093e5ba4f5738f552a2deb1395d6}\label{ndp_8c_a0918093e5ba4f5738f552a2deb1395d6}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Dump\+Neighbor\+Sol\+Message@{ndp\+Dump\+Neighbor\+Sol\+Message}}
\index{ndp\+Dump\+Neighbor\+Sol\+Message@{ndp\+Dump\+Neighbor\+Sol\+Message}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Dump\+Neighbor\+Sol\+Message()}{ndpDumpNeighborSolMessage()}}
{\footnotesize\ttfamily void ndp\+Dump\+Neighbor\+Sol\+Message (\begin{DoxyParamCaption}\item[{const \hyperlink{ndp_8h_a0cc069b424bfd84ee062d7d0793b174b}{Ndp\+Neighbor\+Sol\+Message} $\ast$}]{message }\end{DoxyParamCaption})}



Dump Neighbor Solicitation message for debugging purpose. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Neighbor Solicitation message \\
\hline
\end{DoxyParams}


Definition at line 1928 of file ndp.\+c.


\begin{DoxyCode}
1929 \{
1930    \textcolor{comment}{//Dump Neighbor Solicitation message}
1931    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Type = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->type);
1932    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Code = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->code);
1933    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Checksum = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->checksum));
1934    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Target Address = %s\(\backslash\)r\(\backslash\)n"}, \hyperlink{ipv6_8c_a96e27d88ffdf1b2ca6fca448dc6b4e7e}{ipv6AddrToString}(&
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->targetAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
1935 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_a0c9cf9bc419ac9ebd3bdcd13ccae9060}\label{ndp_8c_a0c9cf9bc419ac9ebd3bdcd13ccae9060}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Dump\+Redirect\+Message@{ndp\+Dump\+Redirect\+Message}}
\index{ndp\+Dump\+Redirect\+Message@{ndp\+Dump\+Redirect\+Message}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Dump\+Redirect\+Message()}{ndpDumpRedirectMessage()}}
{\footnotesize\ttfamily void ndp\+Dump\+Redirect\+Message (\begin{DoxyParamCaption}\item[{const \hyperlink{ndp_8h_ad7f7873e6eed24c49155b65903f51801}{Ndp\+Redirect\+Message} $\ast$}]{message }\end{DoxyParamCaption})}



Dump Redirect message for debugging purpose. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Redirect message \\
\hline
\end{DoxyParams}


Definition at line 1961 of file ndp.\+c.


\begin{DoxyCode}
1962 \{
1963    \textcolor{comment}{//Dump Neighbor Advertisement message}
1964    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Type = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->type);
1965    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Code = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->code);
1966    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Checksum = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->checksum));
1967    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Target Address = %s\(\backslash\)r\(\backslash\)n"}, \hyperlink{ipv6_8c_a96e27d88ffdf1b2ca6fca448dc6b4e7e}{ipv6AddrToString}(&
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->targetAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
1968    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Destination Address = %s\(\backslash\)r\(\backslash\)n"}, \hyperlink{ipv6_8c_a96e27d88ffdf1b2ca6fca448dc6b4e7e}{ipv6AddrToString}(&
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->destAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
1969 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_a20c2cb4ecad744ec1fb6db91f6f2787e}\label{ndp_8c_a20c2cb4ecad744ec1fb6db91f6f2787e}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Dump\+Router\+Adv\+Message@{ndp\+Dump\+Router\+Adv\+Message}}
\index{ndp\+Dump\+Router\+Adv\+Message@{ndp\+Dump\+Router\+Adv\+Message}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Dump\+Router\+Adv\+Message()}{ndpDumpRouterAdvMessage()}}
{\footnotesize\ttfamily void ndp\+Dump\+Router\+Adv\+Message (\begin{DoxyParamCaption}\item[{const \hyperlink{ndp_8h_ad4e8bce6eb079bfe6e7681a6f6488c1e}{Ndp\+Router\+Adv\+Message} $\ast$}]{message }\end{DoxyParamCaption})}



Dump Router Advertisement message for debugging purpose. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Router Advertisement message \\
\hline
\end{DoxyParams}


Definition at line 1908 of file ndp.\+c.


\begin{DoxyCode}
1909 \{
1910    \textcolor{comment}{//Dump Router Advertisement message}
1911    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Type = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->type);
1912    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Code = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->code);
1913    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Checksum = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->checksum));
1914    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Cur Hop Limit = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->curHopLimit);
1915    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  M = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->m);
1916    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  O = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->o);
1917    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Router Lifetime = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->routerLifetime));
1918    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Reachable Time = %"} PRIu32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->reachableTime));
1919    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Retrans Timer = %"} PRIu32 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->retransTimer));
1920 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_a7d9e788153f14c99e9d5b76bb5f3dc5e}\label{ndp_8c_a7d9e788153f14c99e9d5b76bb5f3dc5e}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Dump\+Router\+Sol\+Message@{ndp\+Dump\+Router\+Sol\+Message}}
\index{ndp\+Dump\+Router\+Sol\+Message@{ndp\+Dump\+Router\+Sol\+Message}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Dump\+Router\+Sol\+Message()}{ndpDumpRouterSolMessage()}}
{\footnotesize\ttfamily void ndp\+Dump\+Router\+Sol\+Message (\begin{DoxyParamCaption}\item[{const \hyperlink{ndp_8h_a0d342407a414edc2cf6ea2fefbd24621}{Ndp\+Router\+Sol\+Message} $\ast$}]{message }\end{DoxyParamCaption})}



Dump Router Solicitation message for debugging purpose. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em message} & Router Solicitation message \\
\hline
\end{DoxyParams}


Definition at line 1894 of file ndp.\+c.


\begin{DoxyCode}
1895 \{
1896    \textcolor{comment}{//Dump Router Solicitation message}
1897    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Type = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->type);
1898    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Code = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->code);
1899    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Checksum = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}->checksum));
1900 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_a25dabd46635fe898b551abf46cf83599}\label{ndp_8c_a25dabd46635fe898b551abf46cf83599}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Enqueue\+Packet@{ndp\+Enqueue\+Packet}}
\index{ndp\+Enqueue\+Packet@{ndp\+Enqueue\+Packet}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Enqueue\+Packet()}{ndpEnqueuePacket()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ndp\+Enqueue\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{src\+Interface,  }\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{dest\+Interface,  }\item[{const \hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6\+Addr} $\ast$}]{ip\+Addr,  }\item[{\hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset }\end{DoxyParamCaption})}



Enqueue an I\+Pv6 packet waiting for address resolution. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em src\+Interface} & Interface from which the packet has been received \\
\hline
\mbox{\tt in}  & {\em dest\+Interface} & Interface on which the packet should be sent \\
\hline
\mbox{\tt in}  & {\em ip\+Addr} & I\+Pv6 address of the destination host \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the packet to be enqueued \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first byte of the packet \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 192 of file ndp.\+c.


\begin{DoxyCode}
194 \{
195    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
196    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
197    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
198    \hyperlink{structNdpNeighborCacheEntry}{NdpNeighborCacheEntry} *entry;
199 
200    \textcolor{comment}{//Retrieve the length of the multi-part buffer}
201    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer);
202 
203    \textcolor{comment}{//Search the Neighbor cache for the specified IPv6 address}
204    entry = \hyperlink{ndp__cache_8c_a4bb136704775638d094e9b9b0eab0c62}{ndpFindNeighborCacheEntry}(destInterface, 
      \hyperlink{mib__common_8h_a3860e959b1b7dd73686a6e11424805e2}{ipAddr});
205 
206    \textcolor{comment}{//Check whether a matching entry exists}
207    \textcolor{keywordflow}{if}(entry != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
208    \{
209       \textcolor{comment}{//Check current state}
210       \textcolor{keywordflow}{if}(entry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} == \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479af1920f2caebfea1b46a7e9f9439bc6f9}{NDP\_STATE\_INCOMPLETE})
211       \{
212          \textcolor{comment}{//Check whether the packet queue is full}
213          \textcolor{keywordflow}{if}(entry->\hyperlink{structNdpNeighborCacheEntry_ac6639d88295e91df681f7e0fcb88c83b}{queueSize} >= \hyperlink{ndp_8h_af20ff817ba73edd4451c0fb8dfb6e5b2}{NDP\_MAX\_PENDING\_PACKETS})
214          \{
215             \textcolor{comment}{//When the queue overflows, the new arrival should replace the oldest entry}
216             \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(entry->\hyperlink{structNdpNeighborCacheEntry_a96ee1ce22a34ce6fbe999554aed2ec3d}{queue}[0].\hyperlink{structNdpQueueItem_a082af3807557108029732db38c0343e6}{buffer});
217 
218             \textcolor{comment}{//Make room for the new packet}
219             \textcolor{keywordflow}{for}(i = 1; i < \hyperlink{ndp_8h_af20ff817ba73edd4451c0fb8dfb6e5b2}{NDP\_MAX\_PENDING\_PACKETS}; i++)
220                entry->\hyperlink{structNdpNeighborCacheEntry_a96ee1ce22a34ce6fbe999554aed2ec3d}{queue}[i - 1] = entry->\hyperlink{structNdpNeighborCacheEntry_a96ee1ce22a34ce6fbe999554aed2ec3d}{queue}[i];
221 
222             \textcolor{comment}{//Adjust the number of pending packets}
223             entry->\hyperlink{structNdpNeighborCacheEntry_ac6639d88295e91df681f7e0fcb88c83b}{queueSize}--;
224          \}
225 
226          \textcolor{comment}{//Index of the entry to be filled in}
227          i = entry->\hyperlink{structNdpNeighborCacheEntry_ac6639d88295e91df681f7e0fcb88c83b}{queueSize};
228          \textcolor{comment}{//Allocate a memory buffer to store the packet}
229          entry->\hyperlink{structNdpNeighborCacheEntry_a96ee1ce22a34ce6fbe999554aed2ec3d}{queue}[i].\hyperlink{structNdpQueueItem_a082af3807557108029732db38c0343e6}{buffer} = \hyperlink{net__mem_8c_a986c9991e530e99528faa4c43efadc6f}{netBufferAlloc}(length);
230 
231          \textcolor{comment}{//Successful memory allocation?}
232          \textcolor{keywordflow}{if}(entry->\hyperlink{structNdpNeighborCacheEntry_a96ee1ce22a34ce6fbe999554aed2ec3d}{queue}[i].\hyperlink{structNdpQueueItem_a082af3807557108029732db38c0343e6}{buffer} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
233          \{
234             \textcolor{comment}{//If the IPv6 packet has been forwarded, record the network}
235             \textcolor{comment}{//interface from which the packet has been received}
236             entry->\hyperlink{structNdpNeighborCacheEntry_a96ee1ce22a34ce6fbe999554aed2ec3d}{queue}[i].\hyperlink{structNdpQueueItem_ae42a51fd4d60583ddc7a323c9e2c6863}{srcInterface} = srcInterface;
237 
238             \textcolor{comment}{//Copy the contents of the IPv6 packet}
239             \hyperlink{net__mem_8c_a553a02631efd217192800ad3cdf9bbba}{netBufferCopy}(entry->\hyperlink{structNdpNeighborCacheEntry_a96ee1ce22a34ce6fbe999554aed2ec3d}{queue}[i].\hyperlink{structNdpQueueItem_a082af3807557108029732db38c0343e6}{buffer}, 0, buffer, 0, length);
240             \textcolor{comment}{//Offset to the first byte of the IPv6 header}
241             entry->\hyperlink{structNdpNeighborCacheEntry_a96ee1ce22a34ce6fbe999554aed2ec3d}{queue}[i].\hyperlink{structNdpQueueItem_a35dd0104a5c90df40b99e85e84b2e194}{offset} = \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
242 
243             \textcolor{comment}{//Increment the number of queued packets}
244             entry->\hyperlink{structNdpNeighborCacheEntry_ac6639d88295e91df681f7e0fcb88c83b}{queueSize}++;
245             \textcolor{comment}{//The packet was successfully enqueued}
246             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
247          \}
248          \textcolor{keywordflow}{else}
249          \{
250             \textcolor{comment}{//Failed to allocate memory}
251             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
252          \}
253       \}
254       \textcolor{keywordflow}{else}
255       \{
256          \textcolor{comment}{//The address is already resolved}
257          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac17950207f5a741c1f2a1f5edb64c22e}{ERROR\_UNEXPECTED\_STATE};
258       \}
259    \}
260    \textcolor{keywordflow}{else}
261    \{
262       \textcolor{comment}{//No matching entry in Neighbor Cache}
263       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4cca37264afee88cb14cd105f0d59607}{ERROR\_NOT\_FOUND};
264    \}
265 
266    \textcolor{comment}{//Return status code}
267    \textcolor{keywordflow}{return} error;
268 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_a4b0bf0cdfad666e147a1a29941127e67}\label{ndp_8c_a4b0bf0cdfad666e147a1a29941127e67}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Init@{ndp\+Init}}
\index{ndp\+Init@{ndp\+Init}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Init()}{ndpInit()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ndp\+Init (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Neighbor cache initialization. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 68 of file ndp.\+c.


\begin{DoxyCode}
69 \{
70    \hyperlink{structNdpContext}{NdpContext} *context;
71 
72    \textcolor{comment}{//Point to the NDP context}
73    context = &interface->ndpContext;
74 
75    \textcolor{comment}{//Clear the NDP context}
76    memset(context, 0, \textcolor{keyword}{sizeof}(\hyperlink{structNdpContext}{NdpContext}));
77 
78    \textcolor{comment}{//Initialize interface specific variables}
79    context->\hyperlink{structNdpContext_a572ac8209cafbc1f41949fa4031173fc}{reachableTime} = \hyperlink{ndp_8h_aedca5344875b2ae8e08ee5d794dadd7f}{NDP\_REACHABLE\_TIME};
80    context->\hyperlink{structNdpContext_a529caf9017efd6a9e5b9e546a9a0c012}{retransTimer} = \hyperlink{ndp_8h_a28f80d67a8075ff1837c693c69374445}{NDP\_RETRANS\_TIMER};
81    context->\hyperlink{structNdpContext_a47458438d295650512e889531b1e0471}{dupAddrDetectTransmits} = 
      \hyperlink{ndp_8h_aa51ff416f59404cf5b2e9bca1031313d}{NDP\_DUP\_ADDR\_DETECT\_TRANSMITS};
82    context->\hyperlink{structNdpContext_a79e43c50b5147074a654da9c242008d3}{minRtrSolicitationDelay} = 
      \hyperlink{ndp_8h_aaea9dc170a43470ae056dfa4fe59c2cc}{NDP\_MIN\_RTR\_SOLICITATION\_DELAY};
83    context->\hyperlink{structNdpContext_a5f21cd7b9fe8e523cd7b01d6274cb11c}{maxRtrSolicitationDelay} = 
      \hyperlink{ndp_8h_aabd73da3c2aca80788a052444d83b0d5}{NDP\_MAX\_RTR\_SOLICITATION\_DELAY};
84    context->\hyperlink{structNdpContext_aeb312645a94a797c2e509c4753562fb4}{rtrSolicitationInterval} = 
      \hyperlink{ndp_8h_a7a7d5a7704660da72d5e6d68cf828c20}{NDP\_RTR\_SOLICITATION\_INTERVAL};
85    context->\hyperlink{structNdpContext_aceadc715ad12f0148cdba9acba96949a}{maxRtrSolicitations} = \hyperlink{ndp_8h_a9c9a34ea3fffe3f99687de87f069b50d}{NDP\_MAX\_RTR\_SOLICITATIONS};
86 
87    \textcolor{comment}{//Successful initialization}
88    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
89 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_ab0cb4376c4dcf43a46691afab3909c97}\label{ndp_8c_ab0cb4376c4dcf43a46691afab3909c97}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Link\+Change\+Event@{ndp\+Link\+Change\+Event}}
\index{ndp\+Link\+Change\+Event@{ndp\+Link\+Change\+Event}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Link\+Change\+Event()}{ndpLinkChangeEvent()}}
{\footnotesize\ttfamily void ndp\+Link\+Change\+Event (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Callback function for link change event. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 366 of file ndp.\+c.


\begin{DoxyCode}
367 \{
368    \hyperlink{structNdpContext}{NdpContext} *context;
369 
370    \textcolor{comment}{//Point to the NDP context}
371    context = &interface->ndpContext;
372 
373    \textcolor{comment}{//Restore default parameters}
374    context->\hyperlink{structNdpContext_a572ac8209cafbc1f41949fa4031173fc}{reachableTime} = \hyperlink{ndp_8h_aedca5344875b2ae8e08ee5d794dadd7f}{NDP\_REACHABLE\_TIME};
375    context->\hyperlink{structNdpContext_a529caf9017efd6a9e5b9e546a9a0c012}{retransTimer} = \hyperlink{ndp_8h_a28f80d67a8075ff1837c693c69374445}{NDP\_RETRANS\_TIMER};
376    context->\hyperlink{structNdpContext_a47458438d295650512e889531b1e0471}{dupAddrDetectTransmits} = 
      \hyperlink{ndp_8h_aa51ff416f59404cf5b2e9bca1031313d}{NDP\_DUP\_ADDR\_DETECT\_TRANSMITS};
377    context->\hyperlink{structNdpContext_a79e43c50b5147074a654da9c242008d3}{minRtrSolicitationDelay} = 
      \hyperlink{ndp_8h_aaea9dc170a43470ae056dfa4fe59c2cc}{NDP\_MIN\_RTR\_SOLICITATION\_DELAY};
378    context->\hyperlink{structNdpContext_a5f21cd7b9fe8e523cd7b01d6274cb11c}{maxRtrSolicitationDelay} = 
      \hyperlink{ndp_8h_aabd73da3c2aca80788a052444d83b0d5}{NDP\_MAX\_RTR\_SOLICITATION\_DELAY};
379    context->\hyperlink{structNdpContext_aeb312645a94a797c2e509c4753562fb4}{rtrSolicitationInterval} = 
      \hyperlink{ndp_8h_a7a7d5a7704660da72d5e6d68cf828c20}{NDP\_RTR\_SOLICITATION\_INTERVAL};
380    context->\hyperlink{structNdpContext_aceadc715ad12f0148cdba9acba96949a}{maxRtrSolicitations} = \hyperlink{ndp_8h_a9c9a34ea3fffe3f99687de87f069b50d}{NDP\_MAX\_RTR\_SOLICITATIONS};
381 
382    \textcolor{comment}{//Reset retransmission counter for RS messages}
383    context->\hyperlink{structNdpContext_aa6eac8a31ad5f605018412cbdc75fbee}{rtrSolicitationCount} = 0;
384    \textcolor{comment}{//Valid RA message not yet received}
385    context->\hyperlink{structNdpContext_af16d6cf8472c6b3827ba500f25458579}{rtrAdvReceived} = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
386 
387    \textcolor{comment}{//Flush the Neighbor Cache}
388    \hyperlink{ndp__cache_8c_a3e78f99b9a9fd56561aa5c28dd0f4fe7}{ndpFlushNeighborCache}(interface);
389    \textcolor{comment}{//Flush the Destination Cache}
390    \hyperlink{ndp__cache_8c_a37506956e2aa6b664eef6acf9137e9ef}{ndpFlushDestCache}(interface);
391 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_abad0ce0562414e464a6509338000e462}\label{ndp_8c_abad0ce0562414e464a6509338000e462}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Process\+Neighbor\+Adv@{ndp\+Process\+Neighbor\+Adv}}
\index{ndp\+Process\+Neighbor\+Adv@{ndp\+Process\+Neighbor\+Adv}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Process\+Neighbor\+Adv()}{ndpProcessNeighborAdv()}}
{\footnotesize\ttfamily void ndp\+Process\+Neighbor\+Adv (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{hop\+Limit }\end{DoxyParamCaption})}



Neighbor Advertisement message processing. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & I\+Pv6 pseudo header \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the Neighbor Advertisement message \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first byte of the message \\
\hline
\mbox{\tt in}  & {\em hop\+Limit} & Hop Limit field from I\+Pv6 header \\
\hline
\end{DoxyParams}


Definition at line 919 of file ndp.\+c.


\begin{DoxyCode}
921 \{
922 \textcolor{preprocessor}{#if (ETH\_SUPPORT == ENABLED)}
923    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
924    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
925    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
926    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
927    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} differentLinkLayerAddr;
928    \hyperlink{ndp_8h_a2727c6d34f93db5133b4a7bf327a63a9}{NdpNeighborAdvMessage} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
929    \hyperlink{ndp_8h_a468b5bb872928c789dabecb62486ce8c}{NdpLinkLayerAddrOption} *option;
930    \hyperlink{structNdpNeighborCacheEntry}{NdpNeighborCacheEntry} *neighborCacheEntry;
931    \hyperlink{structIpv6AddrEntry}{Ipv6AddrEntry} *addrEntry;
932 
933    \textcolor{comment}{//Retrieve the length of the message}
934    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
935 
936    \textcolor{comment}{//Check the length of the Neighbor Advertisement message}
937    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a2727c6d34f93db5133b4a7bf327a63a9}{NdpNeighborAdvMessage}))
938       \textcolor{keywordflow}{return};
939 
940    \textcolor{comment}{//Point to the beginning of the message}
941    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
942    \textcolor{comment}{//Sanity check}
943    \textcolor{keywordflow}{if}(message == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
944       \textcolor{keywordflow}{return};
945 
946    \textcolor{comment}{//Debug message}
947    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Neighbor Advertisement message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      length);
948    \textcolor{comment}{//Dump message contents for debugging purpose}
949    \hyperlink{ndp_8c_a0fb3e8d27d1f9658296efe05c705d05d}{ndpDumpNeighborAdvMessage}(message);
950 
951    \textcolor{comment}{//The IPv6 Hop Limit field must have a value of 255 to ensure}
952    \textcolor{comment}{//that the packet has not been forwarded by a router}
953    \textcolor{keywordflow}{if}(hopLimit != \hyperlink{ndp_8h_aed9955a5c2a9d8b039e188d88f2bd923}{NDP\_HOP\_LIMIT})
954       \textcolor{keywordflow}{return};
955 
956    \textcolor{comment}{//ICMPv6 Code must be 0}
957    \textcolor{keywordflow}{if}(message->code)
958       \textcolor{keywordflow}{return};
959 
960    \textcolor{comment}{//The target address must not be a multicast address}
961    \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_a68fbc1145d242384c90a670196a38495}{ipv6IsMulticastAddr}(&message->targetAddr))
962    \{
963       \textcolor{comment}{//Debug message}
964       \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"Target address must not be a multicast address!\(\backslash\)r\(\backslash\)n"});
965       \textcolor{comment}{//Exit immediately}
966       \textcolor{keywordflow}{return};
967    \}
968 
969    \textcolor{comment}{//If the destination address is a multicast address}
970    \textcolor{comment}{//then the Solicited flag must be zero}
971    \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_a68fbc1145d242384c90a670196a38495}{ipv6IsMulticastAddr}(&pseudoHeader->destAddr) && message->s)
972    \{
973       \textcolor{comment}{//Debug message}
974       \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"Solicited flag must be zero!\(\backslash\)r\(\backslash\)n"});
975       \textcolor{comment}{//Exit immediately}
976       \textcolor{keywordflow}{return};
977    \}
978 
979    \textcolor{comment}{//Calculate the length of the Options field}
980    length -= \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a2727c6d34f93db5133b4a7bf327a63a9}{NdpNeighborAdvMessage});
981 
982    \textcolor{comment}{//Parse Options field}
983    error = \hyperlink{ndp__misc_8c_a91cdf966964a174f131172ae9f4582de}{ndpCheckOptions}(message->options, length);
984    \textcolor{comment}{//All included options must have a length that is greater than zero}
985    \textcolor{keywordflow}{if}(error)
986       \textcolor{keywordflow}{return};
987 
988    \textcolor{comment}{//Duplicate address detection}
989    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{ipv6_8h_aa9064306086cc3bba39cf75db3ec2881}{IPV6\_ADDR\_LIST\_SIZE}; i++)
990    \{
991       \textcolor{comment}{//Point to the current entry}
992       addrEntry = &interface->ipv6Context.addrList[i];
993 
994       \textcolor{comment}{//Valid entry?}
995       \textcolor{keywordflow}{if}(addrEntry->\hyperlink{structIpv6AddrEntry_ae4ce939ceef8a1d15ac7d11542215a0f}{state} != \hyperlink{ipv6_8h_acb54c5e2b7ee1652f5bf055e14cc518dabdf9e5bbd4cc04a803d6e63cc9992ebb}{IPV6\_ADDR\_STATE\_INVALID})
996       \{
997          \textcolor{comment}{//Check whether the target address is tentative or matches}
998          \textcolor{comment}{//a unicast address assigned to the interface}
999          \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(&addrEntry->\hyperlink{structIpv6AddrEntry_a55b2d1238731a3b4ffca6928ebb52fe0}{addr}, &message->targetAddr))
1000          \{
1001             \textcolor{comment}{//Debug message}
1002             \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"The address %s is a duplicate!\(\backslash\)r\(\backslash\)n"},
1003                \hyperlink{ipv6_8c_a96e27d88ffdf1b2ca6fca448dc6b4e7e}{ipv6AddrToString}(&addrEntry->\hyperlink{structIpv6AddrEntry_a55b2d1238731a3b4ffca6928ebb52fe0}{addr}, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
1004 
1005             \textcolor{comment}{//The address is a duplicate and should not be used}
1006             addrEntry->\hyperlink{structIpv6AddrEntry_aebcce0d3eff51b7c413e43ec5bf86282}{duplicate} = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1007             \textcolor{comment}{//Exit immediately}
1008             \textcolor{keywordflow}{return};
1009          \}
1010       \}
1011    \}
1012 
1013    \textcolor{comment}{//Search the Neighbor cache for the specified target address}
1014    neighborCacheEntry = \hyperlink{ndp__cache_8c_a4bb136704775638d094e9b9b0eab0c62}{ndpFindNeighborCacheEntry}(interface, &message->targetAddr)
      ;
1015 
1016    \textcolor{comment}{//If no entry exists, the advertisement should be silently discarded}
1017    \textcolor{keywordflow}{if}(neighborCacheEntry)
1018    \{
1019       \textcolor{comment}{//This flag tells whether the supplied link-layer}
1020       \textcolor{comment}{//address differs from that in the cache}
1021       differentLinkLayerAddr = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1022 
1023       \textcolor{comment}{//Search for the Target Link-Layer Address option}
1024       option = \hyperlink{ndp__misc_8c_a6d3addbaab223cf3eab295c590e42f35}{ndpGetOption}(message->options,
1025          length, \hyperlink{ndp_8h_af1e00e3e4e4a40cf7cc766002871bf30a9b3a7ab40eefc557d9a8e38a072727da}{NDP\_OPT\_TARGET\_LINK\_LAYER\_ADDR});
1026 
1027       \textcolor{comment}{//Target Link-Layer Address option found?}
1028       \textcolor{keywordflow}{if}(option != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && option->length == 1)
1029       \{
1030          \textcolor{comment}{//Debug message}
1031          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Target Link-Layer Address = %s\(\backslash\)r\(\backslash\)n"},
1032             \hyperlink{ethernet_8c_a9939c8165aa34316fdeb8b24258db4c4}{macAddrToString}(&option->linkLayerAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
1033 
1034          \textcolor{comment}{//Different link-layer address than cached?}
1035          \textcolor{keywordflow}{if}(!\hyperlink{ethernet_8h_a800d9f928930baf027e925976c44b9b2}{macCompAddr}(&neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr}, &option->linkLayerAddr))
1036             differentLinkLayerAddr = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1037       \}
1038 
1039       \textcolor{comment}{//INCOMPLETE state?}
1040       \textcolor{keywordflow}{if}(neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} == \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479af1920f2caebfea1b46a7e9f9439bc6f9}{NDP\_STATE\_INCOMPLETE})
1041       \{
1042          \textcolor{comment}{//If no Target Link-Layer Address option is included, the receiving}
1043          \textcolor{comment}{//node should silently discard the received advertisement}
1044          \textcolor{keywordflow}{if}(option != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && option->length == 1)
1045          \{
1046             \textcolor{comment}{//Record the link-layer address}
1047             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr} = option->linkLayerAddr;
1048             \textcolor{comment}{//Send all the packets that are pending for transmission}
1049             n = \hyperlink{ndp__cache_8c_a1691e3229a1353a430185f4c5d29c958}{ndpSendQueuedPackets}(interface, neighborCacheEntry);
1050             \textcolor{comment}{//Save current time}
1051             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
1052 
1053             \textcolor{comment}{//Solicited flag is set?}
1054             \textcolor{keywordflow}{if}(message->s)
1055             \{
1056                \textcolor{comment}{//Computing the random ReachableTime value}
1057                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a315eba9b9511bfbfc60b9559b37e7070}{timeout} = interface->ndpContext.reachableTime;
1058                \textcolor{comment}{//Switch to the REACHABLE state}
1059                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479aae3dbf31bcbade29e680b87bcef30530}{NDP\_STATE\_REACHABLE};
1060             \}
1061             \textcolor{keywordflow}{else}
1062             \{
1063                \textcolor{comment}{//Check whether any packets have been sent}
1064                \textcolor{keywordflow}{if}(n > 0)
1065                \{
1066                   \textcolor{comment}{//Start delay timer}
1067                   neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a315eba9b9511bfbfc60b9559b37e7070}{timeout} = 
      \hyperlink{ndp_8h_aec929b3037b2395eb6ac92c2bb1a8040}{NDP\_DELAY\_FIRST\_PROBE\_TIME};
1068                   \textcolor{comment}{//Switch to the DELAY state}
1069                   neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479a4aea7ed554ee132a415f75034848d922}{NDP\_STATE\_DELAY};
1070                \}
1071                \textcolor{keywordflow}{else}
1072                \{
1073                   \textcolor{comment}{//Enter the STALE state}
1074                   neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE};
1075                \}
1076             \}
1077          \}
1078       \}
1079       \textcolor{comment}{//REACHABLE, STALE, DELAY or PROBE state?}
1080       \textcolor{keywordflow}{else}
1081       \{
1082          \textcolor{comment}{//Check whether the Override flag is clear and the supplied}
1083          \textcolor{comment}{//link-layer address differs from that in the cache}
1084          \textcolor{keywordflow}{if}(!message->o && differentLinkLayerAddr)
1085          \{
1086             \textcolor{comment}{//REACHABLE state?}
1087             \textcolor{keywordflow}{if}(neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} == \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479aae3dbf31bcbade29e680b87bcef30530}{NDP\_STATE\_REACHABLE})
1088             \{
1089                \textcolor{comment}{//Save current time}
1090                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
1091                \textcolor{comment}{//Enter the STALE state}
1092                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE};
1093             \}
1094          \}
1095          \textcolor{keywordflow}{else}
1096          \{
1097             \textcolor{comment}{//Solicited flag is set?}
1098             \textcolor{keywordflow}{if}(message->s)
1099             \{
1100                \textcolor{comment}{//Different link-layer address than cached?}
1101                \textcolor{keywordflow}{if}(differentLinkLayerAddr)
1102                \{
1103                   \textcolor{comment}{//The link-layer address must be inserted in the cache}
1104                   neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr} = option->linkLayerAddr;
1105                \}
1106 
1107                \textcolor{comment}{//Save current time}
1108                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
1109                \textcolor{comment}{//Computing the random ReachableTime value}
1110                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a315eba9b9511bfbfc60b9559b37e7070}{timeout} = interface->ndpContext.reachableTime;
1111                \textcolor{comment}{//Switch to the REACHABLE state}
1112                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479aae3dbf31bcbade29e680b87bcef30530}{NDP\_STATE\_REACHABLE};
1113             \}
1114             \textcolor{keywordflow}{else}
1115             \{
1116                \textcolor{comment}{//Different link-layer address than cached?}
1117                \textcolor{keywordflow}{if}(differentLinkLayerAddr)
1118                \{
1119                   \textcolor{comment}{//The link-layer address must be inserted in the cache}
1120                   neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr} = option->linkLayerAddr;
1121                   \textcolor{comment}{//Save current time}
1122                   neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
1123                   \textcolor{comment}{//The state must be set to STALE}
1124                   neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE};
1125                \}
1126             \}
1127          \}
1128       \}
1129 
1130       \textcolor{comment}{//The IsRouter flag in the cache entry must be set based}
1131       \textcolor{comment}{//on the Router flag in the received advertisement}
1132       \textcolor{keywordflow}{if}(message->r)
1133       \{
1134          \textcolor{comment}{//The neighbor is a router}
1135          neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_af1bf52654360db588714ce7c21e20887}{isRouter} = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1136       \}
1137       \textcolor{keywordflow}{else}
1138       \{
1139          \textcolor{comment}{//Check whether the IsRouter flag changes from TRUE to FALSE}
1140          \textcolor{comment}{//as a result of this update}
1141          \textcolor{keywordflow}{if}(neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_af1bf52654360db588714ce7c21e20887}{isRouter})
1142          \{
1143             \textcolor{comment}{//The node must remove that router from the Default Router list}
1144             \textcolor{comment}{//and update the Destination cache entries for all destinations}
1145             \textcolor{comment}{//using that neighbor as a router}
1146             \hyperlink{ipv6__misc_8c_ad2b66051e8b53dffa4aba62f2241e2d1}{ipv6RemoveDefaultRouter}(interface, &neighborCacheEntry->
      \hyperlink{structNdpNeighborCacheEntry_a3c02dac138bb8d8ae45ad1de8c324221}{ipAddr});
1147          \}
1148 
1149          \textcolor{comment}{//The neighbor is a host}
1150          neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_af1bf52654360db588714ce7c21e20887}{isRouter} = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1151       \}
1152    \}
1153 \textcolor{preprocessor}{#endif}
1154 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_a48be39b562002b5c5d7e8eb49dedbd4d}\label{ndp_8c_a48be39b562002b5c5d7e8eb49dedbd4d}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Process\+Neighbor\+Sol@{ndp\+Process\+Neighbor\+Sol}}
\index{ndp\+Process\+Neighbor\+Sol@{ndp\+Process\+Neighbor\+Sol}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Process\+Neighbor\+Sol()}{ndpProcessNeighborSol()}}
{\footnotesize\ttfamily void ndp\+Process\+Neighbor\+Sol (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{hop\+Limit }\end{DoxyParamCaption})}



Neighbor Solicitation message processing. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & I\+Pv6 pseudo header \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the Neighbor Solicitation message \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first byte of the message \\
\hline
\mbox{\tt in}  & {\em hop\+Limit} & Hop Limit field from I\+Pv6 header \\
\hline
\end{DoxyParams}


Definition at line 685 of file ndp.\+c.


\begin{DoxyCode}
687 \{
688 \textcolor{preprocessor}{#if (ETH\_SUPPORT == ENABLED)}
689    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
690    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
691    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
692    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
693    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} validTarget;
694    \hyperlink{ndp_8h_a0cc069b424bfd84ee062d7d0793b174b}{NdpNeighborSolMessage} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
695    \hyperlink{ndp_8h_a468b5bb872928c789dabecb62486ce8c}{NdpLinkLayerAddrOption} *option;
696    \hyperlink{structNdpNeighborCacheEntry}{NdpNeighborCacheEntry} *neighborCacheEntry;
697    \hyperlink{structIpv6AddrEntry}{Ipv6AddrEntry} *addrEntry;
698 
699    \textcolor{comment}{//Retrieve the length of the message}
700    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
701 
702    \textcolor{comment}{//Check the length of the Neighbor Solicitation message}
703    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a0cc069b424bfd84ee062d7d0793b174b}{NdpNeighborSolMessage}))
704       \textcolor{keywordflow}{return};
705 
706    \textcolor{comment}{//Point to the beginning of the message}
707    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
708    \textcolor{comment}{//Sanity check}
709    \textcolor{keywordflow}{if}(message == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
710       \textcolor{keywordflow}{return};
711 
712    \textcolor{comment}{//Debug message}
713    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Neighbor Solicitation message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      length);
714    \textcolor{comment}{//Dump message contents for debugging purpose}
715    \hyperlink{ndp_8c_a0918093e5ba4f5738f552a2deb1395d6}{ndpDumpNeighborSolMessage}(message);
716 
717    \textcolor{comment}{//The IPv6 Hop Limit field must have a value of 255 to ensure}
718    \textcolor{comment}{//that the packet has not been forwarded by a router}
719    \textcolor{keywordflow}{if}(hopLimit != \hyperlink{ndp_8h_aed9955a5c2a9d8b039e188d88f2bd923}{NDP\_HOP\_LIMIT})
720       \textcolor{keywordflow}{return};
721 
722    \textcolor{comment}{//ICMPv6 Code must be 0}
723    \textcolor{keywordflow}{if}(message->code)
724       \textcolor{keywordflow}{return};
725 
726    \textcolor{comment}{//If the IP source address is the unspecified address, the IP}
727    \textcolor{comment}{//destination address must be a solicited-node multicast address}
728    \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(&pseudoHeader->srcAddr, &\hyperlink{ipv6_8c_aa4baeec4f7b8b166d2457787fb9eddf9}{IPV6\_UNSPECIFIED\_ADDR}) &&
729       !\hyperlink{ipv6_8h_a08377a39aab25a662252bcea6e945a64}{ipv6IsSolicitedNodeAddr}(&pseudoHeader->destAddr))
730    \{
731       \textcolor{comment}{//Debug message}
732       \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"Destination address must be a solicited-node address!\(\backslash\)r\(\backslash\)n"});
733       \textcolor{comment}{//Exit immediately}
734       \textcolor{keywordflow}{return};
735    \}
736 
737    \textcolor{comment}{//Calculate the length of the Options field}
738    length -= \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a0cc069b424bfd84ee062d7d0793b174b}{NdpNeighborSolMessage});
739 
740    \textcolor{comment}{//Parse Options field}
741    error = \hyperlink{ndp__misc_8c_a91cdf966964a174f131172ae9f4582de}{ndpCheckOptions}(message->options, length);
742    \textcolor{comment}{//All included options must have a length that is greater than zero}
743    \textcolor{keywordflow}{if}(error)
744       \textcolor{keywordflow}{return};
745 
746    \textcolor{comment}{//Search for the Source Link-Layer Address option}
747    option = \hyperlink{ndp__misc_8c_a6d3addbaab223cf3eab295c590e42f35}{ndpGetOption}(message->options,
748       length, \hyperlink{ndp_8h_af1e00e3e4e4a40cf7cc766002871bf30a605af3b2b6f92741d213e15ec8bf7148}{NDP\_OPT\_SOURCE\_LINK\_LAYER\_ADDR});
749 
750    \textcolor{comment}{//The target address must a valid unicast or anycast address assigned to}
751    \textcolor{comment}{//the interface or a tentative address on which DAD is being performed}
752    validTarget = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
753 
754    \textcolor{comment}{//Loop through the IPv6 addresses assigned to the interface}
755    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{ipv6_8h_aa9064306086cc3bba39cf75db3ec2881}{IPV6\_ADDR\_LIST\_SIZE}; i++)
756    \{
757       \textcolor{comment}{//Point to the current entry}
758       addrEntry = &interface->ipv6Context.addrList[i];
759 
760       \textcolor{comment}{//Compare target address}
761       \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(&addrEntry->\hyperlink{structIpv6AddrEntry_a55b2d1238731a3b4ffca6928ebb52fe0}{addr}, &message->targetAddr))
762       \{
763          \textcolor{comment}{//Check address state}
764          \textcolor{keywordflow}{if}(addrEntry->\hyperlink{structIpv6AddrEntry_ae4ce939ceef8a1d15ac7d11542215a0f}{state} == \hyperlink{ipv6_8h_acb54c5e2b7ee1652f5bf055e14cc518dacb3152ea8c90d13a425042070b987fe6}{IPV6\_ADDR\_STATE\_TENTATIVE})
765          \{
766             \textcolor{comment}{//If the source address of the Neighbor Solicitation is the}
767             \textcolor{comment}{//unspecified address, the solicitation is from a node}
768             \textcolor{comment}{//performing Duplicate Address Detection}
769             \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(&pseudoHeader->srcAddr, &
      \hyperlink{ipv6_8c_aa4baeec4f7b8b166d2457787fb9eddf9}{IPV6\_UNSPECIFIED\_ADDR}))
770             \{
771                \textcolor{comment}{//The source link-layer address must not be included when the}
772                \textcolor{comment}{//source IP address is the unspecified address...}
773                \textcolor{keywordflow}{if}(option == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
774                \{
775                   \textcolor{comment}{//Debug message}
776                   \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"The tentative address %s is a duplicate!\(\backslash\)r\(\backslash\)n"},
777                      \hyperlink{ipv6_8c_a96e27d88ffdf1b2ca6fca448dc6b4e7e}{ipv6AddrToString}(&addrEntry->\hyperlink{structIpv6AddrEntry_a55b2d1238731a3b4ffca6928ebb52fe0}{addr}, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
778 
779                   \textcolor{comment}{//The tentative address is a duplicate and should not be used}
780                   addrEntry->\hyperlink{structIpv6AddrEntry_aebcce0d3eff51b7c413e43ec5bf86282}{duplicate} = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
781                \}
782             \}
783 
784             \textcolor{comment}{//In all cases, a node must not respond to a Neighbor Solicitation}
785             \textcolor{comment}{//for a tentative address}
786             \textcolor{keywordflow}{return};
787          \}
788          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(addrEntry->\hyperlink{structIpv6AddrEntry_ae4ce939ceef8a1d15ac7d11542215a0f}{state} != \hyperlink{ipv6_8h_acb54c5e2b7ee1652f5bf055e14cc518dabdf9e5bbd4cc04a803d6e63cc9992ebb}{IPV6\_ADDR\_STATE\_INVALID})
789          \{
790             \textcolor{comment}{//The target address is a valid address assigned to the interface}
791             validTarget = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
792             \textcolor{comment}{//We are done}
793             \textcolor{keywordflow}{break};
794          \}
795       \}
796    \}
797 
798    \textcolor{comment}{//Invalid target address?}
799    \textcolor{keywordflow}{if}(!validTarget)
800    \{
801       \textcolor{comment}{//The Neighbor Solicitation must be discarded if the target address}
802       \textcolor{comment}{//is not a valid anycast address assigned to the interface}
803       \textcolor{keywordflow}{if}(!\hyperlink{ipv6__misc_8c_a7448bedb5edff0df8029ca8b5c6d994d}{ipv6IsAnycastAddr}(interface, &message->targetAddr))
804       \{
805          \textcolor{comment}{//Debug message}
806          \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"Wrong target address!\(\backslash\)r\(\backslash\)n"});
807          \textcolor{comment}{//Exit immediately}
808          \textcolor{keywordflow}{return};
809       \}
810    \}
811 
812    \textcolor{comment}{//Source Link-Layer Address option found?}
813    \textcolor{keywordflow}{if}(option != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && option->length == 1)
814    \{
815       \textcolor{comment}{//Debug message}
816       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Source Link-Layer Address = %s\(\backslash\)r\(\backslash\)n"},
817          \hyperlink{ethernet_8c_a9939c8165aa34316fdeb8b24258db4c4}{macAddrToString}(&option->linkLayerAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
818 
819       \textcolor{comment}{//The Source Link-Layer Address option must not be included when the}
820       \textcolor{comment}{//source IP address is the unspecified address}
821       \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(&pseudoHeader->srcAddr, &\hyperlink{ipv6_8c_aa4baeec4f7b8b166d2457787fb9eddf9}{IPV6\_UNSPECIFIED\_ADDR}))
822          \textcolor{keywordflow}{return};
823 
824       \textcolor{comment}{//Search the Neighbor Cache for the source address of the solicitation}
825       neighborCacheEntry = \hyperlink{ndp__cache_8c_a4bb136704775638d094e9b9b0eab0c62}{ndpFindNeighborCacheEntry}(interface, &pseudoHeader->
      srcAddr);
826 
827       \textcolor{comment}{//No matching entry has been found?}
828       \textcolor{keywordflow}{if}(!neighborCacheEntry)
829       \{
830          \textcolor{comment}{//Create an entry}
831          neighborCacheEntry = \hyperlink{ndp__cache_8c_aa10560ab298b818966ff62cf4493b0e5}{ndpCreateNeighborCacheEntry}(interface);
832 
833          \textcolor{comment}{//Neighbor Cache entry successfully created?}
834          \textcolor{keywordflow}{if}(neighborCacheEntry)
835          \{
836             \textcolor{comment}{//Record the IPv6 and the corresponding MAC address}
837             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a3c02dac138bb8d8ae45ad1de8c324221}{ipAddr} = pseudoHeader->srcAddr;
838             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr} = option->linkLayerAddr;
839             \textcolor{comment}{//Save current time}
840             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
841             \textcolor{comment}{//Enter the STALE state}
842             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE};
843          \}
844       \}
845       \textcolor{keywordflow}{else}
846       \{
847          \textcolor{comment}{//INCOMPLETE state?}
848          \textcolor{keywordflow}{if}(neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} == \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479af1920f2caebfea1b46a7e9f9439bc6f9}{NDP\_STATE\_INCOMPLETE})
849          \{
850             \textcolor{comment}{//Record link-layer address}
851             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr} = option->linkLayerAddr;
852             \textcolor{comment}{//Send all the packets that are pending for transmission}
853             n = \hyperlink{ndp__cache_8c_a1691e3229a1353a430185f4c5d29c958}{ndpSendQueuedPackets}(interface, neighborCacheEntry);
854             \textcolor{comment}{//Save current time}
855             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
856 
857             \textcolor{comment}{//Check whether any packets have been sent}
858             \textcolor{keywordflow}{if}(n > 0)
859             \{
860                \textcolor{comment}{//Start delay timer}
861                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a315eba9b9511bfbfc60b9559b37e7070}{timeout} = \hyperlink{ndp_8h_aec929b3037b2395eb6ac92c2bb1a8040}{NDP\_DELAY\_FIRST\_PROBE\_TIME};
862                \textcolor{comment}{//Switch to the DELAY state}
863                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479a4aea7ed554ee132a415f75034848d922}{NDP\_STATE\_DELAY};
864             \}
865             \textcolor{keywordflow}{else}
866             \{
867                \textcolor{comment}{//Enter the STALE state}
868                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE};
869             \}
870          \}
871          \textcolor{comment}{//REACHABLE, STALE, DELAY or PROBE state?}
872          \textcolor{keywordflow}{else}
873          \{
874             \textcolor{comment}{//Different link-layer address than cached?}
875             \textcolor{keywordflow}{if}(!\hyperlink{ethernet_8h_a800d9f928930baf027e925976c44b9b2}{macCompAddr}(&neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr}, &option->linkLayerAddr))
876             \{
877                \textcolor{comment}{//Update link-layer address}
878                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr} = option->linkLayerAddr;
879                \textcolor{comment}{//Save current time}
880                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
881                \textcolor{comment}{//Enter the STALE state}
882                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE};
883             \}
884          \}
885       \}
886    \}
887    \textcolor{comment}{//Source Link-Layer Address option not found?}
888    \textcolor{keywordflow}{else}
889    \{
890       \textcolor{comment}{//The Source Link-Layer Address option must not be included when the}
891       \textcolor{comment}{//source IP address is the unspecified address. Otherwise, this option}
892       \textcolor{comment}{//must be included in multicast solicitations}
893       \textcolor{keywordflow}{if}(!\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(&pseudoHeader->srcAddr, &
      \hyperlink{ipv6_8c_aa4baeec4f7b8b166d2457787fb9eddf9}{IPV6\_UNSPECIFIED\_ADDR}) &&
894          \hyperlink{ipv6_8h_a68fbc1145d242384c90a670196a38495}{ipv6IsMulticastAddr}(&pseudoHeader->destAddr))
895       \{
896          \textcolor{comment}{//Debug message}
897          \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"The Source Link-Layer Address must be included!\(\backslash\)r\(\backslash\)n"});
898          \textcolor{comment}{//Exit immediately}
899          \textcolor{keywordflow}{return};
900       \}
901    \}
902 
903    \textcolor{comment}{//After any updates to the Neighbor cache, the node sends a Neighbor}
904    \textcolor{comment}{//Advertisement response as described in RFC 4861 7.2.4}
905    \hyperlink{ndp_8c_a469e0954e29d4f66705088abcbbdd28a}{ndpSendNeighborAdv}(interface, &message->targetAddr, &pseudoHeader->srcAddr);
906 \textcolor{preprocessor}{#endif}
907 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_a9a209b57eb8f84ac34d0eeea736a2aff}\label{ndp_8c_a9a209b57eb8f84ac34d0eeea736a2aff}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Process\+Redirect@{ndp\+Process\+Redirect}}
\index{ndp\+Process\+Redirect@{ndp\+Process\+Redirect}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Process\+Redirect()}{ndpProcessRedirect()}}
{\footnotesize\ttfamily void ndp\+Process\+Redirect (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{hop\+Limit }\end{DoxyParamCaption})}



Redirect message processing. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & I\+Pv6 pseudo header \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the Redirect message \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first byte of the message \\
\hline
\mbox{\tt in}  & {\em hop\+Limit} & Hop Limit field from I\+Pv6 header \\
\hline
\end{DoxyParams}


Definition at line 1166 of file ndp.\+c.


\begin{DoxyCode}
1168 \{
1169 \textcolor{preprocessor}{#if (ETH\_SUPPORT == ENABLED)}
1170    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1171    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1172    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1173    \hyperlink{ndp_8h_ad7f7873e6eed24c49155b65903f51801}{NdpRedirectMessage} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
1174    \hyperlink{ndp_8h_a468b5bb872928c789dabecb62486ce8c}{NdpLinkLayerAddrOption} *option;
1175    \hyperlink{structNdpNeighborCacheEntry}{NdpNeighborCacheEntry} *neighborCacheEntry;
1176    \hyperlink{structNdpDestCacheEntry}{NdpDestCacheEntry} *destCacheEntry;
1177 
1178    \textcolor{comment}{//Retrieve the length of the message}
1179    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
1180 
1181    \textcolor{comment}{//Check the length of the Redirect message}
1182    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_ad7f7873e6eed24c49155b65903f51801}{NdpRedirectMessage}))
1183       \textcolor{keywordflow}{return};
1184 
1185    \textcolor{comment}{//Point to the beginning of the message}
1186    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
1187    \textcolor{comment}{//Sanity check}
1188    \textcolor{keywordflow}{if}(message == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1189       \textcolor{keywordflow}{return};
1190 
1191    \textcolor{comment}{//Debug message}
1192    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Redirect message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
1193    \textcolor{comment}{//Dump message contents for debugging purpose}
1194    \hyperlink{ndp_8c_a0c9cf9bc419ac9ebd3bdcd13ccae9060}{ndpDumpRedirectMessage}(message);
1195 
1196    \textcolor{comment}{//The IPv6 Hop Limit field must have a value of 255 to ensure}
1197    \textcolor{comment}{//that the packet has not been forwarded by a router}
1198    \textcolor{keywordflow}{if}(hopLimit != \hyperlink{ndp_8h_aed9955a5c2a9d8b039e188d88f2bd923}{NDP\_HOP\_LIMIT})
1199       \textcolor{keywordflow}{return};
1200 
1201    \textcolor{comment}{//ICMPv6 Code must be 0}
1202    \textcolor{keywordflow}{if}(message->code)
1203       \textcolor{keywordflow}{return};
1204 
1205    \textcolor{comment}{//Routers must use their link-local address as the source for Redirect}
1206    \textcolor{comment}{//messages so that hosts can uniquely identify routers}
1207    \textcolor{keywordflow}{if}(!\hyperlink{ipv6_8h_a6f8d54c7cac75d512f6311e6f34e04ee}{ipv6IsLinkLocalUnicastAddr}(&pseudoHeader->srcAddr))
1208       \textcolor{keywordflow}{return};
1209 
1210    \textcolor{comment}{//The IP source address of the Redirect must be the same as the current}
1211    \textcolor{comment}{//first-hop router for the specified Destination address}
1212    \textcolor{keywordflow}{if}(!\hyperlink{ndp__misc_8c_ab02536abae3654c6c0c86df994035966}{ndpIsFirstHopRouter}(interface, &message->destAddr, &pseudoHeader->srcAddr))
1213       \textcolor{keywordflow}{return};
1214 
1215    \textcolor{comment}{//The Destination Address field in the Redirect message must not}
1216    \textcolor{comment}{//contain a multicast address}
1217    \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_a68fbc1145d242384c90a670196a38495}{ipv6IsMulticastAddr}(&message->destAddr))
1218       \textcolor{keywordflow}{return};
1219 
1220    \textcolor{comment}{//The Target Address must be either a link-local address (when redirected}
1221    \textcolor{comment}{//to a router) or the same as the Destination Address (when redirected to}
1222    \textcolor{comment}{//the on-link destination)}
1223    \textcolor{keywordflow}{if}(!\hyperlink{ipv6_8h_a6f8d54c7cac75d512f6311e6f34e04ee}{ipv6IsLinkLocalUnicastAddr}(&message->targetAddr) &&
1224       !\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(&message->targetAddr, &message->destAddr))
1225    \{
1226       \textcolor{comment}{//Silently discard the received Redirect message}
1227       \textcolor{keywordflow}{return};
1228    \}
1229 
1230    \textcolor{comment}{//Calculate the length of the Options field}
1231    length -= \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a2727c6d34f93db5133b4a7bf327a63a9}{NdpNeighborAdvMessage});
1232 
1233    \textcolor{comment}{//Parse Options field}
1234    error = \hyperlink{ndp__misc_8c_a91cdf966964a174f131172ae9f4582de}{ndpCheckOptions}(message->options, length);
1235    \textcolor{comment}{//All included options must have a length that is greater than zero}
1236    \textcolor{keywordflow}{if}(error)
1237       \textcolor{keywordflow}{return};
1238 
1239    \textcolor{comment}{//Search the Destination cache for the specified address}
1240    destCacheEntry = \hyperlink{ndp__cache_8c_a8fff27f53999959c6e2964700774a25d}{ndpFindDestCacheEntry}(interface, &message->destAddr);
1241 
1242    \textcolor{comment}{//Check whether a corresponding Destination cache entry exists}
1243    \textcolor{keywordflow}{if}(destCacheEntry)
1244    \{
1245       \textcolor{comment}{//The entry is updated with information learned from Redirect messages}
1246       destCacheEntry->\hyperlink{structNdpDestCacheEntry_ad4faeec940b627f2b0c73d298fb2e605}{nextHop} = message->targetAddr;
1247       \textcolor{comment}{//Save current time}
1248       destCacheEntry->\hyperlink{structNdpDestCacheEntry_a8474c35e89cb368fafe1e73ce9210f34}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
1249    \}
1250    \textcolor{keywordflow}{else}
1251    \{
1252       \textcolor{comment}{//If no Destination Cache entry exists for the destination, an}
1253       \textcolor{comment}{//implementation should create such an entry}
1254       destCacheEntry = \hyperlink{ndp__cache_8c_af21f9dcd84454d9cda4e48a2bf227c92}{ndpCreateDestCacheEntry}(interface);
1255 
1256       \textcolor{comment}{//Destination cache entry successfully created?}
1257       \textcolor{keywordflow}{if}(destCacheEntry)
1258       \{
1259          \textcolor{comment}{//Destination address}
1260          destCacheEntry->\hyperlink{structNdpDestCacheEntry_a7ae9c14d0f1debbf7e5a756d4edb20ff}{destAddr} = message->destAddr;
1261          \textcolor{comment}{//Address of the next hop}
1262          destCacheEntry->\hyperlink{structNdpDestCacheEntry_ad4faeec940b627f2b0c73d298fb2e605}{nextHop} = message->targetAddr;
1263 
1264          \textcolor{comment}{//Initially, the PMTU value for a path is assumed to be}
1265          \textcolor{comment}{//the MTU of the first-hop link}
1266          destCacheEntry->\hyperlink{structNdpDestCacheEntry_aa9f02a7bf3d1a681861c8affd54e0354}{pathMtu} = interface->ipv6Context.linkMtu;
1267 
1268          \textcolor{comment}{//Save current time}
1269          destCacheEntry->\hyperlink{structNdpDestCacheEntry_a8474c35e89cb368fafe1e73ce9210f34}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
1270       \}
1271    \}
1272 
1273    \textcolor{comment}{//Search for the Target Link-Layer Address option}
1274    option = \hyperlink{ndp__misc_8c_a6d3addbaab223cf3eab295c590e42f35}{ndpGetOption}(message->options,
1275       length, \hyperlink{ndp_8h_af1e00e3e4e4a40cf7cc766002871bf30a9b3a7ab40eefc557d9a8e38a072727da}{NDP\_OPT\_TARGET\_LINK\_LAYER\_ADDR});
1276 
1277    \textcolor{comment}{//If the Redirect contains a Target Link-Layer Address option, the host}
1278    \textcolor{comment}{//either creates or updates the Neighbor Cache entry for the target}
1279    \textcolor{keywordflow}{if}(option != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && option->length == 1)
1280    \{
1281       \textcolor{comment}{//Debug message}
1282       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Target Link-Layer Address = %s\(\backslash\)r\(\backslash\)n"},
1283          \hyperlink{ethernet_8c_a9939c8165aa34316fdeb8b24258db4c4}{macAddrToString}(&option->linkLayerAddr, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
1284 
1285       \textcolor{comment}{//Search the Neighbor cache for the specified target address}
1286       neighborCacheEntry = \hyperlink{ndp__cache_8c_a4bb136704775638d094e9b9b0eab0c62}{ndpFindNeighborCacheEntry}(interface, &message->
      targetAddr);
1287 
1288       \textcolor{comment}{//No matching entry has been found?}
1289       \textcolor{keywordflow}{if}(!neighborCacheEntry)
1290       \{
1291          \textcolor{comment}{//Create an entry for the target}
1292          neighborCacheEntry = \hyperlink{ndp__cache_8c_aa10560ab298b818966ff62cf4493b0e5}{ndpCreateNeighborCacheEntry}(interface);
1293 
1294          \textcolor{comment}{//Neighbor cache entry successfully created?}
1295          \textcolor{keywordflow}{if}(neighborCacheEntry)
1296          \{
1297             \textcolor{comment}{//Record the Target address}
1298             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a3c02dac138bb8d8ae45ad1de8c324221}{ipAddr} = message->targetAddr;
1299             \textcolor{comment}{//The cached link-layer address is copied from the option}
1300             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr} = option->linkLayerAddr;
1301             \textcolor{comment}{//Newly created Neighbor Cache entries should set the IsRouter flag to FALSE}
1302             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_af1bf52654360db588714ce7c21e20887}{isRouter} = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1303             \textcolor{comment}{//Save current time}
1304             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
1305             \textcolor{comment}{//The reachability state must be set to STALE}
1306             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE};
1307          \}
1308       \}
1309       \textcolor{keywordflow}{else}
1310       \{
1311          \textcolor{comment}{//If the Target Address is not the same as the Destination Address,}
1312          \textcolor{comment}{//the host must set IsRouter to TRUE for the target}
1313          \textcolor{keywordflow}{if}(!\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(&message->targetAddr, &message->destAddr))
1314             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_af1bf52654360db588714ce7c21e20887}{isRouter} = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1315 
1316          \textcolor{comment}{//INCOMPLETE state?}
1317          \textcolor{keywordflow}{if}(neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} == \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479af1920f2caebfea1b46a7e9f9439bc6f9}{NDP\_STATE\_INCOMPLETE})
1318          \{
1319             \textcolor{comment}{//Record link-layer address}
1320             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr} = option->linkLayerAddr;
1321             \textcolor{comment}{//Send all the packets that are pending for transmission}
1322             n = \hyperlink{ndp__cache_8c_a1691e3229a1353a430185f4c5d29c958}{ndpSendQueuedPackets}(interface, neighborCacheEntry);
1323             \textcolor{comment}{//Save current time}
1324             neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
1325 
1326             \textcolor{comment}{//Check whether any packets have been sent}
1327             \textcolor{keywordflow}{if}(n > 0)
1328             \{
1329                \textcolor{comment}{//Start delay timer}
1330                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a315eba9b9511bfbfc60b9559b37e7070}{timeout} = \hyperlink{ndp_8h_aec929b3037b2395eb6ac92c2bb1a8040}{NDP\_DELAY\_FIRST\_PROBE\_TIME};
1331                \textcolor{comment}{//Switch to the DELAY state}
1332                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479a4aea7ed554ee132a415f75034848d922}{NDP\_STATE\_DELAY};
1333             \}
1334             \textcolor{keywordflow}{else}
1335             \{
1336                \textcolor{comment}{//Enter the STALE state}
1337                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE};
1338             \}
1339          \}
1340          \textcolor{comment}{//REACHABLE, STALE, DELAY or PROBE state?}
1341          \textcolor{keywordflow}{else}
1342          \{
1343             \textcolor{comment}{//Different link-layer address than cached?}
1344             \textcolor{keywordflow}{if}(!\hyperlink{ethernet_8h_a800d9f928930baf027e925976c44b9b2}{macCompAddr}(&neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr}, &option->linkLayerAddr))
1345             \{
1346                \textcolor{comment}{//Update link-layer address}
1347                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr} = option->linkLayerAddr;
1348                \textcolor{comment}{//Save current time}
1349                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
1350                \textcolor{comment}{//The reachability state must be set to STALE}
1351                neighborCacheEntry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE};
1352             \}
1353          \}
1354       \}
1355    \}
1356 \textcolor{preprocessor}{#endif}
1357 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_aa7051fe044957e8df3367770d7431581}\label{ndp_8c_aa7051fe044957e8df3367770d7431581}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Process\+Router\+Adv@{ndp\+Process\+Router\+Adv}}
\index{ndp\+Process\+Router\+Adv@{ndp\+Process\+Router\+Adv}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Process\+Router\+Adv()}{ndpProcessRouterAdv()}}
{\footnotesize\ttfamily void ndp\+Process\+Router\+Adv (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6\+Pseudo\+Header} $\ast$}]{pseudo\+Header,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{hop\+Limit }\end{DoxyParamCaption})}



Router Advertisement message processing. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em pseudo\+Header} & I\+Pv6 pseudo header \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the Router Advertisement message \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first byte of the message \\
\hline
\mbox{\tt in}  & {\em hop\+Limit} & Hop Limit field from I\+Pv6 header \\
\hline
\end{DoxyParams}


Definition at line 403 of file ndp.\+c.


\begin{DoxyCode}
405 \{
406    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
407    \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
408    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
409    \hyperlink{ndp_8h_ad4e8bce6eb079bfe6e7681a6f6488c1e}{NdpRouterAdvMessage} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
410    \hyperlink{ndp_8h_afd8ec0d73acceaa61a42cf76985bf7c9}{NdpMtuOption} *mtuOption;
411    \hyperlink{ndp_8h_a7da4a31f2fe9a81aabb5dfd8979ec3a6}{NdpPrefixInfoOption} *prefixInfoOption;
412 \textcolor{preprocessor}{#if (ETH\_SUPPORT == ENABLED)}
413    \hyperlink{ndp_8h_a468b5bb872928c789dabecb62486ce8c}{NdpLinkLayerAddrOption} *linkLayerAddrOption;
414    \hyperlink{structNdpNeighborCacheEntry}{NdpNeighborCacheEntry} *entry;
415 \textcolor{preprocessor}{#endif}
416 
417    \textcolor{comment}{//Retrieve the length of the message}
418    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
419 
420    \textcolor{comment}{//Check the length of the Router Advertisement message}
421    \textcolor{keywordflow}{if}(length < \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_ad4e8bce6eb079bfe6e7681a6f6488c1e}{NdpRouterAdvMessage}))
422       \textcolor{keywordflow}{return};
423 
424    \textcolor{comment}{//Point to the beginning of the message}
425    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset});
426    \textcolor{comment}{//Sanity check}
427    \textcolor{keywordflow}{if}(message == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
428       \textcolor{keywordflow}{return};
429 
430    \textcolor{comment}{//Debug message}
431    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Router Advertisement message received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      length);
432    \textcolor{comment}{//Dump message contents for debugging purpose}
433    \hyperlink{ndp_8c_a20c2cb4ecad744ec1fb6db91f6f2787e}{ndpDumpRouterAdvMessage}(message);
434 
435    \textcolor{comment}{//Routers must use their link-local address as the source for the}
436    \textcolor{comment}{//Router Advertisement so that hosts can uniquely identify routers}
437    \textcolor{keywordflow}{if}(!\hyperlink{ipv6_8h_a6f8d54c7cac75d512f6311e6f34e04ee}{ipv6IsLinkLocalUnicastAddr}(&pseudoHeader->srcAddr))
438       \textcolor{keywordflow}{return};
439 
440    \textcolor{comment}{//The IPv6 Hop Limit field must have a value of 255 to ensure}
441    \textcolor{comment}{//that the packet has not been forwarded by a router}
442    \textcolor{keywordflow}{if}(hopLimit != \hyperlink{ndp_8h_aed9955a5c2a9d8b039e188d88f2bd923}{NDP\_HOP\_LIMIT})
443       \textcolor{keywordflow}{return};
444 
445    \textcolor{comment}{//ICMPv6 Code must be 0. An advertisement that passes the validity}
446    \textcolor{comment}{//checks is called a valid advertisement}
447    \textcolor{keywordflow}{if}(message->code)
448       \textcolor{keywordflow}{return};
449 
450    \textcolor{comment}{//Calculate the length of the Options field}
451    length -= \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_ad4e8bce6eb079bfe6e7681a6f6488c1e}{NdpRouterAdvMessage});
452 
453    \textcolor{comment}{//Parse Options field}
454    error = \hyperlink{ndp__misc_8c_a91cdf966964a174f131172ae9f4582de}{ndpCheckOptions}(message->options, length);
455    \textcolor{comment}{//All included options must have a length that is greater than zero}
456    \textcolor{keywordflow}{if}(error)
457       \textcolor{keywordflow}{return};
458 
459    \textcolor{comment}{//Check the Router Lifetime value}
460    \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->routerLifetime) != 0)
461    \{
462       \textcolor{comment}{//Add a new entry in the Default Router List}
463       \hyperlink{ipv6__misc_8c_a527a66aa974432cc0f42726426408c49}{ipv6AddDefaultRouter}(interface, &pseudoHeader->srcAddr,
464          \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(message->routerLifetime), message->prf);
465 
466       \textcolor{comment}{//The host should send at least one solicitation in the case where}
467       \textcolor{comment}{//an advertisement is received prior to having sent a solicitation}
468       \textcolor{keywordflow}{if}(interface->ndpContext.rtrSolicitationCount > 1)
469       \{
470          \textcolor{comment}{//Once the host sends a Router Solicitation, and receives a valid}
471          \textcolor{comment}{//Router Advertisement with a non-zero Router Lifetime, the host must}
472          \textcolor{comment}{//desist from sending additional solicitations on that interface}
473          interface->ndpContext.rtrAdvReceived = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
474       \}
475    \}
476    \textcolor{keywordflow}{else}
477    \{
478       \textcolor{comment}{//Immediately time-out the entry}
479       \hyperlink{ipv6__misc_8c_ad2b66051e8b53dffa4aba62f2241e2d1}{ipv6RemoveDefaultRouter}(interface, &pseudoHeader->srcAddr);
480    \}
481 
482    \textcolor{comment}{//6LoWPAN interface?}
483    \textcolor{keywordflow}{if}(interface->nicDriver != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} &&
484       interface->nicDriver->type == \hyperlink{nic_8h_ac1ce8659a9797513ecd9cc1afedce40ba5b85ff07103ab20b9b081b4b263619ea}{NIC\_TYPE\_6LOWPAN})
485    \{
486       \textcolor{comment}{//In all cases, the Router Solicitation retransmissions are terminated}
487       \textcolor{comment}{//when a Router Advertisement is received (refer to RFC 6675 5.3)}
488       interface->ndpContext.rtrAdvReceived = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
489    \}
490 
491    \textcolor{comment}{//A Router Advertisement field (Cur Hop Limit, Reachable Time, and}
492    \textcolor{comment}{//Retrans Timer) may contain a value denoting that it is unspecified.}
493    \textcolor{comment}{//In such cases, the parameter should be ignored and the host should}
494    \textcolor{comment}{//continue using whatever value it is already using}
495    \textcolor{keywordflow}{if}(message->curHopLimit != 0)
496    \{
497       \textcolor{comment}{//Get the default value that should be placed in the Hop Count}
498       \textcolor{comment}{//field of the IP header for outgoing IP packets}
499       interface->ipv6Context.curHopLimit = message->curHopLimit;
500    \}
501 
502    \textcolor{comment}{//A value of zero means unspecified...}
503    \textcolor{keywordflow}{if}(message->reachableTime != 0)
504    \{
505       \textcolor{comment}{//The Reachable Time field holds the time, in milliseconds, that}
506       \textcolor{comment}{//a node assumes a neighbor is reachable after having received a}
507       \textcolor{comment}{//reachability confirmation}
508       interface->ndpContext.reachableTime = \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(message->reachableTime);
509    \}
510 
511    \textcolor{comment}{//A value of zero means unspecified...}
512    \textcolor{keywordflow}{if}(message->retransTimer != 0)
513    \{
514       \textcolor{comment}{//The Retrans Timer field holds the time, in milliseconds,}
515       \textcolor{comment}{//between retransmitted Neighbor Solicitation messages}
516       interface->ndpContext.retransTimer = \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(message->retransTimer);
517    \}
518 
519 \textcolor{preprocessor}{#if (ETH\_SUPPORT == ENABLED)}
520    \textcolor{comment}{//Search for the Source Link-Layer Address option}
521    linkLayerAddrOption = \hyperlink{ndp__misc_8c_a6d3addbaab223cf3eab295c590e42f35}{ndpGetOption}(message->options,
522       length, \hyperlink{ndp_8h_af1e00e3e4e4a40cf7cc766002871bf30a605af3b2b6f92741d213e15ec8bf7148}{NDP\_OPT\_SOURCE\_LINK\_LAYER\_ADDR});
523 
524    \textcolor{comment}{//Source Link-Layer Address option found?}
525    \textcolor{keywordflow}{if}(linkLayerAddrOption != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && linkLayerAddrOption->length == 1)
526    \{
527       \textcolor{comment}{//Debug message}
528       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Source Link-Layer Address = %s\(\backslash\)r\(\backslash\)n"},
529          \hyperlink{ethernet_8c_a9939c8165aa34316fdeb8b24258db4c4}{macAddrToString}(&linkLayerAddrOption->linkLayerAddr, 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
530    \}
531    \textcolor{keywordflow}{else}
532    \{
533       \textcolor{comment}{//No valid Source Link-Layer Address option...}
534       linkLayerAddrOption = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
535    \}
536 
537    \textcolor{comment}{//Search the Neighbor cache for the router}
538    entry = \hyperlink{ndp__cache_8c_a4bb136704775638d094e9b9b0eab0c62}{ndpFindNeighborCacheEntry}(interface, &pseudoHeader->srcAddr);
539 
540    \textcolor{comment}{//No matching entry has been found?}
541    \textcolor{keywordflow}{if}(!entry)
542    \{
543       \textcolor{comment}{//If the advertisement contains a Source Link-Layer Address option,}
544       \textcolor{comment}{//the link-layer address should be recorded in the Neighbor cache}
545       \textcolor{keywordflow}{if}(linkLayerAddrOption)
546       \{
547          \textcolor{comment}{//Create an entry for the router}
548          entry = \hyperlink{ndp__cache_8c_aa10560ab298b818966ff62cf4493b0e5}{ndpCreateNeighborCacheEntry}(interface);
549 
550          \textcolor{comment}{//Neighbor cache entry successfully created?}
551          \textcolor{keywordflow}{if}(entry)
552          \{
553             \textcolor{comment}{//Record the IPv6 address and the corresponding MAC address}
554             entry->\hyperlink{structNdpNeighborCacheEntry_a3c02dac138bb8d8ae45ad1de8c324221}{ipAddr} = pseudoHeader->srcAddr;
555             entry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr} = linkLayerAddrOption->linkLayerAddr;
556             \textcolor{comment}{//The IsRouter flag must be set to TRUE}
557             entry->\hyperlink{structNdpNeighborCacheEntry_af1bf52654360db588714ce7c21e20887}{isRouter} = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
558             \textcolor{comment}{//Save current time}
559             entry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
560             \textcolor{comment}{//The reachability state must be set to STALE}
561             entry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE};
562          \}
563       \}
564    \}
565    \textcolor{keywordflow}{else}
566    \{
567       \textcolor{comment}{//The sender of a Router Advertisement is implicitly assumed to be a router}
568       entry->\hyperlink{structNdpNeighborCacheEntry_af1bf52654360db588714ce7c21e20887}{isRouter} = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
569 
570       \textcolor{comment}{//Check if the advertisement contains a Source Link-Layer Address option}
571       \textcolor{keywordflow}{if}(linkLayerAddrOption)
572       \{
573          \textcolor{comment}{//INCOMPLETE state?}
574          \textcolor{keywordflow}{if}(entry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} == \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479af1920f2caebfea1b46a7e9f9439bc6f9}{NDP\_STATE\_INCOMPLETE})
575          \{
576             \textcolor{comment}{//Record link-layer address}
577             entry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr} = linkLayerAddrOption->linkLayerAddr;
578             \textcolor{comment}{//Send all the packets that are pending for transmission}
579             n = \hyperlink{ndp__cache_8c_a1691e3229a1353a430185f4c5d29c958}{ndpSendQueuedPackets}(interface, entry);
580             \textcolor{comment}{//Save current time}
581             entry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
582 
583             \textcolor{comment}{//Check whether any packets have been sent}
584             \textcolor{keywordflow}{if}(n > 0)
585             \{
586                \textcolor{comment}{//Start delay timer}
587                entry->\hyperlink{structNdpNeighborCacheEntry_a315eba9b9511bfbfc60b9559b37e7070}{timeout} = \hyperlink{ndp_8h_aec929b3037b2395eb6ac92c2bb1a8040}{NDP\_DELAY\_FIRST\_PROBE\_TIME};
588                \textcolor{comment}{//Switch to the DELAY state}
589                entry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479a4aea7ed554ee132a415f75034848d922}{NDP\_STATE\_DELAY};
590             \}
591             \textcolor{keywordflow}{else}
592             \{
593                \textcolor{comment}{//Enter the STALE state}
594                entry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE};
595             \}
596          \}
597          \textcolor{comment}{//REACHABLE, STALE, DELAY or PROBE state?}
598          \textcolor{keywordflow}{else}
599          \{
600             \textcolor{comment}{//Different link-layer address than cached?}
601             \textcolor{keywordflow}{if}(!\hyperlink{ethernet_8h_a800d9f928930baf027e925976c44b9b2}{macCompAddr}(&entry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr}, &linkLayerAddrOption->linkLayerAddr))
602             \{
603                \textcolor{comment}{//Update link-layer address}
604                entry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr} = linkLayerAddrOption->linkLayerAddr;
605                \textcolor{comment}{//Save current time}
606                entry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
607                \textcolor{comment}{//The reachability state must be set to STALE}
608                entry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE};
609             \}
610          \}
611       \}
612    \}
613 \textcolor{preprocessor}{#endif}
614 
615    \textcolor{comment}{//Search for the MTU option}
616    mtuOption = \hyperlink{ndp__misc_8c_a6d3addbaab223cf3eab295c590e42f35}{ndpGetOption}(message->options, length, \hyperlink{ndp_8h_af1e00e3e4e4a40cf7cc766002871bf30acbe37e1b91f35c5dc750d54edf07453f}{NDP\_OPT\_MTU});
617 
618    \textcolor{comment}{//MTU option found?}
619    \textcolor{keywordflow}{if}(mtuOption != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && mtuOption->length == 1)
620    \{
621       \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{NetInterface} *physicalInterface;
622 
623       \textcolor{comment}{//Point to the physical interface}
624       physicalInterface = \hyperlink{nic_8c_aa8f48265895dab1633056c2dcd796355}{nicGetPhysicalInterface}(interface);
625 
626       \textcolor{comment}{//This option specifies the recommended MTU for the link}
627       n = \hyperlink{cpu__endian_8h_a22f92ea3318059b7d88dfbd98d0cbc3e}{ntohl}(mtuOption->mtu);
628 
629       \textcolor{comment}{//The host should copy the option's value so long as the value is greater}
630       \textcolor{comment}{//than or equal to the minimum IPv6 MTU and does not exceed the maximum}
631       \textcolor{comment}{//MTU of the interface}
632       \textcolor{keywordflow}{if}(n >= \hyperlink{ipv6_8h_a34a355847abfca977d0ca4ed43dd05ae}{IPV6\_DEFAULT\_MTU} && n <= physicalInterface->nicDriver->mtu)
633       \{
634          \textcolor{comment}{//Save the MTU value}
635          interface->ipv6Context.linkMtu = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
636       \}
637    \}
638 
639    \textcolor{comment}{//Point to the beginning of the Options field}
640    n = 0;
641 
642    \textcolor{comment}{//Parse Options field}
643    \textcolor{keywordflow}{while}(1)
644    \{
645       \textcolor{comment}{//Search the Options field for any Prefix Information options}
646       prefixInfoOption = \hyperlink{ndp__misc_8c_a6d3addbaab223cf3eab295c590e42f35}{ndpGetOption}(message->options + n,
647          length - n, \hyperlink{ndp_8h_af1e00e3e4e4a40cf7cc766002871bf30a6a0ecdab157e41227db339c02d093cb2}{NDP\_OPT\_PREFIX\_INFORMATION});
648 
649       \textcolor{comment}{//No more option of the specified type?}
650       \textcolor{keywordflow}{if}(prefixInfoOption == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
651          \textcolor{keywordflow}{break};
652 
653       \textcolor{comment}{//Hosts use the advertised on-link prefixes to build and maintain}
654       \textcolor{comment}{//a list that is used in deciding when a packet's destination is}
655       \textcolor{comment}{//on-link or beyond a router}
656       \hyperlink{ndp__misc_8c_ab7707a98f198e1f2a1f2f52557865ed6}{ndpParsePrefixInfoOption}(interface, prefixInfoOption);
657 
658       \textcolor{comment}{//Retrieve the offset to the current position}
659       n = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) prefixInfoOption - message->options;
660       \textcolor{comment}{//Jump to the next option}
661       n += prefixInfoOption->length * 8;
662    \}
663 
664 \textcolor{preprocessor}{#if (SLAAC\_SUPPORT == ENABLED)}
665    \textcolor{comment}{//Stateless Address Autoconfiguration is currently used?}
666    \textcolor{keywordflow}{if}(interface->slaacContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
667    \{
668       \textcolor{comment}{//Process the valid advertisement}
669       \hyperlink{slaac_8c_a0ffa11d5c7d2e2a92c2e99336c1863c3}{slaacParseRouterAdv}(interface->slaacContext, message,
670          length + \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_ad4e8bce6eb079bfe6e7681a6f6488c1e}{NdpRouterAdvMessage}));
671    \}
672 \textcolor{preprocessor}{#endif}
673 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_af4c9241c9bdc3e1ef99481060de5cc02}\label{ndp_8c_af4c9241c9bdc3e1ef99481060de5cc02}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Resolve@{ndp\+Resolve}}
\index{ndp\+Resolve@{ndp\+Resolve}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Resolve()}{ndpResolve()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ndp\+Resolve (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6\+Addr} $\ast$}]{ip\+Addr,  }\item[{\hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{Mac\+Addr} $\ast$}]{mac\+Addr }\end{DoxyParamCaption})}



Address resolution using Neighbor Discovery protocol. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em ip\+Addr} & I\+Pv6 address \\
\hline
\mbox{\tt in}  & {\em mac\+Addr} & Physical address matching the specified I\+Pv6 address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 100 of file ndp.\+c.


\begin{DoxyCode}
101 \{
102    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
103    \hyperlink{structNdpNeighborCacheEntry}{NdpNeighborCacheEntry} *entry;
104 
105    \textcolor{comment}{//Search the ndpCacheMutex cache for the specified IPv6 address}
106    entry = \hyperlink{ndp__cache_8c_a4bb136704775638d094e9b9b0eab0c62}{ndpFindNeighborCacheEntry}(interface, \hyperlink{mib__common_8h_a3860e959b1b7dd73686a6e11424805e2}{ipAddr});
107 
108    \textcolor{comment}{//Check whether a matching entry has been found}
109    \textcolor{keywordflow}{if}(entry != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
110    \{
111       \textcolor{comment}{//Check the state of the Neighbor cache entry}
112       \textcolor{keywordflow}{if}(entry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} == \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479af1920f2caebfea1b46a7e9f9439bc6f9}{NDP\_STATE\_INCOMPLETE})
113       \{
114          \textcolor{comment}{//The address resolution is already in progress}
115          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca14596397b69ee6fd1d74ca77fb55e186}{ERROR\_IN\_PROGRESS};
116       \}
117       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(entry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} == \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479ab6e55ba9d8e5319194d5fe9b9b83c684}{NDP\_STATE\_STALE})
118       \{
119          \textcolor{comment}{//Copy the MAC address associated with the specified IPv6 address}
120          *macAddr = entry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr};
121 
122          \textcolor{comment}{//Start delay timer}
123          entry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
124          \textcolor{comment}{//Delay before sending the first probe}
125          entry->\hyperlink{structNdpNeighborCacheEntry_a315eba9b9511bfbfc60b9559b37e7070}{timeout} = \hyperlink{ndp_8h_aec929b3037b2395eb6ac92c2bb1a8040}{NDP\_DELAY\_FIRST\_PROBE\_TIME};
126          \textcolor{comment}{//Switch to the DELAY state}
127          entry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479a4aea7ed554ee132a415f75034848d922}{NDP\_STATE\_DELAY};
128 
129          \textcolor{comment}{//Successful address resolution}
130          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
131       \}
132       \textcolor{keywordflow}{else}
133       \{
134          \textcolor{comment}{//Copy the MAC address associated with the specified IPv6 address}
135          *macAddr = entry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr};
136 
137          \textcolor{comment}{//Successful address resolution}
138          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
139       \}
140    \}
141    \textcolor{keywordflow}{else}
142    \{
143       \textcolor{comment}{//If no entry exists, then create a new one}
144       entry = \hyperlink{ndp__cache_8c_aa10560ab298b818966ff62cf4493b0e5}{ndpCreateNeighborCacheEntry}(interface);
145 
146       \textcolor{comment}{//Neighbor Cache entry successfully created?}
147       \textcolor{keywordflow}{if}(entry != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
148       \{
149          \textcolor{comment}{//Record the IPv6 address whose MAC address is unknown}
150          entry->\hyperlink{structNdpNeighborCacheEntry_a3c02dac138bb8d8ae45ad1de8c324221}{ipAddr} = *\hyperlink{mib__common_8h_a3860e959b1b7dd73686a6e11424805e2}{ipAddr};
151 
152          \textcolor{comment}{//Reset retransmission counter}
153          entry->\hyperlink{structNdpNeighborCacheEntry_a4814680905745d10b71447d63db67a1c}{retransmitCount} = 0;
154          \textcolor{comment}{//No packet are pending in the transmit queue}
155          entry->\hyperlink{structNdpNeighborCacheEntry_ac6639d88295e91df681f7e0fcb88c83b}{queueSize} = 0;
156 
157          \textcolor{comment}{//Send a multicast Neighbor Solicitation message}
158          \hyperlink{ndp_8c_aa2d7bb550603db3b3e48a150c4e30d49}{ndpSendNeighborSol}(interface, \hyperlink{mib__common_8h_a3860e959b1b7dd73686a6e11424805e2}{ipAddr}, \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE});
159 
160          \textcolor{comment}{//Save the time at which the message was sent}
161          entry->\hyperlink{structNdpNeighborCacheEntry_a09717542b16d54caabb3494f39b8864c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
162          \textcolor{comment}{//Set timeout value}
163          entry->\hyperlink{structNdpNeighborCacheEntry_a315eba9b9511bfbfc60b9559b37e7070}{timeout} = interface->ndpContext.retransTimer;
164          \textcolor{comment}{//Enter INCOMPLETE state}
165          entry->\hyperlink{structNdpNeighborCacheEntry_a574ecea20d21d33352612dcd9583e3d5}{state} = \hyperlink{ndp_8h_a97a48b3286230efa6a168a56910ea479af1920f2caebfea1b46a7e9f9439bc6f9}{NDP\_STATE\_INCOMPLETE};
166 
167          \textcolor{comment}{//The address resolution is in progress}
168          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca14596397b69ee6fd1d74ca77fb55e186}{ERROR\_IN\_PROGRESS};
169       \}
170       \textcolor{keywordflow}{else}
171       \{
172          \textcolor{comment}{//Failed to create Neighbor Cache entry...}
173          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca528efe91b7a7e4bcc9a6de7d4b778c67}{ERROR\_OUT\_OF\_RESOURCES};
174       \}
175    \}
176 
177    \textcolor{comment}{//Return status code}
178    \textcolor{keywordflow}{return} error;
179 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_a469e0954e29d4f66705088abcbbdd28a}\label{ndp_8c_a469e0954e29d4f66705088abcbbdd28a}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Send\+Neighbor\+Adv@{ndp\+Send\+Neighbor\+Adv}}
\index{ndp\+Send\+Neighbor\+Adv@{ndp\+Send\+Neighbor\+Adv}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Send\+Neighbor\+Adv()}{ndpSendNeighborAdv()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ndp\+Send\+Neighbor\+Adv (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6\+Addr} $\ast$}]{target\+Ip\+Addr,  }\item[{const \hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6\+Addr} $\ast$}]{dest\+Ip\+Addr }\end{DoxyParamCaption})}



Send a Neighbor Advertisement message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em target\+Ip\+Addr} & Target I\+Pv6 address \\
\hline
\mbox{\tt in}  & {\em dest\+Ip\+Addr} & Destination I\+Pv6 address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1593 of file ndp.\+c.


\begin{DoxyCode}
1595 \{
1596    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1597    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
1598    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1599    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
1600    \hyperlink{ndp_8h_a2727c6d34f93db5133b4a7bf327a63a9}{NdpNeighborAdvMessage} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
1601    \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader} pseudoHeader;
1602 \textcolor{preprocessor}{#if (ETH\_SUPPORT == ENABLED)}
1603    \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{NetInterface} *logicalInterface;
1604 \textcolor{preprocessor}{#endif}
1605 
1606    \textcolor{comment}{//Destination IP address is the unspecified address?}
1607    \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(\hyperlink{ipcp_8h_a752e1719cf65f78dfec6274352cb56df}{destIpAddr}, &\hyperlink{ipv6_8c_aa4baeec4f7b8b166d2457787fb9eddf9}{IPV6\_UNSPECIFIED\_ADDR}))
1608    \{
1609       \textcolor{comment}{//If the destination is the unspecified address, the node must}
1610       \textcolor{comment}{//multicast the advertisement to the all-nodes address}
1611       pseudoHeader.destAddr = \hyperlink{ipv6_8c_a8e2b9466528a5be6596c59cf94ac56a4}{IPV6\_LINK\_LOCAL\_ALL\_NODES\_ADDR};
1612    \}
1613    \textcolor{keywordflow}{else}
1614    \{
1615       \textcolor{comment}{//Otherwise, the node must unicast the advertisement to the}
1616       \textcolor{comment}{//destination IP address}
1617       pseudoHeader.destAddr = *\hyperlink{ipcp_8h_a752e1719cf65f78dfec6274352cb56df}{destIpAddr};
1618    \}
1619 
1620    \textcolor{comment}{//Check whether the target address is a valid anycast address assigned}
1621    \textcolor{comment}{//to the interface}
1622    \textcolor{keywordflow}{if}(\hyperlink{ipv6__misc_8c_a7448bedb5edff0df8029ca8b5c6d994d}{ipv6IsAnycastAddr}(interface, targetIpAddr))
1623    \{
1624       \textcolor{comment}{//Select the most appropriate source address to be used when sending}
1625       \textcolor{comment}{//the Neighbor Advertisement message}
1626       error = \hyperlink{ipv6__misc_8c_a1d69e11a455ee8895ec67061f554a174}{ipv6SelectSourceAddr}(&interface, targetIpAddr,
1627          &pseudoHeader.srcAddr);
1628 
1629       \textcolor{comment}{//No address assigned to the interface?}
1630       \textcolor{keywordflow}{if}(error)
1631          \textcolor{keywordflow}{return} error;
1632    \}
1633    \textcolor{keywordflow}{else}
1634    \{
1635       \textcolor{comment}{//Set the source IP address}
1636       pseudoHeader.srcAddr = *targetIpAddr;
1637    \}
1638 
1639    \textcolor{comment}{//The only defined option that may appear in a Neighbor Advertisement}
1640    \textcolor{comment}{//message is the Target Link-Layer Address option}
1641    length = \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a2727c6d34f93db5133b4a7bf327a63a9}{NdpNeighborAdvMessage}) + \textcolor{keyword}{sizeof}(
      \hyperlink{ndp_8h_a468b5bb872928c789dabecb62486ce8c}{NdpLinkLayerAddrOption});
1642 
1643    \textcolor{comment}{//Allocate a memory buffer to hold the Neighbor Advertisement message}
1644    buffer = \hyperlink{ip_8c_a2222fb64b1b18140283119eea309c1b3}{ipAllocBuffer}(length, &offset);
1645    \textcolor{comment}{//Failed to allocate memory?}
1646    \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1647       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
1648 
1649    \textcolor{comment}{//Point to the beginning of the message}
1650    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, offset);
1651 
1652    \textcolor{comment}{//Format Neighbor Advertisement message}
1653    message->type = \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a8cf8b81569e86589eb5b71c7fd2f8ac5}{ICMPV6\_TYPE\_NEIGHBOR\_ADV};
1654    message->code = 0;
1655    message->checksum = 0;
1656    message->reserved1 = 0;
1657    message->reserved2 = 0;
1658    message->targetAddr = *targetIpAddr;
1659 
1660    \textcolor{comment}{//The Router flag indicates that the sender is a router}
1661    \textcolor{keywordflow}{if}(interface->ipv6Context.isRouter)
1662       message->r = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1663    \textcolor{keywordflow}{else}
1664       message->r = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1665 
1666    \textcolor{comment}{//If the destination is the unspecified address, the node must set}
1667    \textcolor{comment}{//the Solicited flag to zero}
1668    \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(\hyperlink{ipcp_8h_a752e1719cf65f78dfec6274352cb56df}{destIpAddr}, &\hyperlink{ipv6_8c_aa4baeec4f7b8b166d2457787fb9eddf9}{IPV6\_UNSPECIFIED\_ADDR}))
1669       message->s = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1670    \textcolor{keywordflow}{else}
1671       message->s = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1672 
1673    \textcolor{comment}{//The Override flag should not be set in solicited advertisements}
1674    \textcolor{comment}{//for anycast addresses}
1675    \textcolor{keywordflow}{if}(\hyperlink{ipv6__misc_8c_a7448bedb5edff0df8029ca8b5c6d994d}{ipv6IsAnycastAddr}(interface, targetIpAddr))
1676       message->o = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1677    \textcolor{keywordflow}{else}
1678       message->o = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1679 
1680    \textcolor{comment}{//Length of the message, excluding any option}
1681    length = \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a2727c6d34f93db5133b4a7bf327a63a9}{NdpNeighborAdvMessage});
1682 
1683 \textcolor{preprocessor}{#if (ETH\_SUPPORT == ENABLED)}
1684    \textcolor{comment}{//Point to the logical interface}
1685    logicalInterface = \hyperlink{nic_8c_a650d776d6513c3bb88671c3aedd782f0}{nicGetLogicalInterface}(interface);
1686 
1687    \textcolor{comment}{//Add Target Link-Layer Address option}
1688    \hyperlink{ndp__misc_8c_a30c9073c96be88de0b5768e07d22db8e}{ndpAddOption}(message, &length, \hyperlink{ndp_8h_af1e00e3e4e4a40cf7cc766002871bf30a9b3a7ab40eefc557d9a8e38a072727da}{NDP\_OPT\_TARGET\_LINK\_LAYER\_ADDR},
1689       &logicalInterface->macAddr, \textcolor{keyword}{sizeof}(\hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{MacAddr}));
1690 \textcolor{preprocessor}{#endif}
1691 
1692    \textcolor{comment}{//Adjust the length of the multi-part buffer}
1693    \hyperlink{net__mem_8c_ac0a46f396754e069dd1ee65cdc559b28}{netBufferSetLength}(buffer, offset + length);
1694 
1695    \textcolor{comment}{//Format IPv6 pseudo header}
1696    pseudoHeader.length = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(length);
1697    pseudoHeader.reserved = 0;
1698    pseudoHeader.nextHeader = \hyperlink{ipv6_8h_a551bec2628dfcc3b67c0fff52e486fa5a1abdcf5760ff2904781383db26717c83}{IPV6\_ICMPV6\_HEADER};
1699 
1700    \textcolor{comment}{//Calculate ICMPv6 header checksum}
1701    message->checksum = \hyperlink{ip_8c_a9ec0593d9dbb2adf3e67894c0349cef3}{ipCalcUpperLayerChecksumEx}(&pseudoHeader,
1702       \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader}), buffer, offset, length);
1703 
1704    \textcolor{comment}{//Total number of ICMP messages which this entity attempted to send}
1705    \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6Stats.icmpStatsOutMsgs, 1);
1706    \textcolor{comment}{//Increment per-message type ICMP counter}
1707    \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6MsgStatsTable.icmpMsgStatsOutPkts[
      \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a8cf8b81569e86589eb5b71c7fd2f8ac5}{ICMPV6\_TYPE\_NEIGHBOR\_ADV}], 1);
1708 
1709    \textcolor{comment}{//Debug message}
1710    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending Neighbor Advertisement message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      length);
1711    \textcolor{comment}{//Dump message contents for debugging purpose}
1712    \hyperlink{ndp_8c_a0fb3e8d27d1f9658296efe05c705d05d}{ndpDumpNeighborAdvMessage}(message);
1713 
1714    \textcolor{comment}{//Send Neighbor Advertisement message}
1715    error = \hyperlink{ipv6_8c_ae9edf1ac407897f91eb5caed37df7c3c}{ipv6SendDatagram}(interface, &pseudoHeader, buffer, offset, 
      \hyperlink{ndp_8h_aed9955a5c2a9d8b039e188d88f2bd923}{NDP\_HOP\_LIMIT});
1716 
1717    \textcolor{comment}{//Free previously allocated memory}
1718    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
1719    \textcolor{comment}{//Return status code}
1720    \textcolor{keywordflow}{return} error;
1721 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_aa2d7bb550603db3b3e48a150c4e30d49}\label{ndp_8c_aa2d7bb550603db3b3e48a150c4e30d49}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Send\+Neighbor\+Sol@{ndp\+Send\+Neighbor\+Sol}}
\index{ndp\+Send\+Neighbor\+Sol@{ndp\+Send\+Neighbor\+Sol}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Send\+Neighbor\+Sol()}{ndpSendNeighborSol()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ndp\+Send\+Neighbor\+Sol (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6\+Addr} $\ast$}]{target\+Ip\+Addr,  }\item[{\hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\+\_\+t}}]{multicast }\end{DoxyParamCaption})}



Send a Neighbor Solicitation message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em target\+Ip\+Addr} & Target I\+Pv6 address \\
\hline
\mbox{\tt in}  & {\em multicast} & Unicast or unicast Neighbor Solicitation message \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1473 of file ndp.\+c.


\begin{DoxyCode}
1475 \{
1476    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1477    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
1478    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1479    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
1480    \hyperlink{ndp_8h_a0cc069b424bfd84ee062d7d0793b174b}{NdpNeighborSolMessage} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
1481    \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader} pseudoHeader;
1482 
1483    \textcolor{comment}{//Multicast Neighbor Solicitation message?}
1484    \textcolor{keywordflow}{if}(multicast)
1485    \{
1486       \textcolor{comment}{//Compute the solicited-node multicast address that}
1487       \textcolor{comment}{//corresponds to the target IPv6 address}
1488       \hyperlink{ipv6__misc_8c_a6ae7a7bdd0009e5dcb63267ed1cf9c88}{ipv6ComputeSolicitedNodeAddr}(targetIpAddr, &pseudoHeader.destAddr);
1489    \}
1490    \textcolor{keywordflow}{else}
1491    \{
1492       \textcolor{comment}{//Unicast Neighbor Solicitation message}
1493       pseudoHeader.destAddr = *targetIpAddr;
1494    \}
1495 
1496    \textcolor{comment}{//Check whether the target address is a tentative address}
1497    \textcolor{keywordflow}{if}(\hyperlink{ipv6__misc_8c_af26691bb490df211ba351340016cd53c}{ipv6IsTentativeAddr}(interface, targetIpAddr))
1498    \{
1499       \textcolor{comment}{//The IPv6 source is set to the unspecified address}
1500       pseudoHeader.srcAddr = \hyperlink{ipv6_8c_aa4baeec4f7b8b166d2457787fb9eddf9}{IPV6\_UNSPECIFIED\_ADDR};
1501    \}
1502    \textcolor{keywordflow}{else}
1503    \{
1504       \textcolor{comment}{//Select the most appropriate source address to be used when sending}
1505       \textcolor{comment}{//the Neighbor Solicitation message}
1506       error = \hyperlink{ipv6__misc_8c_a1d69e11a455ee8895ec67061f554a174}{ipv6SelectSourceAddr}(&interface, targetIpAddr,
1507          &pseudoHeader.srcAddr);
1508 
1509       \textcolor{comment}{//No address assigned to the interface?}
1510       \textcolor{keywordflow}{if}(error)
1511          \textcolor{keywordflow}{return} error;
1512    \}
1513 
1514    \textcolor{comment}{//The only defined option that may appear in a Neighbor Solicitation}
1515    \textcolor{comment}{//message is the Source Link-Layer Address option}
1516    length = \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a0cc069b424bfd84ee062d7d0793b174b}{NdpNeighborSolMessage}) + \textcolor{keyword}{sizeof}(
      \hyperlink{ndp_8h_a468b5bb872928c789dabecb62486ce8c}{NdpLinkLayerAddrOption});
1517 
1518    \textcolor{comment}{//Allocate a memory buffer to hold the Neighbor Solicitation message}
1519    buffer = \hyperlink{ip_8c_a2222fb64b1b18140283119eea309c1b3}{ipAllocBuffer}(length, &offset);
1520    \textcolor{comment}{//Failed to allocate memory?}
1521    \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1522       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
1523 
1524    \textcolor{comment}{//Point to the beginning of the message}
1525    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, offset);
1526 
1527    \textcolor{comment}{//Format Neighbor Solicitation message}
1528    message->type = \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a15fcec525be2799e51a85119d592fa0e}{ICMPV6\_TYPE\_NEIGHBOR\_SOL};
1529    message->code = 0;
1530    message->checksum = 0;
1531    message->reserved = 0;
1532    message->targetAddr = *targetIpAddr;
1533 
1534    \textcolor{comment}{//Length of the message, excluding any option}
1535    length = \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a0cc069b424bfd84ee062d7d0793b174b}{NdpNeighborSolMessage});
1536 
1537    \textcolor{comment}{//The Source Link-Layer Address option must not be included}
1538    \textcolor{comment}{//when the source IPv6 address is the unspecified address}
1539    \textcolor{keywordflow}{if}(!\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(&pseudoHeader.srcAddr, &\hyperlink{ipv6_8c_aa4baeec4f7b8b166d2457787fb9eddf9}{IPV6\_UNSPECIFIED\_ADDR}))
1540    \{
1541 \textcolor{preprocessor}{#if (ETH\_SUPPORT == ENABLED)}
1542       \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{NetInterface} *logicalInterface;
1543 
1544       \textcolor{comment}{//Point to the logical interface}
1545       logicalInterface = \hyperlink{nic_8c_a650d776d6513c3bb88671c3aedd782f0}{nicGetLogicalInterface}(interface);
1546 
1547       \textcolor{comment}{//Add Source Link-Layer Address option}
1548       \hyperlink{ndp__misc_8c_a30c9073c96be88de0b5768e07d22db8e}{ndpAddOption}(message, &length, \hyperlink{ndp_8h_af1e00e3e4e4a40cf7cc766002871bf30a605af3b2b6f92741d213e15ec8bf7148}{NDP\_OPT\_SOURCE\_LINK\_LAYER\_ADDR}
      ,
1549          &logicalInterface->macAddr, \textcolor{keyword}{sizeof}(\hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{MacAddr}));
1550 \textcolor{preprocessor}{#endif}
1551    \}
1552 
1553    \textcolor{comment}{//Adjust the length of the multi-part buffer}
1554    \hyperlink{net__mem_8c_ac0a46f396754e069dd1ee65cdc559b28}{netBufferSetLength}(buffer, offset + length);
1555 
1556    \textcolor{comment}{//Format IPv6 pseudo header}
1557    pseudoHeader.length = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(length);
1558    pseudoHeader.reserved = 0;
1559    pseudoHeader.nextHeader = \hyperlink{ipv6_8h_a551bec2628dfcc3b67c0fff52e486fa5a1abdcf5760ff2904781383db26717c83}{IPV6\_ICMPV6\_HEADER};
1560 
1561    \textcolor{comment}{//Calculate ICMPv6 header checksum}
1562    message->checksum = \hyperlink{ip_8c_a9ec0593d9dbb2adf3e67894c0349cef3}{ipCalcUpperLayerChecksumEx}(&pseudoHeader,
1563       \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader}), buffer, offset, length);
1564 
1565    \textcolor{comment}{//Total number of ICMP messages which this entity attempted to send}
1566    \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6Stats.icmpStatsOutMsgs, 1);
1567    \textcolor{comment}{//Increment per-message type ICMP counter}
1568    \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6MsgStatsTable.icmpMsgStatsOutPkts[
      \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a15fcec525be2799e51a85119d592fa0e}{ICMPV6\_TYPE\_NEIGHBOR\_SOL}], 1);
1569 
1570    \textcolor{comment}{//Debug message}
1571    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending Neighbor Solicitation message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      length);
1572    \textcolor{comment}{//Dump message contents for debugging purpose}
1573    \hyperlink{ndp_8c_a0918093e5ba4f5738f552a2deb1395d6}{ndpDumpNeighborSolMessage}(message);
1574 
1575    \textcolor{comment}{//Send Neighbor Solicitation message}
1576    error = \hyperlink{ipv6_8c_ae9edf1ac407897f91eb5caed37df7c3c}{ipv6SendDatagram}(interface, &pseudoHeader, buffer, offset, 
      \hyperlink{ndp_8h_aed9955a5c2a9d8b039e188d88f2bd923}{NDP\_HOP\_LIMIT});
1577 
1578    \textcolor{comment}{//Free previously allocated memory}
1579    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
1580    \textcolor{comment}{//Return status code}
1581    \textcolor{keywordflow}{return} error;
1582 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_a1f5f38f7a18c49e25a1d81821a813491}\label{ndp_8c_a1f5f38f7a18c49e25a1d81821a813491}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Send\+Redirect@{ndp\+Send\+Redirect}}
\index{ndp\+Send\+Redirect@{ndp\+Send\+Redirect}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Send\+Redirect()}{ndpSendRedirect()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ndp\+Send\+Redirect (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{const \hyperlink{ipv6_8h_aed0cbc40c61ed5b4fb681ebc55237e89}{Ipv6\+Addr} $\ast$}]{target\+Addr,  }\item[{const \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{ip\+Packet,  }\item[{size\+\_\+t}]{ip\+Packet\+Offset }\end{DoxyParamCaption})}



Send a Redirect message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em target\+Addr} & I\+Pv6 address that is a better first hop to use for the destination address \\
\hline
\mbox{\tt in}  & {\em ip\+Packet} & Multi-\/part buffer that holds the I\+Pv6 packet that triggered the sending of the Redirect \\
\hline
\mbox{\tt in}  & {\em ip\+Packet\+Offset} & Offset to the first byte of the I\+Pv6 packet \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1735 of file ndp.\+c.


\begin{DoxyCode}
1737 \{
1738    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1739    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
1740    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1741    \textcolor{keywordtype}{size\_t} ipPacketLen;
1742    \textcolor{keywordtype}{size\_t} optionLen;
1743    \textcolor{keywordtype}{size\_t} paddingLen;
1744    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
1745    \hyperlink{ndp_8h_ad7f7873e6eed24c49155b65903f51801}{NdpRedirectMessage} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
1746    \hyperlink{ndp_8h_a07f8bb889bfd058236205e9aabcb04ac}{NdpRedirectedHeaderOption} *option;
1747    \hyperlink{structNdpNeighborCacheEntry}{NdpNeighborCacheEntry} *entry;
1748    \hyperlink{ipv6_8h_ad553284c12e3a0d96dc8a4da1c5f6ea0}{Ipv6Header} *ipHeader;
1749    \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader} pseudoHeader;
1750    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} \hyperlink{md4_8c_ae1cca62951c2df9f5bf77fda3dcdd423}{padding}[8];
1751 
1752    \textcolor{comment}{//Retrieve the length of the forwarded IPv6 packet}
1753    ipPacketLen = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(ipPacket) - ipPacketOffset;
1754 
1755    \textcolor{comment}{//Check the length of the IPv6 packet}
1756    \textcolor{keywordflow}{if}(ipPacketLen < \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_ad553284c12e3a0d96dc8a4da1c5f6ea0}{Ipv6Header}))
1757       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae5c014519c3ac2540447887ddca1bd28}{ERROR\_INVALID\_LENGTH};
1758 
1759    \textcolor{comment}{//Point to the header of the invoking packet}
1760    ipHeader = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(ipPacket, ipPacketOffset);
1761    \textcolor{comment}{//Sanity check}
1762    \textcolor{keywordflow}{if}(ipHeader == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1763       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
1764 
1765    \textcolor{comment}{//The only defined options that may appear in a Redirect message are the}
1766    \textcolor{comment}{//Target Link-Layer Address option and the Redirected Header option}
1767    length = \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_ad7f7873e6eed24c49155b65903f51801}{NdpRedirectMessage}) + \textcolor{keyword}{sizeof}(
      \hyperlink{ndp_8h_a468b5bb872928c789dabecb62486ce8c}{NdpLinkLayerAddrOption}) +
1768       \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a07f8bb889bfd058236205e9aabcb04ac}{NdpRedirectedHeaderOption});
1769 
1770    \textcolor{comment}{//Allocate a memory buffer to hold the Redirect message}
1771    buffer = \hyperlink{ip_8c_a2222fb64b1b18140283119eea309c1b3}{ipAllocBuffer}(length, &offset);
1772    \textcolor{comment}{//Failed to allocate memory?}
1773    \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1774       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
1775 
1776    \textcolor{comment}{//Point to the beginning of the message}
1777    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, offset);
1778 
1779    \textcolor{comment}{//Format Redirect message}
1780    message->type = \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a7ae52a8f3a16cdfbb750f2a0431ad196}{ICMPV6\_TYPE\_REDIRECT};
1781    message->code = 0;
1782    message->checksum = 0;
1783    message->reserved = 0;
1784    message->targetAddr = *\hyperlink{ndp_8h_a2bad05a029241e5009f65fe5480187a0}{targetAddr};
1785    message->destAddr = ipHeader->destAddr;
1786 
1787    \textcolor{comment}{//Length of the message, excluding any option}
1788    length = \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_ad7f7873e6eed24c49155b65903f51801}{NdpRedirectMessage});
1789 
1790    \textcolor{comment}{//Search the Neighbor cache for the specified target address}
1791    entry = \hyperlink{ndp__cache_8c_a4bb136704775638d094e9b9b0eab0c62}{ndpFindNeighborCacheEntry}(interface, 
      \hyperlink{ndp_8h_a2bad05a029241e5009f65fe5480187a0}{targetAddr});
1792 
1793    \textcolor{comment}{//Include the link-layer address of the target, if known}
1794    \textcolor{keywordflow}{if}(entry != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1795    \{
1796       \textcolor{comment}{//Add Target Link-Layer Address option}
1797       \hyperlink{ndp__misc_8c_a30c9073c96be88de0b5768e07d22db8e}{ndpAddOption}(message, &length, \hyperlink{ndp_8h_af1e00e3e4e4a40cf7cc766002871bf30a9b3a7ab40eefc557d9a8e38a072727da}{NDP\_OPT\_TARGET\_LINK\_LAYER\_ADDR}
      ,
1798          &entry->\hyperlink{structNdpNeighborCacheEntry_a1e8f8ff5e8f92123bb81a40643b13c2c}{macAddr}, \textcolor{keyword}{sizeof}(\hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{MacAddr}));
1799    \}
1800 
1801    \textcolor{comment}{//Retrieve the length of the IPv6 packet that triggered the sending}
1802    \textcolor{comment}{//of the Redirect}
1803    ipPacketLen = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(ipPacket) - ipPacketOffset;
1804 
1805    \textcolor{comment}{//Return as much of the forwarded IPv6 packet as can fit without}
1806    \textcolor{comment}{//the redirect packet exceeding the minimum IPv6 MTU}
1807    ipPacketLen = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(ipPacketLen, \hyperlink{ipv6_8h_a34a355847abfca977d0ca4ed43dd05ae}{IPV6\_DEFAULT\_MTU} -
1808       \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a07f8bb889bfd058236205e9aabcb04ac}{NdpRedirectedHeaderOption}) - length);
1809 
1810    \textcolor{comment}{//Length of the Redirected Header option in units of 8 bytes including}
1811    \textcolor{comment}{//the type and length fields}
1812    optionLen = (ipPacketLen + \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a4703825ac5372088c82fde5ea118b93d}{NdpOption}) + 7) / 8;
1813 
1814    \textcolor{comment}{//Add Redirected Header option}
1815    option = (\hyperlink{ndp_8h_a07f8bb889bfd058236205e9aabcb04ac}{NdpRedirectedHeaderOption} *) ((\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *) message + 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
1816 
1817    \textcolor{comment}{//Format Redirected Header option}
1818    option->type = \hyperlink{ndp_8h_af1e00e3e4e4a40cf7cc766002871bf30a09ecf93a573bc3116faa3938610cdea9}{NDP\_OPT\_REDIRECTED\_HEADER};
1819    option->length = (\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}) optionLen;
1820    option->reserved1 = 0;
1821    option->reserved2 = 0;
1822 
1823    \textcolor{comment}{//Update the length of Redirect message}
1824    length += \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a07f8bb889bfd058236205e9aabcb04ac}{NdpRedirectedHeaderOption});
1825 
1826    \textcolor{comment}{//Adjust the length of the multi-part buffer}
1827    \hyperlink{net__mem_8c_ac0a46f396754e069dd1ee65cdc559b28}{netBufferSetLength}(buffer, offset + length);
1828 
1829    \textcolor{comment}{//Copy the contents of the forwarded IPv6 packet}
1830    error = \hyperlink{net__mem_8c_aba4fe2d850142e40a9a668afeb2a0c8a}{netBufferConcat}(buffer, ipPacket, ipPacketOffset, ipPacketLen);
1831 
1832    \textcolor{comment}{//Check status code}
1833    \textcolor{keywordflow}{if}(!error)
1834    \{
1835       \textcolor{comment}{//Options should be padded when necessary to ensure that they end on}
1836       \textcolor{comment}{//their natural 64-bit boundaries}
1837       \textcolor{keywordflow}{if}((ipPacketLen + \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a07f8bb889bfd058236205e9aabcb04ac}{NdpRedirectedHeaderOption})) < (optionLen * 8))
1838       \{
1839          \textcolor{comment}{//Determine the amount of padding data to append}
1840          paddingLen = (optionLen * 8) - ipPacketLen -
1841             \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a07f8bb889bfd058236205e9aabcb04ac}{NdpRedirectedHeaderOption});
1842 
1843          \textcolor{comment}{//Prepare padding data}
1844          memset(padding, 0, paddingLen);
1845          \textcolor{comment}{//Append padding bytes}
1846          error = \hyperlink{net__mem_8c_aceae1188a93321e1d4daed11bb8005df}{netBufferAppend}(buffer, padding, paddingLen);
1847       \}
1848    \}
1849 
1850    \textcolor{comment}{//Check status code}
1851    \textcolor{keywordflow}{if}(!error)
1852    \{
1853       \textcolor{comment}{//Get the length of the resulting message}
1854       length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer) - \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
1855 
1856       \textcolor{comment}{//Format IPv6 pseudo header}
1857       pseudoHeader.srcAddr = interface->ipv6Context.addrList[0].addr;
1858       pseudoHeader.destAddr = ipHeader->srcAddr;
1859       pseudoHeader.length = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(length);
1860       pseudoHeader.reserved = 0;
1861       pseudoHeader.nextHeader = \hyperlink{ipv6_8h_a551bec2628dfcc3b67c0fff52e486fa5a1abdcf5760ff2904781383db26717c83}{IPV6\_ICMPV6\_HEADER};
1862 
1863       \textcolor{comment}{//Message checksum calculation}
1864       message->checksum = \hyperlink{ip_8c_a9ec0593d9dbb2adf3e67894c0349cef3}{ipCalcUpperLayerChecksumEx}(&pseudoHeader,
1865          \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader}), buffer, offset, length);
1866 
1867       \textcolor{comment}{//Total number of ICMP messages which this entity attempted to send}
1868       \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6Stats.icmpStatsOutMsgs, 1);
1869       \textcolor{comment}{//Increment per-message type ICMP counter}
1870       \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6MsgStatsTable.icmpMsgStatsOutPkts[
      \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609a7ae52a8f3a16cdfbb750f2a0431ad196}{ICMPV6\_TYPE\_REDIRECT}], 1);
1871 
1872       \textcolor{comment}{//Debug message}
1873       \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending Redirect message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length);
1874       \textcolor{comment}{//Dump message contents for debugging purpose}
1875       \hyperlink{ndp_8c_a0c9cf9bc419ac9ebd3bdcd13ccae9060}{ndpDumpRedirectMessage}(message);
1876 
1877       \textcolor{comment}{//Send Redirect message}
1878       error = \hyperlink{ipv6_8c_ae9edf1ac407897f91eb5caed37df7c3c}{ipv6SendDatagram}(interface, &pseudoHeader, buffer, offset, 
      \hyperlink{ndp_8h_aed9955a5c2a9d8b039e188d88f2bd923}{NDP\_HOP\_LIMIT});
1879    \}
1880 
1881    \textcolor{comment}{//Free previously allocated memory}
1882    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
1883 
1884    \textcolor{comment}{//Return status code}
1885    \textcolor{keywordflow}{return} error;
1886 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_a7553aa29f5212b7e5be1faad1af42925}\label{ndp_8c_a7553aa29f5212b7e5be1faad1af42925}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Send\+Router\+Sol@{ndp\+Send\+Router\+Sol}}
\index{ndp\+Send\+Router\+Sol@{ndp\+Send\+Router\+Sol}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Send\+Router\+Sol()}{ndpSendRouterSol()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} ndp\+Send\+Router\+Sol (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Send a Router Solicitation message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1366 of file ndp.\+c.


\begin{DoxyCode}
1367 \{
1368    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1369    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
1370    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1371    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
1372    \hyperlink{ndp_8h_a0d342407a414edc2cf6ea2fefbd24621}{NdpRouterSolMessage} *\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message};
1373    \hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader} pseudoHeader;
1374 
1375    \textcolor{comment}{//The destination address is typically the all-routers multicast address}
1376    pseudoHeader.destAddr = \hyperlink{ipv6_8c_aa8488194ba618b31711b0e7953af10d7}{IPV6\_LINK\_LOCAL\_ALL\_ROUTERS\_ADDR};
1377 
1378    \textcolor{comment}{//Select the most appropriate source address to be used when sending the}
1379    \textcolor{comment}{//Router Solicitation message}
1380    error = \hyperlink{ipv6__misc_8c_a1d69e11a455ee8895ec67061f554a174}{ipv6SelectSourceAddr}(&interface, &pseudoHeader.destAddr,
1381       &pseudoHeader.srcAddr);
1382 
1383    \textcolor{comment}{//No address assigned to the interface?}
1384    \textcolor{keywordflow}{if}(error)
1385    \{
1386       \textcolor{comment}{//Use the unspecified address if no address is assigned}
1387       \textcolor{comment}{//to the sending interface}
1388       pseudoHeader.srcAddr = \hyperlink{ipv6_8c_aa4baeec4f7b8b166d2457787fb9eddf9}{IPV6\_UNSPECIFIED\_ADDR};
1389    \}
1390 
1391    \textcolor{comment}{//The only defined option that may appear in a Router Solicitation}
1392    \textcolor{comment}{//message is the Source Link-Layer Address option}
1393    length = \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a0d342407a414edc2cf6ea2fefbd24621}{NdpRouterSolMessage}) + \textcolor{keyword}{sizeof}(
      \hyperlink{ndp_8h_a468b5bb872928c789dabecb62486ce8c}{NdpLinkLayerAddrOption});
1394 
1395    \textcolor{comment}{//Allocate a memory buffer to hold the Router Solicitation message}
1396    buffer = \hyperlink{ip_8c_a2222fb64b1b18140283119eea309c1b3}{ipAllocBuffer}(length, &offset);
1397    \textcolor{comment}{//Failed to allocate memory?}
1398    \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1399       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
1400 
1401    \textcolor{comment}{//Point to the beginning of the message}
1402    message = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, offset);
1403 
1404    \textcolor{comment}{//Format Router Solicitation message}
1405    message->type = \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609ae9bf5c9cb1c8160705268ee86cfb4f4e}{ICMPV6\_TYPE\_ROUTER\_SOL};
1406    message->code = 0;
1407    message->checksum = 0;
1408    message->reserved = 0;
1409 
1410    \textcolor{comment}{//Length of the message, excluding any option}
1411    length = \textcolor{keyword}{sizeof}(\hyperlink{ndp_8h_a0d342407a414edc2cf6ea2fefbd24621}{NdpRouterSolMessage});
1412 
1413    \textcolor{comment}{//The Source Link-Layer Address option must not be included}
1414    \textcolor{comment}{//when the source IPv6 address is the unspecified address}
1415    \textcolor{keywordflow}{if}(!\hyperlink{ipv6_8h_ab1e93bd2152bc3f3b5642fd0216384d7}{ipv6CompAddr}(&pseudoHeader.srcAddr, &\hyperlink{ipv6_8c_aa4baeec4f7b8b166d2457787fb9eddf9}{IPV6\_UNSPECIFIED\_ADDR}))
1416    \{
1417 \textcolor{preprocessor}{#if (ETH\_SUPPORT == ENABLED)}
1418       \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{NetInterface} *logicalInterface;
1419 
1420       \textcolor{comment}{//Point to the logical interface}
1421       logicalInterface = \hyperlink{nic_8c_a650d776d6513c3bb88671c3aedd782f0}{nicGetLogicalInterface}(interface);
1422 
1423       \textcolor{comment}{//Check whether a MAC address has been assigned to the interface}
1424       \textcolor{keywordflow}{if}(!\hyperlink{ethernet_8h_a800d9f928930baf027e925976c44b9b2}{macCompAddr}(&logicalInterface->macAddr, &
      \hyperlink{ethernet_8c_a24b2ce78dd643fe028d2e18c3b503f1f}{MAC\_UNSPECIFIED\_ADDR}))
1425       \{
1426          \textcolor{comment}{//Add Source Link-Layer Address option}
1427          \hyperlink{ndp__misc_8c_a30c9073c96be88de0b5768e07d22db8e}{ndpAddOption}(message, &length, 
      \hyperlink{ndp_8h_af1e00e3e4e4a40cf7cc766002871bf30a605af3b2b6f92741d213e15ec8bf7148}{NDP\_OPT\_SOURCE\_LINK\_LAYER\_ADDR},
1428             &logicalInterface->macAddr, \textcolor{keyword}{sizeof}(\hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{MacAddr}));
1429       \}
1430 \textcolor{preprocessor}{#endif}
1431    \}
1432 
1433    \textcolor{comment}{//Adjust the length of the multi-part buffer}
1434    \hyperlink{net__mem_8c_ac0a46f396754e069dd1ee65cdc559b28}{netBufferSetLength}(buffer, offset + length);
1435 
1436    \textcolor{comment}{//Format IPv6 pseudo header}
1437    pseudoHeader.length = \hyperlink{cpu__endian_8h_a63baf217625b15caa7246af75b027380}{htonl}(length);
1438    pseudoHeader.reserved = 0;
1439    pseudoHeader.nextHeader = \hyperlink{ipv6_8h_a551bec2628dfcc3b67c0fff52e486fa5a1abdcf5760ff2904781383db26717c83}{IPV6\_ICMPV6\_HEADER};
1440 
1441    \textcolor{comment}{//Calculate ICMPv6 header checksum}
1442    message->checksum = \hyperlink{ip_8c_a9ec0593d9dbb2adf3e67894c0349cef3}{ipCalcUpperLayerChecksumEx}(&pseudoHeader,
1443       \textcolor{keyword}{sizeof}(\hyperlink{ipv6_8h_a68061e0a0b502d880cbe60b645cfa2b7}{Ipv6PseudoHeader}), buffer, offset, length);
1444 
1445    \textcolor{comment}{//Total number of ICMP messages which this entity attempted to send}
1446    \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6Stats.icmpStatsOutMsgs, 1);
1447    \textcolor{comment}{//Increment per-message type ICMP counter}
1448    \hyperlink{ip__mib__module_8h_abbb1f41624dcbd4f21b44932e338a479}{IP\_MIB\_INC\_COUNTER32}(icmpv6MsgStatsTable.icmpMsgStatsOutPkts[
      \hyperlink{icmpv6_8h_a6bd3724b797b492017d0264d1ae5c609ae9bf5c9cb1c8160705268ee86cfb4f4e}{ICMPV6\_TYPE\_ROUTER\_SOL}], 1);
1449 
1450    \textcolor{comment}{//Debug message}
1451    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending Router Solicitation message (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, length)
      ;
1452    \textcolor{comment}{//Dump message contents for debugging purpose}
1453    \hyperlink{ndp_8c_a7d9e788153f14c99e9d5b76bb5f3dc5e}{ndpDumpRouterSolMessage}(message);
1454 
1455    \textcolor{comment}{//Send Router Solicitation message}
1456    error = \hyperlink{ipv6_8c_ae9edf1ac407897f91eb5caed37df7c3c}{ipv6SendDatagram}(interface, &pseudoHeader, buffer, offset, 
      \hyperlink{ndp_8h_aed9955a5c2a9d8b039e188d88f2bd923}{NDP\_HOP\_LIMIT});
1457 
1458    \textcolor{comment}{//Free previously allocated memory}
1459    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
1460    \textcolor{comment}{//Return status code}
1461    \textcolor{keywordflow}{return} error;
1462 \}
\end{DoxyCode}
\mbox{\Hypertarget{ndp_8c_ae1a7cfa93be8d2ff1c062d278796ddc1}\label{ndp_8c_ae1a7cfa93be8d2ff1c062d278796ddc1}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Tick@{ndp\+Tick}}
\index{ndp\+Tick@{ndp\+Tick}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Tick()}{ndpTick()}}
{\footnotesize\ttfamily void ndp\+Tick (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



N\+DP timer handler. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 276 of file ndp.\+c.


\begin{DoxyCode}
277 \{
278    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
279    \hyperlink{structNdpContext}{NdpContext} *context;
280 
281    \textcolor{comment}{//Point to the NDP context}
282    context = &interface->ndpContext;
283 
284    \textcolor{comment}{//Get current time}
285    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
286 
287    \textcolor{comment}{//When an interface becomes enabled, a host may send some Router}
288    \textcolor{comment}{//Solicitation messages to obtain Router Advertisements quickly}
289    \textcolor{keywordflow}{if}(interface->linkState && !interface->ipv6Context.isRouter)
290    \{
291       \textcolor{comment}{//Make sure that a valid link-local address has been assigned to the interface}
292       \textcolor{keywordflow}{if}(\hyperlink{ipv6_8h_a0650f6186ad38b49662420902ae208ea}{ipv6GetLinkLocalAddrState}(interface) == 
      \hyperlink{ipv6_8h_acb54c5e2b7ee1652f5bf055e14cc518daaa3a0ce422a678d8eb14a36f4c642d16}{IPV6\_ADDR\_STATE\_PREFERRED})
293       \{
294          \textcolor{comment}{//The host should transmit up to MAX\_RTR\_SOLICITATIONS Router}
295          \textcolor{comment}{//Solicitation messages}
296          \textcolor{keywordflow}{if}(context->\hyperlink{structNdpContext_aa6eac8a31ad5f605018412cbdc75fbee}{rtrSolicitationCount} == 0)
297          \{
298             \textcolor{comment}{//Set time stamp}
299             context->\hyperlink{structNdpContext_a141f76af5b53aa964be76110f7c80791}{timestamp} = \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
300 
301             \textcolor{comment}{//Check whether the host has already performed Duplicate Address}
302             \textcolor{comment}{//Detection for the link-local address}
303             \textcolor{keywordflow}{if}(context->\hyperlink{structNdpContext_a47458438d295650512e889531b1e0471}{dupAddrDetectTransmits} > 0)
304             \{
305                \textcolor{comment}{//If a host has already performed a random delay since the interface}
306                \textcolor{comment}{//became enabled, there is no need to delay again before sending the}
307                \textcolor{comment}{//first Router Solicitation message}
308                context->\hyperlink{structNdpContext_a25bace7e12dfc4b36791709f5cf836ac}{timeout} = 0;
309             \}
310             \textcolor{keywordflow}{else}
311             \{
312                \textcolor{comment}{//Before a host sends an initial solicitation, it should delay the}
313                \textcolor{comment}{//transmission for a random amount of time in order to alleviate}
314                \textcolor{comment}{//congestion when many hosts start up on a link at the same time}
315                context->\hyperlink{structNdpContext_a25bace7e12dfc4b36791709f5cf836ac}{timeout} = \hyperlink{net_8c_af45ea0afc9806749114ec85e507014e1}{netGetRandRange}(context->
      \hyperlink{structNdpContext_a79e43c50b5147074a654da9c242008d3}{minRtrSolicitationDelay},
316                   context->\hyperlink{structNdpContext_a5f21cd7b9fe8e523cd7b01d6274cb11c}{maxRtrSolicitationDelay});
317             \}
318 
319             \textcolor{comment}{//Prepare to send the first Router Solicitation message}
320             context->\hyperlink{structNdpContext_aa6eac8a31ad5f605018412cbdc75fbee}{rtrSolicitationCount} = 1;
321          \}
322          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->\hyperlink{structNdpContext_aa6eac8a31ad5f605018412cbdc75fbee}{rtrSolicitationCount} <= context->
      \hyperlink{structNdpContext_aceadc715ad12f0148cdba9acba96949a}{maxRtrSolicitations})
323          \{
324             \textcolor{comment}{//Once the host sends a Router Solicitation, and receives a valid}
325             \textcolor{comment}{//Router Advertisement with a non-zero Router Lifetime, the host must}
326             \textcolor{comment}{//desist from sending additional solicitations on that interface}
327             \textcolor{keywordflow}{if}(!context->\hyperlink{structNdpContext_af16d6cf8472c6b3827ba500f25458579}{rtrAdvReceived})
328             \{
329                \textcolor{comment}{//Check current time}
330                \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, context->\hyperlink{structNdpContext_a141f76af5b53aa964be76110f7c80791}{timestamp} + context->
      \hyperlink{structNdpContext_a25bace7e12dfc4b36791709f5cf836ac}{timeout}) >= 0)
331                \{
332                   \textcolor{comment}{//Send Router Solicitation message}
333                   \hyperlink{ndp_8c_a7553aa29f5212b7e5be1faad1af42925}{ndpSendRouterSol}(interface);
334 
335                   \textcolor{comment}{//Save the time at which the message was sent}
336                   context->\hyperlink{structNdpContext_a141f76af5b53aa964be76110f7c80791}{timestamp} = \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
337                   \textcolor{comment}{//Set timeout value}
338                   context->\hyperlink{structNdpContext_a25bace7e12dfc4b36791709f5cf836ac}{timeout} = context->\hyperlink{structNdpContext_aeb312645a94a797c2e509c4753562fb4}{rtrSolicitationInterval};
339                   \textcolor{comment}{//Increment retransmission counter}
340                   context->\hyperlink{structNdpContext_aa6eac8a31ad5f605018412cbdc75fbee}{rtrSolicitationCount}++;
341                \}
342             \}
343          \}
344       \}
345    \}
346 
347    \textcolor{comment}{//Periodically update the Neighbor Cache}
348    \hyperlink{ndp__cache_8c_adefd18b05d210d7cdba584d514d2088c}{ndpUpdateNeighborCache}(interface);
349 
350    \textcolor{comment}{//Manage the lifetime of IPv6 addresses}
351    \hyperlink{ndp__misc_8c_a11e39a940e9b547e8f1dc2bfb4d6f2b9}{ndpUpdateAddrList}(interface);
352 
353    \textcolor{comment}{//Periodically update the Prefix List}
354    \hyperlink{ndp__misc_8c_a6606369f2059b60ad027762b27d7570e}{ndpUpdatePrefixList}(interface);
355 
356    \textcolor{comment}{//Periodically update the Default Router List}
357    \hyperlink{ndp__misc_8c_a0b14d06878fd62aace574f808d819677}{ndpUpdateDefaultRouterList}(interface);
358 \}
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{ndp_8c_ac0dbbb540cd7f7eb6e8f42b820ef5407}\label{ndp_8c_ac0dbbb540cd7f7eb6e8f42b820ef5407}} 
\index{ndp.\+c@{ndp.\+c}!ndp\+Tick\+Counter@{ndp\+Tick\+Counter}}
\index{ndp\+Tick\+Counter@{ndp\+Tick\+Counter}!ndp.\+c@{ndp.\+c}}
\subsubsection{\texorpdfstring{ndp\+Tick\+Counter}{ndpTickCounter}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t} ndp\+Tick\+Counter}



Definition at line 59 of file ndp.\+c.

