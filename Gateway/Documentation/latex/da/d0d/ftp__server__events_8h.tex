\hypertarget{ftp__server__events_8h}{}\section{cyclone\+\_\+tcp/ftp/ftp\+\_\+server\+\_\+events.h File Reference}
\label{ftp__server__events_8h}\index{cyclone\+\_\+tcp/ftp/ftp\+\_\+server\+\_\+events.\+h@{cyclone\+\_\+tcp/ftp/ftp\+\_\+server\+\_\+events.\+h}}


F\+TP server (event handlers)  


{\ttfamily \#include \char`\"{}ftp/ftp\+\_\+server.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{ftp__server__events_8h_a7e6589130ad309cdc58d3275d127904b}{F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS}~(180 $\ast$ 86400)
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{ftp__server__events_8h_a91af7a6efcabedb8b20ae2363e11a866}{ftp\+Server\+Control\+Event\+Handler} (\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$context, \hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$connection, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} event\+Flags)
\begin{DoxyCompactList}\small\item\em Control connection event handler. \end{DoxyCompactList}\item 
void \hyperlink{ftp__server__events_8h_ae5a2e409a5596eea342ed9fd2b33f933}{ftp\+Server\+Data\+Event\+Handler} (\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$context, \hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$connection, \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} event\+Flags)
\begin{DoxyCompactList}\small\item\em Data connection event handler. \end{DoxyCompactList}\item 
void \hyperlink{ftp__server__events_8h_a10471e0cb73797e19e3673c29fce8b9c}{ftp\+Server\+Send\+Data} (\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$context, \hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Send data on the data connection. \end{DoxyCompactList}\item 
void \hyperlink{ftp__server__events_8h_ae9be8006b96e85756b1b25259adab5d3}{ftp\+Server\+Receive\+Data} (\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$context, \hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$connection)
\begin{DoxyCompactList}\small\item\em Receive data on the data connection. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
F\+TP server (event handlers) 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+4 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{ftp__server__events_8h_a7e6589130ad309cdc58d3275d127904b}\label{ftp__server__events_8h_a7e6589130ad309cdc58d3275d127904b}} 
\index{ftp\+\_\+server\+\_\+events.\+h@{ftp\+\_\+server\+\_\+events.\+h}!F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS@{F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS}}
\index{F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS@{F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS}!ftp\+\_\+server\+\_\+events.\+h@{ftp\+\_\+server\+\_\+events.\+h}}
\subsubsection{\texorpdfstring{F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS}{FTP\_SERVER\_180\_DAYS}}
{\footnotesize\ttfamily \#define F\+T\+P\+\_\+\+S\+E\+R\+V\+E\+R\+\_\+180\+\_\+\+D\+A\+YS~(180 $\ast$ 86400)}



Definition at line 38 of file ftp\+\_\+server\+\_\+events.\+h.



\subsection{Function Documentation}
\mbox{\Hypertarget{ftp__server__events_8h_a91af7a6efcabedb8b20ae2363e11a866}\label{ftp__server__events_8h_a91af7a6efcabedb8b20ae2363e11a866}} 
\index{ftp\+\_\+server\+\_\+events.\+h@{ftp\+\_\+server\+\_\+events.\+h}!ftp\+Server\+Control\+Event\+Handler@{ftp\+Server\+Control\+Event\+Handler}}
\index{ftp\+Server\+Control\+Event\+Handler@{ftp\+Server\+Control\+Event\+Handler}!ftp\+\_\+server\+\_\+events.\+h@{ftp\+\_\+server\+\_\+events.\+h}}
\subsubsection{\texorpdfstring{ftp\+Server\+Control\+Event\+Handler()}{ftpServerControlEventHandler()}}
{\footnotesize\ttfamily void ftp\+Server\+Control\+Event\+Handler (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$}]{context,  }\item[{\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{event\+Flags }\end{DoxyParamCaption})}



Control connection event handler. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP server context \\
\hline
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em event\+Flags} & Event to be processed \\
\hline
\end{DoxyParams}


Definition at line 73 of file ftp\+\_\+server\+\_\+events.\+c.


\begin{DoxyCode}
75 \{
76    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
77    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
78 
79    \textcolor{comment}{//Send buffer is available for writing?}
80    \textcolor{keywordflow}{if}(eventFlags == \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea078fc309f8e29689ee08e584f00a73b6}{SOCKET\_EVENT\_TX\_READY})
81    \{
82       \textcolor{comment}{//Send data back to the client}
83       error = \hyperlink{socket_8c_aa4eeb3a3294d14d681675ba9f0d3e568}{socketSend}(connection->controlSocket, connection->response +
84          connection->responsePos, connection->responseLength, &n, 0);
85 
86       \textcolor{comment}{//Failed to send data?}
87       \textcolor{keywordflow}{if}(error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} && error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
88       \{
89          \textcolor{comment}{//Close connection with the client}
90          \hyperlink{ftp__server__misc_8c_a131bc4ee0544ae32eee4cf829f006a11}{ftpServerCloseConnection}(context, connection);
91          \textcolor{comment}{//Exit immediately}
92          \textcolor{keywordflow}{return};
93       \}
94 
95       \textcolor{comment}{//Advance data pointer}
96       connection->responsePos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
97       \textcolor{comment}{//Number of bytes still available in the response buffer}
98       connection->responseLength -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
99    \}
100    \textcolor{comment}{//Data is pending in the receive buffer?}
101    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(eventFlags == \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea72985d7e82625f037ca8a6734f49996c}{SOCKET\_EVENT\_RX\_READY})
102    \{
103       \textcolor{comment}{//Read data from the client}
104       error = \hyperlink{socket_8c_a894c7bf0bfd4e3886fc584ed7ebbb087}{socketReceive}(connection->controlSocket,
105          connection->command + connection->commandLength,
106          \hyperlink{ftp__server_8h_a311e12601252dc2319ee256bb6e714ba}{FTP\_SERVER\_MAX\_LINE\_LEN} - connection->commandLength, &n, 0);
107 
108       \textcolor{comment}{//Failed to receive data?}
109       \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca8b7223773301a4f3dd811f1d35e13ce4}{ERROR\_END\_OF\_STREAM})
110       \{
111          \textcolor{comment}{//Gracefully disconnect from the remote host}
112          connection->controlState = FTP\_CONTROL\_STATE\_WAIT\_ACK;
113          \textcolor{comment}{//Exit immediately}
114          \textcolor{keywordflow}{return};
115       \}
116       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(error)
117       \{
118          \textcolor{comment}{//Close connection with the client}
119          \hyperlink{ftp__server__misc_8c_a131bc4ee0544ae32eee4cf829f006a11}{ftpServerCloseConnection}(context, connection);
120          \textcolor{comment}{//Exit immediately}
121          \textcolor{keywordflow}{return};
122       \}
123 
124       \textcolor{comment}{//Number of bytes available in the command buffer}
125       connection->commandLength += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
126       \textcolor{comment}{//Process incoming command}
127       ftpServerProcessCmd(context, connection);
128    \}
129    \textcolor{comment}{//Data are transmitted and acknowledged?}
130    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(eventFlags == \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea9303c52298e0adf175b7064fbe7ce077}{SOCKET\_EVENT\_TX\_ACKED})
131    \{
132       \textcolor{comment}{//Disable transmission}
133       \hyperlink{socket_8c_acc736b53dba4a0d3b11b63f75cdcfffb}{socketShutdown}(connection->controlSocket, \hyperlink{socket_8h_a36ee33c18de64f549a6336d1aa7333b7a535dc5f70a642b86e56e6e83ce2a3378}{SOCKET\_SD\_SEND});
134       \textcolor{comment}{//Next state}
135       connection->controlState = FTP\_CONTROL\_STATE\_SHUTDOWN\_TX;
136    \}
137    \textcolor{comment}{//Transmission is shut down?}
138    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(eventFlags == \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea7c192744b90c583effbac921fe00c4a0}{SOCKET\_EVENT\_TX\_SHUTDOWN})
139    \{
140       \textcolor{comment}{//Disable reception}
141       \hyperlink{socket_8c_acc736b53dba4a0d3b11b63f75cdcfffb}{socketShutdown}(connection->controlSocket, \hyperlink{socket_8h_a36ee33c18de64f549a6336d1aa7333b7a88cccdaadbcce09cccd7561d10af6a39}{SOCKET\_SD\_RECEIVE});
142       \textcolor{comment}{//Next state}
143       connection->controlState = FTP\_CONTROL\_STATE\_SHUTDOWN\_RX;
144    \}
145    \textcolor{comment}{//Reception is shut down?}
146    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(eventFlags == \hyperlink{socket_8h_add8a4c36456f478ab23bd4372aebde6ea0578189399787b74acb9636b9eef30fc}{SOCKET\_EVENT\_RX\_SHUTDOWN})
147    \{
148       \textcolor{comment}{//Properly close connection}
149       \hyperlink{ftp__server__misc_8c_a131bc4ee0544ae32eee4cf829f006a11}{ftpServerCloseConnection}(context, connection);
150    \}
151 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__events_8h_ae5a2e409a5596eea342ed9fd2b33f933}\label{ftp__server__events_8h_ae5a2e409a5596eea342ed9fd2b33f933}} 
\index{ftp\+\_\+server\+\_\+events.\+h@{ftp\+\_\+server\+\_\+events.\+h}!ftp\+Server\+Data\+Event\+Handler@{ftp\+Server\+Data\+Event\+Handler}}
\index{ftp\+Server\+Data\+Event\+Handler@{ftp\+Server\+Data\+Event\+Handler}!ftp\+\_\+server\+\_\+events.\+h@{ftp\+\_\+server\+\_\+events.\+h}}
\subsubsection{\texorpdfstring{ftp\+Server\+Data\+Event\+Handler()}{ftpServerDataEventHandler()}}
{\footnotesize\ttfamily void ftp\+Server\+Data\+Event\+Handler (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$}]{context,  }\item[{\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$}]{connection,  }\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{event\+Flags }\end{DoxyParamCaption})}



Data connection event handler. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP server context \\
\hline
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\mbox{\tt in}  & {\em event\+Flags} & Event to be processed \\
\hline
\end{DoxyParams}


Definition at line 161 of file ftp\+\_\+server\+\_\+events.\+c.


\begin{DoxyCode}
163 \{
164    \textcolor{comment}{//Any connection attempt?}
165    \textcolor{keywordflow}{if}(connection->dataState == FTP\_DATA\_STATE\_LISTEN)
166    \{
167       \textcolor{comment}{//Accept data connection}
168       ftpServerAcceptDataConnection(connection);
169    \}
170    \textcolor{comment}{//Ready to send data?}
171    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->dataState == FTP\_DATA\_STATE\_SEND)
172    \{
173       \textcolor{comment}{//Send more data to the remote host}
174       \hyperlink{ftp__server__events_8c_a10471e0cb73797e19e3673c29fce8b9c}{ftpServerSendData}(context, connection);
175    \}
176    \textcolor{comment}{//Any data pending in the receive buffer?}
177    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->dataState == FTP\_DATA\_STATE\_RECEIVE)
178    \{
179       \textcolor{comment}{//Process incoming data}
180       \hyperlink{ftp__server__events_8c_ae9be8006b96e85756b1b25259adab5d3}{ftpServerReceiveData}(context, connection);
181    \}
182    \textcolor{comment}{//Data are transmitted and acknowledged?}
183    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->dataState == FTP\_DATA\_STATE\_WAIT\_ACK)
184    \{
185       \textcolor{comment}{//Disable transmission}
186       \hyperlink{socket_8c_acc736b53dba4a0d3b11b63f75cdcfffb}{socketShutdown}(connection->dataSocket, \hyperlink{socket_8h_a36ee33c18de64f549a6336d1aa7333b7a535dc5f70a642b86e56e6e83ce2a3378}{SOCKET\_SD\_SEND});
187       \textcolor{comment}{//Next state}
188       connection->dataState = FTP\_DATA\_STATE\_SHUTDOWN\_TX;
189    \}
190    \textcolor{comment}{//Transmission is shut down?}
191    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->dataState == FTP\_DATA\_STATE\_SHUTDOWN\_TX)
192    \{
193       \textcolor{comment}{//Disable reception}
194       \hyperlink{socket_8c_acc736b53dba4a0d3b11b63f75cdcfffb}{socketShutdown}(connection->dataSocket, \hyperlink{socket_8h_a36ee33c18de64f549a6336d1aa7333b7a88cccdaadbcce09cccd7561d10af6a39}{SOCKET\_SD\_RECEIVE});
195       \textcolor{comment}{//Next state}
196       connection->dataState = FTP\_DATA\_STATE\_SHUTDOWN\_RX;
197    \}
198    \textcolor{comment}{//Reception is shut down?}
199    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->dataState == FTP\_DATA\_STATE\_SHUTDOWN\_RX)
200    \{
201       \textcolor{comment}{//Close the data connection}
202       ftpServerCloseDataConnection(connection);
203 
204       \textcolor{comment}{//Back to idle state}
205       connection->controlState = FTP\_CONTROL\_STATE\_IDLE;
206 
207       \textcolor{comment}{//Transfer status}
208       strcpy(connection->response, \textcolor{stringliteral}{"226 Transfer complete\(\backslash\)r\(\backslash\)n"});
209       \textcolor{comment}{//Debug message}
210       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"FTP server: %s"}, connection->response);
211 
212       \textcolor{comment}{//Number of bytes in the response buffer}
213       connection->responseLength = strlen(connection->response);
214       connection->responsePos = 0;
215    \}
216 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__events_8h_ae9be8006b96e85756b1b25259adab5d3}\label{ftp__server__events_8h_ae9be8006b96e85756b1b25259adab5d3}} 
\index{ftp\+\_\+server\+\_\+events.\+h@{ftp\+\_\+server\+\_\+events.\+h}!ftp\+Server\+Receive\+Data@{ftp\+Server\+Receive\+Data}}
\index{ftp\+Server\+Receive\+Data@{ftp\+Server\+Receive\+Data}!ftp\+\_\+server\+\_\+events.\+h@{ftp\+\_\+server\+\_\+events.\+h}}
\subsubsection{\texorpdfstring{ftp\+Server\+Receive\+Data()}{ftpServerReceiveData()}}
{\footnotesize\ttfamily void ftp\+Server\+Receive\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$}]{context,  }\item[{\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Receive data on the data connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP server context \\
\hline
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}


Definition at line 425 of file ftp\+\_\+server\+\_\+events.\+c.


\begin{DoxyCode}
426 \{
427    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
428    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} eof;
429    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
430 
431    \textcolor{comment}{//File transfer in progress?}
432    \textcolor{keywordflow}{if}(connection->controlState == FTP\_CONTROL\_STATE\_STOR ||
433       connection->controlState == FTP\_CONTROL\_STATE\_APPE)
434    \{
435       \textcolor{comment}{//Read incoming data}
436       error = \hyperlink{socket_8c_a894c7bf0bfd4e3886fc584ed7ebbb087}{socketReceive}(connection->dataSocket,
437          connection->buffer + connection->bufferPos,
438          \hyperlink{ftp__server_8h_a37067cf14f1730ca29fec31f4c8a2bff}{FTP\_SERVER\_BUFFER\_SIZE} - connection->bufferLength, &n, 0);
439 
440       \textcolor{comment}{//Any error to report?}
441       \textcolor{keywordflow}{if}(error)
442       \{
443          \textcolor{comment}{//Cannot read more data}
444          eof = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
445       \}
446       \textcolor{keywordflow}{else}
447       \{
448          \textcolor{comment}{//Successful read operation}
449          eof = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
450 
451          \textcolor{comment}{//Advance data pointer}
452          connection->bufferPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
453          connection->bufferLength += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
454       \}
455 
456       \textcolor{comment}{//Read data until the buffer is full or the end of the file is reached}
457       \textcolor{keywordflow}{if}(eof || connection->bufferLength >= \hyperlink{ftp__server_8h_a37067cf14f1730ca29fec31f4c8a2bff}{FTP\_SERVER\_BUFFER\_SIZE})
458       \{
459          \textcolor{comment}{//Any data to be written?}
460          \textcolor{keywordflow}{if}(connection->bufferLength > 0)
461          \{
462             \textcolor{comment}{//Write data to the specified file}
463             error = \hyperlink{fs__port__fatfs_8c_aa5372052eff813ade8102cff497ad739}{fsWriteFile}(connection->file,
464                connection->buffer, connection->bufferLength);
465 
466             \textcolor{comment}{//Any error to report?}
467             \textcolor{keywordflow}{if}(error)
468             \{
469                \textcolor{comment}{//Close the data connection}
470                ftpServerCloseDataConnection(connection);
471 
472                \textcolor{comment}{//Release previously allocated resources}
473                \hyperlink{fs__port__fatfs_8c_a563173066eb2924f61e00e87fbf9d0bc}{fsCloseFile}(connection->file);
474                connection->file = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
475 
476                \textcolor{comment}{//Back to idle state}
477                connection->controlState = FTP\_CONTROL\_STATE\_IDLE;
478 
479                \textcolor{comment}{//Transfer status}
480                strcpy(connection->response, \textcolor{stringliteral}{"451 Transfer aborted\(\backslash\)r\(\backslash\)n"});
481                \textcolor{comment}{//Debug message}
482                \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"FTP server: %s"}, connection->response);
483 
484                \textcolor{comment}{//Number of bytes in the response buffer}
485                connection->responseLength = strlen(connection->response);
486                connection->responsePos = 0;
487 
488                \textcolor{comment}{//Exit immediately}
489                \textcolor{keywordflow}{return};
490             \}
491          \}
492 
493          \textcolor{comment}{//Flush reception buffer}
494          connection->bufferLength = 0;
495          connection->bufferPos = 0;
496       \}
497 
498       \textcolor{comment}{//End of stream?}
499       \textcolor{keywordflow}{if}(eof)
500       \{
501          \textcolor{comment}{//Close file}
502          \hyperlink{fs__port__fatfs_8c_a563173066eb2924f61e00e87fbf9d0bc}{fsCloseFile}(connection->file);
503          connection->file = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
504 
505          \textcolor{comment}{//Graceful shutdown sequence}
506          connection->dataState = FTP\_DATA\_STATE\_WAIT\_ACK;
507       \}
508    \}
509    \textcolor{comment}{//Invalid state?}
510    \textcolor{keywordflow}{else}
511    \{
512       \textcolor{comment}{//The FTP server has encountered a critical error}
513       \hyperlink{ftp__server__misc_8c_a131bc4ee0544ae32eee4cf829f006a11}{ftpServerCloseConnection}(context, connection);
514    \}
515 \}
\end{DoxyCode}
\mbox{\Hypertarget{ftp__server__events_8h_a10471e0cb73797e19e3673c29fce8b9c}\label{ftp__server__events_8h_a10471e0cb73797e19e3673c29fce8b9c}} 
\index{ftp\+\_\+server\+\_\+events.\+h@{ftp\+\_\+server\+\_\+events.\+h}!ftp\+Server\+Send\+Data@{ftp\+Server\+Send\+Data}}
\index{ftp\+Server\+Send\+Data@{ftp\+Server\+Send\+Data}!ftp\+\_\+server\+\_\+events.\+h@{ftp\+\_\+server\+\_\+events.\+h}}
\subsubsection{\texorpdfstring{ftp\+Server\+Send\+Data()}{ftpServerSendData()}}
{\footnotesize\ttfamily void ftp\+Server\+Send\+Data (\begin{DoxyParamCaption}\item[{\hyperlink{ftp__server_8h_af7294ff4e42ca4befb7414ce9fd6f287}{Ftp\+Server\+Context} $\ast$}]{context,  }\item[{\hyperlink{ftp__server_8h_ab682699c15473841571a42c3df57e9d2}{Ftp\+Client\+Connection} $\ast$}]{connection }\end{DoxyParamCaption})}



Send data on the data connection. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the F\+TP server context \\
\hline
\mbox{\tt in}  & {\em connection} & Pointer to the client connection \\
\hline
\end{DoxyParams}


Definition at line 225 of file ftp\+\_\+server\+\_\+events.\+c.


\begin{DoxyCode}
226 \{
227    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
228    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
229 
230    \textcolor{comment}{//Any data waiting for transmission?}
231    \textcolor{keywordflow}{if}(connection->bufferLength > 0)
232    \{
233       \textcolor{comment}{//Send more data}
234       error = \hyperlink{socket_8c_aa4eeb3a3294d14d681675ba9f0d3e568}{socketSend}(connection->dataSocket, connection->buffer +
235          connection->bufferPos, connection->bufferLength, &n, 0);
236 
237       \textcolor{comment}{//Failed to send data?}
238       \textcolor{keywordflow}{if}(error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR} && error != \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4d0f7be53b837f004379ac6bbd56f1e2}{ERROR\_TIMEOUT})
239       \{
240          \textcolor{comment}{//Close the data connection}
241          ftpServerCloseDataConnection(connection);
242 
243          \textcolor{comment}{//Release previously allocated resources}
244          \textcolor{keywordflow}{if}(connection->file != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
245          \{
246             \hyperlink{fs__port__fatfs_8c_a563173066eb2924f61e00e87fbf9d0bc}{fsCloseFile}(connection->file);
247             connection->file = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
248          \}
249 
250          \textcolor{keywordflow}{if}(connection->dir != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
251          \{
252             \hyperlink{fs__port__fatfs_8c_a94bfd6c1ae79880d0a5cbe3b491368f2}{fsCloseDir}(connection->dir);
253             connection->dir = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
254          \}
255 
256          \textcolor{comment}{//Back to idle state}
257          connection->controlState = FTP\_CONTROL\_STATE\_IDLE;
258 
259          \textcolor{comment}{//Transfer status}
260          strcpy(connection->response, \textcolor{stringliteral}{"451 Transfer aborted\(\backslash\)r\(\backslash\)n"});
261          \textcolor{comment}{//Debug message}
262          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"FTP server: %s"}, connection->response);
263 
264          \textcolor{comment}{//Number of bytes in the response buffer}
265          connection->responseLength = strlen(connection->response);
266          connection->responsePos = 0;
267 
268          \textcolor{comment}{//Exit immediately}
269          \textcolor{keywordflow}{return};
270       \}
271 
272       \textcolor{comment}{//Advance data pointer}
273       connection->bufferPos += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
274       \textcolor{comment}{//Number of bytes still available in the buffer}
275       connection->bufferLength -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
276    \}
277 
278    \textcolor{comment}{//Empty transmission buffer?}
279    \textcolor{keywordflow}{if}(connection->bufferLength == 0)
280    \{
281       \textcolor{comment}{//File transfer in progress?}
282       \textcolor{keywordflow}{if}(connection->controlState == FTP\_CONTROL\_STATE\_RETR)
283       \{
284          \textcolor{comment}{//Read more data}
285          error = \hyperlink{fs__port__fatfs_8c_af802c67ab60bcc6273bcc65a967d99ab}{fsReadFile}(connection->file,
286             connection->buffer, \hyperlink{ftp__server_8h_a37067cf14f1730ca29fec31f4c8a2bff}{FTP\_SERVER\_BUFFER\_SIZE}, &n);
287 
288          \textcolor{comment}{//End of stream?}
289          \textcolor{keywordflow}{if}(error)
290          \{
291             \textcolor{comment}{//Close file}
292             \hyperlink{fs__port__fatfs_8c_a563173066eb2924f61e00e87fbf9d0bc}{fsCloseFile}(connection->file);
293             connection->file = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
294 
295             \textcolor{comment}{//Wait for all the data to be transmitted and acknowledged}
296             connection->dataState = FTP\_DATA\_STATE\_WAIT\_ACK;
297 
298             \textcolor{comment}{//Exit immediately}
299             \textcolor{keywordflow}{return};
300          \}
301       \}
302       \textcolor{comment}{//Directory listing in progress?}
303       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(connection->controlState == FTP\_CONTROL\_STATE\_LIST)
304       \{
305          \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} perm;
306          time\_t currentTime;
307          time\_t modified;
308          \hyperlink{compiler__port_8h_a40bb5262bf908c328fbcfbe5d29d0201}{char\_t} *path;
309          \hyperlink{structFsDirEntry}{FsDirEntry} dirEntry;
310 
311          \textcolor{comment}{//Read a new entry in the directory}
312          error = \hyperlink{fs__port__fatfs_8c_af9286e05d7b1032502ef39874a5b85ee}{fsReadDir}(connection->dir, &dirEntry);
313 
314          \textcolor{comment}{//End of stream?}
315          \textcolor{keywordflow}{if}(error)
316          \{
317             \textcolor{comment}{//Close directory}
318             \hyperlink{fs__port__fatfs_8c_a94bfd6c1ae79880d0a5cbe3b491368f2}{fsCloseDir}(connection->dir);
319             connection->dir = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
320 
321             \textcolor{comment}{//Wait for all the data to be transmitted and acknowledged}
322             connection->dataState = FTP\_DATA\_STATE\_WAIT\_ACK;
323 
324             \textcolor{comment}{//Exit immediately}
325             \textcolor{keywordflow}{return};
326          \}
327 
328          \textcolor{comment}{//Point to the scratch buffer}
329          path = connection->buffer;
330 
331          \textcolor{comment}{//Get the pathname of the directory being listed}
332          strcpy(path, connection->path);
333          \textcolor{comment}{//Retrieve the full pathname}
334          \hyperlink{path_8c_a38625df4e9abd106fb932b8ff308adc3}{pathCombine}(path, dirEntry.\hyperlink{structFsDirEntry_ab2a81b6bc89dc202e25448d2afdbae5b}{name}, \hyperlink{ftp__server_8h_ade570d175c68d8272bc482bf337af10f}{FTP\_SERVER\_MAX\_PATH\_LEN});
335          \hyperlink{path_8c_a64519f81386b6ece797fb51f06e3052d}{pathCanonicalize}(path);
336 
337          \textcolor{comment}{//Get permissions for the specified file}
338          perm = \hyperlink{ftp__server__misc_8c_a5c8fef27bdd37ac48d983912577b8ac3}{ftpServerGetFilePermissions}(context, connection, path);
339 
340          \textcolor{comment}{//Enforce access rights}
341          \textcolor{keywordflow}{if}(perm & \hyperlink{ftp__server_8h_aa941a819cc54df0f491b11d56ebe4a5eaeede2660186e1e3800757ec2c6744df6}{FTP\_FILE\_PERM\_LIST})
342          \{
343             \textcolor{comment}{//Format links, owner, group and size fields}
344             n = sprintf(connection->buffer, \textcolor{stringliteral}{"----------   1 owner    group    %10"} PRIu32,
345                dirEntry.\hyperlink{structFsDirEntry_acface51e05962d480c731d0b0c7b1d0e}{size});
346 
347             \textcolor{comment}{//Check whether the current entry is a directory}
348             \textcolor{keywordflow}{if}(dirEntry.\hyperlink{structFsDirEntry_ae6bc73c8708ef8541ed7dc2c5f802e96}{attributes} & \hyperlink{fs__port_8h_a2edaa29f659eebea8cf331b1066405a3a24f8258160b4e054c565570b6260db96}{FS\_FILE\_ATTR\_DIRECTORY})
349                connection->buffer[0] = \textcolor{charliteral}{'d'};
350 
351             \textcolor{comment}{//Read access permitted?}
352             \textcolor{keywordflow}{if}(perm & \hyperlink{ftp__server_8h_aa941a819cc54df0f491b11d56ebe4a5ea2f3957b04a30fc147df1c3818e26fe1b}{FTP\_FILE\_PERM\_READ})
353             \{
354                connection->buffer[1] = \textcolor{charliteral}{'r'};
355                connection->buffer[4] = \textcolor{charliteral}{'r'};
356                connection->buffer[7] = \textcolor{charliteral}{'r'};
357             \}
358 
359             \textcolor{comment}{//Write access permitted?}
360             \textcolor{keywordflow}{if}(perm & \hyperlink{ftp__server_8h_aa941a819cc54df0f491b11d56ebe4a5eab2002a5415790b9b7318f8067f623ff0}{FTP\_FILE\_PERM\_WRITE})
361             \{
362                \textcolor{comment}{//Make sure the file is not marked as read-only}
363                \textcolor{keywordflow}{if}(!(dirEntry.\hyperlink{structFsDirEntry_ae6bc73c8708ef8541ed7dc2c5f802e96}{attributes} & \hyperlink{fs__port_8h_a2edaa29f659eebea8cf331b1066405a3a218468508475fb0ef7155299f48fc9e5}{FS\_FILE\_ATTR\_READ\_ONLY}))
364                \{
365                   connection->buffer[2] = \textcolor{charliteral}{'w'};
366                   connection->buffer[5] = \textcolor{charliteral}{'w'};
367                   connection->buffer[8] = \textcolor{charliteral}{'w'};
368                \}
369             \}
370 
371             \textcolor{comment}{//Get current time}
372             currentTime = \hyperlink{date__time_8c_a5ea5d60e1fafcd89917ee76d57981aae}{getCurrentUnixTime}();
373             \textcolor{comment}{//Get modification time}
374             modified = \hyperlink{date__time_8c_a399c87076e1ac03c9542ba1544c06f21}{convertDateToUnixTime}(&dirEntry.
      \hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified});
375 
376             \textcolor{comment}{//Check whether the modification time is within the previous 180 days}
377             \textcolor{keywordflow}{if}(currentTime > modified && currentTime < (modified + 
      \hyperlink{ftp__server__events_8h_a7e6589130ad309cdc58d3275d127904b}{FTP\_SERVER\_180\_DAYS}))
378             \{
379                \textcolor{comment}{//The format of the date/time field is Mmm dd hh:mm}
380                n += sprintf(connection->buffer + n, \textcolor{stringliteral}{" %s %02"} PRIu8 \textcolor{stringliteral}{" %02"} PRIu8 \textcolor{stringliteral}{":%02"} PRIu8,
381                   \hyperlink{ftp__server__events_8c_a9430ddee3d3efc767708393fd75a734b}{months}[\hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(dirEntry.\hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.\hyperlink{structDateTime_ac895afb51c74941c50205f746b709148}{month}, 12)], dirEntry.
      \hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.\hyperlink{structDateTime_a727866b5ecdfda1edf946efe86aa74af}{day},
382                   dirEntry.\hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.\hyperlink{structDateTime_a46fa4e0c13c7fc19c8ae97a5642c4a15}{hours}, dirEntry.\hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.
      \hyperlink{structDateTime_a9e705a28fc51e333616553313107d579}{minutes});
383             \}
384             \textcolor{keywordflow}{else}
385             \{
386                \textcolor{comment}{//The format of the date/time field is Mmm dd  yyyy}
387                n += sprintf(connection->buffer + n, \textcolor{stringliteral}{" %s %02"} PRIu8 \textcolor{stringliteral}{"  %04"} PRIu16,
388                   \hyperlink{ftp__server__events_8c_a9430ddee3d3efc767708393fd75a734b}{months}[\hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(dirEntry.\hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.\hyperlink{structDateTime_ac895afb51c74941c50205f746b709148}{month}, 12)], dirEntry.
      \hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.\hyperlink{structDateTime_a727866b5ecdfda1edf946efe86aa74af}{day},
389                   dirEntry.\hyperlink{structFsDirEntry_abd332197750fa0d7181d206355a86b99}{modified}.\hyperlink{structDateTime_a0a61d60280541502e47f9a7fd6e1c8d2}{year});
390             \}
391 
392             \textcolor{comment}{//Append filename}
393             n += sprintf(connection->buffer + n, \textcolor{stringliteral}{" %s\(\backslash\)r\(\backslash\)n"}, dirEntry.\hyperlink{structFsDirEntry_ab2a81b6bc89dc202e25448d2afdbae5b}{name});
394             \textcolor{comment}{//Debug message}
395             \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"FTP server: %s"}, connection->buffer);
396          \}
397          \textcolor{keywordflow}{else}
398          \{
399             \textcolor{comment}{//Insufficient access rights}
400             n = 0;
401          \}
402       \}
403       \textcolor{comment}{//Invalid state?}
404       \textcolor{keywordflow}{else}
405       \{
406          \textcolor{comment}{//The FTP server has encountered a critical error}
407          \hyperlink{ftp__server__misc_8c_a131bc4ee0544ae32eee4cf829f006a11}{ftpServerCloseConnection}(context, connection);
408          \textcolor{comment}{//Exit immediately}
409          \textcolor{keywordflow}{return};
410       \}
411 
412       \textcolor{comment}{//Number of bytes in the buffer}
413       connection->bufferPos = 0;
414       connection->bufferLength = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
415    \}
416 \}
\end{DoxyCode}
