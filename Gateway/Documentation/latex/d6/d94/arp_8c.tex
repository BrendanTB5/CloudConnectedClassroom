\hypertarget{arp_8c}{}\section{cyclone\+\_\+tcp/ipv4/arp.c File Reference}
\label{arp_8c}\index{cyclone\+\_\+tcp/ipv4/arp.\+c@{cyclone\+\_\+tcp/ipv4/arp.\+c}}


A\+RP (Address Resolution Protocol)  


{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include \char`\"{}core/net.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}core/ethernet.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv4/ipv4\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ipv4/arp.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{arp_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{net__config_8h_af77d71c8b5058e6b8b993cfa00731892}{A\+R\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{arp_8c_ad1390c72da5a2bed60298796ab7bb539}{arp\+Init} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em A\+RP cache initialization. \end{DoxyCompactList}\item 
void \hyperlink{arp_8c_a1abb41c91b12250f2a8d0af1f0566372}{arp\+Flush\+Cache} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Flush A\+RP cache. \end{DoxyCompactList}\item 
\hyperlink{structArpCacheEntry}{Arp\+Cache\+Entry} $\ast$ \hyperlink{arp_8c_aa5845d19d638440cab5a1aaf04716763}{arp\+Create\+Entry} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em Create a new entry in the A\+RP cache. \end{DoxyCompactList}\item 
\hyperlink{structArpCacheEntry}{Arp\+Cache\+Entry} $\ast$ \hyperlink{arp_8c_ab4d07fb455a2794628312442674efa1d}{arp\+Find\+Entry} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr} \hyperlink{ipcp_8h_a11542dd5a4de5976a89188df3d53b42d}{ip\+Addr})
\begin{DoxyCompactList}\small\item\em Search the A\+RP cache for a given I\+Pv4 address. \end{DoxyCompactList}\item 
void \hyperlink{arp_8c_a53bd16006525a1cbb59dc83cb2cebf11}{arp\+Send\+Queued\+Packets} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{structArpCacheEntry}{Arp\+Cache\+Entry} $\ast$entry)
\begin{DoxyCompactList}\small\item\em Send packets that are waiting for address resolution. \end{DoxyCompactList}\item 
void \hyperlink{arp_8c_a718bee17405c8472f26c0d3f29cadb80}{arp\+Flush\+Queued\+Packets} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{structArpCacheEntry}{Arp\+Cache\+Entry} $\ast$entry)
\begin{DoxyCompactList}\small\item\em Flush packet queue. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{arp_8c_a7468a7e9b409d74677a7a7285b55fc8d}{arp\+Resolve} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr} \hyperlink{ipcp_8h_a11542dd5a4de5976a89188df3d53b42d}{ip\+Addr}, \hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{Mac\+Addr} $\ast$mac\+Addr)
\begin{DoxyCompactList}\small\item\em Address resolution using A\+RP protocol. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{arp_8c_ab21da3d4fc4df7543ee8acaf1d6b2449}{arp\+Enqueue\+Packet} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr} \hyperlink{ipcp_8h_a11542dd5a4de5976a89188df3d53b42d}{ip\+Addr}, \hyperlink{structNetBuffer}{Net\+Buffer} $\ast$buffer, size\+\_\+t \hyperlink{pic32mz_2isr__support_8h_ac0542d92dfcd62c19170fd963f9e5052}{offset})
\begin{DoxyCompactList}\small\item\em Enqueue an I\+Pv4 packet waiting for address resolution. \end{DoxyCompactList}\item 
void \hyperlink{arp_8c_ae1a76e2e34dfe2c12c05d64a8b8526ec}{arp\+Tick} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface)
\begin{DoxyCompactList}\small\item\em A\+RP timer handler. \end{DoxyCompactList}\item 
void \hyperlink{arp_8c_a9cef7aa6e33d98d3a00e5b9441b76c64}{arp\+Process\+Packet} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{Arp\+Packet} $\ast$arp\+Packet, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Incoming A\+RP packet processing. \end{DoxyCompactList}\item 
void \hyperlink{arp_8c_ae42c9aacdeb0e4b525a9b88f0f800357}{arp\+Process\+Request} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{Arp\+Packet} $\ast$arp\+Request)
\begin{DoxyCompactList}\small\item\em Incoming A\+RP request processing. \end{DoxyCompactList}\item 
void \hyperlink{arp_8c_a5c3bc760cdb56539337c94b64d1e07d9}{arp\+Process\+Reply} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{Arp\+Packet} $\ast$arp\+Reply)
\begin{DoxyCompactList}\small\item\em Incoming A\+RP reply processing. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{arp_8c_a409a9ebedbbc8b4838abf55c0e4570ac}{arp\+Send\+Probe} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr} target\+Ip\+Addr)
\begin{DoxyCompactList}\small\item\em Send A\+RP probe. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{arp_8c_a01808695b2ef58c55179909126ce9f8f}{arp\+Send\+Request} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr} target\+Ip\+Addr, const \hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{Mac\+Addr} $\ast$dest\+Mac\+Addr)
\begin{DoxyCompactList}\small\item\em Send A\+RP request. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{arp_8c_a4e145d7abcd3451c2cdb7debe66e523b}{arp\+Send\+Reply} (\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$interface, \hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr} sender\+Ip\+Addr, \hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr} target\+Ip\+Addr, const \hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{Mac\+Addr} $\ast$target\+Mac\+Addr)
\begin{DoxyCompactList}\small\item\em Send A\+RP reply. \end{DoxyCompactList}\item 
void \hyperlink{arp_8c_aad3aa5978f61a8dc1810568e0d36239d}{arp\+Dump\+Packet} (const \hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{Arp\+Packet} $\ast$arp\+Packet)
\begin{DoxyCompactList}\small\item\em Dump A\+RP packet for debugging purpose. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t} \hyperlink{arp_8c_aa0adbd8d7d464b063104f6457979643e}{arp\+Tick\+Counter}
\end{DoxyCompactItemize}


\subsection{Detailed Description}
A\+RP (Address Resolution Protocol) 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+T\+CP Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.\hypertarget{tftp__server_8c_Description}{}\subsection{Description}\label{tftp__server_8c_Description}
Address Resolution Protocol is used to determine the hardware address of a specific host when only its I\+Pv4 address is known. Refer to R\+FC 826

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{arp_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{arp_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{arp.\+c@{arp.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{net__config_8h_af77d71c8b5058e6b8b993cfa00731892}{A\+R\+P\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 37 of file arp.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{arp_8c_aa5845d19d638440cab5a1aaf04716763}\label{arp_8c_aa5845d19d638440cab5a1aaf04716763}} 
\index{arp.\+c@{arp.\+c}!arp\+Create\+Entry@{arp\+Create\+Entry}}
\index{arp\+Create\+Entry@{arp\+Create\+Entry}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Create\+Entry()}{arpCreateEntry()}}
{\footnotesize\ttfamily \hyperlink{structArpCacheEntry}{Arp\+Cache\+Entry}$\ast$ arp\+Create\+Entry (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Create a new entry in the A\+RP cache. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Pointer to the newly created entry 
\end{DoxyReturn}


Definition at line 100 of file arp.\+c.


\begin{DoxyCode}
101 \{
102    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
103    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
104    \hyperlink{structArpCacheEntry}{ArpCacheEntry} *entry;
105    \hyperlink{structArpCacheEntry}{ArpCacheEntry} *oldestEntry;
106 
107    \textcolor{comment}{//Get current time}
108    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
109 
110    \textcolor{comment}{//Keep track of the oldest entry}
111    oldestEntry = &interface->arpCache[0];
112 
113    \textcolor{comment}{//Loop through ARP cache entries}
114    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{arp_8h_adfc3bb356b0ae1244f95c2f191ee096e}{ARP\_CACHE\_SIZE}; i++)
115    \{
116       \textcolor{comment}{//Point to the current entry}
117       entry = &interface->arpCache[i];
118 
119       \textcolor{comment}{//Check whether the entry is currently in used or not}
120       \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a09db81d13b46a2908f3d8a62d7ba5ce0}{ARP\_STATE\_NONE})
121       \{
122          \textcolor{comment}{//Erase contents}
123          memset(entry, 0, \textcolor{keyword}{sizeof}(\hyperlink{structArpCacheEntry}{ArpCacheEntry}));
124          \textcolor{comment}{//Return a pointer to the ARP entry}
125          \textcolor{keywordflow}{return} entry;
126       \}
127 
128       \textcolor{comment}{//Keep track of the oldest entry in the table}
129       \textcolor{keywordflow}{if}((time - entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp}) > (time - oldestEntry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp}))
130       \{
131          oldestEntry = entry;
132       \}
133    \}
134 
135    \textcolor{comment}{//Drop any pending packets}
136    \hyperlink{arp_8c_a718bee17405c8472f26c0d3f29cadb80}{arpFlushQueuedPackets}(interface, oldestEntry);
137    \textcolor{comment}{//The oldest entry is removed whenever the table runs out of space}
138    memset(oldestEntry, 0, \textcolor{keyword}{sizeof}(\hyperlink{structArpCacheEntry}{ArpCacheEntry}));
139    \textcolor{comment}{//Return a pointer to the ARP entry}
140    \textcolor{keywordflow}{return} oldestEntry;
141 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_aad3aa5978f61a8dc1810568e0d36239d}\label{arp_8c_aad3aa5978f61a8dc1810568e0d36239d}} 
\index{arp.\+c@{arp.\+c}!arp\+Dump\+Packet@{arp\+Dump\+Packet}}
\index{arp\+Dump\+Packet@{arp\+Dump\+Packet}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Dump\+Packet()}{arpDumpPacket()}}
{\footnotesize\ttfamily void arp\+Dump\+Packet (\begin{DoxyParamCaption}\item[{const \hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{Arp\+Packet} $\ast$}]{arp\+Packet }\end{DoxyParamCaption})}



Dump A\+RP packet for debugging purpose. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em arp\+Packet} & A\+RP header \\
\hline
\end{DoxyParams}


Definition at line 976 of file arp.\+c.


\begin{DoxyCode}
977 \{
978    \textcolor{comment}{//Dump ARP packet contents}
979    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Hardware Type (hrd) = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(arpPacket->hrd));
980    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Protocol Type (pro) = 0x%04"} PRIX16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(arpPacket->pro));
981    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Hardware Address Length (hln) = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, arpPacket->hln);
982    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Protocol Address Length (pln) = %"} PRIu8 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, arpPacket->pln);
983    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Opcode (op) = %"} PRIu16 \textcolor{stringliteral}{"\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(arpPacket->op));
984    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Sender Hardware Address (sha) = %s\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{ethernet_8c_a9939c8165aa34316fdeb8b24258db4c4}{macAddrToString}(&arpPacket->sha, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
985    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Sender Protocol Address (spa) = %s\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{ipv4_8c_a6d826409fb54a5cc0ce23c5f88f5c7c1}{ipv4AddrToString}(arpPacket->spa, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
986    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Target Hardware Address (tha)= %s\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{ethernet_8c_a9939c8165aa34316fdeb8b24258db4c4}{macAddrToString}(&arpPacket->tha, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
987    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Target Protocol Address (tpa) = %s\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{ipv4_8c_a6d826409fb54a5cc0ce23c5f88f5c7c1}{ipv4AddrToString}(arpPacket->tpa, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}));
988 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_ab21da3d4fc4df7543ee8acaf1d6b2449}\label{arp_8c_ab21da3d4fc4df7543ee8acaf1d6b2449}} 
\index{arp.\+c@{arp.\+c}!arp\+Enqueue\+Packet@{arp\+Enqueue\+Packet}}
\index{arp\+Enqueue\+Packet@{arp\+Enqueue\+Packet}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Enqueue\+Packet()}{arpEnqueuePacket()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} arp\+Enqueue\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr}}]{ip\+Addr,  }\item[{\hyperlink{structNetBuffer}{Net\+Buffer} $\ast$}]{buffer,  }\item[{size\+\_\+t}]{offset }\end{DoxyParamCaption})}



Enqueue an I\+Pv4 packet waiting for address resolution. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em ip\+Addr} & I\+Pv4 address of the destination host \\
\hline
\mbox{\tt in}  & {\em buffer} & Multi-\/part buffer containing the packet to be enqueued \\
\hline
\mbox{\tt in}  & {\em offset} & Offset to the first byte of the packet \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 342 of file arp.\+c.


\begin{DoxyCode}
344 \{
345    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
346    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
347    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
348    \hyperlink{structArpCacheEntry}{ArpCacheEntry} *entry;
349 
350    \textcolor{comment}{//Retrieve the length of the multi-part buffer}
351    length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(buffer);
352 
353    \textcolor{comment}{//Search the ARP cache for the specified IPv4 address}
354    entry = \hyperlink{arp_8c_ab4d07fb455a2794628312442674efa1d}{arpFindEntry}(interface, \hyperlink{mib__common_8h_a3860e959b1b7dd73686a6e11424805e2}{ipAddr});
355 
356    \textcolor{comment}{//Check whether a matching entry exists}
357    \textcolor{keywordflow}{if}(entry != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
358    \{
359       \textcolor{comment}{//Check current state}
360       \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a32fbe4d5f33e18dbe924cb5a570a6b0e}{ARP\_STATE\_INCOMPLETE})
361       \{
362          \textcolor{comment}{//Check whether the packet queue is full}
363          \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_af81948c9f899549e51e70c2550f4ae4f}{queueSize} >= \hyperlink{arp_8h_a7f10c703fc244856512502b9d37fe636}{ARP\_MAX\_PENDING\_PACKETS})
364          \{
365             \textcolor{comment}{//When the queue overflows, the new arrival should replace the oldest entry}
366             \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(entry->\hyperlink{structArpCacheEntry_a217e54562a6d3c279ce48e8a4b26b1ce}{queue}[0].\hyperlink{structArpQueueItem_a825a97f1d1ae622ab44e78cae03c86eb}{buffer});
367 
368             \textcolor{comment}{//Make room for the new packet}
369             \textcolor{keywordflow}{for}(i = 1; i < \hyperlink{arp_8h_a7f10c703fc244856512502b9d37fe636}{ARP\_MAX\_PENDING\_PACKETS}; i++)
370                entry->\hyperlink{structArpCacheEntry_a217e54562a6d3c279ce48e8a4b26b1ce}{queue}[i - 1] = entry->\hyperlink{structArpCacheEntry_a217e54562a6d3c279ce48e8a4b26b1ce}{queue}[i];
371 
372             \textcolor{comment}{//Adjust the number of pending packets}
373             entry->\hyperlink{structArpCacheEntry_af81948c9f899549e51e70c2550f4ae4f}{queueSize}--;
374          \}
375 
376          \textcolor{comment}{//Index of the entry to be filled in}
377          i = entry->\hyperlink{structArpCacheEntry_af81948c9f899549e51e70c2550f4ae4f}{queueSize};
378          \textcolor{comment}{//Allocate a memory buffer to store the packet}
379          entry->\hyperlink{structArpCacheEntry_a217e54562a6d3c279ce48e8a4b26b1ce}{queue}[i].\hyperlink{structArpQueueItem_a825a97f1d1ae622ab44e78cae03c86eb}{buffer} = \hyperlink{net__mem_8c_a986c9991e530e99528faa4c43efadc6f}{netBufferAlloc}(length);
380 
381          \textcolor{comment}{//Successful memory allocation?}
382          \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_a217e54562a6d3c279ce48e8a4b26b1ce}{queue}[i].\hyperlink{structArpQueueItem_a825a97f1d1ae622ab44e78cae03c86eb}{buffer} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
383          \{
384             \textcolor{comment}{//Copy the contents of the IPv4 packet}
385             \hyperlink{net__mem_8c_a553a02631efd217192800ad3cdf9bbba}{netBufferCopy}(entry->\hyperlink{structArpCacheEntry_a217e54562a6d3c279ce48e8a4b26b1ce}{queue}[i].\hyperlink{structArpQueueItem_a825a97f1d1ae622ab44e78cae03c86eb}{buffer}, 0, buffer, 0, length);
386             \textcolor{comment}{//Offset to the first byte of the IPv4 header}
387             entry->\hyperlink{structArpCacheEntry_a217e54562a6d3c279ce48e8a4b26b1ce}{queue}[i].\hyperlink{structArpQueueItem_af508c934293030681a6e12fcc41f3e3c}{offset} = \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
388 
389             \textcolor{comment}{//Increment the number of queued packets}
390             entry->\hyperlink{structArpCacheEntry_af81948c9f899549e51e70c2550f4ae4f}{queueSize}++;
391             \textcolor{comment}{//The packet was successfully enqueued}
392             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
393          \}
394          \textcolor{keywordflow}{else}
395          \{
396             \textcolor{comment}{//Failed to allocate memory}
397             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
398          \}
399       \}
400       \textcolor{keywordflow}{else}
401       \{
402          \textcolor{comment}{//The address is already resolved}
403          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac17950207f5a741c1f2a1f5edb64c22e}{ERROR\_UNEXPECTED\_STATE};
404       \}
405    \}
406    \textcolor{keywordflow}{else}
407    \{
408       \textcolor{comment}{//No matching entry in ARP cache}
409       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4cca37264afee88cb14cd105f0d59607}{ERROR\_NOT\_FOUND};
410    \}
411 
412    \textcolor{comment}{//Return status code}
413    \textcolor{keywordflow}{return} error;
414 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_ab4d07fb455a2794628312442674efa1d}\label{arp_8c_ab4d07fb455a2794628312442674efa1d}} 
\index{arp.\+c@{arp.\+c}!arp\+Find\+Entry@{arp\+Find\+Entry}}
\index{arp\+Find\+Entry@{arp\+Find\+Entry}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Find\+Entry()}{arpFindEntry()}}
{\footnotesize\ttfamily \hyperlink{structArpCacheEntry}{Arp\+Cache\+Entry}$\ast$ arp\+Find\+Entry (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr}}]{ip\+Addr }\end{DoxyParamCaption})}



Search the A\+RP cache for a given I\+Pv4 address. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em ip\+Addr} & I\+Pv4 address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
A pointer to the matching A\+RP entry is returned. N\+U\+LL is returned if the specified I\+Pv4 address could not be found in A\+RP cache 
\end{DoxyReturn}


Definition at line 152 of file arp.\+c.


\begin{DoxyCode}
153 \{
154    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
155    \hyperlink{structArpCacheEntry}{ArpCacheEntry} *entry;
156 
157    \textcolor{comment}{//Loop through ARP cache entries}
158    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{arp_8h_adfc3bb356b0ae1244f95c2f191ee096e}{ARP\_CACHE\_SIZE}; i++)
159    \{
160       \textcolor{comment}{//Point to the current entry}
161       entry = &interface->arpCache[i];
162 
163       \textcolor{comment}{//Check whether the entry is currently in used}
164       \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} != \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a09db81d13b46a2908f3d8a62d7ba5ce0}{ARP\_STATE\_NONE})
165       \{
166          \textcolor{comment}{//Current entry matches the specified address?}
167          \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_a1bea163ecbcefd764974eda38077edf1}{ipAddr} == \hyperlink{mib__common_8h_a3860e959b1b7dd73686a6e11424805e2}{ipAddr})
168             \textcolor{keywordflow}{return} entry;
169       \}
170    \}
171 
172    \textcolor{comment}{//No matching entry in ARP cache...}
173    \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
174 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_a1abb41c91b12250f2a8d0af1f0566372}\label{arp_8c_a1abb41c91b12250f2a8d0af1f0566372}} 
\index{arp.\+c@{arp.\+c}!arp\+Flush\+Cache@{arp\+Flush\+Cache}}
\index{arp\+Flush\+Cache@{arp\+Flush\+Cache}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Flush\+Cache()}{arpFlushCache()}}
{\footnotesize\ttfamily void arp\+Flush\+Cache (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



Flush A\+RP cache. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 75 of file arp.\+c.


\begin{DoxyCode}
76 \{
77    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
78    \hyperlink{structArpCacheEntry}{ArpCacheEntry} *entry;
79 
80    \textcolor{comment}{//Loop through ARP cache entries}
81    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{arp_8h_adfc3bb356b0ae1244f95c2f191ee096e}{ARP\_CACHE\_SIZE}; i++)
82    \{
83       \textcolor{comment}{//Point to the current entry}
84       entry = &interface->arpCache[i];
85 
86       \textcolor{comment}{//Drop packets that are waiting for address resolution}
87       \hyperlink{arp_8c_a718bee17405c8472f26c0d3f29cadb80}{arpFlushQueuedPackets}(interface, entry);
88       \textcolor{comment}{//Release ARP entry}
89       entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} = \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a09db81d13b46a2908f3d8a62d7ba5ce0}{ARP\_STATE\_NONE};
90    \}
91 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_a718bee17405c8472f26c0d3f29cadb80}\label{arp_8c_a718bee17405c8472f26c0d3f29cadb80}} 
\index{arp.\+c@{arp.\+c}!arp\+Flush\+Queued\+Packets@{arp\+Flush\+Queued\+Packets}}
\index{arp\+Flush\+Queued\+Packets@{arp\+Flush\+Queued\+Packets}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Flush\+Queued\+Packets()}{arpFlushQueuedPackets()}}
{\footnotesize\ttfamily void arp\+Flush\+Queued\+Packets (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{structArpCacheEntry}{Arp\+Cache\+Entry} $\ast$}]{entry }\end{DoxyParamCaption})}



Flush packet queue. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em entry} & Pointer to a A\+RP cache entry \\
\hline
\end{DoxyParams}


Definition at line 223 of file arp.\+c.


\begin{DoxyCode}
224 \{
225    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
226 
227    \textcolor{comment}{//Check current state}
228    \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a32fbe4d5f33e18dbe924cb5a570a6b0e}{ARP\_STATE\_INCOMPLETE})
229    \{
230       \textcolor{comment}{//Drop packets that are waiting for address resolution}
231       \textcolor{keywordflow}{for}(i = 0; i < entry->\hyperlink{structArpCacheEntry_af81948c9f899549e51e70c2550f4ae4f}{queueSize}; i++)
232       \{
233          \textcolor{comment}{//Release memory buffer}
234          \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(entry->\hyperlink{structArpCacheEntry_a217e54562a6d3c279ce48e8a4b26b1ce}{queue}[i].\hyperlink{structArpQueueItem_a825a97f1d1ae622ab44e78cae03c86eb}{buffer});
235       \}
236    \}
237 
238    \textcolor{comment}{//The queue is now empty}
239    entry->\hyperlink{structArpCacheEntry_af81948c9f899549e51e70c2550f4ae4f}{queueSize} = 0;
240 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_ad1390c72da5a2bed60298796ab7bb539}\label{arp_8c_ad1390c72da5a2bed60298796ab7bb539}} 
\index{arp.\+c@{arp.\+c}!arp\+Init@{arp\+Init}}
\index{arp\+Init@{arp\+Init}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Init()}{arpInit()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} arp\+Init (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



A\+RP cache initialization. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 60 of file arp.\+c.


\begin{DoxyCode}
61 \{
62    \textcolor{comment}{//Initialize the ARP cache}
63    memset(interface->arpCache, 0, \textcolor{keyword}{sizeof}(interface->arpCache));
64 
65    \textcolor{comment}{//Successful initialization}
66    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
67 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_a9cef7aa6e33d98d3a00e5b9441b76c64}\label{arp_8c_a9cef7aa6e33d98d3a00e5b9441b76c64}} 
\index{arp.\+c@{arp.\+c}!arp\+Process\+Packet@{arp\+Process\+Packet}}
\index{arp\+Process\+Packet@{arp\+Process\+Packet}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Process\+Packet()}{arpProcessPacket()}}
{\footnotesize\ttfamily void arp\+Process\+Packet (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{Arp\+Packet} $\ast$}]{arp\+Packet,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Incoming A\+RP packet processing. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em arp\+Packet} & Incoming A\+RP packet \\
\hline
\mbox{\tt in}  & {\em length} & Packet length \\
\hline
\end{DoxyParams}


Definition at line 537 of file arp.\+c.


\begin{DoxyCode}
539 \{
540    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
541    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} validTarget;
542    \hyperlink{structIpv4AddrEntry}{Ipv4AddrEntry} *addrEntry;
543    \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{NetInterface} *logicalInterface;
544 
545    \textcolor{comment}{//Discard invalid ARP packets}
546    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{ArpPacket}))
547       \textcolor{keywordflow}{return};
548 
549    \textcolor{comment}{//Debug message}
550    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"ARP packet received (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
551    \textcolor{comment}{//Dump ARP packet contents for debugging purpose}
552    \hyperlink{arp_8c_aad3aa5978f61a8dc1810568e0d36239d}{arpDumpPacket}(arpPacket);
553 
554    \textcolor{comment}{//Make sure the hardware type is valid}
555    \textcolor{keywordflow}{if}(arpPacket->hrd != \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{arp_8h_ac7754018d3a3d2b23293ebf5dbe73e0a}{ARP\_HARDWARE\_TYPE\_ETH}))
556       \textcolor{keywordflow}{return};
557    \textcolor{comment}{//Make sure the protocol type is valid}
558    \textcolor{keywordflow}{if}(arpPacket->pro != \hyperlink{cpu__endian_8h_a15540dbaeee98b6df80805f92e2f6759}{HTONS}(\hyperlink{arp_8h_ac77afcf350028355a4b0f8aee75a1cc2}{ARP\_PROTOCOL\_TYPE\_IPV4}))
559       \textcolor{keywordflow}{return};
560    \textcolor{comment}{//Check the length of the hardware address}
561    \textcolor{keywordflow}{if}(arpPacket->hln != \textcolor{keyword}{sizeof}(\hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{MacAddr}))
562       \textcolor{keywordflow}{return};
563    \textcolor{comment}{//Check the length of the protocol address}
564    \textcolor{keywordflow}{if}(arpPacket->pln != \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr}))
565       \textcolor{keywordflow}{return};
566 
567    \textcolor{comment}{//The target protocol address must a valid address assigned to the interface}
568    \textcolor{comment}{//or a tentative address whose uniqueness on a link is being verified}
569    validTarget = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
570 
571    \textcolor{comment}{//Loop through the list of IPv4 addresses assigned to the interface}
572    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{ipv4_8h_a360065ed2949f3d5f9f7e6ac4e9ad7e1}{IPV4\_ADDR\_LIST\_SIZE}; i++)
573    \{
574       \textcolor{comment}{//Point to the current entry}
575       addrEntry = &interface->ipv4Context.addrList[i];
576 
577       \textcolor{comment}{//Valid entry?}
578       \textcolor{keywordflow}{if}(addrEntry->\hyperlink{structIpv4AddrEntry_a36c6c6703cbac5cd8fd16ffd1abd7622}{state} != \hyperlink{ipv4_8h_a7bc59b5d625b1217a91f1db3917e8358a0334165f8ccc85e66349e123ead01c61}{IPV4\_ADDR\_STATE\_INVALID})
579       \{
580          \textcolor{comment}{//Check whether the sender protocol address matches the IP address}
581          \textcolor{comment}{//assigned to the interface}
582          \textcolor{keywordflow}{if}(addrEntry->\hyperlink{structIpv4AddrEntry_a63f7b289c827b77a86f2824468b74fbf}{addr} == arpPacket->spa)
583          \{
584             \textcolor{comment}{//Tentative address?}
585             \textcolor{keywordflow}{if}(addrEntry->\hyperlink{structIpv4AddrEntry_a36c6c6703cbac5cd8fd16ffd1abd7622}{state} == \hyperlink{ipv4_8h_a7bc59b5d625b1217a91f1db3917e8358a4bf3bae142ae012ac2e9731495ca5818}{IPV4\_ADDR\_STATE\_TENTATIVE})
586             \{
587                \textcolor{comment}{//If the host receives any ARP packet where the sender IP}
588                \textcolor{comment}{//address is the address being probed for, then this is a}
589                \textcolor{comment}{//conflicting ARP packet}
590                addrEntry->\hyperlink{structIpv4AddrEntry_a99a82bf5609db4f21877d2e62a69972a}{conflict} = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
591                \textcolor{comment}{//Exit immediately}
592                \textcolor{keywordflow}{return};
593             \}
594             \textcolor{keywordflow}{else}
595             \{
596                \textcolor{comment}{//Point to the logical interface}
597                logicalInterface = \hyperlink{nic_8c_a650d776d6513c3bb88671c3aedd782f0}{nicGetLogicalInterface}(interface);
598 
599                \textcolor{comment}{//If the sender hardware address does not match the hardware}
600                \textcolor{comment}{//address of that interface, then this is a conflicting ARP}
601                \textcolor{comment}{//packet}
602                \textcolor{keywordflow}{if}(!\hyperlink{ethernet_8h_a800d9f928930baf027e925976c44b9b2}{macCompAddr}(&arpPacket->sha, &logicalInterface->macAddr))
603                \{
604                   \textcolor{comment}{//An address conflict has been detected...}
605                   addrEntry->\hyperlink{structIpv4AddrEntry_a99a82bf5609db4f21877d2e62a69972a}{conflict} = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
606                   \textcolor{comment}{//Exit immediately}
607                   \textcolor{keywordflow}{return};
608                \}
609             \}
610          \}
611 
612          \textcolor{comment}{//Check whether the target protocol address matches an IP address}
613          \textcolor{comment}{//assigned to the interface}
614          \textcolor{keywordflow}{if}(addrEntry->\hyperlink{structIpv4AddrEntry_a63f7b289c827b77a86f2824468b74fbf}{addr} == arpPacket->tpa)
615          \{
616             validTarget = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
617          \}
618       \}
619    \}
620 
621    \textcolor{comment}{//Valid target protocol address?}
622    \textcolor{keywordflow}{if}(validTarget)
623    \{
624       \textcolor{comment}{//Check operation code}
625       \textcolor{keywordflow}{switch}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(arpPacket->op))
626       \{
627       \textcolor{comment}{//ARP request?}
628       \textcolor{keywordflow}{case} \hyperlink{arp_8h_aefdd3857f04fba01d5122a0e34df9523a58cb77926d304bf3df1ae2b99f60f983}{ARP\_OPCODE\_ARP\_REQUEST}:
629          \textcolor{comment}{//Process incoming ARP request}
630          \hyperlink{arp_8c_ae42c9aacdeb0e4b525a9b88f0f800357}{arpProcessRequest}(interface, arpPacket);
631          \textcolor{keywordflow}{break};
632       \textcolor{comment}{//ARP reply?}
633       \textcolor{keywordflow}{case} \hyperlink{arp_8h_aefdd3857f04fba01d5122a0e34df9523a9afd195c0d3bc3794817c1fdb23a418c}{ARP\_OPCODE\_ARP\_REPLY}:
634          \textcolor{comment}{//Process incoming ARP reply}
635          \hyperlink{arp_8c_a5c3bc760cdb56539337c94b64d1e07d9}{arpProcessReply}(interface, arpPacket);
636          \textcolor{keywordflow}{break};
637       \textcolor{comment}{//Unknown operation code?}
638       \textcolor{keywordflow}{default}:
639          \textcolor{comment}{//Debug message}
640          \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Unknown operation code!\(\backslash\)r\(\backslash\)n"});
641          \textcolor{comment}{//Discard incoming packet}
642          \textcolor{keywordflow}{break};
643       \}
644    \}
645 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_a5c3bc760cdb56539337c94b64d1e07d9}\label{arp_8c_a5c3bc760cdb56539337c94b64d1e07d9}} 
\index{arp.\+c@{arp.\+c}!arp\+Process\+Reply@{arp\+Process\+Reply}}
\index{arp\+Process\+Reply@{arp\+Process\+Reply}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Process\+Reply()}{arpProcessReply()}}
{\footnotesize\ttfamily void arp\+Process\+Reply (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{Arp\+Packet} $\ast$}]{arp\+Reply }\end{DoxyParamCaption})}



Incoming A\+RP reply processing. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em arp\+Reply} & Incoming A\+RP reply \\
\hline
\end{DoxyParams}


Definition at line 724 of file arp.\+c.


\begin{DoxyCode}
725 \{
726    \hyperlink{structArpCacheEntry}{ArpCacheEntry} *entry;
727 
728    \textcolor{comment}{//Debug message}
729    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"ARP Reply received...\(\backslash\)r\(\backslash\)n"});
730 
731    \textcolor{comment}{//Check sender protocol address}
732    \textcolor{keywordflow}{if}(arpReply->spa == \hyperlink{ipv4_8h_aa9d277a6ff68d361eaf48d6af73e78e8}{IPV4\_UNSPECIFIED\_ADDR})
733       \textcolor{keywordflow}{return};
734    \textcolor{keywordflow}{if}(\hyperlink{ipv4__misc_8c_a73422a205c437d811cf29972c3464e1c}{ipv4IsBroadcastAddr}(interface, arpReply->spa))
735       \textcolor{keywordflow}{return};
736    \textcolor{keywordflow}{if}(\hyperlink{ipv4_8h_aada5b622e70acf16bd1cd5a9c08ea107}{ipv4IsMulticastAddr}(arpReply->spa))
737       \textcolor{keywordflow}{return};
738 
739    \textcolor{comment}{//Check sender hardware address}
740    \textcolor{keywordflow}{if}(\hyperlink{ethernet_8h_a800d9f928930baf027e925976c44b9b2}{macCompAddr}(&arpReply->sha, &\hyperlink{ethernet_8c_a24b2ce78dd643fe028d2e18c3b503f1f}{MAC\_UNSPECIFIED\_ADDR}))
741       \textcolor{keywordflow}{return};
742    \textcolor{keywordflow}{if}(\hyperlink{ethernet_8h_a800d9f928930baf027e925976c44b9b2}{macCompAddr}(&arpReply->sha, &\hyperlink{ethernet_8c_ae1313f9f72de49c713dea514e09ae0e3}{MAC\_BROADCAST\_ADDR}))
743       \textcolor{keywordflow}{return};
744    \textcolor{keywordflow}{if}(\hyperlink{ethernet_8h_a039998d9b03dc52280cda15b57d88cb3}{macIsMulticastAddr}(&arpReply->sha))
745       \textcolor{keywordflow}{return};
746 
747    \textcolor{comment}{//Check whether the target IP address is an address being probed for}
748    \textcolor{keywordflow}{if}(\hyperlink{ipv4__misc_8c_ae1a1091c35e9a8ba4656688bdb76dc11}{ipv4IsTentativeAddr}(interface, arpReply->tpa))
749       \textcolor{keywordflow}{return};
750 
751    \textcolor{comment}{//Search the ARP cache for the specified IPv4 address}
752    entry = \hyperlink{arp_8c_ab4d07fb455a2794628312442674efa1d}{arpFindEntry}(interface, arpReply->spa);
753 
754    \textcolor{comment}{//Check whether a matching entry has been found}
755    \textcolor{keywordflow}{if}(entry != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
756    \{
757       \textcolor{comment}{//Check current state}
758       \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a32fbe4d5f33e18dbe924cb5a570a6b0e}{ARP\_STATE\_INCOMPLETE})
759       \{
760          \textcolor{comment}{//Record the corresponding MAC address}
761          entry->\hyperlink{structArpCacheEntry_a48913a7a1aa68c83f6a34fa71091acb0}{macAddr} = arpReply->sha;
762 
763          \textcolor{comment}{//Send all the packets that are pending for transmission}
764          \hyperlink{arp_8c_a53bd16006525a1cbb59dc83cb2cebf11}{arpSendQueuedPackets}(interface, entry);
765 
766          \textcolor{comment}{//Save current time}
767          entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
768          \textcolor{comment}{//The validity of the ARP entry is limited in time}
769          entry->\hyperlink{structArpCacheEntry_ad74ee2386d4551701aa641e9111c4df0}{timeout} = \hyperlink{arp_8h_a03de1d70a819d5f154f5f85a9448f844}{ARP\_REACHABLE\_TIME};
770          \textcolor{comment}{//Switch to the REACHABLE state}
771          entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} = \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a5166b37c7baf2766482cda9e3cd5c59a}{ARP\_STATE\_REACHABLE};
772       \}
773       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a5166b37c7baf2766482cda9e3cd5c59a}{ARP\_STATE\_REACHABLE})
774       \{
775          \textcolor{comment}{//Different link-layer address than cached?}
776          \textcolor{keywordflow}{if}(!\hyperlink{ethernet_8h_a800d9f928930baf027e925976c44b9b2}{macCompAddr}(&arpReply->sha, &entry->\hyperlink{structArpCacheEntry_a48913a7a1aa68c83f6a34fa71091acb0}{macAddr}))
777          \{
778             \textcolor{comment}{//Enter STALE state}
779             entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} = \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a0a9b79308d1462c24535ce2bba8cf711}{ARP\_STATE\_STALE};
780          \}
781       \}
782       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a82d89e2b6fc81da67a1902d73ff755d5}{ARP\_STATE\_PROBE})
783       \{
784          \textcolor{comment}{//Record IPv4/MAC address pair}
785          entry->\hyperlink{structArpCacheEntry_a1bea163ecbcefd764974eda38077edf1}{ipAddr} = arpReply->spa;
786          entry->\hyperlink{structArpCacheEntry_a48913a7a1aa68c83f6a34fa71091acb0}{macAddr} = arpReply->sha;
787 
788          \textcolor{comment}{//Save current time}
789          entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
790          \textcolor{comment}{//The validity of the ARP entry is limited in time}
791          entry->\hyperlink{structArpCacheEntry_ad74ee2386d4551701aa641e9111c4df0}{timeout} = \hyperlink{arp_8h_a03de1d70a819d5f154f5f85a9448f844}{ARP\_REACHABLE\_TIME};
792          \textcolor{comment}{//Switch to the REACHABLE state}
793          entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} = \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a5166b37c7baf2766482cda9e3cd5c59a}{ARP\_STATE\_REACHABLE};
794       \}
795    \}
796 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_ae42c9aacdeb0e4b525a9b88f0f800357}\label{arp_8c_ae42c9aacdeb0e4b525a9b88f0f800357}} 
\index{arp.\+c@{arp.\+c}!arp\+Process\+Request@{arp\+Process\+Request}}
\index{arp\+Process\+Request@{arp\+Process\+Request}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Process\+Request()}{arpProcessRequest()}}
{\footnotesize\ttfamily void arp\+Process\+Request (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{Arp\+Packet} $\ast$}]{arp\+Request }\end{DoxyParamCaption})}



Incoming A\+RP request processing. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em arp\+Request} & Incoming A\+RP request \\
\hline
\end{DoxyParams}


Definition at line 654 of file arp.\+c.


\begin{DoxyCode}
655 \{
656    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
657    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} validTarget;
658    \hyperlink{structIpv4AddrEntry}{Ipv4AddrEntry} *addrEntry;
659    \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{NetInterface} *logicalInterface;
660 
661    \textcolor{comment}{//Debug message}
662    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"ARP Request received...\(\backslash\)r\(\backslash\)n"});
663 
664    \textcolor{comment}{//Check sender protocol address}
665    \textcolor{keywordflow}{if}(\hyperlink{ipv4__misc_8c_a73422a205c437d811cf29972c3464e1c}{ipv4IsBroadcastAddr}(interface, arpRequest->spa))
666       \textcolor{keywordflow}{return};
667    \textcolor{keywordflow}{if}(\hyperlink{ipv4_8h_aada5b622e70acf16bd1cd5a9c08ea107}{ipv4IsMulticastAddr}(arpRequest->spa))
668       \textcolor{keywordflow}{return};
669 
670    \textcolor{comment}{//Initialize flag}
671    validTarget = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
672 
673    \textcolor{comment}{//Loop through the list of IPv4 addresses assigned to the interface}
674    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{ipv4_8h_a360065ed2949f3d5f9f7e6ac4e9ad7e1}{IPV4\_ADDR\_LIST\_SIZE}; i++)
675    \{
676       \textcolor{comment}{//Point to the current entry}
677       addrEntry = &interface->ipv4Context.addrList[i];
678 
679       \textcolor{comment}{//Tentative address?}
680       \textcolor{keywordflow}{if}(addrEntry->\hyperlink{structIpv4AddrEntry_a36c6c6703cbac5cd8fd16ffd1abd7622}{state} == \hyperlink{ipv4_8h_a7bc59b5d625b1217a91f1db3917e8358a4bf3bae142ae012ac2e9731495ca5818}{IPV4\_ADDR\_STATE\_TENTATIVE})
681       \{
682          \textcolor{comment}{//Check whether the target IP address is an address being probed for}
683          \textcolor{keywordflow}{if}(addrEntry->\hyperlink{structIpv4AddrEntry_a63f7b289c827b77a86f2824468b74fbf}{addr} == arpRequest->tpa)
684          \{
685             \textcolor{comment}{//The target protocol address is a tentative address}
686             validTarget = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
687 
688             \textcolor{comment}{//ARP probe received?}
689             \textcolor{keywordflow}{if}(arpRequest->spa == \hyperlink{ipv4_8h_aa9d277a6ff68d361eaf48d6af73e78e8}{IPV4\_UNSPECIFIED\_ADDR})
690             \{
691                \textcolor{comment}{//Point to the logical interface}
692                logicalInterface = \hyperlink{nic_8c_a650d776d6513c3bb88671c3aedd782f0}{nicGetLogicalInterface}(interface);
693 
694                \textcolor{comment}{//If the sender hardware address does not match the hardware}
695                \textcolor{comment}{//address of that interface, then this is a conflicting ARP}
696                \textcolor{comment}{//packet}
697                \textcolor{keywordflow}{if}(!\hyperlink{ethernet_8h_a800d9f928930baf027e925976c44b9b2}{macCompAddr}(&arpRequest->sha, &logicalInterface->macAddr))
698                \{
699                   \textcolor{comment}{//An address conflict has been detected...}
700                   addrEntry->\hyperlink{structIpv4AddrEntry_a99a82bf5609db4f21877d2e62a69972a}{conflict} = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
701                \}
702             \}
703          \}
704       \}
705    \}
706 
707    \textcolor{comment}{//In all cases, the host must not respond to an ARP request for an address}
708    \textcolor{comment}{//being probed for}
709    \textcolor{keywordflow}{if}(validTarget)
710    \{
711       \textcolor{comment}{//Send ARP reply}
712       \hyperlink{arp_8c_a4e145d7abcd3451c2cdb7debe66e523b}{arpSendReply}(interface, arpRequest->tpa, arpRequest->spa,
713          &arpRequest->sha);
714    \}
715 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_a7468a7e9b409d74677a7a7285b55fc8d}\label{arp_8c_a7468a7e9b409d74677a7a7285b55fc8d}} 
\index{arp.\+c@{arp.\+c}!arp\+Resolve@{arp\+Resolve}}
\index{arp\+Resolve@{arp\+Resolve}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Resolve()}{arpResolve()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} arp\+Resolve (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr}}]{ip\+Addr,  }\item[{\hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{Mac\+Addr} $\ast$}]{mac\+Addr }\end{DoxyParamCaption})}



Address resolution using A\+RP protocol. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em ip\+Addr} & I\+Pv4 address \\
\hline
\mbox{\tt in}  & {\em mac\+Addr} & Physical address matching the specified I\+Pv4 address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 251 of file arp.\+c.


\begin{DoxyCode}
252 \{
253    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
254    \hyperlink{structArpCacheEntry}{ArpCacheEntry} *entry;
255 
256    \textcolor{comment}{//Search the ARP cache for the specified IPv4 address}
257    entry = \hyperlink{arp_8c_ab4d07fb455a2794628312442674efa1d}{arpFindEntry}(interface, \hyperlink{mib__common_8h_a3860e959b1b7dd73686a6e11424805e2}{ipAddr});
258 
259    \textcolor{comment}{//Check whether a matching entry has been found}
260    \textcolor{keywordflow}{if}(entry != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
261    \{
262       \textcolor{comment}{//Check the state of the ARP entry}
263       \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a32fbe4d5f33e18dbe924cb5a570a6b0e}{ARP\_STATE\_INCOMPLETE})
264       \{
265          \textcolor{comment}{//The address resolution is already in progress}
266          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca14596397b69ee6fd1d74ca77fb55e186}{ERROR\_IN\_PROGRESS};
267       \}
268       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a0a9b79308d1462c24535ce2bba8cf711}{ARP\_STATE\_STALE})
269       \{
270          \textcolor{comment}{//Copy the MAC address associated with the specified IPv4 address}
271          *macAddr = entry->\hyperlink{structArpCacheEntry_a48913a7a1aa68c83f6a34fa71091acb0}{macAddr};
272 
273          \textcolor{comment}{//Start delay timer}
274          entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
275          \textcolor{comment}{//Delay before sending the first probe}
276          entry->\hyperlink{structArpCacheEntry_ad74ee2386d4551701aa641e9111c4df0}{timeout} = \hyperlink{arp_8h_a5dcbb643c134124dc82886aada1ec864}{ARP\_DELAY\_FIRST\_PROBE\_TIME};
277          \textcolor{comment}{//Switch to the DELAY state}
278          entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} = \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5af43ae88e7f99487bc1c154c38ab1768a}{ARP\_STATE\_DELAY};
279 
280          \textcolor{comment}{//Successful address resolution}
281          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
282       \}
283       \textcolor{keywordflow}{else}
284       \{
285          \textcolor{comment}{//Copy the MAC address associated with the specified IPv4 address}
286          *macAddr = entry->\hyperlink{structArpCacheEntry_a48913a7a1aa68c83f6a34fa71091acb0}{macAddr};
287 
288          \textcolor{comment}{//Successful address resolution}
289          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
290       \}
291    \}
292    \textcolor{keywordflow}{else}
293    \{
294       \textcolor{comment}{//If no entry exists, then create a new one}
295       entry = \hyperlink{arp_8c_aa5845d19d638440cab5a1aaf04716763}{arpCreateEntry}(interface);
296 
297       \textcolor{comment}{//ARP cache entry successfully created?}
298       \textcolor{keywordflow}{if}(entry != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
299       \{
300          \textcolor{comment}{//Record the IPv4 address whose MAC address is unknown}
301          entry->\hyperlink{structArpCacheEntry_a1bea163ecbcefd764974eda38077edf1}{ipAddr} = \hyperlink{mib__common_8h_a3860e959b1b7dd73686a6e11424805e2}{ipAddr};
302 
303          \textcolor{comment}{//Reset retransmission counter}
304          entry->\hyperlink{structArpCacheEntry_a94ca6d58bf237b77eec4419fceac39ab}{retransmitCount} = 0;
305          \textcolor{comment}{//No packet are pending in the transmit queue}
306          entry->\hyperlink{structArpCacheEntry_af81948c9f899549e51e70c2550f4ae4f}{queueSize} = 0;
307 
308          \textcolor{comment}{//Send an ARP request}
309          \hyperlink{arp_8c_a01808695b2ef58c55179909126ce9f8f}{arpSendRequest}(interface, entry->\hyperlink{structArpCacheEntry_a1bea163ecbcefd764974eda38077edf1}{ipAddr}, &
      \hyperlink{ethernet_8c_ae1313f9f72de49c713dea514e09ae0e3}{MAC\_BROADCAST\_ADDR});
310 
311          \textcolor{comment}{//Save the time at which the packet was sent}
312          entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
313          \textcolor{comment}{//Set timeout value}
314          entry->\hyperlink{structArpCacheEntry_ad74ee2386d4551701aa641e9111c4df0}{timeout} = \hyperlink{arp_8h_af99c2e2914161a3853cc19534d92cca7}{ARP\_REQUEST\_TIMEOUT};
315          \textcolor{comment}{//Enter INCOMPLETE state}
316          entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} = \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a32fbe4d5f33e18dbe924cb5a570a6b0e}{ARP\_STATE\_INCOMPLETE};
317 
318          \textcolor{comment}{//The address resolution is in progress}
319          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca14596397b69ee6fd1d74ca77fb55e186}{ERROR\_IN\_PROGRESS};
320       \}
321       \textcolor{keywordflow}{else}
322       \{
323          \textcolor{comment}{//Failed to create ARP cache entry...}
324          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca528efe91b7a7e4bcc9a6de7d4b778c67}{ERROR\_OUT\_OF\_RESOURCES};
325       \}
326    \}
327 
328    \textcolor{comment}{//Return status code}
329    \textcolor{keywordflow}{return} error;
330 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_a409a9ebedbbc8b4838abf55c0e4570ac}\label{arp_8c_a409a9ebedbbc8b4838abf55c0e4570ac}} 
\index{arp.\+c@{arp.\+c}!arp\+Send\+Probe@{arp\+Send\+Probe}}
\index{arp\+Send\+Probe@{arp\+Send\+Probe}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Send\+Probe()}{arpSendProbe()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} arp\+Send\+Probe (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr}}]{target\+Ip\+Addr }\end{DoxyParamCaption})}



Send A\+RP probe. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em target\+Ip\+Addr} & Target I\+Pv4 address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 806 of file arp.\+c.


\begin{DoxyCode}
807 \{
808    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
809    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
810    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
811    \hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{ArpPacket} *arpRequest;
812    \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{NetInterface} *logicalInterface;
813 
814    \textcolor{comment}{//Point to the logical interface}
815    logicalInterface = \hyperlink{nic_8c_a650d776d6513c3bb88671c3aedd782f0}{nicGetLogicalInterface}(interface);
816 
817    \textcolor{comment}{//Allocate a memory buffer to hold an ARP packet}
818    buffer = \hyperlink{ethernet_8c_aadabeac7d0393741647e30f80f482c84}{ethAllocBuffer}(\textcolor{keyword}{sizeof}(\hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{ArpPacket}), &offset);
819    \textcolor{comment}{//Failed to allocate buffer?}
820    \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
821       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
822 
823    \textcolor{comment}{//Point to the beginning of the ARP packet}
824    arpRequest = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, offset);
825 
826    \textcolor{comment}{//Format ARP request}
827    arpRequest->hrd = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{arp_8h_ac7754018d3a3d2b23293ebf5dbe73e0a}{ARP\_HARDWARE\_TYPE\_ETH});
828    arpRequest->pro = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{arp_8h_ac77afcf350028355a4b0f8aee75a1cc2}{ARP\_PROTOCOL\_TYPE\_IPV4});
829    arpRequest->hln = \textcolor{keyword}{sizeof}(\hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{MacAddr});
830    arpRequest->pln = \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr});
831    arpRequest->op = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{arp_8h_aefdd3857f04fba01d5122a0e34df9523a58cb77926d304bf3df1ae2b99f60f983}{ARP\_OPCODE\_ARP\_REQUEST});
832    arpRequest->sha = logicalInterface->macAddr;
833    arpRequest->spa = \hyperlink{ipv4_8h_aa9d277a6ff68d361eaf48d6af73e78e8}{IPV4\_UNSPECIFIED\_ADDR};
834    arpRequest->tha = \hyperlink{ethernet_8c_a24b2ce78dd643fe028d2e18c3b503f1f}{MAC\_UNSPECIFIED\_ADDR};
835    arpRequest->tpa = targetIpAddr;
836 
837    \textcolor{comment}{//Debug message}
838    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending ARP Probe (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, \textcolor{keyword}{sizeof}(
      \hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{ArpPacket}));
839    \textcolor{comment}{//Dump ARP packet contents for debugging purpose}
840    \hyperlink{arp_8c_aad3aa5978f61a8dc1810568e0d36239d}{arpDumpPacket}(arpRequest);
841 
842    \textcolor{comment}{//Send ARP request}
843    error = \hyperlink{ethernet_8c_ad56ff94d4390f5821d1f1249fb0fea89}{ethSendFrame}(interface, &\hyperlink{ethernet_8c_ae1313f9f72de49c713dea514e09ae0e3}{MAC\_BROADCAST\_ADDR},
844       buffer, offset, \hyperlink{ethernet_8h_a527bb7f81d1c0869a7fc3f38b05ceaafa4d0ac4860984fbcfcfdcdb92f7253292}{ETH\_TYPE\_ARP});
845 
846    \textcolor{comment}{//Free previously allocated memory}
847    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
848    \textcolor{comment}{//Return status code}
849    \textcolor{keywordflow}{return} error;
850 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_a53bd16006525a1cbb59dc83cb2cebf11}\label{arp_8c_a53bd16006525a1cbb59dc83cb2cebf11}} 
\index{arp.\+c@{arp.\+c}!arp\+Send\+Queued\+Packets@{arp\+Send\+Queued\+Packets}}
\index{arp\+Send\+Queued\+Packets@{arp\+Send\+Queued\+Packets}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Send\+Queued\+Packets()}{arpSendQueuedPackets()}}
{\footnotesize\ttfamily void arp\+Send\+Queued\+Packets (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{structArpCacheEntry}{Arp\+Cache\+Entry} $\ast$}]{entry }\end{DoxyParamCaption})}



Send packets that are waiting for address resolution. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em entry} & Pointer to a A\+RP cache entry \\
\hline
\end{DoxyParams}


Definition at line 183 of file arp.\+c.


\begin{DoxyCode}
184 \{
185    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
186    \textcolor{keywordtype}{size\_t} \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
187    \hyperlink{structArpQueueItem}{ArpQueueItem} *item;
188 
189    \textcolor{comment}{//Check current state}
190    \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a32fbe4d5f33e18dbe924cb5a570a6b0e}{ARP\_STATE\_INCOMPLETE})
191    \{
192       \textcolor{comment}{//Loop through the queued packets}
193       \textcolor{keywordflow}{for}(i = 0; i < entry->\hyperlink{structArpCacheEntry_af81948c9f899549e51e70c2550f4ae4f}{queueSize}; i++)
194       \{
195          \textcolor{comment}{//Point to the current queue item}
196          item = &entry->\hyperlink{structArpCacheEntry_a217e54562a6d3c279ce48e8a4b26b1ce}{queue}[i];
197 
198          \textcolor{comment}{//Retrieve the length of the IPv4 packet}
199          length = \hyperlink{net__mem_8c_ac9dbcd9e28e61d8f4f6d2e9af2607b68}{netBufferGetLength}(item->\hyperlink{structArpQueueItem_a825a97f1d1ae622ab44e78cae03c86eb}{buffer}) - item->
      \hyperlink{structArpQueueItem_af508c934293030681a6e12fcc41f3e3c}{offset};
200          \textcolor{comment}{//Update IP statistics}
201          \hyperlink{ipv4__misc_8c_a6dcb6ccf3fb5fe97289b11941d36c695}{ipv4UpdateOutStats}(interface, entry->\hyperlink{structArpCacheEntry_a1bea163ecbcefd764974eda38077edf1}{ipAddr}, length);
202 
203          \textcolor{comment}{//Send the IPv4 packet}
204          \hyperlink{ethernet_8c_ad56ff94d4390f5821d1f1249fb0fea89}{ethSendFrame}(interface, &entry->\hyperlink{structArpCacheEntry_a48913a7a1aa68c83f6a34fa71091acb0}{macAddr},
205             item->\hyperlink{structArpQueueItem_a825a97f1d1ae622ab44e78cae03c86eb}{buffer}, item->\hyperlink{structArpQueueItem_af508c934293030681a6e12fcc41f3e3c}{offset}, \hyperlink{ethernet_8h_a527bb7f81d1c0869a7fc3f38b05ceaafa67afa19003e394d1bbec4a103b9d5648}{ETH\_TYPE\_IPV4});
206 
207          \textcolor{comment}{//Release memory buffer}
208          \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(item->\hyperlink{structArpQueueItem_a825a97f1d1ae622ab44e78cae03c86eb}{buffer});
209       \}
210    \}
211 
212    \textcolor{comment}{//The queue is now empty}
213    entry->\hyperlink{structArpCacheEntry_af81948c9f899549e51e70c2550f4ae4f}{queueSize} = 0;
214 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_a4e145d7abcd3451c2cdb7debe66e523b}\label{arp_8c_a4e145d7abcd3451c2cdb7debe66e523b}} 
\index{arp.\+c@{arp.\+c}!arp\+Send\+Reply@{arp\+Send\+Reply}}
\index{arp\+Send\+Reply@{arp\+Send\+Reply}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Send\+Reply()}{arpSendReply()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} arp\+Send\+Reply (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr}}]{sender\+Ip\+Addr,  }\item[{\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr}}]{target\+Ip\+Addr,  }\item[{const \hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{Mac\+Addr} $\ast$}]{target\+Mac\+Addr }\end{DoxyParamCaption})}



Send A\+RP reply. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em sender\+Ip\+Addr} & Sender Ipv4 address \\
\hline
\mbox{\tt in}  & {\em target\+Ip\+Addr} & Target I\+Pv4 address \\
\hline
\mbox{\tt in}  & {\em target\+Mac\+Addr} & Target M\+AC address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 924 of file arp.\+c.


\begin{DoxyCode}
926 \{
927    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
928    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
929    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
930    \hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{ArpPacket} *arpReply;
931    \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{NetInterface} *logicalInterface;
932 
933    \textcolor{comment}{//Point to the logical interface}
934    logicalInterface = \hyperlink{nic_8c_a650d776d6513c3bb88671c3aedd782f0}{nicGetLogicalInterface}(interface);
935 
936    \textcolor{comment}{//Allocate a memory buffer to hold an ARP packet}
937    buffer = \hyperlink{ethernet_8c_aadabeac7d0393741647e30f80f482c84}{ethAllocBuffer}(\textcolor{keyword}{sizeof}(\hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{ArpPacket}), &offset);
938    \textcolor{comment}{//Failed to allocate buffer?}
939    \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
940       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
941 
942    \textcolor{comment}{//Point to the beginning of the ARP packet}
943    arpReply = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, offset);
944 
945    \textcolor{comment}{//Format ARP reply}
946    arpReply->hrd = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{arp_8h_ac7754018d3a3d2b23293ebf5dbe73e0a}{ARP\_HARDWARE\_TYPE\_ETH});
947    arpReply->pro = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{ethernet_8h_a527bb7f81d1c0869a7fc3f38b05ceaafa67afa19003e394d1bbec4a103b9d5648}{ETH\_TYPE\_IPV4});
948    arpReply->hln = \textcolor{keyword}{sizeof}(\hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{MacAddr});
949    arpReply->pln = \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr});
950    arpReply->op = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{arp_8h_aefdd3857f04fba01d5122a0e34df9523a9afd195c0d3bc3794817c1fdb23a418c}{ARP\_OPCODE\_ARP\_REPLY});
951    arpReply->sha = logicalInterface->macAddr;
952    arpReply->spa = senderIpAddr;
953    arpReply->tha = *targetMacAddr;
954    arpReply->tpa = targetIpAddr;
955 
956    \textcolor{comment}{//Debug message}
957    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending ARP Reply (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, \textcolor{keyword}{sizeof}(
      \hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{ArpPacket}));
958    \textcolor{comment}{//Dump ARP packet contents for debugging purpose}
959    \hyperlink{arp_8c_aad3aa5978f61a8dc1810568e0d36239d}{arpDumpPacket}(arpReply);
960 
961    \textcolor{comment}{//Send ARP reply}
962    error = \hyperlink{ethernet_8c_ad56ff94d4390f5821d1f1249fb0fea89}{ethSendFrame}(interface, targetMacAddr, buffer, offset, 
      \hyperlink{ethernet_8h_a527bb7f81d1c0869a7fc3f38b05ceaafa4d0ac4860984fbcfcfdcdb92f7253292}{ETH\_TYPE\_ARP});
963 
964    \textcolor{comment}{//Free previously allocated memory}
965    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
966    \textcolor{comment}{//Return status code}
967    \textcolor{keywordflow}{return} error;
968 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_a01808695b2ef58c55179909126ce9f8f}\label{arp_8c_a01808695b2ef58c55179909126ce9f8f}} 
\index{arp.\+c@{arp.\+c}!arp\+Send\+Request@{arp\+Send\+Request}}
\index{arp\+Send\+Request@{arp\+Send\+Request}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Send\+Request()}{arpSendRequest()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} arp\+Send\+Request (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface,  }\item[{\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4\+Addr}}]{target\+Ip\+Addr,  }\item[{const \hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{Mac\+Addr} $\ast$}]{dest\+Mac\+Addr }\end{DoxyParamCaption})}



Send A\+RP request. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\mbox{\tt in}  & {\em target\+Ip\+Addr} & Target I\+Pv4 address \\
\hline
\mbox{\tt in}  & {\em dest\+Mac\+Addr} & Destination M\+AC address \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 861 of file arp.\+c.


\begin{DoxyCode}
863 \{
864    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
865    \textcolor{keywordtype}{size\_t} \hyperlink{pic32mz_2isr__support_8h_a12a5aed8a193ebbf9a641104a310610d}{offset};
866    \hyperlink{structNetBuffer}{NetBuffer} *buffer;
867    \hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{ArpPacket} *arpRequest;
868    \hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr} senderIpAddr;
869    \hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{NetInterface} *logicalInterface;
870 
871    \textcolor{comment}{//Point to the logical interface}
872    logicalInterface = \hyperlink{nic_8c_a650d776d6513c3bb88671c3aedd782f0}{nicGetLogicalInterface}(interface);
873 
874    \textcolor{comment}{//Select the most appropriate sender IP address to be used}
875    error = \hyperlink{ipv4__misc_8c_af1ec532996ca54986f87e67a354e03e1}{ipv4SelectSourceAddr}(&interface, targetIpAddr, &senderIpAddr);
876    \textcolor{comment}{//No address assigned to the interface?}
877    \textcolor{keywordflow}{if}(error)
878       \textcolor{keywordflow}{return} error;
879 
880    \textcolor{comment}{//Allocate a memory buffer to hold an ARP packet}
881    buffer = \hyperlink{ethernet_8c_aadabeac7d0393741647e30f80f482c84}{ethAllocBuffer}(\textcolor{keyword}{sizeof}(\hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{ArpPacket}), &offset);
882    \textcolor{comment}{//Failed to allocate buffer?}
883    \textcolor{keywordflow}{if}(buffer == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
884       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
885 
886    \textcolor{comment}{//Point to the beginning of the ARP packet}
887    arpRequest = \hyperlink{net__mem_8c_a20d30c9db547b3b2743368b589cf482b}{netBufferAt}(buffer, offset);
888 
889    \textcolor{comment}{//Format ARP request}
890    arpRequest->hrd = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{arp_8h_ac7754018d3a3d2b23293ebf5dbe73e0a}{ARP\_HARDWARE\_TYPE\_ETH});
891    arpRequest->pro = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{arp_8h_ac77afcf350028355a4b0f8aee75a1cc2}{ARP\_PROTOCOL\_TYPE\_IPV4});
892    arpRequest->hln = \textcolor{keyword}{sizeof}(\hyperlink{ethernet_8h_a1e00ed3977e8a770e8b4ae4cb306d1c0}{MacAddr});
893    arpRequest->pln = \textcolor{keyword}{sizeof}(\hyperlink{ipv4_8h_a411debb3d770caa0c06d3f73367da37f}{Ipv4Addr});
894    arpRequest->op = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(\hyperlink{arp_8h_aefdd3857f04fba01d5122a0e34df9523a58cb77926d304bf3df1ae2b99f60f983}{ARP\_OPCODE\_ARP\_REQUEST});
895    arpRequest->sha = logicalInterface->macAddr;
896    arpRequest->spa = senderIpAddr;
897    arpRequest->tha = \hyperlink{ethernet_8c_a24b2ce78dd643fe028d2e18c3b503f1f}{MAC\_UNSPECIFIED\_ADDR};
898    arpRequest->tpa = targetIpAddr;
899 
900    \textcolor{comment}{//Debug message}
901    \hyperlink{debug_8h_a7339bfd784193a5c79efcef2eeb2d6df}{TRACE\_INFO}(\textcolor{stringliteral}{"Sending ARP Request (%"} \hyperlink{compiler__port_8h_a2b7b0557dc6cd786df02dafbb51f5292}{PRIuSIZE} \textcolor{stringliteral}{" bytes)...\(\backslash\)r\(\backslash\)n"}, \textcolor{keyword}{sizeof}(
      \hyperlink{arp_8h_ab53152904f0f41caefcb312d7e0ebad8}{ArpPacket}));
902    \textcolor{comment}{//Dump ARP packet contents for debugging purpose}
903    \hyperlink{arp_8c_aad3aa5978f61a8dc1810568e0d36239d}{arpDumpPacket}(arpRequest);
904 
905    \textcolor{comment}{//Send ARP request}
906    error = \hyperlink{ethernet_8c_ad56ff94d4390f5821d1f1249fb0fea89}{ethSendFrame}(interface, destMacAddr, buffer, offset, 
      \hyperlink{ethernet_8h_a527bb7f81d1c0869a7fc3f38b05ceaafa4d0ac4860984fbcfcfdcdb92f7253292}{ETH\_TYPE\_ARP});
907 
908    \textcolor{comment}{//Free previously allocated memory}
909    \hyperlink{net__mem_8c_aa33fc4dd2a71649194052f297c707d08}{netBufferFree}(buffer);
910    \textcolor{comment}{//Return status code}
911    \textcolor{keywordflow}{return} error;
912 \}
\end{DoxyCode}
\mbox{\Hypertarget{arp_8c_ae1a76e2e34dfe2c12c05d64a8b8526ec}\label{arp_8c_ae1a76e2e34dfe2c12c05d64a8b8526ec}} 
\index{arp.\+c@{arp.\+c}!arp\+Tick@{arp\+Tick}}
\index{arp\+Tick@{arp\+Tick}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Tick()}{arpTick()}}
{\footnotesize\ttfamily void arp\+Tick (\begin{DoxyParamCaption}\item[{\hyperlink{net_8h_a2234db8911a1148c9159979d8f5e0d6b}{Net\+Interface} $\ast$}]{interface }\end{DoxyParamCaption})}



A\+RP timer handler. 

This routine must be periodically called by the T\+C\+P/\+IP stack to manage A\+RP cache


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em interface} & Underlying network interface \\
\hline
\end{DoxyParams}


Definition at line 426 of file arp.\+c.


\begin{DoxyCode}
427 \{
428    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
429    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
430    \hyperlink{structArpCacheEntry}{ArpCacheEntry} *entry;
431 
432    \textcolor{comment}{//Get current time}
433    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
434 
435    \textcolor{comment}{//Go through ARP cache}
436    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{arp_8h_adfc3bb356b0ae1244f95c2f191ee096e}{ARP\_CACHE\_SIZE}; i++)
437    \{
438       \textcolor{comment}{//Point to the current entry}
439       entry = &interface->arpCache[i];
440 
441       \textcolor{comment}{//INCOMPLETE state?}
442       \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a32fbe4d5f33e18dbe924cb5a570a6b0e}{ARP\_STATE\_INCOMPLETE})
443       \{
444          \textcolor{comment}{//The request timed out?}
445          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp} + entry->
      \hyperlink{structArpCacheEntry_ad74ee2386d4551701aa641e9111c4df0}{timeout}) >= 0)
446          \{
447             \textcolor{comment}{//Increment retransmission counter}
448             entry->\hyperlink{structArpCacheEntry_a94ca6d58bf237b77eec4419fceac39ab}{retransmitCount}++;
449 
450             \textcolor{comment}{//Check whether the maximum number of retransmissions has been exceeded}
451             \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_a94ca6d58bf237b77eec4419fceac39ab}{retransmitCount} < \hyperlink{arp_8h_a1ee5f35dd1b37fff702aa25041e98df9}{ARP\_MAX\_REQUESTS})
452             \{
453                \textcolor{comment}{//Retransmit ARP request}
454                \hyperlink{arp_8c_a01808695b2ef58c55179909126ce9f8f}{arpSendRequest}(interface, entry->\hyperlink{structArpCacheEntry_a1bea163ecbcefd764974eda38077edf1}{ipAddr}, &
      \hyperlink{ethernet_8c_ae1313f9f72de49c713dea514e09ae0e3}{MAC\_BROADCAST\_ADDR});
455 
456                \textcolor{comment}{//Save the time at which the packet was sent}
457                entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp} = \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
458                \textcolor{comment}{//Set timeout value}
459                entry->\hyperlink{structArpCacheEntry_ad74ee2386d4551701aa641e9111c4df0}{timeout} = \hyperlink{arp_8h_af99c2e2914161a3853cc19534d92cca7}{ARP\_REQUEST\_TIMEOUT};
460             \}
461             \textcolor{keywordflow}{else}
462             \{
463                \textcolor{comment}{//Drop packets that are waiting for address resolution}
464                \hyperlink{arp_8c_a718bee17405c8472f26c0d3f29cadb80}{arpFlushQueuedPackets}(interface, entry);
465                \textcolor{comment}{//The entry should be deleted since address resolution has failed}
466                entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} = \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a09db81d13b46a2908f3d8a62d7ba5ce0}{ARP\_STATE\_NONE};
467             \}
468          \}
469       \}
470       \textcolor{comment}{//REACHABLE state?}
471       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a5166b37c7baf2766482cda9e3cd5c59a}{ARP\_STATE\_REACHABLE})
472       \{
473          \textcolor{comment}{//Periodically time out ARP cache entries}
474          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp} + entry->
      \hyperlink{structArpCacheEntry_ad74ee2386d4551701aa641e9111c4df0}{timeout}) >= 0)
475          \{
476             \textcolor{comment}{//Save current time}
477             entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp} = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
478             \textcolor{comment}{//Enter STALE state}
479             entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} = \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a0a9b79308d1462c24535ce2bba8cf711}{ARP\_STATE\_STALE};
480          \}
481       \}
482       \textcolor{comment}{//DELAY state?}
483       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5af43ae88e7f99487bc1c154c38ab1768a}{ARP\_STATE\_DELAY})
484       \{
485          \textcolor{comment}{//Wait for the specified delay before sending the first probe}
486          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp} + entry->
      \hyperlink{structArpCacheEntry_ad74ee2386d4551701aa641e9111c4df0}{timeout}) >= 0)
487          \{
488             \textcolor{comment}{//Send a point-to-point ARP request to the host}
489             \hyperlink{arp_8c_a01808695b2ef58c55179909126ce9f8f}{arpSendRequest}(interface, entry->\hyperlink{structArpCacheEntry_a1bea163ecbcefd764974eda38077edf1}{ipAddr}, &entry->
      \hyperlink{structArpCacheEntry_a48913a7a1aa68c83f6a34fa71091acb0}{macAddr});
490 
491             \textcolor{comment}{//Save the time at which the packet was sent}
492             entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp} = \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
493             \textcolor{comment}{//Set timeout value}
494             entry->\hyperlink{structArpCacheEntry_ad74ee2386d4551701aa641e9111c4df0}{timeout} = \hyperlink{arp_8h_a8dd06cd92e889d1c2f449b713b82e198}{ARP\_PROBE\_TIMEOUT};
495             \textcolor{comment}{//Switch to the PROBE state}
496             entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} = \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a82d89e2b6fc81da67a1902d73ff755d5}{ARP\_STATE\_PROBE};
497          \}
498       \}
499       \textcolor{comment}{//PROBE state?}
500       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} == \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a82d89e2b6fc81da67a1902d73ff755d5}{ARP\_STATE\_PROBE})
501       \{
502          \textcolor{comment}{//The request timed out?}
503          \textcolor{keywordflow}{if}(\hyperlink{os__port_8h_a25c13833ef003da02045a91b1080263a}{timeCompare}(time, entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp} + entry->
      \hyperlink{structArpCacheEntry_ad74ee2386d4551701aa641e9111c4df0}{timeout}) >= 0)
504          \{
505             \textcolor{comment}{//Increment retransmission counter}
506             entry->\hyperlink{structArpCacheEntry_a94ca6d58bf237b77eec4419fceac39ab}{retransmitCount}++;
507 
508             \textcolor{comment}{//Check whether the maximum number of retransmissions has been exceeded}
509             \textcolor{keywordflow}{if}(entry->\hyperlink{structArpCacheEntry_a94ca6d58bf237b77eec4419fceac39ab}{retransmitCount} < \hyperlink{arp_8h_a099dd6ad217f834c13bdb06fbb76a5e4}{ARP\_MAX\_PROBES})
510             \{
511                \textcolor{comment}{//Send a point-to-point ARP request to the host}
512                \hyperlink{arp_8c_a01808695b2ef58c55179909126ce9f8f}{arpSendRequest}(interface, entry->\hyperlink{structArpCacheEntry_a1bea163ecbcefd764974eda38077edf1}{ipAddr}, &entry->
      \hyperlink{structArpCacheEntry_a48913a7a1aa68c83f6a34fa71091acb0}{macAddr});
513 
514                \textcolor{comment}{//Save the time at which the packet was sent}
515                entry->\hyperlink{structArpCacheEntry_a10d340cfb6df76db9d3b154bdee2758c}{timestamp} = \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
516                \textcolor{comment}{//Set timeout value}
517                entry->\hyperlink{structArpCacheEntry_ad74ee2386d4551701aa641e9111c4df0}{timeout} = \hyperlink{arp_8h_a8dd06cd92e889d1c2f449b713b82e198}{ARP\_PROBE\_TIMEOUT};
518             \}
519             \textcolor{keywordflow}{else}
520             \{
521                \textcolor{comment}{//The entry should be deleted since the host is not reachable anymore}
522                entry->\hyperlink{structArpCacheEntry_aa0bba797a4db6b52cebcd868d52e6361}{state} = \hyperlink{arp_8h_a9beda55edee387702e47f03bb204deb5a09db81d13b46a2908f3d8a62d7ba5ce0}{ARP\_STATE\_NONE};
523             \}
524          \}
525       \}
526    \}
527 \}
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{arp_8c_aa0adbd8d7d464b063104f6457979643e}\label{arp_8c_aa0adbd8d7d464b063104f6457979643e}} 
\index{arp.\+c@{arp.\+c}!arp\+Tick\+Counter@{arp\+Tick\+Counter}}
\index{arp\+Tick\+Counter@{arp\+Tick\+Counter}!arp.\+c@{arp.\+c}}
\subsubsection{\texorpdfstring{arp\+Tick\+Counter}{arpTickCounter}}
{\footnotesize\ttfamily \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\+\_\+t} arp\+Tick\+Counter}



Definition at line 51 of file arp.\+c.

