\hypertarget{tls__client__fsm_8c}{}\section{cyclone\+\_\+ssl/tls\+\_\+client\+\_\+fsm.c File Reference}
\label{tls__client__fsm_8c}\index{cyclone\+\_\+ssl/tls\+\_\+client\+\_\+fsm.\+c@{cyclone\+\_\+ssl/tls\+\_\+client\+\_\+fsm.\+c}}


T\+LS state machine (T\+LS client)  


{\ttfamily \#include \char`\"{}tls.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+handshake.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+client\+\_\+fsm.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+common.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+record.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls13\+\_\+client.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls13\+\_\+client\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls13\+\_\+common.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls13\+\_\+key\+\_\+material.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{tls__client__fsm_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{tls__config_8h_afee42a623033dac888291d1993985206}{T\+L\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__fsm_8c_ae64b68918d36ccfba6230c918fe3bf6e}{tls\+Perform\+Client\+Handshake} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em T\+LS client handshake. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__client__fsm_8c_aea420e8e37aba190c9ccb4f9249d87bb}{tls\+Parse\+Server\+Handshake\+Message} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{mqtt__sn__common_8h_a9d7facd71a8c8355a77006f5a6dcd420}{msg\+Type}, const void $\ast$\hyperlink{pap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length})
\begin{DoxyCompactList}\small\item\em Parse server\textquotesingle{}s handshake message. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
T\+LS state machine (T\+LS client) 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+S\+SL Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{tls__client__fsm_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{tls__client__fsm_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{tls\+\_\+client\+\_\+fsm.\+c@{tls\+\_\+client\+\_\+fsm.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!tls\+\_\+client\+\_\+fsm.\+c@{tls\+\_\+client\+\_\+fsm.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{tls__config_8h_afee42a623033dac888291d1993985206}{T\+L\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file tls\+\_\+client\+\_\+fsm.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{tls__client__fsm_8c_aea420e8e37aba190c9ccb4f9249d87bb}\label{tls__client__fsm_8c_aea420e8e37aba190c9ccb4f9249d87bb}} 
\index{tls\+\_\+client\+\_\+fsm.\+c@{tls\+\_\+client\+\_\+fsm.\+c}!tls\+Parse\+Server\+Handshake\+Message@{tls\+Parse\+Server\+Handshake\+Message}}
\index{tls\+Parse\+Server\+Handshake\+Message@{tls\+Parse\+Server\+Handshake\+Message}!tls\+\_\+client\+\_\+fsm.\+c@{tls\+\_\+client\+\_\+fsm.\+c}}
\subsubsection{\texorpdfstring{tls\+Parse\+Server\+Handshake\+Message()}{tlsParseServerHandshakeMessage()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Parse\+Server\+Handshake\+Message (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t}}]{msg\+Type,  }\item[{const void $\ast$}]{message,  }\item[{size\+\_\+t}]{length }\end{DoxyParamCaption})}



Parse server\textquotesingle{}s handshake message. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em msg\+Type} & Handshake message type \\
\hline
\mbox{\tt in}  & {\em message} & Pointer to the handshake message to parse \\
\hline
\mbox{\tt in}  & {\em length} & Length of the handshake messaged \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 248 of file tls\+\_\+client\+\_\+fsm.\+c.


\begin{DoxyCode}
250 \{
251    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
252 
253    \textcolor{comment}{//Check handshake message type}
254    \textcolor{keywordflow}{switch}(\hyperlink{dtls__misc_8h_a9d7facd71a8c8355a77006f5a6dcd420}{msgType})
255    \{
256    \textcolor{comment}{//HelloRequest message received?}
257    \textcolor{keywordflow}{case} \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9baa9428dd744b7ffb47682aa40f988dd70}{TLS\_TYPE\_HELLO\_REQUEST}:
258       \textcolor{comment}{//HelloRequest is a simple notification that the client should begin the}
259       \textcolor{comment}{//negotiation process anew}
260       error = \hyperlink{tls__client_8c_a81ca7c5ae469fee80d67742b49cd5329}{tlsParseHelloRequest}(context, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
261       \textcolor{keywordflow}{break};
262 
263    \textcolor{comment}{//ServerHello message received?}
264    \textcolor{keywordflow}{case} \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba0ec92de95e5ea4899b69affe1bc7aeac}{TLS\_TYPE\_SERVER\_HELLO}:
265 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
266       \textcolor{comment}{//For backward compatibility with middleboxes the HelloRetryRequest}
267       \textcolor{comment}{//message uses the same structure as the ServerHello, but with Random}
268       \textcolor{comment}{//field set to a special value}
269       \textcolor{keywordflow}{if}(\hyperlink{tls13__client__misc_8h_ac911c9e2418b8ca18e62e48bc3e4c2aa}{tls13IsHelloRetryRequest}(\hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}))
270       \{
271          \textcolor{comment}{//The server sends a HelloRetryRequest message if the ClientHello}
272          \textcolor{comment}{//message does not contain sufficient information to proceed with}
273          \textcolor{comment}{//the handshake}
274          error = \hyperlink{tls13__client_8h_a556d1e423c771003b9dedcee41bfc2aa}{tls13ParseHelloRetryRequest}(context, 
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
275       \}
276       \textcolor{keywordflow}{else}
277 \textcolor{preprocessor}{#endif}
278       \{
279          \textcolor{comment}{//The server will send this message in response to a ClientHello}
280          \textcolor{comment}{//message when it was able to find an acceptable set of algorithms}
281          error = \hyperlink{tls__client_8c_a8a87bf037ce4a5d6f43a3a4973956a2b}{tlsParseServerHello}(context, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
282       \}
283       \textcolor{keywordflow}{break};
284 
285    \textcolor{comment}{//Certificate message received?}
286    \textcolor{keywordflow}{case} \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9bab621c6882cff8d5b59980875b6ce7cfc}{TLS\_TYPE\_CERTIFICATE}:
287       \textcolor{comment}{//The server must send a Certificate message whenever the agreed-upon}
288       \textcolor{comment}{//key exchange method uses certificates for authentication. This message}
289       \textcolor{comment}{//will always immediately follow the ServerHello message}
290       error = \hyperlink{tls__common_8c_a8ea298350bb1262e85bca00a448122f3}{tlsParseCertificate}(context, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
291       \textcolor{keywordflow}{break};
292 
293    \textcolor{comment}{//CertificateRequest message received?}
294    \textcolor{keywordflow}{case} \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9badf4f63379ab93eec891cdbae8f8a2717}{TLS\_TYPE\_CERTIFICATE\_REQUEST}:
295       \textcolor{comment}{//A non-anonymous server can optionally request a certificate from the}
296       \textcolor{comment}{//client, if appropriate for the selected cipher suite. This message,}
297       \textcolor{comment}{//if sent, will immediately follow the ServerKeyExchange message}
298       error = \hyperlink{tls__client_8c_ab5d289458cdd60951cd498313a7a39a2}{tlsParseCertificateRequest}(context, 
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
299       \textcolor{keywordflow}{break};
300 
301    \textcolor{comment}{//Finished message received?}
302    \textcolor{keywordflow}{case} \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9baa70dd3c1f4f49e708201d020a2125b9f}{TLS\_TYPE\_FINISHED}:
303       \textcolor{comment}{//A Finished message is always sent immediately after a ChangeCipherSpec}
304       \textcolor{comment}{//message to verify that the key exchange and authentication processes}
305       \textcolor{comment}{//were successful}
306       error = \hyperlink{tls__common_8c_ad2a518c781f8297e7b21fdbeb569de31}{tlsParseFinished}(context, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
307       \textcolor{keywordflow}{break};
308 
309 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
310    \textcolor{comment}{//HelloVerifyRequest message received?}
311    \textcolor{keywordflow}{case} \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9bada2322e839eb9462ae7b291fdae02110}{TLS\_TYPE\_HELLO\_VERIFY\_REQUEST}:
312       \textcolor{comment}{//When the client sends its ClientHello message to the server, the server}
313       \textcolor{comment}{//may respond with a HelloVerifyRequest message}
314       error = \hyperlink{dtls__misc_8c_a6d24a5bb0cc6356fce0849aad3f87b3a}{dtlsParseHelloVerifyRequest}(context, 
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
315       \textcolor{keywordflow}{break};
316 \textcolor{preprocessor}{#endif}
317 
318 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
319    \textcolor{comment}{//ServerKeyExchange message received?}
320    \textcolor{keywordflow}{case} \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9baa4910b2d8fcdfb42e1e3199e634ce290}{TLS\_TYPE\_SERVER\_KEY\_EXCHANGE}:
321       \textcolor{comment}{//The ServerKeyExchange message is sent by the server only when the}
322       \textcolor{comment}{//server Certificate message (if sent) does not contain enough data}
323       \textcolor{comment}{//to allow the client to exchange a premaster secret}
324       error = \hyperlink{tls__client_8c_a31b6586adec9fe0527edcf448dfa34b1}{tlsParseServerKeyExchange}(context, 
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
325       \textcolor{keywordflow}{break};
326 
327    \textcolor{comment}{//ServerHelloDone message received?}
328    \textcolor{keywordflow}{case} \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba979c5881efc687024fa12190b925ac1f}{TLS\_TYPE\_SERVER\_HELLO\_DONE}:
329       \textcolor{comment}{//The ServerHelloDone message is sent by the server to indicate the end}
330       \textcolor{comment}{//of the ServerHello and associated messages}
331       error = \hyperlink{tls__client_8c_afa16663d44f1be4f22bedea28caaa35c}{tlsParseServerHelloDone}(context, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
332       \textcolor{keywordflow}{break};
333 \textcolor{preprocessor}{#endif}
334 
335 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
336    \textcolor{comment}{//EncryptedExtensions message received?}
337    \textcolor{keywordflow}{case} \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9baca1f58dfb4bcf29b9b5097ddb72189d8}{TLS\_TYPE\_ENCRYPTED\_EXTENSIONS}:
338       \textcolor{comment}{//The server sends the EncryptedExtensions message immediately after}
339       \textcolor{comment}{//the ServerHello message. The EncryptedExtensions message contains}
340       \textcolor{comment}{//extensions that can be protected}
341       error = \hyperlink{tls13__client_8h_abf1184efc29d2047174d14ac52076cba}{tls13ParseEncryptedExtensions}(context, 
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
342       \textcolor{keywordflow}{break};
343 
344    \textcolor{comment}{//CertificateVerify message received?}
345    \textcolor{keywordflow}{case} \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9ba43d7fd238682404358c9831b0048aa18}{TLS\_TYPE\_CERTIFICATE\_VERIFY}:
346       \textcolor{comment}{//Servers must send this message when authenticating via a certificate.}
347       \textcolor{comment}{//When sent, this message must appear immediately after the Certificate}
348       \textcolor{comment}{//message}
349       error = \hyperlink{tls__common_8c_a28b47eb94395efb96c6b4d274a5aeb38}{tlsParseCertificateVerify}(context, 
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
350       \textcolor{keywordflow}{break};
351 
352    \textcolor{comment}{//NewSessionTicket message received?}
353    \textcolor{keywordflow}{case} \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9badd2d0307b59249022f09225e97228e94}{TLS\_TYPE\_NEW\_SESSION\_TICKET}:
354       \textcolor{comment}{//At any time after the server has received the client Finished message,}
355       \textcolor{comment}{//it may send a NewSessionTicket message}
356       error = \hyperlink{tls13__client_8h_a01cacb30ceac4ced62d171a2a45cb946}{tls13ParseNewSessionTicket}(context, 
      \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
357       \textcolor{keywordflow}{break};
358 
359    \textcolor{comment}{//KeyUpdate message received?}
360    \textcolor{keywordflow}{case} \hyperlink{tls_8h_aea257240929f03e1e6ea3c7ab65ddb9bab97fd5abc6c82fbde3813a4f585323f2}{TLS\_TYPE\_KEY\_UPDATE}:
361       \textcolor{comment}{//The KeyUpdate handshake message is used to indicate that the server}
362       \textcolor{comment}{//is updating its sending cryptographic keys. This message can be sent}
363       \textcolor{comment}{//by the server after it has sent a Finished message}
364       error = \hyperlink{tls13__common_8h_a2c0e9ef093247bf63593fc36c33e6c8a}{tls13ParseKeyUpdate}(context, \hyperlink{chap_8h_a52f19d36a71e9b8ddea38fe00c291181}{message}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length});
365       \textcolor{keywordflow}{break};
366 \textcolor{preprocessor}{#endif}
367 
368    \textcolor{comment}{//Invalid handshake message received?}
369    \textcolor{keywordflow}{default}:
370       \textcolor{comment}{//Report an error}
371       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafb4f7e4640c9d495bf35ee668d620b17}{ERROR\_UNEXPECTED\_MESSAGE};
372    \}
373 
374    \textcolor{comment}{//Return status code}
375    \textcolor{keywordflow}{return} error;
376 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__client__fsm_8c_ae64b68918d36ccfba6230c918fe3bf6e}\label{tls__client__fsm_8c_ae64b68918d36ccfba6230c918fe3bf6e}} 
\index{tls\+\_\+client\+\_\+fsm.\+c@{tls\+\_\+client\+\_\+fsm.\+c}!tls\+Perform\+Client\+Handshake@{tls\+Perform\+Client\+Handshake}}
\index{tls\+Perform\+Client\+Handshake@{tls\+Perform\+Client\+Handshake}!tls\+\_\+client\+\_\+fsm.\+c@{tls\+\_\+client\+\_\+fsm.\+c}}
\subsubsection{\texorpdfstring{tls\+Perform\+Client\+Handshake()}{tlsPerformClientHandshake()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Perform\+Client\+Handshake (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



T\+LS client handshake. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 58 of file tls\+\_\+client\+\_\+fsm.\+c.


\begin{DoxyCode}
59 \{
60    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
61 
62    \textcolor{comment}{//Initialize status code}
63    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
64 
65    \textcolor{comment}{//Wait for the handshake to complete}
66    \textcolor{keywordflow}{while}(!error)
67    \{
68       \textcolor{comment}{//TLS protocol?}
69       \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa2fbbbd6c318570d570225144f3c6c244}{TLS\_TRANSPORT\_PROTOCOL\_STREAM})
70       \{
71          \textcolor{comment}{//Check current state}
72          \textcolor{keywordflow}{if}(context->state != \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da91123cf9d82ef3aac68e9e091ef5c9f9}{TLS\_STATE\_INIT} &&
73             context->state != \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da182b100e092b0058c72d76006b7981fd}{TLS\_STATE\_CLOSED})
74          \{
75             \textcolor{comment}{//Flush send buffer}
76             error = \hyperlink{tls__record_8c_ae8f8c035d23eb99d1d5642d4ce644715}{tlsWriteProtocolData}(context, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}, 0, 
      \hyperlink{tls_8h_a6fad1efb9f011dc3f76039976bef896ca86bbddd09b8894c9f1bcf5c721b0d412}{TLS\_TYPE\_NONE});
77             \textcolor{comment}{//Any error to report?}
78             \textcolor{keywordflow}{if}(error)
79                \textcolor{keywordflow}{break};
80          \}
81       \}
82 
83       \textcolor{comment}{//Check whether the handshake is complete}
84       \textcolor{keywordflow}{if}(context->state == \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da7ff3a76e0b1787b6d0026e533a89649b}{TLS\_STATE\_APPLICATION\_DATA})
85       \{
86          \textcolor{comment}{//At this is point, the handshake is complete and the client starts}
87          \textcolor{comment}{//to exchange application-layer data}
88          \textcolor{keywordflow}{break};
89       \}
90 
91       \textcolor{comment}{//The TLS handshake is implemented as a state machine representing the}
92       \textcolor{comment}{//current location in the protocol}
93       \textcolor{keywordflow}{switch}(context->state)
94       \{
95       \textcolor{comment}{//Initial state?}
96       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da91123cf9d82ef3aac68e9e091ef5c9f9}{TLS\_STATE\_INIT}:
97          \textcolor{comment}{//TLS handshake initialization}
98          error = \hyperlink{tls__handshake_8c_a89760024b4640ed45d9961d0cd91d4d3}{tlsInitHandshake}(context);
99          \textcolor{keywordflow}{break};
100 
101       \textcolor{comment}{//Sending ClientHello message?}
102       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dade201db86ae38480c06696f3a48e0170}{TLS\_STATE\_CLIENT\_HELLO}:
103       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da535ebf5eb2c0397b2d6ed43669f63a7d}{TLS\_STATE\_CLIENT\_HELLO\_2}:
104          \textcolor{comment}{//When a client first connects to a server, it is required to send}
105          \textcolor{comment}{//the ClientHello as its first message}
106          error = \hyperlink{tls__client_8c_ae08e364f08b197642487228b0d090634}{tlsSendClientHello}(context);
107          \textcolor{keywordflow}{break};
108 
109       \textcolor{comment}{//Sending Certificate message?}
110       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daf228b75114f59a280fff6ec472c5a251}{TLS\_STATE\_CLIENT\_CERTIFICATE}:
111          \textcolor{comment}{//This is the first message the client can send after receiving a}
112          \textcolor{comment}{//ServerHelloDone message. This message is only sent if the server}
113          \textcolor{comment}{//requests a certificate}
114          error = \hyperlink{tls__common_8c_ae447dcb4133c50b4baf93b4808824474}{tlsSendCertificate}(context);
115          \textcolor{keywordflow}{break};
116 
117       \textcolor{comment}{//Sending CertificateVerify message?}
118       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da0f0ff1805dfdec56bba42cbd8f42097b}{TLS\_STATE\_CLIENT\_CERTIFICATE\_VERIFY}:
119          \textcolor{comment}{//This message is used to provide explicit verification of a client}
120          \textcolor{comment}{//certificate. This message is only sent following a client certificate}
121          \textcolor{comment}{//that has signing capability. When sent, it must immediately follow}
122          \textcolor{comment}{//the clientKeyExchange message}
123          error = \hyperlink{tls__common_8c_ad10693e5b3286d3df6fca1597c61201e}{tlsSendCertificateVerify}(context);
124          \textcolor{keywordflow}{break};
125 
126       \textcolor{comment}{//Sending ChangeCipherSpec message?}
127       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daf4ad5e0b1c92eb5991962aa9f3a6932b}{TLS\_STATE\_CLIENT\_CHANGE\_CIPHER\_SPEC}:
128       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da9e601264440c96a1e68763e9b0e5761a}{TLS\_STATE\_CLIENT\_CHANGE\_CIPHER\_SPEC\_2}:
129          \textcolor{comment}{//The ChangeCipherSpec message is sent by the client and to notify the}
130          \textcolor{comment}{//server that subsequent records will be protected under the newly}
131          \textcolor{comment}{//negotiated CipherSpec and keys}
132          error = \hyperlink{tls__common_8c_a4a916411e28b77ed86195f311ebebb4b}{tlsSendChangeCipherSpec}(context);
133          \textcolor{keywordflow}{break};
134 
135       \textcolor{comment}{//Sending Finished message?}
136       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da3cb415075672864bb35731a372a18fbd}{TLS\_STATE\_CLIENT\_FINISHED}:
137          \textcolor{comment}{//A Finished message is always sent immediately after a ChangeCipherSpec}
138          \textcolor{comment}{//message to verify that the key exchange and authentication processes}
139          \textcolor{comment}{//were successful}
140          error = \hyperlink{tls__common_8c_a6830d5e2c36cf6293e93369370d8e4c2}{tlsSendFinished}(context);
141          \textcolor{keywordflow}{break};
142 
143 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
144       \textcolor{comment}{//Sending ClientKeyExchange message?}
145       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daec55a02fa5725d9b44460666d30b3a5c}{TLS\_STATE\_CLIENT\_KEY\_EXCHANGE}:
146          \textcolor{comment}{//This message is always sent by the client. It must immediately}
147          \textcolor{comment}{//follow the client certificate message, if it is sent. Otherwise,}
148          \textcolor{comment}{//it must be the first message sent by the client after it receives}
149          \textcolor{comment}{//the ServerHelloDone message}
150          error = \hyperlink{tls__client_8c_a8093867cfcf2598d3c186d34a55a61c4}{tlsSendClientKeyExchange}(context);
151          \textcolor{keywordflow}{break};
152 \textcolor{preprocessor}{#endif}
153 
154 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
155       \textcolor{comment}{//Sending EndOfEarlyData message?}
156       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dab81557d62e95162a1c4f1ceb4bb20cb1}{TLS\_STATE\_END\_OF\_EARLY\_DATA}:
157          \textcolor{comment}{//The EndOfEarlyData message indicates that all 0-RTT application}
158          \textcolor{comment}{//data messages, if any, have been transmitted and that the following}
159          \textcolor{comment}{//records are protected under handshake traffic keys}
160          error = \hyperlink{tls13__client_8h_ac849f47db5f71cee30193451dda0a621}{tls13SendEndOfEarlyData}(context);
161          \textcolor{keywordflow}{break};
162 
163       \textcolor{comment}{//Handshake traffic key generation?}
164       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daeb443224abb7649fc9e8adf3e51864a2}{TLS\_STATE\_HANDSHAKE\_TRAFFIC\_KEYS}:
165          \textcolor{comment}{//Compute handshake traffic keys}
166          error = \hyperlink{tls13__key__material_8h_a5a007be4a677342cdf83df08c92d59a7}{tls13GenerateHandshakeTrafficKeys}(context);
167          \textcolor{keywordflow}{break};
168 
169       \textcolor{comment}{//Server application traffic key generation?}
170       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da4540b72ab65fe29516e8148fbb43261d}{TLS\_STATE\_SERVER\_APP\_TRAFFIC\_KEYS}:
171          \textcolor{comment}{//Compute server application traffic keys}
172          error = \hyperlink{tls13__key__material_8h_a3ff36fe11c6a23b6e036e456f5fccfac}{tls13GenerateServerAppTrafficKeys}(context);
173          \textcolor{keywordflow}{break};
174 
175       \textcolor{comment}{//Client application traffic key generation?}
176       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da429690fe1b1bd88bcc256dc5ec811448}{TLS\_STATE\_CLIENT\_APP\_TRAFFIC\_KEYS}:
177          \textcolor{comment}{//Compute client application traffic keys}
178          error = \hyperlink{tls13__key__material_8h_a149f0e82a98fbe08b175f47c9a47682f}{tls13GenerateClientAppTrafficKeys}(context);
179          \textcolor{keywordflow}{break};
180 
181       \textcolor{comment}{//Sending KeyUpdate message?}
182       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da68485949c9524dff9175a025cac5f3b8}{TLS\_STATE\_KEY\_UPDATE}:
183          \textcolor{comment}{//The KeyUpdate handshake message is used to indicate that the sender}
184          \textcolor{comment}{//is updating its sending cryptographic keys}
185          error = \hyperlink{tls13__common_8h_a0f8477a44383f9efb6abab5203865a16}{tls13SendKeyUpdate}(context);
186          \textcolor{keywordflow}{break};
187 \textcolor{preprocessor}{#endif}
188 
189       \textcolor{comment}{//Waiting for a message from the server?}
190       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da69787ce8e1f218e8e47defe7af1c601a}{TLS\_STATE\_SERVER\_HELLO}:
191       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da22971523377f52c52b251553e373b4c8}{TLS\_STATE\_SERVER\_HELLO\_2}:
192       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dac2a251e510ed5a202b13f7fe615767cc}{TLS\_STATE\_SERVER\_HELLO\_3}:
193       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4daf72c48e789c26be573d3726c9e7ad163}{TLS\_STATE\_ENCRYPTED\_EXTENSIONS}:
194       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da09790eaca7bac9c6bfd5b3e0775b6074}{TLS\_STATE\_SERVER\_CERTIFICATE}:
195       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da8ed746876fcd686d131f90d04809fd32}{TLS\_STATE\_SERVER\_KEY\_EXCHANGE}:
196       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da21097ff5428ba2ba5b8be925fd42224b}{TLS\_STATE\_SERVER\_CERTIFICATE\_VERIFY}:
197       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dae316fcecd0b42b329c94f5c3102d8783}{TLS\_STATE\_CERTIFICATE\_REQUEST}:
198       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dacfeeaa75eec1aecc4c975236b2af1f9c}{TLS\_STATE\_SERVER\_HELLO\_DONE}:
199       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da0023cfdc8ed0f0062637380bee3683a0}{TLS\_STATE\_SERVER\_CHANGE\_CIPHER\_SPEC}:
200       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da4638034a43094f0a8409cc8f0163d23b}{TLS\_STATE\_SERVER\_FINISHED}:
201          \textcolor{comment}{//Receive server's message}
202          error = \hyperlink{tls__handshake_8c_a56fc0a8992b1b7e5a2420f9557b39561}{tlsReceiveHandshakeMessage}(context);
203          \textcolor{keywordflow}{break};
204 
205       \textcolor{comment}{//Sending Alert message?}
206       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4dabb02ceb758f4c4dedc2aabf472677fbe}{TLS\_STATE\_CLOSING}:
207          \textcolor{comment}{//Mark the TLS connection as closed}
208          context->state = \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da182b100e092b0058c72d76006b7981fd}{TLS\_STATE\_CLOSED};
209          \textcolor{keywordflow}{break};
210 
211       \textcolor{comment}{//TLS connection closed?}
212       \textcolor{keywordflow}{case} \hyperlink{tls_8h_a02bb4c8aa7988b33fe4d4836d8ff4a4da182b100e092b0058c72d76006b7981fd}{TLS\_STATE\_CLOSED}:
213          \textcolor{comment}{//Debug message}
214          \hyperlink{debug_8h_a72b9761add7486364dba449091cd2579}{TRACE\_WARNING}(\textcolor{stringliteral}{"TLS handshake failure!\(\backslash\)r\(\backslash\)n"});
215          \textcolor{comment}{//Report an error}
216          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca70d82df53df56c9d4a943d5539ccc4bc}{ERROR\_HANDSHAKE\_FAILED};
217          \textcolor{keywordflow}{break};
218 
219       \textcolor{comment}{//Invalid state?}
220       \textcolor{keywordflow}{default}:
221          \textcolor{comment}{//Report an error}
222          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac17950207f5a741c1f2a1f5edb64c22e}{ERROR\_UNEXPECTED\_STATE};
223          \textcolor{keywordflow}{break};
224       \}
225    \}
226 
227    \textcolor{comment}{//Any error to report?}
228    \textcolor{keywordflow}{if}(error)
229    \{
230       \textcolor{comment}{//Send an alert message to the server, if applicable}
231       \hyperlink{tls__misc_8c_ae43b7ef806126baf125c46cdb9424e87}{tlsProcessError}(context, error);
232    \}
233 
234    \textcolor{comment}{//Return status code}
235    \textcolor{keywordflow}{return} error;
236 \}
\end{DoxyCode}
