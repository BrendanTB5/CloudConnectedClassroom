\hypertarget{nm__bus__wrapper__samv71_8c}{}\section{third\+\_\+party/atmel/devices/wilc1000/bus\+\_\+wrapper/source/nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.c File Reference}
\label{nm__bus__wrapper__samv71_8c}\index{third\+\_\+party/atmel/devices/wilc1000/bus\+\_\+wrapper/source/nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{third\+\_\+party/atmel/devices/wilc1000/bus\+\_\+wrapper/source/nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}}


S\+PI bus wrapper for S\+A\+M\+V71 microcontrollers.  


{\ttfamily \#include $<$stdio.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include \char`\"{}samv71.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}bsp/include/nm\+\_\+bsp.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}common/include/nm\+\_\+common.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}bus\+\_\+wrapper/include/nm\+\_\+bus\+\_\+wrapper.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{nm__bus__wrapper__samv71_8c_afbc973888cb214292ecd9094a69adf68}{N\+M\+\_\+\+B\+U\+S\+\_\+\+M\+A\+X\+\_\+\+T\+R\+X\+\_\+\+SZ}~4096
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
static \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{nm__bus__wrapper__stm32l4xx_8c_a38e2250244d3f7799048819b9aed0b1e}{tx\+Buffer} \mbox{[}\hyperlink{nm__bus__wrapper__stm32l4xx_8c_afbc973888cb214292ecd9094a69adf68}{N\+M\+\_\+\+B\+U\+S\+\_\+\+M\+A\+X\+\_\+\+T\+R\+X\+\_\+\+SZ}\mbox{]} \hyperlink{nm__bus__wrapper__samv71_8c_a6f20565b6f00d89eb51d1cb1b8e54350}{\+\_\+\+\_\+attribute\+\_\+\+\_\+} ((aligned(4), \+\_\+\+\_\+section\+\_\+\+\_\+(\char`\"{}.ram\+\_\+no\+\_\+cache\char`\"{})))
\item 
static \hyperlink{group__DataT_gae35f10ffd0ac8dd2bc3e794da9bdfbc7}{sint8} \hyperlink{nm__bus__wrapper__samv71_8c_ae656e55934eaeffc372287189b5e0d5b}{spi\+\_\+rw} (\hyperlink{group__DataT_ga4df709a77647e870bbf1d955b8edc9a6}{uint8} $\ast$pu8\+Mosi, \hyperlink{group__DataT_ga4df709a77647e870bbf1d955b8edc9a6}{uint8} $\ast$pu8\+Miso, \hyperlink{group__DataT_ga1daa745171fc6e31d942c161422a76f9}{uint16} u16\+Sz)
\begin{DoxyCompactList}\small\item\em S\+PI transfer. \end{DoxyCompactList}\item 
\hyperlink{group__DataT_gae35f10ffd0ac8dd2bc3e794da9bdfbc7}{sint8} \hyperlink{nm__bus__wrapper__samv71_8c_ac6735b4dcb286ba50ed1b2db8ae04d31}{nm\+\_\+bus\+\_\+init} (void $\ast$pvinit)
\begin{DoxyCompactList}\small\item\em S\+PI bus initialization. \end{DoxyCompactList}\item 
\hyperlink{group__DataT_gae35f10ffd0ac8dd2bc3e794da9bdfbc7}{sint8} \hyperlink{nm__bus__wrapper__samv71_8c_aa98500dc13748397906e03440fb3892a}{nm\+\_\+bus\+\_\+ioctl} (\hyperlink{group__DataT_ga4df709a77647e870bbf1d955b8edc9a6}{uint8} u8\+Cmd, void $\ast$pv\+Parameter)
\begin{DoxyCompactList}\small\item\em I\+O\+C\+TL command processing. \end{DoxyCompactList}\item 
\hyperlink{group__DataT_gae35f10ffd0ac8dd2bc3e794da9bdfbc7}{sint8} \hyperlink{nm__bus__wrapper__samv71_8c_a577ad43e9d464f7309b5ffa75f4ae15a}{nm\+\_\+bus\+\_\+deinit} (void)
\begin{DoxyCompactList}\small\item\em S\+PI bus deinitialization. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{structtstrNmBusCapabilities}{tstr\+Nm\+Bus\+Capabilities} \hyperlink{nm__bus__wrapper__samv71_8c_ae7dfa29166b4111ca6c3e3bab953eb79}{egstr\+Nm\+Bus\+Capabilities}
\begin{DoxyCompactList}\small\item\em Bus capabilities information. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
S\+PI bus wrapper for S\+A\+M\+V71 microcontrollers. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{nm__bus__wrapper__samv71_8c_afbc973888cb214292ecd9094a69adf68}\label{nm__bus__wrapper__samv71_8c_afbc973888cb214292ecd9094a69adf68}} 
\index{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}!N\+M\+\_\+\+B\+U\+S\+\_\+\+M\+A\+X\+\_\+\+T\+R\+X\+\_\+\+SZ@{N\+M\+\_\+\+B\+U\+S\+\_\+\+M\+A\+X\+\_\+\+T\+R\+X\+\_\+\+SZ}}
\index{N\+M\+\_\+\+B\+U\+S\+\_\+\+M\+A\+X\+\_\+\+T\+R\+X\+\_\+\+SZ@{N\+M\+\_\+\+B\+U\+S\+\_\+\+M\+A\+X\+\_\+\+T\+R\+X\+\_\+\+SZ}!nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}}
\subsubsection{\texorpdfstring{N\+M\+\_\+\+B\+U\+S\+\_\+\+M\+A\+X\+\_\+\+T\+R\+X\+\_\+\+SZ}{NM\_BUS\_MAX\_TRX\_SZ}}
{\footnotesize\ttfamily \#define N\+M\+\_\+\+B\+U\+S\+\_\+\+M\+A\+X\+\_\+\+T\+R\+X\+\_\+\+SZ~4096}



Definition at line 38 of file nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{nm__bus__wrapper__samv71_8c_a6f20565b6f00d89eb51d1cb1b8e54350}\label{nm__bus__wrapper__samv71_8c_a6f20565b6f00d89eb51d1cb1b8e54350}} 
\index{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}!\+\_\+\+\_\+attribute\+\_\+\+\_\+@{\+\_\+\+\_\+attribute\+\_\+\+\_\+}}
\index{\+\_\+\+\_\+attribute\+\_\+\+\_\+@{\+\_\+\+\_\+attribute\+\_\+\+\_\+}!nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}}
\subsubsection{\texorpdfstring{\+\_\+\+\_\+attribute\+\_\+\+\_\+()}{\_\_attribute\_\_()}}
{\footnotesize\ttfamily static \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} \hyperlink{nm__bus__wrapper__stm32l4xx_8c_a38e2250244d3f7799048819b9aed0b1e}{tx\+Buffer} \mbox{[}\hyperlink{nm__bus__wrapper__stm32l4xx_8c_afbc973888cb214292ecd9094a69adf68}{N\+M\+\_\+\+B\+U\+S\+\_\+\+M\+A\+X\+\_\+\+T\+R\+X\+\_\+\+SZ}\mbox{]} \+\_\+\+\_\+attribute\+\_\+\+\_\+ (\begin{DoxyParamCaption}\item[{(aligned(4), \+\_\+\+\_\+section\+\_\+\+\_\+(\char`\"{}.ram\+\_\+no\+\_\+cache\char`\"{}))}]{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}

\mbox{\Hypertarget{nm__bus__wrapper__samv71_8c_a577ad43e9d464f7309b5ffa75f4ae15a}\label{nm__bus__wrapper__samv71_8c_a577ad43e9d464f7309b5ffa75f4ae15a}} 
\index{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}!nm\+\_\+bus\+\_\+deinit@{nm\+\_\+bus\+\_\+deinit}}
\index{nm\+\_\+bus\+\_\+deinit@{nm\+\_\+bus\+\_\+deinit}!nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}}
\subsubsection{\texorpdfstring{nm\+\_\+bus\+\_\+deinit()}{nm\_bus\_deinit()}}
{\footnotesize\ttfamily \hyperlink{group__DataT_gae35f10ffd0ac8dd2bc3e794da9bdfbc7}{sint8} nm\+\_\+bus\+\_\+deinit (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



S\+PI bus deinitialization. 

De-\/initialize the bus wrapper.


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em pvinit} & Unused parameter \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Status code (M2\+M\+\_\+\+S\+U\+C\+C\+E\+SS or M2\+M\+\_\+\+E\+R\+R\+\_\+\+B\+U\+S\+\_\+\+F\+A\+IL) 
\end{DoxyReturn}


Definition at line 290 of file nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c.


\begin{DoxyCode}
291 \{
292    \textcolor{comment}{//Not implemented}
293    \textcolor{keywordflow}{return} \hyperlink{nm__common_8h_a9ef27ba27aafdd1aa3a79d3ba2c36b8f}{M2M\_SUCCESS};
294 \}
\end{DoxyCode}
\mbox{\Hypertarget{nm__bus__wrapper__samv71_8c_ac6735b4dcb286ba50ed1b2db8ae04d31}\label{nm__bus__wrapper__samv71_8c_ac6735b4dcb286ba50ed1b2db8ae04d31}} 
\index{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}!nm\+\_\+bus\+\_\+init@{nm\+\_\+bus\+\_\+init}}
\index{nm\+\_\+bus\+\_\+init@{nm\+\_\+bus\+\_\+init}!nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}}
\subsubsection{\texorpdfstring{nm\+\_\+bus\+\_\+init()}{nm\_bus\_init()}}
{\footnotesize\ttfamily \hyperlink{group__DataT_gae35f10ffd0ac8dd2bc3e794da9bdfbc7}{sint8} nm\+\_\+bus\+\_\+init (\begin{DoxyParamCaption}\item[{void $\ast$}]{pvinit }\end{DoxyParamCaption})}



S\+PI bus initialization. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em pvinit} & Unused parameter \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Status code (M2\+M\+\_\+\+S\+U\+C\+C\+E\+SS or M2\+M\+\_\+\+E\+R\+R\+\_\+\+B\+U\+S\+\_\+\+F\+A\+IL) 
\end{DoxyReturn}


Definition at line 197 of file nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c.


\begin{DoxyCode}
198 \{
199    \hyperlink{group__DataT_ga100e7c691a47d6978527c479a0158245}{uint32} div;
200 
201    \textcolor{comment}{//Enable PIO peripheral clock}
202    PMC->PMC\_PCER0 = (1 << CONF\_WILC\_SPI\_ID\_PIO);
203    \textcolor{comment}{//Enable SPI peripheral clock}
204    PMC->PMC\_PCER0 = (1 << CONF\_WILC\_SPI\_ID);
205    \textcolor{comment}{//Enable XDMAC peripheral clock}
206    PMC->PMC\_PCER1 = (1 << (ID\_XDMAC - 32));
207 
208    \textcolor{comment}{//Disable interrupts on SPI pins}
209    CONF\_WILC\_SPI\_PIO->PIO\_IDR = CONF\_WILC\_SCK\_PIN | CONF\_WILC\_MOSI\_PIN | CONF\_WILC\_MISO\_PIN;
210    \textcolor{comment}{//Internal pull-up resistors}
211    CONF\_WILC\_SPI\_PIO->PIO\_PUER = CONF\_WILC\_SCK\_PIN | CONF\_WILC\_MOSI\_PIN | CONF\_WILC\_MISO\_PIN;
212    \textcolor{comment}{//Assign corresponding pins to Peripheral B function}
213    CONF\_WILC\_SPI\_PIO->PIO\_ABCDSR[0] |= CONF\_WILC\_SCK\_PIN | CONF\_WILC\_MOSI\_PIN | CONF\_WILC\_MISO\_PIN;
214    CONF\_WILC\_SPI\_PIO->PIO\_ABCDSR[1] &= ~(CONF\_WILC\_SCK\_PIN | CONF\_WILC\_MOSI\_PIN | CONF\_WILC\_MISO\_PIN);
215    \textcolor{comment}{//Disable the PIO from controlling the corresponding pins}
216    CONF\_WILC\_SPI\_PIO->PIO\_PDR = CONF\_WILC\_SCK\_PIN | CONF\_WILC\_MOSI\_PIN | CONF\_WILC\_MISO\_PIN;
217 
218    \textcolor{comment}{//Disable SPI module}
219    CONF\_WILC\_SPI->SPI\_CR = SPI\_CR\_SPIDIS;
220    \textcolor{comment}{//Reset SPI module}
221    CONF\_WILC\_SPI->SPI\_CR = SPI\_CR\_SWRST;
222    CONF\_WILC\_SPI->SPI\_CR = SPI\_CR\_SWRST;
223 
224    \textcolor{comment}{//Master mode operation}
225    CONF\_WILC\_SPI->SPI\_MR = SPI\_MR\_MODFDIS | SPI\_MR\_MSTR;
226 
227    \textcolor{comment}{//Calculate clock divider}
228    div = SystemCoreClock / CONF\_WILC\_SPI\_CLOCK;
229 
230    \textcolor{comment}{//SPI configuration (8-bit words, clock phase = 1, clock polarity = 0)}
231    CONF\_WILC\_SPI->SPI\_CSR[0] = SPI\_CSR\_SCBR(div) | SPI\_CSR\_BITS\_8\_BIT | SPI\_CSR\_NCPHA;
232 
233    \textcolor{comment}{//Enable SPI module}
234    CONF\_WILC\_SPI->SPI\_CR = SPI\_CR\_SPIEN;
235 
236    \textcolor{comment}{//Reset WILC1000}
237    \hyperlink{group__NmBspResetFn_ga3e540428a9246a27c61999ecb7e13d05}{nm\_bsp\_reset}();
238 
239    \textcolor{comment}{//Successful operation}
240    \textcolor{keywordflow}{return} \hyperlink{nm__common_8h_a9ef27ba27aafdd1aa3a79d3ba2c36b8f}{M2M\_SUCCESS};
241 \}
\end{DoxyCode}
\mbox{\Hypertarget{nm__bus__wrapper__samv71_8c_aa98500dc13748397906e03440fb3892a}\label{nm__bus__wrapper__samv71_8c_aa98500dc13748397906e03440fb3892a}} 
\index{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}!nm\+\_\+bus\+\_\+ioctl@{nm\+\_\+bus\+\_\+ioctl}}
\index{nm\+\_\+bus\+\_\+ioctl@{nm\+\_\+bus\+\_\+ioctl}!nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}}
\subsubsection{\texorpdfstring{nm\+\_\+bus\+\_\+ioctl()}{nm\_bus\_ioctl()}}
{\footnotesize\ttfamily \hyperlink{group__DataT_gae35f10ffd0ac8dd2bc3e794da9bdfbc7}{sint8} nm\+\_\+bus\+\_\+ioctl (\begin{DoxyParamCaption}\item[{\hyperlink{group__DataT_ga4df709a77647e870bbf1d955b8edc9a6}{uint8}}]{u8\+Cmd,  }\item[{void $\ast$}]{pv\+Parameter }\end{DoxyParamCaption})}



I\+O\+C\+TL command processing. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em u8\+Cmd} & Command opcode \\
\hline
\mbox{\tt in}  & {\em pv\+Parameter} & Command parameters \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Status code (M2\+M\+\_\+\+S\+U\+C\+C\+E\+SS or M2\+M\+\_\+\+E\+R\+R\+\_\+\+B\+U\+S\+\_\+\+F\+A\+IL) 
\end{DoxyReturn}


Definition at line 251 of file nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c.


\begin{DoxyCode}
252 \{
253    \hyperlink{group__DataT_gae35f10ffd0ac8dd2bc3e794da9bdfbc7}{sint8} ret;
254 \textcolor{preprocessor}{#ifdef CONF\_WILC\_USE\_SPI}
255    \hyperlink{structtstrNmSpiRw}{tstrNmSpiRw} *spiRwParams;
256 \textcolor{preprocessor}{#endif}
257 
258    \textcolor{comment}{//Check commande opcode}
259    \textcolor{keywordflow}{switch}(u8Cmd)
260    \{
261 \textcolor{preprocessor}{#ifdef CONF\_WILC\_USE\_SPI}
262    \textcolor{comment}{//Read/write command?}
263    \textcolor{keywordflow}{case} \hyperlink{nm__bus__wrapper_8h_a7c9c01416493afd57406928672066506}{NM\_BUS\_IOCTL\_RW}:
264       \textcolor{comment}{//Retrieve command parameters}
265       spiRwParams = (\hyperlink{structtstrNmSpiRw}{tstrNmSpiRw} *) pvParameter;
266       \textcolor{comment}{//Perform SPI transfer}
267       ret = \hyperlink{nm__bus__wrapper__samv71_8c_ae656e55934eaeffc372287189b5e0d5b}{spi\_rw}(spiRwParams->\hyperlink{structtstrNmSpiRw_aa0a0dd7106812c8af780cb0729e2d1ef}{pu8InBuf}, spiRwParams->\hyperlink{structtstrNmSpiRw_a6778f8ba906b9eb363ac0422fca66dd5}{pu8OutBuf}, spiRwParams->
      \hyperlink{structtstrNmSpiRw_a7daa8262b96cb0543eb9189c65622c72}{u16Sz});
268       \textcolor{keywordflow}{break};
269 \textcolor{preprocessor}{#endif}
270    \textcolor{comment}{//Invalid command?}
271    \textcolor{keywordflow}{default}:
272       \textcolor{comment}{//Debug message}
273       \hyperlink{nm__common_8h_a34d005df494e50b05cd38b80f318d7ac}{M2M\_ERR}(\textcolor{stringliteral}{"Invalid IOCTL command!\(\backslash\)r\(\backslash\)n"});
274       \textcolor{comment}{//Report an error}
275       ret = \hyperlink{nm__common_8h_a1337ea19161996276a331dc168c6b24b}{M2M\_ERR\_BUS\_FAIL};
276       \textcolor{keywordflow}{break};
277    \}
278 
279    \textcolor{comment}{//Return status code}
280    \textcolor{keywordflow}{return} ret;
281 \}
\end{DoxyCode}
\mbox{\Hypertarget{nm__bus__wrapper__samv71_8c_ae656e55934eaeffc372287189b5e0d5b}\label{nm__bus__wrapper__samv71_8c_ae656e55934eaeffc372287189b5e0d5b}} 
\index{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}!spi\+\_\+rw@{spi\+\_\+rw}}
\index{spi\+\_\+rw@{spi\+\_\+rw}!nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}}
\subsubsection{\texorpdfstring{spi\+\_\+rw()}{spi\_rw()}}
{\footnotesize\ttfamily static \hyperlink{group__DataT_gae35f10ffd0ac8dd2bc3e794da9bdfbc7}{sint8} spi\+\_\+rw (\begin{DoxyParamCaption}\item[{\hyperlink{group__DataT_ga4df709a77647e870bbf1d955b8edc9a6}{uint8} $\ast$}]{pu8\+Mosi,  }\item[{\hyperlink{group__DataT_ga4df709a77647e870bbf1d955b8edc9a6}{uint8} $\ast$}]{pu8\+Miso,  }\item[{\hyperlink{group__DataT_ga1daa745171fc6e31d942c161422a76f9}{uint16}}]{u16\+Sz }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



S\+PI transfer. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em pu8\+Mosi} & The data to be written to the slave device \\
\hline
\mbox{\tt out}  & {\em pu8\+Miso} & The data received from the slave device \\
\hline
\mbox{\tt in}  & {\em u16\+Sz} & Number of bytes to be transferred \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Status code (M2\+M\+\_\+\+S\+U\+C\+C\+E\+SS or M2\+M\+\_\+\+E\+R\+R\+\_\+\+B\+U\+S\+\_\+\+F\+A\+IL) 
\end{DoxyReturn}


Definition at line 83 of file nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c.


\begin{DoxyCode}
84 \{
85    \textcolor{keyword}{volatile} \hyperlink{group__DataT_ga100e7c691a47d6978527c479a0158245}{uint32} status;
86 
87    \textcolor{comment}{//Pull the CS pin low}
88    CONF\_WILC\_CS\_PIO->PIO\_CODR = CONF\_WILC\_CS\_PIN;
89 
90    \textcolor{comment}{//Copy data to TX buffer}
91    \textcolor{keywordflow}{if}(pu8Mosi != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
92       \hyperlink{nm__common_8h_a62b30b611dfcc58e190254d1f663470a}{m2m\_memcpy}(\hyperlink{wilc1000__driver_8c_aba92300075ca68e5227458fd23a1bb34}{txBuffer}, pu8Mosi, u16Sz);
93    \textcolor{keywordflow}{else}
94       \hyperlink{nm__common_8h_ad4de761e451e6416e7e21d6abc4fb776}{m2m\_memset}(\hyperlink{wilc1000__driver_8c_aba92300075ca68e5227458fd23a1bb34}{txBuffer}, 0, u16Sz);
95 
96    \textcolor{comment}{//Clear pending interrupt status flags by reading the interrupt status}
97    status = XDMAC->XDMAC\_CHID[1].XDMAC\_CIS;
98    \textcolor{comment}{//Set source address}
99    XDMAC->XDMAC\_CHID[1].XDMAC\_CSA = (\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}) \hyperlink{wilc1000__driver_8c_aba92300075ca68e5227458fd23a1bb34}{txBuffer};
100    \textcolor{comment}{//Set destination address}
101    XDMAC->XDMAC\_CHID[1].XDMAC\_CDA = (\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}) &(CONF\_WILC\_SPI->SPI\_TDR);
102    \textcolor{comment}{//Set the number of data to be transferred}
103    XDMAC->XDMAC\_CHID[1].XDMAC\_CUBC = XDMAC\_CUBC\_UBLEN(u16Sz);
104 
105    \textcolor{comment}{//Program configuration register}
106    XDMAC->XDMAC\_CHID[1].XDMAC\_CC =
107       XDMAC\_CC\_TYPE\_PER\_TRAN |      \textcolor{comment}{//Peripheral transfer}
108       XDMAC\_CC\_MBSIZE\_SINGLE |      \textcolor{comment}{//Memory burst size}
109       XDMAC\_CC\_SAM\_INCREMENTED\_AM | \textcolor{comment}{//Source memory addressing scheme}
110       XDMAC\_CC\_DAM\_FIXED\_AM |       \textcolor{comment}{//Destination memory addressing scheme}
111       XDMAC\_CC\_DSYNC\_MEM2PER |      \textcolor{comment}{//Peripheral transfer direction}
112       XDMAC\_CC\_PROT\_SEC |           \textcolor{comment}{//Activate a secure channel}
113       XDMAC\_CC\_CSIZE\_CHK\_1 |        \textcolor{comment}{//Channel chunk size}
114       XDMAC\_CC\_DWIDTH\_BYTE |        \textcolor{comment}{//Transfer data width}
115       XDMAC\_CC\_SIF\_AHB\_IF0 |        \textcolor{comment}{//Master interface used to read data}
116       XDMAC\_CC\_DIF\_AHB\_IF1 |        \textcolor{comment}{//Master interface used to write data}
117       XDMAC\_CC\_PERID(1) |           \textcolor{comment}{//Peripheral identifier}
118       XDMAC\_CC\_SWREQ\_HWR\_CONNECTED;
119 
120    \textcolor{comment}{//Clear the following five registers}
121    XDMAC->XDMAC\_CHID[1].XDMAC\_CNDC = 0;
122    XDMAC->XDMAC\_CHID[1].XDMAC\_CBC = 0;
123    XDMAC->XDMAC\_CHID[1].XDMAC\_CDS\_MSP = 0;
124    XDMAC->XDMAC\_CHID[1].XDMAC\_CSUS = 0;
125    XDMAC->XDMAC\_CHID[1].XDMAC\_CDUS = 0;
126 
127    \textcolor{comment}{//Enable the microblock interrupt}
128    XDMAC->XDMAC\_CHID[1].XDMAC\_CIE = XDMAC\_CIE\_BIE;
129 
130    \textcolor{comment}{//Clear pending interrupt status flags by reading the interrupt status}
131    status = XDMAC->XDMAC\_CHID[2].XDMAC\_CIS;
132    \textcolor{comment}{//Set source address}
133    XDMAC->XDMAC\_CHID[2].XDMAC\_CSA = (\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}) &(CONF\_WILC\_SPI->SPI\_RDR);
134    \textcolor{comment}{//Set destination address}
135    XDMAC->XDMAC\_CHID[2].XDMAC\_CDA = (\hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t}) \hyperlink{wilc1000__driver_8c_a33225839969f0578aae348a4fd62f0f3}{rxBuffer};
136    \textcolor{comment}{//Set the number of data to be transferred}
137    XDMAC->XDMAC\_CHID[2].XDMAC\_CUBC = XDMAC\_CUBC\_UBLEN(u16Sz);
138 
139    \textcolor{comment}{//Program configuration register}
140    XDMAC->XDMAC\_CHID[2].XDMAC\_CC =
141       XDMAC\_CC\_TYPE\_PER\_TRAN |      \textcolor{comment}{//Peripheral transfer}
142       XDMAC\_CC\_MBSIZE\_SINGLE |      \textcolor{comment}{//Memory burst size}
143       XDMAC\_CC\_SAM\_FIXED\_AM |       \textcolor{comment}{//Source memory addressing scheme}
144       XDMAC\_CC\_DAM\_INCREMENTED\_AM | \textcolor{comment}{//Destination memory addressing scheme}
145       XDMAC\_CC\_DSYNC\_PER2MEM |      \textcolor{comment}{//Peripheral transfer direction}
146       XDMAC\_CC\_PROT\_SEC |           \textcolor{comment}{//Activate a secure channel}
147       XDMAC\_CC\_CSIZE\_CHK\_1 |        \textcolor{comment}{//Channel chunk size}
148       XDMAC\_CC\_DWIDTH\_BYTE |        \textcolor{comment}{//Transfer data width}
149       XDMAC\_CC\_SIF\_AHB\_IF1 |        \textcolor{comment}{//Master interface used to read data}
150       XDMAC\_CC\_DIF\_AHB\_IF0 |        \textcolor{comment}{//Master interface used to write data}
151       XDMAC\_CC\_PERID(2) |           \textcolor{comment}{//Channel peripheral identifier}
152       XDMAC\_CC\_SWREQ\_HWR\_CONNECTED;
153 
154    \textcolor{comment}{//Clear the following five registers}
155    XDMAC->XDMAC\_CHID[2].XDMAC\_CNDC = 0;
156    XDMAC->XDMAC\_CHID[2].XDMAC\_CBC = 0;
157    XDMAC->XDMAC\_CHID[2].XDMAC\_CDS\_MSP = 0;
158    XDMAC->XDMAC\_CHID[2].XDMAC\_CSUS = 0;
159    XDMAC->XDMAC\_CHID[2].XDMAC\_CDUS = 0;
160 
161    \textcolor{comment}{//Enable the microblock interrupt}
162    XDMAC->XDMAC\_CHID[2].XDMAC\_CIE = XDMAC\_CIE\_BIE;
163 
164    \textcolor{comment}{//Enable channel 1 and channel 2 interrupt enable bit}
165    XDMAC->XDMAC\_GIE = XDMAC\_GIE\_IE1 | XDMAC\_GIE\_IE2;
166    \textcolor{comment}{//Enable channel 1 (SPI0 TX) and channel 2 (SPI0 RX)}
167    XDMAC->XDMAC\_GE = XDMAC\_GE\_EN1 | XDMAC\_GE\_EN2;
168 
169    \textcolor{comment}{//Wait for the DMA transfer to be complete}
170    \textcolor{keywordflow}{while}(!(XDMAC->XDMAC\_CHID[1].XDMAC\_CIS & XDMAC\_CIS\_BIS));
171    \textcolor{keywordflow}{while}(!(XDMAC->XDMAC\_CHID[2].XDMAC\_CIS & XDMAC\_CIS\_BIS));
172    \textcolor{keywordflow}{while}(!(CONF\_WILC\_SPI->SPI\_SR & SPI\_SR\_TXEMPTY));
173 
174    \textcolor{comment}{//Disable channel 1 and channel 2}
175    XDMAC->XDMAC\_GD = XDMAC\_GD\_DI1 | XDMAC\_GD\_DI2;
176    \textcolor{comment}{//Disable channel 1 and channel 2 interrupts}
177    XDMAC->XDMAC\_GID = XDMAC\_GID\_ID1 | XDMAC\_GID\_ID2;
178 
179    \textcolor{comment}{//Copy data from RX buffer}
180    \textcolor{keywordflow}{if}(pu8Miso != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
181       \hyperlink{nm__common_8h_a62b30b611dfcc58e190254d1f663470a}{m2m\_memcpy}(pu8Miso, \hyperlink{wilc1000__driver_8c_a33225839969f0578aae348a4fd62f0f3}{rxBuffer}, u16Sz);
182 
183    \textcolor{comment}{//Terminate the operation by raising the CS pin}
184    CONF\_WILC\_CS\_PIO->PIO\_SODR = CONF\_WILC\_CS\_PIN;
185 
186    \textcolor{comment}{//Successful operation}
187    \textcolor{keywordflow}{return} \hyperlink{nm__common_8h_a9ef27ba27aafdd1aa3a79d3ba2c36b8f}{M2M\_SUCCESS};
188 \}
\end{DoxyCode}


\subsection{Variable Documentation}
\mbox{\Hypertarget{nm__bus__wrapper__samv71_8c_ae7dfa29166b4111ca6c3e3bab953eb79}\label{nm__bus__wrapper__samv71_8c_ae7dfa29166b4111ca6c3e3bab953eb79}} 
\index{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}!egstr\+Nm\+Bus\+Capabilities@{egstr\+Nm\+Bus\+Capabilities}}
\index{egstr\+Nm\+Bus\+Capabilities@{egstr\+Nm\+Bus\+Capabilities}!nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c@{nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c}}
\subsubsection{\texorpdfstring{egstr\+Nm\+Bus\+Capabilities}{egstrNmBusCapabilities}}
{\footnotesize\ttfamily \hyperlink{structtstrNmBusCapabilities}{tstr\+Nm\+Bus\+Capabilities} egstr\+Nm\+Bus\+Capabilities}

{\bfseries Initial value\+:}
\begin{DoxyCode}
=
\{
   \hyperlink{nm__bus__wrapper__samv71_8c_afbc973888cb214292ecd9094a69adf68}{NM\_BUS\_MAX\_TRX\_SZ}
\}
\end{DoxyCode}


Bus capabilities information. 

$<$ Bus capabilities. This structure must be declared at platform specific bus wrapper 

Definition at line 69 of file nm\+\_\+bus\+\_\+wrapper\+\_\+samv71.\+c.

