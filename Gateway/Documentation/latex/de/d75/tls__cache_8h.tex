\hypertarget{tls__cache_8h}{}\section{cyclone\+\_\+ssl/tls\+\_\+cache.h File Reference}
\label{tls__cache_8h}\index{cyclone\+\_\+ssl/tls\+\_\+cache.\+h@{cyclone\+\_\+ssl/tls\+\_\+cache.\+h}}


Session cache management.  


{\ttfamily \#include \char`\"{}tls.\+h\char`\"{}}\newline
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{structTlsCache}{Tls\+Cache} $\ast$ \hyperlink{tls__cache_8h_a2877ecfdab3423e0cd0aff29d44ae4ce}{tls\+Init\+Cache} (\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t} size)
\begin{DoxyCompactList}\small\item\em Session cache initialization. \end{DoxyCompactList}\item 
\hyperlink{structTlsSessionState}{Tls\+Session\+State} $\ast$ \hyperlink{tls__cache_8h_a1849469bec230442e53f9a6103052edb}{tls\+Find\+Cache} (\hyperlink{structTlsCache}{Tls\+Cache} $\ast$cache, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tls13__misc_8h_a0ee8ac239b5c0b1c94a323be5dd9fb17}{session\+Id}, size\+\_\+t \hyperlink{tls13__misc_8h_a17e3dc94f3cf9dd7c26a411a9db2608d}{session\+Id\+Len})
\begin{DoxyCompactList}\small\item\em Search the session cache for a given session ID. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__cache_8h_a541cae4b88bf90c090e2096004368f75}{tls\+Save\+To\+Cache} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Save current session in cache. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__cache_8h_a7ec82d843e8bef5efc1ace2394b7e6cb}{tls\+Remove\+From\+Cache} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context)
\begin{DoxyCompactList}\small\item\em Remove current session from cache. \end{DoxyCompactList}\item 
void \hyperlink{tls__cache_8h_a36decf51e7152e18383532dda4fa3554}{tls\+Free\+Cache} (\hyperlink{structTlsCache}{Tls\+Cache} $\ast$cache)
\begin{DoxyCompactList}\small\item\em Properly dispose a session cache. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Session cache management. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+S\+SL Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Function Documentation}
\mbox{\Hypertarget{tls__cache_8h_a1849469bec230442e53f9a6103052edb}\label{tls__cache_8h_a1849469bec230442e53f9a6103052edb}} 
\index{tls\+\_\+cache.\+h@{tls\+\_\+cache.\+h}!tls\+Find\+Cache@{tls\+Find\+Cache}}
\index{tls\+Find\+Cache@{tls\+Find\+Cache}!tls\+\_\+cache.\+h@{tls\+\_\+cache.\+h}}
\subsubsection{\texorpdfstring{tls\+Find\+Cache()}{tlsFindCache()}}
{\footnotesize\ttfamily \hyperlink{structTlsSessionState}{Tls\+Session\+State}$\ast$ tls\+Find\+Cache (\begin{DoxyParamCaption}\item[{\hyperlink{structTlsCache}{Tls\+Cache} $\ast$}]{cache,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{session\+Id,  }\item[{size\+\_\+t}]{session\+Id\+Len }\end{DoxyParamCaption})}



Search the session cache for a given session ID. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em cache} & Pointer to the session cache \\
\hline
\mbox{\tt in}  & {\em session\+Id} & Expected session ID \\
\hline
\mbox{\tt in}  & {\em session\+Id\+Len} & Length of the session ID \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
A pointer to the matching session is returned. N\+U\+LL is returned if the specified ID could not be found in the session cache 
\end{DoxyReturn}


Definition at line 97 of file tls\+\_\+cache.\+c.


\begin{DoxyCode}
99 \{
100 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
101    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
102    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
103    \hyperlink{structTlsSessionState}{TlsSessionState} *session;
104 
105    \textcolor{comment}{//Check parameters}
106    \textcolor{keywordflow}{if}(cache == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || \hyperlink{tls_8h_a0ee8ac239b5c0b1c94a323be5dd9fb17}{sessionId} == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} || \hyperlink{tls_8h_a17e3dc94f3cf9dd7c26a411a9db2608d}{sessionIdLen} == 0)
107       \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
108 
109    \textcolor{comment}{//Initialize session state}
110    session = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
111 
112    \textcolor{comment}{//Get current time}
113    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
114 
115    \textcolor{comment}{//Acquire exclusive access to the session cache}
116    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&cache->\hyperlink{structTlsCache_a82f21fcb2f5eb7103c02a6a447082476}{mutex});
117 
118    \textcolor{comment}{//Flush expired entries}
119    \textcolor{keywordflow}{for}(i = 0; i < cache->\hyperlink{structTlsCache_a796ebf2823471af019a1c6a16bb2a505}{size}; i++)
120    \{
121       \textcolor{comment}{//Skip unused entries}
122       \textcolor{keywordflow}{if}(cache->\hyperlink{structTlsCache_adc79fbdfd19c6c9a1fbcf14e23404df5}{sessions}[i].\hyperlink{structTlsSessionState_a679cbf66e41da3f5e6ae7d25c8ef363e}{sessionIdLen} != 0)
123       \{
124          \textcolor{comment}{//Outdated entry?}
125          \textcolor{keywordflow}{if}((time - cache->\hyperlink{structTlsCache_adc79fbdfd19c6c9a1fbcf14e23404df5}{sessions}[i].\hyperlink{structTlsSessionState_a6923caefbda8f5283ff9920459485f0b}{timestamp}) >= 
      \hyperlink{tls_8h_aa0a3061fe9a64323c2e15d743994d5ce}{TLS\_SESSION\_CACHE\_LIFETIME})
126          \{
127             \textcolor{comment}{//This session is no more valid and should be removed from the cache}
128             \hyperlink{tls_8c_a6e78d966a9bcd9eb6210c996389f6551}{tlsFreeSessionState}(&cache->\hyperlink{structTlsCache_adc79fbdfd19c6c9a1fbcf14e23404df5}{sessions}[i]);
129          \}
130       \}
131    \}
132 
133    \textcolor{comment}{//Search the cache for the specified session ID}
134    \textcolor{keywordflow}{for}(i = 0; i < cache->\hyperlink{structTlsCache_a796ebf2823471af019a1c6a16bb2a505}{size}; i++)
135    \{
136       \textcolor{comment}{//Check whether the current identifier matches the specified session ID}
137       \textcolor{keywordflow}{if}(cache->\hyperlink{structTlsCache_adc79fbdfd19c6c9a1fbcf14e23404df5}{sessions}[i].\hyperlink{structTlsSessionState_a679cbf66e41da3f5e6ae7d25c8ef363e}{sessionIdLen} == \hyperlink{tls_8h_a17e3dc94f3cf9dd7c26a411a9db2608d}{sessionIdLen} &&
138          !memcmp(cache->\hyperlink{structTlsCache_adc79fbdfd19c6c9a1fbcf14e23404df5}{sessions}[i].\hyperlink{structTlsSessionState_a784cd9c073b07b51f1cf315e9fb19768}{sessionId}, \hyperlink{tls_8h_a0ee8ac239b5c0b1c94a323be5dd9fb17}{sessionId}, 
      \hyperlink{tls_8h_a17e3dc94f3cf9dd7c26a411a9db2608d}{sessionIdLen}))
139       \{
140          \textcolor{comment}{//A matching session has been found}
141          session = &cache->\hyperlink{structTlsCache_adc79fbdfd19c6c9a1fbcf14e23404df5}{sessions}[i];
142          \textcolor{keywordflow}{break};
143       \}
144    \}
145 
146    \textcolor{comment}{//Release exclusive access to the session cache}
147    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&cache->\hyperlink{structTlsCache_a82f21fcb2f5eb7103c02a6a447082476}{mutex});
148 
149    \textcolor{comment}{//Return a pointer to the matching session, if any}
150    \textcolor{keywordflow}{return} session;
151 \textcolor{preprocessor}{#else}
152    \textcolor{comment}{//Not implemented}
153    \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
154 \textcolor{preprocessor}{#endif}
155 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__cache_8h_a36decf51e7152e18383532dda4fa3554}\label{tls__cache_8h_a36decf51e7152e18383532dda4fa3554}} 
\index{tls\+\_\+cache.\+h@{tls\+\_\+cache.\+h}!tls\+Free\+Cache@{tls\+Free\+Cache}}
\index{tls\+Free\+Cache@{tls\+Free\+Cache}!tls\+\_\+cache.\+h@{tls\+\_\+cache.\+h}}
\subsubsection{\texorpdfstring{tls\+Free\+Cache()}{tlsFreeCache()}}
{\footnotesize\ttfamily void tls\+Free\+Cache (\begin{DoxyParamCaption}\item[{\hyperlink{structTlsCache}{Tls\+Cache} $\ast$}]{cache }\end{DoxyParamCaption})}



Properly dispose a session cache. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em cache} & Pointer to the session cache to be released \\
\hline
\end{DoxyParams}


Definition at line 313 of file tls\+\_\+cache.\+c.


\begin{DoxyCode}
314 \{
315    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
316 
317    \textcolor{comment}{//Valid session cache?}
318    \textcolor{keywordflow}{if}(cache != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
319    \{
320       \textcolor{comment}{//Loop through the session cache}
321       \textcolor{keywordflow}{for}(i = 0; i < cache->\hyperlink{structTlsCache_a796ebf2823471af019a1c6a16bb2a505}{size}; i++)
322       \{
323          \textcolor{comment}{//Release current entry}
324          \hyperlink{tls_8c_a6e78d966a9bcd9eb6210c996389f6551}{tlsFreeSessionState}(&cache->\hyperlink{structTlsCache_adc79fbdfd19c6c9a1fbcf14e23404df5}{sessions}[i]);
325       \}
326 
327       \textcolor{comment}{//Release mutex object}
328       \hyperlink{os__port__chibios_8c_a2b0ba1e39227e4a4d52ee46bbee15c11}{osDeleteMutex}(&cache->\hyperlink{structTlsCache_a82f21fcb2f5eb7103c02a6a447082476}{mutex});
329 
330       \textcolor{comment}{//Properly dispose the session cache}
331       \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(cache);
332    \}
333 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__cache_8h_a2877ecfdab3423e0cd0aff29d44ae4ce}\label{tls__cache_8h_a2877ecfdab3423e0cd0aff29d44ae4ce}} 
\index{tls\+\_\+cache.\+h@{tls\+\_\+cache.\+h}!tls\+Init\+Cache@{tls\+Init\+Cache}}
\index{tls\+Init\+Cache@{tls\+Init\+Cache}!tls\+\_\+cache.\+h@{tls\+\_\+cache.\+h}}
\subsubsection{\texorpdfstring{tls\+Init\+Cache()}{tlsInitCache()}}
{\footnotesize\ttfamily \hyperlink{structTlsCache}{Tls\+Cache}$\ast$ tls\+Init\+Cache (\begin{DoxyParamCaption}\item[{\hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\+\_\+t}}]{size }\end{DoxyParamCaption})}



Session cache initialization. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em size} & Maximum number of cache entries \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Handle referencing the fully initialized session cache 
\end{DoxyReturn}


Definition at line 50 of file tls\+\_\+cache.\+c.


\begin{DoxyCode}
51 \{
52    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
53    \hyperlink{structTlsCache}{TlsCache} *cache;
54 
55    \textcolor{comment}{//Make sure the parameter is acceptable}
56    \textcolor{keywordflow}{if}(size < 1)
57       \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
58 
59    \textcolor{comment}{//Size of the memory required}
60    n = \textcolor{keyword}{sizeof}(\hyperlink{structTlsCache}{TlsCache}) + size * \textcolor{keyword}{sizeof}(\hyperlink{structTlsSessionState}{TlsSessionState});
61 
62    \textcolor{comment}{//Allocate a memory buffer to hold the session cache}
63    cache = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(n);
64    \textcolor{comment}{//Failed to allocate memory?}
65    \textcolor{keywordflow}{if}(cache == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
66       \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
67 
68    \textcolor{comment}{//Clear memory}
69    memset(cache, 0, n);
70 
71    \textcolor{comment}{//Create a mutex to prevent simultaneous access to the cache}
72    \textcolor{keywordflow}{if}(!\hyperlink{os__port__chibios_8c_a16627f901c807c29adf29a38fb1af16a}{osCreateMutex}(&cache->\hyperlink{structTlsCache_a82f21fcb2f5eb7103c02a6a447082476}{mutex}))
73    \{
74       \textcolor{comment}{//Clean up side effects}
75       \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(cache);
76       \textcolor{comment}{//Report an error}
77       \textcolor{keywordflow}{return} \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
78    \}
79 
80    \textcolor{comment}{//Save the maximum number of cache entries}
81    cache->\hyperlink{structTlsCache_a796ebf2823471af019a1c6a16bb2a505}{size} = size;
82 
83    \textcolor{comment}{//Return a pointer to the newly created cache}
84    \textcolor{keywordflow}{return} cache;
85 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__cache_8h_a7ec82d843e8bef5efc1ace2394b7e6cb}\label{tls__cache_8h_a7ec82d843e8bef5efc1ace2394b7e6cb}} 
\index{tls\+\_\+cache.\+h@{tls\+\_\+cache.\+h}!tls\+Remove\+From\+Cache@{tls\+Remove\+From\+Cache}}
\index{tls\+Remove\+From\+Cache@{tls\+Remove\+From\+Cache}!tls\+\_\+cache.\+h@{tls\+\_\+cache.\+h}}
\subsubsection{\texorpdfstring{tls\+Remove\+From\+Cache()}{tlsRemoveFromCache()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Remove\+From\+Cache (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Remove current session from cache. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 263 of file tls\+\_\+cache.\+c.


\begin{DoxyCode}
264 \{
265 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
266    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
267    \hyperlink{structTlsSessionState}{TlsSessionState} *session;
268 
269    \textcolor{comment}{//Check parameters}
270    \textcolor{keywordflow}{if}(context == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
271       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
272 
273    \textcolor{comment}{//Check whether session caching is supported}
274    \textcolor{keywordflow}{if}(context->cache == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
275       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
276 
277    \textcolor{comment}{//Ensure the session ID is valid}
278    \textcolor{keywordflow}{if}(context->sessionIdLen == 0)
279       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
280 
281    \textcolor{comment}{//Acquire exclusive access to the session cache}
282    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&context->cache->mutex);
283 
284    \textcolor{comment}{//Search the cache for the specified session ID}
285    \textcolor{keywordflow}{for}(i = 0; i < context->cache->size; i++)
286    \{
287       \textcolor{comment}{//Point to the current entry}
288       session = &context->cache->sessions[i];
289 
290       \textcolor{comment}{//Check whether the current identifier matches the specified session ID}
291       \textcolor{keywordflow}{if}(session->\hyperlink{structTlsSessionState_a679cbf66e41da3f5e6ae7d25c8ef363e}{sessionIdLen} == context->sessionIdLen &&
292          !memcmp(session->\hyperlink{structTlsSessionState_a784cd9c073b07b51f1cf315e9fb19768}{sessionId}, context->sessionId, session->
      \hyperlink{structTlsSessionState_a679cbf66e41da3f5e6ae7d25c8ef363e}{sessionIdLen}))
293       \{
294          \textcolor{comment}{//Drop current entry}
295          \hyperlink{tls_8c_a6e78d966a9bcd9eb6210c996389f6551}{tlsFreeSessionState}(session);
296       \}
297    \}
298 
299    \textcolor{comment}{//Release exclusive access to the session cache}
300    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&context->cache->mutex);
301 \textcolor{preprocessor}{#endif}
302 
303    \textcolor{comment}{//Successful processing}
304    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
305 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__cache_8h_a541cae4b88bf90c090e2096004368f75}\label{tls__cache_8h_a541cae4b88bf90c090e2096004368f75}} 
\index{tls\+\_\+cache.\+h@{tls\+\_\+cache.\+h}!tls\+Save\+To\+Cache@{tls\+Save\+To\+Cache}}
\index{tls\+Save\+To\+Cache@{tls\+Save\+To\+Cache}!tls\+\_\+cache.\+h@{tls\+\_\+cache.\+h}}
\subsubsection{\texorpdfstring{tls\+Save\+To\+Cache()}{tlsSaveToCache()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Save\+To\+Cache (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context }\end{DoxyParamCaption})}



Save current session in cache. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & T\+LS context \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 164 of file tls\+\_\+cache.\+c.


\begin{DoxyCode}
165 \{
166 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
167    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
168    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
169    \hyperlink{compiler__port_8h_ae3e32a98d431a02106616da3071832dd}{systime\_t} \hyperlink{dhcpv6__common_8h_ae73654f333e4363463ad8c594eca1905}{time};
170    \hyperlink{structTlsSessionState}{TlsSessionState} *session;
171    \hyperlink{structTlsSessionState}{TlsSessionState} *firstFreeEntry;
172    \hyperlink{structTlsSessionState}{TlsSessionState} *oldestEntry;
173 
174    \textcolor{comment}{//Check parameters}
175    \textcolor{keywordflow}{if}(context == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
176       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caeae4b12e06d727d085f75f79a820f2e8}{ERROR\_INVALID\_PARAMETER};
177 
178    \textcolor{comment}{//Check whether session caching is supported}
179    \textcolor{keywordflow}{if}(context->cache == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
180       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
181 
182    \textcolor{comment}{//Ensure the session ID is valid}
183    \textcolor{keywordflow}{if}(context->sessionIdLen == 0)
184       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
185 
186    \textcolor{comment}{//Acquire exclusive access to the session cache}
187    \hyperlink{os__port__chibios_8c_a58485224df4bfa522246d55b35bbd83a}{osAcquireMutex}(&context->cache->mutex);
188 
189    \textcolor{comment}{//Get current time}
190    time = \hyperlink{os__port__chibios_8c_ab66a11272d40a916fa69dd8e4dc443d4}{osGetSystemTime}();
191 
192    \textcolor{comment}{//Keep track of the first free entry}
193    firstFreeEntry = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
194    \textcolor{comment}{//Keep track of the oldest entry}
195    oldestEntry = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
196 
197    \textcolor{comment}{//Search the cache for the specified session ID}
198    \textcolor{keywordflow}{for}(i = 0; i < context->cache->size; i++)
199    \{
200       \textcolor{comment}{//Point to the current entry}
201       session = &context->cache->sessions[i];
202 
203       \textcolor{comment}{//If the session ID already exists, we are done}
204       \textcolor{keywordflow}{if}(session->\hyperlink{structTlsSessionState_a679cbf66e41da3f5e6ae7d25c8ef363e}{sessionIdLen} == context->sessionIdLen &&
205          !memcmp(session->\hyperlink{structTlsSessionState_a784cd9c073b07b51f1cf315e9fb19768}{sessionId}, context->sessionId, session->
      \hyperlink{structTlsSessionState_a679cbf66e41da3f5e6ae7d25c8ef363e}{sessionIdLen}))
206       \{
207          \textcolor{comment}{//Do not write to session cache}
208          firstFreeEntry = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
209          oldestEntry = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
210          \textcolor{comment}{//Exit immediately}
211          \textcolor{keywordflow}{break};
212       \}
213 
214       \textcolor{comment}{//Check whether current entry is free}
215       \textcolor{keywordflow}{if}(session->\hyperlink{structTlsSessionState_a679cbf66e41da3f5e6ae7d25c8ef363e}{sessionIdLen} == 0)
216       \{
217          \textcolor{comment}{//Keep track of the first free entry}
218          \textcolor{keywordflow}{if}(!firstFreeEntry)
219          \{
220             firstFreeEntry = session;
221          \}
222       \}
223       \textcolor{keywordflow}{else}
224       \{
225          \textcolor{comment}{//Keep track of the oldest entry in the table}
226          \textcolor{keywordflow}{if}(oldestEntry == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
227          \{
228             oldestEntry = session;
229          \}
230          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}((time - session->\hyperlink{structTlsSessionState_a6923caefbda8f5283ff9920459485f0b}{timestamp}) > (time - oldestEntry->
      \hyperlink{structTlsSessionState_a6923caefbda8f5283ff9920459485f0b}{timestamp}))
231          \{
232             oldestEntry = session;
233          \}
234       \}
235    \}
236 
237    \textcolor{comment}{//Add current session to cache if necessary}
238    \textcolor{keywordflow}{if}(firstFreeEntry != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
239       error = \hyperlink{tls_8c_a1685cfa2e5cd4b4d9a212201de0336f4}{tlsSaveSessionState}(context, firstFreeEntry);
240    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(oldestEntry != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
241       error = \hyperlink{tls_8c_a1685cfa2e5cd4b4d9a212201de0336f4}{tlsSaveSessionState}(context, oldestEntry);
242    \textcolor{keywordflow}{else}
243       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
244 
245    \textcolor{comment}{//Release exclusive access to the session cache}
246    \hyperlink{os__port__chibios_8c_a8e10e5b2c6d3877b5ba60e375ac45d79}{osReleaseMutex}(&context->cache->mutex);
247 
248    \textcolor{comment}{//Return status code}
249    \textcolor{keywordflow}{return} error;
250 \textcolor{preprocessor}{#else}
251    \textcolor{comment}{//Not implemented}
252    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
253 \textcolor{preprocessor}{#endif}
254 \}
\end{DoxyCode}
