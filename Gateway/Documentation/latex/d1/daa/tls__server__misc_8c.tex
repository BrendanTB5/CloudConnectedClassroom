\hypertarget{tls__server__misc_8c}{}\section{cyclone\+\_\+ssl/tls\+\_\+server\+\_\+misc.c File Reference}
\label{tls__server__misc_8c}\index{cyclone\+\_\+ssl/tls\+\_\+server\+\_\+misc.\+c@{cyclone\+\_\+ssl/tls\+\_\+server\+\_\+misc.\+c}}


Helper functions for T\+LS server.  


{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include \char`\"{}tls.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+cipher\+\_\+suites.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+server.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+server\+\_\+extensions.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+server\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+common.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+extensions.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+certificate.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+signature.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+cache.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+ffdhe.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+record.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}tls\+\_\+misc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}pkix/pem\+\_\+import.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}debug.\+h\char`\"{}}\newline
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{tls__server__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}~\hyperlink{tls__config_8h_afee42a623033dac888291d1993985206}{T\+L\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_aef25ac0a386d26b16921691ef75a97d1}{tls\+Format\+Psk\+Identity\+Hint} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, size\+\_\+t $\ast$written)
\begin{DoxyCompactList}\small\item\em Format P\+SK identity hint. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_a066a88bee17c444813a6b631b1f442cd}{tls\+Format\+Server\+Key\+Params} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, size\+\_\+t $\ast$written)
\begin{DoxyCompactList}\small\item\em Format server\textquotesingle{}s key exchange parameters. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_abf2189814fc56621fbab70c7af9a0ea2}{tls\+Generate\+Server\+Key\+Signature} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{tls_8h_a8e07cba48fef31563460ba8f90ad5f1d}{Tls\+Digital\+Signature} $\ast$\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$params, size\+\_\+t params\+Len, size\+\_\+t $\ast$written)
\begin{DoxyCompactList}\small\item\em Sign server\textquotesingle{}s key exchange parameters (S\+SL 3.\+0, T\+LS 1.\+0 and T\+LS 1.\+1) \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_a1ac1dcf9d144fb9eb54018ac25b22801}{tls12\+Generate\+Server\+Key\+Signature} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{tls_8h_ad6758810e829828a20529e27e0f1fb6a}{Tls12\+Digital\+Signature} $\ast$\hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$params, size\+\_\+t params\+Len, size\+\_\+t $\ast$written)
\begin{DoxyCompactList}\small\item\em Sign server\textquotesingle{}s key exchange parameters (T\+LS 1.\+2) \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_acd0ea01bfbd67e0d7ccbdfc03c595f4f}{tls\+Check\+Signaling\+Cipher\+Suite\+Values} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{Tls\+Cipher\+Suites} $\ast$cipher\+Suites)
\begin{DoxyCompactList}\small\item\em Check whether the Client\+Hello includes any S\+C\+SV cipher suites. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_a5f4a1b96d929e08c6e62fa2f5408a894}{tls\+Resume\+Server\+Session} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{tls13__misc_8h_a0ee8ac239b5c0b1c94a323be5dd9fb17}{session\+Id}, size\+\_\+t \hyperlink{tls13__misc_8h_a17e3dc94f3cf9dd7c26a411a9db2608d}{session\+Id\+Len}, const \hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{Tls\+Cipher\+Suites} $\ast$cipher\+Suites, const \hyperlink{structTlsHelloExtensions}{Tls\+Hello\+Extensions} $\ast$\hyperlink{tls13__misc_8h_a7b8cc84c920376c616d85d575080d28e}{extensions})
\begin{DoxyCompactList}\small\item\em Resume T\+LS session via session ID. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_ad99a99db09cdc1ac0f3cb60f15711035}{tls\+Negotiate\+Version} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t} \hyperlink{tls_8h_a8dbf7ac9449d428ac01b65110fc605b7}{client\+Version}, const \hyperlink{tls_8h_a47fa2b51d8550d068fce6f01a24c03a8}{Tls\+Supported\+Version\+List} $\ast$supported\+Version\+List)
\begin{DoxyCompactList}\small\item\em Version negotiation. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_a634953aa0fd11d11c625673b3edb2456}{tls\+Negotiate\+Cipher\+Suite} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{structHashAlgo}{Hash\+Algo} $\ast$hash\+Algo, const \hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{Tls\+Cipher\+Suites} $\ast$cipher\+Suites, \hyperlink{structTlsHelloExtensions}{Tls\+Hello\+Extensions} $\ast$\hyperlink{tls13__misc_8h_a7b8cc84c920376c616d85d575080d28e}{extensions})
\begin{DoxyCompactList}\small\item\em Cipher suite negotiation. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_a17a35f3a542a6ba200aa77d4ca297224}{tls\+Select\+Group} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{tls_8h_a697f1e9ded788afc0e198e055676b13c}{Tls\+Supported\+Group\+List} $\ast$group\+List)
\begin{DoxyCompactList}\small\item\em Select the group to be used when performing (EC)D\+HE key exchange. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_af8f42eaa6f80e4f5fe5608f79f7719df}{tls\+Select\+Ecdhe\+Group} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{tls_8h_a697f1e9ded788afc0e198e055676b13c}{Tls\+Supported\+Group\+List} $\ast$group\+List)
\begin{DoxyCompactList}\small\item\em Select the named curve to be used when performing E\+C\+D\+HE key exchange. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_a4c3f902c625a88aa8ba5269aff110b6c}{tls\+Select\+Certificate} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{structTlsHelloExtensions}{Tls\+Hello\+Extensions} $\ast$\hyperlink{tls13__misc_8h_a7b8cc84c920376c616d85d575080d28e}{extensions})
\begin{DoxyCompactList}\small\item\em Certificate selection process. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_a7aec22c82399ab4173339771d47ceff7}{tls\+Parse\+Compress\+Methods} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{tls_8h_a73df667e4fbedd6b3dd66620b4d5d018}{Tls\+Compress\+Methods} $\ast$compress\+Methods)
\begin{DoxyCompactList}\small\item\em Parse the list of compression methods supported by the client. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_a83d2e7ba7af8d605e367229331aabbbb}{tls\+Parse\+Psk\+Identity} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, size\+\_\+t $\ast$consumed)
\begin{DoxyCompactList}\small\item\em Parse P\+SK identity. \end{DoxyCompactList}\item 
\hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} \hyperlink{tls__server__misc_8c_aeb2235551aa3828c696652a82ca808b6}{tls\+Parse\+Client\+Key\+Params} (\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$context, const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, size\+\_\+t \hyperlink{ppp_8h_ab2b3adeb2a67e656ff030b56727fd0ac}{length}, size\+\_\+t $\ast$consumed)
\begin{DoxyCompactList}\small\item\em Parse client\textquotesingle{}s key exchange parameters. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Helper functions for T\+LS server. 

\hypertarget{pic32mz__ef__curiosity_8h_License}{}\subsection{License}\label{pic32mz__ef__curiosity_8h_License}
S\+P\+D\+X-\/\+License-\/\+Identifier\+: G\+P\+L-\/2.\+0-\/or-\/later

Copyright (C) 2010-\/2019 Oryx Embedded S\+A\+RL. All rights reserved.

This file is part of Cyclone\+S\+SL Open.

This program is free software; you can redistribute it and/or modify it under the terms of the G\+NU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but W\+I\+T\+H\+O\+UT A\+NY W\+A\+R\+R\+A\+N\+TY; without even the implied warranty of M\+E\+R\+C\+H\+A\+N\+T\+A\+B\+I\+L\+I\+TY or F\+I\+T\+N\+E\+SS F\+OR A P\+A\+R\+T\+I\+C\+U\+L\+AR P\+U\+R\+P\+O\+SE. See the G\+NU General Public License for more details.

You should have received a copy of the G\+NU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-\/1301, U\+SA.

\begin{DoxyAuthor}{Author}
Oryx Embedded S\+A\+RL (www.\+oryx-\/embedded.\+com) 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
1.\+9.\+6 
\end{DoxyVersion}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{tls__server__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}\label{tls__server__misc_8c_afcdf5e66fd927a7f4cc64295acd20407}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}
\index{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL@{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}{TRACE\_LEVEL}}
{\footnotesize\ttfamily \#define T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL~\hyperlink{tls__config_8h_afee42a623033dac888291d1993985206}{T\+L\+S\+\_\+\+T\+R\+A\+C\+E\+\_\+\+L\+E\+V\+EL}}



Definition at line 32 of file tls\+\_\+server\+\_\+misc.\+c.



\subsection{Function Documentation}
\mbox{\Hypertarget{tls__server__misc_8c_a1ac1dcf9d144fb9eb54018ac25b22801}\label{tls__server__misc_8c_a1ac1dcf9d144fb9eb54018ac25b22801}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls12\+Generate\+Server\+Key\+Signature@{tls12\+Generate\+Server\+Key\+Signature}}
\index{tls12\+Generate\+Server\+Key\+Signature@{tls12\+Generate\+Server\+Key\+Signature}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls12\+Generate\+Server\+Key\+Signature()}{tls12GenerateServerKeySignature()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls12\+Generate\+Server\+Key\+Signature (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{tls_8h_ad6758810e829828a20529e27e0f1fb6a}{Tls12\+Digital\+Signature} $\ast$}]{signature,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{params,  }\item[{size\+\_\+t}]{params\+Len,  }\item[{size\+\_\+t $\ast$}]{written }\end{DoxyParamCaption})}



Sign server\textquotesingle{}s key exchange parameters (T\+LS 1.\+2) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em signature} & Output stream where to write the digital signature \\
\hline
\mbox{\tt in}  & {\em params} & Pointer to the server\textquotesingle{}s key exchange parameters \\
\hline
\mbox{\tt in}  & {\em params\+Len} & Length of the server\textquotesingle{}s key exchange parameters \\
\hline
\mbox{\tt out}  & {\em written} & Total number of bytes that have been written \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 532 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
535 \{
536    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
537 
538 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_2 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
539    \textcolor{comment}{//Initialize status code}
540    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
541 
542    \textcolor{comment}{//Total number of bytes that have been written}
543    *written = 0;
544 
545 \textcolor{preprocessor}{#if (TLS\_RSA\_SIGN\_SUPPORT == ENABLED || TLS\_RSA\_PSS\_SIGN\_SUPPORT == ENABLED || \(\backslash\)}
546 \textcolor{preprocessor}{   TLS\_DSA\_SIGN\_SUPPORT == ENABLED || TLS\_ECDSA\_SIGN\_SUPPORT == ENABLED)}
547    \textcolor{comment}{//RSA, DSA or ECDSA signature scheme?}
548    \textcolor{keywordflow}{if}(context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a84a0f0f40c0affb557a7e5f157b4e1f5}{TLS\_SIGN\_ALGO\_RSA} ||
549       context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ae82458ac6b05ba0e3851a5804f7d5e57}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA256} ||
550       context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aef95b8f001c19481fef0409a91b56ce4}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA384} ||
551       context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a53d5e91921faf4103349e699d188ea5f}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA512} ||
552       context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ad23a08f2a2e5d3231cc9c2ce2e223a8d}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA256} ||
553       context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aeb67836989d29de8af7c31ea0ddbe1b7}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA384} ||
554       context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a1f76baf2d64af86ca98e164c9089a77c}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA512} ||
555       context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a8d024e93d33282e5cb2a1665fb69153d}{TLS\_SIGN\_ALGO\_DSA} ||
556       context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a47f4ec2313cd5ce1755fc2485cfdd49a}{TLS\_SIGN\_ALGO\_ECDSA})
557    \{
558       \textcolor{keyword}{const} \hyperlink{structHashAlgo}{HashAlgo} *hashAlgo;
559       \hyperlink{structHashContext}{HashContext} *hashContext;
560 
561       \textcolor{comment}{//Retrieve the hash algorithm used for signing}
562       \textcolor{keywordflow}{if}(context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ae82458ac6b05ba0e3851a5804f7d5e57}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA256} ||
563          context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ad23a08f2a2e5d3231cc9c2ce2e223a8d}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA256})
564       \{
565          \textcolor{comment}{//The hashing is intrinsic to the signature algorithm}
566          hashAlgo = \hyperlink{tls__misc_8c_a0540f6f41d033803f8c6b9f5efe391e8}{tlsGetHashAlgo}(\hyperlink{tls_8h_a98b0299cd7e197edc67123642089156da7912aa0ea6b40af839a3d4be331fe182}{TLS\_HASH\_ALGO\_SHA256});
567       \}
568       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aef95b8f001c19481fef0409a91b56ce4}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA384} ||
569          context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aeb67836989d29de8af7c31ea0ddbe1b7}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA384})
570       \{
571          \textcolor{comment}{//The hashing is intrinsic to the signature algorithm}
572          hashAlgo = \hyperlink{tls__misc_8c_a0540f6f41d033803f8c6b9f5efe391e8}{tlsGetHashAlgo}(\hyperlink{tls_8h_a98b0299cd7e197edc67123642089156da53b125010bbd797aa333a41bd1264edb}{TLS\_HASH\_ALGO\_SHA384});
573       \}
574       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a53d5e91921faf4103349e699d188ea5f}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA512} ||
575          context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a1f76baf2d64af86ca98e164c9089a77c}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA512})
576       \{
577          \textcolor{comment}{//The hashing is intrinsic to the signature algorithm}
578          hashAlgo = \hyperlink{tls__misc_8c_a0540f6f41d033803f8c6b9f5efe391e8}{tlsGetHashAlgo}(\hyperlink{tls_8h_a98b0299cd7e197edc67123642089156da81cc682c95330532471fe9b48fed6acf}{TLS\_HASH\_ALGO\_SHA512});
579       \}
580       \textcolor{keywordflow}{else}
581       \{
582          \textcolor{comment}{//Select the relevant hash algorithm}
583          hashAlgo = \hyperlink{tls__misc_8c_a0540f6f41d033803f8c6b9f5efe391e8}{tlsGetHashAlgo}(context->signHashAlgo);
584       \}
585 
586       \textcolor{comment}{//Make sure the hash algorithm is supported}
587       \textcolor{keywordflow}{if}(hashAlgo != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
588       \{
589          \textcolor{comment}{//Allocate a memory buffer to hold the hash context}
590          hashContext = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(hashAlgo->\hyperlink{structHashAlgo_ad087845190aa4163d8339cacd07fec3e}{contextSize});
591 
592          \textcolor{comment}{//Successful memory allocation?}
593          \textcolor{keywordflow}{if}(hashContext != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
594          \{
595             \textcolor{comment}{//Compute hash(ClientHello.random + ServerHello.random +}
596             \textcolor{comment}{//ServerKeyExchange.params)}
597             hashAlgo->\hyperlink{structHashAlgo_a77dcebcb5fd49cd6672ad6c97b55fdee}{init}(hashContext);
598             hashAlgo->\hyperlink{structHashAlgo_a83df6297595f1b9de65143df15fafda4}{update}(hashContext, context->clientRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
599             hashAlgo->\hyperlink{structHashAlgo_a83df6297595f1b9de65143df15fafda4}{update}(hashContext, context->serverRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
600             hashAlgo->\hyperlink{structHashAlgo_a83df6297595f1b9de65143df15fafda4}{update}(hashContext, params, paramsLen);
601             hashAlgo->\hyperlink{structHashAlgo_a8a1972d608540bbf31e1932f5403f51d}{final}(hashContext, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
602 
603 \textcolor{preprocessor}{#if (TLS\_RSA\_SIGN\_SUPPORT == ENABLED)}
604             \textcolor{comment}{//RSA signature scheme?}
605             \textcolor{keywordflow}{if}(context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a84a0f0f40c0affb557a7e5f157b4e1f5}{TLS\_SIGN\_ALGO\_RSA})
606             \{
607                \hyperlink{structRsaPrivateKey}{RsaPrivateKey} privateKey;
608 
609                \textcolor{comment}{//Initialize RSA private key}
610                \hyperlink{rsa_8c_ad454d9bc34f7d9fa5717180707365e69}{rsaInitPrivateKey}(&privateKey);
611 
612                \textcolor{comment}{//Set the relevant signature algorithm}
613                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a84a0f0f40c0affb557a7e5f157b4e1f5}{TLS\_SIGN\_ALGO\_RSA};
614                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.hash = context->signHashAlgo;
615 
616                \textcolor{comment}{//Decode the PEM structure that holds the RSA private key}
617                error = \hyperlink{certificate_2pem__import_8c_a3d276f00ad49589056269bfe8abbb664}{pemImportRsaPrivateKey}(context->cert->privateKey,
618                   context->cert->privateKeyLen, &privateKey);
619 
620                \textcolor{comment}{//Check status code}
621                \textcolor{keywordflow}{if}(!error)
622                \{
623                   \textcolor{comment}{//Generate RSA signature (RSASSA-PKCS1-v1\_5 signature scheme)}
624                   error = \hyperlink{rsa_8c_aa11231857578f3d094759dd7789015b8}{rsassaPkcs1v15Sign}(&privateKey, hashAlgo,
625                      hashContext->\hyperlink{structHashContext_a846e5b08172b00162569c343caa0eae1}{digest}, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, written);
626                \}
627 
628                \textcolor{comment}{//Release previously allocated resources}
629                \hyperlink{rsa_8c_a14ee0338e3149b934552c40b97c8f096}{rsaFreePrivateKey}(&privateKey);
630             \}
631             \textcolor{keywordflow}{else}
632 \textcolor{preprocessor}{#endif}
633 \textcolor{preprocessor}{#if (TLS\_RSA\_PSS\_SIGN\_SUPPORT == ENABLED)}
634             \textcolor{comment}{//RSA-PSS signature scheme?}
635             \textcolor{keywordflow}{if}(context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ae82458ac6b05ba0e3851a5804f7d5e57}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA256} ||
636                context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aef95b8f001c19481fef0409a91b56ce4}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA384} ||
637                context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a53d5e91921faf4103349e699d188ea5f}{TLS\_SIGN\_ALGO\_RSA\_PSS\_RSAE\_SHA512} ||
638                context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ad23a08f2a2e5d3231cc9c2ce2e223a8d}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA256} ||
639                context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223aeb67836989d29de8af7c31ea0ddbe1b7}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA384} ||
640                context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a1f76baf2d64af86ca98e164c9089a77c}{TLS\_SIGN\_ALGO\_RSA\_PSS\_PSS\_SHA512})
641             \{
642                \hyperlink{structRsaPrivateKey}{RsaPrivateKey} privateKey;
643 
644                \textcolor{comment}{//Initialize RSA private key}
645                \hyperlink{rsa_8c_ad454d9bc34f7d9fa5717180707365e69}{rsaInitPrivateKey}(&privateKey);
646 
647                \textcolor{comment}{//Set the relevant signature algorithm}
648                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature = context->signAlgo;
649                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156dab77721d4496c39c41f5984cfd7515882}{TLS\_HASH\_ALGO\_INTRINSIC};
650 
651                \textcolor{comment}{//Decode the PEM structure that holds the RSA private key}
652                error = \hyperlink{certificate_2pem__import_8c_a3d276f00ad49589056269bfe8abbb664}{pemImportRsaPrivateKey}(context->cert->privateKey,
653                   context->cert->privateKeyLen, &privateKey);
654 
655                \textcolor{comment}{//Check status code}
656                \textcolor{keywordflow}{if}(!error)
657                \{
658                   \textcolor{comment}{//Generate RSA signature (RSASSA-PSS signature scheme)}
659                   error = \hyperlink{rsa_8c_a2bc9405e58c8ce947d411cd9751e96b2}{rsassaPssSign}(context->prngAlgo, context->prngContext,
660                      &privateKey, hashAlgo, hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize},
661                      hashContext->\hyperlink{structHashContext_a846e5b08172b00162569c343caa0eae1}{digest}, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, written);
662                \}
663 
664                \textcolor{comment}{//Release previously allocated resources}
665                \hyperlink{rsa_8c_a14ee0338e3149b934552c40b97c8f096}{rsaFreePrivateKey}(&privateKey);
666             \}
667             \textcolor{keywordflow}{else}
668 \textcolor{preprocessor}{#endif}
669 \textcolor{preprocessor}{#if (TLS\_DSA\_SIGN\_SUPPORT == ENABLED)}
670             \textcolor{comment}{//DSA signature scheme?}
671             \textcolor{keywordflow}{if}(context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a8d024e93d33282e5cb2a1665fb69153d}{TLS\_SIGN\_ALGO\_DSA})
672             \{
673                \textcolor{comment}{//Set the relevant signature algorithm}
674                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a8d024e93d33282e5cb2a1665fb69153d}{TLS\_SIGN\_ALGO\_DSA};
675                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.hash = context->signHashAlgo;
676 
677                \textcolor{comment}{//Sign the key exchange parameters using DSA}
678                error = \hyperlink{tls__signature_8c_a2fb5acdd086627e2071e8ec9118253a8}{tlsGenerateDsaSignature}(context, hashContext->
      \hyperlink{structHashContext_a846e5b08172b00162569c343caa0eae1}{digest},
679                   hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize}, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, written);
680             \}
681             \textcolor{keywordflow}{else}
682 \textcolor{preprocessor}{#endif}
683 \textcolor{preprocessor}{#if (TLS\_ECDSA\_SIGN\_SUPPORT == ENABLED)}
684             \textcolor{comment}{//ECDSA signature scheme?}
685             \textcolor{keywordflow}{if}(context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a47f4ec2313cd5ce1755fc2485cfdd49a}{TLS\_SIGN\_ALGO\_ECDSA})
686             \{
687                \textcolor{comment}{//Set the relevant signature algorithm}
688                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a47f4ec2313cd5ce1755fc2485cfdd49a}{TLS\_SIGN\_ALGO\_ECDSA};
689                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.hash = context->signHashAlgo;
690 
691                \textcolor{comment}{//Sign the key exchange parameters using ECDSA}
692                error = \hyperlink{tls__signature_8c_ac858056ee74a931fb3c0f0ad42120664}{tlsGenerateEcdsaSignature}(context, hashContext->
      \hyperlink{structHashContext_a846e5b08172b00162569c343caa0eae1}{digest},
693                   hashAlgo->\hyperlink{structHashAlgo_a0c8ccdb22ea395ccdd8decd06401d22e}{digestSize}, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, written);
694             \}
695             \textcolor{keywordflow}{else}
696 \textcolor{preprocessor}{#endif}
697             \textcolor{comment}{//Invalid signature scheme?}
698             \{
699                \textcolor{comment}{//Report an error}
700                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4c54d9b14297edac328805943cf95795}{ERROR\_UNSUPPORTED\_SIGNATURE\_ALGO};
701             \}
702 
703             \textcolor{comment}{//Release previously allocated memory}
704             \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(hashContext);
705          \}
706          \textcolor{keywordflow}{else}
707          \{
708             \textcolor{comment}{//Failed to allocate memory}
709             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
710          \}
711       \}
712       \textcolor{keywordflow}{else}
713       \{
714          \textcolor{comment}{//Hash algorithm not supported}
715          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4c54d9b14297edac328805943cf95795}{ERROR\_UNSUPPORTED\_SIGNATURE\_ALGO};
716       \}
717    \}
718    \textcolor{keywordflow}{else}
719 \textcolor{preprocessor}{#endif}
720 \textcolor{preprocessor}{#if (TLS\_EDDSA\_SIGN\_SUPPORT == ENABLED)}
721    \textcolor{comment}{//EdDSA signature scheme?}
722    \textcolor{keywordflow}{if}(context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ae6cdc4f0c6a497d2bd2c5d15412759ef}{TLS\_SIGN\_ALGO\_ED25519} ||
723       context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a6fbbd4136d21496a9053ccca846ecf3f}{TLS\_SIGN\_ALGO\_ED448})
724    \{
725       \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} *buffer;
726 
727       \textcolor{comment}{//A temporary buffer is needed to concatenate ClientHello.random +}
728       \textcolor{comment}{//ServerHello.random + ServerKeyExchange.params}
729       buffer = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(paramsLen + 2 * \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
730 
731       \textcolor{comment}{//Successful memory allocation?}
732       \textcolor{keywordflow}{if}(buffer != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
733       \{
734          \textcolor{comment}{//Data to be verified is run through the EdDSA algorithm with no}
735          \textcolor{comment}{//hashing}
736          memcpy(buffer, context->clientRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
737          memcpy(buffer + 32, context->serverRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
738          memcpy(buffer + 64, params, paramsLen);
739 
740 \textcolor{preprocessor}{#if (TLS\_ED25519\_SUPPORT == ENABLED)}
741          \textcolor{comment}{//Ed25519 signature scheme?}
742          \textcolor{keywordflow}{if}(context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ae6cdc4f0c6a497d2bd2c5d15412759ef}{TLS\_SIGN\_ALGO\_ED25519})
743          \{
744             \textcolor{comment}{//The hashing is intrinsic to the signature algorithm}
745             \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223ae6cdc4f0c6a497d2bd2c5d15412759ef}{TLS\_SIGN\_ALGO\_ED25519};
746             \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156dab77721d4496c39c41f5984cfd7515882}{TLS\_HASH\_ALGO\_INTRINSIC};
747 
748             \textcolor{comment}{//Sign the key exchange parameters using EdDSA}
749             error = \hyperlink{tls__signature_8c_a8fcd4df412699843f8b084729fbbb250}{tlsGenerateEddsaSignature}(context, buffer, paramsLen + 64,
750                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, written);
751          \}
752          \textcolor{keywordflow}{else}
753 \textcolor{preprocessor}{#endif}
754 \textcolor{preprocessor}{#if (TLS\_ED448\_SUPPORT == ENABLED)}
755          \textcolor{comment}{//Ed448 signature scheme?}
756          \textcolor{keywordflow}{if}(context->signAlgo == \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a6fbbd4136d21496a9053ccca846ecf3f}{TLS\_SIGN\_ALGO\_ED448})
757          \{
758             \textcolor{comment}{//The hashing is intrinsic to the signature algorithm}
759             \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.signature = \hyperlink{tls_8h_abe6ce436cb0d777df29e0af7bf800223a6fbbd4136d21496a9053ccca846ecf3f}{TLS\_SIGN\_ALGO\_ED448};
760             \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->algorithm.hash = \hyperlink{tls_8h_a98b0299cd7e197edc67123642089156dab77721d4496c39c41f5984cfd7515882}{TLS\_HASH\_ALGO\_INTRINSIC};
761 
762             \textcolor{comment}{//Sign the key exchange parameters using EdDSA}
763             error = \hyperlink{tls__signature_8c_a8fcd4df412699843f8b084729fbbb250}{tlsGenerateEddsaSignature}(context, buffer, paramsLen + 64,
764                \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, written);
765          \}
766          \textcolor{keywordflow}{else}
767 \textcolor{preprocessor}{#endif}
768          \textcolor{comment}{//Invalid signature scheme?}
769          \{
770             \textcolor{comment}{//Report an error}
771             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4c54d9b14297edac328805943cf95795}{ERROR\_UNSUPPORTED\_SIGNATURE\_ALGO};
772          \}
773 
774          \textcolor{comment}{//Release previously allocated memory}
775          \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(buffer);
776       \}
777       \textcolor{keywordflow}{else}
778       \{
779          \textcolor{comment}{//Failed to allocate memory}
780          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
781       \}
782    \}
783    \textcolor{keywordflow}{else}
784 \textcolor{preprocessor}{#endif}
785    \textcolor{comment}{//Invalid signature scheme?}
786    \{
787       \textcolor{comment}{//Report an error}
788       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4c54d9b14297edac328805943cf95795}{ERROR\_UNSUPPORTED\_SIGNATURE\_ALGO};
789    \}
790 
791    \textcolor{comment}{//Check status code}
792    \textcolor{keywordflow}{if}(!error)
793    \{
794       \textcolor{comment}{//Fix the length of the digitally-signed element}
795       \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(*written);
796       \textcolor{comment}{//Adjust the length of the message}
797       *written += \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_ad6758810e829828a20529e27e0f1fb6a}{Tls12DigitalSignature});
798    \}
799 \textcolor{preprocessor}{#else}
800    \textcolor{comment}{//Not implemented}
801    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
802 \textcolor{preprocessor}{#endif}
803 
804    \textcolor{comment}{//Return status code}
805    \textcolor{keywordflow}{return} error;
806 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_acd0ea01bfbd67e0d7ccbdfc03c595f4f}\label{tls__server__misc_8c_acd0ea01bfbd67e0d7ccbdfc03c595f4f}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Check\+Signaling\+Cipher\+Suite\+Values@{tls\+Check\+Signaling\+Cipher\+Suite\+Values}}
\index{tls\+Check\+Signaling\+Cipher\+Suite\+Values@{tls\+Check\+Signaling\+Cipher\+Suite\+Values}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Check\+Signaling\+Cipher\+Suite\+Values()}{tlsCheckSignalingCipherSuiteValues()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Check\+Signaling\+Cipher\+Suite\+Values (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{Tls\+Cipher\+Suites} $\ast$}]{cipher\+Suites }\end{DoxyParamCaption})}



Check whether the Client\+Hello includes any S\+C\+SV cipher suites. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em cipher\+Suites} & List of cipher suites offered by the client \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 816 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
818 \{
819    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
820    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
821    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
822    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_a68eac05091e706580bce356bdae41075}{serverVersion};
823 
824    \textcolor{comment}{//Initialize status code}
825    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
826 
827    \textcolor{comment}{//Get the highest version supported by the implementation (legacy version)}
828    serverVersion = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(context->versionMax, \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2});
829 
830 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
831    \textcolor{comment}{//DTLS protocol?}
832    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
833    \{
834       \textcolor{comment}{//Translate TLS version into DTLS version}
835       serverVersion = \hyperlink{dtls__misc_8c_a309abf8d9966cd0d5a28be1d94859970}{dtlsTranslateVersion}(serverVersion);
836    \}
837 \textcolor{preprocessor}{#endif}
838 
839    \textcolor{comment}{//Get the number of cipher suite identifiers present in the list}
840    n = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->length) / 2;
841 
842    \textcolor{comment}{//Debug message}
843    \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Cipher suites:\(\backslash\)r\(\backslash\)n"});
844 
845    \textcolor{comment}{//Loop through the list of cipher suite identifiers}
846    \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}; i++)
847    \{
848       \textcolor{comment}{//Debug message}
849       \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  0x%04"} PRIX16 \textcolor{stringliteral}{" (%s)\(\backslash\)r\(\backslash\)n"}, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->value[i]),
850          \hyperlink{tls__cipher__suites_8c_a018dae46ac8e4443b69ed34bf3ea69c8}{tlsGetCipherSuiteName}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->value[i])));
851 
852 \textcolor{preprocessor}{#if (TLS\_SECURE\_RENEGOTIATION\_SUPPORT == ENABLED)}
853       \textcolor{comment}{//TLS\_EMPTY\_RENEGOTIATION\_INFO\_SCSV signaling cipher suite?}
854       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->value[i]) == \hyperlink{tls__cipher__suites_8h_af773ba8ae18d635fc9126e7f03290114aaa0adb3a743b6a7809400c6b52d7e694}{TLS\_EMPTY\_RENEGOTIATION\_INFO\_SCSV}
      )
855       \{
856          \textcolor{comment}{//Initial handshake?}
857          \textcolor{keywordflow}{if}(context->clientVerifyDataLen == 0)
858          \{
859             \textcolor{comment}{//Set the secure\_renegotiation flag to TRUE}
860             context->secureRenegoFlag = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
861          \}
862          \textcolor{comment}{//Secure renegotiation?}
863          \textcolor{keywordflow}{else}
864          \{
865             \textcolor{comment}{//When a ClientHello is received, the server must verify that it}
866             \textcolor{comment}{//does not contain the TLS\_EMPTY\_RENEGOTIATION\_INFO\_SCSV SCSV. If}
867             \textcolor{comment}{//the SCSV is present, the server must abort the handshake}
868             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca70d82df53df56c9d4a943d5539ccc4bc}{ERROR\_HANDSHAKE\_FAILED};
869             \textcolor{keywordflow}{break};
870          \}
871       \}
872       \textcolor{keywordflow}{else}
873 \textcolor{preprocessor}{#endif}
874       \textcolor{comment}{//TLS\_FALLBACK\_SCSV signaling cipher suite?}
875       \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->value[i]) == \hyperlink{tls__cipher__suites_8h_af773ba8ae18d635fc9126e7f03290114a77d1bafacfe09bf4f94d004785db9c13}{TLS\_FALLBACK\_SCSV})
876       \{
877 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
878          \textcolor{comment}{//DTLS protocol?}
879          \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
880          \{
881             \textcolor{comment}{//Test if the highest protocol version supported by the server is}
882             \textcolor{comment}{//higher than the version indicated by the client}
883             \textcolor{keywordflow}{if}(serverVersion < context->\hyperlink{tls_8h_a8dbf7ac9449d428ac01b65110fc605b7}{clientVersion})
884             \{
885                \textcolor{comment}{//The server must respond with a fatal inappropriate\_fallback alert}
886                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca425a82f41b6a546698868167c341ef1c}{ERROR\_INAPPROPRIATE\_FALLBACK};
887                \textcolor{keywordflow}{break};
888             \}
889          \}
890          \textcolor{keywordflow}{else}
891 \textcolor{preprocessor}{#endif}
892          \textcolor{comment}{//TLS protocol?}
893          \{
894             \textcolor{comment}{//Test if the highest protocol version supported by the server is}
895             \textcolor{comment}{//higher than the version indicated by the client}
896             \textcolor{keywordflow}{if}(serverVersion > context->clientVersion)
897             \{
898                \textcolor{comment}{//The server must respond with a fatal inappropriate\_fallback alert}
899                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca425a82f41b6a546698868167c341ef1c}{ERROR\_INAPPROPRIATE\_FALLBACK};
900                \textcolor{keywordflow}{break};
901             \}
902          \}
903       \}
904    \}
905 
906    \textcolor{comment}{//Return status code}
907    \textcolor{keywordflow}{return} error;
908 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_aef25ac0a386d26b16921691ef75a97d1}\label{tls__server__misc_8c_aef25ac0a386d26b16921691ef75a97d1}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Format\+Psk\+Identity\+Hint@{tls\+Format\+Psk\+Identity\+Hint}}
\index{tls\+Format\+Psk\+Identity\+Hint@{tls\+Format\+Psk\+Identity\+Hint}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Format\+Psk\+Identity\+Hint()}{tlsFormatPskIdentityHint()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Format\+Psk\+Identity\+Hint (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{p,  }\item[{size\+\_\+t $\ast$}]{written }\end{DoxyParamCaption})}



Format P\+SK identity hint. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em p} & Output stream where to write the P\+SK identity hint \\
\hline
\mbox{\tt out}  & {\em written} & Total number of bytes that have been written \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 64 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
66 \{
67    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
68    \hyperlink{tls_8h_a500029728daf114a406e8dd63647db6f}{TlsPskIdentityHint} *pskIdentityHint;
69 
70    \textcolor{comment}{//Point to the PSK identity hint}
71    pskIdentityHint = (\hyperlink{tls_8h_a500029728daf114a406e8dd63647db6f}{TlsPskIdentityHint} *) \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
72 
73 \textcolor{preprocessor}{#if (TLS\_PSK\_KE\_SUPPORT == ENABLED || TLS\_RSA\_PSK\_KE\_SUPPORT == ENABLED || \(\backslash\)}
74 \textcolor{preprocessor}{   TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
75    \textcolor{comment}{//Any PSK identity hint defined?}
76    \textcolor{keywordflow}{if}(context->pskIdentityHint != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
77    \{
78       \textcolor{comment}{//Determine the length of the PSK identity hint}
79       n = strlen(context->pskIdentityHint);
80       \textcolor{comment}{//Copy PSK identity hint}
81       memcpy(pskIdentityHint->value, context->pskIdentityHint, n);
82    \}
83    \textcolor{keywordflow}{else}
84 \textcolor{preprocessor}{#endif}
85    \{
86       \textcolor{comment}{//No PSK identity hint is provided}
87       n = 0;
88    \}
89 
90    \textcolor{comment}{//The PSK identity hint is preceded by a 2-byte length field}
91    pskIdentityHint->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(n);
92 
93    \textcolor{comment}{//Total number of bytes that have been written}
94    *written = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a500029728daf114a406e8dd63647db6f}{TlsPskIdentityHint}) + n;
95 
96    \textcolor{comment}{//Successful processing}
97    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
98 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_a066a88bee17c444813a6b631b1f442cd}\label{tls__server__misc_8c_a066a88bee17c444813a6b631b1f442cd}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Format\+Server\+Key\+Params@{tls\+Format\+Server\+Key\+Params}}
\index{tls\+Format\+Server\+Key\+Params@{tls\+Format\+Server\+Key\+Params}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Format\+Server\+Key\+Params()}{tlsFormatServerKeyParams()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Format\+Server\+Key\+Params (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{p,  }\item[{size\+\_\+t $\ast$}]{written }\end{DoxyParamCaption})}



Format server\textquotesingle{}s key exchange parameters. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em p} & Output stream where to write the server\textquotesingle{}s key exchange parameters \\
\hline
\mbox{\tt out}  & {\em written} & Total number of bytes that have been written \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 109 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
111 \{
112    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
113 
114 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
115    \textcolor{comment}{//Initialize status code}
116    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
117 
118    \textcolor{comment}{//Total number of bytes that have been written}
119    *written = 0;
120 
121 \textcolor{preprocessor}{#if (TLS\_DH\_ANON\_KE\_SUPPORT == ENABLED || TLS\_DHE\_RSA\_KE\_SUPPORT == ENABLED || \(\backslash\)}
122 \textcolor{preprocessor}{   TLS\_DHE\_DSS\_KE\_SUPPORT == ENABLED || TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED)}
123    \textcolor{comment}{//Diffie-Hellman key exchange method?}
124    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a33535bd987c46f1ba621d6e28b0b3bfa}{TLS\_KEY\_EXCH\_DH\_ANON} ||
125       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01660ec1808dd6a8b5250b16d81502e4}{TLS\_KEY\_EXCH\_DHE\_RSA} ||
126       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ac256323d1e243a2e7a435abce34dbd39}{TLS\_KEY\_EXCH\_DHE\_DSS} ||
127       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a32a252b7c7befeccaa088290d6a71dfe}{TLS\_KEY\_EXCH\_DHE\_PSK})
128    \{
129       \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
130 
131 \textcolor{preprocessor}{#if (TLS\_FFDHE\_SUPPORT == ENABLED)}
132       \textcolor{keyword}{const} \hyperlink{structTlsFfdheGroup}{TlsFfdheGroup} *ffdheGroup;
133 
134       \textcolor{comment}{//Get the FFDHE parameters that match the specified named group}
135       ffdheGroup = \hyperlink{tls__ffdhe_8c_a60d7cd3aa7ab8be3a85c776c161b3853}{tlsGetFfdheGroup}(context, context->namedGroup);
136 
137       \textcolor{comment}{//Valid FFDHE group?}
138       \textcolor{keywordflow}{if}(ffdheGroup != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
139       \{
140          \textcolor{comment}{//Load FFDHE parameters}
141          error = \hyperlink{tls__ffdhe_8c_af64246340bf23c196ad3573ee15ecfba}{tlsLoadFfdheParameters}(&context->dhContext.params, ffdheGroup);
142       \}
143 \textcolor{preprocessor}{#endif}
144 
145       \textcolor{comment}{//Check status code}
146       \textcolor{keywordflow}{if}(!error)
147       \{
148          \textcolor{comment}{//Generate an ephemeral key pair}
149          error = \hyperlink{dh_8c_a42364e9c726b1223c227ed4722d02395}{dhGenerateKeyPair}(&context->dhContext, context->prngAlgo,
150             context->prngContext);
151       \}
152 
153       \textcolor{comment}{//Check status code}
154       \textcolor{keywordflow}{if}(!error)
155       \{
156          \textcolor{comment}{//Debug message}
157          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"Diffie-Hellman parameters:\(\backslash\)r\(\backslash\)n"});
158          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Prime modulus:\(\backslash\)r\(\backslash\)n"});
159          \hyperlink{debug_8h_a9c9f3b28f2daf14d77b401512c189d93}{TRACE\_DEBUG\_MPI}(\textcolor{stringliteral}{"    "}, &context->dhContext.params.p);
160          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Generator:\(\backslash\)r\(\backslash\)n"});
161          \hyperlink{debug_8h_a9c9f3b28f2daf14d77b401512c189d93}{TRACE\_DEBUG\_MPI}(\textcolor{stringliteral}{"    "}, &context->dhContext.params.g);
162          \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Server public value:\(\backslash\)r\(\backslash\)n"});
163          \hyperlink{debug_8h_a9c9f3b28f2daf14d77b401512c189d93}{TRACE\_DEBUG\_MPI}(\textcolor{stringliteral}{"    "}, &context->dhContext.ya);
164 
165          \textcolor{comment}{//Encode the prime modulus to an opaque vector}
166          error = \hyperlink{tls__misc_8c_acdc0bb8b49d6c596ba176a5757b0fc7e}{tlsWriteMpi}(&context->dhContext.params.p, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, &n);
167       \}
168 
169       \textcolor{comment}{//Check status code}
170       \textcolor{keywordflow}{if}(!error)
171       \{
172          \textcolor{comment}{//Advance data pointer}
173          \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
174          \textcolor{comment}{//Total number of bytes that have been written}
175          *written += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
176 
177          \textcolor{comment}{//Encode the generator to an opaque vector}
178          error = \hyperlink{tls__misc_8c_acdc0bb8b49d6c596ba176a5757b0fc7e}{tlsWriteMpi}(&context->dhContext.params.g, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, &n);
179       \}
180 
181       \textcolor{comment}{//Check status code}
182       \textcolor{keywordflow}{if}(!error)
183       \{
184          \textcolor{comment}{//Advance data pointer}
185          \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
186          \textcolor{comment}{//Total number of bytes that have been written}
187          *written += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
188 
189          \textcolor{comment}{//Encode the server's public value to an opaque vector}
190          error = \hyperlink{tls__misc_8c_acdc0bb8b49d6c596ba176a5757b0fc7e}{tlsWriteMpi}(&context->dhContext.ya, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, &n);
191       \}
192 
193       \textcolor{comment}{//Check status code}
194       \textcolor{keywordflow}{if}(!error)
195       \{
196          \textcolor{comment}{//Advance data pointer}
197          \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
198          \textcolor{comment}{//Adjust the length of the key exchange parameters}
199          *written += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
200       \}
201    \}
202    \textcolor{keywordflow}{else}
203 \textcolor{preprocessor}{#endif}
204 \textcolor{preprocessor}{#if (TLS\_ECDH\_ANON\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_RSA\_KE\_SUPPORT == ENABLED || \(\backslash\)}
205 \textcolor{preprocessor}{   TLS\_ECDHE\_ECDSA\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
206    \textcolor{comment}{//ECDH key exchange method?}
207    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a895e0af86b29640264f699235be22953}{TLS\_KEY\_EXCH\_ECDH\_ANON} ||
208       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ad9ebbdd436027753829ea5b6cd4b810b}{TLS\_KEY\_EXCH\_ECDHE\_RSA} ||
209       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a14c521a28278eecd181953c37b784cb7}{TLS\_KEY\_EXCH\_ECDHE\_ECDSA} ||
210       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aebba2060dba7ad92238668218f3a6520}{TLS\_KEY\_EXCH\_ECDHE\_PSK})
211    \{
212       \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
213       \textcolor{keyword}{const} \hyperlink{structEcCurveInfo}{EcCurveInfo} *curveInfo;
214 
215       \textcolor{comment}{//Retrieve the elliptic curve to be used}
216       curveInfo = \hyperlink{tls__misc_8c_a1d99ba7208ae993d388e7849fa5dce71}{tlsGetCurveInfo}(context, context->namedGroup);
217 
218       \textcolor{comment}{//Make sure the elliptic curve is supported}
219       \textcolor{keywordflow}{if}(curveInfo != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
220       \{
221          \textcolor{comment}{//Load EC domain parameters}
222          error = \hyperlink{ec_8c_ab3d7ebcb8fd2e79990ef25e39a68f4a5}{ecLoadDomainParameters}(&context->ecdhContext.params,
223             curveInfo);
224 
225          \textcolor{comment}{//Check status code}
226          \textcolor{keywordflow}{if}(!error)
227          \{
228 \textcolor{preprocessor}{#if (TLS\_ECC\_CALLBACK\_SUPPORT == ENABLED)}
229             \textcolor{comment}{//Any registered callback?}
230             \textcolor{keywordflow}{if}(context->ecdhCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
231             \{
232                \textcolor{comment}{//Invoke user callback function}
233                error = context->ecdhCallback(context);
234             \}
235             \textcolor{keywordflow}{else}
236 \textcolor{preprocessor}{#endif}
237             \{
238                \textcolor{comment}{//No callback function defined}
239                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caae7cba11578605e61d5137cea3752cb9}{ERROR\_UNSUPPORTED\_ELLIPTIC\_CURVE};
240             \}
241 
242             \textcolor{comment}{//Check status code}
243             \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caae7cba11578605e61d5137cea3752cb9}{ERROR\_UNSUPPORTED\_ELLIPTIC\_CURVE})
244             \{
245                \textcolor{comment}{//Generate an ephemeral key pair}
246                error = \hyperlink{ecdh_8c_a84bbbc2b2072c6e845457f4a58602889}{ecdhGenerateKeyPair}(&context->ecdhContext,
247                   context->prngAlgo, context->prngContext);
248             \}
249          \}
250 
251          \textcolor{comment}{//Check status code}
252          \textcolor{keywordflow}{if}(!error)
253          \{
254             \textcolor{comment}{//Debug message}
255             \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Server public key X:\(\backslash\)r\(\backslash\)n"});
256             \hyperlink{debug_8h_a9c9f3b28f2daf14d77b401512c189d93}{TRACE\_DEBUG\_MPI}(\textcolor{stringliteral}{"    "}, &context->ecdhContext.qa.x);
257             \hyperlink{debug_8h_a67a8f9bc74358aa21745a76e23768dae}{TRACE\_DEBUG}(\textcolor{stringliteral}{"  Server public key Y:\(\backslash\)r\(\backslash\)n"});
258             \hyperlink{debug_8h_a9c9f3b28f2daf14d77b401512c189d93}{TRACE\_DEBUG\_MPI}(\textcolor{stringliteral}{"    "}, &context->ecdhContext.qa.y);
259 
260             \textcolor{comment}{//Set the type of the elliptic curve domain parameters}
261             *\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} = \hyperlink{tls_8h_af3e9b2155b087b33547c1f5fa5f953b2a715a05524ba4c8c38b3c72d04fc27466}{TLS\_EC\_CURVE\_TYPE\_NAMED\_CURVE};
262 
263             \textcolor{comment}{//Advance data pointer}
264             \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} += \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t});
265             \textcolor{comment}{//Total number of bytes that have been written}
266             *written += \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t});
267 
268             \textcolor{comment}{//Write elliptic curve identifier}
269             \hyperlink{cpu__endian_8h_a8e657bcdf3842380d2d0006859029240}{STORE16BE}(context->namedGroup, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p});
270 
271             \textcolor{comment}{//Advance data pointer}
272             \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} += \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t});
273             \textcolor{comment}{//Total number of bytes that have been written}
274             *written += \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t});
275 
276             \textcolor{comment}{//Write server's public key}
277             error = \hyperlink{tls__misc_8c_ae1d6ad23621c58ee4fe6954521e1cb34}{tlsWriteEcPoint}(&context->ecdhContext.params,
278                &context->ecdhContext.qa, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, &n);
279          \}
280 
281          \textcolor{comment}{//Check status code}
282          \textcolor{keywordflow}{if}(!error)
283          \{
284             \textcolor{comment}{//Advance data pointer}
285             \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} +=\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
286             \textcolor{comment}{//Total number of bytes that have been written}
287             *written += \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
288          \}
289       \}
290       \textcolor{keywordflow}{else}
291       \{
292          \textcolor{comment}{//The specified elliptic curve is not supported}
293          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
294       \}
295    \}
296    \textcolor{keywordflow}{else}
297 \textcolor{preprocessor}{#endif}
298    \textcolor{comment}{//Any other exchange method?}
299    \{
300       \textcolor{comment}{//It is not legal to send the ServerKeyExchange message when a key}
301       \textcolor{comment}{//exchange method other than DHE\_DSS, DHE\_RSA, DH\_anon, ECDHE\_RSA,}
302       \textcolor{comment}{//ECDHE\_ECDSA or ECDH\_anon is selected}
303       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cae9be6449970fca5714ab9957b16562a5}{ERROR\_FAILURE};
304    \}
305 \textcolor{preprocessor}{#else}
306    \textcolor{comment}{//Not implemented}
307    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
308 \textcolor{preprocessor}{#endif}
309 
310    \textcolor{comment}{//Return status code}
311    \textcolor{keywordflow}{return} error;
312 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_abf2189814fc56621fbab70c7af9a0ea2}\label{tls__server__misc_8c_abf2189814fc56621fbab70c7af9a0ea2}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Generate\+Server\+Key\+Signature@{tls\+Generate\+Server\+Key\+Signature}}
\index{tls\+Generate\+Server\+Key\+Signature@{tls\+Generate\+Server\+Key\+Signature}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Generate\+Server\+Key\+Signature()}{tlsGenerateServerKeySignature()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Generate\+Server\+Key\+Signature (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{tls_8h_a8e07cba48fef31563460ba8f90ad5f1d}{Tls\+Digital\+Signature} $\ast$}]{signature,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{params,  }\item[{size\+\_\+t}]{params\+Len,  }\item[{size\+\_\+t $\ast$}]{written }\end{DoxyParamCaption})}



Sign server\textquotesingle{}s key exchange parameters (S\+SL 3.\+0, T\+LS 1.\+0 and T\+LS 1.\+1) 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em signature} & Output stream where to write the digital signature \\
\hline
\mbox{\tt in}  & {\em params} & Pointer to the server\textquotesingle{}s key exchange parameters \\
\hline
\mbox{\tt in}  & {\em params\+Len} & Length of the server\textquotesingle{}s key exchange parameters \\
\hline
\mbox{\tt out}  & {\em written} & Total number of bytes that have been written \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 325 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
328 \{
329    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
330 
331 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_1)}
332    \textcolor{comment}{//Initialize status code}
333    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
334 
335    \textcolor{comment}{//Total number of bytes that have been written}
336    *written = 0;
337 
338 \textcolor{preprocessor}{#if (TLS\_RSA\_SIGN\_SUPPORT == ENABLED)}
339    \textcolor{comment}{//RSA certificate?}
340    \textcolor{keywordflow}{if}(context->cert->type == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda3a76023fc80c787bffed357a4560351b}{TLS\_CERT\_RSA\_SIGN})
341    \{
342       \hyperlink{structMd5Context}{Md5Context} *md5Context;
343       \hyperlink{structSha1Context}{Sha1Context} *sha1Context;
344       \hyperlink{structRsaPrivateKey}{RsaPrivateKey} privateKey;
345 
346       \textcolor{comment}{//Initialize RSA private key}
347       \hyperlink{rsa_8c_ad454d9bc34f7d9fa5717180707365e69}{rsaInitPrivateKey}(&privateKey);
348 
349       \textcolor{comment}{//Allocate a memory buffer to hold the MD5 context}
350       md5Context = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structMd5Context}{Md5Context}));
351 
352       \textcolor{comment}{//Successful memory allocation?}
353       \textcolor{keywordflow}{if}(md5Context != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
354       \{
355          \textcolor{comment}{//Compute MD5(ClientHello.random + ServerHello.random +}
356          \textcolor{comment}{//ServerKeyExchange.params)}
357          \hyperlink{md5_8c_acc37d4333236797f144067f5c39f345e}{md5Init}(md5Context);
358          \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, context->clientRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
359          \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, context->serverRandom, \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
360          \hyperlink{md5_8c_aa396f66cc4a5275f4b610551602df8ff}{md5Update}(md5Context, params, paramsLen);
361          \hyperlink{md5_8c_add832f9f73d9df95f48bed551122df55}{md5Final}(md5Context, context->serverVerifyData);
362 
363          \textcolor{comment}{//Release previously allocated memory}
364          \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(md5Context);
365       \}
366       \textcolor{keywordflow}{else}
367       \{
368          \textcolor{comment}{//Failed to allocate memory}
369          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
370       \}
371 
372       \textcolor{comment}{//Check status code}
373       \textcolor{keywordflow}{if}(!error)
374       \{
375          \textcolor{comment}{//Allocate a memory buffer to hold the SHA-1 context}
376          sha1Context = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structSha1Context}{Sha1Context}));
377 
378          \textcolor{comment}{//Successful memory allocation?}
379          \textcolor{keywordflow}{if}(sha1Context != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
380          \{
381             \textcolor{comment}{//Compute SHA(ClientHello.random + ServerHello.random +}
382             \textcolor{comment}{//ServerKeyExchange.params)}
383             \hyperlink{sha1_8c_ab734cb0e0b67798f5cce1f34419982a3}{sha1Init}(sha1Context);
384             \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, context->clientRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
385             \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, context->serverRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
386             \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, params, paramsLen);
387             \hyperlink{sha1_8c_a7b7d2f57b504df6ed98c27d21c1d7a14}{sha1Final}(sha1Context, context->serverVerifyData + 
      \hyperlink{md5_8h_ad86b38d6ab14e243543904e30f26bed2}{MD5\_DIGEST\_SIZE});
388 
389             \textcolor{comment}{//Release previously allocated memory}
390             \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(sha1Context);
391          \}
392          \textcolor{keywordflow}{else}
393          \{
394             \textcolor{comment}{//Failed to allocate memory}
395             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
396          \}
397       \}
398 
399       \textcolor{comment}{//Check status code}
400       \textcolor{keywordflow}{if}(!error)
401       \{
402          \textcolor{comment}{//Decode the PEM structure that holds the RSA private key}
403          error = \hyperlink{certificate_2pem__import_8c_a3d276f00ad49589056269bfe8abbb664}{pemImportRsaPrivateKey}(context->cert->privateKey,
404             context->cert->privateKeyLen, &privateKey);
405       \}
406 
407       \textcolor{comment}{//Check status code}
408       \textcolor{keywordflow}{if}(!error)
409       \{
410          \textcolor{comment}{//Sign the key exchange parameters using RSA}
411          error = \hyperlink{tls__signature_8c_af6c383197c9d99d7845e8602c997e494}{tlsGenerateRsaSignature}(&privateKey,
412             context->serverVerifyData, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, written);
413       \}
414 
415       \textcolor{comment}{//Release previously allocated resources}
416       \hyperlink{rsa_8c_a14ee0338e3149b934552c40b97c8f096}{rsaFreePrivateKey}(&privateKey);
417    \}
418    \textcolor{keywordflow}{else}
419 \textcolor{preprocessor}{#endif}
420 \textcolor{preprocessor}{#if (TLS\_DSA\_SIGN\_SUPPORT == ENABLED)}
421    \textcolor{comment}{//DSA certificate?}
422    \textcolor{keywordflow}{if}(context->cert->type == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda925aea3c96483609ae2867b10693b4c4}{TLS\_CERT\_DSS\_SIGN})
423    \{
424       \hyperlink{structSha1Context}{Sha1Context} *sha1Context;
425 
426       \textcolor{comment}{//Allocate a memory buffer to hold the SHA-1 context}
427       sha1Context = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structSha1Context}{Sha1Context}));
428 
429       \textcolor{comment}{//Successful memory allocation?}
430       \textcolor{keywordflow}{if}(sha1Context != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
431       \{
432          \textcolor{comment}{//Compute SHA(ClientHello.random + ServerHello.random +}
433          \textcolor{comment}{//ServerKeyExchange.params)}
434          \hyperlink{sha1_8c_ab734cb0e0b67798f5cce1f34419982a3}{sha1Init}(sha1Context);
435          \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, context->clientRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
436          \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, context->serverRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
437          \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, params, paramsLen);
438          \hyperlink{sha1_8c_a7b7d2f57b504df6ed98c27d21c1d7a14}{sha1Final}(sha1Context, context->serverVerifyData);
439 
440          \textcolor{comment}{//Release previously allocated memory}
441          \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(sha1Context);
442       \}
443       \textcolor{keywordflow}{else}
444       \{
445          \textcolor{comment}{//Failed to allocate memory}
446          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
447       \}
448 
449       \textcolor{comment}{//Check status code}
450       \textcolor{keywordflow}{if}(!error)
451       \{
452          \textcolor{comment}{//Sign the key exchange parameters using DSA}
453          error = \hyperlink{tls__signature_8c_a2fb5acdd086627e2071e8ec9118253a8}{tlsGenerateDsaSignature}(context, context->serverVerifyData,
454             \hyperlink{sha1_8h_a3ba9296b223f1b3c710d6b812fd860e8}{SHA1\_DIGEST\_SIZE}, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, written);
455       \}
456    \}
457    \textcolor{keywordflow}{else}
458 \textcolor{preprocessor}{#endif}
459 \textcolor{preprocessor}{#if (TLS\_ECDSA\_SIGN\_SUPPORT == ENABLED)}
460    \textcolor{comment}{//ECDSA certificate?}
461    \textcolor{keywordflow}{if}(context->cert->type == \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffdab47f2dd2c4d36761f920f8a1af97f6ec}{TLS\_CERT\_ECDSA\_SIGN})
462    \{
463       \hyperlink{structSha1Context}{Sha1Context} *sha1Context;
464 
465       \textcolor{comment}{//Allocate a memory buffer to hold the SHA-1 context}
466       sha1Context = \hyperlink{tls_8h_a00504a83fb06cb4206f7205664ffeeb4}{tlsAllocMem}(\textcolor{keyword}{sizeof}(\hyperlink{structSha1Context}{Sha1Context}));
467 
468       \textcolor{comment}{//Successful memory allocation?}
469       \textcolor{keywordflow}{if}(sha1Context != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
470       \{
471          \textcolor{comment}{//Compute SHA(ClientHello.random + ServerHello.random +}
472          \textcolor{comment}{//ServerKeyExchange.params)}
473          \hyperlink{sha1_8c_ab734cb0e0b67798f5cce1f34419982a3}{sha1Init}(sha1Context);
474          \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, context->clientRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
475          \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, context->serverRandom, 
      \hyperlink{tls_8h_aafeca350828039567f4495388ca1fa52}{TLS\_RANDOM\_SIZE});
476          \hyperlink{sha1_8c_a910571a0170efa26560fe6300a9b87d9}{sha1Update}(sha1Context, params, paramsLen);
477          \hyperlink{sha1_8c_a7b7d2f57b504df6ed98c27d21c1d7a14}{sha1Final}(sha1Context, context->serverVerifyData);
478 
479          \textcolor{comment}{//Release previously allocated memory}
480          \hyperlink{tls_8h_a3bf186204f261ff5d65b31794917f742}{tlsFreeMem}(sha1Context);
481       \}
482       \textcolor{keywordflow}{else}
483       \{
484          \textcolor{comment}{//Failed to allocate memory}
485          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cac0a554045048d2fb61387cf735676f69}{ERROR\_OUT\_OF\_MEMORY};
486       \}
487 
488       \textcolor{comment}{//Check status code}
489       \textcolor{keywordflow}{if}(!error)
490       \{
491          \textcolor{comment}{//Sign the key exchange parameters using ECDSA}
492          error = \hyperlink{tls__signature_8c_ac858056ee74a931fb3c0f0ad42120664}{tlsGenerateEcdsaSignature}(context, context->serverVerifyData,
493             \hyperlink{sha1_8h_a3ba9296b223f1b3c710d6b812fd860e8}{SHA1\_DIGEST\_SIZE}, \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->value, written);
494       \}
495    \}
496    \textcolor{keywordflow}{else}
497 \textcolor{preprocessor}{#endif}
498    \textcolor{comment}{//Invalid certificate?}
499    \{
500       \textcolor{comment}{//Report an error}
501       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca4c54d9b14297edac328805943cf95795}{ERROR\_UNSUPPORTED\_SIGNATURE\_ALGO};
502    \}
503 
504    \textcolor{comment}{//Check status code}
505    \textcolor{keywordflow}{if}(!error)
506    \{
507       \textcolor{comment}{//Fix the length of the digitally-signed element}
508       \hyperlink{tls_8h_af27e6d4ea3add14cd8cc9aa275d716ad}{signature}->length = \hyperlink{cpu__endian_8h_a800cdbf435a85a9b3ad4f0edc518472a}{htons}(*written);
509       \textcolor{comment}{//Adjust the length of the signature}
510       *written += \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_a8e07cba48fef31563460ba8f90ad5f1d}{TlsDigitalSignature});
511    \}
512 \textcolor{preprocessor}{#else}
513    \textcolor{comment}{//Not implemented}
514    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
515 \textcolor{preprocessor}{#endif}
516 
517    \textcolor{comment}{//Return status code}
518    \textcolor{keywordflow}{return} error;
519 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_a634953aa0fd11d11c625673b3edb2456}\label{tls__server__misc_8c_a634953aa0fd11d11c625673b3edb2456}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Negotiate\+Cipher\+Suite@{tls\+Negotiate\+Cipher\+Suite}}
\index{tls\+Negotiate\+Cipher\+Suite@{tls\+Negotiate\+Cipher\+Suite}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Negotiate\+Cipher\+Suite()}{tlsNegotiateCipherSuite()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Negotiate\+Cipher\+Suite (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{structHashAlgo}{Hash\+Algo} $\ast$}]{hash\+Algo,  }\item[{const \hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{Tls\+Cipher\+Suites} $\ast$}]{cipher\+Suites,  }\item[{\hyperlink{structTlsHelloExtensions}{Tls\+Hello\+Extensions} $\ast$}]{extensions }\end{DoxyParamCaption})}



Cipher suite negotiation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em hash\+Algo} & Desired K\+DF hash algorithm \\
\hline
\mbox{\tt in}  & {\em cipher\+Suites} & List of cipher suites offered by the client \\
\hline
\mbox{\tt in}  & {\em extensions} & Client\+Hello extensions offered by the client \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1165 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
1167 \{
1168    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1169    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
1170    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} j;
1171    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{md5_8c_af11ea3cdbca7345eb6a4a8ac5ce0434d}{k};
1172    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1173 
1174    \textcolor{comment}{//Initialize status code}
1175    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca70d82df53df56c9d4a943d5539ccc4bc}{ERROR\_HANDSHAKE\_FAILED};
1176 
1177    \textcolor{comment}{//If no SignatureAlgorithmsCert extension is present in the ClientHello}
1178    \textcolor{comment}{//message, then the SignatureAlgorithms extension also applies to signatures}
1179    \textcolor{comment}{//appearing in certificates (RFC 8446, section 4.2.3)}
1180    \textcolor{keywordflow}{if}(extensions->\hyperlink{structTlsHelloExtensions_a640637c05b8aec2ef15420d5005830cb}{certSignAlgoList} == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1181    \{
1182       extensions->\hyperlink{structTlsHelloExtensions_a640637c05b8aec2ef15420d5005830cb}{certSignAlgoList} = extensions->\hyperlink{structTlsHelloExtensions_a7903ad9cf319d5f27990432c4e719544}{signAlgoList};
1183    \}
1184 
1185    \textcolor{comment}{//Get the total number of cipher suites offered by the client}
1186    n = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->length) / 2;
1187 
1188    \textcolor{comment}{//Select the most appropriate cipher suite (2-pass process)}
1189    \textcolor{keywordflow}{for}(k = 0; k < 2 && error; k++)
1190    \{
1191       \textcolor{comment}{//Any preferred cipher suites?}
1192       \textcolor{keywordflow}{if}(context->numCipherSuites > 0)
1193       \{
1194          \textcolor{comment}{//Loop through the list of allowed cipher suites (most preferred first)}
1195          \textcolor{keywordflow}{for}(i = 0; i < context->numCipherSuites && error; i++)
1196          \{
1197             \textcolor{comment}{//Loop through the list of cipher suites offered by the client}
1198             \textcolor{keywordflow}{for}(j = 0; j < n && error; j++)
1199             \{
1200                \textcolor{comment}{//If the list contains cipher suites the server does not}
1201                \textcolor{comment}{//recognize, support, or wish to use, the server must ignore}
1202                \textcolor{comment}{//those cipher suites, and process the remaining ones as usual}
1203                \textcolor{keywordflow}{if}(context->cipherSuites[i] == \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->value[j]))
1204                \{
1205                   \textcolor{comment}{//Select current cipher suite}
1206                   error = \hyperlink{tls__misc_8c_a2ba32c2ad10fd77d5947387e6753210d}{tlsSelectCipherSuite}(context, context->cipherSuites[i]);
1207 
1208                   \textcolor{comment}{//If a KDF hash algorithm has been specified, the server must}
1209                   \textcolor{comment}{//select a compatible cipher suite}
1210                   \textcolor{keywordflow}{if}(!error && hashAlgo != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1211                   \{
1212                      \textcolor{comment}{//Make sure the selected cipher suite is compatible}
1213                      \textcolor{keywordflow}{if}(context->cipherSuite.prfHashAlgo != hashAlgo)
1214                         error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca70d82df53df56c9d4a943d5539ccc4bc}{ERROR\_HANDSHAKE\_FAILED};
1215                   \}
1216 
1217                   \textcolor{comment}{//Check status code}
1218                   \textcolor{keywordflow}{if}(!error)
1219                   \{
1220                      \textcolor{comment}{//Select the group to be used when performing (EC)DHE key}
1221                      \textcolor{comment}{//exchange}
1222                      error = \hyperlink{tls__server__misc_8c_a17a35f3a542a6ba200aa77d4ca297224}{tlsSelectGroup}(context, extensions->
      \hyperlink{structTlsHelloExtensions_ae47ac6a93d2836418dc163d299e46cf7}{supportedGroupList});
1223                   \}
1224 
1225                   \textcolor{comment}{//Check status code}
1226                   \textcolor{keywordflow}{if}(!error)
1227                   \{
1228                      \textcolor{comment}{//Select the appropriate certificate}
1229                      error = \hyperlink{tls__server__misc_8c_a4c3f902c625a88aa8ba5269aff110b6c}{tlsSelectCertificate}(context, extensions);
1230                   \}
1231                \}
1232             \}
1233          \}
1234       \}
1235       \textcolor{keywordflow}{else}
1236       \{
1237          \textcolor{comment}{//The cipher suite list contains the combinations of cryptographic}
1238          \textcolor{comment}{//algorithms supported by the client in order of the client's preference}
1239          \textcolor{keywordflow}{for}(j = 0; j < n && error; j++)
1240          \{
1241             \textcolor{comment}{//If the list contains cipher suites the server does not recognize,}
1242             \textcolor{comment}{//support, or wish to use, the server must ignore those cipher suites,}
1243             \textcolor{comment}{//and process the remaining ones as usual}
1244             error = \hyperlink{tls__misc_8c_a2ba32c2ad10fd77d5947387e6753210d}{tlsSelectCipherSuite}(context, \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->value[j]));
1245 
1246             \textcolor{comment}{//If a KDF hash algorithm has been specified, the server must select}
1247             \textcolor{comment}{//a compatible cipher suite}
1248             \textcolor{keywordflow}{if}(!error && hashAlgo != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1249             \{
1250                \textcolor{comment}{//Make sure the selected cipher suite is compatible}
1251                \textcolor{keywordflow}{if}(context->cipherSuite.prfHashAlgo != hashAlgo)
1252                   error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca70d82df53df56c9d4a943d5539ccc4bc}{ERROR\_HANDSHAKE\_FAILED};
1253             \}
1254 
1255             \textcolor{comment}{//Check status code}
1256             \textcolor{keywordflow}{if}(!error)
1257             \{
1258                \textcolor{comment}{//Select the group to be used when performing (EC)DHE key exchange}
1259                error = \hyperlink{tls__server__misc_8c_a17a35f3a542a6ba200aa77d4ca297224}{tlsSelectGroup}(context, extensions->
      \hyperlink{structTlsHelloExtensions_ae47ac6a93d2836418dc163d299e46cf7}{supportedGroupList});
1260             \}
1261 
1262             \textcolor{comment}{//Check status code}
1263             \textcolor{keywordflow}{if}(!error)
1264             \{
1265                \textcolor{comment}{//Select the appropriate certificate}
1266                error = \hyperlink{tls__server__misc_8c_a4c3f902c625a88aa8ba5269aff110b6c}{tlsSelectCertificate}(context, extensions);
1267             \}
1268          \}
1269       \}
1270 
1271       \textcolor{comment}{//The second pass relaxes the constraints}
1272       extensions->\hyperlink{structTlsHelloExtensions_a640637c05b8aec2ef15420d5005830cb}{certSignAlgoList} = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1273    \}
1274 
1275    \textcolor{comment}{//Return status code}
1276    \textcolor{keywordflow}{return} error;
1277 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_ad99a99db09cdc1ac0f3cb60f15711035}\label{tls__server__misc_8c_ad99a99db09cdc1ac0f3cb60f15711035}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Negotiate\+Version@{tls\+Negotiate\+Version}}
\index{tls\+Negotiate\+Version@{tls\+Negotiate\+Version}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Negotiate\+Version()}{tlsNegotiateVersion()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Negotiate\+Version (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\+\_\+t}}]{client\+Version,  }\item[{const \hyperlink{tls_8h_a47fa2b51d8550d068fce6f01a24c03a8}{Tls\+Supported\+Version\+List} $\ast$}]{supported\+Version\+List }\end{DoxyParamCaption})}



Version negotiation. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em client\+Version} & Highest version number supported by the client (legacy version) \\
\hline
\mbox{\tt in}  & {\em supported\+Version\+List} & Pointer to the Supported\+Versions extensions \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1068 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
1070 \{
1071    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1072    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_a68eac05091e706580bce356bdae41075}{serverVersion};
1073 
1074    \textcolor{comment}{//Get the highest version supported by the implementation}
1075    serverVersion = context->versionMax;
1076 
1077 \textcolor{preprocessor}{#if (DTLS\_SUPPORT == ENABLED)}
1078    \textcolor{comment}{//DTLS protocol?}
1079    \textcolor{keywordflow}{if}(context->transportProtocol == \hyperlink{tls_8h_a25cb7e3df9004160eb21eac9377dc89fa3055717a6d464160f611ee26a81c7d92}{TLS\_TRANSPORT\_PROTOCOL\_DATAGRAM})
1080    \{
1081       \textcolor{comment}{//In DTLS 1.2, the client can indicate its version preferences in the}
1082       \textcolor{comment}{//SupportedVersions extension}
1083       \textcolor{keywordflow}{if}(supportedVersionList != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && context->versionMax >= 
      \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1084       \{
1085          \textcolor{comment}{//If the SupportedVersions extension is present in the ClientHello,}
1086          \textcolor{comment}{//servers must only select a version of DTLS present in that extension}
1087          error = \hyperlink{dtls__misc_8c_a4d9d84a3e22a9d1e4bfe10158c37e328}{dtlsParseClientSupportedVersionsExtension}(context
      ,
1088             (\hyperlink{dtls__misc_8h_abb5e373748ba1bb9a1fd3bf0d0d6e3ff}{DtlsSupportedVersionList} *) supportedVersionList);
1089       \}
1090       \textcolor{keywordflow}{else}
1091       \{
1092          \textcolor{comment}{//If the SupportedVersions extension is not present, servers must}
1093          \textcolor{comment}{//negotiate DTLS 1.2 or prior}
1094          serverVersion = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(serverVersion, \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2});
1095 
1096          \textcolor{comment}{//Translate TLS version into DTLS version}
1097          serverVersion = \hyperlink{dtls__misc_8c_a309abf8d9966cd0d5a28be1d94859970}{dtlsTranslateVersion}(serverVersion);
1098 
1099          \textcolor{comment}{//If a DTLS server receives a ClientHello containing a version number}
1100          \textcolor{comment}{//greater than the highest version supported by the server, it must}
1101          \textcolor{comment}{//reply according to the highest version supported by the server}
1102          serverVersion = \hyperlink{os__port_8h_afa99ec4acc4ecb2dc3c2d05da15d0e3f}{MAX}(serverVersion, \hyperlink{tls_8h_a8dbf7ac9449d428ac01b65110fc605b7}{clientVersion});
1103 
1104          \textcolor{comment}{//Set the DTLS version to be used}
1105          error = \hyperlink{dtls__misc_8c_a2f7252c7efbaf7747badfd0edde48eb9}{dtlsSelectVersion}(context, serverVersion);
1106       \}
1107    \}
1108    \textcolor{keywordflow}{else}
1109 \textcolor{preprocessor}{#endif}
1110    \textcolor{comment}{//TLS protocol?}
1111    \{
1112       \textcolor{comment}{//In TLS 1.2, the client can indicate its version preferences in the}
1113       \textcolor{comment}{//SupportedVersions extension}
1114       \textcolor{keywordflow}{if}(supportedVersionList != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && context->versionMax >= 
      \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1115       \{
1116          \textcolor{comment}{//If the SupportedVersions extension is present in the ClientHello,}
1117          \textcolor{comment}{//servers must only select a version of TLS present in that extension}
1118          error = \hyperlink{tls__server__extensions_8c_a5f9b37e02ecb77f4b6285669ed9a90b4}{tlsParseClientSupportedVersionsExtension}(context,
1119             supportedVersionList);
1120 
1121          \textcolor{comment}{//Check status code}
1122          \textcolor{keywordflow}{if}(!error)
1123          \{
1124             \textcolor{comment}{//Check whether TLS 1.3 has been negotiated}
1125             \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_ab44dc642afbfbd72926ab1f94634cd4d}{TLS\_VERSION\_1\_3})
1126             \{
1127                \textcolor{comment}{//The legacy\_version field must be set to 0x0303, which is the}
1128                \textcolor{comment}{//version number for TLS 1.2}
1129                \textcolor{keywordflow}{if}(\hyperlink{tls_8h_a8dbf7ac9449d428ac01b65110fc605b7}{clientVersion} < \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1130                   error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca20a00b499b03770ffd859e78470c278f}{ERROR\_VERSION\_NOT\_SUPPORTED};
1131             \}
1132          \}
1133       \}
1134       \textcolor{keywordflow}{else}
1135       \{
1136          \textcolor{comment}{//If the SupportedVersions extension is not present, servers must}
1137          \textcolor{comment}{//negotiate TLS 1.2 or prior, even if the legacy\_version of the}
1138          \textcolor{comment}{//ClientHello is 0x0304 or later (refer to RFC 8446, section 4.2.1)}
1139          serverVersion = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(serverVersion, \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2});
1140 
1141          \textcolor{comment}{//If a TLS server receives a ClientHello containing a version number}
1142          \textcolor{comment}{//greater than the highest version supported by the server, it must}
1143          \textcolor{comment}{//reply according to the highest version supported by the server}
1144          serverVersion = \hyperlink{os__port_8h_a3acffbd305ee72dcd4593c0d8af64a4f}{MIN}(serverVersion, \hyperlink{tls_8h_a8dbf7ac9449d428ac01b65110fc605b7}{clientVersion});
1145 
1146          \textcolor{comment}{//Set the TLS version to be used}
1147          error = \hyperlink{tls__misc_8c_a62b0052733220e9ec9fee8ff5e8e5dab}{tlsSelectVersion}(context, serverVersion);
1148       \}
1149    \}
1150 
1151    \textcolor{comment}{//Return status code}
1152    \textcolor{keywordflow}{return} error;
1153 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_aeb2235551aa3828c696652a82ca808b6}\label{tls__server__misc_8c_aeb2235551aa3828c696652a82ca808b6}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Parse\+Client\+Key\+Params@{tls\+Parse\+Client\+Key\+Params}}
\index{tls\+Parse\+Client\+Key\+Params@{tls\+Parse\+Client\+Key\+Params}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Parse\+Client\+Key\+Params()}{tlsParseClientKeyParams()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Parse\+Client\+Key\+Params (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{p,  }\item[{size\+\_\+t}]{length,  }\item[{size\+\_\+t $\ast$}]{consumed }\end{DoxyParamCaption})}



Parse client\textquotesingle{}s key exchange parameters. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em p} & Input stream where to read the client\textquotesingle{}s key exchange parameters \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes available in the input stream \\
\hline
\mbox{\tt out}  & {\em consumed} & Total number of bytes that have been consumed \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1693 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
1695 \{
1696    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1697 
1698 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
1699    \textcolor{comment}{//Initialize status code}
1700    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1701 
1702 \textcolor{preprocessor}{#if (TLS\_RSA\_KE\_SUPPORT == ENABLED || TLS\_RSA\_PSK\_KE\_SUPPORT == ENABLED)}
1703    \textcolor{comment}{//RSA key exchange method?}
1704    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01c48fe0c56e76f59032069e7c7da49e}{TLS\_KEY\_EXCH\_RSA} ||
1705       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a38a6d0551d2fbd9480b6c233c1242d4c}{TLS\_KEY\_EXCH\_RSA\_PSK})
1706    \{
1707       \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1708       \hyperlink{stdint_8h_a435d1572bf3f880d55459d9805097f62}{uint32\_t} bad;
1709       \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} \hyperlink{dtls__misc_8h_ab6d7b6f8c2ceaba7acda80aaf05f4899}{version};
1710       \hyperlink{structRsaPrivateKey}{RsaPrivateKey} privateKey;
1711       \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} randPremasterSecret[48];
1712 
1713       \textcolor{comment}{//The RSA-encrypted premaster secret in a ClientKeyExchange is preceded by}
1714       \textcolor{comment}{//two length bytes. SSL 3.0 implementations do not include these bytes}
1715       \textcolor{keywordflow}{if}(context->version > \hyperlink{tls_8h_a8d19a9661e2ca28062ba4a00799e8bdb}{SSL\_VERSION\_3\_0})
1716       \{
1717          \textcolor{comment}{//Malformed ClientKeyExchange message?}
1718          \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < 2)
1719             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1720 
1721          \textcolor{comment}{//Decode the length field}
1722          n = \hyperlink{cpu__endian_8h_ae21854587c05993c850b537156470088}{LOAD16BE}(\hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p});
1723 
1724          \textcolor{comment}{//Check the length of the RSA-encrypted premaster secret}
1725          \textcolor{keywordflow}{if}(n > (\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} - 2))
1726             \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1727 
1728          \textcolor{comment}{//Save the length of the RSA-encrypted premaster secret}
1729          \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1730          \textcolor{comment}{//Advance the pointer over the length field}
1731          \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p} += 2;
1732          \textcolor{comment}{//Total number of bytes that have been consumed}
1733          *consumed = \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} + 2;
1734       \}
1735       \textcolor{keywordflow}{else}
1736       \{
1737          \textcolor{comment}{//Total number of bytes that have been consumed}
1738          *consumed = \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length};
1739       \}
1740 
1741       \textcolor{comment}{//Initialize RSA private key}
1742       \hyperlink{rsa_8c_ad454d9bc34f7d9fa5717180707365e69}{rsaInitPrivateKey}(&privateKey);
1743 
1744       \textcolor{comment}{//Decode the PEM structure that holds the RSA private key}
1745       error = \hyperlink{certificate_2pem__import_8c_a3d276f00ad49589056269bfe8abbb664}{pemImportRsaPrivateKey}(context->cert->privateKey,
1746          context->cert->privateKeyLen, &privateKey);
1747 
1748       \textcolor{comment}{//Check status code}
1749       \textcolor{keywordflow}{if}(!error)
1750       \{
1751          \textcolor{comment}{//Decrypt the premaster secret using the server private key}
1752          error = \hyperlink{rsa_8c_a2441cef0529ca8ebb763f566877fc37e}{rsaesPkcs1v15Decrypt}(&privateKey, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, 
      \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length},
1753             context->premasterSecret, \hyperlink{tls_8h_ab57dd89b36996f086e46d778395375c3}{TLS\_PREMASTER\_SECRET\_SIZE},
1754             &context->premasterSecretLen);
1755       \}
1756 
1757       \textcolor{comment}{//Release RSA private key}
1758       \hyperlink{rsa_8c_a14ee0338e3149b934552c40b97c8f096}{rsaFreePrivateKey}(&privateKey);
1759 
1760       \textcolor{comment}{//Retrieve the latest version supported by the client. This is used}
1761       \textcolor{comment}{//to detect version roll-back attacks}
1762       version = \hyperlink{cpu__endian_8h_ae21854587c05993c850b537156470088}{LOAD16BE}(context->premasterSecret);
1763 
1764       \textcolor{comment}{//The best way to avoid vulnerability to the Bleichenbacher attack is to}
1765       \textcolor{comment}{//treat incorrectly formatted messages in a manner indistinguishable from}
1766       \textcolor{comment}{//correctly formatted RSA blocks}
1767       bad = \hyperlink{cyclone__crypto_2core_2crypto_8h_a56de78e395c483702d9b2fc057ef91ef}{CRYPTO\_TEST\_NZ\_32}(error);
1768       bad |= \hyperlink{cyclone__crypto_2core_2crypto_8h_a8929cd320cf311a479ec9f94a764ac92}{CRYPTO\_TEST\_NEQ\_32}(context->premasterSecretLen, 48);
1769       bad |= \hyperlink{cyclone__crypto_2core_2crypto_8h_a1e8a6b6e8f45e0f5ee4f2b9c3a9b20fc}{CRYPTO\_TEST\_NEQ\_16}(version, context->clientVersion);
1770 
1771       \textcolor{comment}{//Generate a random 48-byte value}
1772       error = context->prngAlgo->read(context->prngContext,
1773          randPremasterSecret, 48);
1774 
1775       \textcolor{comment}{//When it receives an incorrectly formatted RSA block, the server should}
1776       \textcolor{comment}{//proceed using the random 48-byte value as the premaster secret}
1777       \textcolor{keywordflow}{for}(n = 0; n < 48; n++)
1778       \{
1779          context->premasterSecret[\hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}] = \hyperlink{cyclone__crypto_2core_2crypto_8h_aa9f5e6d0d42a84bae01ec5e4e6f5c45b}{CRYPTO\_SELECT\_8}(
1780             context->premasterSecret[n], randPremasterSecret[n], bad);
1781       \}
1782 
1783       \textcolor{comment}{//Fix the length of the premaster secret}
1784       context->premasterSecretLen = 48;
1785    \}
1786    \textcolor{keywordflow}{else}
1787 \textcolor{preprocessor}{#endif}
1788 \textcolor{preprocessor}{#if (TLS\_DH\_ANON\_KE\_SUPPORT == ENABLED || TLS\_DHE\_RSA\_KE\_SUPPORT == ENABLED || \(\backslash\)}
1789 \textcolor{preprocessor}{   TLS\_DHE\_DSS\_KE\_SUPPORT == ENABLED || TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED)}
1790    \textcolor{comment}{//Diffie-Hellman key exchange method?}
1791    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a33535bd987c46f1ba621d6e28b0b3bfa}{TLS\_KEY\_EXCH\_DH\_ANON} ||
1792       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01660ec1808dd6a8b5250b16d81502e4}{TLS\_KEY\_EXCH\_DHE\_RSA} ||
1793       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ac256323d1e243a2e7a435abce34dbd39}{TLS\_KEY\_EXCH\_DHE\_DSS} ||
1794       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a32a252b7c7befeccaa088290d6a71dfe}{TLS\_KEY\_EXCH\_DHE\_PSK})
1795    \{
1796       \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1797 
1798       \textcolor{comment}{//Convert the client's public value to a multiple precision integer}
1799       error = \hyperlink{tls__misc_8c_ac339933c6e9abec0ad7758fb4000673e}{tlsReadMpi}(&context->dhContext.yb, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, &n);
1800 
1801       \textcolor{comment}{//Check status code}
1802       \textcolor{keywordflow}{if}(!error)
1803       \{
1804          \textcolor{comment}{//Total number of bytes that have been consumed}
1805          *consumed = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1806 
1807          \textcolor{comment}{//Verify client's public value}
1808          error = \hyperlink{dh_8c_a988fa4ff931f4ee47c2d46f0db080136}{dhCheckPublicKey}(&context->dhContext.params,
1809             &context->dhContext.yb);
1810       \}
1811 
1812       \textcolor{comment}{//Check status code}
1813       \textcolor{keywordflow}{if}(!error)
1814       \{
1815          \textcolor{comment}{//Calculate the negotiated key Z}
1816          error = \hyperlink{dh_8c_a79c2a9c97b46c822ed219314a1ef3231}{dhComputeSharedSecret}(&context->dhContext,
1817             context->premasterSecret, \hyperlink{tls_8h_ab57dd89b36996f086e46d778395375c3}{TLS\_PREMASTER\_SECRET\_SIZE},
1818             &context->premasterSecretLen);
1819       \}
1820 
1821       \textcolor{comment}{//Check status code}
1822       \textcolor{keywordflow}{if}(!error)
1823       \{
1824          \textcolor{comment}{//Leading bytes of Z that contain all zero bits are stripped before}
1825          \textcolor{comment}{//it is used as the premaster secret (RFC 4346, section 8.2.1)}
1826          \textcolor{keywordflow}{for}(n = 0; n < context->premasterSecretLen; n++)
1827          \{
1828             \textcolor{keywordflow}{if}(context->premasterSecret[n] != 0x00)
1829                \textcolor{keywordflow}{break};
1830          \}
1831 
1832          \textcolor{comment}{//Any leading zero bytes?}
1833          \textcolor{keywordflow}{if}(n > 0)
1834          \{
1835             \textcolor{comment}{//Strip leading zero bytes from the negotiated key}
1836             memmove(context->premasterSecret, context->premasterSecret + n,
1837                context->premasterSecretLen - n);
1838 
1839             \textcolor{comment}{//Adjust the length of the premaster secret}
1840             context->premasterSecretLen -= \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1841          \}
1842       \}
1843    \}
1844    \textcolor{keywordflow}{else}
1845 \textcolor{preprocessor}{#endif}
1846 \textcolor{preprocessor}{#if (TLS\_ECDH\_ANON\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_RSA\_KE\_SUPPORT == ENABLED || \(\backslash\)}
1847 \textcolor{preprocessor}{   TLS\_ECDHE\_ECDSA\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
1848    \textcolor{comment}{//ECDH key exchange method?}
1849    \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a895e0af86b29640264f699235be22953}{TLS\_KEY\_EXCH\_ECDH\_ANON} ||
1850       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ad9ebbdd436027753829ea5b6cd4b810b}{TLS\_KEY\_EXCH\_ECDHE\_RSA} ||
1851       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a14c521a28278eecd181953c37b784cb7}{TLS\_KEY\_EXCH\_ECDHE\_ECDSA} ||
1852       context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aebba2060dba7ad92238668218f3a6520}{TLS\_KEY\_EXCH\_ECDHE\_PSK})
1853    \{
1854       \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1855 
1856       \textcolor{comment}{//Decode client's public key}
1857       error = \hyperlink{tls__misc_8c_ac6d7ad566c151d978f10283c3e6710ff}{tlsReadEcPoint}(&context->ecdhContext.params,
1858          &context->ecdhContext.qb, \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p}, \hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length}, &n);
1859 
1860       \textcolor{comment}{//Check status code}
1861       \textcolor{keywordflow}{if}(!error)
1862       \{
1863          \textcolor{comment}{//Total number of bytes that have been consumed}
1864          *consumed = \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1865 
1866          \textcolor{comment}{//Verify client's public key and make sure that it is on the same}
1867          \textcolor{comment}{//elliptic curve as the server's ECDH key}
1868          error = \hyperlink{ecdh_8c_a91d3e413ca085581761f40ce6215925b}{ecdhCheckPublicKey}(&context->ecdhContext.params,
1869             &context->ecdhContext.qb);
1870       \}
1871 
1872       \textcolor{comment}{//Check status code}
1873       \textcolor{keywordflow}{if}(!error)
1874       \{
1875 \textcolor{preprocessor}{#if (TLS\_ECC\_CALLBACK\_SUPPORT == ENABLED)}
1876          \textcolor{comment}{//Any registered callback?}
1877          \textcolor{keywordflow}{if}(context->ecdhCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1878          \{
1879             \textcolor{comment}{//Invoke user callback function}
1880             error = context->ecdhCallback(context);
1881          \}
1882          \textcolor{keywordflow}{else}
1883 \textcolor{preprocessor}{#endif}
1884          \{
1885             \textcolor{comment}{//No callback function defined}
1886             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caae7cba11578605e61d5137cea3752cb9}{ERROR\_UNSUPPORTED\_ELLIPTIC\_CURVE};
1887          \}
1888 
1889          \textcolor{comment}{//Check status code}
1890          \textcolor{keywordflow}{if}(error == \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689caae7cba11578605e61d5137cea3752cb9}{ERROR\_UNSUPPORTED\_ELLIPTIC\_CURVE})
1891          \{
1892             \textcolor{comment}{//Calculate the shared secret Z. Leading zeros found in this octet}
1893             \textcolor{comment}{//string must not be truncated (see RFC 4492, section 5.10)}
1894             error = \hyperlink{ecdh_8c_a53821d9d049c084309e152dbea880db1}{ecdhComputeSharedSecret}(&context->ecdhContext,
1895                context->premasterSecret, \hyperlink{tls_8h_ab57dd89b36996f086e46d778395375c3}{TLS\_PREMASTER\_SECRET\_SIZE},
1896                &context->premasterSecretLen);
1897          \}
1898       \}
1899    \}
1900    \textcolor{keywordflow}{else}
1901 \textcolor{preprocessor}{#endif}
1902    \textcolor{comment}{//Invalid key exchange method?}
1903    \{
1904       \textcolor{comment}{//The specified key exchange method is not supported}
1905       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca893cd3e6a2ef1603a6c30561ed73ec0e}{ERROR\_UNSUPPORTED\_KEY\_EXCH\_METHOD};
1906    \}
1907 \textcolor{preprocessor}{#else}
1908    \textcolor{comment}{//Not implemented}
1909    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
1910 \textcolor{preprocessor}{#endif}
1911 
1912    \textcolor{comment}{//Return status code}
1913    \textcolor{keywordflow}{return} error;
1914 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_a7aec22c82399ab4173339771d47ceff7}\label{tls__server__misc_8c_a7aec22c82399ab4173339771d47ceff7}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Parse\+Compress\+Methods@{tls\+Parse\+Compress\+Methods}}
\index{tls\+Parse\+Compress\+Methods@{tls\+Parse\+Compress\+Methods}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Parse\+Compress\+Methods()}{tlsParseCompressMethods()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Parse\+Compress\+Methods (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{tls_8h_a73df667e4fbedd6b3dd66620b4d5d018}{Tls\+Compress\+Methods} $\ast$}]{compress\+Methods }\end{DoxyParamCaption})}



Parse the list of compression methods supported by the client. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em compress\+Methods} & List of compression methods \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1589 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
1591 \{
1592    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1593    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
1594 
1595    \textcolor{comment}{//Initialize status code}
1596    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca152b24f57c941cb736772696416eb7c2}{ERROR\_ILLEGAL\_PARAMETER};
1597 
1598    \textcolor{comment}{//Version of TLS prior to TLS 1.3?}
1599    \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1600    \{
1601       \textcolor{comment}{//The list of the compression methods supported by the client is sorted}
1602       \textcolor{comment}{//by client preference}
1603       \textcolor{keywordflow}{for}(i = 0; i < compressMethods->length && error; i++)
1604       \{
1605          \textcolor{comment}{//The CRIME exploit takes advantage of TLS compression, so conservative}
1606          \textcolor{comment}{//implementations do not accept compression at the TLS level}
1607          \textcolor{keywordflow}{if}(compressMethods->value[i] == \hyperlink{tls_8h_a27ce2afc296aeccf0726bf834d2df74da9e6d39fe3397b578757793795b18d882}{TLS\_COMPRESSION\_METHOD\_NULL})
1608          \{
1609             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1610          \}
1611       \}
1612    \}
1613    \textcolor{keywordflow}{else}
1614    \{
1615       \textcolor{comment}{//For every TLS 1.3 ClientHello, this vector must contain exactly one}
1616       \textcolor{comment}{//byte, set to zero which corresponds to the null compression method}
1617       \textcolor{keywordflow}{if}(compressMethods->length == 1)
1618       \{
1619          \textcolor{comment}{//If a ClientHello is received with any other value in this field,}
1620          \textcolor{comment}{//the server must abort the handshake with an illegal\_parameter alert}
1621          \textcolor{keywordflow}{if}(compressMethods->value[0] == \hyperlink{tls_8h_a27ce2afc296aeccf0726bf834d2df74da9e6d39fe3397b578757793795b18d882}{TLS\_COMPRESSION\_METHOD\_NULL})
1622          \{
1623             error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1624          \}
1625       \}
1626    \}
1627 
1628    \textcolor{comment}{//Return status code}
1629    \textcolor{keywordflow}{return} error;
1630 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_a83d2e7ba7af8d605e367229331aabbbb}\label{tls__server__misc_8c_a83d2e7ba7af8d605e367229331aabbbb}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Parse\+Psk\+Identity@{tls\+Parse\+Psk\+Identity}}
\index{tls\+Parse\+Psk\+Identity@{tls\+Parse\+Psk\+Identity}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Parse\+Psk\+Identity()}{tlsParsePskIdentity()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Parse\+Psk\+Identity (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{p,  }\item[{size\+\_\+t}]{length,  }\item[{size\+\_\+t $\ast$}]{consumed }\end{DoxyParamCaption})}



Parse P\+SK identity. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em p} & Input stream where to read the P\+SK identity hint \\
\hline
\mbox{\tt in}  & {\em length} & Number of bytes available in the input stream \\
\hline
\mbox{\tt out}  & {\em consumed} & Total number of bytes that have been consumed \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1642 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
1644 \{
1645    \textcolor{keywordtype}{size\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1646    \hyperlink{tls_8h_af33e2a9d86182364df2ba92d43c4dd0f}{TlsPskIdentity} *pskIdentity;
1647 
1648    \textcolor{comment}{//Point to the PSK identity}
1649    pskIdentity = (\hyperlink{tls_8h_af33e2a9d86182364df2ba92d43c4dd0f}{TlsPskIdentity} *) \hyperlink{ndp_8h_a6519522ad9a6f45e7a8d25d31392a977}{p};
1650 
1651    \textcolor{comment}{//Malformed ClientKeyExchange message?}
1652    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_af33e2a9d86182364df2ba92d43c4dd0f}{TlsPskIdentity}))
1653       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1654    \textcolor{keywordflow}{if}(\hyperlink{dtls__misc_8h_ab43ca82dd7fa2a0e56f941032ef324c4}{length} < (\textcolor{keyword}{sizeof}(\hyperlink{tls_8h_af33e2a9d86182364df2ba92d43c4dd0f}{TlsPskIdentity}) + \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(pskIdentity->length)))
1655       \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca9468adacac8c37004024dd0095ba2768}{ERROR\_DECODING\_FAILED};
1656 
1657    \textcolor{comment}{//Retrieve the length of the PSK identity}
1658    n = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(pskIdentity->length);
1659 
1660 \textcolor{preprocessor}{#if (TLS\_PSK\_KE\_SUPPORT == ENABLED || TLS\_RSA\_PSK\_KE\_SUPPORT == ENABLED || \(\backslash\)}
1661 \textcolor{preprocessor}{   TLS\_DHE\_PSK\_KE\_SUPPORT == ENABLED || TLS\_ECDHE\_PSK\_KE\_SUPPORT == ENABLED)}
1662    \textcolor{comment}{//Any registered callback?}
1663    \textcolor{keywordflow}{if}(context->pskCallback != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1664    \{
1665       \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1666 
1667       \textcolor{comment}{//The server selects which key to use depending on the the PSK identity}
1668       \textcolor{comment}{//provided by the client}
1669       error = context->pskCallback(context, pskIdentity->value, n);
1670       \textcolor{comment}{//Any error to report?}
1671       \textcolor{keywordflow}{if}(error)
1672          \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cade0c8860257a961bd14c16418e03f993}{ERROR\_UNKNOWN\_IDENTITY};
1673    \}
1674 \textcolor{preprocessor}{#endif}
1675 
1676    \textcolor{comment}{//Total number of bytes that have been consumed}
1677    *consumed = \textcolor{keyword}{sizeof}(\hyperlink{tls_8h_af33e2a9d86182364df2ba92d43c4dd0f}{TlsPskIdentity}) + n;
1678 
1679    \textcolor{comment}{//Successful processing}
1680    \textcolor{keywordflow}{return} \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1681 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_a5f4a1b96d929e08c6e62fa2f5408a894}\label{tls__server__misc_8c_a5f4a1b96d929e08c6e62fa2f5408a894}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Resume\+Server\+Session@{tls\+Resume\+Server\+Session}}
\index{tls\+Resume\+Server\+Session@{tls\+Resume\+Server\+Session}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Resume\+Server\+Session()}{tlsResumeServerSession()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Resume\+Server\+Session (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\+\_\+t} $\ast$}]{session\+Id,  }\item[{size\+\_\+t}]{session\+Id\+Len,  }\item[{const \hyperlink{tls_8h_a063ff78ef819d405642544154c856ec4}{Tls\+Cipher\+Suites} $\ast$}]{cipher\+Suites,  }\item[{const \hyperlink{structTlsHelloExtensions}{Tls\+Hello\+Extensions} $\ast$}]{extensions }\end{DoxyParamCaption})}



Resume T\+LS session via session ID. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em session\+Id} & Pointer to the session ID offered by the client \\
\hline
\mbox{\tt in}  & {\em session\+Id\+Len} & Length of the session ID, in bytes \\
\hline
\mbox{\tt in}  & {\em cipher\+Suites} & List of cipher suites offered by the client \\
\hline
\mbox{\tt in}  & {\em extensions} & Client\+Hello extensions offered by the client \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 921 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
924 \{
925    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
926 
927 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
928    \textcolor{comment}{//Initialize status code}
929    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
930 
931 \textcolor{preprocessor}{#if (TLS\_SESSION\_RESUME\_SUPPORT == ENABLED)}
932    \textcolor{comment}{//Check whether session caching is supported}
933    \textcolor{keywordflow}{if}(context->cache != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
934    \{
935       \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
936       \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
937       \hyperlink{structTlsSessionState}{TlsSessionState} *session;
938 
939       \textcolor{comment}{//If the session ID was non-empty, the server will look in its}
940       \textcolor{comment}{//session cache for a match}
941       session = \hyperlink{tls__cache_8c_a1849469bec230442e53f9a6103052edb}{tlsFindCache}(context->cache, \hyperlink{tls_8h_a0ee8ac239b5c0b1c94a323be5dd9fb17}{sessionId}, 
      \hyperlink{tls_8h_a17e3dc94f3cf9dd7c26a411a9db2608d}{sessionIdLen});
942 
943       \textcolor{comment}{//Matching session found?}
944       \textcolor{keywordflow}{if}(session != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
945       \{
946          \textcolor{comment}{//Whenever a client already knows the highest protocol version known}
947          \textcolor{comment}{//to a server (for example, when resuming a session), it should}
948          \textcolor{comment}{//initiate the connection in that native protocol}
949          \textcolor{keywordflow}{if}(session->\hyperlink{structTlsSessionState_a174320f3867df007a4315bfa7a84e42c}{version} != context->version)
950             session = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
951       \}
952 
953       \textcolor{comment}{//Matching session found?}
954       \textcolor{keywordflow}{if}(session != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
955       \{
956          \textcolor{comment}{//Get the total number of cipher suites offered by the client}
957          n = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->length) / 2;
958 
959          \textcolor{comment}{//Loop through the list of cipher suite identifiers}
960          \textcolor{keywordflow}{for}(i = 0; i < \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n}; i++)
961          \{
962             \textcolor{comment}{//Matching cipher suite?}
963             \textcolor{keywordflow}{if}(\hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(cipherSuites->value[i]) == session->\hyperlink{structTlsSessionState_a645a198fee226b387ad71fa2df860bd2}{cipherSuite})
964                \textcolor{keywordflow}{break};
965          \}
966 
967          \textcolor{comment}{//If the cipher suite is not present in the list cipher suites offered}
968          \textcolor{comment}{//by the client, the server must not perform the abbreviated handshake}
969          \textcolor{keywordflow}{if}(i >= n)
970             session = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
971       \}
972 
973 \textcolor{preprocessor}{#if (TLS\_SNI\_SUPPORT == ENABLED)}
974       \textcolor{comment}{//Matching session found?}
975       \textcolor{keywordflow}{if}(session != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
976       \{
977          \textcolor{comment}{//ServerName extension found?}
978          \textcolor{keywordflow}{if}(session->\hyperlink{structTlsSessionState_a9e4b28fa363d10a42e24879e0ba57813}{serverName} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && context->serverName != 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
979          \{
980             \textcolor{comment}{//A server that implements this extension must not accept the}
981             \textcolor{comment}{//request to resume the session if the ServerName extension contains}
982             \textcolor{comment}{//a different name (refer to RFC 6066, section 3)}
983             \textcolor{keywordflow}{if}(strcmp(session->\hyperlink{structTlsSessionState_a9e4b28fa363d10a42e24879e0ba57813}{serverName}, context->serverName))
984             \{
985                \textcolor{comment}{//Instead, the server proceeds with a full handshake to establish}
986                \textcolor{comment}{//a new session}
987                session = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
988             \}
989          \}
990          \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(session->\hyperlink{structTlsSessionState_a9e4b28fa363d10a42e24879e0ba57813}{serverName} == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL} && context->serverName == 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
991          \{
992             \textcolor{comment}{//The ServerName extension is not present}
993          \}
994          \textcolor{keywordflow}{else}
995          \{
996             \textcolor{comment}{//The server proceeds with a full handshake to establish a new}
997             \textcolor{comment}{//session}
998             session = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
999          \}
1000       \}
1001 \textcolor{preprocessor}{#endif}
1002 
1003 \textcolor{preprocessor}{#if (TLS\_EXT\_MASTER\_SECRET\_SUPPORT == ENABLED)}
1004       \textcolor{comment}{//Matching session found?}
1005       \textcolor{keywordflow}{if}(session != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1006       \{
1007          \textcolor{comment}{//ExtendedMasterSecret extension found?}
1008          \textcolor{keywordflow}{if}(extensions->\hyperlink{structTlsHelloExtensions_a04cc0ffcf992700820ec12d6f43212bf}{extendedMasterSecret} != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1009          \{
1010             \textcolor{comment}{//If the original session did not use the ExtendedMasterSecret}
1011             \textcolor{comment}{//extension but the new ClientHello contains the extension, then}
1012             \textcolor{comment}{//the server must not perform the abbreviated handshake}
1013             \textcolor{keywordflow}{if}(!session->\hyperlink{structTlsSessionState_a1345e3eac1e2a0fb86af8e0f0c7b123a}{extendedMasterSecret})
1014                session = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1015          \}
1016       \}
1017 \textcolor{preprocessor}{#endif}
1018 
1019       \textcolor{comment}{//Check whether the server has decided to resume a previous session}
1020       \textcolor{keywordflow}{if}(session != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1021       \{
1022          \textcolor{comment}{//Perform abbreviated handshake}
1023          context->resume = \hyperlink{os__port_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
1024          \textcolor{comment}{//Restore cached session parameters}
1025          \hyperlink{tls_8c_a04094e358f18adc2d7ad8686e3258b93}{tlsRestoreSessionState}(context, session);
1026 
1027          \textcolor{comment}{//Select the relevant cipher suite}
1028          error = \hyperlink{tls__misc_8c_a2ba32c2ad10fd77d5947387e6753210d}{tlsSelectCipherSuite}(context, session->
      \hyperlink{structTlsSessionState_a645a198fee226b387ad71fa2df860bd2}{cipherSuite});
1029       \}
1030       \textcolor{keywordflow}{else}
1031       \{
1032          \textcolor{comment}{//Perform a full handshake}
1033          context->resume = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1034          \textcolor{comment}{//Session ID is limited to 32 bytes}
1035          context->sessionIdLen = 32;
1036 
1037          \textcolor{comment}{//Generate a new random ID}
1038          error = context->prngAlgo->read(context->prngContext,
1039             context->sessionId, context->sessionIdLen);
1040       \}
1041    \}
1042    \textcolor{keywordflow}{else}
1043 \textcolor{preprocessor}{#endif}
1044    \{
1045       \textcolor{comment}{//Perform a full handshake}
1046       context->resume = \hyperlink{os__port_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE};
1047       \textcolor{comment}{//The session cannot be resumed}
1048       context->sessionIdLen = 0;
1049    \}
1050 \textcolor{preprocessor}{#else}
1051    \textcolor{comment}{//Not implemented}
1052    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab61c5ef368fbf03fdc1fb566c63f2f9a}{ERROR\_NOT\_IMPLEMENTED};
1053 \textcolor{preprocessor}{#endif}
1054 
1055    \textcolor{comment}{//Return status code}
1056    \textcolor{keywordflow}{return} error;
1057 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_a4c3f902c625a88aa8ba5269aff110b6c}\label{tls__server__misc_8c_a4c3f902c625a88aa8ba5269aff110b6c}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Select\+Certificate@{tls\+Select\+Certificate}}
\index{tls\+Select\+Certificate@{tls\+Select\+Certificate}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Select\+Certificate()}{tlsSelectCertificate()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Select\+Certificate (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{structTlsHelloExtensions}{Tls\+Hello\+Extensions} $\ast$}]{extensions }\end{DoxyParamCaption})}



Certificate selection process. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em extensions} & Client\+Hello extensions offered by the client \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1445 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
1447 \{
1448    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1449    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
1450    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1451    \hyperlink{compiler__port_8h_a812d16e5494522586b3784e55d479912}{bool\_t} acceptable;
1452    \hyperlink{stdint_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} certTypes[2];
1453 
1454    \textcolor{comment}{//Initialize status code}
1455    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1456 
1457    \textcolor{comment}{//Number of certificate types}
1458    n = 0;
1459 
1460 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
1461    \textcolor{comment}{//SSL 3.0, TLS 1.0, TLS 1.1 or TLS 1.2 currently selected?}
1462    \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1463    \{
1464       \textcolor{comment}{//The server requires a valid certificate whenever the agreed-upon key}
1465       \textcolor{comment}{//exchange method uses certificates for authentication}
1466       \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01c48fe0c56e76f59032069e7c7da49e}{TLS\_KEY\_EXCH\_RSA} ||
1467          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01660ec1808dd6a8b5250b16d81502e4}{TLS\_KEY\_EXCH\_DHE\_RSA} ||
1468          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ad9ebbdd436027753829ea5b6cd4b810b}{TLS\_KEY\_EXCH\_ECDHE\_RSA} ||
1469          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a38a6d0551d2fbd9480b6c233c1242d4c}{TLS\_KEY\_EXCH\_RSA\_PSK})
1470       \{
1471          \textcolor{comment}{//RSA, DHE\_RSA, ECDHE\_RSA and RSA\_PSK key exchange methods require}
1472          \textcolor{comment}{//an RSA certificate}
1473          certTypes[n++] = \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda3a76023fc80c787bffed357a4560351b}{TLS\_CERT\_RSA\_SIGN};
1474       \}
1475       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a4ee2715b2c18c6b04bee93f29cf35880}{TLS\_KEY\_EXCH\_DH\_RSA})
1476       \{
1477          \textcolor{comment}{//In DH\_RSA, the server's certificate must contain a Diffie-Hellman}
1478          \textcolor{comment}{//public key and be signed with RSA}
1479          certTypes[n++] = \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda0e95820e1b8ed5f424901b5863359e95}{TLS\_CERT\_RSA\_FIXED\_DH};
1480       \}
1481       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75af5c6a99b56f3f5b549491e422ecdb3ab}{TLS\_KEY\_EXCH\_ECDH\_RSA})
1482       \{
1483          \textcolor{comment}{//In ECDH\_RSA, the server's certificate must contain an ECDH-capable}
1484          \textcolor{comment}{//public key and be signed with RSA}
1485          certTypes[n++] = \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffdacc0e4b72a74d02e2400fe0ae9bf3afbf}{TLS\_CERT\_RSA\_FIXED\_ECDH};
1486       \}
1487       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ac256323d1e243a2e7a435abce34dbd39}{TLS\_KEY\_EXCH\_DHE\_DSS})
1488       \{
1489          \textcolor{comment}{//DHE\_DSS key exchange method requires a DSA certificate}
1490          certTypes[n++] = \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda925aea3c96483609ae2867b10693b4c4}{TLS\_CERT\_DSS\_SIGN};
1491       \}
1492       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a357d93f665cb8baea6aa16af8393aaf4}{TLS\_KEY\_EXCH\_DH\_DSS})
1493       \{
1494          \textcolor{comment}{//In DH\_DSS, the server's certificate must contain a Diffie-Hellman}
1495          \textcolor{comment}{//public key and be signed with DSA}
1496          certTypes[n++] = \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda55d75bab5c471fa35a9ea06ea6e683c0}{TLS\_CERT\_DSS\_FIXED\_DH};
1497       \}
1498       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a14c521a28278eecd181953c37b784cb7}{TLS\_KEY\_EXCH\_ECDHE\_ECDSA})
1499       \{
1500          \textcolor{comment}{//ECDHE\_ECDSA key exchange method requires an ECDSA certificate}
1501          certTypes[n++] = \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffdab47f2dd2c4d36761f920f8a1af97f6ec}{TLS\_CERT\_ECDSA\_SIGN};
1502       \}
1503       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aa1759ab7a571296547996aa8f43938a5}{TLS\_KEY\_EXCH\_ECDH\_ECDSA})
1504       \{
1505          \textcolor{comment}{//In ECDH\_ECDSA, the server's certificate must contain an ECDH-capable}
1506          \textcolor{comment}{//public key and be signed with ECDSA}
1507          certTypes[n++] = \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda17c5b42f126089ec4a5b59203cd5e897}{TLS\_CERT\_ECDSA\_FIXED\_ECDH};
1508       \}
1509       \textcolor{keywordflow}{else}
1510       \{
1511          \textcolor{comment}{//DH\_anon and ECDH\_anon key exchange methods do not require any}
1512          \textcolor{comment}{//certificate}
1513       \}
1514    \}
1515    \textcolor{keywordflow}{else}
1516 \textcolor{preprocessor}{#endif}
1517 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= TLS\_VERSION\_1\_3 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_3)}
1518    \textcolor{comment}{//TLS 1.3 currently selected?}
1519    \textcolor{keywordflow}{if}(context->version == \hyperlink{tls_8h_ab44dc642afbfbd72926ab1f94634cd4d}{TLS\_VERSION\_1\_3})
1520    \{
1521       \textcolor{comment}{//If PSK is not being used, then (EC)DHE and certificate-based}
1522       \textcolor{comment}{//authentication are always used}
1523       \textcolor{keywordflow}{if}(context->selectedIdentity < 0)
1524       \{
1525          \textcolor{comment}{//TLS 1.3 removes support for DSA certificates}
1526          certTypes[n++] = \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffda3a76023fc80c787bffed357a4560351b}{TLS\_CERT\_RSA\_SIGN};
1527          certTypes[n++] = \hyperlink{tls_8h_a9bd45859e2bffbd3edb8beff07240ffdab47f2dd2c4d36761f920f8a1af97f6ec}{TLS\_CERT\_ECDSA\_SIGN};
1528       \}
1529    \}
1530    \textcolor{keywordflow}{else}
1531 \textcolor{preprocessor}{#endif}
1532    \textcolor{comment}{//Invalid TLS version?}
1533    \{
1534       \textcolor{comment}{//Abort certificate selection process}
1535       error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cafc403a048723cbb5e5ade33caa70c48b}{ERROR\_INVALID\_VERSION};
1536    \}
1537 
1538    \textcolor{comment}{//Check whether a certificate is required}
1539    \textcolor{keywordflow}{if}(n > 0)
1540    \{
1541       \textcolor{comment}{//Reset currently selected certificate}
1542       context->cert = \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
1543 
1544       \textcolor{comment}{//Loop through the list of available certificates}
1545       \textcolor{keywordflow}{for}(i = 0; i < context->numCerts && context->cert == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL}; i++)
1546       \{
1547          \textcolor{comment}{//Check whether the current certificate is acceptable}
1548          acceptable = \hyperlink{tls__certificate_8c_a31f6bd0b16ae44ecc92ac37b5eb39d6f}{tlsIsCertificateAcceptable}(context, &context->certs[i],
1549             certTypes, n, extensions->\hyperlink{structTlsHelloExtensions_a7903ad9cf319d5f27990432c4e719544}{signAlgoList}, extensions->
      \hyperlink{structTlsHelloExtensions_a640637c05b8aec2ef15420d5005830cb}{certSignAlgoList},
1550             extensions->\hyperlink{structTlsHelloExtensions_ae47ac6a93d2836418dc163d299e46cf7}{supportedGroupList}, \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL});
1551 
1552          \textcolor{comment}{//The certificate must be appropriate for the negotiated cipher}
1553          \textcolor{comment}{//suite and any negotiated extensions}
1554          \textcolor{keywordflow}{if}(acceptable)
1555          \{
1556             \textcolor{comment}{//The hash algorithm to be used when generating signatures must}
1557             \textcolor{comment}{//be one of those present in the SignatureAlgorithms extension}
1558             error = \hyperlink{tls__signature_8c_ad721a7cba2bdeb68ea9f4a43c9b6c2cc}{tlsSelectSignatureScheme}(context, &context->certs[i],
1559                extensions->\hyperlink{structTlsHelloExtensions_a7903ad9cf319d5f27990432c4e719544}{signAlgoList});
1560 
1561             \textcolor{comment}{//Check status code}
1562             \textcolor{keywordflow}{if}(!error)
1563             \{
1564                \textcolor{comment}{//If all the requirements were met, the certificate can be}
1565                \textcolor{comment}{//used in conjunction with the selected cipher suite}
1566                context->cert = &context->certs[i];
1567             \}
1568          \}
1569       \}
1570 
1571       \textcolor{comment}{//Do not accept the specified cipher suite unless a suitable}
1572       \textcolor{comment}{//certificate has been found}
1573       \textcolor{keywordflow}{if}(context->cert == \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1574          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cab3e09f05cab8c8668f2a32955d1b2e99}{ERROR\_NO\_CERTIFICATE};
1575    \}
1576 
1577    \textcolor{comment}{//Return status code}
1578    \textcolor{keywordflow}{return} error;
1579 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_af8f42eaa6f80e4f5fe5608f79f7719df}\label{tls__server__misc_8c_af8f42eaa6f80e4f5fe5608f79f7719df}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Select\+Ecdhe\+Group@{tls\+Select\+Ecdhe\+Group}}
\index{tls\+Select\+Ecdhe\+Group@{tls\+Select\+Ecdhe\+Group}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Select\+Ecdhe\+Group()}{tlsSelectEcdheGroup()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Select\+Ecdhe\+Group (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{tls_8h_a697f1e9ded788afc0e198e055676b13c}{Tls\+Supported\+Group\+List} $\ast$}]{group\+List }\end{DoxyParamCaption})}



Select the named curve to be used when performing E\+C\+D\+HE key exchange. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em group\+List} & List of named groups supported by the peer \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1341 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
1343 \{
1344    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1345    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} i;
1346    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} j;
1347    \hyperlink{compiler__port_8h_a12a1e9b3ce141648783a82445d02b58d}{uint\_t} \hyperlink{dhcpv6__common_8h_a5a648f5ec00c526b0dfa2df7a272c6c0}{n};
1348    \hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t} namedGroup;
1349 
1350    \textcolor{comment}{//Initialize status code}
1351    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689ca70d82df53df56c9d4a943d5539ccc4bc}{ERROR\_HANDSHAKE\_FAILED};
1352 
1353    \textcolor{comment}{//Reset the named group to its default value}
1354    context->namedGroup = \hyperlink{tls_8h_ae51675bb94f1945c0eed549ef93e6b51aee79345f691598413b1506c1a2f22548}{TLS\_GROUP\_NONE};
1355 
1356    \textcolor{comment}{//Check whether a list of named groups is offered by the client}
1357    \textcolor{keywordflow}{if}(groupList != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1358    \{
1359       \textcolor{comment}{//Get the number of named groups present in the list}
1360       n = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(groupList->length) / \textcolor{keyword}{sizeof}(\hyperlink{stdint_8h_a273cf69d639a59973b6019625df33e30}{uint16\_t});
1361 
1362       \textcolor{comment}{//Any preferred groups?}
1363       \textcolor{keywordflow}{if}(context->numSupportedGroups > 0)
1364       \{
1365          \textcolor{comment}{//Loop through the list of allowed groups (most preferred first)}
1366          \textcolor{keywordflow}{for}(i = 0; i < context->numSupportedGroups && error; i++)
1367          \{
1368             \textcolor{comment}{//Loop through the list of named groups the client supports}
1369             \textcolor{keywordflow}{for}(j = 0; j < n && error; j++)
1370             \{
1371                \textcolor{comment}{//Convert the named group to host byte order}
1372                namedGroup = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(groupList->value[j]);
1373 
1374                \textcolor{comment}{//The named group to be used when performing ECDH key exchange}
1375                \textcolor{comment}{//must be one of those present in the SupportedGroups extension}
1376                \textcolor{keywordflow}{if}(context->supportedGroups[i] == namedGroup)
1377                \{
1378                   \textcolor{comment}{//Acceptable elliptic curve found?}
1379                   \textcolor{keywordflow}{if}(\hyperlink{tls__misc_8c_a1d99ba7208ae993d388e7849fa5dce71}{tlsGetCurveInfo}(context, namedGroup) != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1380                   \{
1381                      \textcolor{comment}{//Save the named curve}
1382                      context->namedGroup = namedGroup;
1383                      error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1384                   \}
1385                \}
1386             \}
1387          \}
1388       \}
1389       \textcolor{keywordflow}{else}
1390       \{
1391          \textcolor{comment}{//The named group to be used when performing ECDH key exchange must}
1392          \textcolor{comment}{//be one of those present in the SupportedGroups extension}
1393          \textcolor{keywordflow}{for}(j = 0; j < n && error; j++)
1394          \{
1395             \textcolor{comment}{//Convert the named group to host byte order}
1396             namedGroup = \hyperlink{cpu__endian_8h_a9312c6eb72e64f748ae0d0e0dc3ec9b9}{ntohs}(groupList->value[j]);
1397 
1398             \textcolor{comment}{//Acceptable elliptic curve found?}
1399             \textcolor{keywordflow}{if}(\hyperlink{tls__misc_8c_a1d99ba7208ae993d388e7849fa5dce71}{tlsGetCurveInfo}(context, namedGroup) != \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1400             \{
1401                \textcolor{comment}{//Save the named curve}
1402                context->namedGroup = namedGroup;
1403                error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1404             \}
1405          \}
1406       \}
1407    \}
1408    \textcolor{keywordflow}{else}
1409    \{
1410       \textcolor{comment}{//A client that proposes ECC cipher suites may choose not to include}
1411       \textcolor{comment}{//the SupportedGroups extension. In this case, the server is free to}
1412       \textcolor{comment}{//choose any one of the elliptic curves it supports}
1413       \textcolor{keywordflow}{if}(\hyperlink{tls__misc_8c_a1d99ba7208ae993d388e7849fa5dce71}{tlsGetCurveInfo}(context, \hyperlink{tls_8h_ae51675bb94f1945c0eed549ef93e6b51a754392bfe03e9ee5988cebb5c8466df2}{TLS\_GROUP\_SECP256R1}) != 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1414       \{
1415 
1416          \textcolor{comment}{//Select secp256r1 elliptic curve}
1417          context->namedGroup = \hyperlink{tls_8h_ae51675bb94f1945c0eed549ef93e6b51a754392bfe03e9ee5988cebb5c8466df2}{TLS\_GROUP\_SECP256R1};
1418          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1419       \}
1420       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\hyperlink{tls__misc_8c_a1d99ba7208ae993d388e7849fa5dce71}{tlsGetCurveInfo}(context, \hyperlink{tls_8h_ae51675bb94f1945c0eed549ef93e6b51a7b115315b032f03ca3df4c5c81481922}{TLS\_GROUP\_SECP384R1}) != 
      \hyperlink{group__BSPDefine_ga070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL})
1421       \{
1422          \textcolor{comment}{//Select secp384r1 elliptic curve}
1423          context->namedGroup = \hyperlink{tls_8h_ae51675bb94f1945c0eed549ef93e6b51a7b115315b032f03ca3df4c5c81481922}{TLS\_GROUP\_SECP384R1};
1424          error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1425       \}
1426       \textcolor{keywordflow}{else}
1427       \{
1428          \textcolor{comment}{//Just for sanity}
1429          context->namedGroup = \hyperlink{tls_8h_ae51675bb94f1945c0eed549ef93e6b51aee79345f691598413b1506c1a2f22548}{TLS\_GROUP\_NONE};
1430       \}
1431    \}
1432 
1433    \textcolor{comment}{//Return status code}
1434    \textcolor{keywordflow}{return} error;
1435 \}
\end{DoxyCode}
\mbox{\Hypertarget{tls__server__misc_8c_a17a35f3a542a6ba200aa77d4ca297224}\label{tls__server__misc_8c_a17a35f3a542a6ba200aa77d4ca297224}} 
\index{tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}!tls\+Select\+Group@{tls\+Select\+Group}}
\index{tls\+Select\+Group@{tls\+Select\+Group}!tls\+\_\+server\+\_\+misc.\+c@{tls\+\_\+server\+\_\+misc.\+c}}
\subsubsection{\texorpdfstring{tls\+Select\+Group()}{tlsSelectGroup()}}
{\footnotesize\ttfamily \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\+\_\+t} tls\+Select\+Group (\begin{DoxyParamCaption}\item[{\hyperlink{tls_8h_ac09f7a286c0cdf9b07ee1edd107946f5}{Tls\+Context} $\ast$}]{context,  }\item[{const \hyperlink{tls_8h_a697f1e9ded788afc0e198e055676b13c}{Tls\+Supported\+Group\+List} $\ast$}]{group\+List }\end{DoxyParamCaption})}



Select the group to be used when performing (EC)D\+HE key exchange. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em context} & Pointer to the T\+LS context \\
\hline
\mbox{\tt in}  & {\em group\+List} & List of named groups supported by the client \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code 
\end{DoxyReturn}


Definition at line 1287 of file tls\+\_\+server\+\_\+misc.\+c.


\begin{DoxyCode}
1289 \{
1290    \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689c}{error\_t} error;
1291 
1292    \textcolor{comment}{//Initialize status code}
1293    error = \hyperlink{error_8h_ac7659d73a8cdedc08e9f566bb406689cabf350750d0d4fabd8954c0f1e9bbae94}{NO\_ERROR};
1294 
1295 \textcolor{preprocessor}{#if (TLS\_MAX\_VERSION >= SSL\_VERSION\_3\_0 && TLS\_MIN\_VERSION <= TLS\_VERSION\_1\_2)}
1296    \textcolor{comment}{//SSL 3.0, TLS 1.0, TLS 1.1 or TLS 1.2 currently selected?}
1297    \textcolor{keywordflow}{if}(context->version <= \hyperlink{tls_8h_af97e91c5fb95fb0957e5f37ec9e9eae8}{TLS\_VERSION\_1\_2})
1298    \{
1299       \textcolor{comment}{//ECC cipher suite?}
1300       \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a895e0af86b29640264f699235be22953}{TLS\_KEY\_EXCH\_ECDH\_ANON} ||
1301          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ad9ebbdd436027753829ea5b6cd4b810b}{TLS\_KEY\_EXCH\_ECDHE\_RSA} ||
1302          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a14c521a28278eecd181953c37b784cb7}{TLS\_KEY\_EXCH\_ECDHE\_ECDSA} ||
1303          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75aebba2060dba7ad92238668218f3a6520}{TLS\_KEY\_EXCH\_ECDHE\_PSK})
1304       \{
1305          \textcolor{comment}{//One of the proposed ECC cipher suites must be negotiated only if the}
1306          \textcolor{comment}{//server can successfully complete the handshake while using the curves}
1307          \textcolor{comment}{//and point formats supported by the client}
1308          error = \hyperlink{tls__server__misc_8c_af8f42eaa6f80e4f5fe5608f79f7719df}{tlsSelectEcdheGroup}(context, groupList);
1309       \}
1310 \textcolor{preprocessor}{#if (TLS\_FFDHE\_SUPPORT == ENABLED)}
1311       \textcolor{comment}{//FFDHE cipher suite?}
1312       \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a33535bd987c46f1ba621d6e28b0b3bfa}{TLS\_KEY\_EXCH\_DH\_ANON} ||
1313          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a01660ec1808dd6a8b5250b16d81502e4}{TLS\_KEY\_EXCH\_DHE\_RSA} ||
1314          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75ac256323d1e243a2e7a435abce34dbd39}{TLS\_KEY\_EXCH\_DHE\_DSS} ||
1315          context->keyExchMethod == \hyperlink{tls_8h_a10c9078f6485419c2b8644b573ef0b75a32a252b7c7befeccaa088290d6a71dfe}{TLS\_KEY\_EXCH\_DHE\_PSK})
1316       \{
1317          \textcolor{comment}{//If none of the client-proposed FFDHE groups are known and acceptable}
1318          \textcolor{comment}{//to the server, then the server must not select an FFDHE cipher suite}
1319          error = \hyperlink{tls__ffdhe_8c_a393f2e57b8daae1ab1f0994311f373db}{tlsSelectFfdheGroup}(context, groupList);
1320       \}
1321 \textcolor{preprocessor}{#endif}
1322       \textcolor{keywordflow}{else}
1323       \{
1324          \textcolor{comment}{//The selected cipher suite does not provide forward secrecy}
1325       \}
1326    \}
1327 \textcolor{preprocessor}{#endif}
1328 
1329    \textcolor{comment}{//Return status code}
1330    \textcolor{keywordflow}{return} error;
1331 \}
\end{DoxyCode}
